<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/6143 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:38:37 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Using TinyTX and LDR to measure Watt on my power meter | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Using TinyTX and LDR to measure Watt on my power meter</h3>
        <span class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Mon, 17/11/2014 - 10:10</span>
        <div class="content"><p>Hi,</p>
<p>I bought an <a href="http://www.conrad.de/ce/de/product/145475/Fotowiderstand-A-9060-Gehaeuseart-5-mm/SHOP_AREA_37351">LDR</a> to measure electric consumption on my power meter.</p>
<p>My power meter has an infrared LED which outputs pulses.</p>
<p>I attached the LDR with the TinyTx node to the power meter. But unfortunately it does not send anything!<br />
If i use a flashlight, my wireless sensor TinyTx (Sketch) sends a signal.</p>
<p>Is the LDR able to read infrared impulses? Which sensor is used to read an infrared LED?</p>
<p>Maybe its a problem with the resistor which is used between Pin A0 and Pin D9 on my TinyTX!? I have to check which resistor I am using. There are two different sketches for TinyTX to use with a LDR:</p>
<p><a href="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR_Meter/TinyTX_LDR_Meter.ino" title="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR_Meter/TinyTX_LDR_Meter.ino">https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR_Meter/T...</a><br />
<a href="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR/TinyTX_LDR.ino" title="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR/TinyTX_LDR.ino">https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR/TinyTX_...</a></p>
<p>I am sure I use the the first one on my TinyTX, but I am not sure that I used the correct resistor - can this be the problem?</p>
<p>Best regards,<br />
Christian</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10005.html" class="topic-previous" title="Go to previous forum topic">‹ Calibration Values for my CT</a>
              <a href="5324.html" class="topic-next" title="Go to next forum topic">Code to upload first? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-25185"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 17/11/2014 - 13:01.</div>
    <div class="content">
     <p>You need some data on your LDR! You need to know its resistance in the dark (easy) and when seeing the infra-red pulses (harder). Without that, you cannot calculate the correct value for the series resistor.</p>
<p>You might be able to get an idea of the 'light' resistance if you use a TV remote control as a substitute for the meter. The one used in the emonGLCD responds to my TV remore control if the range is less than 2 cm.</p>
<p>If you cannot find the resistance of your LDR, all you can do is try different values of series resistance until you find one that works - do not go below the minimum value and destroy your LDR with too much current.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25187"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Mon, 17/11/2014 - 13:36.</div>
    <div class="content">
     <p>Hi Robert,</p>
<p>thank you for your answer.</p>
<p>I found a specification on my LDR: <a href="http://www.produktinfo.conrad.com/datenblaetter/125000-149999/145475-da-01-en-FOTOWIDERSTAND_A_9060_A_9013.pdf" title="http://www.produktinfo.conrad.com/datenblaetter/125000-149999/145475-da-01-en-FOTOWIDERSTAND_A_9060_A_9013.pdf">http://www.produktinfo.conrad.com/datenblaetter/125000-149999/145475-da-...</a></p>
<p>It says:</p>
<p>Resistance value at 10 lux = 27 - 94 KOhm<br />
Minimum resistance 1 sec after removal of light = 0,5 MOhm</p>
<p>How can I measure its resistance when an infrared LED is on?<br />
Of course I can use my TV remote control to send an infrared signal. But how to measure it?</p>
<p>Maybe I can use a voltmeter to measure its resistance when using my TV remote like written here <a href="https://learn.adafruit.com/photocells/testing-a-photocell" title="https://learn.adafruit.com/photocells/testing-a-photocell">https://learn.adafruit.com/photocells/testing-a-photocell</a></p>
<p>But how do I calculate which resistor I need for my LDR if I know its resistance?</p>
<p>Best regards,<br />
Christian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25192"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 17/11/2014 - 15:17.</div>
    <div class="content">
     <p>OK, that information helps. Let me assume you are making a voltage divider circuit between the supply and ground, and your LDR is in the top position and your fixed resistor in the bottom. When the LDR is illuminated, its resistance will be low and you have a positive pulse. When it is dark, you have approx 500 k&Omega;, so you want the resistance of the fixed resistor to give you a logic 'LOW' at your input when dark. You know the supply voltage, you can find what a logic LOW voltage is, so you can calculate the fixed resistor's value. I guess about 100 k&Omega;. That will give you a LOW voltage of Vcc/6. Now let's check what this will give you at 10 lux: your LDR is (say) 100 k&Omega; that will give you a HIGH voltage of Vcc/2 worst case, which is probably not good enough - you need more light - but it could be as high as nearly 0.8 &times; Vcc - which should be OK.<br />
Until we know how low the resistance goes when the LED is on, we can do no better, but this shows you how to begin to calculate the value. It might be better (depends on the voltages you need for a logic HIGH and a logic LOW input) to switch the positions of the LDR and resistor, then invert the input in software.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25203"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Tue, 18/11/2014 - 08:08.</div>
    <div class="content">
     <p>Hi Robert,</p>
<p>thank you very much for calculating this.</p>
<p>Yesterday evening I changed my setup a little bit. Unfortunately﻿﻿ I had no 100 k&Omega; resistor at home, so I used two 47 k&Omega; (=94 k&Omega;) resistors.</p>
<p>The good news is that, using my infrared TV remote control the TinyTX started to send - so the LDR was able to read the signal. The bad news is that, that it was not able to read the infrared LED of my power meter. Maybe because of the weak light of the infrared led of my power meter?</p>
<p>The question is how to change the size of the resistor so that the LDR is working with the infrared LED of my power meter? Do you have any ideas? How do you calculate the size of the resistor?</p>
<p>Best regards,<br />
Christian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25217"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 18/11/2014 - 12:51.</div>
    <div class="content">
     <p>So you are almost there. </p>
<p>There can be two problems. First, have you excluded all light? To get the highest dark resistance, you must excluded all light - both visible and infra-red. Second, the light resistance is inversely proportional to the amount of light, so the more light you can get from the IR LED, the better. Usually that means getting as close as possible and directly in line.</p>
<p>I have no idea how much light you will get out of your meter, nor of the characteristics or the actual LDR that you have, so I cannot do the calculations exactly. I have shown you how to calculate the resistor value, you need to check the data sheet for your TinyTX and find the voltages that your input considers to be logic HIGH and logic LOW, then you adjust those calculations and the resistor value so that when dark your voltage is only just below the LOW threshold and when light you hope it will go above the HIGH threshold.<br />
If you cannot do that, you can either try amplifying the voltage, or you can get a more sensitive LDR.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25218"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Tue, 18/11/2014 - 13:41.</div>
    <div class="content">
     <blockquote><p><em>There can be two problems. First, have you excluded all light? To get the highest dark resistance, you must excluded all light - both visible and infra-red. </em></p>
</blockquote>
<p>&nbsp;</p>
<p>Yes, I exluded all light. I closed the fusebox my power meter is in, so the LDR is completely in the dark.<br />
The LDR is directly (face-to-face) put on the infrared LED of the power meter. There is only a glas in between.</p>
<p>TinyTX is running with two AA batteries (each 1.5V) = between 3V and 3.3V and outputs this voltage when a pin is defined as output.<br />
So <u>i think</u> the logic HIGH is exactly the supply voltage - but I&#39;m not sure.</p>
<p>So thank you for helping me Robert. I think I have to try around a little bit find the correct resistor. Can I destroy the LDR by trying around with different resistors? I have only a very basic knowledge, so how is the formula to calculate the resistor I need?</p>
<p>Christian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25222"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 18/11/2014 - 13:59.</div>
    <div class="content">
     <p><i>So i think the logic HIGH is exactly the supply voltage - but I'm not sure.</i><br />
No. The voltage you are looking for is the voltage that the <b>input</b> recognises as HIGH. Check the data sheet. It is usually above about 70% of the supply voltage, and LOW is usually below about 20% of the supply voltage.<br />
The data sheet for the ATTiny84 is here: <a href="http://www.atmel.com/Images/doc8006.pdf" title="http://www.atmel.com/Images/doc8006.pdf">http://www.atmel.com/Images/doc8006.pdf</a> If you look in section 20, you will see that a LOW is below 0.2 Vcc if Vcc is between 1.8 &amp; 2.4 V, and 0.3 Vcc if Vcc is between 2.4 and 5.5 V; and a HIGH is above 0.7 Vcc if Vcc is between 1.8 &amp; 2.4 V, and 0.6 Vcc if Vcc is between 2.4 and 5.5 V.</p>
<p>You can destroy your LDR if you use a resistor that is too low, the data sheet will tell you the maximum power that it can safely dissipate. I guess it will be in the order of 100 mW, so you need a quite small resistor (well below 100 &Omega;) to do that with a 3.3 V supply. As it looks as if you need resistors in the 100 k&Omega; range, the only danger is an accidental short-circuit.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25240"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Thu, 20/11/2014 - 15:48.</div>
    <div class="content">
     <p>Hi Robert,</p>
<p>thanks for the specification. I have only a very basic knowledge working with microcontrollers.</p>
<p>I was trying around with multiple resistors now but I had no luck.<br />
With my TV remote, everything works fine - but not with my power meter.</p>
<p>I have to find out if the infrared led is working or not.<br />
And I have also read that there are infrared interfaces where you can read more information than just a light pulse. But some interfaces have a photoresistor and need an active light pulse from a sensor before they send information.</p>
<p>I found a specification from my power meter, I will post the link here.</p>
<p>Best regards,<br />
Christian<br />
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25241"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Thu, 20/11/2014 - 16:20.</div>
    <div class="content">
     <p>Hi Christian</p>
<p>You should be able to check your meter using a mobile phone camera,&nbsp;the infra red light is visible&nbsp;via a digital camera.</p>
<p>Are you sure it&#39;s supposed&nbsp;to pulse? if it uses infra red it could well &quot;communicate&quot; rather than just &quot;pulse&quot; if it does communicate it could well be waiting to be &quot;asked&quot; for the data,</p>
<p>Paul&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25242"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 20/11/2014 - 16:24.</div>
    <div class="content">
     <p>If you have a digital camera/webcam/camera phone, you might be able to see the IR LED using that. But if you can't, it's not conclusive as some are fitted with an IR filter. I think the most likely scenario is the LED is working, but the light pulse is not of sufficient intensity to make the ATTiny input swing far enough for a pulse to be recognised.</p>
<p><i>"I have only a very basic knowledge working with microcontrollers."</i> That's where I'm trying to help you by steering you towards where to find the information and how to interpret it, then how to do the calculation.</p>
<p>[Edit] Not again! Paul and I seem to be able to post nearly the same answer at nearly the same instant!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25260"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Fri, 21/11/2014 - 08:18.</div>
    <div class="content">
     <p>Hi Paul, Hi Robert,</p>
<p>great thank you!</p>
<p>Yesterday evening I tried to capture the infrared led pulse with my digital camera and I could see the light pulse on my screen! It is a short flash every 1kW.</p>
<p>So I think the pulse has not the sufficient intensity to work with my LDR. Maybe I can try, using different resistors, to make the LDR more sensitive. I think with the right setup, the LDR will be able to capture the light pulse.</p>
<p>When you have a look on the sketch to line 134-137, I think this has something to do with the value which is read from the LDR <a href="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR_Meter/TinyTX_LDR_Meter.ino#L134-L137" title="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR_Meter/TinyTX_LDR_Meter.ino#L134-L137">https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR_Meter/T...</a></p>
<p>There is another sketch for Attiny just for sending the light intensitiy <a href="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR/TinyTX_LDR.ino" title="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR/TinyTX_LDR.ino">https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR/TinyTX_...</a> It sends the LDR value every minute. So if I modify this sketch that it just sends the LDRs value if the LDR values changes, so I can add it in front of my power meter and read the exact value from the LDR when it&#39;s dark and when the light pulses. Then I can modify the LDR_Meter sketch with the exact values.</p>
<p>Best regards,<br />
Christian</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25263"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 21/11/2014 - 14:58.</div>
    <div class="content">
     <p>I see you're actually using an analogue input for your pulse. I could not access those external links earlier, so I did not know that and had to assume you were using a digital input (and that should have been obvious from what I wrote). You will certainly need to change to levels at which you detect the pulse if you are using the analogue input, you might also have a problem with the duration of the pulse and the speed at which you poll and can measure the analogue input, though as you can see the pulse using a camera, it is likely that it is long enough to be able to read it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25298"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Mon, 24/11/2014 - 10:49.</div>
    <div class="content">
     <p>Hi Robert,</p>
<p>oh, you were talking about a digital input - now I understand your answers better :-) Sorry for that! No, it is just an analogue input. The LDR is NOT connected directly to the infrared LED of the power meter.</p>
<p>I modified the attiny sketch in a way that it now just reports changes on the analog input. <strong>This means, whenever the light condition (the resistance of the LDR) changes, my wireless TinyTX nodes are sending a signal</strong>.</p>
<p>I made the LDR very sensitive using up to 200 kOhm resistor. So it works perfect with my TV remote when holding it about 1 meter away from the LDR. But not with the power meter. It seems that the signal has not the suffiecient intensity. Maybe the LDR is still not sensitive enough?</p>
<p>Best regards,</p>
<p>Christian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-25299"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 24/11/2014 - 12:24.</div>
    <div class="content">
     <p>I think you need to forget the sketches for a moment and start at the beginning. What numbers do you get for the light intensity (a) when it is dark and (b) when the meter LED is pulsing? (Recording the maximum and minimum values should give you the numbers you need). Then you can decide the number to set where it decides that there is a pulse, and the number where it decides there is not a pulse.</p>
<p>These lines do that: </p>
<p>&nbsp;&nbsp;	    if (!ledOn &amp;& powerReading < 1010)<br />
&nbsp;&nbsp;            {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	        ledOn = true;<br />
&nbsp;&nbsp;	    }<br />
&nbsp;&nbsp;            else if (ledOn &amp;& powerReading > 1020)<br />
&nbsp;&nbsp;            {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	        ledOn = false;<br />
&nbsp;&nbsp;            }</p>
<p>it assumes that the LDR is connected between GND and the analogue input (because it expects the voltage to <u>fall</u> when it decides the LED is on, and says that the light has to go below 1010 (only about 40 mV below V<sub>CC</sub>) to register a pulse, and it must rise above 1020 (nearly at V<sub>CC</sub>) to recognise 'dark'.</p>
<p>Where is your LDR connected? If it is between the analogue input and V<sub>CC</sub>, then you definitely need to change that part of the sketch.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26756"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Wed, 14/01/2015 - 12:19.</div>
    <div class="content">
     <p>Hi Robert, Hi Paul,</p>
<p>I am still working on this project. It is not working yet :-(</p>
<p>Now I bought an infrared sensor like <a href="../../../2.bp.blogspot.com/-AnMEMSXu6qg/UqTKly3lhvI/AAAAAAAAFKk/HzhWXlREM94/s1600/IRwiring2.png">this one</a> and connected it to my TinyTX wireless sensor node.<br />
It works fantastic with my TV remote control over a great distance and it ignores most of the ambient light unlike the LDR sensor.</p>
<p>I uploaded a skech to the Attiny. So my TinyTX wireless node sends the value, every time the infrared sensor receives a new value. Using the RFM12Pi interface in emoncms I connected the TinyTX wireless sensor to a feed.</p>
<p>I did this in a first step to find out which is the value (a) when it is dark and (b) when the meter infrared LED is pulsing. I got the following values. Now I think everything above the value 2000 stand for (b) the pulsing LED and everything below 2000 for (a) when it is dark.</p>
<p>&nbsp;</p>
<p><img alt="" src="../sites/default/files/Sensor_Value.jpg" style="height: 344px; width: 680px;" /><br />
&nbsp;</p>
<p>Now in the second step my idea was to adapt / create a sketch for the attiny on my tinyTX, which calculates the Watt value every time the infrared sensor is higher than 2000. So I used t<a href="https://github.com/nathanchantrell/TinyTX/blob/master/TinyTX_LDR_Meter/TinyTX_LDR_Meter.ino">his sketch from Nthan Chantrell on github</a> and created <a href="../sites/default/files/LDR_Meter_Sketch.html">my &quot;own&quot; very basic sketch</a>. The most important part is the loop part (see below).</p>
<p>No my question or problem is the following:</p>
<p>If I change the following line and add...</p>
<p>&nbsp;</p>
<blockquote><p><strong><em>if ( powerReading &gt; 450 )</em></strong></p>
</blockquote>
<p>&nbsp;</p>
<p>...the tinyTX wireless sensor perfectly sends the values to emoncms / my raspberry pi.</p>
<p>But if I change the line (the IF condition) to what I need, namely...</p>
<p>&nbsp;</p>
<blockquote><p><em><strong>if ( powerReading &gt; 2000 )</strong></em></p>
</blockquote>
<p>&nbsp;</p>
<p>...or...</p>
<p>&nbsp;</p>
<blockquote><p><strong><em>if ( powerReading &gt; 1500 )</em></strong></p>
</blockquote>
<p>&nbsp;</p>
<p>...nothing is send to my raspberry pi. Why?<br />
In the diagramm (picture) above you can see values above 2000 going up to 2500. But the sketch does not work and the wireless node does not send anything.</p>
<p>What is wrong with my sketch???</p>
<p>&nbsp;</p>
<p><em>void loop() {</em></p>
<p>
<em>&nbsp; bitClear(PRR, PRADC); ADCSRA |= bit(ADEN); // Enable the ADC<br />
&nbsp; powerReading = analogRead(10); // calculate the average<br />
&nbsp; ADCSRA &amp;= ~ bit(ADEN); bitSet(PRR, PRADC); // Disable the ADC to save power</em></p>
<p><em>&nbsp; if ( powerReading &gt; 1500 ) {</em></p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned long time = millis();<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned long interval = time - last;</em></p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; watts = 1 * 1 * 3.6E6 / interval;</em></p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last = time;</em></p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tinytx.power = watts; // Get realtime power<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tinytx.supplyV = readVcc(); // Get supply voltage<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tinytx.powerReading = powerReading;</em></p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rfwrite(); // Send data via RF</em></p>
<p><em>&nbsp;}</em></p>
<p>&nbsp;</p>
<p>Best regards,</p>
<p>Christian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26758"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 13/01/2015 - 21:44.</div>
    <div class="content">
     <p>There's no way that sketch you've attached will work, it's an HTML file!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26759"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Tue, 13/01/2015 - 21:49.</div>
    <div class="content">
     <p><em>There&#39;s no way that sketch you&#39;ve attached will work, it&#39;s an HTML file!</em></p>
<p>It looks as though it&#39;s a sketch that has been carelessly copied and pasted from a HTML page!</p>
<p>&nbsp;</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26760"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 13/01/2015 - 22:11.</div>
    <div class="content">
     <p>Exactly, Paul, and as such it's very hard to read. If people expect us to help them, they should not make it harder than necessary, whether by carelessness or whatever. What's wrong with checking that what you have posted is sensible and readable?</p>
<p>And we've got only half the story in the clip that he's pasted into the thread, we don't know where the values in the graph (screenshot) came from, so a constructive suggestion is a little difficult. But my guess is those numbers aren't the values he's reading into powerReading.</p>
<p>One obvious error is it will send messages all the time the LED is on - maybe that was wanted, but I doubt it, and it's not the immediate problem. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26762"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Wed, 14/01/2015 - 12:31.</div>
    <div class="content">
     <p>Hi Robert, Hi Paul,</p>
<p>sorry, this was just a problem with formatting / saving the original sketch. Sorry for that.</p>
<p>I changed the download link and uploaded a plain text document. You can check it again in my original post (url: <a href="../sites/default/files/LDR_Meter_Sketch_0.txt" title="http://openenergymonitor.org/emon/sites/default/files/LDR_Meter_Sketch_0.txt">http://openenergymonitor.org/emon/sites/default/files/LDR_Meter_Sketch_0...</a>).</p>
<p>Most important is the &quot;loop&quot; part. I cannot find the problem!</p>
<p>Best regards,</p>
<p>Christian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26765"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 13/01/2015 - 23:17.</div>
    <div class="content">
     <p>What values are you seeing for powerReading?</p>
<p>Here I have a problem. The ADC in your processor is 10 bits resolution, 2^10 = 1024, so how can the output "powerReading" ever be greater than 1023?</p>
<p>Where did your values of 2500 come from?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26777"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7118.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pfeilc&#039;s picture" title="pfeilc&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/7118.html" title="View user profile.">pfeilc</a> on Wed, 14/01/2015 - 12:31.</div>
    <div class="content">
     <p>Hi Robert,</p>
<p>the TinyTX wireless node is connected to a raspberry pi using <a href="http://wiki.openenergymonitor.org/index.php?title=RFM12Pi_V2">RFM12Pi</a>. On my raspberry I installed emoncms. The graph above shows the infrared sensor value (powerReading) which was send from TinyTX to emoncms.</p>
<p>If my TinyTX node is sending a value to emoncms, the following values (like in my sketch) appear in the &quot;Input&quot; menu of emoncms. In this first step I am only interested in the values for powerReading when its dark and when the LED pulses.</p>
<p><strong>typedef struct { </strong></p>
<p><strong>&nbsp;&nbsp;&nbsp; int power; // Temperature reading<br />
&nbsp;&nbsp;&nbsp; int supplyV; // Supply voltage<br />
&nbsp;&nbsp;&nbsp; int powerReading; // Infrared Sensor</strong></p>
<p><strong>} </strong></p>
<p>From the input of &quot;powerReading&quot; I created a feed in emoncms. After creating the feed I started the realtime graph. You can see the result in my post above.</p>
<p>I agree with you and I think the values I see in emoncms for powerReading (e.g. 2500) are not the values the TinyTX node captures in the powerReading variable.</p>
<p>Even if I change the IF-statement in the <strong>loop() </strong>part of my sketch to something like <strong>if ( powerReading &gt; 1000 )</strong>, nothing is send and received to emoncms. Unlike if I write <strong>if ( powerReading &gt; 500 )</strong> than I receive the values shown in the graph above.</p>
<p>How can I get the &quot;real&quot; values for powerReading? Does emoncms does some kind of calculation or transformation on the values shown in the &quot;Input&quot; menu?</p>
<p>Best regards,</p>
<p>Christian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26778"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using TinyTX and LDR to measure Watt on my power meter</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 14/01/2015 - 13:27.</div>
    <div class="content">
     <p>The point is, if the loop in your TinyTX is looking for a value close to or above 1023 (bearing in mind that the processor data sheet does not guarantee you will get 1023, only that the output will be close to 1023, for maximum input) then you will <b><i>never</i></b> trigger the transmitter.</p>
<p>Have you addressed the question of what happens if the LED is on for two consecutive trips around the loop? In that case, the second time, interval will be a very small number and watts will be very large. Interval needs to be greater than 55 for tinytx.powerReading to not overflow. And even if it doesn't overflow, you still get a wrong reading because it believes it has seen two flashes in quick succession.</p>
<p>You need to put that right first. If that isn't the problem, then you need to look at what you are doing in emoncms to find out how the number is interpreted there. </p>
<p>Why don't you forget the sensor and write a very simple sketch to send known fixed numbers to emoncms? When you have traced those through the system and know how it works, then you can have some confidence that you can send real data and expect meaningful results.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/6143"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-kuUZ68gc1roVgBuQRKWjxTP5ER_O_RGGhz17jl2NR4o" value="form-kuUZ68gc1roVgBuQRKWjxTP5ER_O_RGGhz17jl2NR4o"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
