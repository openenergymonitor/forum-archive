<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2016 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:06:08 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>does PHASECAL really work? | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">does PHASECAL really work?</h3>
        <span class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 11/02/2013 - 11:39</span>
        <div class="content"><p>I&#39;ve always been suspicious of the PHASECAL algorithm (we all learnt at school that extrapolation is dangerous)&nbsp;but a link posted by Robert Wall yesterday encouraged me to look at <a href="https://learn.openenergymonitor.org/?redirect=explanation-of-the-phase-correction-algorithm">this building block entry</a>.</p>
<p>It includes this nice diagram...</p>
<p><img alt="" height="302" src="../sites/default/files/phaseshift.png" width="674" /></p>
<p>&nbsp;</p>
<p>The red dots show the required phase shifted waveform as calculated by the PHASECAL algorithm.</p>
<p>The graphical equivalent of this function is to draw a line between two adjacent points and then extend the line by half the distance between them. It&#39;s clear just looking at the diagram that the result will always be on the outside of the grey shaded area, i.e. always above the black line where the true phase shifted value lies.</p>
<p>The net result of this is that the value given by the PHASECAL algorithm will always be too large and the errors will therefore accumulate. In contrast, if you didn&#39;t try to correct at all the errors largely cancel, less than 0.1% error for a 2 degree phase shift.</p>
<p>&nbsp;I contend that the error resulting from using PHASECAL will, at least for some values,&nbsp;be larger than if you hadn&#39;t corrected at all. Anyone care to prove me wrong?</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2020.html" class="topic-previous" title="Go to previous forum topic">‹ Temperature resolution for low power node</a>
              <a href="1733.html" class="topic-next" title="Go to next forum topic">Electricity meter LED flash direct to raspberry pi emonbase ? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-9758"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 11/02/2013 - 12:25.</div>
    <div class="content">
     <p>I know it&#39;s a nice diagram, I drew it ;-).&nbsp; But you&#39;re wrong when you say &quot;the result will always be on the outside of the grey shaded area&quot;. It depends on the value of phasecal that you use, and it isn&#39;t always 1.5 as I used to illustrate the effect. If you change the order of reading V and I, phasecal may well come inside the range 0 - 1, in which case it will be interpolating and the result will always be on or under the curve. Proven?</p>
<p>But as has been pointed out previously, when the wave is a true sine wave, only the amplitude is affected, and this can be corrected by recalibrating. But when top of the wave is flattened, then there&#39;s a big distortion at the corners, and that&#39;s an error that can be mitigated but not removed by recalibrating. (Interpolation rounds the corners, extrapolation makes them stick out - like shoulder pads.)</p>
<p>There&#39;s an argument (a good one in my view) for changing the order of the readings to make the value of phasecal as close as possible to the ideal - 0 or 1 - as both these values introduce no distortion at all. The &#39;standard&#39; value for the shop transducers and example sketch is 1.7. If I remember correctly, reversing the order of readings would bring this down to 0.7, which would give much less distortion, because it&#39;s now only 0.3 away from the ideal value. The argument against is the confusion that would arise from having a switch in the library and its proper use.</p>
<p>There&#39;s a danger here (if I haven&#39;t already done so) of opening up the whole phase shift can of worms. The ideal is zero phase shift from both transducers and truly simultaneous readings of both. The next best is the phase shift of one equals the sum of the phase shift of the other plus the time delay between readings. In both those cases, phasecal wouldn&#39;t be needed. Otherwise, you&#39;ve got to do it the easy way as a time shift in software like this, or the hard way is insert hardware filters to do a real phase shift.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9767"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 11/02/2013 - 13:55.</div>
    <div class="content">
     <p><em>If you change the order of reading V and I, phasecal may well come inside the range 0 - 1, in which case it will be interpolating</em> <em>and the result will always be on or under the curve.</em></p>
<p>Precisely so now all errored values&nbsp;will be too small and the errors will still accumulate. So no, not proven :)</p>
<p>I think that for any value of PHASECAL &gt;0.5 and &lt;1.5 the error in real power will be greater if you correct using the library method than if you just used the raw, unshifted voltage. Even outside this range you&#39;d get a better result by simply using the previous or following voltage sample.</p>
<p>How about that one? :)</p>
<p>It&#39;s perfectly possible, given enough CPU power, to phase shift the voltage correctly in software&nbsp;by assuming&nbsp;the voltage is&nbsp;a sine wave and not a straight line, it just takes a bit of trigonometry.</p>
<p>Nothing wrong with opening a can of worms - question everything, that&#39;s my motto!</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9770"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 11/02/2013 - 14:12.</div>
    <div class="content">
     <p>Can you explain exactly what you mean with: &quot;errors will still accumulate&quot;? I can&#39;t see any mechanism for that to happen, you&#39;re not storing the shifted value to use next time. You&#39;re changing the amplitude, yes, but that can be corrected provided no other distortion is added to the wave.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9771"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 11/02/2013 - 14:23.</div>
    <div class="content">
     <p>What I&#39;m trying to say is that over a single cycle all the errored values are either too large (phasecal&gt;1) or too small (phasecal&lt;1) so there is no cancelation at all. All the errors contribute to the overall error in the calculated power.</p>
<p>By contrast, if you don&#39;t phase shift the voltage some errored values are too small and some are too large so there&#39;s a degree of cancelation and the error in calculated power is smaller.</p>
<p>This is why the power factor for small current leads/lags is small. The instantaneous power swings about but the total power over a cycle is only slightly different to when the PF is 1. Or to put it another way cos(a) is very close to 1 when a is small.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9776"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 11/02/2013 - 15:09.</div>
    <div class="content">
     <p>(1) The amplitude error is zero at phasecal = 0 and at phasecal = 1. The error curve is a parabola with a negative minimum at 0.5.&nbsp; Notwithstanding that, you&#39;re ignoring the fact that the amplitude distortion is consistent and can be corrected by adjusting the calibration?</p>
<p>(2) &quot;This is why the power factor for small current leads/lags is small.&quot;<br />
	The normal way of analysing a complex phasor is to resolve it on orthogonal axes into real and imaginary parts, so the real component is aligned with the real axis and the imaginary or reactive component with the imaginary axis. If you have a difference in phase shifts between your transducers, you&#39;re effectively adding another pair of axes twisted in relation to the first, so you&#39;re drawing voltage phasors according to one frame of reference and current phasors with respect to the other.<br />
	Using that framework, can you explain a bit further the point you&#39;re trying to make?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9786"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 11/02/2013 - 16:40.</div>
    <div class="content">
     <p>I think you&#39;re trying to baffle me with science there Robert but I also think I now understand what you are trying to tell me. Let me put this into my own words and see if you agree...</p>
<p>If we have a perfect system, voltage and current are pure sine waves, the load is purely resistive, neither transformer introduces any phase shift and VCAL and ICAL are correctly set. The only error is the delay between sampling voltage and current.</p>
<p>If we calculated real power in this system we&#39;d get a value that was too small by a factor of cos(current delay angle)</p>
<p>If we then simply applied the phasecal algorithm and recalculated real power we&#39;d still&nbsp;get an incorrect result and the error would be greater than the previous error.</p>
<p>This was the gist of my point.</p>
<p>BUT, and I think this is your point, because all the individual sample errors are in the same direction this latter error can largely be compensated for by changing the amplitude, i.e. by adjusting VCAL.</p>
<p>This is also why it&#39;s important to use the phase shifted voltage for the Vrms calculation because VCAL is now incorrect for the raw voltage samples.</p>
<p>Is this correct?</p>
<p>I now just need to convince myself that the amplitude corrected error is smaller than the raw error and I&#39;ll be happy.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9791"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 11/02/2013 - 17:35.</div>
    <div class="content">
     <p>Yes, that&#39;s correct but with one proviso: <em>the mains wave isn&#39;t a sine wave</em>! I have a sampled mains wave in a spreadsheet - here it is resampled at 53 per cycle. Column B is the raw mains, Column C is the Mascot adapter output. You can run the algorithm on this in the spreadsheet and see what effect the various changes have.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9813"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 12/02/2013 - 10:29.</div>
    <div class="content">
     <p>Thanks for that Robert, it&#39;s interesting to look at real-world data.</p>
<p>I see what you mean about distortion in the corners...</p>
<p><img alt="" src="../sites/default/files/phasecal.png" style="width: 483px; height: 291px;" /></p>
<p>This is for a phasecal value of 1.7 so we would be extrapolating. As you&#39;d expect you get a much better result by interpolating between the following 2 values instead.</p>
<p>This would be easy to do in the library for phasecal values of 1-2 by just using the older current value that is already saved. Something like this...</p>
<p>if(PHASECAL&gt;1) { phaseShiftedV = lastFilteredV + (PHASECAL-1) * (filteredV - lastFilteredV); instP = phaseShiftedV * lastFilteredI; }</p>
<p>else&nbsp;{ phaseShiftedV = lastFilteredV + PHASECAL * (filteredV - lastFilteredV); instP = phaseShiftedV * filteredI; }</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9827"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: does PHASECAL really work?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 12/02/2013 - 16:55.</div>
    <div class="content">
     <p>Yep, that looks exactly like the curves I have. Obviously, the more frequent the samples, the more history you need and the less distortion you get because there is less of a gap to fill. The original data was recorded at 44.1 or 48 k samples per second, so can be resampled at any rate (any that the Arduino can keep up with!).</p>
<p>But don&#39;t forget, with the v.t. phase shift varying with voltage and the c.t likewise with current, you can only aim for an average correction without unreasonably complicating the algorithm. And you can&#39;t get rid of those and remain non-invasive and at reasonable cost and complexity.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2016"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-bNKUjFYaFTyqeEOnaHFIY-gRyXOqOwDfSEVvTqNypKM" value="form-bNKUjFYaFTyqeEOnaHFIY-gRyXOqOwDfSEVvTqNypKM"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
