<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11762 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:49:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonGLCD - changing from EmonTX system to Emonpi | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonGLCD - changing from EmonTX system to Emonpi</h3>
        <span class="submitted">Submitted by <a href="../user/7971.html" title="View user profile.">Derekb</a> on Sat, 05/12/2015 - 20:29</span>
        <div class="content"><p>Hi,</p>
<p>just found the time to&nbsp;migrate from an EmonTX&nbsp;to a (Kickstarter) EmonPi, and&nbsp;I have a&nbsp;query re EmonGLCD&nbsp;code. &nbsp;Currently running SolarPV.ino, and it&nbsp;decides whether it&#39;s getting an energy packet from the TX&nbsp;or a time update from Emonbase by checking the source node:</p>
<p>if (node_id == 10) {emontx = *(PayloadTX*) rf12_data; last_emontx = millis();}<br />
if (node_id == 15)<br />
{<br />
RTC.adjust(DateTime(2013, 1, 1, rf12_data[1], rf12_data[2], rf12_data[3]));</p>
<p>With the&nbsp;EmonPi, both packets will I believe both&nbsp;have node id = 5. &nbsp;Before I go hacking the code&nbsp;around, is&nbsp;there an existing&nbsp;preferred fix for&nbsp;this?&nbsp; I&#39;ve searched this forum but haven&#39;t found anything.</p>
<p>&nbsp;</p>
<p>I also&nbsp;ran into the bug of Emonhub splitting a node name into multiple lines when there&#39;s only one variable sent (&nbsp;http://openenergymonitor.org/emon/node/11322 ) but found a&nbsp;different workaround, just changed&nbsp;the name to a&nbsp;single letter &quot;T&quot;</p>
<p>Thanks!</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11765.html" class="topic-previous" title="Go to previous forum topic">‹ Issue Running myelectric app - [SOLVED]</a>
              <a href="11709.html" class="topic-next" title="Go to next forum topic">Virtual Feed Behaving Oddly ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-36767"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonGLCD - changing from EmonTX system to Emonpi</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sat, 05/12/2015 - 21:23.</div>
    <div class="content">
     <p>Unfortunately that&#39;s not going to work, Previously with the emonTx (node 10) the emonGLCD was listening in on the transmision from the emonTx to the emonBase, when using an emonPi&nbsp;instead of the emonTx, there is no transmission&nbsp;to listen to, plus if it did transmit the data as node 5 as well as the time as node 5 the emonGLCD wouldn&#39;t be able to use the node&nbsp;id to distinguish the time from the data.</p>
<p>The emonPi is able to transmit the time and you could extend this to send one packet including both the time and the data, which would also require some minor edits in the emonGLCD sketch. Or you will need to edit emonPi to repeat the locally captured data over the rfm network with a different id. either an edit to the emonPi&nbsp;sketch to just broadcast the data as it passes it to the Pi over serial or in emonhub to TX the dat it gets from the emonpi&nbsp;board or by &quot;fetching&quot; the required data from emoncms&nbsp;in emonhub and TX over rfm.</p>
<p>The last one IMO is the better option, but any will do the job and all will require some coding, with the last one the coding can be all done&nbsp;in emonhub so no sketches to upload.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36769"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8298.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8298.jpg" alt="Jon&#039;s picture" title="Jon&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonGLCD - changing from EmonTX system to Emonpi</h3>

    <div class="submitted">Submitted by <a href="../user/8298.html" title="View user profile.">Jon</a> on Sat, 05/12/2015 - 21:29.</div>
    <div class="content">
     <p>Derek - I have an emonPi&nbsp;and the emonGLCD but I am running a hacked up version of the HomeEnergyMonitor.ino code. &nbsp;I get my power and time&nbsp;from the emonPi (node 5). &nbsp;I do not own the emonTX. &nbsp;I changed the&nbsp;HomeEnergyMonitor.ino code Payload to accept the time and power (and energy).</p>
<blockquote><p>typedef struct { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;for data from emonPi for emonGLCD time &amp; &quot;Power Now&quot;<br />
&nbsp; byte cmd;<br />
&nbsp; byte hour;<br />
&nbsp; byte minute;<br />
&nbsp; byte second;<br />
&nbsp; byte blank1;<br />
&nbsp; int32_t WattsNow;<br />
&nbsp; int32_t kWhAccum;<br />
&nbsp; byte SendToNode;<br />
} PayloadPi; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// create JeeLabs RF packet structure<br />
PayloadPi emonPi;</p>
</blockquote>
<p>&nbsp;</p>
<p>And I&nbsp;changed&nbsp;to the EmonHubJeeInterfacer.py code in the &quot;def action(self):&quot; area to send both the time and the power (and energy) to the emonGLCD.</p>
<blockquote><p>&nbsp; &nbsp; def action(self):<br />
&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;Actions that need to be done on a regular basis.&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; This should be called in main loop by instantiater.<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &quot;&quot;&quot;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; t = time.time()</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; # Broadcast time to synchronize emonGLCD<br />
&nbsp; &nbsp; &nbsp; &nbsp; interval = int(self._settings[&#39;interval&#39;])<br />
&nbsp; &nbsp; &nbsp; &nbsp; if interval: &nbsp;# A value of 0 means don&#39;t do anything<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (t - self._interval_timestamp) &gt; (interval):<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self._interval_timestamp = t<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now = datetime.datetime.now()<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self._log.debug(self.name + &quot; Broadcasting time: %02d:%02d:%02d&quot; % (now.hour, now.minute, now.second))<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sendstr = &quot;00,%02d,%02d,%02d,00&quot; % (now.hour, now.minute, now.second)&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; # Add Power at end of Time string<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; packet = urllib2.urlopen(&quot;http://localhost/emoncms/feed/fetch.json?ids=1,2&amp;apikey=emonPi_emoncms_read_apikey&quot;).read()<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; packet = packet.translate(None, &#39;&quot;[]&#39;)&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# &nbsp;packet is a string &lt;type &#39;str&#39;&gt; &nbsp;- &nbsp;1101,1138.1513306719<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; packet = packet.split(&#39;,&#39;)&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# &nbsp;packet is a list &lt;type &#39;list&#39;&gt; &nbsp;- &nbsp;1101,1138.1513306719<br />
&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for value in packet:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value = int(round((float(value) * 10)))<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;myPackData = struct.pack(&#39;&lt;i&#39;, value)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bytes = struct.unpack(&#39;&lt;BBBB&#39;, myPackData)&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for byte in bytes:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sendstr = sendstr + (&quot;,%d&quot; % int(byte))</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sendstr = sendstr + &quot;,00,s&quot;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #self._log.debug(self.name + &quot; sendstr &quot; + sendstr)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self._ser.write(sendstr)</p>
</blockquote>
<p>The above was with the help of many others on this forum! &nbsp;<a href="10065.html">How to send feed data from emoncms to emonGLCD?</a></p>
<p>Hope this helps - Jon</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36771"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7971.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Derekb&#039;s picture" title="Derekb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonGLCD - changing from EmonTX system to Emonpi</h3>

    <div class="submitted">Submitted by <a href="../user/7971.html" title="View user profile.">Derekb</a> on Sat, 05/12/2015 - 22:27.</div>
    <div class="content">
     <p>Thanks for the quick response guys,</p>
<p>I&#39;ll probably put the time in the main payload - looks&nbsp;as if&nbsp;I&#39;m doing some recoding!</p>
<p>In the meantime I plan to leave the old emonbase powered up on node 15 just to provide a temporary&nbsp;time signal...</p>
<p>regards</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11762"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-Au6kVT2pbEp9HVyxZFBd0bTQAsUIbSHElfu1XACliKs" value="form-Au6kVT2pbEp9HVyxZFBd0bTQAsUIbSHElfu1XACliKs"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
