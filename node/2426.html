<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2426 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:28 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Adding Frequency | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Adding Frequency</h3>
        <span class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Sun, 02/06/2013 - 03:16</span>
        <div class="content"><p>Is there code to add frequency?</p>
<p>Thanks</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2466.html" class="topic-previous" title="Go to previous forum topic">‹ Links to Raspberry Pi ready to go image not available</a>
              <a href="2452.html" class="topic-next" title="Go to next forum topic">input processing... yeah again :-D ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-12511"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 02/06/2013 - 10:52.</div>
    <div class="content">
     <p>Yes, both MartinR and Calypso_rae have published sketches that measure frequency.</p>
<p><a href="1535.html" title="http://openenergymonitor.org/emon/node/1535">http://openenergymonitor.org/emon/node/1535</a></p>
<p><a href="1757.html">Robin&#39;s Mk2 Code variants and associated tools.</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12540"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Mon, 03/06/2013 - 06:29.</div>
    <div class="content">
     <p>Awesome code for frequency and all the power parameters.</p>
<p><span style="font-size: 12px;">Looking more for adding frequency code to emonlib.cpp</span></p>
<p>It already utilizes code to access the crossings as below..</p>
<p>Can you tell me how to add the code to calculate frequency using crosscount?</p>
<p>while I&#39;m here can a &quot;auto reply notify&quot; check box be added to this forum - would help.</p>
<p>&nbsp;</p>
<p>I have used pulseIn(), but it seems to have a drift -&nbsp;</p>
<p>Here is my frequency coding - i hope to get rid of this code anduse the emonlib.cpp&nbsp;crosscount as a counter of zero crosses</p>
<p>Hoping someone can assist.</p>
<p><span style="font-size: 12px;">*****************************************************************************</span></p>
<p>&nbsp;//******************************<br />
	&nbsp; //Frequency smoothing<br />
	&nbsp; //******************************<br />
	&nbsp;&nbsp;&nbsp; // subtract the last reading:<br />
	&nbsp; total= total - readings[index];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; // read from the sensor:&nbsp;<br />
	&nbsp; //readings[index] = analogRead(inputPin);<br />
	&nbsp; readings[index] = pulseIn(inputPin,HIGH);//HIGH gives best fit<br />
	&nbsp; // add the reading to the total:<br />
	&nbsp; total= total + readings[index];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; // advance to the next position in the array:&nbsp;<br />
	&nbsp; index = index + 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp; // if we&#39;re at the end of the array...<br />
	&nbsp; if (index &gt;= numReadings)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; // ...wrap around to the beginning:<br />
	&nbsp;&nbsp;&nbsp; index = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>//************************************<br />
	//end smoothing Routine for Frequency<br />
	//************************************</p>
<p>&nbsp;</p>
<p>&nbsp; // calculate the average:<br />
	&nbsp; val = total / numReadings;&nbsp; //Frequency raw counts</p>
<p>Serial.print(&quot;&nbsp; Freq= &quot;);<br />
	&nbsp; Serial.print((1000/((val*2/1000.0)-freqerror)),2); //frequency - freqerror is the calibration devised to setup<br />
	&nbsp;</p>
<p>Any mistakes?? Please let me (and everyone else) know.</p>
<p>******************************************************************************</p>
<p>emonlib.cpp extract for crosscount&nbsp;follows</p>
<p>******************************************************************************</p>
<p>// emon_calc procedure<br />
	// Calculates realPower,apparentPower,powerFactor,Vrms,Irms,kwh increment<br />
	// From a sample window of the mains AC voltage and current.<br />
	// The Sample window length is defined by the number of wavelengths we choose to measure.<br />
	//--------------------------------------------------------------------------------------<br />
	void EnergyMonitor::calcVI(int wavelengths, int timeout)<br />
	{<br />
	&nbsp; int SUPPLYVOLTAGE = readVcc();<br />
	&nbsp; <strong>int crossCount</strong> = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Used to measure number of times threshold is crossed.<br />
	&nbsp; int numberOfSamples = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //This is now incremented&nbsp;</p>
<p>&nbsp; //-------------------------------------------------------------------------------------------------------------------------<br />
	&nbsp; // 1) Waits for the waveform to be close to &#39;zero&#39; (500 adc) part in sin curve.<br />
	&nbsp; //-------------------------------------------------------------------------------------------------------------------------<br />
	&nbsp; boolean st=false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //an indicator to exit the while loop</p>
<p>&nbsp; unsigned long start = millis();&nbsp;&nbsp;&nbsp; //millis()-start makes sure it doesnt get stuck in the loop if there is an error.</p>
<p>&nbsp; while(st==false)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //the while loop...<br />
	&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; startV = analogRead(inPinV);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //using the voltage waveform<br />
	&nbsp;&nbsp;&nbsp;&nbsp; if ((startV &lt; 550) &amp;&amp; (startV &gt; 440)) st=true;&nbsp; //check its within range<br />
	&nbsp;&nbsp;&nbsp;&nbsp; if ((millis()-start)&gt;timeout) st = true;<br />
	&nbsp; }<br />
	***************************************************************************************************</p>
<p>end of emonlib.cpp extract</p>
<p>***************************************************************************************************</p>
<p>Thanks all.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12541"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Mon, 03/06/2013 - 06:33.</div>
    <div class="content">
     <p>This&nbsp;might help anyone trying to use my frequency code</p>
<p>It goes in the sketch header (above setup()</p>
<p>&nbsp;</p>
<p>//****Frequency setup**********************************<br />
	const int numReadings = 6;// Frequency samples # of half waves samples</p>
<p>int readings[numReadings];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the readings from the analog input<br />
	int index = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the index of the current reading<br />
	float total = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the running total<br />
	float val = 0; // the average<br />
	//*****END FREQUENCY SETUP*****************************<br />
	&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12547"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 03/06/2013 - 10:07.</div>
    <div class="content">
     <p>Firstly, frequency is defined as the number of cycles in a unit of time. I can&#39;t see where you are measuring time, and I can&#39;t see where you are trying to relate time to the number of cycles. What is inputPin connected to? You need to check what PulseIn( ) actually does, and think what HIGH and LOW mean - especially in terms of an analogue signal. It doesn&#39;t do what you seem to think it does.</p>
<p>Secondly, you will most likely suffer a lack of accuracy if you stay with emonLib. The reason is, the time to execute the loop is dependent upon the ADC, so as the crossing is detected only once within the loop, and it is not synchronous to the mains frequency, there will be a large amount of jitter if you time the loop. Clearly, if you time many loops, the amount of jitter will decrease in proportion, but it will still be present.</p>
<p>MartinR&#39;s phase locked loop adjusts the divider for the clock frequency of the processor to synchronise itself exactly with the mains, so the jitter is very small - as you can see if you run the code, the voltage at the crossing (which should be zero if the loop is exactly synchonous) changes by only a few volts, representing less than 50 &micro;s and typically about 10 &micro;s jitter. Compare that to emonLib that typically takes around 400 &micro;s per input pair (V &amp; I) to execute the loop.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12658"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Thu, 06/06/2013 - 00:33.</div>
    <div class="content">
     <p>My frequency code</p>
<p>&nbsp;</p>
<p>#define inputPin 2 &nbsp;// hardware connect to a 1K resistor off the Voltage divider feeding the Voltage for emonlib</p>
<p>The output line below adjusts for error (calibrates per wavelength) and calculates frequency using 1000 milliseconds as the timebase.</p>
<p>val is the time per half cycle multiplied by 2 to get one cycle, adjust for error and calculate pulse timing in one second.</p>
<p>This line takes a number of readings(pulses) - take as many as you like but it slows down the loop, NOT the measurement accuracy.</p>
<p>const int numReadings = 6;// Frequency samples # of half waves samples</p>
<p>Serial.print((1000/((val*2/1000.0)-freqerror)),2); //frequency - freqerror is the calibration devised to setup</p>
<p>The frequency stays within +-0.1Hz</p>
<p>************************************************</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12680"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Thu, 06/06/2013 - 09:48.</div>
    <div class="content">
     <p><em>freqerror is the calibration devised to setup</em></p>
<p>can you explain that?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12689"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 06/06/2013 - 11:58.</div>
    <div class="content">
     <p>Sorry, Platypus, but while your idea is good, the way you have converted it into code is wrong. Unless I am mistaken, you are taking part of the voltage wave and using pulseIn( ) to time the period when the input is high. That depends on the amplitude of the voltage wave and where the processor input decides that it will be &quot;HIGH&quot; and &quot;LOW&quot;. Normally, &quot;HIGH&quot; is when the input&nbsp; is above 0.7 x Vcc&nbsp; and &quot;LOW&quot; is when the input is below 0.3 x Vcc.&nbsp; Both these points will move along the wave as voltage changes, and they also depend on the d.c level. They might not be symmetrical about the true midpoint of your input wave. Therefore, you are not timing a true half cycle. Also, there is no guarantee that your wave is truly symmetrical, so the two halves might not be exactly equal. PulseIn( ) is designed for timing <em>pulses</em> with square edges, not sine waves. I think that is the reason you need&nbsp;<em>freqerror</em>.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12692"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Thu, 06/06/2013 - 12:55.</div>
    <div class="content">
     <p>Ah, I see what Platypus is doing now Robert, using the digital pulse input as a crude zero crossing detector on the analogue voltage input. As you say, quite clever but not very reliable. I suppose it might work reasonably well if you only used one edge.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12698"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Thu, 06/06/2013 - 20:12.</div>
    <div class="content">
     <p>How about this for a better solution...</p>
<p>Instead of using a digital input to detect a point in the waveform, use the analogue comparator in the ATmega. By connecting one input to the band gap reference and the other to the a/c input pin you can get a very consistent sampling point in the waveform. The output of the comparator can be used to trigger the input compare register in timer 1 so you can get a direct reading of the cycle period.</p>
<p>Here&rsquo;s the code I used to test this...</p>
<p>float measureFrequency(byte pin)<br />
	{<br />
	&nbsp; word count;<br />
	&nbsp; byte oldADCSRA=ADCSRA;<br />
	&nbsp; byte oldADCSRB=ADCSRB;<br />
	&nbsp; byte oldADMUX=ADMUX;<br />
	&nbsp;<br />
	&nbsp; bitClear(ADCSRA,ADEN); // disable ADC because we are using ADMUX<br />
	&nbsp; bitSet(ADCSRB,ACME); // enable ADMUX for comparator<br />
	&nbsp; ADMUX=pin; // select pin for comparator -ve i/p<br />
	&nbsp; ACSR = _BV(ACBG) | _BV(ACIC); // enable comparator to trigger timer 0, band gap is +ve i/p<br />
	&nbsp; TCCR1A=0; // timer 1 normal mode<br />
	&nbsp; TCCR1B = _BV(ICNC1) | _BV(CS11); // enable noise canceller, /8 prescaler<br />
	&nbsp;<br />
	&nbsp; noInterrupts(); // so we don&#39;t get delayed by other interrupts<br />
	&nbsp; bitSet(TIFR1,ICF1); // clear i/p compare flag<br />
	&nbsp; while(!bitRead(TIFR1,ICF1)); // wait for comparator (this will freeze if no a/c)<br />
	&nbsp; count=ICR1L | ((word)ICR1H&lt;&lt;8); // get start timer count<br />
	&nbsp; bitSet(TIFR1,ICF1); // clear flag for next comparison<br />
	&nbsp; while(!bitRead(TIFR1,ICF1)); // wait for comparator (this will freeze if no a/c)<br />
	&nbsp; count = (ICR1L | ((word)ICR1H&lt;&lt;8)) - count; // get period of cycle<br />
	&nbsp; interrupts();<br />
	&nbsp;<br />
	&nbsp; ADCSRA=oldADCSRA; // restore ADC state<br />
	&nbsp; ADCSRB=oldADCSRB;<br />
	&nbsp; ADMUX=oldADMUX;</p>
<p>&nbsp; return 2000000.0/count; // timer frequency is 2MHz<br />
	}</p>
<p>Call this function, passing the analogue pin you want to test, and it will return the frequency in Hertz measured over a single cycle.</p>
<p>The resolution is 500ns and it seems to work pretty well without any averaging, although you&rsquo;d probably want some smoothing for display purposes.</p>
<p>-martin</p>
<p>edited to correct prescaler comment</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12710"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Fri, 07/06/2013 - 09:17.</div>
    <div class="content">
     <p>Thanks Martin, I tried your code but couldn&#39;t get it to work.</p>
<p>Could you post the complete sketch please.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12711"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Fri, 07/06/2013 - 13:23.</div>
    <div class="content">
     <p>If anyone can extract the frequency only from the attached file I am sure we would all be grateful.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12718"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 07/06/2013 - 13:38.</div>
    <div class="content">
     <p>You need to click &quot;List&quot; when you attach a file, else we cannot see it. I&#39;ve done it for you.</p>
<p>And I think you need to read the sketch carefully. If I look in sendResults( ) I can quite clearly see these lines:</p>
<p>&nbsp; Serial.print(&quot; &quot;);<br />
	<strong>&nbsp; Serial.print(frequency);</strong><br />
	&nbsp; Serial.print(&quot; &quot;);</p>
<p>	and it seems to print the value for me too</p>
<p>506 513 508 257.56 3.53 0.02 0.00 <strong>50.07</strong> 300.00 0.11 PLL is locked<br />
	&nbsp;</p>
<p>I can&#39;t get Martin&#39;s measureFrequency( ) to work either, he knows and he will look at it later.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12728"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Fri, 07/06/2013 - 17:07.</div>
    <div class="content">
     <p>platypus,</p>
<p>We&#39;ve solved Robert&#39;s problem with my code, it was due to noise and I think that it&#39;s unlikely you are having the same problem.</p>
<p>The rest of my sketch is just...</p>
<p>void setup()<br />
	{<br />
	&nbsp; Serial.begin(9600);<br />
	}</p>
<p>void loop()<br />
	{<br />
	&nbsp; Serial.println(measureFrequency(2)); // 2 is the analogue pin for the a/c input, you may need to change this<br />
	&nbsp; delay(500);<br />
	}</p>
<p>For this sketch to work the a/c input needs to be referenced to Vcc/2, as it is in emonTx, and the amplitude of the a/c signal needs to be large enough for it to cross the 1.1V band gap reference value. Ideally this crossing should be during the steep part of the sine wave, so a large signal is better.</p>
<p>I suspect that the reason it doesn&#39;t work for you is that the 0.5V you are using isn&#39;t large enough for the signal to cross the 1.1V threshold. There are two things you could do to remedy this, either change your resistor divider values to get a larger signal or use a different reference voltage for the comparator.</p>
<p>The best reference voltage to use&nbsp; is the centre of the bias circuit that your a/c signal is connected to i.e. Vcc/2. This will then trigger the comparator at the true zero crossings. To do this you need to connect a wire from the ATmega328 AIN0 input (pin 12) to the centre of the resistor divider in your bias circuit.</p>
<p>You also need to change the sketch to stop using the band gap reference as follows:</p>
<p>change ACSR = _BV(ACBG) | _BV(ACIC); // enable comparator to trigger timer 0, band gap is +ve i/p</p>
<p>to ACSR = _BV(ACIC); // enable comparator to trigger timer 0, AIN0 is +ve i/p</p>
<p>This sketch just measures the period of a cycle, as yours does. The difference is that it measures a whole cycle rather than an indeterminate part of a cycle and so doesn&#39;t need freqerror to compensate for the unknown fraction of a cycle that you are measuring.</p>
<p>Or you could just use the PLL sketch as Roberts suggested....</p>
<p>Martin</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12736"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 07/06/2013 - 18:56.</div>
    <div class="content">
     <p>My problem appears to have been noise pickup from my laptop&#39;s power supply (which is not earthed so the laptop floats at around 100 V a.c.)&nbsp; So it would be worth checking for noise on the a.c. voltage reference.</p>
<p>If I&#39;m reading the data sheet correctly, the hysteresis of the comparator is about 0.33 mV with a 3.3 V supply (Figure 29-27) so without a low-pass filter of the hardware kind, I think this method could well be problematical. Putting that number into some kind of perspective, the noise only needs to be 0.01% of the signal and potentially you have a problem.</p>
<p>On the other hand, Martin&#39;s PLL is rock solid and faithfully follows mains frequency variations.</p>
<p>[Edit]<br />
	A 1 nF capacitor in parallel with the 10 k resistor of the voltage input divider suppresses the noise for me and gives steady readings, but introduces a small (&lt; 0.2&deg;) phase shift that can easily be corrected by adjusting the phase calibration.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12744"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Fri, 07/06/2013 - 23:55.</div>
    <div class="content">
     <p>Thanks Robert for the amplitude idea - will change my divider which is at about 0.5Vrms right now - how far above 1.1Vrms would you recommend - would 1.5Vrms do?</p>
<p>I am using the Vcc/2 on each of the voltage and CT dividers - my Vcc is 5V</p>
<p>Must be some confusion, but I had no problem running the emontx&nbsp;sketch, just Martins sketch - no output function..</p>
<p>I need a short form of the&nbsp;emontx&nbsp;sketch, just to measure frequency in a PLL - any ideas on how to extract just the frequency code?&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12748"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 08/06/2013 - 12:21.</div>
    <div class="content">
     <p>If you are running your processor at 5 V, then you want your a.c. input voltage to swing to 5 V peak-peak at maximum supply voltage <em>less</em> an allowance for resistor tolerances. So about 1.4 V rms seems a good number to aim for. 1.5 V gives you 15% spare, 10% for voltage tolerance leaving 5% for 4 resistors. It <em>should</em> be OK with 1% resistors in both the divider and the bias, but it is close (see <a href="https://learn.openenergymonitor.org/?redirect=acac-component-tolerances" title="ACAC Component tolerances">ACAC Component tolerances</a> for more information on how tolerances affect the design).</p>
<p>(It was MartinR who saw that your voltage input was too small.)</p>
<p>MartinR published a frequency-only sketch while he was developing the full controller, here <a href="../sites/default/files/phase_lock_50hz.html" title="http://openenergymonitor.org/emon/sites/default/files/phase_lock_50hz.ino">http://openenergymonitor.org/emon/sites/default/files/phase_lock_50hz.ino</a></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12750"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sat, 08/06/2013 - 12:34.</div>
    <div class="content">
     <p>ooh - I&#39;d forgotten about that :) Well remembered!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12766"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Sun, 09/06/2013 - 09:18.</div>
    <div class="content">
     <p>Well nice work Martin and Robert - I will try this.</p>
<p>Up to now I had not needed to look into the ADCSRA and band gap as it is complicated, although obviously useful.</p>
<p>But as you said we probably don&#39;t need to reference to 1.1V but rather an aref of 2.5V might be fine.</p>
<p>emonlib does seem to use the 1.1V though as here in emonlib.cpp (at the end of the code)</p>
<p>long EnergyMonitor::readVcc() {<br />
	&nbsp; long result;<br />
	&nbsp; ADMUX = _BV(REFS0) | _BV(MUX3) | _BV(MUX2) | _BV(MUX1);<br />
	&nbsp; delay(2);<br />
	&nbsp; ADCSRA |= _BV(ADSC);<br />
	&nbsp; while (bit_is_set(ADCSRA,ADSC));<br />
	&nbsp; result = ADCL;<br />
	&nbsp; result |= ADCH&lt;&lt;8;<br />
	&nbsp; result = 1126400L / result;<br />
	&nbsp; return result;</p>
<p>Will try your code Martin and hopefully there is no conflict with this code as above - would you have some description of this bit of code - yes its a good learning exercise.</p>
<p>Even though the emontx (for solar) sketch does give a nice PLL frequencythe sketch is way too large to use just for frequency. Will also look at your code link Martin.</p>
<p>&nbsp;You have both been quite helpful, thanks.</p>
<p>I think many others might have learned quite a bit from this so far.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12767"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Sun, 09/06/2013 - 09:47.</div>
    <div class="content">
     <p>Nice frequency sketch Martin</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12771"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Tue, 11/06/2013 - 04:25.</div>
    <div class="content">
     <p>I couldn&#39;t wait until morning so I ran your sketch, as is, Martin, just to see what would happen without making the adjustments.</p>
<p>Have yet to make the changes as per your post on 8-6-13, 3:07</p>
<p>Well at least its attempting to work.</p>
<p>Here is some data direct from the serial monitor</p>
<p>Frequency = 400000.00</p>
<p>Frequency &nbsp;1000000.00<br />
	Frequency &nbsp;400000.00<br />
	Frequency 666666.68<br />
	Frequency 49.98<br />
	Frequency &nbsp;1000000.00<br />
	Frequency &nbsp;1000000.00<br />
	Frequency 1000000.00<br />
	Frequency 1000000.00<br />
	Frequency &nbsp;500000.00<br />
	Frequency &nbsp;367.65<br />
	Frequency 50.20<br />
	Frequency &nbsp;50.12<br />
	Frequency 1000000.00</p>
<p><strong>This is the complete sketch - changes yet to be made:</strong></p>
<p>/*<br />
	Frequency measurement<br />
	by Martin Roberts, 9 June 2013<br />
	*/</p>
<p>float measureFrequency(byte pin)<br />
	{<br />
	&nbsp; word count;<br />
	&nbsp; byte oldADCSRA=ADCSRA;<br />
	&nbsp; byte oldADCSRB=ADCSRB;<br />
	&nbsp; byte oldADMUX=ADMUX;</p>
<p>	&nbsp; bitClear(ADCSRA,ADEN); // disable ADC because we are using ADMUX<br />
	&nbsp; bitSet(ADCSRB,ACME); // enable ADMUX for comparator<br />
	&nbsp; ADMUX=pin; // select pin for comparator -ve i/p<br />
	&nbsp; ACSR = _BV(ACBG) | _BV(ACIC); // enable comparator to trigger timer 0, band gap is +ve i/p<br />
	&nbsp; TCCR1A=0; // timer 1 normal mode<br />
	&nbsp; TCCR1B = _BV(ICNC1) | _BV(CS11); // enable noise canceller, /8 prescaler</p>
<p>	&nbsp; noInterrupts(); // so we don&#39;t get delayed by other interrupts<br />
	&nbsp; bitSet(TIFR1,ICF1); // clear i/p compare flag<br />
	&nbsp; while(!bitRead(TIFR1,ICF1)); // wait for comparator (this will freeze if no a/c)<br />
	&nbsp; count=ICR1L | ((word)ICR1H&lt;&lt;8); // get start timer count<br />
	&nbsp; bitSet(TIFR1,ICF1); // clear flag for next comparison<br />
	&nbsp; while(!bitRead(TIFR1,ICF1)); // wait for comparator (this will freeze if no a/c)<br />
	&nbsp; count = (ICR1L | ((word)ICR1H&lt;&lt;8)) - count; // get period of cycle<br />
	&nbsp; interrupts();</p>
<p>	&nbsp; ADCSRA=oldADCSRA; // restore ADC state<br />
	&nbsp; ADCSRB=oldADCSRB;<br />
	&nbsp; ADMUX=oldADMUX;<br />
	&nbsp; return 2000000.0/count; // timer frequency is 2MHz<br />
	}</p>
<p>void setup()<br />
	{<br />
	Serial.begin(9600);<br />
	&nbsp;<br />
	}</p>
<p>void loop()<br />
	{<br />
	&nbsp; Serial.print(&quot; Frequency = &quot;);<br />
	&nbsp; Serial.println(measureFrequency(5)); // 2 is the analogue pin for the a/c input, you may need to change this<br />
	&nbsp; delay(1500);</p>
<p>}</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12772"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 09/06/2013 - 13:46.</div>
    <div class="content">
     <p>Just a note about the internal reference. It is a band-gap reference, the <em>tolerance</em> is poor ( 1.1 V &plusmn; 0.1 V) but its long-term <em>stability</em> is good. On the other hand, the 3.3 V or 5 V regulator - MCP1702 - has a <em>tolerance</em> of &plusmn; 3% (and typically 0.4% - significantly better), but is subject to 50 ppm per &deg;C temperature drift plus 0.3%/V line regulation plus 2.5% load regulation (1 - 250 mA) plus a PSRR of 0.6%.</p>
<p>The purpose of scaling the input using the internal band-gap reference (which is ultimately what that emonLib method does) is to allow battery operation, where the supply will clearly drop as the battery runs down. If the 3.3 V regulator in the emonTx has a pre-regulated 5 V input and a constant load and operates at a constant temperature, many of these variations will be much reduced, and the supply from the MCP1702 will be more precise, but possibly still not as stable. If you look up one of the original papers by the inventor of the band-gap reference, he claims that with on-chip thin film resistors, a temperature stability of less than 4 ppm/ &deg;C is possible. I have not found any specific data for the reference in the Atmega328P.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12798"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Sun, 09/06/2013 - 23:54.</div>
    <div class="content">
     <p>Using Martins recent &nbsp;sketch..</p>
<p>After adjusting ACSR&nbsp;= _BV(ASIC_</p>
<p>and adding a wire from AIN0 to center of volt divider, I got this</p>
<p>Frequency PLL= 24691.36<br />
	Frequency PLL= 64516.13<br />
	Frequency PLL= 21978.02<br />
	Frequency PLL= 21505.38<br />
	Frequency PLL= 16000.00<br />
	Frequency PLL= 57142.85<br />
	Frequency PLL= 16000.00<br />
	Frequency PLL= 22222.22<br />
	Frequency PLL= 117647.07<br />
	Frequency PLL= 15873.02<br />
	Frequency PLL= 28169.01<br />
	Frequency PLL= 449.9</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12800"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 10/06/2013 - 00:24.</div>
    <div class="content">
     <p>That looks similar to the numbers I got without a hardware filter. I assume you have followed all of MartinR&#39;s advice. See above for what I needed to do additionally.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12805"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 10/06/2013 - 06:52.</div>
    <div class="content">
     <p>Firstly platypus, this bit of code does not implement a PLL, it just times the period of 1 cycle as I explained above, so it&#39;s probably best that you remove the &quot;Frequency PLL&quot; comment to avoid confusion.</p>
<p>This simple method does seem to be&nbsp;sensitive to noise as Robert found, so unless you have the means and determination to track down the source and fix it you are probably better off using the old phase_lock_50Hz sketch that Robert suggested.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12839"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Tue, 11/06/2013 - 04:46.</div>
    <div class="content">
     <p>Thanks Martin, have removed PLL from the previous post.</p>
<p>Your phase lock sketch works well, by itself - from the link that Robert posted.</p>
<p>I ultimately want to add phase locked frequency to emonlib.</p>
<p>An attempt to add your phase lock code to the emonlib sketch failed - think by trying to add the code on an, as is, basis there was some conflict, perhaps with the &#39;already there&#39; bandgap code in emonlib.cpp</p>
<p>So that&#39;s where I was heading.</p>
<p>Have I missed an update that already has this functionality?</p>
<p>And yes, you are absolutely correct, playing with this type of code is complicated and needs perseverance.</p>
<p>Robert and yourself have already put in quite a lot of time here, thanks - hopefully others have also benefitted by your combined experience. At least your phase locked sketch has bubbled up again and does work.</p>
<p>All the best..</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12850"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 11/06/2013 - 10:40.</div>
    <div class="content">
     <p>You simply will not be able to add a PLL function to emonLib. EmonLib works in a quite different way; the correct approach is to see the whole sketch as one complete entity, not as several pieces bolted together. What is wrong with Martin&#39;s <a href="1535.html" title="http://openenergymonitor.org/emon/node/1535">http://openenergymonitor.org/emon/node/1535</a> ?&nbsp; If you need to read more c.t&#39;s, they can be added (but you might need to reduce the number of samples per cycle).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12856"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1775.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1775.jpg" alt="Brian D&#039;s picture" title="Brian D&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/1775.html" title="View user profile.">Brian D</a> on Tue, 11/06/2013 - 11:55.</div>
    <div class="content">
     <p>I have not read everything above but a photo of my emonGLCD displaying frequency sent using Martin&#39;s code is attached.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12888"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Wed, 12/06/2013 - 07:00.</div>
    <div class="content">
     <p>Thanks Robert, yes I guessed that there was a conflict between emonlib and Martins PLL code but just don&#39;t have the time to play with this further.</p>
<p>I am also getting a random glitch in display from the emonitor where suddenly the voltage goes haywire, resets, then the very next line is fine. Of course, it affects all the energy calculations</p>
<p>Here is the Serial Monitor display of the fault - dont worry about the unusual current, this is on a 200A test CT with 25turns active as booster. This load is a fridge on voltage regulation equipment.</p>
<p>The frequency is a modification of my previous crude version which used a dual pulseIn(), high followed by low with extra code to prevent wandering - so I have locked the high/low together to catch a whole cycle - its very close.</p>
<p>Frequency is not affected as it is sensed/calculated outside the emon code.</p>
<p>The lines in bold show the glitch/es</p>
<p><u><strong>On No Load</strong></u></p>
<p>V=221.9&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 75.14 Temp= 25.20 degC<br />
	V=221.8&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 60.04 Temp= 25.20 degC<br />
	V=221.3&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 50.01 Temp= 25.20 degC<br />
	V=223.1&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 50.00 Temp= 25.20 degC<br />
	<strong>V=-0.2&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 50.02 Temp= 25.68 degC</strong><br />
	V=223.3&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 50.02 Temp= 25.20 degC<br />
	V=221.1&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 50.02 Temp= 25.20 degC<br />
	V=222.5&nbsp; I= NoLoad&nbsp; KW=0.00&nbsp; KVA=0.00&nbsp; KVAr=0.00&nbsp; PF= 0.999&nbsp; PG=357.44&nbsp; Freq= 50.00 Temp= 24.71 degC<br />
	V=222.</p>
<p><u><strong>With Load</strong></u></p>
<p>V=219.0&nbsp; I= 35.56&nbsp; KW=5.49&nbsp; KVA=7.79&nbsp; KVAr=5.52&nbsp; PF= 0.705&nbsp; PG=314.83&nbsp; Freq= 50.03 Temp= 24.71 degC<br />
	V=220.4&nbsp; I= 35.68&nbsp; KW=5.54&nbsp; KVA=7.87&nbsp; KVAr=5.59&nbsp; PF= 0.704&nbsp; PG=314.75&nbsp; Freq= 50.00 Temp= 25.20 degC<br />
	V=219.8&nbsp; I= 35.71&nbsp; KW=5.53&nbsp; KVA=7.85&nbsp; KVAr=5.58&nbsp; PF= 0.704&nbsp; PG=314.74&nbsp; Freq= 50.03 Temp= 25.68 degC<br />
	V=219.1&nbsp; I= 35.60&nbsp; KW=5.47&nbsp; KVA=7.80&nbsp; KVAr=5.56&nbsp; PF= 0.702&nbsp; PG=314.57&nbsp; Freq= 50.03 Temp= 25.20 degC<br />
	<strong>V=2444.4&nbsp; I= 398.11&nbsp; KW=681.11&nbsp; KVA=973.13&nbsp; KVAr=695.03&nbsp; PF= 0.700&nbsp; PG=314.42&nbsp; Freq= 50.03 Temp= 25.68 degC</strong><br />
	V=219.4&nbsp; I= 35.69&nbsp; KW=5.49&nbsp; KVA=7.83&nbsp; KVAr=5.58&nbsp; PF= 0.701&nbsp; PG=314.50&nbsp; Freq= 50.01 Temp= 25.20 degC<br />
	V=219.6&nbsp; I= 35.55&nbsp; KW=5.47&nbsp; KVA=7.81&nbsp; KVAr=5.57&nbsp; PF= 0.700&nbsp; PG=314.44&nbsp; Freq= 50.00 Temp= 25.68 degC<br />
	V=219.7&nbsp; I= 35.51&nbsp; KW=5.47&nbsp; KVA=7.80&nbsp; KVAr=5.56&nbsp; PF= 0.701&nbsp; PG=314.52&nbsp; Freq= 50.00 Temp= 24.71 degC<br />
	V</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12898"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 12/06/2013 - 11:20.</div>
    <div class="content">
     <p>I need to see the code you are running to be able to even start to think about that one. When you write &quot;<em>the voltage goes haywire, resets, then the very next line is fine. </em>&quot; do you mean &quot;resets&quot; as in the processor restarts the sketch from the top? -and how do you know?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12938"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3756.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="platypus&#039;s picture" title="platypus&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/3756.html" title="View user profile.">platypus</a> on Thu, 13/06/2013 - 02:43.</div>
    <div class="content">
     <p>Robert, I suspect a connection issue here.</p>
<p>Also can you say for which which Arduino&nbsp;boards emonlib was written?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12942"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding Frequency</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 13/06/2013 - 09:28.</div>
    <div class="content">
     <p>EmonLib is written not for Arduino boards, but for the emonTx with the 328P processor. However, you appear to be reading voltage, frequency and current correctly most of the time, which to me rules out a basic problem like wrong pins.</p>
<p>What is puzzling me is the negative voltage that you see. You cannot have a square root of a negative number (it is &quot;nan&quot;), so (working backwards through the emonLib method that calculates Vrms) VRATIO must be negative. Therefore either VCAL or SUPPLYVOLTAGE must be negative (but not both). If VCAL is negative, the parameters you are passing to EnergyMonitor::voltage(int _inPinV, double _VCAL, double _PHASECAL) are wrong, and why are all the other values correct?; if SUPPLYVOLTAGE is negative, then readVcc( ) is returning a negative number.</p>
<p>You need to find out why readVcc( ) is returning a wrong value occasionally. The first step of course is to substitute a constant value instead of the call to readVcc( ) and prove that I am correct so far.</p>
<p>The reason I wanted sight of your code is because &quot;I=noload&quot; is not part of any of the standard sketches, and it&#39;s difficult to diagnose a problem blind.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2426"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-Ohh0D0KJ2uBgqFZ5v6SggjMwCCcz075XgA6HlNuw2cc" value="form-Ohh0D0KJ2uBgqFZ5v6SggjMwCCcz075XgA6HlNuw2cc"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
