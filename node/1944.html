<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1944 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:43:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>M-Bus ? | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">M-Bus ?</h3>
        <span class="submitted">Submitted by Guest on Mon, 21/01/2013 - 19:25</span>
        <div class="content"><p>Is there any activity in OpenEnergyMonitor on the M-bus protocol? (M-Bus = Meter Bus, not Multi-Bus). &nbsp;Hardware level converters from M-Bus to RS-232/ or 485 / USB &nbsp;/ software ? A number of energy monitoring devices and sensors becoming available that support M-Bus.&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="12085.html" class="topic-previous" title="Go to previous forum topic">‹ Consultancy support service?</a>
              <a href="12071.html" class="topic-next" title="Go to next forum topic">Battery powered, two CT monitor ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-14738"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4288.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Wxll&#039;s picture" title="Wxll&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/4288.html" title="View user profile.">Wxll</a> on Tue, 03/09/2013 - 12:49.</div>
    <div class="content">
     <p>BUMP Post.</p>
<p>Would be interesting in this too, M-Bus is rather interesting as it is similar to the I2C&nbsp;bus. Commercial products to read the&nbsp;Mbus are often insane priced (250+).</p>
<p>--- Update 3-Sep-2013 ---</p>
<pre>
<strong><span style="font-family: Arial, Verdana, sans-serif;">
M-Bus Information:
</span></strong><span style="font-family: Arial, Verdana, sans-serif;">An opensource C-library can be found on github: </span><a href="https://github.com/rscada/libmbus"><span style="font-family: Arial, Verdana, sans-serif;">https://github.com/rscada/libmbus</span></a><strong><span style="font-family: Arial, Verdana, sans-serif;">

Transmission Characteristics (source m-bus documentation)
</span></strong><em style="font-family: Arial, Verdana, sans-serif;">The slaves are designed to be constant current sinks with two different currents, 
whereby the current which is &quot;sunk&quot; must not 
vary by more than 0.2 % for 1 V voltage change on the bus. In order to transmit a 
Mark, a so-called Unit Load consisting of a 
constant current of 1.5 mA maximum is specified. If the slave needs more current, 
an appropriate number of additional Unit
Loads must be used. When sending a Space, the slave increases its current 
consumption by 11-20mA. In order to receive 
data, the slave detects the maximum value Vmax of the bus voltage, which can 
be between 21 V and 42 V. With a bus 
voltage of more than Vmax - 5.5 V, a Mark should be registered, and with a 
voltage of less than Vmax - 8,2 V, a Space 
should be registered.</em></pre><p>Reading the M-Bus specs there is a IC TSS721 that does most of the job.</p>
<p>&nbsp;</p>
<p>TSS721 (source:&nbsp;<a href="http://www.m-bus.com/mbusdoc/md4.php">http://www.m-bus.com/mbusdoc/md4.php</a>)<br />
	<img alt="" src="../../../www.m-bus.com/mbusdoc/Image7.gif" style="width: 300px; height: 190px;" /></p>
<p><img alt="" src="../../../www.m-bus.com/mbusdoc/Image8.gif" style="width: 500px; height: 306px;" /></p>
<p><img alt="" src="../../../www.m-bus.com/mbusdoc/Image9.gif" style="width: 400px; height: 139px;" /></p>
<p>&nbsp;</p>
<p>And a very simple one based on RS232:</p>
<p><img alt="" src="http://www.m-bus.com/files/minimaster.tif" />&nbsp;( it&#39;s a tif so if you can&#39;t see it, copy url and download it)</p>
<p>&nbsp;</p>
<p>I&#39;ll have a go with this later on.&nbsp;</p>
<p>&nbsp;</p>
<p>Wxll</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-16936"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="IntoMethod&#039;s picture" title="IntoMethod&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by IntoMethod (not verified) on Sat, 21/12/2013 - 13:51.</div>
    <div class="content">
     <p>Hi, did you have any success with the m-bus reader using the rs232 level converter (as in the tiff-image) ?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-20504"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4288.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Wxll&#039;s picture" title="Wxll&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/4288.html" title="View user profile.">Wxll</a> on Sat, 05/04/2014 - 21:19.</div>
    <div class="content">
     <p>no not yet. I glanced over it recently and collected a little bit more info but haven&#39;t build anything yet.</p>
<p>I did found some one who did quite some work and shared his:</p>
<p><a href="http://a385e-5.de/?cat=11" title="http://a385e-5.de/?cat=11">http://a385e-5.de/?cat=11</a></p>
<p>I think I go with his work on this, looks good.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-22136"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5678.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5678.png" alt="mircsicz&#039;s picture" title="mircsicz&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/5678.html" title="View user profile.">mircsicz</a> on Mon, 23/06/2014 - 23:35.</div>
    <div class="content">
     <p>Hi there,</p>
<p>I&#39;ve been using libmbus since version 0.3 and have always been very happy with it... I&#39;ld be very interested in getting a deeper integration to work.</p>
<p>My current solution in regards of emoncms is to simply run curl for every value I transmit... So there&#39;s a shell script run every 15min&#39;s&nbsp;from cron, and that script calls libmbus&nbsp;get&#39;s the mbus response extracts the value&#39;s and generate&#39;s a curl line.</p>
<p>Think it would be perfect to have like a emonhub framework to read from plugins like libmbus or the tools from the volkszaehler.org project: like</p>
<div>
	http://wiki.volkszaehler.org/software/controller/m-bus</div>
<div>
	http://wiki.volkszaehler.org/software/controller/vzlogger</div>
<p>never tested vzlogger, but as it reads so many different meter&#39;s I would love to...</p>
<div>
	And as reference: I&#39;m very happy with this ethernet-master:&nbsp;</div>
<div>
	http://www.adfweb.com/home/products/mbus_ethernet.asp?frompg=GooMbus</div>
<div>
	and have successfully tested this rs232-master (it&#39;s only 70&euro;)</div>
<div>
	http://www.a2s.pl/en/m-bus-10-p-3150.html</div>
<div>
	&nbsp;</div>
<div>
	Greetz</div>
<div>
	Mircsicz</div>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29234"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Tue, 31/03/2015 - 19:33.</div>
    <div class="content">
     <p>John Cantor and I are looking at how we could connect a couple of different heat meters with m-bus to the OpenEnergyMonitor system for heatpump monitoring. I dont yet have any experience with m-bus, I might try starting by building the circuit here <a href="https://github.com/rscada/libmbus/tree/master/hardware" title="https://github.com/rscada/libmbus/tree/master/hardware">https://github.com/rscada/libmbus/tree/master/hardware</a> looking at both libmbus there and <a href="http://wiki.volkszaehler.org/software/controller/m-bus" title="http://wiki.volkszaehler.org/software/controller/m-bus">http://wiki.volkszaehler.org/software/controller/m-bus</a> as Mircsicz suggests.</p>
<p>But I wonder if anyone else has more experience of this and can give me an idea of what might be involved in getting data out of a kamstrup 402 with mbus module <a href="http://www.termonet.rs/pdfpr/Data Sheet  MC402.pdf" title="http://www.termonet.rs/pdfpr/Data%20Sheet%20%20MC402.pdf">http://www.termonet.rs/pdfpr/Data%20Sheet%20%20MC402.pdf</a> or a sontex <a href="http://www.rhimetering.co.uk/pdf/Sontex-Superstatic-449-Datasheet.pdf" title="http://www.rhimetering.co.uk/pdf/Sontex-Superstatic-449-Datasheet.pdf">http://www.rhimetering.co.uk/pdf/Sontex-Superstatic-449-Datasheet.pdf</a></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29237"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6359.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pisoni.silvano@gmail.com&#039;s picture" title="pisoni.silvano@gmail.com&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/6359.html" title="View user profile.">pisoni.silvano@...</a> on Tue, 31/03/2015 - 20:03.</div>
    <div class="content">
     <p><a href="http://www.openmuc.xn--org-0da/" title="http://www.openmuc.org ">http://www.openmuc.org </a></p>
<p>&nbsp;</p>
<p>[Please read <a href="10391.html" title="http://openenergymonitor.org/emon/node/10391">http://openenergymonitor.org/emon/node/10391</a> - <i>Moderator</i>]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29244"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 31/03/2015 - 22:26.</div>
    <div class="content">
     <p>(The link above should be&nbsp;<a href="http://www.openmuc.org/">http://www.openmuc.org</a>&nbsp;not&nbsp;http://www.openmuc.org%20/)</p>
<p>Also see&nbsp;<a href="https://code.google.com/p/iotsys/wiki/MBusConnector#M-Bus-Master_for_Raspberry_Pi">https://code.google.com/p/iotsys/wiki/MBusConnector#M-Bus-Master_for_Raspberry_Pi</a></p>
<p>and in particular towards the end of&nbsp;that page is <a href="https://code.google.com/p/iotsys/wiki/MBusConnector#M-Bus-Master_for_Raspberry_Pi">a schematic and layout for a Pi&nbsp;gpio&nbsp;-&gt; M-Bus interface</a></p>
<p>It would cause a conflict for use with a RFM2Pi,&nbsp;but maybe a RFM69Pi&#39;s&nbsp;IO&nbsp;could be utilized with a custom sketch&nbsp;to &quot;merge&quot; M-Bus and RFM packets into the Pi&#39;s serial port ?</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29255"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Wed, 01/04/2015 - 08:37.</div>
    <div class="content">
     <p>Thanks a lot Paul. I will try those out.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30753"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Fri, 29/05/2015 - 14:40.</div>
    <div class="content">
     <p>Good news, John Cantor (<a href="http://heatpumps.co.uk/" title="http://heatpumps.co.uk/">http://heatpumps.co.uk/</a>) and I got the MBUS reader circuit by rscada <a href="https://github.com/rscada/libmbus/tree/master/hardware" title="https://github.com/rscada/libmbus/tree/master/hardware">https://github.com/rscada/libmbus/tree/master/hardware</a> to work and their libmbus library and command line mbus reader utility, reading data from a kampstrup 402 heat meter with the intention of using it for heatpump heat output monitoring. We then implemented a very lightweight kampstrup 402 meter specific reader for Arduino.</p>
<p><img alt="" src="../sites/default/files/CGLQ1ccWwAA7oEd.jpg_large.jpg" style="width: 600px; height: 337px;" /></p>
<p>We started by building the simple circuit below and connecting the TX and RX lines to a USB to Serial adapter connected to a laptop and providing 34V from a bench top DC power supply. We didn&#39;t have the BD136 PNP transistor so we used a 2N3906 PNP instead, which worked fine.<br />
<img alt="" src="../sites/default/files/mbus_levelshifter.png" style="width: 699px; height: 385px;" /><br />
We then downloaded libmbus library <a href="https://github.com/rscada/libmbus" title="https://github.com/rscada/libmbus">https://github.com/rscada/libmbus</a> and installed on linux :</p>
<p>&nbsp;&nbsp;&nbsp; ch libmbus<br />
&nbsp;&nbsp;&nbsp; sh build.sh<br />
&nbsp;&nbsp;&nbsp; sudo make install</p>
<p>Running</p>
<p>&nbsp;&nbsp;&nbsp; $ mbus-serial-scan /dev/ttyUSB0</p>
<p>reported &quot;Found a M-Bus device at address 68&quot;. Running</p>
<p>&nbsp;&nbsp;&nbsp; $ mbus-serial-request-data -b 2400 /dev/ttyUSB0 68</p>
<p>Printed the following XML output: <a href="../sites/default/files/example_xml_output.txt">http://openenergymonitor.org/emon/sites/default/files/example_xml_output.txt</a>.&nbsp;</p>
<p>With the bench top power supply connected and reading over USB to serial we could reduce the voltage driver all the way down to 18V and still receive a full frame from the MBus device, although I dont know how reliable that would be.</p>
<p>With the data being read over USB-to-Serial I then decided to dig a little into the protocol format to see if it would be possible to implement a reader that ran on an Arduino rather than needing a serial port on a computer or raspberrypi. There seems to be quite a few people looking to do this from searching on the internet but I couldn&#39;t find a solution that worked on an Arduino UNO the full libmbus library stores a lot of information that relates to particular byte values in large arrays which would completely fill the memory on the Atmega328.</p>
<p>By reading the MBUS protocol and kamstrup data frame description in the Kamstrup MBUS manual here <a href="http://www.oresundskraft.se/media/202136/m-bus_protokoll_f_r_multical_402.pdf" title="http://www.oresundskraft.se/media/202136/m-bus_protokoll_f_r_multical_402.pdf">http://www.oresundskraft.se/media/202136/m-bus_protokoll_f_r_multical_40...</a> and cross checking that by reading the byte values that where being received from the kamstrup meter and the source code for libmbus I put together a barebones Kamstrup 402 specific reader for Arduino:<br />
<a href="../sites/default/files/kamstrup402_mbus_reader.html" title="http://openenergymonitor.org/emon/sites/default/files/kamstrup402_mbus_reader.ino">http://openenergymonitor.org/emon/sites/default/files/kamstrup402_mbus_r...</a></p>
<p>Commands sent to the MBUS device need to be even parity 1 stop bit, the arduino hardware serial library supports this but the softserial arduino library does not. I tried various suggested modifications to the softserial library but couldnt get it to work so in the end settled on the temporary solution of sending the command string on the hardware serial tx line and receiving the reply on the softserial rx line. This at least kept most of the activity off the hardware serial port used to communicate with the computer.</p>
<p>Here&#39;s an example of the print out from the arduino reader showing the part of the kamstrup heatmeter data frame that we where most interested in:</p>
<p>Energy (kWh): 10<br />
Volume (m3): 2.72<br />
Ontime (hours): 2423<br />
Flow temperature: 18.36<br />
Return temperature: 18.16<br />
Temperature difference (K): 0.20<br />
Power (W): 0<br />
Max Power (W): 47<br />
Volume flow (m3/h): 0<br />
Max volume flow (m3/h): 1390</p>
<p>To decode the data frame its a matter of reading each byte in the frame and understanding from the data frame specification what each byte corresponds too. For example the first part of the header that specifies the frame type, data length and address is read like this:</p>
<p>&nbsp;&nbsp;&nbsp; start1 = bytes[0]<br />
&nbsp;&nbsp;&nbsp; length1 = bytes[1]<br />
&nbsp;&nbsp;&nbsp; length2 = bytes[2]<br />
&nbsp;&nbsp;&nbsp; start2 = bytes[3]<br />
&nbsp;&nbsp;&nbsp; control = bytes[4]<br />
&nbsp;&nbsp;&nbsp; address = bytes[5]<br />
&nbsp;&nbsp;&nbsp; control_information = bytes[6]</p>
<p>The first record starts at byte 25 and is 6 bytes long, the first 2 bytes corresponding to type and units and the last 4 bytes the value. Which can be decoded with, where i is the start byte of the record (i.e 25)</p>
<p>&nbsp;&nbsp;&nbsp; value = bytes[i+2] + (bytes[i+3]&lt;&lt;8) + (bytes[i+4]&lt;&lt;16) + (bytes[i+5]&lt;&lt;24)</p>
<p>It would be good to do some more reading up on the protocol in order to create a more generic less hardcoded arduino library for reading MBUS meters and sort the software serial library even parity bit issue but the above gives a working initial solution that can be built upon and integrated into the OpenEnergyMonitor system. Data could now be sent via RFM12/69 to an emonbase for logging in emoncms.</p>
<p>A small step-up converter can be used to provide the 34V required for the MBUS, we&#39;re going to try this one <a href="http://www.ebay.co.uk/itm/XL6009-DC-DC-Voltage-Step-Up-Boost-Converter-replace-LM2577-3-32v-input-UK-Fast-/400858208676" title="http://www.ebay.co.uk/itm/XL6009-DC-DC-Voltage-Step-Up-Boost-Converter-replace-LM2577-3-32v-input-UK-Fast-/400858208676">http://www.ebay.co.uk/itm/XL6009-DC-DC-Voltage-Step-Up-Boost-Converter-r...</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33699"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5908.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rbreuss&#039;s picture" title="rbreuss&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Sun, 30/08/2015 - 11:34.</div>
    <div class="content">
     <p>Hi Trystan,</p>
<p>Im working on to connect another meters with M-bus interface&nbsp;to Emoncms. I read your great tutorial in above (great job you made!) and I replicated HW interface you described. I have conected&nbsp;energy meter Siemens WFN21 with M-bus interface and it works ! Using libmbus&nbsp;at my Ubuntu desktop I got very similar structured output, like you got from your Kampstrup. There is just another set of registers and values represented by them, but registers structure seem to be the same. Now I will try to modify&nbsp;your .ino script for reading registers of my energy meter and to read values by my experimental Arduino Mega (for more HW Serials available).</p>
<p>Did you make any progress since your status&nbsp;description&nbsp;above&nbsp;from the end&nbsp;of May?</p>
<p>Radek&nbsp;&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33857"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Fri, 04/09/2015 - 11:50.</div>
    <div class="content">
     <p>Hello Radek, great to hear, yes we did make a little more progress, we built a couple of the reader circuits connected to emonth&#39;s to create a wireless emonth mbus reader. We&#39;re still reading the mbus meter address manually first.</p>
<p>Here&#39;s the firmware example for an emonth that connects to the reader circuit and then transmits via rfm12: <a href="../sites/default/files/kamstrup402_mbus_reader_rf12.html" title="http://openenergymonitor.org/emon/sites/default/files/kamstrup402_mbus_reader_rf12.ino">http://openenergymonitor.org/emon/sites/default/files/kamstrup402_mbus_r...</a></p>
<p>It would be good to get device address discovery going as part of this.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35594"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Mon, 02/11/2015 - 20:28.</div>
    <div class="content">
     <p>A little more progress on this. The hack that I was using above to first send the MBUS command on hardware serial and then receive the data on software serial can now be replaced with this nice software serial library by @ledongthuc on github</p>
<p><a href="https://github.com/ledongthuc/CustomSoftwareSerial" title="https://github.com/ledongthuc/CustomSoftwareSerial">https://github.com/ledongthuc/CustomSoftwareSerial</a></p>
<p>This alternative to the Arduino software serial library allows configuration of the software serial parity bit, stop bits and number of data bits which makes it easy to use 8 bit, even parity with one stop bit as required by MBUS.</p>
<p>I&#39;ve attached a reworked example of the last example I posted which uses this library, It also reads 2x DS18B20 temperature sensors and two analog inputs (flow temperature and flow rate) from a grundfos vortex flow meter which Im parallel testing alongside a kampstrup heatmeter.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38548"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9335.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="albert&#039;s picture" title="albert&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/9335.html" title="View user profile.">albert</a> on Wed, 20/01/2016 - 16:32.</div>
    <div class="content">
     <p>Hello TrystanLea.</p>
<p>I&#39;m doing a M-BUS master device. I wonder exactly how many slave can be connected to the hardware circuit discussed above in&nbsp;https://github.com/rscada/libmbus/tree/master/hardware.</p>
<p>Do&nbsp;you&nbsp;have tested many devices? How many?</p>
<p>I need to connect 8 slaves, and I need to know if the hardware circuit discussed above, it is sufficiently robust to endure 8 slaves. Because documentation sets &quot;Bus-driver for up to three meters&quot;</p>
<p>Then, I look a circuit hardware in ANALOG-BOARD&nbsp;for the Meter Bus Application&nbsp;of Texas&nbsp;Instruments&nbsp;http://cxjr.21ic.org/uploadfile-/200667162428749.pdf &nbsp;.Which it&nbsp;is more&nbsp;robust, it but more expensive.&nbsp;I do not know whether it is worth implement&nbsp;for 8 slaves, this circuit of Texas instruments.</p>
<p>Do&nbsp;you&nbsp;have tested many slaves&nbsp;with the circuit of libmbus? How many slaves?</p>
<p>Thank you very much,</p>
<p>Albert</p>
<p>&nbsp;</p>
<p><em>[2 further copies of this post have been deleted. Please READ &quot;Read this before posting&quot; under the heading SITE MAP. &nbsp;Moderator (RW)]</em></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38718"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9370.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Caver_Mike&#039;s picture" title="Caver_Mike&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: M-Bus ?</h3>

    <div class="submitted">Submitted by <a href="../user/9370.html" title="View user profile.">Caver_Mike</a> on Mon, 25/01/2016 - 16:04.</div>
    <div class="content">
     <p>Hi Albert -</p>
<p>The simple interface circuit will not work for more than about 3 or 4 M-bus slaves.&nbsp; This circuit detects a &#39;0&#39; from the slaves whenever the total bus current is above about 7 mA.&nbsp; Each slave is allowed to draw up to 1.5 mA (and as little as 0 mA) at all times.&nbsp; When a slave wants to send a &#39;0&#39;, it will draw an additional 10 mA.&nbsp; So, with 4 slaves, you would see anywhere from 0 to 6 mA all the time, and somewhere between 10 and 16 mA when a &#39;0&#39; is transmitted.&nbsp; This will give valid results with the simple circuit, because anything less than 7 mA will be received as a &#39;1&#39;, and anything over that will be received as a &#39;0&#39;.</p>
<p>If you connect 8 slaves, the total current when no slave is sending a &#39;0&#39; is between 0 and 12 mA.&nbsp; The current when a slave is sending a &#39;0&#39; could be anywhere from 10 to 22 mA.&nbsp; In this case, there is no single current value that can be used as the threshold between &#39;1&#39; and &#39;0&#39;.&nbsp; In order to work with more than 3 or 4 slaves, the receiving circuitry must measure the current when no slave is sending, remember this current, and compare the current received to a threshold based on the saved current.</p>
<p>I am working on a circuit which will do this.&nbsp; I will post my results as I proceed.</p>
<p>Caver Mike</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1944"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-UNc_JqiIvr82iVT8TqA0kFCKaAXo-WHy-YcKVrr6t0w" value="form-UNc_JqiIvr82iVT8TqA0kFCKaAXo-WHy-YcKVrr6t0w"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
