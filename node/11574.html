<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11574 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:13:23 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Hook Triac or FET to EmonPi | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Hook Triac or FET to EmonPi</h3>
        <span class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 12/11/2015 - 01:22</span>
        <div class="content"><p>Hi.</p>
<p>I&#39;ve been reading about this theme around here and haven&#39;t seen anyone doing it with EmonPi.</p>
<p>My idea is to hook the MOC+TRIAC&nbsp;directly to emonPI and change the firmware to control it during the day to&nbsp;deliver&nbsp;the excess energy&nbsp;from the solar system to a water heater instead of the grid.</p>
<p>I want to drive&nbsp;the triac smoothly&nbsp;like the light dimmers instead of turning on and off for short periods of time like most of the cases I&#39;ve seen that take advantage of the minimum&nbsp;power unit of the utility&nbsp;meter. It seems to me that this method (on/off short periods) is good for an independent system, but not ideal when having measuring systems like EmonPi/TX.</p>
<p>It may be more difficult to control, and I may be wrong,&nbsp;but I think this way I can get some advantages:<br />
- I can prevent spikes in the energy because theoretically the heater will not be completely on or off for short periods of time, but instead will consume a steady amount of power;<br />
- I don&#39;t know what would be the behavior of the utility meter about the minimum power unit. It&nbsp;is&nbsp;a very recent meter&nbsp;that is already online with the power company and may well be configured with a very short power unit that renders that kind of method useless;<br />
- I think the traditional method of turning on and off for short periods of time would mess the overall readings of emonPi because it would still detect the power going into the grid and, I build my system to consider that power lost and count it as lost.</p>
<p>I&#39;ve noticed that there is pin in the RJ45 port of the emonPi that is identified with ADC6/D20: could I use this for the Triac connection?</p>
<p>Off-Topic: There are free ports on&nbsp;the Arduino, I&#39;ve seen sketches on how the CT sensors are connected to the Arduino, If I need, could I use this free ports to add one or two additional&nbsp;CT sensors without the need of extra EmonTX?</p>
<p>Maybe some of this question have already been answered and I apologize&nbsp;if that&#39;s the case,</p>
<p>Cheers.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11682.html" class="topic-previous" title="Go to previous forum topic">‹ Emonth</a>
              <a href="11669.html" class="topic-next" title="Go to next forum topic">EmonTH powered by power supply ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-35827"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 12/11/2015 - 08:49.</div>
    <div class="content">
     <p>To divert surplus PV energy for heating water using a triac, you will need some suitable code to be running a processor platform.&nbsp; This site offers <a href="../Choosing%20an%20Energy%20Diverter.html">two versions</a> which use different measurement techniques, but they both&nbsp; have a similar mechanism for diverting surplus energy.&nbsp; Burst-mode is the usual method of control, but phase-angle control (as for a light dimmer) can also be used.&nbsp; My <a href="1757.html">Summary Page</a> includes two sketches of the phase-angle type, the details of the original one being:</p>
<p><em>Mk2_PV_phaseAngle.&nbsp; A phase-angle controlled variant.&nbsp; This requires a trigger which acts immediately rather than a zero-crossing one.&nbsp;&nbsp;&nbsp; Originally posted, with full supporting information, on 01/11/12 at <a href="841.html#comment-6990">http://openenergymonitor.org/emon/node/841#comment-6990</a>, this code is available at<br />
<a href="../sites/default/files/Mk2_PV_phaseAngle.ino_.zip">http://openenergymonitor.org/emon/sites/default/files/Mk2_PV_phaseAngle.ino_.zip</a></em></p>
<p>This sketch uses <em>analogRead() </em>to obtain samples of the voltage and current signals.&nbsp; That mechanism uses all of the available processor time so would not be suitable when other tasks need to be done as well.&nbsp; More recently, the same phase-angle control algorithm has been incorporated into a sketch in which the sampling is done by smarter means which frees-up the processor to do other activities.&nbsp; Details for this one are:</p>
<p><em>Using an Emontx V3.4 as a MK2 PV Router with phase angle control This describes using the emonTx V3.4 rather than an Arduino to supply the processing power. Posted, on 09/07/2015, at <a href="10865.html#comment-32080">http://openenergymonitor.org/emon/node/10865</a></em></p>
<p>I have only run this code on the Atmega 328.&nbsp; But with the appropriate input sensors in place, I see no reason why it should not provide similar performance when running on any other platform, such as the emonPi.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35828"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 12/11/2015 - 09:50.</div>
    <div class="content">
     <p>Hi.</p>
<p>I believe that all the processing is need is already done by the EmonPi.</p>
<p>I only need some kind TSR routine that controls the triac&nbsp;phaseAngle, and then based&nbsp;on the Power readings of the emonPI&nbsp;I regulate the power that the triac lets pass by altering some variable used by the TSR.</p>
<p>TSR as in Terminate and Stay Resident, or interrupt (like I used in Z80 assembly programing).</p>
<p>I think this should be viable.</p>
<p>Creers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35831"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 12/11/2015 - 10:06.</div>
    <div class="content">
     <p>The ATMega 328P inside the emonPi does very little extra when compared to the 'standard' emonTx, so I don't see a reason not to use (a) the 'continuous' sketch to get around your problem with accurately reading the burst-mode power (and that problem is of course not just confined to the emonPi) or (b) to run one of Robin's phase-angle sketches more or less unchanged. That will do all the power control inside the 328P, nothing will be done inside the Raspberry Pi.</p>
<p>What might well be an expensive problem is the harmonic filters that you are likely to need to reduce the harmonic currents that you inject into your supply to an acceptable level.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35832"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 12/11/2015 - 12:05.</div>
    <div class="content">
     <p>Hi.</p>
<p>You lost me on that last paragraph. My electricity knowledge is not going so far.</p>
<p>When you refer to &quot;your supply&quot; do you mean the utility grid?</p>
<p>Isn&#39;t the burst mode worse to cause fluctuations&nbsp;in the voltage?</p>
<p>My PV is 500W&nbsp;so the power I will supply to the heater will be always less than that and when on grid (during the night) it will be full power. The main objective is to heat the water at night (at the low tariff) and dump the excess power during the to keep it warm during the day.</p>
<p>Maybe this is to much hassle to be viable...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35838"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 12/11/2015 - 16:29.</div>
    <div class="content">
     <p>When you chop up the current wave, you generate harmonics of the 50 Hz supply frequency in the public electricity supply. There are limits which you should stay below (a) in order to remain a good citizen and (b) you probably need to satisfy local regulations. [(a) is because harmonics on the supply can cause various problems with equipment.] A harmonic filter will attenuate those harmonic currents. </p>
<p>Voltage dip is slightly different because the amount of dip depends both on the fault level of the supply (i.e. its impedance) and your load. If you have a supply with a high fault level (low impedance) then voltage dip with a 500 W load will be less of a problem.</p>
<p>You should check the regulations that apply where you are to see what you need to do.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35844"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 12/11/2015 - 21:16.</div>
    <div class="content">
     <p>Hi.</p>
<p>I don&#39;t think that kind of information (regulations that apply) is&nbsp;available to the general public...</p>
<p>I also thought of rectifying the AC and use a FET, or somehow use two FETs, one for the negative part and one for the positive part (don&#39;t even know if it could be done) and control them with an analog port... but it would also be very farfetched,,,</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35847"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 12/11/2015 - 21:27.</div>
    <div class="content">
     <p>I am almost certain that the regulations applicable to you will be available - but they might take some effort to find.</p>
<p><i>"rectifying the AC" ... "use two FETs"</i><br />
The rectifying idea is old - very old. The first thyristors were so expensive that any trick to use fewer was a good idea, so to control a.c, a diode bridge was put in series with the load, and the thyristors - there had to be two in series because their voltage rating was not enough to cope with the full mains voltage - controlled the rectified current 'output' of the bridge.</p>
<p>I believe the 'two fets' idea is basically a Class D amplifier, and it's used in the Immersun Trusine controller.   </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35850"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 12/11/2015 - 22:20.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve made a quick search, and have using one&nbsp;FET&nbsp;IXFH20N100P&nbsp;with one&nbsp;bridge rectifier&nbsp;Kbpc2010,&nbsp;I would be able able to do the job, my next problem would be how to connect this all to the&nbsp;ATMega/EmonPI&nbsp;isolating things at the same time.</p>
<p>Is there anyone out there that has the knowledge&nbsp;to&nbsp;answer this question I made:</p>
<blockquote><p>I&#39;ve noticed that there is pin in the RJ45 port of the emonPi that is identified with ADC6/D20: could I use this for the Triac connection?</p>
</blockquote>
<p>With this present circuit I have in mind I would need to output an analog signal through this port to drive the FET, not the Triac.</p>
<p>What is puzzling me is why there aren&#39;t more information about doing this kind of control with a&nbsp;FET when it seems much more efficient compared with the triac. Even at ATMEGA programing I think we can set the level of the output port and changing it as needed instead of needing to modulate the sine wave at least 100 times per second (50 to turn&nbsp;on + 50 to turn off).</p>
<p>PS: I&#39;m glad that I&nbsp;boarded this project, I&#39;ve learned quite a few things since I started, at least in the electricity area (in the programming area only the info about the IDE itself, the programing is old news)...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35855"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 13/11/2015 - 00:08.</div>
    <div class="content">
     <p><i>"...when it seems much more efficient compared with the triac"</i></p>
<p>From what you've written, I get the impression that you are intending to drive the FET with an analogue signal, as in a "Class A" audio amplifier. Have you calculated the power dissipation that you will have? And how are you going to get that heat away - and where to? </p>
<p>I wouldn't call dissipating 125 W into the air, and 125 W into the water, "efficient", which is what will happen in the worst case.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35857"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 13/11/2015 - 01:28.</div>
    <div class="content">
     <p>Hi.</p>
<p>You lost me there with &quot;125 W into the air, and 125 W into the water&quot;.</p>
<p>I think that&nbsp;I&#39;m going over my head with this...</p>
<p>I&#39;m calling this off for today, I was checking about PWM for driving the FET, but this is too much information.</p>
<p>Still about the triacs: I&#39;ve seen on ebay&nbsp;dimmers for 5000W that are so small and cheap that I can&#39;t believe would comply with the regulations of&nbsp;harmonic currents... If that regulations where met I would buy one and change it in order to use it for my purpose...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35858"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 13/11/2015 - 02:03.</div>
    <div class="content">
     <p><i>"You lost me there with "125 W into the air, and 125 W into the water"."</i></p>
<p>Oh dear. That is very basic theory indeed. I'm a little worried for you.</p>
<p>Without wishing to hurt your feelings, I think you are in danger of causing some damage or hurting yourself, or someone close to you, if you continue when you do not understand what you are doing. Please do remember that electricity can start fires and can kill, and we wouldn't want you involved with either of those things.</p>
<p>You are going in the right direction when you say PWM and the FET, but I've been in electrical engineering for nearly 50 years, and I'd hesitate to take that on, because I KNOW what could go wrong.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35863"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 13/11/2015 - 11:25.</div>
    <div class="content">
     <p>Hi.</p>
<p>You are probably right, my area is computers&nbsp;and electronics, mainly in low power and low voltage.</p>
<p>I know that I would be required to have a good heat dissipation for the FET (and for the triac also), but do you think that the FET would take almost 10% of the power? (the heater would be in the range of 1500 to 2500 W)</p>
<p>I&#39;m not yet to give up, but I don&#39;t want to spend much money on this also and don&#39;t want to build something that isn&#39;t efficient enough, unsafe, or&nbsp;out of law...</p>
<p>Do you have anything to say about this one (search for&nbsp;261846884159 on Ebay or others found there)?</p>
<p>I&#39;ve seen plenty of this, some without enclosure but I&#39;m not certain that it is the right way to go, at least I wouldn&#39;t have&nbsp;to gather hardware parts&nbsp;that is hard to find, like coils that most of the time have to be hand made to the spec.</p>
<p>Edit:<br />
What would be the electronic devices&nbsp;you refer for the harmonics filters?<br />
Why do you seem to imply they are expensive?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35870"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 13/11/2015 - 12:30.</div>
    <div class="content">
     <p><i>"261846884159"</i><br />
It is impossible to be able to say anything about this, as there is no real information about it.</p>
<p><i>"the heater would be in the range of 1500 to 2500 W"</i><br />
That makes the problems even bigger - you wrote earlier "500 W". </p>
<p>As your speciality is computers, it is time to construct a spreadsheet and try the numbers. Imagine you have two resistors connected in series across your mains supply. One is the water heater, the other represents your FET, which you're using as a variable resistor. First, calculate the resistance of the heater from the power and the voltage. Now set up a spreadsheet. The resistance of the heater is the first column and it won't change. The second column is the second resistor, start with the value of zero, and increase its value in steps (they don't need to be equal, they can increase exponentially), starting at about 10% of the resistance of your heater until it is about 10 &times; the value of the heater. In the next column, calculate the voltage at the junction of the two resistors, in the next column the current in the resistors, and then three columns with the power in each resistor and the total power. Then plot the graphs of power by rows.</p>
<p>That will show you the power that you will get in your heater as you turn the FET on and off, and the power that the FET needs to lose to the air.</p>
<p>The heat dissipation of the triac, or the FET when it is acting as a pulse width modulated switch,  is far less because it is a totally different calculation. In this case the active device has a constant voltage across it of only a couple of volts when it's on, and zero current so zero power when it's off, so the power dissipated is a lot less. (And before somebody points it out, there is some power dissipated as it transitions between the two states.)</p>
<p>I think your best route by far is to purchase a ready-built module. Calypso_rae can help you.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35871"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 13/11/2015 - 23:29.</div>
    <div class="content">
     <p>Hi.</p>
<p>Thanks for the explanation.</p>
<p>The max variable power I would be powering the heater is 500W that is the max available&nbsp;PV power at any time, but the max power the&nbsp;heater can consume is more than that but it would never be regulated between 500W and the max. Basically during most of the night it would be always at the max and let its thermostat do the job.</p>
<p>About the power dissipated by the FET I would expect it to have a very very low resistance,&nbsp;a fraction of the heater. I&#39;ve made low power tests with FET and transistors to dim DC lights and the power drawn seems to be consistent with what the lamp draws considering the emitted light. You seem to imply that the FET will draw as much power as the heater a situation that I know would happen if the a variable resistor was used... but a FET is not a variable resistor, at least that&#39;s what I thought.</p>
<p>About buying a ready-built module, it is possible, but I also want to learn things and I would like to take advantage of the material I already have and at the same time prevent this part of the project to interfere with the readings: I&#39;m convinced that the ready-build (at least the burst model) will interfere with the emonPI readings and possibly be &quot;detected&quot; by the utility meter and consume power from grid even when delivering it from the PV.</p>
<p>UpDate:</p>
<p>I&#39;ve read much more information about this and it seems that the same triac&nbsp;configuration is used for Burst and &nbsp;Phase Control, and that triac configuration doesn&#39;t seem to have any prevention for the generated&nbsp;current harmonics when using the Phase Control mode.</p>
<p>My first step is to&nbsp;find the right circuit to control an up-to 4000W resistive load that keeps the current harmonics within&nbsp;the acceptable limits. I willing to buy this part of the project from Robin at a reasonable price, how should I contact him?</p>
<p>My Second step is find the right way to find a port on&nbsp;my EmonPi board to drive the triac. Maybe the pin 8 on RJ45 port does the job, I still don&#39;t know, but from what I understood&nbsp;about the Arduino/ATMega design&nbsp;that pin couldn&#39;t be used for PWM output.</p>
<p>My third step is to pinpoint an existing software for the arduino that is close enough&nbsp;to what I need, understand and adapt it to work with my existing EmonPi software.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35902"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sat, 14/11/2015 - 11:59.</div>
    <div class="content">
     <p><em>CiDiRome: I&#39;ve read much more information about this and it seems that the same triac&nbsp;configuration is used for Burst and &nbsp;Phase Control, and that triac configuration doesn&#39;t seem to have any prevention for the generated&nbsp;current harmonics when using the Phase Control mode.</em></p>
<p>Correct.&nbsp; For the phase-angle controlled version, the user is reminded of the need to provide appropriate protection against EMI effects.&nbsp; Commercial filters are available for this purpose.</p>
<p><em>My Second step is find the right way to find a port on&nbsp;my EmonPi board to drive the triac. Maybe the pin 8 on RJ45 port does the job, I still don&#39;t know, but from what I understood&nbsp;about the Arduino/ATMega design&nbsp;that pin couldn&#39;t be used for PWM output.</em></p>
<p>Any IO port (analog or digital) can be used to drive a triac via its associated trigger circuit.&nbsp; An un-synchronised PWM signal would not be suitable for this purpose.</p>
<p>Robin (calypso_rae) can be contacted via a Private Message on this forum or by email via the <a href="http://mk2pvrouter.co.uk/13779.html">Shop page</a> on his website.&nbsp; However, a public discussion may be of more benefit to you as useful input can be gained from multiple sources.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35903"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 14/11/2015 - 12:25.</div>
    <div class="content">
     <p>Hi.</p>
<p>So I was right...</p>
<p>&quot;<em>Commercial filters are available for this purpose</em>&quot;. Is this a so hard to build device that one can&#39;t build it from parts that we can buy online and integrate it in the triac system?</p>
<p>Isn&#39;t it built of&nbsp;a few capacitors of specific rates and/or probably some coils?</p>
<p>I&nbsp;admit that the coils can be the real problem to buy, but those we can probably make our own from scrap parts like computer power supplies that I have plenty...</p>
<p>What is the term I should search for on google about building my own filter?</p>
<p>PS: Robin is you... ok, Can you give me an indicative price for the device I need (triac system + filter)?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35908"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sat, 14/11/2015 - 13:22.</div>
    <div class="content">
     <p>This is one commercial filter for use with SSR or triac-based switching systems:</p>
<p><a href="http://uk.farnell.com/crydom/1f25/filter-ssr-1-phase/dp/1200270?MER=en-mer-0713-pd-r2-acce">http://uk.farnell.com/crydom/1f25/filter-ssr-1-phase/dp/1200270?MER=en-mer-0713-pd-r2-acce</a></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35909"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 14/11/2015 - 13:40.</div>
    <div class="content">
     <p><i>"Is this a so hard ..."</i></p>
<p>Yes, I'm afraid it is. It is a very specialised area, which is why I suggest buying one that has a guaranteed performance.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35921"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 14/11/2015 - 22:02.</div>
    <div class="content">
     <p>Hi.</p>
<p>Thank you for pointing in the right direction, the price is acceptable but there is a bug with that device:<br />
By itself,&nbsp;It can consume almost 10W (stated as max), and by the way it shows how to use it in the diagram seems that it can&nbsp;be permanent as the datasheet is very vague about almost everything.</p>
<p>In order to use a device like this, if&nbsp;on test I conclude that it really consumes that kind of energy, I would have to add another triac or relay behind it to prevent it from consuming while the load if offline.</p>
<p>Has any of you tested one of this devices?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35922"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 14/11/2015 - 22:25.</div>
    <div class="content">
     <p>Where does it say that the device consumes 10 W? </p>
<p>I cannot see that anywhere. It does say "Current Drain at VRMS max: 40 mA" but that does not necessarily mean 10&nbsp;W. What temperature will a box of that size reach if it has to dissipate 10 W? 10&nbsp;VA I will believe, but the <b><i>power</i></b> will be nowhere near 10&nbsp;W, probably less than 1&nbsp;W, and that will only be because there will be a high value parallel resistor to safely discharge the capacitor when the supply is turned off.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35923"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 14/11/2015 - 22:59.</div>
    <div class="content">
     <p>OK.</p>
<p>So that 40mA cannot be considered for real power but apparent power. I confess I forgot about that, my bad.</p>
<p>That information should be present in the datasheet in the datasheet anyway...</p>
<p>I will soon start with my second and third steps, that won&#39;t require expenses, and when&nbsp;I believe I&#39;m in the right track I will buy the parts.</p>
<p>Cheers,</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35982"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 16/11/2015 - 21:49.</div>
    <div class="content">
     <p>Hi.</p>
<p>Advancing in my project, I&#39;ve found contradictory information about emonPI.</p>
<p>On EmonPi Wiki about RJ45&nbsp;Pin 8 is stated&nbsp;&quot;RJ45 pin 8 &ndash; ADC6 / Dig20&quot;, checking the diagram I can see that it is connect to pin 19 of Atmega328 that is ADC6, but I can&#39;t see any reference to D20 in the datasheet, that I assume would be an alternative configuration to ADC6 on pin 19...</p>
<blockquote><p>ADC7:6 (TQFP and QFN/MLF Package Only) In the TQFP and QFN/MLF package, ADC7:6 serve as analog inputs to the A/D converter. These pins are powered from the analog supply and serve as 10-bit ADC channels.</p>
</blockquote>
<p>What is this Dig 20/D20 that appears on the wiki and schematics?</p>
<p>Also, it appears as D19 in the firmware comment...</p>
<blockquote><p>//const byte emonPi_RJ45_8_IO= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; A6; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // RJ45 pin 8 - Analog 6 (D19) - Aux I/O</p>
</blockquote>
<p>It seems that it would be simple to connect another CT sensor to this port (there ir a thread about it), but I believe that for my project on driving the&nbsp;triac&nbsp;I will need a port that can be configured as output digital or analog.</p>
<p>I also have questions about the emonPi firmware, but I will post them in the right forum area since that is classified as software.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35985"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 17/11/2015 - 08:53.</div>
    <div class="content">
     <p>The emonPi has an Atmel 328P processor which is the same as is used on the emonTx V2.&nbsp; This Design Reference page for the emonTx V2 is very useful as it lists all on the pins/ports along with their function:</p>
<p><a href="../emontx/reference.html">http://openenergymonitor.org/emon/emontx/reference</a></p>
<p>The Atmel 328P has 20 IO ports in total: 14 digital and 6 analog.&nbsp; The naming convention in the above Design Reference shows the digital ports as 0-13; the analog ports are numbered 0-5 but they can also be used in a digital manner as 14-19.</p>
<p>If the numbering convention were to start at 1 rather than 0, then A5 / D19 would become A6 / D20.&nbsp; I suspect that the emonPi documentation which you have found is using this alternative scheme.</p>
<p>.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35987"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 17/11/2015 - 09:51.</div>
    <div class="content">
     <p>Hi.</p>
<p>Thank you for you answer.</p>
<p>But I think something is mismatching somewhere.</p>
<p>While the Port C 0 to 5 (PC0-PC5) are described in the datasheet as:</p>
<blockquote><p><em>Port C (PC5:0) Port C is a 7-bit bi-directional I/O port with internal pull-up resistors (selected for each bit). The PC5...0 output buffers have symmetrical drive characteristics with both high sink and source capability. As inputs, Port C pins that are externally pulled low will source current if the pull-up resistors are activated. The Port C pins are tristated when a reset condition becomes active, even if the clock is not running.</em></p>
</blockquote>
<p>The Port ADC6/7 (where the RJ 45 pin 8 is connected to) are described as:</p>
<blockquote><p><em>ADC7:6 (TQFP and QFN/MLF Package Only) In the TQFP and QFN/MLF package, ADC7:6 serve as analog inputs to the A/D converter. These pins are powered from the analog supply and serve as 10-bit ADC channels.</em></p>
</blockquote>
<p>These two ports (ADC6/7) are not in the list of ports described on that link. If fact I know why: the chip package used in EmonTX v2 (28 PDIP) don&#39;t have that ports.</p>
<p>So is the Digital port 20 a bug?</p>
<p>I think my option is to use the ports that are assigned to the LCD witch I don&#39;t have/use.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36027"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 18/11/2015 - 01:44.</div>
    <div class="content">
     <p>Update:</p>
<p>After further analyzing the EmonPi diagram, it seems it was not so obvious to use the LCD communication ports because they seem also to be used to communicate with the Rasp.</p>
<p>Faced with this situation I opted to use the Pulse count sensor pin that I also don&#39;t use and already passed the first step of having a flashing led controlled&nbsp;has I want inside the the firmware.</p>
<p>I&#39;ve started to read emonTxV3_4_as_Mk2Router.ino code and I can say that it is a bit complex and I don&#39;t fully understand most of it.</p>
<p>I was hoping to find some function I would be able to call to change the % of power that the triac is letting pass and it would modulate the was as needed, e.g. change_triac_power(n) where n would vary between 0 and 65535 and (0=off to&nbsp;65535&nbsp;full on), but the code is more complex than that.</p>
<p>My next step will be to try&nbsp;understanding&nbsp;the code better or try to write my one code...</p>
<p>Edit: for tests, I have, from old projects, MOC3011 and BT139. I&#39;ve seem that MOC3041&nbsp;has a slightly&nbsp;different functionally, can it be a problem on my tests to use MOC3011 instead of MOC3041?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36034"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 18/11/2015 - 10:15.</div>
    <div class="content">
     <p><em>I&#39;ve started to read emonTxV3_4_as_Mk2Router.ino code and I can say that it is a bit complex and I don&#39;t fully understand most of it.</em></p>
<p>That sketch performs a similar function to the original Mk2 Router code for which there is a detailed description at:&nbsp; <a href="https://learn.openenergymonitor.org?redirect=mk2/versions">http://openenergymonitor.org/emon/mk2/versions</a></p>
<p><em>I was hoping to find some function I would be able to call to change the % of power that the triac is letting pass and it would modulate the was as needed, e.g. change_triac_power(n) where n would vary between 0 and 65535 and (0=off to&nbsp;65535&nbsp;full on), but the code is more complex than that.</em></p>
<p>Your supply meter measures <strong><em>energy</em></strong>, not power, and the Mk2 Router does likewise.&nbsp; The operation of the Mk2 Router is reactive rather than predictive, hence &quot;<em>the % of power</em>&quot; is not a concept that is relevant within its terms of reference.&nbsp; Over what timescale are you considering this &quot;power&quot; to exist?&nbsp;</p>
<p>Before designing the Mk2 Router, I heated water using an alternative approach which was similar to your thinking,&nbsp; That arrangement had a number of discrete steps to which the output stage could be pre-set.&nbsp; It can be seen working here:</p>
<p><a href="https://www.youtube.com/watch?v=-lk6Me3cwuw">https://www.youtube.com/watch?v=-lk6Me3cwuw</a></p>
<p>The external controller is described at 1&#39;20&quot; - 1&#39;50&quot;.&nbsp; Although I am using it in a &quot;whole-cycle&quot; mode, this device can also operate with &quot;phase-angle&quot; control whereby the load is on for a pre-determined portion of each half cycle.</p>
<p>The output stage is a <a href="http://uk.rs-online.com/web/p/solid-state-relays/7082080/">Carlo Gavazzi AC switch</a> which was controlled by PWM from my Arduino.&nbsp; I still have this device here with its original box and instructions.&nbsp; It cost me &pound;70, yours for &pound;35 including postage.&nbsp; Send me a PM if you&#39;re interested.</p>
<p>PS.&nbsp; My &#39;Mk1&#39; code is at <a href="../sites/default/files/Mk1_in_Garage_2.ino_.zip">http://openenergymonitor.org/emon/sites/default/files/Mk1_in_Garage_2.ino_.zip</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36038"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 18/11/2015 - 11:25.</div>
    <div class="content">
     <p>Hi.</p>
<p>The device you purpose would only replace the <em>triac system</em>, the control system would still be needed to arranged.</p>
<p>About your code, it is more complex than I anticipated, and I can&#39;t go striping it off of parts I don&#39;t need, instead I have to understand it and gather the parts I need.</p>
<p>Don&#39;t forget my base start is the EmonPi with only two sensors, This two sensors are already in use (Grid + PV), My idea was&nbsp;to monitor de the Grid power and when it goes -4W or less increase the triac % for a relative value (calculated with base on the max load power)&nbsp;and the opposite when the power goes over 0W (or -1W).</p>
<p>I don&#39;t have a third CT, at least for now, so I&#39;m not considering controlling the consumed energy of the load, rather I would log the&nbsp;theoretical power it is consuming based on the % of the triac for the sake of statistics.</p>
<p>I was thinking about doing the verification once a second.</p>
<p>I wasn&#39;t even considering the <em>bucket system</em>, my utility meter is very recent and I&#39;m afraid that it has a very small energy packet that can screw that kind of functionality, anyway I will also see the model and search about it.</p>
<p>Best Regards.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36039"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 18/11/2015 - 13:28.</div>
    <div class="content">
     <p><i>"The device you purpose would only replace the triac system, the control system would still be needed to arranged."</i><br />
That's correct.</p>
<p><i>"Don't forget my base start is the EmonPi with only two sensors"</i><br />
You only <b>need</b> one CT, on the grid connection, for Robin's control system to work, because it only needs to know the nett energy flow at the grid connection. Everything else is information for you.</p>
<p><i>"I don't have a third CT, at least for now, so I'm not considering controlling the consumed energy of the load, rather I would log the theoretical power it is consuming based on the % of the triac for the sake of statistics."</i><br />
If you have a thermostat on your heater that overrides the triac, your calculation will be wrong when the thermostat opens. You can avoid this by fitting a temperature sensor to your water tank and using the temperature to override the control when the water reaches maximum temperature. Then set the thermostat to 5&deg; higher to act as a safety cut-out.</p>
<p><i>"I was thinking about doing the verification once a second."</i><br />
That is probably far too slow. Robin's program calculates every 20 ms. You will have an average of &frac12; s overshoot or undershoot in addition to the time it takes to alter the firing angle of your triac every time something switches on or off.</p>
<p><i>"I wasn't even considering the bucket system, my utility meter is very recent and I'm afraid that it has a very small energy packet that can screw that kind of functionality, anyway I will also see the model and search about it."</i><br />
You are confusing two different ideas here. The 'burst fire' mode is like a bucket with a big hole in the bottom with a plug in it - the plug can be either in the hole (and the bucket fills quickly) or out of the hole (and the bucket empties quickly). The 'proportional' mode is like a bucket with a tap on it. If the level in the bucket starts to go up, you open the tap a little, and if it continues to go up, you open it a bit more. If the level in the bucket starts to go down, you close the tap a little, and if it continues to go down, you close it a bit more. When the level stays the same, you leave the tap where it is. So the bucket idea will work for you, it's how you empty the bucket that is different. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36041"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 18/11/2015 - 17:57.</div>
    <div class="content">
     <p>Hi.</p>
<p>So, it is efficient.</p>
<p>I will do&nbsp;my best to understand their code&nbsp;and&nbsp;adapt it to use with my EmonPi.</p>
<p>About the 3rd CT sensor, I&#39;m thinking about&nbsp;ordering one and hook it to the RJ45 Pin8 ADC6.<br />
About this subject: EmonTX has high sensitivity sensor input, what is different: the circuitry, the sensor&nbsp;or booth? Would I be able to make this new EmonPi Sensor a high sensitivity one?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36045"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 18/11/2015 - 17:23.</div>
    <div class="content">
     <p>It is only the value of the burden resistor that changes. You can remove the SMT component (R17, R28) and solder in a wire-ended one - holes are provided (R22, R26).</p>
<p>The CT is a <i>current</i> source, the secondary current is determined by the primary current and the current ratio (100 A : 50 mA for the shop one), therefore you choose the burden resistor to give you ~ 1.1 V rms at the maximum current that you will have in your load - 12 A will give you some in hand (if your voltage is 230 V). So I make that 180 &Omega; to the nearest E12 value below.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36048"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 18/11/2015 - 18:06.</div>
    <div class="content">
     <p>Is the result very different compared to what I did?<br />
I&#39;m referring to&nbsp;passing the live wire 3 times thought&nbsp;the CT&nbsp;for the incoming grid wire and 10 Times for the PV system (and then divide the value in the firmware for the according&nbsp;turns).</p>
<p>From what I&#39;ve seen, changing the values of the burden resistor also causes the max Amperes to drop, with what I did the same happens, which&nbsp;one is better?</p>
<p>Cheers?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36050"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 18/11/2015 - 18:51.</div>
    <div class="content">
     <p>You did not say that you wanted to use a multi-turn primary winding. That is the better way because the errors due to transformer magnetization losses are proportionately smaller.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36051"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 18/11/2015 - 19:54.</div>
    <div class="content">
     <p>Thank you.</p>
<p>That is what I thought, so when possible I will use this method for better accuracy. If I add a 3rd CT, I&#39;m thinking about&nbsp;use the same circuitry (only external) and get the 3.3V from the board (since they aren&#39;t available in the RJ45 port). My reason to do this instead of building the external circuitry according the 5V power source was to keep all CTs with the same schema thus as much similar as possible.</p>
<p>If it was you, would you get the 3.3V to keep the same schema or change the schema to work with 5V?</p>
<p>PS: in answer to: &quot;<em>If you have a thermostat on your heater that overrides the triac, your calculation will be wrong when the thermostat opens</em>&quot;, I think a little check would be enough, if the % of power given to the load is greater than the power being produced than the logged power for the load would be zero...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36061"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 18/11/2015 - 20:31.</div>
    <div class="content">
     <p>Regarding the bias supply for the outboard input, I would use 5 V and keep all the same components except for the resistor in the R27 position, which needs to be adjusted so that the voltage at the junction with (C4) and (R25) is 1.65 V, which gives a value of 954 k&Omega;. That, very inconveniently, is almost exactly mid-way between two E24 preferred values. Using 910 k&Omega;, the voltage is fractionally closer, but 1 M&Omega; is only fractionally worse and probably easier to obtain. You will lose about 1.5% of the range, which is nothing to worry about. Or you could use 910 k&Omega; + 43 k&Omega; in series. If you can get a 953 k&Omega; resistor, that would be ideal, but values in the E48 series can be hard to find and costly.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36066"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 18/11/2015 - 22:13.</div>
    <div class="content">
     <p>Hi.</p>
<p>I didn&#39;t know about the E*&nbsp;system. One more thing I learned today.</p>
<p>What about 560k + 390k +&nbsp;4k or 680k + 270k +&nbsp;4k? it is a little sketchy, but this values we have in E12, but E12 has 10% and the end can have a big variation of almost 100k while E48 would have only 20k.</p>
<p>In your opinion, if one can calibrate the resistor while measuring it with the multi meter (try different&nbsp;values in series or use a 1M&nbsp;potentiometer) would be better or worse than sticking to a set like this&nbsp;560k&nbsp;+&nbsp;390k&nbsp;+&nbsp;4k of standard resistors?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36067"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 18/11/2015 - 22:52.</div>
    <div class="content">
     <p>First, 1% tolerance resistors are common and inexpensive (e.g. <a href="http://spiratronics.com/0.6w-metal-film-resistor-390k-pack-of-10.html" title="http://spiratronics.com/0.6w-metal-film-resistor-390k-pack-of-10.html">http://spiratronics.com/0.6w-metal-film-resistor-390k-pack-of-10.html</a>). Second, there is no point in trying to get closer than 1%, because that is the tolerance of the other resistor in the chain. So I'd use 2 E12 resistors in series and forget the difference from the ideal value. I would certainly not use a potentiometer. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36098"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 19/11/2015 - 22:52.</div>
    <div class="content">
     <p><em>CidiRome:&nbsp; The device you purpose would only replace the triac system, the control system would still be needed to arranged.</em></p>
<p>A few days ago, I pointed you towards the software and hardware design for the phase-angle version of my Mk2 Router which appeared to do what you wanted.&nbsp; Since then, I&#39;ve provided some earlier software which appears to&nbsp; match your needs more closely, and also offered you the crucial bit of hardware to go with it.&nbsp;</p>
<p>I&#39;m now wondering what else you are hoping for ...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36100"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 19/11/2015 - 23:08.</div>
    <div class="content">
     <p>Hi.</p>
<p>At this point, the hardware is not my concern, I already know what I will use, I&#39;m now looking at the code and trying to adapt it to my needs.</p>
<p>Since I want to add that functionally to my existing emonPi and the mk2 code is very different from the emonPI.</p>
<p>I&#39;ve understood&nbsp;almost all the EmonPI code, but the MK2 is far more complex, I&#39;m trying to get my head around it a few hours a day after work.</p>
<p>Sorry if I seem not to know what I want... You have to understand that I&#39;m new to this, I only have my emonPi for one month (today) and the PV system for less than two weeks.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36108"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 20/11/2015 - 08:19.</div>
    <div class="content">
     <p><em>I&#39;ve understood&nbsp;almost all the EmonPI code, but the MK2 is far more complex, I&#39;m trying to get my head around it a few hours a day after work.</em></p>
<p>OK.&nbsp; Have you studied the description of this code at <a href="https://learn.openenergymonitor.org?redirect=mk2/versions">http://openenergymonitor.org/emon/mk2/versions</a><em> ? </em></p>
<p><em>I was hoping to find some function I would be able to call to change the % of power that the triac is letting pass and it would modulate the was as needed, e.g. change_triac_power(n) where n would vary between 0 and 65535 and (0=off to&nbsp;65535&nbsp;full on), but the code is more complex than that.</em></p>
<p>In the &quot;Mk1&quot; code which I mentioned recently, all of the measurement side is taken care of by the standard OEM library routine, <em>calcVI().&nbsp; </em>With a 256-step PWM output that is updated each second, this control structure seems&nbsp; just as you have been asking for.&nbsp; Extra hardware is however required to convert the slowly varying analogue output from the processor into a dynamic phase-angle signal for switching the load.</p>
<p>The phase-angle version of my &quot;Mk2 Router for emonTx V3.4&quot; sketch, as referenced in my initial reply, does a similar job but in a reactive rather than predictive manner.&nbsp; If implemented within your emonPi code, no other hardware would be required to hook it to your MOC + TRIAC.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36112"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 20/11/2015 - 09:49.</div>
    <div class="content">
     <p>Hi.</p>
<p>Yes that&#39;s it.</p>
<p>Since I started I&#39;ve learned some things and I can see that your&nbsp;expertise on the field is plenty and luckily I have you to orient me.</p>
<p>If you say that the Mk2 system is better I will try to adapt it to my usage, instead of Mk1.</p>
<p>About the Mk1 needing more hardware, that is another thing I would avoid and my idea of interrupts was to do the modulation for the triac in background and controlling it in the main/loop&nbsp;code... Never mind that is not my way now, and I think I would have lack of&nbsp;memory problems with it and the actual EmonPi firmware anyway...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36133"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 20/11/2015 - 18:55.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve been converting your code to EmonPI. I&#39;m not saying I would do better (probably not), but some variables names are a bit confusing... I think that, for example, I would always use the CT sensor naming as CT1..CTn and in the definition I would somehow (maybe some king of variable aliases) inform the software that CT1 is grid, CT2 is PC, CT3 is diverted, etc... This way with little changed in the code we would be able to use the CT as wanted and easely port the code to other devices like I&#39;m doing.</p>
<p>Please don&#39;t take me wrong, I truly appreciate&nbsp;your work, this&nbsp;is a constructive critic.</p>
<p>Just to confirm &quot;<em>const byte powerForDallasSensor = 19;</em>&quot; in EmonPI the Dallas sensor is not powered this way, this is not necessary, isn&#39;t it?</p>
<p>How do I convert this calibration value:<br />
float Vcal_EU=261.558345; //&lt;Original Line was&nbsp;(230V x 13) / (9V x 1.2) = 276.9 ...</p>
<p>Into this:<br />
const float voltageCal = 0.875; // &lt;-- using a Fluke 77 multimeter for my own setup - RAE</p>
<p>Cheers.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36137"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 20/11/2015 - 20:00.</div>
    <div class="content">
     <p>When posting this code (Mk2 Router for emonTx V3), my primary objective was to achieve continuous monitoring on four channels, with diversion of surplus power, and RF.&nbsp; Having restructured the code to move all the time-critical stuff inside the ISR, temperature measurements could then be included without disrupting the other aspects.&nbsp; If the way that I&#39;ve supplied power to the Dallas sensor is different than elsewhere, you or anyone else is welcome to change this detail.</p>
<p>Regarding the names for variables, more logical names often appear after the event.&nbsp; If anyone wishes to post a version with alternative names, they are welcome to do so.&nbsp; Personally, I prefer not to pre-allocate what each channel is likely to be used for.&nbsp; You will appreciate that my efforts these days are mainly in support of my own business/website where software runs on hardware that is similar but not identical to the emonTx. &nbsp;</p>
<p>voltageCal is my way of calibrating the voltage sensor.&nbsp; My intention is that it is adjusted until the reported value is the same as is measured by any external piece of kit that can be trusted.&nbsp; My preferred approach is to measure and adjust this value rather than the calculating what it should theoretically be. &nbsp;&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36142"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 20/11/2015 - 21:55.</div>
    <div class="content">
     <p>Hi.</p>
<p>&quot;<em>I prefer not to pre-allocate what each channel is likely to be used for</em>&quot;<br />
Is this sentence correct or did I understood you wrong? You seem&nbsp;to pre-allocate what each channel is used for...</p>
<p>The value I have for Vcal&nbsp;for the present EmonPI is not theoretical, I archived it by calibration as explained for EmonPI,&nbsp;I changed unit I&nbsp;got readings very close to the ones I got with my multi meter (it is not a top quality one, but I believe is accurate enough. I also have a cheaper one and can tell the difference).<br />
How do I measure&nbsp;voltageCal for your code?</p>
<p>Can you point me where should I divide the readings by the number of turns I use in each CT? I know that I can make that division before sending the data to EmonHUB, but the readings will be wrong for the phase angle&nbsp;and other calculations made before.</p>
<p>About&nbsp;the power to dallas sensor: I don&#39;t know about EmonTX, but in EmonPI it doens&#39;t seem to come from a port on ATMega.</p>
<p>One question about this: &quot;<em>* July 2015, upgraded for phase-angle control.</em>&quot;. Was this a definitive change in code or there is flag to choose (I couldn&#39;t find it). I&#39;m asking this because the ones who could be using your code with burst mode shell not change to phase angle if they not have the harmonics filters in place, am I wrong?</p>
<p>It seems that you haven&#39;t worked with EmonPI to help me enough to port the code to it and at this point I don&#39;t know if I&#39;m up to the task. I think that I don&#39;t understand the MK system well enough to be able to port it by myself...</p>
<p>Anyway, I thank you for your efforts on helping me even where theres little chance of selling and I understand that you have your business and have to take care of if before anything else.</p>
<p>Cheers.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36221"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sun, 22/11/2015 - 14:58.</div>
    <div class="content">
     <p>Hi.</p>
<p>Since my last message I&#39;ve been making changes to the code and understood a little more of it.</p>
<p>There is one thing that is puzzling me:<br />
I noticed that the constant&nbsp;voltageCal is only used when the values are returned and never when the calculations are made...</p>
<p>The fact (as I stated before) is that I don&#39;t understand your code completely, but, how do you make calculations to obtain power and energy if you seem not to be dealing with correct/accurate voltage? (I think that&nbsp;87.5% to 100% is not a negligenciable&nbsp;error)</p>
<p>Most probably there is something I&#39;m not seeing correctly, I don&#39;t know.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36222"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sun, 22/11/2015 - 17:13.</div>
    <div class="content">
     <p><em>CidiRome: how do you make calculations to obtain power and energy if you seem not to be dealing with correct/accurate voltage?</em></p>
<p>Most of the code that I have posted uses integer maths for greater speed and efficiency.&nbsp; Cal factors are only applied when absolutely necessary.&nbsp; This approach is no different than working through an algebraic exercise in its pure form, and only substituting real-world values at the end.&nbsp; If you are interesting in understanding the details, this process is thoroughly described in the code, e.g.</p>
<p><em>&nbsp; // The next stage would normally be to apply a calibration factor so that real power<br />
&nbsp; // can be expressed in Watts.&nbsp; That&#39;s fine for floating point maths, but it&#39;s not such<br />
&nbsp; // a good idea when integer maths is being used.&nbsp; To keep the numbers large, and also<br />
&nbsp; // to save time, calibration of power is omitted at this stage.&nbsp; Real Power (stored as<br />
&nbsp; // a &#39;long&#39;) is therefore (1/powerCal) times larger than the actual power in Watts.<br />
&nbsp; //<br />
&nbsp; long realPower_for_energyBucket&nbsp; = sumP_forEnergyBucket / sampleSetsDuringThisCycle;</em></p>
<p>Providing that your measurement system is linear and repeatable, the reported values for real energy and power should be OK.&nbsp; Appropriately scaling the signal to be measured within the working range of the ADC is helpful to minimise the effects of quantisation distortion at small signal levels. &nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36223"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sun, 22/11/2015 - 17:39.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve read that.</p>
<p>I&#39;ve seen that the calibration value for the CT is applied to the bucket capacity</p>
<blockquote><p>capacityOfEnergyBucket_long =<br />
&nbsp; &nbsp; &nbsp;(long)SWEETZONE_IN_JOULES * CYCLES_PER_SECOND * (1/powerCal_grid);</p>
</blockquote>
<p>I understand that this will cause the bucket to work in some kind of internal measuring unit for&nbsp;the system...</p>
<p>But, it seems that there are calculations of power (watts)&nbsp;where the Vcal is not included...<br />
If P=U*I, can we obtain correct values of P while U is not accurate?</p>
<p>And about</p>
<blockquote><p>Can you point me where should I divide the readings by the number of turns I use in each CT? I know that I can make that division before sending the data to EmonHUB, but the readings will be wrong for the phase angle&nbsp;and other calculations made before.</p>
</blockquote>
<p>Can you point to the best place where I should make the divisions?<br />
I think it shell not be before outputting them, because that will mean all&nbsp;the prior calcullations&nbsp;will be wrong. at least the ones of grid &nbsp;CT.</p>
<p>Cheers...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36227"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sun, 22/11/2015 - 21:34.</div>
    <div class="content">
     <p>As far as I am aware, all calculations in my sketches are in good order.&nbsp; I am primarily interested in monitoring Real Power/Energy for which any phase mismatch between the V and I waveforms has minimal effect.&nbsp; The phaseCal algorithm may be useful for anyone who wishes to monitor Power Factor etc.</p>
<p>If you intend to have multiple turns around your CT(s), it would seem best to calibrate your system with this setup already in place.&nbsp; Then no other changes to the code should be necessary.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36228"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sun, 22/11/2015 - 22:11.</div>
    <div class="content">
     <p>OK, if&nbsp;you say so..</p>
<p>From what I understand of the code, it may do the job correctly on diverting the surplus energy because the units are not very important and are close enough to the reallity.</p>
<p>But this calculation</p>
<p>&nbsp; &nbsp; &nbsp; instP = filtV_div4 * filtI_div4; &nbsp;// 32-bits (now x4096, or 2^12)</p>
<p>Cannot return an accurate power value because&nbsp;one of its origin values is not correct:&nbsp;filtV_div, it&nbsp;is obtained and it the calibration is not applied to it.</p>
<p>I&#39;m sorry if I&#39;m annoying you (probably am), but I like to understand things i&#39;m dealing with.</p>
<p>About:</p>
<blockquote><p>If you intend to have multiple turns around your CT(s), it would seem best to calibrate your system with this setup already in place.&nbsp; Then no other changes to the code should be necessary.</p>
</blockquote>
<p>I don&#39;t understand this statement, if I don&#39;t make changes the code, I cannot have multiple turns in the CT because the reading will be wrong...</p>
<p>Cheers.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36230"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 22/11/2015 - 23:17.</div>
    <div class="content">
     <p><em>monitoring Real Power/Energy for which any phase mismatch between the V and I waveforms has minimal effect.</em></p>
<p>I think that depends a lot on the nature of the signal you&#39;re measuring. &nbsp;It&#39;s certainly true for big beefy in-phase sinusoidal loads but less so for the misshaped loads you see if you&#39;re primarily measuring switch mode power supplies (or big reactive loads).</p>
<p><em>The phaseCal algorithm may be useful for anyone who wishes to monitor Power Factor etc.</em></p>
<p>Power Factor is just RealP/ApparentP so the only way phase error correction&nbsp;improves that is by improving&nbsp;the&nbsp;RealPower measurement.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36232"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 23/11/2015 - 00:04.</div>
    <div class="content">
     <p><i>"About:</p>
<p>If you intend to have multiple turns around your CT(s), it would seem best to calibrate your system with this setup already in place.  Then no other changes to the code should be necessary.</p>
<p>I don't understand this statement, if I don't make changes the code, I cannot have multiple turns in the CT because the reading will be wrong..."</i></p>
<p>P = V &times; I</p>
<p>Whether that is an instantaneous value that is used for real power calculation, or V and I are rms average values, that statement is always true. (Always assuming you do not mix real and apparent power.) If either V or I or both are wrong by a constant value, you can always remove that constant and apply it, or the product of two constants if both are wrong, to P.</p>
<p>P = a.V &times; b.I</p>
<p>is exactly equivalent to</p>
<p>P = (a &times; b) &times; (V &times; I)</p>
<p>is exactly equivalent to</p>
<p>P = c &times; (V &times; I)  </p>
<p>if c = a &times; b<br />
 - and then you can call it powerCal.</p>
<p>Multiple turns on your CT is equivalent to changing b, therefore if you change powerCal by the appropriate number, you will have the correct calibration. </p>
<p>Robin wrote "Then no <b>other</b> changes to the code should be necessary." - meaning that you change powerCal but nothing else.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36234"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 23/11/2015 - 01:38.</div>
    <div class="content">
     <p>Hi.</p>
<p>You are right.</p>
<p>I didn&#39;t notice the &quot;power&quot; in powercal and I was fixed on Ical =90.9 found on the EmonPi. Wrongly I was assuming that calibration value was only applying to I, not the P. That is sorted out.</p>
<p>So this means I will have to calibrate it all before any use because my AC-AC adapter is not any of the standard ones. If I use the standard powecal values I will get wrong values like I obtained with the original EmonPI firmware before calibrating its Vcal (Ical was accurate enough because the hardware was the same).</p>
<p>I have to make tests with the voltageCal to obtain accurate Voltage readings.</p>
<p>Then with a true resistive device obtain V and I values to calculate the power and calibrate powerCal, don&#39;t know exactly how.</p>
<p>The value that powerCal presently have (0.25), how should I calculate mine with what I have available to do it: resistive load and an accurate enough multi meter? (I also have the current EmonPi FW working, but I cannot use at the same time, yet I could make some changes on it to pickup values for calibration in this new mk firmware)</p>
<p>The ideal would be to have Ical and Vcal, so the firmware would calculate it&#39;s Pcal for it&#39;s own usage...</p>
<p>In the end (after calibration with single turns), will it be enough to divide powerCal by the number of turns on the CT to obtain correct values?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36255"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Mon, 23/11/2015 - 15:29.</div>
    <div class="content">
     <p>@CidiRome, you are critical of this line in my code because the parameters have not been calibrated</p>
<p><em>&nbsp; &nbsp; &nbsp; instP = filtV_div4 * filtI_div4; &nbsp;// 32-bits (now x4096, or 2^12)</em></p>
<p>Here is the equivalent part of the emonLib library where data samples are treated.&nbsp; As you will see, much of &quot;my own&quot; code is very similar to this:</p>
<p><em>&nbsp;&nbsp;&nbsp; // A) Read in raw voltage and current samples<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; sampleV = analogRead(inPinV);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Read in raw voltage signal<br />
&nbsp;&nbsp;&nbsp; sampleI = analogRead(inPinI);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Read in raw current signal</em></p>
<p><em>&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; // B) Apply digital high pass filters to remove 2.5V DC offset (centered on 0V).<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; filteredV = 0.996*(lastFilteredV+sampleV-lastSampleV);<br />
&nbsp;&nbsp;&nbsp; filteredI = 0.996*(lastFilteredI+sampleI-lastSampleI);<br />
&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; // C) Root-mean-square method voltage<br />
&nbsp;&nbsp;&nbsp; //----------------------------------------------------------------------------- &nbsp;<br />
&nbsp;&nbsp;&nbsp; sqV= filteredV * filteredV;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //1) square voltage values<br />
&nbsp;&nbsp;&nbsp; sumV += sqV;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //2) sum<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; // D) Root-mean-square method current<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; sqI = filteredI * filteredI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //1) square current values<br />
&nbsp;&nbsp;&nbsp; sumI += sqI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //2) sum<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; // E) Phase calibration<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; phaseShiftedV = lastFilteredV + PHASECAL * (filteredV - lastFilteredV);<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------<br />
&nbsp;&nbsp;&nbsp; // F) Instantaneous power calc<br />
&nbsp;&nbsp;&nbsp; //-----------------------------------------------------------------------------&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; instP = phaseShiftedV * filteredI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Instantaneous Power<br />
&nbsp;&nbsp;&nbsp; sumP +=instP;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Sum</em> &nbsp;</p>
<p>The main difference between &quot;my own&quot; code and that in&nbsp;emonLib is that the former has to run continuously, with no gaps.&nbsp; V &amp; I amples are taken at fixed intervals and all processing needs to be completed within the allocated time interval; otherwise, data will be lost.&nbsp; In emonLib, everything is done sequentially using floating-point maths, and the process takes as long as it takes.&nbsp; The emonLib approach was designed for battery-powered applications and is not intended to run continuously.&nbsp;</p>
<p>Each technology is good for its intended purpose, but they do not combine well.&nbsp; As you have found, their approach to calibration is very different.&nbsp; Each of them has stood the test of time and is working reliably in countless applications for users.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36258"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 23/11/2015 - 16:40.</div>
    <div class="content">
     <p>Yes.</p>
<p>On my last post, with help from Robert, I already understood that I was being miss leaded with the powercal thinking it was only for I, but it is for P (I*V)... This removed any doubts about your code working correcly...</p>
<p>At this point I can understand most of your code and have already made most of the changes I need to use it in my EmonPI, I&#39;m only (a little bit) stuck on how to calibrate it, specially the powercal value... I think the Vcal won&#39;t be a problem and I&#39;ll&nbsp;able to nail it easly.</p>
<p>Can you point me into the right direction&nbsp;about calibrating based on what I stated on my last post?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36261"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 23/11/2015 - 17:38.</div>
    <div class="content">
     <p>In response to a similar question, I have written a complete explanation of how powerCal is derived and calculated. If you search the forums carefully, you should find that.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36270"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 24/11/2015 - 09:33.</div>
    <div class="content">
     <p>Hi</p>
<p>Update:<br />
Before thinking about calibrating I compiled my altered code using the default calibrations.<br />
I thought I would get readings with differences of a few volts and watts, since the code was made for EmonTX and there is not&nbsp;huge difference&nbsp;to EmonPI, in fact the only difference I expected was that my AC-AC transformer to give a little higher reading compared with the default&nbsp;EmonPI (my vcal was&nbsp;261.56&nbsp;and the original EmonPi&nbsp;was&nbsp;276.9)<br />
Don&#39;t know why but I got reading on voltage between 9 and 11 Volts (changing the timesten to time100 as EmonCMS in PI is configured to use) and wattage reading of less than 20W when expected would be about 300W.</p>
<p>Tomorrow I will look more into this... That&#39;s enough for today.</p>
<p>PS: I didn&#39;t account the CT turns I have, but even so, the reading are too much off. I already started porting the code from the beginning again. this time I will be quick since I already understand it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36296"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 24/11/2015 - 22:12.</div>
    <div class="content">
     <p>Hi.</p>
<p>Calipso_Rae:<br />
I&#39;m working on this code (don&#39;t know the exact file name but file&nbsp;starts with&nbsp;<em>/*&nbsp;emonTxV3_4_as_Mk2Router.ino -&gt; emonTxV3_4_as_Mk2Router_PAcontrol.ino</em>) and it seems that there a few mixup situations about the values read from the ADC and where the values are stored.</p>
<p>As I understood in each case of the program reads the ADC value and immediately after sets the next to be read.</p>
<p>I noticed that a few comments seem to be off and there seems to be at least one situation that the value is not the correct one.</p>
<p>on case 2, the requested value for the next is CT1;<br />
on case 3, the read value is used/stored on&nbsp;sumP_CT2</p>
<p>Am I wrong?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36298"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 24/11/2015 - 22:55.</div>
    <div class="content">
     <p>@CidiRome,&nbsp; Some of my later &quot;Mk2&quot; sketches are a lot more complex than the original version.&nbsp; In the one that you&#39;ve mentioned, all of the time-critical background activities take place within the ISR rather than in the main code.&nbsp; By this means, the main processor can be freed up for slower activities such as RF, temperature measurements and Serial.&nbsp;</p>
<p>The ADC is in free-running mode, so the &quot;next&quot; conversion always starts automatically.&nbsp; The ISR therefore has to setup the conditions for the one after that.&nbsp; This somewhat convoluted mechanism is all explained in the comments. To really appreciate what&#39;s going on beneath the surface, you may have to think about it for a while and perhaps&nbsp; draw a diagram or two.&nbsp; I am not aware of any &quot;mixup situations&quot; in any code that I have posted.</p>
<p><em>Am I wrong?</em></p>
<p>Well, I think it is unhelpful of you to keep criticising my code without well-founded reason.&nbsp; These sketches seem to be working OK for everyone else.&nbsp; Anyway, I thought you had got everything sorted out except for calibration ...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36300"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 24/11/2015 - 23:22.</div>
    <div class="content">
     <p>Hi.</p>
<p>I think I&#39;ve already understood how the processor and ISR work.</p>
<p>So, this code</p>
<blockquote><p>&nbsp; &nbsp; &nbsp; rawSample = ADC; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// store the ADC value (this one is for Voltage)<br />
&nbsp; &nbsp; &nbsp; ADMUX = 0x40 + currentSensor_diverted; &nbsp;// the conversion for current_grid (CT4) is already under way</p>
</blockquote>
<p>reads the present sample into rawSample and sets the one&nbsp;that will be read&nbsp;next time we get a sample&nbsp;with&nbsp;rawSample&nbsp;= ADC<br />
<strong>Please tell me if this statement is wrong...</strong></p>
<p>I&#39;m not criticizing anything at least&nbsp;not in a negative way like you seem to be implying, and when I&#39;m wrong I&#39;m the first to admit it.</p>
<p>I may not be an expert on electricity, I know I&#39;m not, but in the field of programming that&#39;s another story, I do not consider myself an expert in this field also but I know my capacities on programming language are above average.</p>
<p>I may not be able to completely understand you code that relates to mathematical and electricity calculations, but generally I can detect mistakes.</p>
<p>Please tell me that this is not a mistake (not important an one, but a mistake):</p>
<blockquote><p>&nbsp; &nbsp; &nbsp; ADMUX = 0x40 + currentSensor_<strong>CT1</strong>; &nbsp;// the conversion for current_<strong>CT2</strong> is already under way</p>
</blockquote>
<p>Unless I understood it wrong, you explain in the comment that CT2 is under the way but request CT1, isn&#39;t it?</p>
<p>I&#39;m sorry that I&#39;m trying to add value to you creation as I would like very much to use it and later share it with others...</p>
<p>At this point I&#39;m very sad: I ported all the code again, chunk-by-chunk for&nbsp;emonPi&nbsp;compatibility with exact the same results as yesterday. I would like to have better news, but unfortunately&nbsp;I don&#39;t.</p>
<p>I only have one EmonPi that I want&nbsp;to keep down for the least time I can because it is monitoring my home energy.</p>
<p>Is there anyone out there with a spare emonPI&nbsp;and knowledge&nbsp;to test my code on it? If yes I can post it somewhere.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36306"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 25/11/2015 - 07:32.</div>
    <div class="content">
     <p><i>"Unless I understood it wrong,"</i></p>
<p>Yes, you did "understood it wrong". Earlier, you wrote "I think I've already understood how the processor and ISR work." Clearly, you don't. Please read the Atmel data sheet where working of the processor and the interaction between the operation of the ADC and the trigger, which in this case is the interrupt that it itself generates, is explained much more fully than is possible in a single line comment in a sketch. As Robin suggested, you need to draw some diagrams to understand how the four actions - pre-loading the multiplexer, generating the interrupt, switching the multiplexer and doing the conversion, and handling the interrupt - interact.</p>
<p>You claim your programming knowledge is above average, sadly I think your evaluation of average programming knowledge might be little different to that of others. One thing that you must remember is, if something (software, hardware, whatever it is) has been looked at and used by many people before you, and nobody has found fault, there is a good possibility that it really is OK - it might not be, of course, but such cases are rare.</p>
<p>You have indicated that you intend to publish your version of Robin's work. I have to warn you that unless the original source (Robin Emley - calypso_rae) is properly credited, the moderators will view your contribution as plagiarism and will act accordingly.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36308"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 25/11/2015 - 19:19.</div>
    <div class="content">
     <p>CidiRome, I&#39;m not at all familiar with the sketch in question, but I can explain how the ADC works in free-running mode. &nbsp;It&#39;s not that complicated&nbsp;and the technique has been around for a long time (and well and truly pre-dates the Arduino).</p>
<p>There are three conversions you need to be aware of:</p>
<ol>
<li>conversion just completed</li>
<li>conversion currently being worked on</li>
<li>conversion you want it to do next</li>
</ol>
<p>The result of #1&nbsp;is available in the ADC register right up until #2&nbsp;completes at which time it gets overwritten and they all shuffle along by one. &nbsp;Conversion times depend on clock settings, but a typical time is about <s>110usecs</s><strong>&nbsp;104 usecs</strong>.</p>
<p>If the ADC is truly running in free-running mode than the ISR is not involved in starting the next conversion. &nbsp; When the current conversion completes, the ADC immediately starts on the next conversion. &nbsp;Optionally,&nbsp;an&nbsp;IRQ is raised&nbsp;if so configured.</p>
<p>When setting up the MUX, you&#39;re&nbsp;actually telling it which input it should sample on the next conversion (#3 above). &nbsp;There are some constraints on when you can write to the MUX but provided you stay away from the <strike>110usecs</strike>&nbsp;<strong>104 usecs</strong>&nbsp;boundaries it is very flexible. &nbsp;Likewise, you need to take a little care at the beginning, &nbsp;as your state machine can&#39;t assume a &quot;conversion just completed&quot; (#1 above) exists (unless you manually fired one off).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36310"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 25/11/2015 - 09:39.</div>
    <div class="content">
     <p><em>is explained much more fully than is possible in a single line comment in a sketch</em></p>
<p>Perhaps one of the improvements&nbsp;CidiRome&nbsp;can make to the code is to use multi-line comments for that bit.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36312"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 25/11/2015 - 09:57.</div>
    <div class="content">
     <p>Hi.</p>
<p>@dBC: thank you for your constructive explanation, it is really very helfpul.</p>
<p>In this case the code uses sets up MUX, so the next reading will be the one we setup in the present cycle.<br />
The 110usecs time is how long the value stays available before being replaced with other, or how long it takes to be available? (the second option seems to long to be the correct&nbsp;answer)<br />
Even when MUX is set, the ADC changes to the next sample after that time?</p>
<p>@dBC: can you please look to this chuck of programming and tell me that I&#39;m seeing it wrong.<br />
Please note that it is the original Code I didn&#39;t make any changes (This first part is only to see how the ISR was setup):</p>
<blockquote><p>(...)</p>
<p>&nbsp; // Set up the ADC to be free-running&nbsp;<br />
&nbsp; ADCSRA &nbsp;= (1&lt;&lt;ADPS0)+(1&lt;&lt;ADPS1)+(1&lt;&lt;ADPS2); &nbsp;// Set the ADC&#39;s clock to system clock / 128<br />
&nbsp; ADCSRA |= (1 &lt;&lt; ADEN); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Enable the ADC&nbsp;<br />
&nbsp;&nbsp;<br />
&nbsp; ADCSRA |= (1&lt;&lt;ADATE); &nbsp;// set the Auto Trigger Enable bit in the ADCSRA register. &nbsp;Because&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// bits ADTS0-2 have not been set (i.e. they are all zero), the&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// ADC&#39;s trigger source is set to &quot;free running mode&quot;.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; ADCSRA |=(1&lt;&lt;ADIE); &nbsp; &nbsp;// set the ADC interrupt enable bit. When this bit is written&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// to one and the I-bit in SREG is set, the&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// ADC Conversion Complete Interrupt is activated.&nbsp;</p>
<p>&nbsp; ADCSRA |= (1&lt;&lt;ADSC); &nbsp; // start ADC manually first time&nbsp;<br />
&nbsp; sei(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Enable Global Interrupts &nbsp;</p>
<p>(...)</p>
<p>ISR(ADC_vect) &nbsp;<br />
/*<br />
&nbsp;* This Interrupt Service Routine looks after the acquisition and processing of<br />
&nbsp;* raw samples from the ADC sub-processor. &nbsp;By means of various helper functions, all of&nbsp;<br />
&nbsp;* the time-critical activities are processed within the ISR. &nbsp;The main code is notified<br />
&nbsp;* by means of a flag to show when fresh copies of loggable data are available.<br />
&nbsp;*/<br />
{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; static unsigned char sample_index = 0;<br />
&nbsp; static long sampleV_minusDC_long;<br />
&nbsp; int rawSample;<br />
&nbsp; long filtV_div4;<br />
&nbsp; long filtI_div4;<br />
&nbsp; long instP;<br />
&nbsp; long inst_Vsquared;<br />
&nbsp; long sampleIminusDC_long;<br />
&nbsp; long phaseShiftedSampleV_minusDC_long;<br />
&nbsp; &nbsp;<br />
&nbsp; switch(sample_index)<br />
&nbsp; {<br />
&nbsp; &nbsp; case 0:<br />
&nbsp; &nbsp; &nbsp; rawSample = ADC; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// store the ADC value (this one is for Voltage)<br />
&nbsp; &nbsp; &nbsp; ADMUX = 0x40 + currentSensor_diverted; &nbsp;// the conversion for current_grid (CT4) is already under way<br />
&nbsp; &nbsp; &nbsp; sample_index++; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // increment the control flag<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; sampleVminusDC_long = ((long)rawSample&lt;&lt;8) - DCoffset_V_long;&nbsp;<br />
&nbsp; &nbsp; &nbsp; if(sampleVminusDC_long &gt; 0) {&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; polarityNow = POSITIVE; }<br />
&nbsp; &nbsp; &nbsp; else {&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; polarityNow = NEGATIVE; }<br />
&nbsp; &nbsp; &nbsp; confirmPolarity();<br />
&nbsp; &nbsp; &nbsp; // &nbsp;<br />
&nbsp; &nbsp; &nbsp; checkProgress(); // deals with aspects that only occur at particular stages of each mains cycle<br />
&nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; // for the Vrms calculation (for datalogging only)<br />
&nbsp; &nbsp; &nbsp; filtV_div4 = sampleVminusDC_long&gt;&gt;2; &nbsp;// reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; inst_Vsquared = filtV_div4 * filtV_div4; // 32-bits (now x4096, or 2^12)<br />
&nbsp; &nbsp; &nbsp; inst_Vsquared = inst_Vsquared&gt;&gt;12; &nbsp; &nbsp; // scaling is now x1 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; sum_Vsquared += inst_Vsquared; // cumulative V^2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; sampleSetsDuringThisDatalogPeriod++;&nbsp;<br />
&nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; // store items for use during next loop<br />
&nbsp; &nbsp; &nbsp; cum_VdeltasThisCycle_long += sampleVminusDC_long; // for use with LP filter<br />
&nbsp; &nbsp; &nbsp; lastSampleV_minusDC_long = sampleVminusDC_long; &nbsp;// required for phaseCal algorithm<br />
&nbsp; &nbsp; &nbsp; polarityConfirmedOfLastSampleV = polarityConfirmed; &nbsp;// for identification of half cycle boundaries<br />
&nbsp; &nbsp; &nbsp; sampleSetsDuringThisCycle++; &nbsp;// for real power calculations<br />
&nbsp; &nbsp; break;<br />
&nbsp; &nbsp; case 1:<br />
&nbsp; &nbsp; &nbsp; rawSample = ADC; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // store the ADC value (this one is for Grid Current on CT4)<br />
&nbsp; &nbsp; &nbsp; ADMUX = 0x40 + currentSensor_CT2; &nbsp;// the conversion for current_diverted (CT3) is already under way<br />
&nbsp; &nbsp; &nbsp; sample_index++; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // increment the control flag<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // remove most of the DC offset from the current sample (the precise value does not matter)<br />
&nbsp; &nbsp; &nbsp; sampleIminusDC_long = ((long)(rawSample-DCoffset_I))&lt;&lt;8;<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // phase-shift the voltage waveform so that it aligns with the current waveform at CT4<br />
&nbsp; &nbsp; &nbsp; phaseShiftedSampleV_minusDC_long = lastSampleV_minusDC_long<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ (((sampleVminusDC_long - lastSampleV_minusDC_long)*phaseCal_int_CT4)&gt;&gt;8); &nbsp;<br />
&nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; // calculate the &quot;real power&quot; in this sample pair and add to the accumulated sum<br />
&nbsp; &nbsp; &nbsp; filtV_div4 = phaseShiftedSampleV_minusDC_long&gt;&gt;2; &nbsp;// reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; filtI_div4 = sampleIminusDC_long&gt;&gt;2; // reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; instP = filtV_div4 * filtI_div4; &nbsp;// 32-bits (now x4096, or 2^12)<br />
&nbsp; &nbsp; &nbsp; instP = instP&gt;&gt;12; &nbsp; &nbsp; // scaling is now x1, as for Mk2 (V_ADC x I_ADC) &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; sumP_grid +=instP; // cumulative power, scaling as for Mk2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; sumP_forEnergyBucket+=instP; // cumulative power, scaling as for Mk2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; break;<br />
&nbsp; &nbsp; case 2:<br />
&nbsp; &nbsp; &nbsp; rawSample = ADC; &nbsp; &nbsp;// store the ADC value (this one is for diverted current on CT3)<br />
&nbsp; &nbsp; &nbsp; ADMUX = 0x40 + currentSensor_CT1; &nbsp;// the conversion for current_CT2 is already under way<br />
&nbsp; &nbsp; &nbsp; sample_index++; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // increment the control flag<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // remove most of the DC offset from the current sample (the precise value does not matter)<br />
&nbsp; &nbsp; &nbsp; sampleIminusDC_long = ((long)(rawSample-DCoffset_I))&lt;&lt;8;<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // phase-shift the voltage waveform so that it aligns with the current waveform at CT3<br />
&nbsp; &nbsp; &nbsp; phaseShiftedSampleV_minusDC_long = lastSampleV_minusDC_long<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ (((sampleVminusDC_long - lastSampleV_minusDC_long)*phaseCal_int_CT3)&gt;&gt;8);<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // calculate the &quot;real power&quot; in this sample pair and add to the accumulated sum<br />
&nbsp; &nbsp; &nbsp; filtV_div4 = phaseShiftedSampleV_minusDC_long&gt;&gt;2; &nbsp;// reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; filtI_div4 = sampleIminusDC_long&gt;&gt;2; // reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; instP = filtV_div4 * filtI_div4; &nbsp;// 32-bits (now x4096, or 2^12)<br />
&nbsp; &nbsp; &nbsp; instP = instP&gt;&gt;12; &nbsp; &nbsp; // scaling is now x1, as for Mk2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; sumP_diverted +=instP; // cumulative power, scaling as for Mk2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; sumP_forDivertedEnergy+=instP; // cumulative power, scaling as for Mk2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; break;<br />
&nbsp; &nbsp; case 3:<br />
&nbsp; &nbsp; &nbsp; rawSample = ADC; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // store the ADC value (this one is for current_CT2)<br />
&nbsp; &nbsp; &nbsp; ADMUX = 0x40 + voltageSensor; &nbsp;// the conversion for current_CT1 is already under way<br />
&nbsp; &nbsp; &nbsp; sample_index++; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // increment the control flag<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // remove most of the DC offset from the current sample (the precise value does not matter)<br />
&nbsp; &nbsp; &nbsp; sampleIminusDC_long = ((long)(rawSample-DCoffset_I))&lt;&lt;8;<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // phase-shift the voltage waveform so that it aligns with the current waveform at CT2<br />
&nbsp; &nbsp; &nbsp; phaseShiftedSampleV_minusDC_long = lastSampleV_minusDC_long<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ (((sampleVminusDC_long - lastSampleV_minusDC_long)*phaseCal_int_CT2)&gt;&gt;8); &nbsp;<br />
&nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; // calculate the &quot;real power&quot; in this sample pair and add to the accumulated sum<br />
&nbsp; &nbsp; &nbsp; filtV_div4 = phaseShiftedSampleV_minusDC_long&gt;&gt;2; &nbsp;// reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; filtI_div4 = sampleIminusDC_long&gt;&gt;2; // reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; instP = filtV_div4 * filtI_div4; &nbsp;// 32-bits (now x4096, or 2^12)<br />
&nbsp; &nbsp; &nbsp; instP = instP&gt;&gt;12; &nbsp; &nbsp; // scaling is now x1, as for Mk2 (V_ADC x I_ADC) &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; sumP_CT2 +=instP; // cumulative power, scaling as for Mk2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; break;<br />
&nbsp; &nbsp; case 4:<br />
&nbsp; &nbsp; &nbsp; rawSample = ADC; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // store the ADC value (this one is for current_CT1)<br />
&nbsp; &nbsp; &nbsp; ADMUX = 0x40 + currentSensor_grid; &nbsp;// the conversion for Voltage is already under way<br />
&nbsp; &nbsp; &nbsp; sample_index = 0; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // reset the control flag<br />
&nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; // remove most of the DC offset from the current sample (the precise value does not matter)<br />
&nbsp; &nbsp; &nbsp; sampleIminusDC_long = ((long)(rawSample-DCoffset_I))&lt;&lt;8;<br />
&nbsp; &nbsp; &nbsp; //<br />
&nbsp; &nbsp; &nbsp; // phase-shift the voltage waveform so that it aligns with the current waveform at CT1<br />
&nbsp; &nbsp; &nbsp; phaseShiftedSampleV_minusDC_long = lastSampleV_minusDC_long<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ (((sampleVminusDC_long - lastSampleV_minusDC_long)*phaseCal_int_CT1)&gt;&gt;8); &nbsp;<br />
&nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; // calculate the &quot;real power&quot; in this sample pair and add to the accumulated sum<br />
&nbsp; &nbsp; &nbsp; filtV_div4 = phaseShiftedSampleV_minusDC_long&gt;&gt;2; &nbsp;// reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; filtI_div4 = sampleIminusDC_long&gt;&gt;2; // reduce to 16-bits (now x64, or 2^6)<br />
&nbsp; &nbsp; &nbsp; instP = filtV_div4 * filtI_div4; &nbsp;// 32-bits (now x4096, or 2^12)<br />
&nbsp; &nbsp; &nbsp; instP = instP&gt;&gt;12; &nbsp; &nbsp; // scaling is now x1, as for Mk2 (V_ADC x I_ADC) &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; sumP_CT1 +=instP; // cumulative power, scaling as for Mk2 (V_ADC x I_ADC)<br />
&nbsp; &nbsp; &nbsp; break;<br />
&nbsp; &nbsp; &nbsp;default:<br />
&nbsp; &nbsp; &nbsp; sample_index = 0; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // to prevent lockup (should never get here) &nbsp; &nbsp; &nbsp;<br />
&nbsp; }<br />
}</p>
</blockquote>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36314"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 25/11/2015 - 12:15.</div>
    <div class="content">
     <p>RobertWall, dBC,</p>
<p>Thanks guys.&nbsp; I am in complete agreement with your descriptions of how my free-running ADC code is operating.</p>
<p>Robin</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36315"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 25/11/2015 - 19:21.</div>
    <div class="content">
     <p>CidiRome, I&#39;ve no plans to review that code you posted, but I&#39;m happy to answer any ADC questions you might have. &nbsp;In particular:</p>
<p><em>The 110usecs time is how long the value stays available before being replaced with other, or how long it takes to be available? (the second option seems to long to be the correct&nbsp;answer)</em></p>
<p>In free-running mode there&#39;ll be a new result every <s>110</s> <strong>104 </strong>usecs. &nbsp;That means you have <s>110</s>&nbsp;<strong>104&nbsp;</strong>usecs to read the result before it gets overwritten by the next conversion. &nbsp;So I think the answer to your question is both.... it&#39;s how long you&#39;ve got to read the result, and it&#39;s how long it takes to do a conversion.</p>
<p><em>Even when MUX is set, the ADC changes to the next sample after that time?</em></p>
<p>I don&#39;t understand that question, perhaps you can re-phrase? &nbsp;In free-running mode, writing to the MUX has no immediate effect on the ADC as it&#39;s busy converting the currently stored voltage. &nbsp;At the next <s>110</s>&nbsp;<strong>104&nbsp;</strong>usec tick&nbsp;it will complete the current conversion, and start on a new one. &nbsp;It&#39;s at that time that MUX setting matters. &nbsp;The first 2 or so (from memory) ADC clocks is when it captures the voltage, so that&#39;s when the MUX setting matters.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36316"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 25/11/2015 - 13:13.</div>
    <div class="content">
     <p>Humm.</p>
<p>Thank you for the explanation.<br />
So it is possible that when I read a value and request the next, this next value is not the one that is obtained in the next cycle. in this case the configured cycle is (/128).</p>
<p>I was thinking like this:</p>
<blockquote><p>Cycle&nbsp;0:<br />
Read valueX;<br />
Request valueA</p>
<p>Cycle 1:<br />
Read valueA<br />
Request valueB</p>
<p>Cycle 2:<br />
Read valueB<br />
Request valueC</p>
<p>&gt; go to the beguining making the valueX be valueC</p>
</blockquote>
<p>But depending how long the cycle&nbsp;is seems that it can be something like this (just an example):</p>
<blockquote><p>Cycle&nbsp;0:<br />
Read valueX;<br />
Request&nbsp;valueA</p>
<p>Cycle&nbsp;1:<br />
Read&nbsp;valueX2<br />
Request&nbsp;valueB</p>
<p>Cycle&nbsp;2:<br />
Read&nbsp;valueA<br />
Request&nbsp;valueC</p>
<p>&gt; go to the&nbsp;beginning&nbsp;making the valueX be&nbsp;valueB and ValueX2 be valueC</p>
</blockquote>
<p>&nbsp;If I made the calculation correctly, the ISR will occur at a rate of 125Khz&nbsp;and this means evey 8 micro-seconds. It seems this can mess&nbsp;up&nbsp;the values being&nbsp;read it takes 110 micro-seconds to have a reading available.</p>
<p>I just have a few more information to think during the day...</p>
<p>PS: Robert and Rae. Taking in account the way you have been answering to me&nbsp;lately,&nbsp;If you want, I will stop posting my findings and troubleshoots and do my investigation off-line. I was posting every bit of information thinking it may be usefully to others, if you think otherwise just say... I don&#39;t say that any help is appreciated, but if it is the way this forum is supposed to work I will abide.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36317"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 25/11/2015 - 13:15.</div>
    <div class="content">
     <p>CidiRome, you may find it helpful to look at the ISR structures in my Mk2i code.&nbsp; Two different ways of controlling the ADC are provided, with a compile-time flag being set to determine which one is used.&nbsp; In one case, a fixed-duration hardware timer determines when the next conversion will start.&nbsp; In the other case, the ADC is free-running.&nbsp; Because of the high workload, my recent code for the emonTx V3 uses the latter approach.&nbsp;</p>
<p>The latest version of my Mk2i code is available at: &nbsp;</p>
<p><a href="../sites/default/files/Mk2i_PV_Router_rev5e.ino_.zip">http://openenergymonitor.org/emon/sites/default/files/Mk2i_PV_Router_rev5e.ino_.zip</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36327"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 25/11/2015 - 19:15.</div>
    <div class="content">
     <p>I<em>f I made the calculation correctly, the ISR will occur at a rate of 125Khz&nbsp;and this means evey 8 micro-seconds. It seems this can mess&nbsp;up&nbsp;the values being&nbsp;read it takes 110 micro-seconds to have a reading available.</em></p>
<p>125kHZ is a typical ADC clock rate, but the ADC takes 13 clocks to complete a conversion so you&#39;ll get an interrupt every 13*8 = 104 usecs. &nbsp;The ~110 usecs quoted by me above is incorrect, I should have said 104 usecs. &nbsp;In any case, the interrupt occurs when the conversion is complete, so you don&#39;t need to worry about it. &nbsp;(I&#39;m referring to free-running mode here).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36328"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 25/11/2015 - 20:30.</div>
    <div class="content">
     <p>Yes, when conversion N has finished, an ISR is called.&nbsp; The ISR sets up the relevant conditions for conversion N+2 because conversion N+1 is already under way.&nbsp; This is how my code behaves when the ADC is in free-running mode.&nbsp;</p>
<p>For the version that uses a hardware timer of 125 us, the conditions for conversion N+1 are set up within the ISR that occurs at the end of conversion N.&nbsp; The sampling rate, and hence the processor&#39;s workload, can be changed by adjusting the duration of the timer.</p>
<p>These interrupt-based regimes for operating the ADC were supplied to me by Jorg Becker circa December 2012, and they have both proved to be entirely reliable since then.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36330"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 25/11/2015 - 21:50.</div>
    <div class="content">
     <p>Humm, very good, that explains it,&nbsp;I think.</p>
<p>Can you elucidate one thing to me:<br />
At the very first cycle of the ISR, ADMUX&nbsp;has not be defined yet, how do you know the reading you are doing is for Analog port for&nbsp;Voltage and the second for CT2?</p>
<p>I would think of a flag to ignore the first few readings until the ISR is reading the expected values...</p>
<p>Cheers.</p>
<p>Update:</p>
<p>With this last indication I made the necessary changes in the ISR and I&#39;m now reading valid results:<br />
Next JOBS related with calibration:<br />
- Take in account for the 3 turns in CT1 and 10 turns in CT2;<br />
- Calibrate the VRMS, it seems to be reading a voltage about 6&nbsp;Volts over the real.</p>
<p>On EmonPI base firmware&nbsp;was getting a <em>Night Production</em>&nbsp;of about&nbsp;3W, with this firmware it seems to be worse about 7W (reading before turn division is 70W)...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36331"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 25/11/2015 - 23:25.</div>
    <div class="content">
     <p><em>I would think of a flag to ignore the first few readings until the ISR is reading the expected values...</em></p>
<p>Have you checked the effect of the existing flag, <em>beyondStartUpPhase</em> ?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36332"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 25/11/2015 - 23:50.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve seen that flag, if I remember correctly, that flag is checked the first time after the first Voltage reading has been made.. but the counters seem to be reset, so any miss reading are reset... Ok, understood.</p>
<p>At this moment I&#39;m implementing a mix program that uses, in intervals of 20 seconds, the emonLib and your program to be calibrate it without the need of measuring everything again because the system is in-place&nbsp;and the CT Sensors inside the breaker box. Tomorrow I will continue.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36334"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 26/11/2015 - 08:26.</div>
    <div class="content">
     <p>CidiRome, The flag, <em>beyondStartUpPhase</em>, is checked at the start of <em><strong>every new mains cycle throughout the lifetime of the program</strong></em>.&nbsp; A quick check of the code will reveal this.&nbsp;&nbsp; This flag is initialised to false, and is then set to true after everything has settled down a few seconds later.&nbsp; This same approach has been taken in all of my Mk2 code variants.&nbsp; The presence of this flag hopefully meets with your approval.</p>
<p>I would be grateful if you could refrain from complaining about my software unless you have found that the original version is deficient in some way.&nbsp; Learning about how other people&#39;s code behaves is fine, but please do not make negative assertions in public that are ill-founded.</p>
<p>When I want to learn about someone else&#39;s code, I run it as posted to see how it behaves.&nbsp; I then make strategic changes as necessary to improve my own understanding.&nbsp; At any stage, I can revert to the original version as a reminder of how the author intended it to be.</p>
<p>As soon as you have made <em>any </em>alterations, you need to take responsibility yourself for the new version.&nbsp; Any changes that you make could have significant side-effects on the program&#39;s behaviour which only you can investigate, analyse and resolve.&nbsp; If any suspected errors are found in the original code, it would be courteous to raise the matter in private with the author rather than posting your initial findings in public view.&nbsp; There could well be an explanation that you had not thought of.</p>
<p>Finally, may I add a word of warning that my &quot;Mk2&quot; code must be allowed to run continuously.&nbsp; This observation is in response to your posting that:</p>
<p><em>At this moment I&#39;m implementing a mix program that uses, in intervals of 20 seconds, the emonLib and your program</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36335"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Hook Triac or FET to EmonPi</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 26/11/2015 - 10:39.</div>
    <div class="content">
     <p>Thank you for your answer.</p>
<p>That was the last statement I made about your code, your last message made it clear&nbsp;that you feel offended about me questioning how your code&nbsp;works as if I would be diminishing you or your work in any way.</p>
<p>My objective was always to learn and maybe help others to learn&nbsp; on how it work and if I implied that something may not be correct, was to obtain an explanation that would contradict me and I apologize&nbsp;if at any time I gave other impressions.</p>
<p>So, since, by what you say,&nbsp;the code is perfect and works flawlessly, my experience&nbsp;feedback on emonPi&nbsp;hardware&nbsp;is not welcome and has ended to be public.</p>
<p>Have a nice day.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11574"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-Q_s2BKiac1WnVHFxFw-wQJ_xwr3_hcJSqUeXcC9IxZM" value="form-Q_s2BKiac1WnVHFxFw-wQJ_xwr3_hcJSqUeXcC9IxZM"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/11574 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:13:24 GMT -->
</html>
