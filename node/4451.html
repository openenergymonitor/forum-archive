<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/4451 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:27:13 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Emoncms V7 Daily Average Function (Arithmetic Mean) | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Emoncms V7 Daily Average Function (Arithmetic Mean)</h3>
        <span class="submitted">Submitted by <a href="../user/3240.html" title="View user profile.">john.b</a> on Fri, 28/03/2014 - 11:32</span>
        <div class="content"><p>Emoncms V7 doesn&#39;t seem to have a daily average function.&nbsp; I recently upgraded to V7 and found my <a href="http://en.wikipedia.org/wiki/Heating_degree_day">Heating Degree Day </a>feed was not working.&nbsp; This used the daily average feature (V5)&nbsp;to calculate the average outside&nbsp;temperature below a certain value (ie equivalent to the HDD).</p>
<p>I know there have been posts about average temperature calculation here before, but I can&#39;t see a solution.</p>
<p>I have tried the slightly contrived method of using kWh to KWh/d, but this doesn&#39;t seem to be a daily average of the data.&nbsp; At least the result is not correct.</p>
<p>Does anyone have a solution to calculating a daily average?</p>
<p>Any help would be much appreciated.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10527.html" class="topic-previous" title="Go to previous forum topic">‹ EMONCMS Key and Name update via the Input API</a>
              <a href="6016.html" class="topic-next" title="Go to next forum topic">Increase log interval to more than 1hour ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-19981"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3240.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="john.b&#039;s picture" title="john.b&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emoncms V7 Daily Average Function (Arithmetic Mean)</h3>

    <div class="submitted">Submitted by <a href="../user/3240.html" title="View user profile.">john.b</a> on Fri, 28/03/2014 - 13:07.</div>
    <div class="content">
     <p>Would the solution to this be as simple as copying the relevant php&nbsp;function from the V5 process_model.php&nbsp;file and placing in the V7 process_model.php&nbsp;file?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-19993"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3240.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="john.b&#039;s picture" title="john.b&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emoncms V7 Daily Average Function (Arithmetic Mean)</h3>

    <div class="submitted">Submitted by <a href="../user/3240.html" title="View user profile.">john.b</a> on Fri, 28/03/2014 - 16:25.</div>
    <div class="content">
     <p>I have no experience of php so I&#39;m a little lost here, but I modified the process_model.php file by adding the following from my V5 file:</p>
<p>// Calculates a daily average of a value<br />
	&nbsp;&nbsp;&nbsp; public function average($feedid, $time_now, $value)<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $feedname = &quot;feed_&quot; . trim($feedid) . &quot;&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $feedtime = mktime(0, 0, 0, date(&quot;m&quot;,$time_now), date(&quot;d&quot;,$time_now), date(&quot;Y&quot;,$time_now));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $result = $this-&gt;mysqli-&gt;query(&quot;SELECT * FROM $feedname WHERE time = &#39;$feedtime&#39;&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!$result)&nbsp; return $value;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $row = $result-&gt;fetch_array();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $average = $row[&#39;data&#39;];<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $size = $row[&#39;data2&#39;];</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $new_average = (($average * $size) + $value) / ($size + 1);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $size = $size + 1;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($row)<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;mysqli-&gt;query(&quot;UPDATE $feedname SET data = &#39;$new_average&#39;, data2 = &#39;$size&#39; WHERE time = &#39;$feedtime&#39;&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;mysqli-&gt;query(&quot;INSERT INTO $feedname (`time`,`data`,`data2`) VALUES (&#39;$feedtime&#39;,&#39;$value&#39;,&#39;1&#39;)&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $updatetime = date(&quot;Y-n-j H:i:s&quot;, $time_now);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;mysqli-&gt;query(&quot;UPDATE feeds SET value = &#39;$new_average&#39;, time = &#39;$updatetime&#39; WHERE id=&#39;$feedid&#39;&quot;);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;</p>
<p>also changing the list to</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; $list[17] = array(_(&quot;Daily Average&quot;),ProcessArg::FEEDID,&quot;average&quot;,2,DataType::HISTOGRAM,&quot;Misc&quot;);</p>
<p>I now have the daily average function in the process list, which is one step forward, <em><strong>but unfortunately the feed does not update.</strong></em>&nbsp; Also the datatype keeps reverting to daily after it has been changed to a histogram?</p>
<p>any suggestions?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-20004"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emoncms V7 Daily Average Function (Arithmetic Mean)</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Fri, 28/03/2014 - 17:27.</div>
    <div class="content">
     <p>john.b, do you mean v8 instead of v7? The v8 PHPFIWA (fixed interval with averaging) feed engine has daily averaging built in. It replaces the average input processor. You can also request averages on any other base period: hourly, monthly and so on.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-20007"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3240.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="john.b&#039;s picture" title="john.b&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emoncms V7 Daily Average Function (Arithmetic Mean)</h3>

    <div class="submitted">Submitted by <a href="../user/3240.html" title="View user profile.">john.b</a> on Fri, 28/03/2014 - 17:45.</div>
    <div class="content">
     <p>Hello Trystan,</p>
<p>Thanks for the help.&nbsp; I&#39;m using V7 as per the hard drive image.&nbsp; I&#39;m also using mysql database, which I prefer to stick with as I don&#39;t have fixed intervals.</p>
<p>Further to my post above I just found my database is actually updating with my modified code, but the feed in emoncms says it is NOT.</p>
<p>I have run admin update and check with the appropriate line ($updatelogin = TRUE;) in setting.php</p>
<p>I&#39;ve also deleted the browser cache and refreshed the page, but the feed does not show its updating.</p>
<p>Any clues as to why the feed does not show its updating?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-20263"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5908.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rbreuss&#039;s picture" title="rbreuss&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emoncms V7 Daily Average Function (Arithmetic Mean)</h3>

    <div class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Mon, 31/03/2014 - 13:42.</div>
    <div class="content">
     <p>Trystan, I need daily averaging function as well. But looking into PHPFIWA options, there is at maximum 1 hour of averaging interval. How do you process correct calculation of daily average value (lets say average temperature) with PHPFIWA?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29970"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7048.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7048.jpg" alt="lassetobiasen&#039;s picture" title="lassetobiasen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emoncms V7 Daily Average Function (Arithmetic Mean)</h3>

    <div class="submitted">Submitted by <a href="../user/7048.html" title="View user profile.">lassetobiasen</a> on Tue, 28/04/2015 - 11:29.</div>
    <div class="content">
     <p>Hi everyone,</p>
<p>I&#39;m not sure if you&#39;ll still be reading this post, given the last entry was a year ago.</p>
<p>Anyway, I was wondering if there was a solution to the issue of making daily averages (or averages based on other - user defined - intervals) ? It seems the above thread did not come to a resolution.</p>
<p>I&#39;m using the emoncms software as it is on the homepage (<a href="http://emoncms.org/">http://emoncms.org</a>) which is currently at version 8.3.5. However, the PHPFIWA interval option is at maximum one hour. I therefore cannot see how to calculate a feed as a daily average.</p>
<p>Although it seems possible to adjust the PHP code with a V5 file (process_model.php as described above) this is a little tricky for me, since I&#39;m using the standard software on the emoncms.org server.&nbsp;</p>
<p>Thanks in advance.</p>
<p>Lasse</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/4451"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-QbQQLQvCQUsr_Fb_d1dOh8viP3m2VGnU9B6u__SvyOU" value="form-QbQQLQvCQUsr_Fb_d1dOh8viP3m2VGnU9B6u__SvyOU"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/4451 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:27:13 GMT -->
</html>
