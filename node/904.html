<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/904 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:49:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Dev: Plug and play sensor nodes | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Dev: Plug and play sensor nodes</h3>
        <span class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Thu, 02/08/2012 - 12:35</span>
        <div class="content"><h3>Plug and play sensor nodes</h3>
<p>At the moment to get a system up and running you need to do quite a bit of manual firmware configuration, setting unique node-id's selecting different emontx sketches for different functionality, hard coding the emonglcd to get different screens.&nbsp;To add a second emontx you need to add several lines of code to the emonbase and the basestation needs to know the data structure of the sensor nodes.&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">What if you could upload a standard sketch to each of these nodes, plug your base station into your router, power up an emontx and see emontx 1 appear in a node list in emoncms. Then as you add more nodes they automatically appear in emoncms, no additional base station configuration needed. In time the software could develop to allow remote configuration of nodes such as&nbsp;emontx config and emonGLCD pages: beginning with page template functions as described in the last blog post:&nbsp;<a href="http://openenergymonitor.blogspot.com/2012/07/emonglcd-template-based-displays.html">emonglcd template based displays</a></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">There are several people I know of that are developing these ideas including&nbsp;Mark Campbell who I have been in contact with by email and is developing base station based auto ID assignment (similar to IP addresses) , eeprom storage of auto ID's, MAC address type&nbsp;unique&nbsp;ID's on the nodes.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Pcunha has also developed as part of his larger 1-3 phase sketch remote ID assignment, emontx config including setting calibration variables.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">I put together a MultiNode NanodeRF sketch a couple of weeks back that works with the new version of emoncms, its on github here:&nbsp;<a href="https://github.com/openenergymonitor/NanodeRF/tree/master/NanodeRF_multinode">https://github.com/openenergymonitor/NanodeRF/tree/master/NanodeRF_multinode</a></p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">So I think we're making some good progress on these ideas.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">The following is a barebones concept that demonstrates auto id assignment and&nbsp;receiving&nbsp;data from multiple nodes.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">The main idea is that commands and data packets are sent in a variable width char array.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">The first character in the array details what kind of packet it is:</p>
<pre><strong>d</strong> - 2 byte integer data i.e int power1, power2, power3, voltage..
<strong>i </strong>- set node id<br type="_moz" /></pre><p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">this packet type character determines the packet deconstructor to use.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Effort is made to keep the packets as lightweight as possible, for example sending a set node id command only uses 3 bytes:</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">1st byte is the packet type 'i' for set node id. 2nd byte is the target node id, 3rd byte is the new id.</p>
<pre>
char data[] = {'i',1,autoid};<br /></pre><p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Decoding the 2 byte integer data also allows for different packet lengths, which makes it possible to add a variable to be sent on the sensor node without chaning the basestation.</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Here's the full code:</p>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">&nbsp;</p>
<div>
<p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><b>Concept 1: Auto ID's and Multiple nodes sketch.</b></p>
<h3>TX code</h3>
</div>
<pre>
#include&nbsp;&lt;JeeLib.h&gt;

<span style="color: #CC6600;">int</span> mynode = 1;
#define&nbsp;freq&nbsp;<span style="color: #006699;">RF12_868MHZ</span>
#define&nbsp;group&nbsp;1

typedef&nbsp;struct&nbsp;{&nbsp;<span style="color: #CC6600;">char</span> type; <span style="color: #CC6600;">int</span> power1, power2, power3, battery; } PayloadTX;      
PayloadTX&nbsp;emontx;

<span style="color: #CC6600;">unsigned</span> <span style="color: #CC6600;">long</span> timer;

<span style="color: #CC6600;">void</span> <span style="color: #CC6600;"><b>setup</b></span>()
{
&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">begin</span>(9600);
&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">println</span>(<span style="color: #006699;">&quot;tx&quot;</span>);
&nbsp;&nbsp;
&nbsp;&nbsp;<span style="color: #CC6600;">rf12_initialize</span>(mynode, freq, group);
}

<span style="color: #CC6600;">void</span> <span style="color: #CC6600;"><b>loop</b></span>()
{
&nbsp;&nbsp;<span style="color: #7E7E7E;">//------------------------------------------------------------------</span>
&nbsp;&nbsp;<span style="color: #7E7E7E;">// RX data</span>
&nbsp;&nbsp;<span style="color: #7E7E7E;">//------------------------------------------------------------------</span>
&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (<span style="color: #CC6600;">rf12_recvDone</span>())
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (<span style="color: #006699;">rf12_crc</span> == 0 &amp;&amp; (<span style="color: #006699;">rf12_hdr</span> &amp; <span style="color: #006699;">RF12_HDR_CTL</span>) == 0)  <span style="color: #7E7E7E;">// and no rf errors</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">int</span> node_id = (<span style="color: #006699;">rf12_hdr</span> &amp; 0x1F);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">char</span> type = <span style="color: #006699;">rf12_data</span>[0];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (type==<span style="color: #006699;">'i'</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">int</span> target = <span style="color: #006699;">rf12_data</span>[1];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">int</span> newid = <span style="color: #006699;">rf12_data</span>[2];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (target==mynode) mynode = newid;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">rf12_initialize</span>(mynode, freq, group);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;
&nbsp;&nbsp;<span style="color: #7E7E7E;">//------------------------------------------------------------------</span>
&nbsp;&nbsp;<span style="color: #7E7E7E;">// Transmit data</span>
&nbsp;&nbsp;<span style="color: #7E7E7E;">//------------------------------------------------------------------</span>
&nbsp;&nbsp;emontx.type&nbsp;=&nbsp;<span style="color: #006699;">'d'</span>;
&nbsp;&nbsp;emontx.power1&nbsp;=&nbsp;520;
&nbsp;&nbsp;emontx.power2&nbsp;=&nbsp;1209;
&nbsp;&nbsp;emontx.power3&nbsp;=&nbsp;1000;
&nbsp;&nbsp;emontx.battery&nbsp;=&nbsp;3300;
&nbsp;&nbsp;
&nbsp;&nbsp;<span style="color: #CC6600;">if</span> ((<span style="color: #CC6600;">millis</span>()-timer)&gt;1000)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;timer&nbsp;=&nbsp;<span style="color: #CC6600;">millis</span>();
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">int</span> i = 0; <span style="color: #CC6600;">while</span> (!<span style="color: #CC6600;">rf12_canSend</span>() &amp;&amp; i&lt;10) {<span style="color: #CC6600;">rf12_recvDone</span>(); i++;}
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">rf12_sendStart</span>(0, &amp;emontx, sizeof emontx);
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">rf12_sendWait</span>(0);
&nbsp;&nbsp;}
}
</pre><h3>Base station code</h3>
<pre>
#include&nbsp;&lt;JeeLib.h&gt;

#define&nbsp;MYNODE&nbsp;20
#define&nbsp;freq&nbsp;<span style="color: #006699;">RF12_868MHZ</span>
#define&nbsp;group&nbsp;1&nbsp;

typedef&nbsp;struct&nbsp;{&nbsp;<span style="color: #CC6600;">char</span> type; <span style="color: #CC6600;">int</span> power1, power2, power3, battery; } PayloadTX;    
PayloadTX&nbsp;emontx;

<span style="color: #CC6600;">unsigned</span> <span style="color: #CC6600;">long</span> timer;

<span style="color: #7E7E7E;">//int&nbsp;idmap[30][1];</span>
<span style="color: #CC6600;">int</span> autoid = 1;

<span style="color: #CC6600;">char</span> instr[30];
<span style="color: #CC6600;">int</span> pos = 0;

<span style="color: #CC6600;">void</span> <span style="color: #CC6600;"><b>setup</b></span>()
{
&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">begin</span>(9600);
&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">println</span>(<span style="color: #006699;">&quot;Base&quot;</span>);
&nbsp;&nbsp;
&nbsp;&nbsp;<span style="color: #CC6600;">rf12_initialize</span>(MYNODE, freq, group);
}

<span style="color: #CC6600;">void</span> <span style="color: #CC6600;"><b>loop</b></span>()
{
&nbsp;&nbsp;<span style="color: #7E7E7E;">//------------------------------------------------------------------</span>
&nbsp;&nbsp;<span style="color: #7E7E7E;">// RX data</span>
&nbsp;&nbsp;<span style="color: #7E7E7E;">//------------------------------------------------------------------</span>
&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (<span style="color: #CC6600;">rf12_recvDone</span>())
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (<span style="color: #006699;">rf12_crc</span> == 0 &amp;&amp; (<span style="color: #006699;">rf12_hdr</span> &amp; <span style="color: #006699;">RF12_HDR_CTL</span>) == 0)  <span style="color: #7E7E7E;">// and no rf errors</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">int</span> node_id = (<span style="color: #006699;">rf12_hdr</span> &amp; 0x1F);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">char</span> type = <span style="color: #006699;">rf12_data</span>[0];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (node_id==1)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;autoid&nbsp;++;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">char</span> data[] = {<span style="color: #006699;">'i'</span>,1,autoid};
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">int</span> i = 0; <span style="color: #CC6600;">while</span> (!<span style="color: #CC6600;">rf12_canSend</span>() &amp;&amp; i&lt;10) {<span style="color: #CC6600;">rf12_recvDone</span>(); i++;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">rf12_sendStart</span>(0, data, sizeof data);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">rf12_sendWait</span>(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (type==<span style="color: #006699;">'d'</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">print</span>(<span style="color: #006699;">&quot;DATA: &quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">print</span>(node_id);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">print</span>(<span style="color: #006699;">&quot; &quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">byte</span> n = <span style="color: #006699;">rf12_len</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">for</span> (<span style="color: #CC6600;">byte</span> i=1; i&lt;n; i+=2)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">int</span> num = ((<span style="color: #CC6600;">unsigned</span> <span style="color: #CC6600;">char</span>)<span style="color: #006699;">rf12_data</span>[i+1] &lt;&lt; 8 | (<span style="color: #CC6600;">unsigned</span> <span style="color: #CC6600;">char</span>)<span style="color: #006699;">rf12_data</span>[i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;">if</span> (i&gt;1) <span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">print</span>(<span style="color: #006699;">&quot;,&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">print</span>(num);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #CC6600;"><b>Serial</b></span>.<span style="color: #CC6600;">println</span>();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}

}<br type="_moz" /></pre><p>It can be downloaded from github here:</p>
<p><a href="https://github.com/openenergymonitor/FirmwareDev/tree/master/01">https://github.com/openenergymonitor/FirmwareDev/tree/master/01</a></p>
<p>If your interested in the development of these features, would be great to hear what you think</p>
  <div class="forum-topic-navigation clear-block">
          <a href="1982.html" class="topic-previous" title="Go to previous forum topic">‹ How to use the API from a PHP script</a>
              <a href="1970.html" class="topic-next" title="Go to next forum topic">Last x hour average ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-5506"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1039.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mattwire&#039;s picture" title="mattwire&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/1039.html" title="View user profile.">mattwire</a> on Thu, 02/08/2012 - 14:54.</div>
    <div class="content">
     <p>Looks like a good idea.&nbsp; The main issue I can see at the moment is there is no way of defining what each datavalue is according to the above.&nbsp; So you either have to have fixed entries based on hardware type or guess.&nbsp; You also have the potential to increase the number of transmissions when you have multiple datatypes since I think you'd need one transmission for type d and another for type i.</p>
<p>How about expanding on this along the same lines so you have 3 entries per datapoint: TYPE, NAME, VALUE.&nbsp;</p>
<p>Then you send packets like this:</p>
<p>{'i',1,autoid,'d',235,'Vrms','d',397,'Power1'}</p>
<p>A slight increase on bytes but allows this to be passed directly through to emoncms with input names.</p>
<p>&nbsp;</p>
<p>Expanding a little further on this.&nbsp; Since a power saving is acheived by not transmitting floats temperatures are multiplied by 100 we could use a more detailed data type, either as a charactor or better as a series of defines in emonlib:&nbsp; For example:</p>
<p>EMON_TEMP: Temperature*100 (divide by 100 to get true value). Type:&nbsp;Int&nbsp;(-32,768 to 32,760). 32,761-32,767 are reserved for sensor error reporting (eg. 32767 = no reading from sensor).&nbsp; Maximum reading 320C (you might define a temperature with type long for things that must go higher like wood stoves).</p>
<p>EMON_POWER_KW:&nbsp;Power(KW)*100 (divide by 100 to get true value).&nbsp; Type unsigned Int&nbsp;(0-65528). 65529-65535 are reserved for sensor error reporting (eg. 65535 = no reading from sensor).&nbsp; Maximum reading 655.28KW.</p>
<p>EMON_VOLTAGE:&nbsp;Voltage (V)*100 (divide by 100 to get true value).&nbsp; Type unsigned Int&nbsp;(0-65528). 65529-65535 are reserved for sensor error reporting (eg. 65535 = no reading from sensor).&nbsp; Maximum reading 655.28V.</p>
<p>You then specify your RFM12 string:</p>
<p>{EMON_VOLTAGE, 235, 'Vrms', EMON_POWER_KW, 397, 'Power1'}</p>
<p>&nbsp;</p>
<p>This way any receiving device and emoncms has all the information it needs to use the data and if you include a node id in the string where it has come from too.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5508"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Pcunha&#039;s picture" title="Pcunha&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by Pcunha (not verified) on Thu, 02/08/2012 - 15:07.</div>
    <div class="content">
     <p>Yes, &nbsp;That's exactly what i have in mind.</p>
<p>I Have some points to consider:</p>
<p>- I Think we have to deal with ACK's. In my code i use them to reply status and pass returns back. I have read all the jeelabs documents about it, and i can say that the rfm code can be extended a little to provide a better solution (but thats not the point here)</p>
<p>- I like &quot;Keep it simple&quot; but like &quot;keep it single&quot; more. I dont like multiple small packages when we can pass one large package.&nbsp;</p>
<p>in my case i pass all the variables to the Emonbase using almost all bytes that the rfm can transmit. It can be a big battery problem (or not) i'm not shure, but it can be a problem with EU regulations too ( is that correct?). so it can be optimized. The EmonTX can have 2 methods of sending data: 1. All data collected (As in my case) or 2. Selective data (just total power by example).</p>
<p>- I Like Computer Browser Interfaces, so it's possible to use the emonbase as a bridge and use a Java/Javascript application to drive and configure all the stuff on the nodes. ( That's evil ).</p>
<p>-Compatibility for extensions: My main concern is be possible to do modifications without to brake all the software. Ex: i want to add a gas meter emonTx. I Can create a new code that will use all the features of the network without major problems, or i need to add a cummulative KWH variable (as i do) on the Emontx, without breaking all the comunications and CMS, etc.</p>
<p>Thanks a lot,</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5510"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/450.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/450.html" title="View user profile.">stuart</a> on Fri, 03/08/2012 - 12:30.</div>
    <div class="content">
     <p>Didn't I suggest doing something similar to this back in June?</p>
<p><a href="722.html" title="http://openenergymonitor.org/emon/node/722">http://openenergymonitor.org/emon/node/722</a></p>
<p>As the previous posts above, I think this would only be a good move if you also include the type of measurement and its unit of measurement - this way GLCD&nbsp;can automatically know that its a PV energy reading or a hot water temperature probe etc.</p>
<p>The GLCD would also need to combine several readings into potentially several screens/groups, you could have a couple of emonTx units sending data which are related to each other - do we need timestamps or a time sync broadcast message from the GLCD&nbsp;once in a while ?</p>
<p>&nbsp;</p>
<p>As someone who has personally designed and worked with these sorts of protocols in the past, please also include a version number in the packet somewhere to allow you to expand the format without breaking all the existing code!</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5526"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Sat, 04/08/2012 - 22:01.</div>
    <div class="content">
     <p>Thanks guys, so datatype definition needs to be a key feature. I wasnt sure weather datatypes should be sent each time or if there could be a way to send it the first time and not repeatedly, thinking that if we could avoid sending datatype and dataname data then we could keep packet size to a minimum.</p>
<p>But thinking about it, provoked by your ideas there with defines mattwire and I think its exactly what your proposing in the linked post stuart - sorry I didnt catch that earlier!, I can see that datatypes could be sent with each transmission with only a very small bit of extra weight.</p>
<p>If we used a definition list as you suggest stuart:&nbsp;</p>
<ul>
<li>0 = Power (Watts)</li>
<li>1 = Temperature&nbsp;<sup>o</sup>C</li>
<li>2 = Power (kW)</li>
<li>3 = Power (kW/hour)</li>
<li>4 = Volts (AC)</li>
<li>5 = Volts (DC)</li>
<li>6 = Current (AC)</li>
<li>7 = Current (DC)</li>
<li>8 = Lux (light)</li>
<li>9 = Frequency (hz)</li>
</ul>
<p>Then the datatype could be a single byte giving us 255 possible datatypes and that single byte could define everything we need to know such as:</p>
<ul>
<li>1 = ct1 realpower Watts, divide by 100, 2 byte integer</li>
</ul>
<p>the variable name in emoncms could be constructed from this such as node1.ct1.realpower</p>
<p>If the datatype was a single byte that came before its data bytes such as:&nbsp;</p>
<p>1 byte (datatype), data bytes, 1 byte (datatype), databytes...</p>
<p>Then the datatype byte can tell the deconstructor how many of the following bytes belong to the data..</p>
<p>..</p>
<p>Ok so as Im writing this I can see that the datatype byte is or can be the same as the packet type character I was suggesting above. But instead of only being the first one it can be as stacked as you suggest.</p>
<p>So a section of our 255 available datatypes could be commands such as set node id.. and another section may be actual datatypes such as Voltage..</p>
<p>Nice!</p>
<p>Can you see any problems with referring too all data and command type defenition in a single byte..?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5552"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Mon, 06/08/2012 - 18:19.</div>
    <div class="content">
     <p>I've had a go at writing a packet constructor and deconstructor for the&nbsp;1 byte (datatype), data bytes, 1 byte (datatype), databytes&nbsp;&nbsp;packet format idea, I think its looking good so far, I have put the code up on github here:&nbsp;<a href="https://github.com/openenergymonitor/FirmwareDev/blob/master/packet_builder/packet_builder.ino">https://github.com/openenergymonitor/FirmwareDev/blob/master/packet_builder/packet_builder.ino</a></p>
<p>Would be great to hear your thoughts.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5556"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/450.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/450.html" title="View user profile.">stuart</a> on Mon, 06/08/2012 - 18:26.</div>
    <div class="content">
     <p>A single byte might be limiting in the long run, but I also agree that keeping the packets small is important.</p>
<p>How about &quot;reserving&quot; a bit on the byte to indicate that this is a 2 byte data type and then the receiver can use that ?</p>
<p>You could also have some sort of broadcast &quot;here I am&quot; message when a node is first powered up (and perhaps every 100 packets or 10 mins) with this data in it if you didn't want to send this all the time - this might be a better way of doing things.</p>
<p>Additionally, I think you many need to include a description/definition of what you are trying to send back to base.</p>
<p>Its no good sending 10 temperature measurements from varios devices if you have no idea where the sensors are or what they are measuring !!</p>
<p>For instance:</p>
<ul>
<li>Outside temp</li>
<li>Top of water tank</li>
<li>Mains feed (cold)</li>
<li>Bottom of water tank</li>
<li>Ground source heat pump flow</li>
<li>Ground source heat pump return</li>
<li>etc. etc. etc.</li>
</ul>
<p>&nbsp;</p>
<p>Does the RFM12 device do hardware level checksum calculations? Do we need to bother with that ?</p>
<p>Think security/encryption of the data has also been mentioned in the past.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5561"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/380.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-380.jpg" alt="mharizanov&#039;s picture" title="mharizanov&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/380.html" title="View user profile.">mharizanov</a> on Mon, 06/08/2012 - 20:34.</div>
    <div class="content">
     <p>&nbsp;The RFM12packets include CRC checksum, no need to handle this additionally.</p>
<p>Encryption may be an overkill, but it is already available for those who need it, see examples here:</p>
<p>&nbsp;</p>
<p><a href="https://github.com/jcw/jeelib/blob/master/examples/RF12/crypSend/crypSend.ino">https://github.com/jcw/jeelib/blob/master/examples/RF12/crypSend/crypSend.ino</a></p>
<p><a href="https://github.com/jcw/jeelib/blob/master/examples/RF12/crypRecv/crypRecv.ino">https://github.com/jcw/jeelib/blob/master/examples/RF12/crypRecv/crypRecv.ino</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5562"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/380.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-380.jpg" alt="mharizanov&#039;s picture" title="mharizanov&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/380.html" title="View user profile.">mharizanov</a> on Mon, 06/08/2012 - 20:41.</div>
    <div class="content">
     <p>&nbsp;I also wanted to share some ideas for the auto node id assignment:</p>
<p>&nbsp;</p>
<p><span style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">1. The NanodeRF sends out a time packet every time it receives incoming one (this is so that the EmonGLCD is updated)</span></p>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">2. I suggest extend that packet with four more bytes that will represent 32 bits, each bit signifying weather the respective NodeID is taken of available (1 or 0). I call that Node Allocation Table. It will be stored in NanodeRF's EEPROM so that it is permanent.</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">3. The NanodeRF will maintain that table based on the incoming transmissions it receives i.e. if it receives a package from node 10, it will set bit 10 of the Node Allocation Table to 1</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">4. The NanodeRF will keep track of the last time the node with that ID was transmitting, so that it knows if the Node is alive or not when eventually it runs out ot Node Allocations. Then Any NodeID that hasn't been live for lets say a month will be released.</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">5. New sensor nodes when run for the first time will assign themself a dummy system ID, lets say 31. The will send an empty packet and await response with Node Allocation Table the next couple seconds, and if no such is received will fall in sleep for at least 15 minutes, then wake up to repeat the query.</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">6. Eventually the new node will receive a Node Allocation Table and will pick an available bit (randomly to minimize risk of two nodes picking same id when powered up at the same time). To reserve it, it will send a dummy packet with that newly picked NodeID, will use ACK for that. Once ACK is received, the node ID can be stored in sensor's EEPROM and used from now on. The firmware can now perform its routine tasks to collect and send data.</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">&nbsp;</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">&nbsp;</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">Also, I don't like very much the idea of the packet containing &quot;instructions&quot; regarding its contents. This is a limitation that I personally will not like. I rather think that the correct approach would be to do sensor configuration on the receiving end i.e. in emonCMS thru some UI that specifies what that node is sending. The PHP &quot;pack&quot; function has some pretty good formatting options that can be used as a starting point. You can name the node, add some description to the raw values it sends, but that belongs to emonCMS, not in the data packet.</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">&nbsp;</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">Trystan has already done great work on multinode firmware for emonTX, it captures raw RFM packets and forwards to emoncms where further processing is done. This way emonBase doesn't even know what it is sending, it is just a pass-thru. Advantage is that you don't need to flash new firmware every time you add a new remote sensor.</div>
<div style="color: rgb(34, 34, 34); font-family: arial, sans-serif; font-size: 13px; ">&nbsp;</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5571"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/450.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/450.html" title="View user profile.">stuart</a> on Tue, 07/08/2012 - 11:53.</div>
    <div class="content">
     <p>mharizanov, think you might be taking a slightly different approach to what I was originally suggesting.</p>
<p>Thoughts so far:</p>
<p>1. Why does a node id matter at all ?&nbsp; Why not broadcast every packet ?</p>
<p>2. You could have several devices transmitting data for a grouped set of readings (e.g. solar pv, current, temperature, voltage, power levels etc.) so don't think that a single node will be sending all those readings together in a single packet or even same time span!</p>
<p>3. If the data packets are self describing then no changes are needed to GLCD or emonCMS to handle the packet</p>
<p>4. Not everybody want's or uses emonCMS - its an extra expense to host/power that some people won't want</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5697"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/859.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Drsdre&#039;s picture" title="Drsdre&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/859.html" title="View user profile.">Drsdre</a> on Tue, 14/08/2012 - 06:51.</div>
    <div class="content">
     <p>How about not only making the EmonTX nodes plug and play, but also the inputs. Auto detect if a CT, pulse or temperature probe has been connected to the EmonTX and automatically start sending data.</p>
<ul>
<li>Checking the CT's should probably be a routine to check if usage (power &gt; 0?) is detected.</li>
<li>For pulse the same power check should suffice.</li>
<li>For temperature probes a software interrupt based scan could be executed for example every minute. Found probes are to be processed in the normal loop.</li>
<li>Jeelabs probes are not standardized yet, so should probably not be taken into account.</li>
</ul>
<p>I'm going to have a try to combine above with the FirmwareDev packet routines.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5710"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/450.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by <a href="../user/450.html" title="View user profile.">stuart</a> on Tue, 14/08/2012 - 11:29.</div>
    <div class="content">
     <p>Probably worth doing this on startup only to avoid the overhead.&nbsp; Add the new sensor and simply reset the emonTx and it discovers it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6779"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="gurjeet&#039;s picture" title="gurjeet&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by gurjeet (not verified) on Fri, 19/10/2012 - 06:47.</div>
    <div class="content">
     <p>You could have several devices transmitting data for a grouped set of readings (e.g. solar pv, current, temperature, voltage, power levels etc.) so don&#39;t think that a single node will be sending all those readings together in a single packet or even same time span! <a href="http://gurjeetguri.blogspot.com/" title="http://gurjeetguri.blogspot.com">http://gurjeetguri.blogspot.com</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9464"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="o_cee&#039;s picture" title="o_cee&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Dev: Plug and play sensor nodes</h3>

    <div class="submitted">Submitted by o_cee (not verified) on Mon, 28/01/2013 - 13:44.</div>
    <div class="content">
     <p>Any progress with this?</p>
<p>Did you see JeeLabs recent thoughts on the same issue?<br />
	<a href="http://jeelabs.org/2013/01/14/remote-node-discovery/">http://jeelabs.org/2013/01/14/remote-node-discovery/</a></p>
<p><a href="http://jeelabs.org/2013/01/15/remote-node-discovery-part-2/">http://jeelabs.org/2013/01/15/remote-node-discovery-part-2/</a></p>
<p><a href="http://jeelabs.org/2013/01/16/remote-node-discovery-code/">http://jeelabs.org/2013/01/16/remote-node-discovery-code/</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/904"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-CZM-tfFFXkwu9uGDkP91ns03W0pqq_3fFKTdaJqKSVI" value="form-CZM-tfFFXkwu9uGDkP91ns03W0pqq_3fFKTdaJqKSVI"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
