<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2761 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:08:34 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Using 2 emontx with emonglcd for solar pv | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Using 2 emontx with emonglcd for solar pv</h3>
        <span class="submitted">Submitted by <a href="../user/4215.html" title="View user profile.">noworries</a> on Mon, 02/09/2013 - 16:35</span>
        <div class="content"><p>It looks like I have managed to get emoncms&nbsp;reading correctly using 1 emontx&nbsp;for grid with AC AC adaptor (emontx123voltage) and 1 emontx&nbsp;for solar (emontx123).</p>
<p>I cant work our how to get the emonglcd to look at both emontx&#39;s and then tell it to use the correct feed? I am using the solarPV firmware as a starting point?</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2765.html" class="topic-previous" title="Go to previous forum topic">‹ Arduino energy monitor - Consumption per hour</a>
              <a href="2759.html" class="topic-next" title="Go to next forum topic">emoncms global event module ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-14779"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using 2 emontx with emonglcd for solar pv</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 02/09/2013 - 23:39.</div>
    <div class="content">
     <p>You need to look at the part of the code where having received the RFM12B message, it is decoded. You must duplicate that, i.e. you need two &quot;if (node_id == emonTx_nodeID) { .... }&nbsp; using the two node IDs for your two emonTx&#39;s. That will give you two sets of data, one from each emonTx, which you can then use however you wish.</p>
<p>(The best way to get the data is to have two PayloadTX&#39;s, emontx1 &amp; emontx2).</p>
<p>I can go into more detail if you can&#39;t figure it out from there.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14783"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4215.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="noworries&#039;s picture" title="noworries&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using 2 emontx with emonglcd for solar pv</h3>

    <div class="submitted">Submitted by <a href="../user/4215.html" title="View user profile.">noworries</a> on Tue, 03/09/2013 - 07:04.</div>
    <div class="content">
     <p>Cheers Robert, new it would be something like that.</p>
<p>Could you elaborate on the payloadtx bit? i am very new arduino so am still working it all out.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14800"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using 2 emontx with emonglcd for solar pv</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 03/09/2013 - 12:02.</div>
    <div class="content">
     <p>PayloadTX is a <strong>struct</strong>ure. It behaves in some respects like an int or a float, so having defined the structure, you create an instance of it:</p>
<p class="rteindent1">PayloadTx emontx;</p>
<p>that&#39;s syntactically identical to writing</p>
<p class="rteindent1">double realPower;</p>
<p>Hence you can have as many as you like (two is enough!) with</p>
<p class="rteindent1">PayloadTx emontx1, emontx2;</p>
<p>The struct is nothing more than a container. You access the individual parts like:</p>
<p class="rteindent1">emontx1.realPower = something;<br />
	emontx2.realPower = something_different;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14805"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4215.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="noworries&#039;s picture" title="noworries&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using 2 emontx with emonglcd for solar pv</h3>

    <div class="submitted">Submitted by <a href="../user/4215.html" title="View user profile.">noworries</a> on Tue, 03/09/2013 - 12:44.</div>
    <div class="content">
     <p>Cheers robert.</p>
<p>A fair amount of guess work but i got it right first time...</p>
<p>Just need to sort the time and base error now.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14817"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using 2 emontx with emonglcd for solar pv</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Tue, 03/09/2013 - 16:29.</div>
    <div class="content">
     <p>Hi Ian,&nbsp;</p>
<p>Just composed an email to you before I read that you&#39;ve got it figured. Good work. Anyway for what it&#39;s worth here&#39;s what I wrote:</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Hi Ian,</p>
<p>Great to hear that you have got the units running and have figured out the firmware upload process.</p>
<p>I would highly recommend you run both emonTx&#39;s with an AC adapter and emonTx CT123 Voltage firmware as the solar inverter will have a less than unit power factor which will cause an emonTx without AC adapter measuring apparent power to over read.</p>
<p>What you need to do is to set the Node ID&#39;s on the two emonTx&#39;s to be different. The default node ID on the emonTx is 10. Both of your emonTx&#39;s are set to node 10. You need to set one to be different, let&#39;s go for 9 as we recomend the following nomenclature for node ID&#39;s<br />
	:</p>
<p>-ID-&nbsp;&nbsp;&nbsp; -Node Type-<br />
	0&nbsp;&nbsp; - Special allocation in JeeLib RFM12 driver - reserved for OOK use<br />
	1-4&nbsp;&nbsp;&nbsp;&nbsp; - Control nodes<br />
	5-10&nbsp; - Energy monitoring nodes<br />
	11-14&nbsp; --Un-assigned --<br />
	15-16&nbsp;&nbsp; - Base Station &amp; logging nodes<br />
	17-30&nbsp;&nbsp;&nbsp;&nbsp; - Environmental sensing nodes (temperature humidity etc.)<br />
	31&nbsp;&nbsp;&nbsp;&nbsp; - Special allocation in JeeLib RFM12 driver - Node31 can communicate with nodes on any network group</p>
<p>
	To do this open the emonTx CT_123_voltage firmware and change the following on line 48</p>
<p><em>const int nodeID = 9;</em></p>
<p>Now we need to tell the emonGLCD to treat data coming from CT1 on emonTx node 9 as solar PV generation and data from CT1 on emonTx Node ID 10 as grid/import export (assuming your system is solar PV type 2 as you suggested to me). Do do this edit&nbsp; emonGLCD solar PV sketch. We first need to create a new payload for the second emonTx, insert a line to detect an RF packet from the new emonTx and map it to emonTx9.powerX then replace all instances of emonTx.power2 (originally CT2 of emonTx with node ID 10) to emonTx9.power1 (coming from CT1 of emonTx node ID 9).</p>
<p>New structure :</p>
<p>typedef struct { int power1, power2, power3, Vrms; } PayloadTX9;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // neat way of packaging data for RF comms<br />
	PayloadTX9 emontx9;</p>
<p>Detect packets from emonTx 9:<br />
	<em>&nbsp; if (rf12_recvDone())<br />
	&nbsp; {<br />
	&nbsp;&nbsp;&nbsp; if (rf12_crc == 0 &amp;&amp; (rf12_hdr &amp; RF12_HDR_CTL) == 0)&nbsp; // and no rf errors<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int node_id = (rf12_hdr &amp; 0x1F);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (node_id == 10) {emontx = *(PayloadTX*) rf12_data; last_emontx = millis();}<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (node_id == 9) {emontx9 = *(PayloadTX9*) rf12_data; last_emontx9 = millis();}<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (node_id == 15)<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RTC.adjust(DateTime(2013, 1, 1, rf12_data[1], rf12_data[2], rf12_data[3]));<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; last_emonbase = millis();<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp; }</em></p>
<p>replace all instances of emonTx.powe1 with emontx9.power2:</p>
<p><em>if (SolarPV_type==2){<br />
	&nbsp;&nbsp;&nbsp; usekwh += ((emontx.power1 + emontx9.power1) * 0.2) / 3600000;<br />
	&nbsp;&nbsp;&nbsp; genkwh += (emontx9.power1 * 0.2) / 3600000;<br />
	&nbsp;&nbsp;&nbsp; }</em></p>
<p>
	See attached for changes implemented in emonGLCD sketch.</p>
<p>Maybe sure you are using the latest emonTx_CT123_voltage code from github. I updated the calibration a couple of days ago when testing your units.</p>
<p>&nbsp;</p>
<p>Best of luck,&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14818"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using 2 emontx with emonglcd for solar pv</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 03/09/2013 - 16:47.</div>
    <div class="content">
     <p>What happens if the two RF messages appear at the same time?</p>
<p>Or is the chances of this happening minimal?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2761"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-CfzFaZyZfzWf7ZPmTELDgtEarYVYvsHUGUbbDpaxoE8" value="form-CfzFaZyZfzWf7ZPmTELDgtEarYVYvsHUGUbbDpaxoE8"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/2761 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:08:34 GMT -->
</html>
