<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/12168 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:48:40 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Getting data from Blueline Wifi Powercost monitor into EmonCMS | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Getting data from Blueline Wifi Powercost monitor into EmonCMS</h3>
        <span class="submitted">Submitted by <a href="../user/9467.html" title="View user profile.">mattncsu</a> on Sat, 13/02/2016 - 04:58</span>
        <div class="content"><p>I have the Blueline Wifi Powercost monitor (<a href="http://www.amazon.com/Blue-Line-Innovations-BLI-32000/dp/B00EU7NUP6" title="http://www.amazon.com/Blue-Line-Innovations-BLI-32000/dp/B00EU7NUP6">http://www.amazon.com/Blue-Line-Innovations-BLI-32000/dp/B00EU7NUP6</a>) watching the disc spinning on my meter and reporting my power usage. I&#39;m not sure if Blueline&#39;s cloud is down or not because my data isn&#39;t showing up on their site, doesn&#39;t really matter because I&#39;d rather have it on EmonCMS anyway. Using Wireshark, I found that every 32 seconds, the monitor is broadcasting a UDP packet with the following data:</p>
<pre>
msgtype=PCMWiFi;
DeviceID=XXXXXXXXXXXX;
Inst=1959;
Reg=13387987;
Temp=31;
BattLow=0;
SQI=66;
uTime=1369834215;
msgtype=PCMWiFi;
DeviceID=XXXXXXXXXXXX;
Inst=1943;
Reg=13388003;
Temp=31;
BattLow=0;
SQI=66;
uTime=1369834246;</pre><p>
msgtype is a constant. DeviceID is the mac address of the unit. Inst is instantaneous Watts. Reg is the Total consumption since last reset/sync. Temp is the temperature in degrees C. BattLow will show 1 when the sensor battery is low, otherwise it is 0. SQI is the signal quality indicator of the wifi unit receiving the signal from the monitor/sensor. It is a percentage. uTime is unix time.</p>
<p>Can anyone recommend a quick and dirty way to get the data into EmonCMS? I found some code on github (<a href="https://github.com/DCandE/PCMWiFi">https://github.com/DCandE/PCMWiFi</a>) that appears to sniff the data and display it on the screen using a Processing.org program. I might be able to adapt that, but I&#39;ve never used Processing, and was wondering if there was already a wheel out there or if I needed to invent one.</p>
<p>The machine that will do the packet capture and posting is running Windows 7. I&#39;m open to installing Cygwin on it, but have to keep it running Windows because it is also pulling and posting data from my weather station and the driver only works in Windows.</p>
<p>Thanks,</p>
<p>Matt</p>
  <div class="forum-topic-navigation clear-block">
          <a href="12175.html" class="topic-previous" title="Go to previous forum topic">‹ My Electric, 9.31</a>
              <a href="12167.html" class="topic-next" title="Go to next forum topic">emonhub: &quot;Device communication error - check settings&quot; ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-39389"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Getting data from Blueline Wifi Powercost monitor into EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 13/02/2016 - 21:58.</div>
    <div class="content">
     <p>I actually do something very similar, except I do my monitor-to-cloud relaying on a unix machine and my energy monitor is completely different from yours, although it too does UDP broadcasts of its data. &nbsp;I suspect the correct way to solve it is via some sort of plug-in for emonhub, but I don&#39;t know enough about emonhub to guide you any further there. &nbsp;My setup pre-dates emonhub and migrating&nbsp;my relay process from a bespoke one to emonhub has long been on my list of things to research, but never seems to get anywhere near the top.</p>
<p>My bespoke code won&#39;t be much use to you because we have different energy monitors, but I guess the basic principles apply. &nbsp;I also take advantage of the various unix&nbsp;tools to make the job a bit easier and I&#39;ve no idea what&#39;s available on Windows. &nbsp;But, for what it&#39;s worth:</p>
<p>I launch the relay with:</p>
<pre>
socat -u udp-recv:8878 - | /bin/erm_cloud_relayd -p -c20 -v258 -w | \
ts %F-%H:%M:%.S &gt;&gt; /var/www/erm_log.txt &amp;</pre><p>socat takes care of the network listening stuff for me, and my erm_cloud_relay simply processes strings from the energy monitor via&nbsp;standard input (handy for testing it with pre-recorded monitor output as well).</p>
<p>The gist of erm_cloud_relayd is to parse the various incoming strings (mine are completely different from yours):</p>
<pre>
&nbsp; &nbsp;&nbsp;
&nbsp; &nbsp; switch (erm_str[11]) {
&nbsp; &nbsp; case &#39;E&#39;:
&nbsp; &nbsp; case &#39;F&#39;:
&nbsp; &nbsp; case &#39;G&#39;:
&nbsp; &nbsp; &nbsp; if (sscanf(&amp;erm_str[12], &quot;%d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d
 %d %d %d %d\n&quot;,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &amp;V_rms, &amp;V_freq,
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &amp;real_energy[0], &amp;react_energy[0], &amp;I_rms[0],
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &amp;real_energy[1], &amp;react_energy[1], &amp;I_rms[1],
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &amp;real_energy[2], &amp;react_energy[2], &amp;I_rms[2],
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &amp;real_energy[3], &amp;react_energy[3], &amp;I_rms[3],
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &amp;real_energy[4], &amp;react_energy[4], &amp;I_rms[4],
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &amp;real_energy[5], &amp;react_energy[5], &amp;I_rms[5]) == 20) {</pre><p>do any pre-processing I want to do on the data, and then at some stage post it to emoncms&nbsp;via libcurl:</p>
<pre>
    snprintf(post_message, sizeof(post_message), 
         &quot;http://emoncms.org/input/post?node=%d&amp;csv=&quot;
         &quot;%d,%d,&quot;
         &quot;%d,%d,%d,&quot;
         &quot;%d,%d,%d,&quot;
         &quot;%d,%d,%d,&quot;
         &quot;%d,%d,%d,&quot;
         &quot;%d,%d,%d,&quot;
         &quot;%d,%d,%d&quot;
         &quot;&amp;apikey=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;,
         node, V_rms, V_freq,
         real_energy[0], react_energy[0], I_rms[0],
         real_energy[1], react_energy[1], I_rms[1],
         real_energy[2], react_energy[2], I_rms[2],
         real_energy[3], react_energy[3], I_rms[3],
         real_energy[4], react_energy[4], I_rms[4],
         real_energy[5], react_energy[5], I_rms[5]);

    if (debugging_posts) printf(&quot;%s%s\n&quot;, post_message, (curl) ? &quot; *&quot; : &quot;&quot;);
    if (curl) {
      curl_easy_setopt(curl, CURLOPT_URL, post_message);
      res = curl_easy_perform(curl);
    }</pre><p><em>Edit - wrapped long lines - Moderator, BT</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39390"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Getting data from Blueline Wifi Powercost monitor into EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 13/02/2016 - 22:13.</div>
    <div class="content">
     <p>I checked out the pointer to your energy monitor. &nbsp;Have you tried their appliance-recognition stuff? &nbsp;I&#39;m blown away that they can do that solely by looking at LED pulses from the meter. &nbsp;I&#39;ve always assumed you need huge amounts of detail (current harmonics etc) to have a reasonable chance at that. &nbsp;Do you know if theirs works well?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39402"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9467.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mattncsu&#039;s picture" title="mattncsu&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Getting data from Blueline Wifi Powercost monitor into EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/9467.html" title="View user profile.">mattncsu</a> on Sun, 14/02/2016 - 01:40.</div>
    <div class="content">
     <p>Got something working with Processing and figured I would share it here in case it helps anyone else along the way. Probably not the most elegant thing but its my first program since Intro to Fortran back in college.</p>
<p><img alt="" src="../sites/default/files/EnergyMonitor.png" style="width: 258px; height: 176px; float: left; border-width: 2px; border-style: solid; margin: 2px;" /></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>-----------------------------</p>
<pre>
import hypermedia.net.*;
import java.text.SimpleDateFormat;
PFont small, big;
int PORT_RX=30278;
String HOST_IP = &quot;192.168.1.90&quot;;//IP Address of the PC in which this App is running
UDP udp;//Create UDP object for recieving
String wh=&quot;&quot;;
float temp=0.0;
long timestamp=0;
String timestring=&quot;&quot;;
String Response;
String emonlink=&quot;http://emoncms.org/app?apikey=&lt;read key&gt;#myelectric&quot;;
int battery=0;

void setup(){
  size(250,150);
  surface.setTitle(&quot;Energy Monitor&quot;);
  small = createFont(&quot;sansSerif&quot;,14);
  big = createFont(&quot;sansSerif&quot;,32);
  udp= new UDP(this, PORT_RX, HOST_IP);
  udp.log(true);
  udp.listen(true);
  noLoop();
}

void mousePressed() {
  link(emonlink); //Open EmonCMS page when clicked
}

void draw(){
    textFont(big);

background(0);
fill(255);
text(&quot;Power=&quot;+wh+&quot;W&quot;, 5, 30);
text(&quot;Temp=&quot;+truncate(temp)+&quot;&deg;F&quot;, 5, 60);
if(battery == 1) { //Show battery warning
  fill(255,0,0);
  text(&quot;BAT&quot;,190,60);
}
fill(255);
textFont(small);
text(&quot;Last Updated &quot;+timestring, 10, 90);
text(&quot;Result &quot;+Response,10,110);
textSize(10);
text(&quot;http://emoncms.org/app?apikey=&lt;key 1/2&gt;&quot;,10,120);
text(&quot;&lt;key 2/2&gt;#myelectric&quot;,10,130);
}//end of draw()

float truncate( float x ) {
    return round( x * 100.0f ) / 100.0f;
}

void receive(byte[] data){//, String HOST_IP, int PORT_RX){
  String value=new String(data);
  println(value);
  String[] power = splitTokens(value,&quot;=; &quot;);
  String url=&quot;http://emoncms.org/input/post.json?time=&quot;+power[15]+&quot;&amp;node=0&amp;csv=&quot;+
power[5]+&quot;,&quot;+power[7]+&quot;,&quot;+power[9]+&quot;,&quot;+power[11]+&quot;,&quot;+power[13]+&quot;&amp;apikey=&lt;read/write key&gt;&quot;;
  println(url);
  String response[]=loadStrings(url);
 Response=response[0];
  println(Response);
  text(&quot;Power=&quot;+power[5], 10, 30);
  wh=power[5];
  temp=int(power[9])*1.8+32;
  timestamp = int(power[15]);
  //create new date format
  SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd&#39;T&#39;hh:mm:ss&#39;Z&#39;&quot;); 
  timestring = format.format(timestamp*1000);
  battery=int(power[11]);
 redraw();
}</pre><p><em>Edit - wrapped long lines - Moderator, BT</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39405"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9467.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mattncsu&#039;s picture" title="mattncsu&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Getting data from Blueline Wifi Powercost monitor into EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/9467.html" title="View user profile.">mattncsu</a> on Sun, 14/02/2016 - 06:19.</div>
    <div class="content">
     <p>The appliance mode just temporarily zeroes the display so you can more easily see the power spike from whatever appliance you are running. The sender on the meter only sends a signal every 32 seconds so good luck holding everything else constant in your house long enough to get a reliable reading.</p>
<p>You can see the furnace (gas) coming on and off and some time spent in the wood shop running various tools.&nbsp; Still need to learn about configuring inputs and feeds. As of now it seems my kWh under &quot;USE TODAY&quot; is off but I&#39;m sure once I find some tutorials or something I&#39;ll figure it out.</p>
<p><img alt="" height="298" src="../sites/default/files/blueline4.png" width="595" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/12168"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-0HHHJ8J7gzYFPHhG3a6F0TALtvSpV6d_iD4ePAunIiM" value="form-0HHHJ8J7gzYFPHhG3a6F0TALtvSpV6d_iD4ePAunIiM"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
