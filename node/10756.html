<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10756 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:21:03 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>MAX and MIN value feeds frozing whole EMONCMS | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">MAX and MIN value feeds frozing whole EMONCMS</h3>
        <span class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Tue, 26/05/2015 - 18:52</span>
        <div class="content"><p>Guys, I have a strange issue now. I have installed last EMONCMS 8.5 to VPS based on Debian 8 folowing step by step tutorial &quot;Install Emoncms v8 on Ubuntu / Debian Linux&quot;. Everything works as expected with one exception.&nbsp;When I create even one&nbsp;MAX or MIN daily value feed (based on phptimeseries), ALL&nbsp;inputs and feeds are frozen and there is not update of their values.&nbsp;When I delete these MAX/MIN feeds, updating values is again working. What can be wrong and where? And how to fix it?</p>
<p>Radek</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10786.html" class="topic-previous" title="Go to previous forum topic">‹ logging future values?</a>
              <a href="10783.html" class="topic-next" title="Go to next forum topic">Lost feed logging/visualisation ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-30781"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sat, 30/05/2015 - 08:36.</div>
    <div class="content">
     <p>Radek&nbsp;</p>
<p><span style="line-height: 20.7999992370605px;">I&#39;m not&nbsp;really&nbsp;clued&nbsp;up enough to help in any depth but in the absence of those that can I thought it was at least&nbsp;worth you exploring the suggestions in the&nbsp;error message&nbsp;</span>mentioned in your&nbsp;<a href="5744.html#comment-30762">comments in the &quot;EMONCMS: Allow New Input processes Feeds in MySQL engine as option from UI&quot; thread</a></p>
<p>It would seem clearing the browser cache plays a part so have you tried switching to v8.4.0 and clearing the cache? if it is still an issue try &quot;git&nbsp;checkout v8.3.6&quot; from the emoncms folder to revert back to a known good version.</p>
<p>
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30783"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5908.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rbreuss&#039;s picture" title="rbreuss&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Sat, 30/05/2015 - 08:53.</div>
    <div class="content">
     <p>Paul, I think, I recognized potential issue. I have compared my working installation 8.0.8 with freezing 8.5 and I found difference in MAX / MIN function declaration. Look at /Modules/input/process_model.php and there is around row 550 definition of MAX and later MIN function. difference is in rows:</p>
<p>$feedtime = $this-&gt;getstartday($time_now);</p>
<p>$time_check = $this-&gt;getstartday($last_time);</p>
<p>In old version 8.0.8 are $feedtime and $time_check declared another way:</p>
<p>$feedtime = mktime(0, 0, 0, date(&quot;m&quot;,$time_now), date(&quot;d&quot;,$time_now), date(&quot;Y&quot;,$time_now));</p>
<p>$time_check = mktime(0, 0, 0, date(&quot;m&quot;,$last_time), date(&quot;d&quot;,$last_time), date(&quot;Y&quot;,$last_time));</p>
<p>When I use that old version, input and feed are not frozing now, when I create MAX or MIN feed. I think, that problem could be in definition of private function getstartday at the end of this file, but my knowledge of php is not strong enough to localize what exactly is wrong. So now Im testing 8.5 with old definition of MAX and MIN functions and we will see, how it works. But at least it&nbsp;is&nbsp;not freezing now.</p>
<p>Radek</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30784"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sat, 30/05/2015 - 11:48.</div>
    <div class="content">
     <p>Looking at github&nbsp;those changes have been in place since the <a href="https://github.com/emoncms/emoncms/blob/8.2/Modules/input/process_model.php#L611-L616">getstartday() function was added&nbsp;for&nbsp;improved&nbsp;timezone&nbsp;support&nbsp;in May2014&nbsp;(v8.2</a>) so it&#39;s not likely to be that directly, however, March this year the&nbsp;getstartday() function was edited&nbsp;for the <a href="https://github.com/emoncms/emoncms/commit/ee2bf29b011b566cbe592a97815a07c4a3cf8b22?diff=unified#diff-61102ea5f198b440603234fbc9465ac5L798">&quot;Fix all Timezone issues. Plus merging with latest and minor bug fixing.&quot;</a>&nbsp;so I suspect that may be closer to the root of the issue since those functions <u>do</u> work in v8.3.6 (emoncms.org current version).</p>
<p>But those changes are only present in v8.5 and extended so v8.4 should be ok, therefore my suggestion above still stand&nbsp;to determine if the issue is present in v8.4 or not.</p>
<p>Among the changes in the latest timezone revisions the way the offset is defined was changed and you may well find reselecting&nbsp;(select another and then change back) might help if you have carried over your settings from a v8.4 or earlier version. ( I assume you have backed up prior to starting the upgrades if not you probally should)</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30786"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5908.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rbreuss&#039;s picture" title="rbreuss&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Sat, 30/05/2015 - 12:51.</div>
    <div class="content">
     <p>As I have new installation without historical data at my new VPS, I can try various scenarios without&nbsp;any worries. So now, I switched back to 8.4.0 and process_model.php file is now without modifications (getstartday() function acting). I cleared browser cache and restarted Apache. Created MAX and MIN feeds and it <u>works</u>. Now I will go forward again to 8.5 and to 8.5.1 XT and we will see, when that issue is going to&nbsp;appear&nbsp;(I hope :-)). At least we have a&nbsp;reference point now.&nbsp;Stay tuned.</p>
<p>Radek</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30787"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5908.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rbreuss&#039;s picture" title="rbreuss&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Sat, 30/05/2015 - 13:06.</div>
    <div class="content">
     <p>Seems to be clear, Paul. Im switching between 8.4.0 (master) and 8.5.0 (v8.5). Clearing browser cache each time. No other changes. With 8.4 I can create MAX and MIN value and everything works fine. With 8.5, or MAX/MIN feeds created before in 8.4, or created now in 8.5, are freezing input update of ALL inputs/feeds. Only way how to keep&nbsp;MAX/MIN feeds alive under 8.5 is to modify process_model.php as described in above. Probably some bug between these two versions.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30837"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Mon, 01/06/2015 - 16:42.</div>
    <div class="content">
     <p>For current 8.5+, replace :</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; $last_time = strtotime($last[&#39;time&#39;]);</p>
<p>With :</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; $last_time = $last[&#39;time&#39;];</p>
<p>on the /Modules/input/process_model.php arrounf lines 610 and 619, if it works i will make a fix later as it&#39;s bad in other place.s</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30838"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5908.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rbreuss&#039;s picture" title="rbreuss&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Mon, 01/06/2015 - 19:54.</div>
    <div class="content">
     <p>I confirm chaveiro, it works and MAX/MIN feeds are no freezing EMONCMS 8.5.1 XT more. But, there is another issue - Im unable to create Multigraph in 8.5.1 XT (there si no selection of feeds for multigraph available). It works in 8.4 and in 8.5, but not in 8.5.1 XT</p>
<p>Radek</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30846"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Tue, 02/06/2015 - 09:14.</div>
    <div class="content">
     <p>Digging into this a bit more. The feed last times are currently saved as date strings in redis. The set_timevalue method converts unix time to date string and then after the get_timevalue is called the last time is usually converted back to unix time with strtotime(). This is a non ideal remnant of an earlier version of emoncms in which I wanted the meta data to be human readable in the mysql database.</p>
<p>The error with the min/max processes appear to be being caused by trying to call get_timevalue when the feed has no last value, i.e when the feed has just been created it has no last value, rather than returning a date string $last[&#39;time&#39;] is just an empty string &quot;&quot;.</p>
<p>I&#39;ve added a fix to emoncms v8.5 where it now checks for this condition after the line:</p>
<p>$last_time = strtotime($last[&#39;time&#39;]);<br />
if ($last[&#39;time&#39;]==&quot;&quot;) $last_time = 0;</p>
<p>This fixes the problem for me and I&#39;ve pushed this fix up to the v8.5 branch.</p>
<p>I have already removed the use of a date string for storing the last time in the low-write branch of emoncms, Im not sure why I didnt implement the same change in emoncms v8.5. I will look into it.<br />
&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30856"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Tue, 02/06/2015 - 15:33.</div>
    <div class="content">
     <p>I&#39;ve update emoncms v8.5 to use unix time instead of date strings for last time value and the latest update includes a bit of code that will convert existing last time meta data over from date string to unix time.</p>
<p>I&#39;ve tested: log_to_feed, power_to_kwh, power_to_kwhd, kwh_to_kwhd, wh_accumulator, max, min, allow positive and allow negative. All appear to be working ok.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30866"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5908.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rbreuss&#039;s picture" title="rbreuss&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/5908.html" title="View user profile.">rbreuss</a> on Tue, 02/06/2015 - 19:42.</div>
    <div class="content">
     <p>Trystan, I can confirm, that after pulling updated 8.5 it works fine (MAX/MIN feeds), Thanks for fixing this unpleasant bug!</p>
<p>Radek</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30882"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: MAX and MIN value feeds frozing whole EMONCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Wed, 03/06/2015 - 00:24.</div>
    <div class="content">
     <p>Fixed on XT, merge waiting.</p>
<p>Can work now with mysql engine also if active on config.</p>
<p>Refactored some code from 8.5 -&gt; Instead of if (!is_numeric($lastvalue[&#39;time&#39;])) in feed_model.php i fixed the reason it may not be.<br />
Also some minor fix on getstartday function on process_model.php</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10756"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-rj__A5i9xMWQcLvX8udikYf2Di3K2jaKLetsalh7jAU" value="form-rj__A5i9xMWQcLvX8udikYf2Di3K2jaKLetsalh7jAU"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/10756 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:21:03 GMT -->
</html>
