<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/5288 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:30 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Alignment / sychronisation of feeds with the timestamps | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Alignment / sychronisation of feeds with the timestamps</h3>
        <span class="submitted">Submitted by <a href="../user/5146.html" title="View user profile.">franknfurther</a> on Mon, 09/06/2014 - 20:01</span>
        <div class="content"><p>Hi,</p>
<p>I am getting my consumption and production data from 2 totally different&nbsp;meters and I am uploading both every 10 seconds to emonCMS. The data upload works fine, however, I just noticed when I was doing simple deductions of the time series of one meter from the other, that the timestamps are not aligned / synchronised. This apparently means that the data of one feed is up to one minute ahead or behind of the other, which means that I get garbage if I do calculations of the feeds.</p>
<p>Or, it could be that the one meter actually sends delayed data to my gateway forwarder. In this case I would like to be able to build in a delay somewhere in the data chain to compensate for that. Where could I best do that?</p>
<p>The 2 timestamps of the two buffers at the time of upload are however nearly identical. e.g. 1402340609.</p>
<p>Does anyone know how the timestamps work, what do they tell me, how are timestamps&nbsp;stored in emonCMS (are they created when data is received or does emonCMS use the timestamps&nbsp;hat I send along with the data)? &nbsp;How could I manage the lag that seems to be ocurring? Furthermore, how do you convert them to actual time in Excel format?</p>
<p>Any answers are much appreciated.</p>
<p>Frank</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="5270.html" class="topic-previous" title="Go to previous forum topic">‹ [EmonCMS] Error when creating input process with HTTP request</a>
              <a href="3910.html" class="topic-next" title="Go to next forum topic">AFP with EmonCMS hdd build ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-21905"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Alignment / sychronisation of feeds with the timestamps</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Mon, 09/06/2014 - 20:32.</div>
    <div class="content">
     <p>Hello Frank,</p>
<p>Where are you doing the subtraction? in input processing? or afterwards using exported csv data?</p>
<p>What feed engines are the feeds in question stored in? PHPFina, PHPFiwa, PHPTimestore or PHPTimeSeries?</p>
<p>How are you sending data to emoncms?</p>
<p>Emoncms can either use a timestamp you give it or if it doesnt find a timestamp it will apply a timetamp at the time the request is received.</p>
<p>&nbsp;</p>
<p>To try and summarise how the data is stored:</p>
<p>PHPTimeSeries is a variable interval feed engine. Every time you post a datapoint it stores the datapoint in the data file. Each datapoint takes up 9 bytes in the data file, the first byte is a flag (used to flag deleted data), the next 4 bytes store the timestamp as an unsigned integer and the 4 bytes after that store the data value as a float.</p>
<p>PHPTimeSeries data is usually stored in the /var/lib/phptimeseries folder and has .MYD file extension (as PHPTimeSeries was originally designed to access datafiles produced by MYSQL directly)</p>
<p>PHPFina, PHPFiwa and PHPTimestore are all &#39;fixed interval&#39; feed engines. They start with the observation that most of the kind of data we deal with is recorded regularly at a 5, 10, 30s etc and so you dont need to store the timestamp for each datapoint in your datafile. You can instead record the start time of your feed and the interval in a meta data file and then just record 4 byte float values in your data file. The timestamp for any given datapoint can be worked out by start time + the position in the file of the datapoint multiplied by the interval.</p>
<p>This &#39;fixed interval&#39; approach provides significant performance benefits as searching for a datapoint in a file is very simple, its also more compact, it can take up less than half the diskspace of the variable interval approach.</p>
<p>The source code for the engines can be found here in the emoncms repo here: <a href="https://github.com/emoncms/emoncms/tree/master/Modules/feed/engine" title="https://github.com/emoncms/emoncms/tree/master/Modules/feed/engine">https://github.com/emoncms/emoncms/tree/master/Modules/feed/engine</a></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-21919"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5146.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5146.jpg" alt="franknfurther&#039;s picture" title="franknfurther&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Alignment / sychronisation of feeds with the timestamps</h3>

    <div class="submitted">Submitted by <a href="../user/5146.html" title="View user profile.">franknfurther</a> on Tue, 10/06/2014 - 19:37.</div>
    <div class="content">
     <p>Hi Trystan,</p>
<p>thanks for your response. I am doing the calculation in input processing and the times series in question are stored within PHPFIWA.</p>
<p>I suppose that what happens to the &quot;calculated&quot;&nbsp;timestamps&nbsp;of the fixed interval feed engines is that my uploaders(buffers) sometimes&nbsp;miss/skip an upload, which every now and again does happen in my case for one of my meters. see example data below.</p>
<p>While I understand the benefits of the fixed intervals, should I possibly consider using the variable feed engine for my case in order to allow for alignment of calculations of data with gaps? &nbsp;Or should I better do some pre-processing of the data in my RPi in the gateway forwarder?</p>
<p>Are the fixed interval feed engines just looking for the nearest fixed timestamp in the database and then store it under that timestamp? I suppose the input processing also just works with the latest data, disregarding that fact that it may be time-shifted.</p>
<p>this is example data of the 2 timeseries&nbsp;(timestamp1, value 1 timestamp2 value 2) downloaded in csv:</p>
<p>1401736830 41 1401736830 0<br />
	1401736840 40 1401736840 0<br />
	1401736850 39 1401736850 0<br />
	1401736860 39 1401736860 0<br />
	1401736870 38 1401736880 0<br />
	1401736880 38 1401736900 0<br />
	1401736890 38 1401736910 0<br />
	1401736910 38 1401736920 0</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/5288"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-uc866whzB8RnKtzYdwRmQlQI31I5Xsp80DGFigUAZrM" value="form-uc866whzB8RnKtzYdwRmQlQI31I5Xsp80DGFigUAZrM"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/5288 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:30 GMT -->
</html>
