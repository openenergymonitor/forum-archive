<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/3606 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:21:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonTX Shield v2 - troubleshooting | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonTX Shield v2 - troubleshooting</h3>
        <span class="submitted">Submitted by <a href="../user/5132.html" title="View user profile.">tomkerswill</a> on Sun, 12/01/2014 - 09:28</span>
        <div class="content"><p>Hi everyone,</p>
<p>I&#39;ve taken the plunge with OpenEnergyMonitor and started by getting an emontx shield v2&nbsp;and 1 CT clamp, plus radio chip. (No AC-AC yet - will add later. And no&nbsp;nanodes or base stations in the system, so I&#39;m using the serial monitor to check output from the board, rather than radio).</p>
<p>Was really impressed by how quickly the kit arrived! I&#39;ve soldered all the non-SMT components and attached it to the Arduino.</p>
<p>I&#39;ve uploaded the&nbsp;emonTxShield/Shield_CT1234 sketch.</p>
<p>This runs, but I don&#39;t think the readings are correct. I&#39;ve tested this by attaching the clamp around the lead to my kettle to start with. The readings don&#39;t seem to change appreciably when the kettle is on, so I&#39;m sure something isn&#39;t right! Here&#39;s an example of the output of the script with the CT connected to CT input 1:</p>
<p>19 0 32 0<br />
	19 0 32 0<br />
	23 0 34 0<br />
	18 0 34 0</p>
<p>This doesn&#39;t change if the kettle is on or off. If I disconnect the CT from the jack, then here are the kind of readings I get:</p>
<p>0 0 34 0<br />
	0 0 34 0<br />
	0 0 35 0</p>
<p>If I plug&nbsp;the CT into each port in turn, then I do see a big spike in readings for the relevant port. Here&#39;s an example of me plugging the CT into port 4 (with the clamp not round anything):</p>
<p>0 63 32 0<br />
	0 55 32 0<br />
	0 444 32 5473 &nbsp;&lt;--- Here is where I plugged into CT4<br />
	0 1 31 3543<br />
	0 0 32 764<br />
	0 0 33 139<br />
	0 0 32 45<br />
	0 0 32 22<br />
	0 0 32 22 &nbsp;&lt;--- CT4 is still plugged in here, and the readings seem to stabilise after the&nbsp;initial spike</p>
<p>I think&nbsp;something&#39;s probably not right, and I guess the most likely problem is with hardware (eg. how I&#39;ve soldered the board). My question is, what is the best procedure for testing this? Are there any sensible checks I can do with a multimeter, or simple tests I can run? All the soldering I&#39;ve done looks okay to theye.</p>
<p>I had a look through other forum posts, and I noticed there&#39;s lots of talk about tests that can be done with Robin&#39;s tools. These look like a good place to start. I&#39;ve run&nbsp;RawSamplesTool. This works fine in debug mode (with demo values). But when I switch debug off, it appears to hang, with output looking like this --- and there&#39;s no more output after the countdown begins (eg. nothing after &#39;4&#39; below):</p>
<p>In NORMAL mode ...</p>
<p>SUPPLYVOLTAGE = 4962, VIn NORMAL mode ...</p>
<p>SUPPLYVOLTAGE = 4940, V_RATIO = 1.42, I_RATIO = 0.38<br />
	millis() now = 11<br />
	recordingMayStartAt 5011<br />
	4</p>
<p>-------------</p>
<p>Thanks in advance for help with any of this!</p>
<p>Tom K</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="3595.html" class="topic-previous" title="Go to previous forum topic">‹ starting with the openEnergyMonitor</a>
              <a href="3608.html" class="topic-next" title="Go to next forum topic">Upgrading RFM12Pi Firmware Direct from the Pi not working ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-17536"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5132.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="tomkerswill&#039;s picture" title="tomkerswill&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX Shield v2 - troubleshooting</h3>

    <div class="submitted">Submitted by <a href="../user/5132.html" title="View user profile.">tomkerswill</a> on Sun, 12/01/2014 - 10:45.</div>
    <div class="content">
     <p>Hi everyone,</p>
<p>Following the last email, I&#39;ve fixed most of my problems by resoldering&nbsp;the joints on CT3. That seemed the best place to start, because the readings from that jack were consistently weird.</p>
<p>It&#39;s now working great, with all the readings spot-on.</p>
<p>I do still have the problem with Robin&#39;s&nbsp;RawSamplesTool hanging during the countdown. I was able to get the script to run without hanging once, by pressing the reset key and keeping on doing this until on one of the runs it completed successfully - but I guess that could be a bug in the script rather than a hardware error.&nbsp;</p>
<p>Thanks - looking forward to doing more experimenting with this!</p>
<p>Tom</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17538"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX Shield v2 - troubleshooting</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 12/01/2014 - 12:44.</div>
    <div class="content">
     <p>Robin will no doubt comment on his RawSamplesTool. I&#39;m not totally familiar with all of them, but some require the ac voltage input to work properly.</p>
<p>In case you were wondering about the high values when you plug the c.t. in (and warning - don&#39;t unplug or leave unplugged the c.t. while it&#39;s on a cable that&#39;s energised, you could get a nasty high voltage, 22 V if the internal protection is working and much higher if it isn&#39;t), that&#39;s due to the d.c. component that&#39;s there initially before the software high pass filter settles and removes it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17539"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5132.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="tomkerswill&#039;s picture" title="tomkerswill&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX Shield v2 - troubleshooting</h3>

    <div class="submitted">Submitted by <a href="../user/5132.html" title="View user profile.">tomkerswill</a> on Sun, 12/01/2014 - 13:40.</div>
    <div class="content">
     <p>Thanks Robert - Ah, okay, that makes sense. Re: the RawSamplesTool&nbsp;- ah, yes maybe it&#39;s because of my lack of AC-AC connection. I know that lots of people are using the tool fine, so it must be something that I haven&#39;t done that is making it freeze --- perhaps it&#39;s waiting for the AC-AC input.</p>
<p>Tom</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17544"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX Shield v2 - troubleshooting</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 12/01/2014 - 19:39.</div>
    <div class="content">
     <p>Is there not a descriptive comment at the top of the sketch? Robin usually puts quite clear instructions there. Failing that, look up the page where he first posted the tool.</p>
<p>Oh dear, it took me longer to find the page than to spot the clue: &quot;it records all voltage and current samples that are taken during one complete cycle of the mains.&quot; Can you tell (maybe from looking at the sketch) how it tells when a cycle of mains begins and ends? Maybe the comment that begins at line 68 is worth reading?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17549"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5132.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="tomkerswill&#039;s picture" title="tomkerswill&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX Shield v2 - troubleshooting</h3>

    <div class="submitted">Submitted by <a href="../user/5132.html" title="View user profile.">tomkerswill</a> on Sun, 12/01/2014 - 21:24.</div>
    <div class="content">
     <p>For anyone else reading, here is a link to the page with the tools:</p>
<p><a href="1757.html" title="http://openenergymonitor.org/emon/node/1757">http://openenergymonitor.org/emon/node/1757</a></p>
<p>And the description at the top of the file reads:</p>
<p>*<br />
	* Tool to display the raw samples generated by an Arduino.&nbsp; Starts in&#39; debug&#39; mode<br />
	* which uses synthesized values for voltage and current.&nbsp; For normal operation,<br />
	* commment out the &#39;#define DEBUG&#39; statement a few lines down.<br />
	*<br />
	* Pauses after each set of measurements has been taken.&nbsp; Press spacebar, then [cr],<br />
	* to repeat.</p>
<p>The code that I&#39;m reading (rawSamplesTool) doesn&#39;t have a comment on line 68, but I think what you&#39;re saying is that if there&#39;s no voltage, it&#39;s never going to be able to tell when one cycle ends, so it&#39;s just going to sit there forever waiting for a voltage change. I can&#39;t quite see this on the code, but I guess that must be what&#39;s happening.</p>
<p>I&#39;ll have a look through and see if there are any scripts that might help with a CT-only setup...</p>
<p>Tom</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17555"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX Shield v2 - troubleshooting</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 12/01/2014 - 22:26.</div>
    <div class="content">
     <p>I was looking at the later &quot;improved&quot; version. The comment is on line 141 in the version you are using.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17559"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5132.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="tomkerswill&#039;s picture" title="tomkerswill&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX Shield v2 - troubleshooting</h3>

    <div class="submitted">Submitted by <a href="../user/5132.html" title="View user profile.">tomkerswill</a> on Mon, 13/01/2014 - 06:56.</div>
    <div class="content">
     <p>Okay - so here&#39;s a copy of the comment on line 141. It looks like the countdown should run over a few seconds, and at the end of this, the recording process starts:</p>
<blockquote><p>/*&nbsp; Allow the system to run for several seconds so that the filtered<br />
		*&nbsp; voltage waveform can settle down.&nbsp; This info is needed for determining<br />
		*&nbsp; the start of each new mains cycle.&nbsp; During this period, a countdown<br />
		*&nbsp; is displayed.<br />
		*<br />
		*&nbsp; After the settling period has expired, raw samples taken during<br />
		*&nbsp; one complete mains cycle are stored in an array.&nbsp; The capacity of the<br />
		*&nbsp; array needs to be sufficient for the number of sample pairs that may<br />
		*&nbsp; appear.&nbsp; A 100 x 2 integer array will probably suffice.<br />
		*<br />
		*&nbsp; At the start of the following cycle, the data collected during the<br />
		*&nbsp; previous cycle data is sent to the Serial window.&nbsp;<br />
		*/</p>
</blockquote>
<p>... The code that determines the end of the cycle checks for a polarity change:</p>
<blockquote><p>if ((polarityNow == POSITIVE) &amp;&amp; (polarityOfLastReading == NEGATIVE))</p>
</blockquote>
<p>... And I guess this condition is never satisfied, so the program runs in an infinite loop.</p>
<p>It would be useful to have a guide to troubleshooting emonTxv2 shield in a CT-only setup. I&#39;ll have a look through the other programs and see if I can find any that are useful for debugging this kind of problem, and will try and get a guide together to make this process easier.</p>
<p>Tom</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/3606"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-vbThkhoB0I3W_L-k5o1SYNqKZrxJd4TyYGyAaIFRqJk" value="form-vbThkhoB0I3W_L-k5o1SYNqKZrxJd4TyYGyAaIFRqJk"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/3606 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:21:33 GMT -->
</html>
