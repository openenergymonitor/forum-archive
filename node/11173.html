<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11173 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:28 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Adding extra analog inputs | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Adding extra analog inputs</h3>
        <span class="submitted">Submitted by <a href="../user/8635.html" title="View user profile.">joseglez</a> on Wed, 26/08/2015 - 08:13</span>
        <div class="content"><p>I&#39;m building a home energy controller, using CT&#39;s and arduino MEGA.&nbsp; I need to control 3 extra CT inputs and not sure how to use the 74HC4051 (multiplexer) with the EmonLib library.&nbsp; The problem I have is how to assign the same analog port to read the 3 extra CT inputs (voltage and current or just plain current).&nbsp; I tried, but I have no good results.&nbsp;&nbsp;</p>
<p>Does any one have a solution on how to do it?</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11188.html" class="topic-previous" title="Go to previous forum topic">‹ EmonCMS 9.0 RC and PHP version</a>
              <a href="10887.html" class="topic-next" title="Go to next forum topic">Emoncms: installation on a shared host linux ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-33623"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 26/08/2015 - 10:08.</div>
    <div class="content">
     <p>Not knowing what you are doing with the multiplexer makes it hard to answer, but if my guess is correct, what you are looking for is 3 instances of EnergyMonitor that use the same physical I/O pin?</p>
<p>If so, all you must do is initialise each instance with the channel or pin, then before you call calcVI(...), you must switch as necessary with the multiplexer. It's probably more obvious for you to use EnergyMonitor::current(...) and EnergyMonitor::voltage(...) rather than EnergyMonitor::currentTX(...) and EnergyMonitor::voltageTX(...).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33624"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 26/08/2015 - 10:33.</div>
    <div class="content">
     <p>Which Arduino Mega are you using? &nbsp;Most of them have 16 analog input pins&nbsp;courtesy of the wider internal MUX in the bigger AVR processors (1280, 2560 etc.).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33635"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8635.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="joseglez&#039;s picture" title="joseglez&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/8635.html" title="View user profile.">joseglez</a> on Wed, 26/08/2015 - 15:39.</div>
    <div class="content">
     <p>Mega 2560, 16 analog pins. Need extra 3 analog pins.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33636"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8635.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="joseglez&#039;s picture" title="joseglez&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/8635.html" title="View user profile.">joseglez</a> on Wed, 26/08/2015 - 18:06.</div>
    <div class="content">
     <p>I&#39;m trying to get 3 extra analog readings for 3 CTs to either read current or voltage.&nbsp; The other analog pins of the arduino MEGA 2560 are used to read other CTs.</p>
<p>I was thinking on initialize the instance, but I do not know how.&nbsp; How would you do it?&nbsp; I know how to switch the miltiplexer, but I do not know how to isolate the answers. &nbsp;</p>
<p>I do not know what you mean by&nbsp;&nbsp;&nbsp; &quot;It&#39;s probably more obvious for you to use EnergyMonitor::current(...) and EnergyMonitor::voltage(...) rather than EnergyMonitor::currentTX(...) and EnergyMonitor::voltageTX(...).&quot;&nbsp; Could you please explain?</p>
<p>I was using the code &quot;Arduino sketch - voltage and current&quot; modified to select the proper channel in the multiplexer.&nbsp;</p>
<p>This is my code:</p>
<p>#include &quot;EmonLib.h&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Include Emon Library<br />
EnergyMonitor emon1;&nbsp; // Create an instance<br />
EnergyMonitor emon2;</p>
<p>double A;</p>
<p>void setup()<br />
{ &nbsp;<br />
&nbsp; Serial.begin(9600); &nbsp;<br />
&nbsp; emon1.voltage(0, 217.06, 0.7);&nbsp; // Voltage: input pin, calibration, phase_shift<br />
&nbsp; emon2.current(0, 6.06);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Current: input pin, calibration.<br />
&nbsp; pinMode(5,OUTPUT);<br />
&nbsp; pinMode(6,OUTPUT);<br />
&nbsp; pinMode(7,OUTPUT);<br />
}</p>
<p>void loop()<br />
{<br />
&nbsp; digitalWrite(5, LOW);<br />
&nbsp; digitalWrite(6, LOW);<br />
&nbsp; digitalWrite(7, LOW);<br />
&nbsp; emon1.calcVI(20,2000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp; Serial.println(emon1.Vrms);<br />
&nbsp; delay (1000);<br />
&nbsp; digitalWrite(5, LOW);<br />
&nbsp; digitalWrite(6, LOW);<br />
&nbsp; digitalWrite(7, HIGH);<br />
&nbsp; A= emon2.calcIrms(1480);<br />
&nbsp; Serial.println(A);<br />
&nbsp; Serial.println();<br />
&nbsp; delay(1000);</p>
<p>}</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33641"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 26/08/2015 - 22:19.</div>
    <div class="content">
     <p>Your sketch is missing some statements. I think you need to look carefully at the emonlib source code to see how each instance of the class is initialised and how those values make it into the methods that run inside loop( ) to read the power. You need to set up voltage and current for each instance of EnergyMonitor, even though all will use the same voltage input pin of the Arduino, and for the multiplexer those channels will also use the same current input pin of the Arduino.</p>
<p>You are reading real power with  calcVI(...), so for each CT you must at the same time read a current and the voltage. It makes sense to have the voltage input on one of the Arduino inputs, and currents on 14 of the remaining Arduino inputs, with 4 extra currents on the 16th Arduino input via your multiplexer.</p>
<p>Therefore, you need to create 18 class instances:</p>
<p>EnergyMonitor emon1, emon2, emon3,....emon18;</p>
<p>emon1.voltage(0, 217, 0.7);<br />
emon2.voltage(0, 217, 0.7);<br />
emon3.voltage(0, 217, 0.7);<br />
...<br />
emon18.voltage(0, 217, 0.7);</p>
<p>because all instances us the same voltage input - pin 0, then</p>
<p>emon1.current(1, 6.06);   - for the current on pin 1<br />
emon2.current(2, 6.06);   - for the current on pin 2<br />
emon3.current(3, 6.06);   - for the current on pin 3<br />
...<br />
emon14.current(14, 6.06);   - for the current on pin 14</p>
<p>and for the multiplexed currents all going in on pin 15</p>
<p>emon15.current(15, 6.06);   - for the current on pin 15 mpx 1<br />
emon16.current(15, 6.06);   - for the current on pin 15 mpx 2<br />
emon17.current(15, 6.06);   - for the current on pin 15 mpx 3<br />
emon18.current(15, 6.06);   - for the current on pin 15 mpx 4</p>
<p>and inside loop( ):</p>
<p>emon1.calcVI(20,2000);<br />
emon2.calcVI(20,2000);<br />
emon3.calcVI(20,2000);<br />
...<br />
emon15.calcVI(20,2000); </p>
<p>set multiplexer for sub-channel 1<br />
emon15.calcVI(20,2000);<br />
set multiplexer for sub-channel 2<br />
emon16.calcVI(20,2000);<br />
set multiplexer for sub-channel 3<br />
emon17.calcVI(20,2000);<br />
set multiplexer for sub-channel 4<br />
emon18.calcVI(20,2000); </p>
<p>And the results for CT1 are in emon1.realPower / emon1.apparentPower etc,<br />
for CT2 they are in emon2....<br />
for CT3 they are in emon3....<br />
...<br />
and for the CT on channel 4 of your multiplexer, they are in emon18....  etc.</p>
<p>[All this isn't real code - it is only giving you the basic outline of how to do it.]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33644"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8635.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="joseglez&#039;s picture" title="joseglez&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/8635.html" title="View user profile.">joseglez</a> on Thu, 27/08/2015 - 00:03.</div>
    <div class="content">
     <p>I have only put the code for the extra CTs I need to read by the multiplexer, which I wrote to test the code.&nbsp; All of the other instances are working fine in the main program I wrote.</p>
<p>In my test program I can read clearly voltage and when I load the CT for current reading the values I get do not correspond to anything.&nbsp;</p>
<p>I may try to see using voltage in one arduino pins and use current for the mux pins. Do not clearly understand your method.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33645"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 27/08/2015 - 00:19.</div>
    <div class="content">
     <p>Have you confirmed with a scope, or even a multimeter, that the signal at the Arduino pin is as expected after you&#39;ve selected a CT input with the mux.... presumably it should be identical to the signal on the other side of the mux.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33650"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 27/08/2015 - 08:58.</div>
    <div class="content">
     <p>Joseglez,</p>
<p>What you have here:</p>
<p> EnergyMonitor emon1;  // Create an instance<br />
 EnergyMonitor emon2;</p>
<p> emon1.voltage(0, 217.06, 0.7);  // Voltage: input pin, calibration, phase_shift<br />
 emon2.current(0, 6.06);         // Current: input pin, calibration.</p>
<p>is two separate instances of EnergyMonitor. </p>
<p>emon1 is set up with the voltage pin and the constants for the voltage <u>but you have not set the current pin nor the current constant</u>, and </p>
<p>emon2 is set up with the constants for the current pin and the current constant, <u>but you have not set the voltage pin and the constants for the voltage</u>.</p>
<p>The voltage for emon1 should be correct but the current and power should be zero (or very small) and the current for emon2 should be correct but likewise the voltage and power will be wrong. Each instance needs to read the voltage and the current in order to compute power.</p>
<p>For your multiplexer, you have 4 current channels - is that correct? If yes, then those 4 channels appear on the same Arduino input pin, therefore the 4 corresponding instances of EnergyMonitor must all use the same current input pin. The EnergyMonitor class has no knowledge of your multiplexer - as far as it is concerned, the multiplexer does not exist. But by having separate instances, and running calcVI after you set the multiplexer channel, <b>you</b> are selecting the output that the readings go to.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33653"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8635.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="joseglez&#039;s picture" title="joseglez&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/8635.html" title="View user profile.">joseglez</a> on Thu, 27/08/2015 - 14:10.</div>
    <div class="content">
     <p>Sorry<em>. I do not follow you at all.&nbsp; </em></p>
<p><em>How can I check the voltage reading?&nbsp; I believe I only can do it with calcVI.&nbsp; Right?</em></p>
<p><em>To check the amps I can use </em><em>calcIrms independently the calcVI did it. Right?</em></p>
<p>In relation to your statement&nbsp; &quot;emon1 is set up with the voltage pin and the constants for the voltage but you have not set the current pin nor the current constant&quot;&nbsp; I only need to get the voltage.&nbsp;&nbsp;</p>
<p>In relation to your next statement, I only need to get the amps, not the power, so I do not need the voltage.. I also have to use de same pin as voltage, and that is the whole problem.&nbsp; Very difficult to understand, al least for me.</p>
<p>I have done only the mux for all current readings and got no good answers.&nbsp; I guess the EmonLib library does not like to use the same pin number to get results.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33655"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 27/08/2015 - 16:01.</div>
    <div class="content">
     <p>Now I am beginning to understand what you are doing. Most people want to know real power, because that relates directly to the energy they pay for. You have chosen to not do that, which is what confused me.</p>
<p>"<i>How can I check the voltage reading?  I believe I only can do it with calcVI?"</i><br />
Correct - unless you write your own method to calculate it. That would be very easy to do because you would take calcVI( ) and remove the current reading and power calculations.</p>
<p><i>"To check the amps I can use calcIrms independently the calcVI did it. Right?"</i><br />
It is not necessary that you use calcVI( ) to calculate current, but when you do, you will get a more accurate reading - because the voltage is available which means you can count cycles, which you cannot do with calcIrms( ). And you can know the values that calcVI calculated, they are all available:<br />
 emon1.realPower, emon1.apparentPower, emon1.Irms, emon1.Vrms and emon1.powerFactor.<br />
But to use calcVI( ), you must have a voltage signal available to the Arduino at the same time as the current signal is available. That is why I put the voltage input on pin 0 (not through the multiplexer) and the current inputs on the other input pins.</p>
<p>Why do you want to measure current and voltage separately? Is real power not more important to you?</p>
<p><i>"I guess the EmonLib library does not like to use the same pin number to get results."</i><br />
While you are using different instances of EnergyMonitor, each instance should be completely separate. For the emonTx, we normally use 4 instances and all 4 share the same voltage pin. So I think that is not the problem.</p>
<p>I suggest the multiplexer might not have settled before you start measuring, can you add a delay between switching the channel and starting the reading?  You might also get better results if you use the "op.amp bias" circuit <a href="673.html" title="http://openenergymonitor.org/emon/node/673">http://openenergymonitor.org/emon/node/673</a> using the same op.amp to provide the bias for all 18 inputs, which will ensure that all the inputs 'sit' at the same d.c. voltage.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33666"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8635.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="joseglez&#039;s picture" title="joseglez&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/8635.html" title="View user profile.">joseglez</a> on Fri, 28/08/2015 - 06:51.</div>
    <div class="content">
     <p>As I said, I&#39;m building a House Energy Controller.&nbsp; My house in Spain is all electric. I have a 3-phase supply 380-50Hz (4 wire) and the electric company will install a digital meter in no later than 10 months.&nbsp; This will put limit on the contacted power.&nbsp; I won&#39;t like to use more than the contact so I will lke to control which loads go in or out especially at night and during the winter (when heating is on).&nbsp; My normal use is 10kW daily in summer and 70-80kW in winter.&nbsp; I have a contract with time discrimination rates.</p>
<p>Electricity costs have gone up skyrocket in last few years and I will like to stay in this 60-80kW range contract.</p>
<p>The Open Energy Project sounded great for this.&nbsp; Do not need a very accurate reading of my power, just I want to stay within my contract.</p>
<p>My electronic knowledge is limited, although I have done several projects, asking when in doubt.</p>
<p>This &quot;op.amp bias&quot; circuit is a very good solution.&nbsp; In relation with testing the voltage is because I have noticed a not too steady supply at times (lived in an area country like).&nbsp; I&#39;ll do the testing randomly.</p>
<p>Not sure how the emonTX works, but with the mux I haven&#39;t been lucky (so far).</p>
<p>I&#39;ll keep on trying to see how I can use the mux, although I may have to schedule the use of the existing pins for different CT measurements.&nbsp; Because I have not being successful on reading using the same pin number.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33669"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 28/08/2015 - 13:14.</div>
    <div class="content">
     <p>Thank you for the explanation. It is now much clearer. </p>
<p>Firstly, you cannot accurately measure power by reading current alone. Secondly, because you have a 3-phase supply, you cannot assume the three voltages of the three phases will be the same. However, you understand those limitations, and though you will only calculate apparent power, you should have a good (probably within 10%) estimate of the real power.</p>
<p>I think you need to learn how the emonTx and emonLib works. The quick guide is:</p>
<p>CalcVI( ): The emonTx takes pairs of samples voltage and current 50 times (approximately) per cycle. Voltage and current are multiplied together, the total is added up. At the same time, the voltage is squared, the total added up. The same thing happens to the current. At the end of the 10 cycles, the average values are calculated and the average of V &times; I is real power. The average V<sup>2</sup> is calculated, and the square root of that is the rms voltage, similarly the current. </p>
<p>CalcIrms( ): The emonTx takes readings of current, at about 5000 samples per second (twice the speed of calcVI because it is not reading the voltage). It cannot know when a mains cycle starts, so all you can do is guess how many samples it will read in (say) 10 cycles, and tell it to read that many samples. Each sample is squared, the total is averaged and the square root is Irms. </p>
<p>Your "emon1" is an instance of the class EnergyMonitor. All those measurements and calculations happen quite separately for each class instance, even though they might use the same voltage pin.</p>
<p>Part of reading the voltage (or current) is to select the input pin, and that is done with a multiplexer inside the processor component. Trystan Lea has used an external multiplexer here <a href="../buildingblocks/rtd-temperature-sensinghttp_/openenergymonitor.org/emon/buildingblocks/rtd-temperature-sensing.3255.delay"><br />
http://openenergymonitor.org/emon/buildingblocks/rtd-temperature-sensing</a>, and you can download the code and see how he did it. There is no fundamental reason why the multiplexer does not work.<br />
One thing I do notice: Trystan put a 10 ms delay (delay(10);) between setting the multiplexer and reading the analogue value. You might need to do the same. If you start reading before the multiplexer has finished switching, you might get a large voltage step at the analogue input pin because the voltage and current inputs sit at slightly different d.c. voltages. If you read the edge of that step, you will certainly get wrong readings. The op.amp bias supply should remove that step, but it would still be a good idea to have a small delay.</p>
<p>[You might like to look at this <a href="11143.html" title="http://openenergymonitor.org/emon/node/11143">http://openenergymonitor.org/emon/node/11143</a> - calcIrms(1228) seems to be a good value to choose. If you are reading a random part-cycle of current at the end, your Irms readings will vary because the maths assumes an exact number of whole cycles.]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33684"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8635.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="joseglez&#039;s picture" title="joseglez&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adding extra analog inputs</h3>

    <div class="submitted">Submitted by <a href="../user/8635.html" title="View user profile.">joseglez</a> on Sat, 29/08/2015 - 13:04.</div>
    <div class="content">
     <p>I finally made it to work.&nbsp; The problem was a faulty mux.&nbsp; I started fresh, replaced all the components one by one and once I replaced the mux everything worked as it should.&nbsp; Now, I can continue with the project.</p>
<p>I appreciate the help I received and for sure now I have a more intense knowledge of the system.&nbsp; I hope I will have the same attention in case I need it.&nbsp; Thanks again.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11173"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-RzoAQAwQtd-YC1s41v5_WYjdP1uOIISQyMYnB7UPMdk" value="form-RzoAQAwQtd-YC1s41v5_WYjdP1uOIISQyMYnB7UPMdk"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/11173 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:28 GMT -->
</html>
