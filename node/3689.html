<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/3689 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:21:06 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Troubleshooting a frozen emonTH [solved] | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Troubleshooting a frozen emonTH [solved]</h3>
        <span class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Tue, 21/01/2014 - 08:45</span>
        <div class="content"><p>I&#39;m running an emonTH with my gas phototransistor&nbsp;sketch (<a href="https://github.com/openenergymonitor/emonTH/pull/2">code</a>) and twice it&#39;s just stopped transmitting. After half an hour in each case I&#39;ve popped a battery for a second or two to reset it, with good results. It ran for around 30 hours the first time, but only 10 the second time (and has been up for an hour since).</p>
<p>It might be a battery issue, but the battery ADC is reporting 2.8V, just under full voltage (I&#39;m using AA primaries I had lying around).</p>
<p>Failing that, I guess it must be an issue with my sketch - perhaps it&#39;s running over memory (I made the sketch more complex between runs, so the reduced runtime might reflect increased memory footprint, although I wouldn&#39;t have expected so).</p>
<p>Can anyone recommend troubleshooting tactics? I can&#39;t access the unit with serial while it&#39;s deployed (and it wouldn&#39;t be logging anyway) but I wonder if I could add a memory check of some sort and transmit as a debugging input to emoncms?</p>
<p>Is there anything else in terms of the health of the unit that I could transmit?</p>
<p>[edit: looks like it might have stopped calling in again, after just an hour this time. If so I guess that would point strongly to a battery issue, in which case: ]</p>
<p>- is 2.8V not sufficient? How much capacity is expected from 2AA in terms of voltage drop?</p>
<p>- is it possible that the battery ADC isn&#39;t reporting voltage correctly? (I could check by changing the batteries and/or with a multimeter)</p>
<p>&nbsp;</p>
<p>Thanks,</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="3704.html" class="topic-previous" title="Go to previous forum topic">‹ Stacking emon tx shield</a>
              <a href="3669.html" class="topic-next" title="Go to next forum topic">Reduced RFM12Pi Receive range following a crash ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-17804"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Troubleshooting a frozen emonTH [solved]</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Tue, 21/01/2014 - 13:18.</div>
    <div class="content">
     <p>Just a note on a little more investigation, in case anyone follows a similar path:</p>
<p>Pretty basic: we are boosting the voltage from the AAs so there should be no issue with them running down to just 2.8V (see <a href="http://openenergymonitor.blogspot.co.uk/2013/10/emonth-update-hardware.html" title="http://openenergymonitor.blogspot.co.uk/2013/10/emonth-update-hardware.html">http://openenergymonitor.blogspot.co.uk/2013/10/emonth-update-hardware.html</a> ) and this means it&#39;s unlikely to be a hardware issue after all. More likely a problem with the sketch, as you&#39;d hope...</p>
<p>I uploaded a stripped-down version before leaving the house with the debug removed, which I thought would provide a little breathing room in SRAM by not loading all the strings. I also changed a few ints to bytes (desperate measures!) but to no avail.</p>
<p>I&#39;ll start reporting&nbsp;<a href="http://playground.arduino.cc/Code/AvailableMemory">freeMemory()</a>&nbsp;to emoncms and see if that looks like a likely culprit. There must be something...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17817"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Troubleshooting a frozen emonTH [solved]</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Wed, 22/01/2014 - 08:46.</div>
    <div class="content">
     <p>OK, freeMemory() reports a constant and ample amount of memory - 1720 - right up to the point the node stops transmitting.</p>
<p>1720 is actually more than I thought was even on the device, so perhaps the function&#39;s not that useful, but the fact it doesn&#39;t change leads me to suspect there isn&#39;t an insidious leak.</p>
<p>There were two while() loops in my original sketch - <a href="https://github.com/Dave-McCraw/emonTH/blob/f4ebcd74e84fcfcc530df66ec4780b286467ca9c/emonTH_gas_reflection_analogue/emonTH_gas_reflection_analogue.ino#L220-221">here </a>and <a href="https://github.com/Dave-McCraw/emonTH/blob/f4ebcd74e84fcfcc530df66ec4780b286467ca9c/emonTH_gas_reflection_analogue/emonTH_gas_reflection_analogue.ino#L245-249">here</a>&nbsp;- and I figured these were natural candidates for hanging up the emonTH.</p>
<p>I removed the first by switching to use sendNow() - although that probably has a loop internally - and &#39;fixed&#39; the second by &nbsp;incrementing an integer while waiting for the&nbsp;MilliTimer to ping, so the loop can run at most 32k times before returning - just to make sure it couldn&#39;t hang.</p>
<p>I loaded this sketch onto a second emonTH but after a few call-ins it also fell silent.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17818"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Troubleshooting a frozen emonTH [solved]</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Wed, 22/01/2014 - 08:48.</div>
    <div class="content">
     <p>I think the next step is to cut down to a minimal sketch that sends emoncms&nbsp;an int counter each time it loops, then carry across the transmission method from these sketches and see if that&#39;s enough to hang to device. If I can get it to fail quickly enough I can potentially use serial output to figure out what&#39;s going wrong.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17840"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Troubleshooting a frozen emonTH [solved]</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Wed, 22/01/2014 - 19:41.</div>
    <div class="content">
     <p><a href="https://github.com/Dave-McCraw/emonTH/blob/f4ebcd74e84fcfcc530df66ec4780b286467ca9c/emonTH_gas_reflection_analogue/emonTH_gas_reflection_analogue.ino#L228">Got it</a> - calling power_spi_disable() led the sketch to hang. I was also multiplying a delay given in ms by 1000, which didn&#39;t exactly help...</p>
<p>Moving that line made everything smile again.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/3689"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-5vVdFZB0S7M5A1E4OtWe4QG9CADAnMJ8futRldJRJqk" value="form-5vVdFZB0S7M5A1E4OtWe4QG9CADAnMJ8futRldJRJqk"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/3689 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:21:06 GMT -->
</html>
