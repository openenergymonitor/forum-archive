<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1418 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:59:40 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>SOLVED: CurrentCost Monitor feed to EmonCMS | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">SOLVED: CurrentCost Monitor feed to EmonCMS</h3>
        <span class="submitted">Submitted by Guest on Fri, 23/11/2012 - 20:37</span>
        <div class="content"><p>I have just started down the path of energy monitoring. My first plan is to get my CurrentCost Monitor feeding to EmonCMS, then to build the whole monitoring infrastructure from the kits on this site.</p>
<p>Yesterday I got my Raspberry Pi feeding the energy monitor data to COSM using a Perl script I found on the current cost site which I have attached. I&#39;m not sure the etiquette but credit for the script goes to <b class="postauthor">ghubsch </b>over on the currentcost forums. I managed to hack the script enough to get it feeding to COSM every 6 seconds when the data comes in from the monitor.</p>
<p>Today I installed Emoncms on my server, so now I need to hack this script, or find another one that takes the data from the currentcost via the Raspberry Pi and passes to EmonCMS.&nbsp; Does anyone know if a script such as this exists? I have Googled all over but not been able to find anything.</p>
<p>I would appreciate any help that the community can give, I&#39;m just trying to get the simplest software part working before launching myself with a soldering iron at the really hard parts. I have no programming experience other than the odd hack to config files etc as required.</p>
<p>thanks</p>
<p>Paul</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10844.html" class="topic-previous" title="Go to previous forum topic">‹ Removing suspected noise from CT</a>
              <a href="10839.html" class="topic-next" title="Go to next forum topic">What have i done wrong, +input doesn&#039;t work. ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-7584"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Fri, 23/11/2012 - 20:44.</div>
    <div class="content">
     <p>would probably help if you attached the script ;-)</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7588"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="plmills&#039;s picture" title="plmills&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by plmills (not verified) on Fri, 23/11/2012 - 22:18.</div>
    <div class="content">
     <p>Script is hopefully attached now. Thanks for the comment.</p>
<p>I think I see what I did now. I attached it but without clicking list it doesn&#39;t show</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7589"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Fri, 23/11/2012 - 22:36.</div>
    <div class="content">
     <p>This is UNTESTED ( i don&#39;t have a current cost monitor). &nbsp;</p>
<p>You&#39;ll need to add your EMONCMS api&nbsp;(line 9)<br />
	and check/change the url&nbsp;(line 42)</p>
<p>It&#39;s a bodge of an existing script, so if it doesn&#39;t work, it should give you enough to get started</p>
<p>&nbsp;</p>
<p>#!/usr/bin/perl -w</p>
<p># Reads data from a Current Cost device via serial port.</p>
<p>use strict;<br />
	use Device::SerialPort qw( :PARAM :STAT 0.07 );<br />
	use LWP::UserAgent;</p>
<p>my $key = &quot;your_emoncms api key_here&quot;;</p>
<p>my $PORT = &quot;/dev/ttyUSB0&quot;;<br />
	my $meas = 0;<br />
	my $sumW = 0;<br />
	my $sumT = 0;<br />
	my $watts;<br />
	my $temp;<br />
	my $wget;</p>
<p>
	my $ob = Device::SerialPort-&gt;new($PORT)&nbsp; || die &quot;Can&#39;t open $PORT: $!\n&quot;;<br />
	$ob-&gt;baudrate(57600);<br />
	$ob-&gt;write_settings;</p>
<p>open(SERIAL, &quot;+&gt;$PORT&quot;);<br />
	while (my $line = &lt;SERIAL&gt;) {<br />
	&nbsp;&nbsp;&nbsp; if ($line =~ m!&lt;tmpr&gt; *([\-\d.]+)&lt;/tmpr&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts = $2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $temp = $1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;SUCCESS $meas: ... $watts, $temp\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meas++;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumW += $watts;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumT += $temp;<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp; if ($meas == 10) { #time to send<br />
	&nbsp;&nbsp;&nbsp;&nbsp; $watts = $sumW/10;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; $temp = $sumT/10;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;AVERAGE: ... $watts, $temp\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_ua = LWP::UserAgent-&gt;new;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_url = &quot;http://localhost/emoncms3/api/post?apikey=$key\&amp;json={power:$watts,temp:$temp}&quot;;<br />
	my $emon_response = $emon_ua-&gt;get($emon_url);</p>
<p>if ($emon_response-&gt;is_error) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; die $emon_response-&gt;status_line;<br />
	}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	}<br />
	}</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7592"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Fri, 23/11/2012 - 23:11.</div>
    <div class="content">
     <p>should have mentioned if you dont have LWP module installed try:</p>
<pre>
perl -MCPAN -e &#39;install Bundle::LWP&#39;</pre><p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7594"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="plmills&#039;s picture" title="plmills&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by plmills (not verified) on Fri, 23/11/2012 - 23:40.</div>
    <div class="content">
     <p>Thanks for the follow up. Yes I did have to install the LWP module, but was off trying to do it while you posted your comment.</p>
<p>&nbsp;</p>
<p>Thank you very much for the script here, I now have the data loading to emoncms on my NAS. I didn&#39;t have to do anything else to the script, although I have hacked it so that it sends every feed rather than every 10th</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7597"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="plmills&#039;s picture" title="plmills&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by plmills (not verified) on Sat, 24/11/2012 - 00:32.</div>
    <div class="content">
     <p>The script seems to run and feed emoncms, but after a minute or so the script seems to stop updating. I changed it to update every 6 seconds, but even when I changed it back it does not seem to run longer than a minute. Any suggestions as to how I could debug? when I run in SSH it does not give any error message when it stops.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7603"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Sat, 24/11/2012 - 08:35.</div>
    <div class="content">
     <p>I&#39;m not located where I can log onto my pi so this is from memory</p>
<p>you can log into the pi with more than one ssh&nbsp;session. &nbsp;so fire up another one, run the command&nbsp;</p>
<pre>
ps aux</pre><p>which will list all the processes running, you can then see if the process is still running or has actually died.</p>
<p>&nbsp;</p>
<p>The other thing is to look at the syslog which is located in /var/logs/syslog</p>
<pre>
tail -40 /var/log/syslog</pre><p>and see if anything has been written there</p>
<p>&nbsp;</p>
<p>Not related to the script stopping, but there are some variables which don&#39;t get used which are still in there, you might as well delete them (eg wget) ; a side effect of coding after beer in front of the TV!&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7823"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="plmills&#039;s picture" title="plmills&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by plmills (not verified) on Thu, 29/11/2012 - 22:21.</div>
    <div class="content">
     <p>Thanks for the help again, I have had a look in the logs and there is nothing there. The job seems to show up in the listing, but it is no longer sending anything to emoncms. It seems to run for a minute or so then stop sending.&nbsp; I changed it from collecting 10 then sending an average to sending every 6 seconds.</p>
<p>pi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2147&nbsp; 2.1&nbsp; 1.9&nbsp; 12932&nbsp; 8556 pts/0&nbsp;&nbsp;&nbsp; S&nbsp;&nbsp;&nbsp; 22:00&nbsp;&nbsp; 0:03 perl envi.pl<br />
	&nbsp;</p>
<p>This is the status with PS AUX it ran for a few minutes but has sent nothing to emoncms for 8 minutes now.</p>
<p>I reverted back to the old script for the last 24 hours in an effort to diagnose whether there is a problem getting the data from the serial port, but it seems to have been rock solid for a day sending to COSM.&nbsp; I am wondering if it is something in the error handling from emoncms? I&#39;m running a synology NAS which can sometimes be a bit slow to respond to web requests. Could it be that there is no response at all coming from the web server and it&#39;s just sat waiting for an answer?&nbsp; If this is the case would it be possible to change the script so that if there is no response it just keeps sending?&nbsp; If I&#39;m sending every 6 seconds I can live with a few readings getting lost on the way if the continuity is there?</p>
<p>Thanks</p>
<p>&nbsp;</p>
<p>edit: I&#39;ve just noticed that the kill command on the above job doesn&#39;t seem to do anything, so I&#39;m not sure if that means it is running or not.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8052"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2125.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2125.jpg" alt="elyobelyob&#039;s picture" title="elyobelyob&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/2125.html" title="View user profile.">elyobelyob</a> on Sat, 08/12/2012 - 17:19.</div>
    <div class="content">
     <p>If it&#39;s of any use, I use a method where I post my data into MQTT .. from there I can just write a quick script to listen to this data. I am writing a module to bring this data in. It&#39;s work in progress, but if someone wanted to take a look, it&#39;s currently taking in my CC XML data ... <a href="https://github.com/elyobelyob/emoncms" title="https://github.com/elyobelyob/emoncms">https://github.com/elyobelyob/emoncms</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12479"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3818.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3818.png" alt="fversteegen&#039;s picture" title="fversteegen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3818.html" title="View user profile.">fversteegen</a> on Fri, 31/05/2013 - 07:36.</div>
    <div class="content">
     <p>I know this is quite an old post, but based on this post I managed to create a working Perl script which runs fine on the synology. Full script is:</p>
<p>#!/usr/bin/perl -w<br />
	# Reads data from a Current Cost device via serial port.</p>
<p>	use strict;<br />
	use warnings;<br />
	use Device::SerialPort qw( :PARAM :STAT 0.07 );<br />
	use LWP::UserAgent;</p>
<p>	&nbsp;&nbsp;&nbsp; my $key = &quot;YOURAPIKEY&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $PORT = &quot;/dev/ttyUSB0&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $meas = 0;<br />
	&nbsp;&nbsp;&nbsp; my $sumW = 0;<br />
	&nbsp;&nbsp;&nbsp; my $sumT = 0;<br />
	&nbsp;&nbsp;&nbsp; my $watts;<br />
	&nbsp;&nbsp;&nbsp; my $temp;</p>
<p>
	&nbsp;&nbsp;&nbsp; my $ob = Device::SerialPort-&gt;new($PORT)&nbsp; || die &quot;Can&#39;t open $PORT: $!\n&quot;;<br />
	&nbsp;&nbsp;&nbsp; $ob-&gt;baudrate(57600);<br />
	&nbsp;&nbsp;&nbsp; $ob-&gt;write_settings;</p>
<p>	&nbsp;&nbsp;&nbsp; open(SERIAL, &quot;+&gt;$PORT&quot;);<br />
	&nbsp;&nbsp;&nbsp; while (my $line = &lt;SERIAL&gt;) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($line =~ m!&lt;tmpr&gt;\s*(-*[\d.]+)&lt;/tmpr&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts = $2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $temp = $1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;SUCCESS $meas: ... $watts, $temp\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meas++;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumW += $watts;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumT += $temp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($meas == 2) { #time to send<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $watts = $sumW/2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $temp = $sumT/2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;AVERAGE: ... $watts, $temp\n&quot;;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_ua = LWP::UserAgent-&gt;new;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_url = &quot;http://diskstation/emoncms/input/post.json?apikey=$key\&amp;json={power:$watts,temp:$temp}&quot;;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;my $emon_response = $emon_ua-&gt;get($emon_url);<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;$meas = $sumW = $sumT = 0;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br />
	}</p>
<p>The reason why the previous versions in this thread were not working was because the line &quot;$meas = $sumW = $sumT = 0;&quot; was omitted.</p>
<p>Can anyone now build on this script so it includes data from IAM&#39;s? (The Individual Appliance Monitors currentcost sells)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12586"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3818.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3818.png" alt="fversteegen&#039;s picture" title="fversteegen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3818.html" title="View user profile.">fversteegen</a> on Tue, 04/06/2013 - 06:55.</div>
    <div class="content">
     <p>Ok, I hacked together a script to support the Individual Appliance Monitors of currentcost and corrected an error in the readings (watts were only half of what they suppose to be).</p>
<p>&nbsp;</p>
<p>#!/usr/bin/perl -w<br />
	# Reads data from a Current Cost device via serial port.</p>
<p>	use strict;<br />
	use warnings;<br />
	use Device::SerialPort qw( :PARAM :STAT 0.07 );<br />
	use LWP::UserAgent;</p>
<p>	&nbsp;&nbsp;&nbsp; my $key = &quot;YOURKEYLOCAL&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $PORT = &quot;/dev/ttyUSB0&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $meas = 0;<br />
	&nbsp;&nbsp;&nbsp; my $sumW = 0;<br />
	&nbsp;&nbsp;&nbsp; my $sumT = 0;<br />
	&nbsp;&nbsp;&nbsp; my $watts;<br />
	&nbsp;&nbsp;&nbsp; #2 extra variables for IAM 1&nbsp;&nbsp; &nbsp;<br />
	&nbsp;&nbsp;&nbsp; my $watts_sensor1;<br />
	&nbsp;&nbsp;&nbsp; my $sumwatts_sensor1= 0;<br />
	&nbsp;&nbsp;&nbsp; my $temp;</p>
<p>
	&nbsp;&nbsp;&nbsp; my $ob = Device::SerialPort-&gt;new($PORT)&nbsp; || die &quot;Can&#39;t open $PORT: $!\n&quot;;<br />
	&nbsp;&nbsp;&nbsp; $ob-&gt;baudrate(57600);<br />
	&nbsp;&nbsp;&nbsp; $ob-&gt;write_settings;</p>
<p>	&nbsp;&nbsp;&nbsp; open(SERIAL, &quot;+&gt;$PORT&quot;);<br />
	&nbsp;&nbsp;&nbsp; while (my $line = &lt;SERIAL&gt;) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;0&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts = $2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $temp = $1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;SUCCESS $meas: ... $watts, $temp\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meas++;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumW += $watts;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumT += $temp;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;#extra if statement to get watts for IAM 1, change the sensorname to reflect this&nbsp;&nbsp; &nbsp;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;1&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts_sensor1 = $2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;SUCCESS $meas: ... $watts_sensor1\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meas++;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumwatts_sensor1 += $watts_sensor1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($meas == 6) { #time to send<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $watts = $sumW/3;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $temp = $sumT/3;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #Additional line for each sensor, note that meas increases 2 times in the cases of 1 additional IAM, so watt readings need to be divided by meascount/sensoramount<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $watts_sensor1 = $sumwatts_sensor1/3;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;AVERAGE: ... $watts, $temp, $sumwatts_sensor1\n&quot;;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_ua = LWP::UserAgent-&gt;new;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_url = &quot;http://diskstation/emoncms/input/post.json?apikey=$key\&amp;json={power:$watts,temp:$temp,sensor1:$watts_sensor1}&quot;;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_response = $emon_ua-&gt;get($emon_url);<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#Line below is because I upload readings to 2 sites in parallel as backup<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_url2 = &quot;http://EXTERNALURL/emoncms/input/post.json?apikey=YOURKEY&amp;json={power:$watts,temp:$temp,sensor1:$watts_sensor1}&quot;;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_response2 = $emon_ua-&gt;get($emon_url2);<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#Do not forget to reset the sum for an additional sensor&nbsp;&nbsp; &nbsp;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;$meas = $sumW = $sumT = $sumwatts_sensor1 = 0;<br />
	&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;}<br />
	}</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13386"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3818.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3818.png" alt="fversteegen&#039;s picture" title="fversteegen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3818.html" title="View user profile.">fversteegen</a> on Thu, 04/07/2013 - 10:13.</div>
    <div class="content">
     <p>For anyone who wants to know: all the steps I took from a clean DS211J to running emoncms on DSM 4.2 are:</p>
<p>&nbsp;</p>
<div class="im">
<ul>
<li>
			Install serialport for perl<br />
			<span><i>ipkg install </i><i>perl</i>-device-<i>serialport</i></span></li>
</ul>
</div>
<ol>
<li>
		Bootstrap synology via: <a href="http://forum.synology.com/wiki/index.php/Overview_on_modifying_the_Synology_Server,_bootstrap,_ipkg_etc" target="_blank">http://forum.synology.com/<wbr />wiki/index.php/Overview_on_<wbr />modifying_the_Synology_Server,<wbr />_bootstrap,_ipkg_etc</a></li>
<li>
		Install kernel modules via: <a href="http://www.fischer-net.de/hausautomation/downloads/category/4-synology.html" target="_blank">http://www.fischer-net.de/<wbr />hausautomation/downloads/<wbr />category/4-synology.html</a></li>
<li>
		<span>Install dependencies<br />
		ipkg install lynx<br />
		ipkg install ncftp<br />
		ipkg install gpg<br />
		ipkg install gpgme<br />
		ipkg install gzip<br />
		ipkg install unzip<br />
		ipkg install make<br />
		ipkg install optware-devel<br />
		ipkg install usbutils</span></li>
<li>
		Get rid of wrong WGET version in Synology<br />
		wget <a href="http://ipkg.nslu2-linux.org/feeds/optware/cs08q1armel/cross/unstable/libidn_1.25-1_arm.ipk" target="_blank">http://ipkg.nslu2-linux.org/<wbr />feeds/optware/cs08q1armel/<wbr />cross/unstable/libidn_1.25-1_<wbr />arm.ipk</a><br />
		wget <a href="http://ipkg.nslu2-linux.org/feeds/optware/cs08q1armel/cross/unstable/wget-ssl_1.12-2_arm.ipk" target="_blank">http://ipkg.nslu2-linux.org/<wbr />feeds/optware/cs08q1armel/<wbr />cross/unstable/wget-ssl_1.12-<wbr />2_arm.ipk</a><br />
		wget <a href="http://ipkg.nslu2-linux.org/feeds/optware/cs08q1armel/cross/unstable/openssl_0.9.8v-2_arm.ipk" target="_blank">http://ipkg.nslu2-linux.org/<wbr />feeds/optware/cs08q1armel/<wbr />cross/unstable/openssl_0.9.8v-<wbr />2_arm.ipk</a><br />
		ipkg remove wget<br />
		<span>ipkg install lib* openssl* wget-ssl* </span></li>
<li>
		Install CpanMinus<br />
		curl -L <a href="http://cpanmin.us/" target="_blank">http://cpanmin.us</a> | perl - App::cpanminus (and get a coffee or 2 ;-))</li>
<li>
		<span>./configure --prefix=/opt</span></li>
<li>
		<span>Check usb connection with lsusb</span></li>
<li>
		Download correct toolchain: wget <a href="http://downloads.sourceforge.net/project/dsgpl/DSM 4.2 Tool Chains/Marvell 88F628x Linux 2.6.32/gcc421_glibc25_88f6281-GPL.tgz?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Fdsgpl%2Ffiles%2FDSM%25204.2%2520Tool%2520Chains%2FMarvell%252088F628x%2520Linux%25202.6.32%2F&amp;ts=1372915725&amp;use_mirror=garr" target="_blank">http://downloads.sourceforge.<wbr />net/project/dsgpl/DSM%204.2%<wbr />20Tool%20Chains/Marvell%<wbr />2088F628x%20Linux%202.6.32/<wbr />gcc421_glibc25_88f6281-GPL.<wbr />tgz?r=http%3A%2F%<wbr />2Fsourceforge.net%2Fprojects%<wbr />2Fdsgpl%2Ffiles%2FDSM%25204.2%<wbr />2520Tool%2520Chains%2FMarvell%<wbr />252088F628x%2520Linux%25202.6.<wbr />32%2F&amp;ts=1372915725&amp;use_<wbr />mirror=garr</a><br />
		tar xpzf gcc421_glibc25_88f6281-GPL.tgz -C /usr/local</li>
<li>
		Setup symlinks for Gnueabi<br />
		ln -sf /opt/bin/ld /opt/bin/arm-none-linux-<wbr />gnueabi-ld<br />
		ln -sf /opt/bin/ranlib /opt/bin/arm-none-linux-<wbr />gnueabi-ranlib<br />
		ln -sf /opt/bin/gcc /opt/bin/arm-none-linux-<wbr />gnueabi-gcc</li>
<li>
		<span>Install dependencies of script:<br />
		cpanm LWP::UserAgent</span></li>
<li>
		Ensure proper access to USB port:<br />
		chmod 666 /dev/ttyUSB0</li>
<li>
		Set correct baudrate and output for USB port:</p>
<div class="im">
			stty -F /dev/ttyUSB0 speed 57600 raw cs8</div>
</li>
<li>
		Install emoncms via: <a href="http://emoncms.org/site/docs/installlinux" target="_blank">http://emoncms.org/site/docs/<wbr />installlinux</a></li>
<li>
		Create/adapt the script below to suit your needs</li>
<li>
		Auto start script by adding line &quot;/opt/bin/perl /volume1/web/emoncms/<a href="http://envi3.pl/" target="_blank">envi3.pl</a> &gt;/volume1/web/emoncms/envi3.<wbr />log&quot; to \etc\rc.local</li>
</ol>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-15028"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="gippy73&#039;s picture" title="gippy73&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by gippy73 (not verified) on Tue, 10/09/2013 - 13:45.</div>
    <div class="content">
     <p>I&#39;ve made some little improvement to the script on 12th post, hope somebody my find it useful:</p>
<p>#!/usr/bin/perl -w<br />
	# Reads data from a Current Cost device via serial port.</p>
<p>use strict;<br />
	use warnings;<br />
	use Device::SerialPort qw( :PARAM :STAT 0.07 );<br />
	use LWP::UserAgent;</p>
<p>&nbsp;&nbsp;&nbsp; my $key&nbsp; = &quot;YOUR-API-KEY-HERE&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $host = &quot;YOUR-IP-HERE&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $node = &quot;1&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $PORT = &quot;/dev/ttyUSB0&quot;;<br />
	&nbsp;&nbsp;&nbsp; my $meas = 0;<br />
	&nbsp;&nbsp;&nbsp; my $sumW = 0;<br />
	&nbsp;&nbsp;&nbsp; my $sumT = 0;<br />
	&nbsp;&nbsp;&nbsp; my $watts = 0;<br />
	&nbsp;&nbsp;&nbsp; my $conta_sensor0 = 0;<br />
	&nbsp;&nbsp;&nbsp; my $conta_sensor1 = 0;<br />
	&nbsp;&nbsp;&nbsp; my $count_limit&nbsp;&nbsp; = 6;<br />
	&nbsp;&nbsp;&nbsp; #2 extra variables for IAM 1&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; my $watts_sensor1;<br />
	&nbsp;&nbsp;&nbsp; my $sumwatts_sensor1= 0;<br />
	&nbsp;&nbsp;&nbsp; my $temp;</p>
<p>&nbsp;&nbsp;&nbsp; my $ob = Device::SerialPort-&gt;new($PORT)&nbsp; || die &quot;Can&#39;t open $PORT: $!\n&quot;;<br />
	&nbsp;&nbsp;&nbsp; $ob-&gt;baudrate(57600);<br />
	&nbsp;&nbsp;&nbsp; $ob-&gt;write_settings;</p>
<p>&nbsp;&nbsp;&nbsp; open(SERIAL, &quot;+&gt;$PORT&quot;);<br />
	&nbsp;&nbsp;&nbsp; while (my $line = &lt;SERIAL&gt;) {<br />
	# print $line;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;0&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts = $2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $temp = $1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;SUCCESS (Sensor0) $meas: ... $watts, $temp\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meas++;<br />
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $conta_sensor0++;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumW += $watts;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumT += $temp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #extra if statement to get watts for IAM 1, change the sensorname to reflect this&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;1&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts_sensor1 = $2;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;SUCCESS IAM (Sensor1) $meas: ... $watts_sensor1\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meas++;<br />
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $conta_sensor1++;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumwatts_sensor1 += $watts_sensor1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($meas == 36) { #time to send<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (($meas &gt;= $count_limit) &amp;&amp; ($conta_sensor0 &gt; 0) &amp;&amp; ($conta_sensor1 &gt; 0)) { #time to send<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $watts = $sumW/$conta_sensor0;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $temp = $sumT/$conta_sensor0;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #Additional line for each sensor, note that meas increases 2 times in the cases of 1 additional IAM, so watt readings need to be divided by meascount/sensoramount<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $watts_sensor1 = $sumwatts_sensor1/$conta_sensor1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;AVERAGE: ... $watts, $temp, $watts_sensor1\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_ua = LWP::UserAgent-&gt;new;<br />
	#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_url = &quot;http://$host/emoncms/input/post.json?apikey=$key\&amp;json={power:$watts,temp:$temp,sensor1:$watts_sensor1}&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_url = &quot;http://$host/emoncms/input/post.json?apikey=$key\&amp;node=$node\&amp;json={power:$watts,temp:$temp,sensor1:$watts_sensor1}&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; print &quot;$emon_url\n&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_response = $emon_ua-&gt;get($emon_url);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #Line below is because I upload readings to 2 sites in parallel as backup<br />
	#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_url2 = &quot;http://EXTERNALURL/emoncms/input/post.json?apikey=YOURKEY&amp;json={power:$watts,temp:$temp,sensor1:$watts_sensor1}&quot;;<br />
	#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $emon_response2 = $emon_ua-&gt;get($emon_url2);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #Do not forget to reset the sum for an additional sensor&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meas = $sumW = $sumT = $sumwatts_sensor1 = 0;<br />
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $conta_sensor0 = $conta_sensor1 = 0;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	}</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29907"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3818.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3818.png" alt="fversteegen&#039;s picture" title="fversteegen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/3818.html" title="View user profile.">fversteegen</a> on Thu, 23/04/2015 - 13:43.</div>
    <div class="content">
     <p>As I extended the amount of IAM&#39;s I have updated the script (still some code cleaning needed)</p>
<p>&nbsp;</p>
<p>#!/usr/bin/perl -w<br />
# Reads data from a Current Cost device via serial port.<br />
BEGIN {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push @INC,&quot;/usr/lib/perl5/&quot;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
use warnings;<br />
use Device::SerialPort qw( :PARAM :STAT 0.07 );<br />
use LWP::UserAgent;</p>
<p>&nbsp;&nbsp; &nbsp;my $PORT = &quot;/dev/ttyUSB0&quot;;<br />
&nbsp;&nbsp; &nbsp;my $meas = 0;<br />
&nbsp;&nbsp; &nbsp;my $sumW = 0;<br />
&nbsp;&nbsp; &nbsp;my $sumT = 0;<br />
&nbsp;&nbsp; &nbsp;my $watts;<br />
&nbsp;&nbsp; &nbsp;#2 extra variables for IAM 1&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;my $watts_sensor1;<br />
&nbsp;&nbsp; &nbsp;my $sumwatts_sensor1= 0;<br />
&nbsp;&nbsp; &nbsp;my $watts_sensor2;<br />
&nbsp;&nbsp; &nbsp;my $sumwatts_sensor2= 0;<br />
&nbsp;&nbsp; &nbsp;my $watts_sensor3;<br />
&nbsp;&nbsp; &nbsp;my $sumwatts_sensor3= 0;<br />
&nbsp;&nbsp; &nbsp;my $watts_sensor4;<br />
&nbsp;&nbsp; &nbsp;my $sumwatts_sensor4= 0;<br />
&nbsp;&nbsp;&nbsp; my $temp;<br />
&nbsp;&nbsp; &nbsp;$meassensormain= 0;<br />
&nbsp;&nbsp; &nbsp;$meassensor1 = 0;<br />
&nbsp;&nbsp; &nbsp;$meassensor2 = 0;<br />
&nbsp;&nbsp; &nbsp;$meassensor3 = 0;<br />
&nbsp;&nbsp; &nbsp;$meassensor4 = 0;<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;</p>
<p>&nbsp;&nbsp; &nbsp;my $ob = Device::SerialPort-&gt;new($PORT)&nbsp; || die &quot;Can&#39;t open $PORT: $!\n&quot;;<br />
&nbsp;&nbsp; &nbsp;$ob-&gt;baudrate(57600);<br />
&nbsp;&nbsp; &nbsp;$ob-&gt;write_settings;</p>
<p>&nbsp;&nbsp;&nbsp; open(SERIAL, &quot;+&gt;$PORT&quot;);<br />
&nbsp;&nbsp;&nbsp; while (my $line = &lt;SERIAL&gt;) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;0&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts = $2;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $temp = $1;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;SUCCESS mainunit $meas: ... $watts, $temp\n&quot;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meassensormain = 1;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumW = $watts;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumT = $temp;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#extra if statement to get watts for IAM 3, change the sensorname to reflect this&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;3&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts_sensor3 = $2;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;SUCCESS IAM3 $meas: ... $watts_sensor3\n&quot;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meassensor3 = 1;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumwatts_sensor3 = $watts_sensor3;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#extra if statement to get watts for IAM 4, change the sensorname to reflect this&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;4&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts_sensor4 = $2;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;SUCCESS IAM4 $meas: ... $watts_sensor4\n&quot;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meassensor4 = 1;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumwatts_sensor4 = $watts_sensor4;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#extra if statement to get watts for IAM 2, change the sensorname to reflect this&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;2&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts_sensor2 = $2;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;SUCCESS IAM2 $meas: ... $watts_sensor2\n&quot;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meassensor2 = 1;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumwatts_sensor2 = $watts_sensor2;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#extra if statement to get watts for IAM 1, change the sensorname to reflect this&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if ($line =~ m!&lt;tmpr&gt;*([\-\d.]+)&lt;/tmpr&gt;&lt;sensor&gt;1&lt;/sensor&gt;.*&lt;ch1&gt;&lt;watts&gt;0*(\d+)&lt;/watts&gt;&lt;/ch1&gt;!) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $watts_sensor1 = $2;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &quot;SUCCESS IAM1 $meas: ... $watts_sensor1\n&quot;;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $meassensor1 = 1;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $sumwatts_sensor1 = $watts_sensor1;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($meassensormain ==1 and $meassensor1 ==1 and $meassensor2 == 1 and $meassensor3 == 1 and $meassensor4 == 1) { #time to send<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $watts = $sumW;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $temp = $sumT;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #Additional line for each sensor, note that meas increases 2 times in the cases of 1 additional IAM, so watt readings need to be divided by meascount/sensoramount<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $watts_sensor1 = $sumwatts_sensor1;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $watts_sensor2 = $sumwatts_sensor2;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $watts_sensor3 = $sumwatts_sensor3;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; $watts_sensor4 = $sumwatts_sensor4;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #print &quot;AVERAGE: ... $watts, $temp, $sumwatts_sensor1, $sumwatts_sensor2, $sumwatts_sensor3, $sumwatts_sensor4\n&quot;;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#print &quot;AVERAGE: ... $watts, $temp, $watts_sensor1, $watts_sensor2, $watts_sensor3, $watts_sensor4\n&quot;;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_ua = LWP::UserAgent-&gt;new;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#Line below is because I upload readings to 2 sites in parallel as backup<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_url2 = &quot;http://EMONCMSURL/input/post.json?node=1&amp;apikey=APIKEY&amp;json={power:$watts,temp:$temp,sensor1:$watts_sensor1,sensor2:$watts_sensor2,sensor3:$watts_sensor3,sensor4:$watts_sensor4}&quot;;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;my $emon_response2 = $emon_ua-&gt;get($emon_url2);<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;print &quot;$emon_url2\n&quot;;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#Do not forget to reset the sum for an additional sensor&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;$meas = $sumW = $sumT = $sumwatts_sensor1 = $sumwatts_sensor2 = $sumwatts_sensor3 = $sumwatts_sensor4 = $meassensormain = $meassensor1 = $meassensor2 = $meassensor3 = $meassensor4 = 0;<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
}</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29959"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8066.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="firefox7518&#039;s picture" title="firefox7518&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by <a href="../user/8066.html" title="View user profile.">firefox7518</a> on Mon, 27/04/2015 - 22:39.</div>
    <div class="content">
     <p>Hi</p>
<p>I found your&nbsp;PERL script here&nbsp;but it has some flaws for my implementation&nbsp;so I enhanced it and I&#39;m using it for several&nbsp;IAMs&nbsp;at the moment.</p>
<p>I also use this script to send the data to pvoutput.org so that I have the data also there where my PV setup will send the data to. I always have the data on my&nbsp;emoncms&nbsp;installation and pvoutput.org :-)</p>
<p>Here is the script I&#39;ve enhanced:<br />
<a href="10470.html#comment-29957">http://openenergymonitor.org/emon/node/10470#comment-29957</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31237"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="a_patch&#039;s picture" title="a_patch&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: SOLVED: CurrentCost Monitor feed to EmonCMS</h3>

    <div class="submitted">Submitted by a_patch (not verified) on Fri, 12/06/2015 - 11:06.</div>
    <div class="content">
     <p>Hi,</p>
<p>Thanks for article. With small adjustments I was able to install and make it work on my i686 DS214Play. But every so often Emon is not recording any data. I believe it is connected with updates and reboots. I did create login script, that is loading modules before scripts run, but even perl script is giving me proper output nothing is going to database. After reinstalling everything (except Emon) it used to working again... up to last week. I didn&#39;t came back. I checked API key and password gadzylion times. Manually using JSON is populating data. Script is giving me output, and database is accessible.<br />
What am I doing wrong? and also can it be permanently installed on NAS and not wiped after every update?</p>
<p>&nbsp;</p>
<p>Thanks for help</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1418"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-RlEB6bXBBWJsZm6qTiJ1VsfBk_oO4hTtc5GpLluugV0" value="form-RlEB6bXBBWJsZm6qTiJ1VsfBk_oO4hTtc5GpLluugV0"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/1418 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:59:41 GMT -->
</html>
