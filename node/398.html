<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/398 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:26:37 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Can anyone help with my project. Weather station integration. | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Can anyone help with my project. Weather station integration.</h3>
        <span class="submitted">Submitted by <a href="../user/436.html" title="View user profile.">nz.mike.christiansen</a> on Tue, 07/02/2012 - 09:45</span>
        <div class="content"><p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;<font face="Arial, Verdana, sans-serif"><font size="2" style="font-size: 9pt">Hi,</font></font></p>
<p lang="en-US"><font color="#000000"><font face="Arial, Verdana, sans-serif"><font size="2" style="font-size: 9pt">Ive been tinkering away trying to make a sketch to integrate my weather station with OpenEnergyMonitor. The weather station in question is a PeetBros Ultimeter 100 that outputs serial data.</font></font></font></p>
<p lang="en-US"><font color="#000000"><font face="Arial, Verdana, sans-serif"><font size="2" style="font-size: 9pt">I have found the necessary code to grab the serial data from the station, but am just having trouble with the RF12 components of the code. Im unable to pickup my transmissions on a simple serial base unit, and im not sure how to troubleshoot at which end (Tx or Rx) is causing the problem.</font></font></font></p>
<p lang="en-US"><font color="#000000"><font face="Arial, Verdana, sans-serif"><font size="2" style="font-size: 9pt">The sketch is very much a draft and im still working on a few things such as my BMP pressure is not correct (negitive values) and I want to have more precision with the temperature.</font></font></font></p>
<p lang="en-US"><font color="#000000"><font face="Arial, Verdana, sans-serif"><font size="2" style="font-size: 9pt">Im planning on doing a writeup on my build once done.</font></font></font></p>
<p lang="en-US"><font color="#000000"><font face="Arial, Verdana, sans-serif"><font size="2" style="font-size: 9pt">Any help with these problems, or if anyone can suggest any improvements i could make to my code it would be very much appreciated.</font></font></font></p>
<p lang="en-US">
&nbsp;</p>
<p lang="en-US"><font color="#000000"><font face="Arial, Verdana, sans-serif"><font size="2" style="font-size: 9pt">Kind regards,</font></font></font></p>
<p lang="en-US">
Mike Christiansen</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>/*</p>
<p>Code by Mike Christiansen <a href="mailto:nz.mike.christiansen@gmail.com">nz.mike.christiansen@gmail.com</a></p>
<p>&nbsp;</p>
<p>for open use, modifacation and sharing. No liability assumed.</p>
<p>&nbsp;</p>
<p>Any feedback most appreciated, im only an arduino beginner :)</p>
<p>&nbsp;</p>
<p>Code for Openenergymonotor tx device running on a jeenode.</p>
<p>this tx transmits data from a peet bros weather station&nbsp;</p>
<p>(wind speed, direction, averaged speed, outdoor temp, and&nbsp;</p>
<p>wind direction name (from michael p code) along with data</p>
<p>from a BMP085.</p>
<p>&nbsp;</p>
<p>Attachments to the jeenode uses the folowing jee ports</p>
<p>&nbsp;</p>
<p>Weatherstation serial port, uses arduino pin 6 (rx)&nbsp;</p>
<p>jeenode port 3 dio 5v and gnd through a ttl-rs232 converter</p>
<p>&nbsp;</p>
<p>BMP085</p>
<p>Pressure bord, P4</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Thanks to these people for there code contrubition.</p>
<p>Michael P from ADS-WS1 yahoo group</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>*/</p>
<p>//==============================BMP085==============================</p>
<p>// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jeenode - Jeelabs</p>
<p>#include &lt;Ports.h&gt;</p>
<p>#include &quot;PortsBMP085.h&quot;</p>
<p>#include &lt;RF12.h&gt;</p>
<p>#include &lt;avr/sleep.h&gt;</p>
<p>#include &lt;avr/eeprom.h&gt;</p>
<p>PortI2C four (4);</p>
<p>BMP085 psensor (four, 3); // ultra high resolution</p>
<p>MilliTimer timer;</p>
<p>&nbsp;</p>
<p>//==================================Openenergymonotor===========================</p>
<p>// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="http://openenergymonitor.org/" title="http://openenergymonitor.org">http://openenergymonitor.org</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>//---------------------------------------------------------------------------------------------------</p>
<p>// RF12 settings&nbsp;</p>
<p>//---------------------------------------------------------------------------------------------------</p>
<p>// fixed RF12 settings</p>
<p>&nbsp;</p>
<p>#define MYNODE &nbsp; &nbsp; &nbsp;18 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>
<p>#define network &nbsp; &nbsp; 212 &nbsp; &nbsp; &nbsp;//default network group (can be in the range 1-250). All nodes required to communigate together must be on the same network group</p>
<p>#define freq RF12_915MHZ &nbsp; &nbsp; //Frequency of RF12B module can be RF12_433MHZ, RF12_868MHZ or RF12_915MHZ. You should use the one matching the module you have.</p>
<p>&nbsp;</p>
<p>// set the sync mode to 2 if the fuses are still the Arduino default</p>
<p>// mode 3 (full powerdown) can only be used with 258 CK startup fuses</p>
<p>#define RADIO_SYNC_MODE 2</p>
<p>&nbsp;</p>
<p>#define COLLECT 0x20 // collect mode, i.e. pass incoming without sending acks</p>
<p>//--------------------------------------------------------------------------------------------------</p>
<p>&nbsp;</p>
<p>//--------------------------------------------------------------------------------------------------</p>
<p>// CT energy monitor setup definitions&nbsp;</p>
<p>//--------------------------------------------------------------------------------------------------</p>
<p>/*</p>
<p>int inPinI= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3; &nbsp; &nbsp;//I/O analogue 3 = emonTx CT2 channel. Change to analogue 0 for emonTx CT1 chnnel &nbsp;</p>
<p>int numberOfSamples= &nbsp; &nbsp; &nbsp; 1480; //The period (one wavelength) of mains 50Hz is 20ms. Each samples was measured to take 0.188ms. This meas that 106.4 samples/wavelength are possible. 1480 samples takes 280.14ms which is 14 wavelengths.&nbsp;</p>
<p>int Vrms= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;230; &nbsp;//UK assumed supply voltage. Tolerance: +10%-6%</p>
<p>int CT_BURDEN_RESISTOR= &nbsp; &nbsp;56; &nbsp; //value in ohms of burden resistor R3 and R6</p>
<p>int CT_TURNS= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1500; //number of turns in CT sensor. 1500 is the vaue of the efergy CT <a href="http://www.efergy.com/Products/efergy-Shop-Accessories/EFERGY/Jackplug-Extra-Sensor/pid-184334.aspx" title="http://www.efergy.com/Products/efergy-Shop-Accessories/EFERGY/Jackplug-Extra-Sensor/pid-184334.aspx">http://www.efergy.com/Products/efergy-Shop-Accessories/EFERGY/Jackplug-E...</a></p>
<p>double CAL=1.2477; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//*calibration coefficient* IMPORTANT - each monitor must be calibrated. See step 4 <a href="58.html" title="http://openenergymonitor.org/emon/node/58">http://openenergymonitor.org/emon/node/58</a></p>
<p>*/</p>
<p>//########################################################################################################################</p>
<p>//Data Structure to be received&nbsp;</p>
<p>//########################################################################################################################&nbsp;</p>
<p>typedef struct {</p>
<p>&nbsp; <span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;int ct1;<span class="Apple-tab-span" style="white-space:pre">		</span>// current transformer 1</p>
<p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;int ct2;<span class="Apple-tab-span" style="white-space:pre">		</span>// current transformer 2</p>
<p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;int temp1;<span class="Apple-tab-span" style="white-space:pre">		</span>// Outdoor temperature 1</p>
<p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;int temp2;<span class="Apple-tab-span" style="white-space:pre">		</span>// BMP085 &nbsp;temperature 2</p>
<p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;int temp3;<span class="Apple-tab-span" style="white-space:pre">		</span>// Server &nbsp;temperature 3</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int BMP_pres; &nbsp; &nbsp; &nbsp; &nbsp; // BMP085 &nbsp;Pressure</p>
<p><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;int emon_wind_speed; &nbsp;// PeetBros wind speed out</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int emon_wind_dir; &nbsp; &nbsp;// PeetBros wind direction out</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int emon_avg_wind; &nbsp; &nbsp;// PeetBros 5min ave wind speed</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int emon_wind_name; &nbsp; // Wind as named below</p>
<p>} Payload;</p>
<p>Payload emontx;</p>
<p>//########################################################################################################################</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;</p>
<p>//=================BELOW FOR SERIAL READ FROM PEET BROS STATION===================</p>
<p>// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THANKS TO MICHAEL P FROM ADS-WS1 YAHOO GROUP</p>
<p>#include &lt;NewSoftSerial.h&gt;</p>
<p>// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rx tx</p>
<p>NewSoftSerial &nbsp;weather_port1(6,7);</p>
<p>int wind_speed =0; &nbsp;// &nbsp;wind speed in kmh</p>
<p>int wind_dir = 0; &nbsp; // &nbsp;wind dir in degrees</p>
<p>int temp = 0; &nbsp; &nbsp; &nbsp; // &nbsp;Outdoor temp fahrenheit</p>
<p>int tempc = 0; &nbsp; &nbsp; &nbsp;// &nbsp;Outdoor temp celsius</p>
<p>float rain = 0; &nbsp; &nbsp; // &nbsp;not attached in my example</p>
<p>float bar = 0;&nbsp;</p>
<p>int id_temp =0; &nbsp; &nbsp; // &nbsp;not attached in my example</p>
<p>int hum = 0; &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;not attached in my example</p>
<p>int id_hum = 0; &nbsp; &nbsp; // &nbsp;not attached in my example</p>
<p>int day = 0; &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;time not used</p>
<p>int minutes = 0; &nbsp; &nbsp;// &nbsp;time not used&nbsp;</p>
<p>float day_rain = 0; // &nbsp;not attached in my example</p>
<p>int avg_wind = 0; &nbsp; // &nbsp;averaged wind speed over 1 minute</p>
<p>&nbsp;</p>
<p>byte chrconv(byte);</p>
<p>unsigned int getword(char *);</p>
<p>void get_weather();</p>
<p>char * wind_name(int);</p>
<p>char * getLine();</p>
<p>&nbsp;</p>
<p>unsigned int getword(char * ptr)</p>
<p>{</p>
<p>&nbsp; return( chrconv(*(ptr+0)) &lt;&lt; 12 | chrconv(*(ptr+1)) &lt;&lt; 8 | chrconv(*(ptr+2)) &lt;&lt; 4 | chrconv(*(ptr+3)));</p>
<p>}</p>
<p>byte chrconv(byte chr)</p>
<p>{</p>
<p>&nbsp;if &nbsp;(chr &nbsp;&lt; 48 || chr &gt; 70)</p>
<p>&nbsp; &nbsp;return -1;</p>
<p>&nbsp; &nbsp;</p>
<p>&nbsp;return &nbsp;(0x40 &amp; chr) ? (9 + (0x0f &amp; chr) ) : (chr - 48);</p>
<p>}</p>
<p>&nbsp;</p>
<p>//=================&quot;WITHOUT DELAY&quot; CODE FOR WRITING TO RF12b=======================</p>
<p>// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;using arduino example blink without delay</p>
<p>long previousMillis = 0;</p>
<p>long interval = 10000;&nbsp;</p>
<p>//================================SETUP============================================</p>
<p>void setup(){</p>
<p>//================================BMP085============================</p>
<p>psensor.getCalibData();</p>
<p>//===============================PeetBros============================</p>
<p>Serial.begin(9600);&nbsp;</p>
<p>weather_port1.begin(2400); &nbsp;</p>
<p>&nbsp;</p>
<p>//============================Openenergymonotor=========================</p>
<p>&nbsp; //-----------------------------------------</p>
<p>&nbsp; // RFM12B Initialize</p>
<p>&nbsp; //------------------------------------------</p>
<p>&nbsp; rf12_initialize(MYNODE,freq,network); &nbsp; //Initialize RFM12 with settings defined above&nbsp;</p>
<p>&nbsp; rf12_sleep(0); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //Put the RFM12 to sleep - Note: This RF12 sleep interupt method might not be 100% repiable. Put RF to sleep: RFM12B module can be kept off while not used &ndash; saving roughly 15 mA</p>
<p>&nbsp; //------------------------------------------</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp; Serial.print(&quot;Node: &quot;);&nbsp;</p>
<p>&nbsp; Serial.print(MYNODE);&nbsp;</p>
<p>&nbsp; Serial.print(&quot; Freq: &quot;);&nbsp;</p>
<p>&nbsp; Serial.print(freq);&nbsp;</p>
<p>&nbsp; Serial.print(&quot; Network: &quot;);&nbsp;</p>
<p>&nbsp; Serial.println(network);</p>
<p>&nbsp; delay(1000);</p>
<p>&nbsp;&nbsp;</p>
<p>//===========================PeetBros=========================================</p>
<p>}</p>
<p>char wLine[100];</p>
<p>char * getLine()</p>
<p>{</p>
<p>&nbsp; char cc=0;</p>
<p>&nbsp; int ii=0;</p>
<p>&nbsp; while(cc != '!')</p>
<p>&nbsp; {</p>
<p>&nbsp; &nbsp; delay(1);&nbsp;</p>
<p>&nbsp; &nbsp; cc = weather_port1.read();</p>
<p>&nbsp; &nbsp;&nbsp;</p>
<p>&nbsp; }</p>
<p>&nbsp; wLine[0]='!';</p>
<p>&nbsp; ii=1;</p>
<p>&nbsp; while(1)</p>
<p>&nbsp; {</p>
<p>&nbsp; &nbsp; if(weather_port1.available() &gt; 0)</p>
<p>&nbsp; &nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;cc = weather_port1.read();</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if (ii &lt; 99 and cc != '\n' and cc != '\r' and cc &nbsp;&gt; 31)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;wLine[ii] = cc;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ii++;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;else</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wLine[ii] = '\0';</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &amp;(wLine[0]);</p>
<p>&nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; }&nbsp;</p>
<p>&nbsp; }&nbsp;</p>
<p>}</p>
<p>void get_weather()</p>
<p>{</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;// char * ptr = &quot;!!030100D8017402632755030600F0----0006052000360201\0&quot;;</p>
<p>&nbsp; &nbsp; char * ptr = getLine();</p>
<p>&nbsp; &nbsp; int num_chars = strlen(ptr);</p>
<p>&nbsp; &nbsp; //Serial.println(ptr);</p>
<p>&nbsp; &nbsp; //Serial.println( num_chars);</p>
<p>&nbsp; &nbsp; if (!ptr or *ptr != '!' or *(ptr+1) != &nbsp;'!')</p>
<p>&nbsp; &nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp;Serial.println(&quot;no header&quot;);</p>
<p>&nbsp; &nbsp; &nbsp; return;</p>
<p>&nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; //0000 wind speed [0.1 kph]</p>
<p>&nbsp; &nbsp; wind_speed = (getword(ptr+2) /10.0);&nbsp;</p>
<p>&nbsp; &nbsp; //00D8 wind direction [0-255]</p>
<p>&nbsp; &nbsp; int tWindDir = (getword(ptr+6) * 360)/255;</p>
<p>&nbsp; &nbsp; if ( tWindDir &gt;=0 and tWindDir &lt;=360)</p>
<p>&nbsp; &nbsp; wind_dir = tWindDir;</p>
<p>&nbsp; &nbsp; //0174 current outdoor temp [0.1 deg F]</p>
<p>&nbsp; &nbsp; temp = (getword(ptr+10) /10.0);</p>
<p>&nbsp; &nbsp; // Maths - Temp conversion to degrees C</p>
<p>&nbsp; &nbsp; tempc = ((temp-32)/1.8);</p>
<p>&nbsp; &nbsp; //0263 rain long term total [0.01 inches]</p>
<p>&nbsp; &nbsp; rain = (getword(ptr+14) / 100.0);</p>
<p>&nbsp; &nbsp; //2755 current barometer [0.1 mbar]</p>
<p>&nbsp; &nbsp; bar = (getword(ptr+18) / 10.0) *0.0295301;</p>
<p>&nbsp; &nbsp; //0306 current indoor temp [0.1 deg F]</p>
<p>&nbsp; &nbsp; id_temp = (getword(ptr+22) /10.0);</p>
<p>&nbsp; &nbsp; //---- current outdoor humidity [0.1%]</p>
<p>&nbsp; &nbsp; hum = (getword(ptr+26) / 10.0);</p>
<p>&nbsp; &nbsp; //---- current indoor humidity [0.1%]</p>
<p>&nbsp; &nbsp; id_hum = (getword(ptr+30) / 10.0) ;</p>
<p>&nbsp; &nbsp; //0006 date [day of year, -1]</p>
<p>&nbsp; &nbsp; day = (getword(ptr+34) + 1);</p>
<p>&nbsp; &nbsp; //0520 time [minute of day, 0-1440]</p>
<p>&nbsp; &nbsp; minutes = (getword(ptr+38));</p>
<p>&nbsp; &nbsp; //0036 today's rain total [0.01 inches]</p>
<p>&nbsp; &nbsp; day_rain = (getword(ptr+42) / 100.0);</p>
<p>&nbsp; &nbsp; //0000 1 min wind speed average [0.1 kph]</p>
<p>&nbsp; &nbsp; avg_wind = (getword(ptr+46) / 10.0);</p>
<p>&nbsp; &nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;</p>
<p>}</p>
<p>char * wind_name(int windir)</p>
<p>{</p>
<p>&nbsp;</p>
<p>&nbsp; char * wname[17] = {&quot;&quot;, &quot;N&quot;, &quot;NNE&quot;, &quot;NE&quot;, &quot;ENE&quot;, &quot;E&quot;, &quot;ESE&quot;, &quot;SE&quot;, &quot;SSE&quot;, &quot;S&quot;, &quot;SSW&quot;, &quot;SW&quot;, &quot;WSW&quot;, &quot;W&quot;, &quot;WNW&quot;, &nbsp;&quot;NW&quot;, &quot;NNW&quot;};</p>
<p>&nbsp; float rawDir = &nbsp;float(windir) / 22.5;</p>
<p>&nbsp; int &nbsp;offset = int(rawDir + 1.5);</p>
<p>&nbsp; offset = offset &gt; 16 ? offset- 16 : offset;</p>
<p>&nbsp; return wname[offset];&nbsp;</p>
<p>&nbsp;&nbsp;</p>
<p>}</p>
<p>void send_rf12() {</p>
<p>//==================================BMP085===================================</p>
<p>&nbsp; &nbsp; psensor.startMeas(BMP085::TEMP);</p>
<p>&nbsp; &nbsp; delay(16);</p>
<p>&nbsp; &nbsp; int32_t traw = psensor.getResult(BMP085::TEMP);</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; psensor.startMeas(BMP085::PRES);</p>
<p>&nbsp; &nbsp; delay(32);</p>
<p>&nbsp; &nbsp; int32_t praw = psensor.getResult(BMP085::PRES);</p>
<p>&nbsp; &nbsp;&nbsp;</p>
<p>&nbsp; &nbsp; struct { int16_t temp; int32_t pres; } payload;</p>
<p>&nbsp; &nbsp; psensor.calculate(payload.temp, payload.pres);</p>
<p>&nbsp; &nbsp;&nbsp;</p>
<p>&nbsp; &nbsp; // this code is not needed for use as remote node, keep it for debugging</p>
<p>&nbsp; &nbsp; //Serial.print(&quot;BMP &quot;);</p>
<p>&nbsp; &nbsp; //Serial.print(&quot;temp = &quot;);</p>
<p>&nbsp; &nbsp; //Serial.print(payload.temp/10.0);</p>
<p>&nbsp; &nbsp; //Serial.print(' ');</p>
<p>&nbsp; &nbsp; //Serial.print(&quot;Pressure = &quot;);</p>
<p>&nbsp; &nbsp; //Serial.println(payload.pres);</p>
<p>&nbsp; &nbsp;&nbsp;</p>
<p>//--------------------------------------------------------------------------------------------------</p>
<p>// Create emon payload</p>
<p>//--------------------------------------------------------------------------------------------------</p>
<p>int temp1 = tempc;<span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Outdoor temperature 1</p>
<p>int temp2 = payload.temp/10.0; &nbsp; &nbsp; &nbsp; // BMP085 &nbsp;temperature 2</p>
<p>int BMP_pres = &nbsp;payload.pres/1; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // BMP085 &nbsp;Pressure</p>
<p>int emon_wind_speed = wind_speed; &nbsp; &nbsp; // PeetBros wind speed out</p>
<p>int emon_wind_dir = wind_dir; &nbsp; &nbsp; &nbsp; &nbsp; // PeetBros wind direction out</p>
<p>int emon_avg_wind = avg_wind; &nbsp; &nbsp; &nbsp; &nbsp; // PeetBros 5min ave wind speed</p>
<p>//char emon_wind_name = wind_name(wind_dir); &nbsp; &nbsp; &nbsp; // Wind name</p>
<p>&nbsp;</p>
<p>//---------------------------------------------------------------------------------------------------</p>
<p>//Serial print for debug</p>
<p>//---------------------------------------------------------------------------------------------------</p>
<p>delay (10);</p>
<p>Serial.print(&quot;temp1: &quot;);</p>
<p>Serial.println(temp1/1.0);</p>
<p>delay(5);</p>
<p>Serial.print(&quot;temp2: &quot;);</p>
<p>Serial.println(temp2/1.0);</p>
<p>delay(5);</p>
<p>Serial.print(&quot;pres: &quot;);</p>
<p>Serial.println(BMP_pres);</p>
<p>delay(5);</p>
<p>Serial.print(&quot;emon_wind_speed: &quot;);</p>
<p>Serial.println(emon_wind_speed);</p>
<p>delay(5);</p>
<p>Serial.print(&quot;emon_wind_dir: &quot;);</p>
<p>Serial.println(emon_wind_dir);</p>
<p>delay(5);</p>
<p>Serial.print(&quot;emon_avg_wind: &quot;);</p>
<p>Serial.println(emon_avg_wind);</p>
<p>delay(5);</p>
<p>//--------------------------------------------------------------------------------------------------</p>
<p>// Send payload data via RF</p>
<p>//--------------------------------------------------------------------------------------------------</p>
<p>&nbsp; &nbsp; rf12_sleep(-1); &nbsp; &nbsp; //wake up RF module</p>
<p>&nbsp; &nbsp; while (!rf12_canSend())</p>
<p>&nbsp; &nbsp; rf12_recvDone();</p>
<p>&nbsp; &nbsp; rf12_sendStart(rf12_hdr, &amp;emontx, sizeof emontx, RADIO_SYNC_MODE);&nbsp;</p>
<p>&nbsp; &nbsp; rf12_sleep(0); &nbsp; &nbsp;//put RF module to sleep</p>
<p>}</p>
<p>&nbsp; &nbsp;&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>void loop() {</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;unsigned long currentMillis = millis();</p>
<p>&nbsp; &nbsp;</p>
<p>&nbsp; &nbsp;if(currentMillis - previousMillis &gt; interval) {</p>
<p>&nbsp; &nbsp;// save the last time you blinked the LED&nbsp;</p>
<p>&nbsp; &nbsp;previousMillis = currentMillis;</p>
<p>&nbsp; &nbsp;//do whatever is in these brackets</p>
<p>&nbsp; &nbsp;&nbsp;</p>
<p>&nbsp; &nbsp;send_rf12();</p>
<p>&nbsp; &nbsp;}</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;get_weather();</p>
<p>&nbsp; &nbsp;</p>
<p>&nbsp; &nbsp;String prBuff = String(&quot;W Dir:&quot;) + wind_name(wind_dir) + String(&quot; &nbsp;W Spd:&quot;) + wind_speed;</p>
<p>&nbsp; &nbsp;//Serial.println(prBuff);</p>
<p>&nbsp; &nbsp;prBuff = String(&quot;Avg Spd:&quot;) + avg_wind + String(&quot; W deg:&quot;) + wind_dir;</p>
<p>&nbsp; &nbsp;//Serial.print(prBuff);</p>
<p>&nbsp; &nbsp;//Serial.print (&quot;temp:&quot;);</p>
<p>&nbsp; &nbsp;//Serial.println (tempc);</p>
<p>&nbsp; &nbsp;//Serial.print(&quot;wind dir:&quot;);</p>
<p>&nbsp; &nbsp;//Serial.println(wind_dir);</p>
<p>&nbsp; &nbsp;//Serial.print(&quot;wind speed:&quot;);</p>
<p>&nbsp; &nbsp;//Serial.print(wind_speed);</p>
<p>&nbsp; &nbsp;//Serial.println(&quot;kms&quot;);</p>
<p>&nbsp; &nbsp;//Serial.print(&quot;avg_wind: &quot;);</p>
<p>&nbsp; &nbsp;//Serial.print(winddir);</p>
<p>&nbsp; &nbsp;//Serial.print(avg_wind);</p>
<p>&nbsp; &nbsp;//Serial.println(&quot;kms&quot;);</p>
<p>&nbsp;</p>
<p>}</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="412.html" class="topic-previous" title="Go to previous forum topic">‹ 3 X 1,5 AA batterys on emonTX</a>
              <a href="393.html" class="topic-next" title="Go to next forum topic">photoresistor  (LDR) from emonGLCD &gt;&gt;&gt; emonTX ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-3118"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Can anyone help with my project. Weather station integration.</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Sun, 12/02/2012 - 11:57.</div>
    <div class="content">
     <p>&nbsp;If your not using a CT sensor it would be a good idea to remove the energy monitoring code. See here for a barebones RFM12 Tx and Rx <a href="https://github.com/openenergymonitor/RFM12B_Simple">code:&nbsp;https://github.com/openenergymonitor/RFM12B_Simple</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/398"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-DYr1lX3ovtzwPVZ-_0aLAhcgtBDKi6IUGgPMOE-MixA" value="form-DYr1lX3ovtzwPVZ-_0aLAhcgtBDKi6IUGgPMOE-MixA"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/398 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:26:37 GMT -->
</html>
