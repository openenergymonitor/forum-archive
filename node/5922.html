<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/5922 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:25:21 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Continuous monitoring sketch with MQTT publishing (over ethernet) | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>
        <span class="submitted">Submitted by <a href="../user/6498.html" title="View user profile.">sumnerboy</a> on Mon, 13/10/2014 - 02:33</span>
        <div class="content"><p>If anyone is interested here is the Arduino sketch I have running on my Uno clone (which has ethernet built in) and the EmonTX Arduino shield. It is based on the continuous monitoring sketch, originally written by Robin (calypso_rae). It will make real power measurements on all 4 CT sensors and publish results to various MQTT topics every 5 seconds.</p>
<p>I am running mqttwarn on my home server which subscribes to these topics and transforms the payloads into something suitable for EmonCMS (<a href="https://github.com/jpmens/mqttwarn#emoncms" title="https://github.com/jpmens/mqttwarn#emoncms">https://github.com/jpmens/mqttwarn#emoncms</a>). EmonCMS is running on the same home server.</p>
<p>This has been running for a couple of months and the daily/monthly cumulative totals are within 0.5% of the totals being reported and billed by my electricity provider so I am very happy with it all.</p>
<p>Note: if you decide to use this you will need to work out your own calibration values and update the sketch. I calibrated it by comparing the daily totals recorded by EmonCMS&nbsp;with the values reported by my provider (who have a portal showing daily totals since we have smart meters down here in NZ). But adjusting the calibration values I have been able to get it pretty accurate.</p>
<p>You will also need to update the MQTT broker IP address, username and password of course.</p>
<p>Not sure if anyone is interested but wanted to share what I had done since I received so much help and advice on this forum, as well as all the fabulous sketches already written and made available by the likes of Robin and Trystan etc. So many thanks to everyone on here!</p>
<p>Cheers,</p>
<p>Ben</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11012.html" class="topic-previous" title="Go to previous forum topic">‹ Posting emonTX shield data to local server</a>
              <a href="10042.html" class="topic-next" title="Go to next forum topic">Where does the RPI save received data from rfm12pi module? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-24569"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6903.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pbertra&#039;s picture" title="pbertra&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6903.html" title="View user profile.">pbertra</a> on Wed, 15/10/2014 - 12:09.</div>
    <div class="content">
     <p>I am really interested!</p>
<p>I have an arduino mega, I ordered an ethernet shield and I will order the emontx shield soon to send data to a mosquitto server server on a raspberry pi. There, I use node-red to publish to emoncms. So I will test this soon...</p>
<p>&nbsp;</p>
<p>Thank you!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24580"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6498.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-6498.jpg" alt="sumnerboy&#039;s picture" title="sumnerboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6498.html" title="View user profile.">sumnerboy</a> on Wed, 15/10/2014 - 18:51.</div>
    <div class="content">
     <p>No worries - glad someone might find this useful!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24583"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Thu, 16/10/2014 - 07:26.</div>
    <div class="content">
     <p>Thanks for sharing this Ben, I&#39;ve added a link from the emonTxShield example list in the readme to this forum post so people can still find this in time as it sounds like a nice configuration. <a href="https://github.com/openenergymonitor/emonTxFirmware/blob/master/emonTxShield/readme.md">https://github.com/openenergymonitor/emonTxFirmware/blob/master/emonTxShield/readme.md</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24586"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6498.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-6498.jpg" alt="sumnerboy&#039;s picture" title="sumnerboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6498.html" title="View user profile.">sumnerboy</a> on Thu, 16/10/2014 - 09:39.</div>
    <div class="content">
     <p>Thanks Trystan - it seems to be working very well so far, 2 months without an issue. I am in the process of merging in some of Robins PV diversion code to control a remote load using MQTT as well - not sure if the MQTT protocol will handle the rapid switching required but I will report back here once I have something to share.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24670"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7039.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="ianw&#039;s picture" title="ianw&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/7039.html" title="View user profile.">ianw</a> on Mon, 20/10/2014 - 09:27.</div>
    <div class="content">
     <p>I have done something similar but instead of using MQTTwarn, I use node-red which has a Emoncms output node. I have one EmonTX and 2 EmonTH&#39;s. (I have also tried MQTTwarn, which works well, but it is one more program to keep running. Node-red is also one more server to keep running, but it is such an elegant solution).</p>
<p>The combination of node-red, MQTT and EmonCMS is very powerful. Once you get data into MQTT then it is easy to send the data to many other systems.</p>
<p>As an example it is quite simple to send events from Emoncms to XBMC I have running on a separate Raspberry Pi, and these events appear as a notification or a popup on XBMC.</p>
<p>See <a href="https://github.com/matbor/mqtt2xbmc-notifications" title="https://github.com/matbor/mqtt2xbmc-notifications">https://github.com/matbor/mqtt2xbmc-notifications</a></p>
<p>for the software to install on XBMC.</p>
<p>These events are manipulated by a custom function I wrote to put the message into a form use by this software.</p>
<p>The node-red flow (including the custom functions) is</p>
<p>[{&quot;id&quot;:&quot;39eb56aa.c614aa&quot;,&quot;type&quot;:&quot;emoncms-server&quot;,&quot;server&quot;:&quot;http://192.168.0.58/emoncms&quot;,&quot;name&quot;:&quot;Locally Hosted Emoncms&quot;},{&quot;id&quot;:&quot;cb79af10.34865&quot;,&quot;type&quot;:&quot;serial-port&quot;,&quot;serialport&quot;:&quot;/dev/ttyAMA0&quot;,&quot;serialbaud&quot;:&quot;9600&quot;,&quot;databits&quot;:&quot;8&quot;,&quot;parity&quot;:&quot;none&quot;,&quot;stopbits&quot;:&quot;1&quot;,&quot;newline&quot;:&quot;\\n&quot;,&quot;bin&quot;:&quot;false&quot;,&quot;out&quot;:&quot;char&quot;,&quot;addchar&quot;:&quot;false&quot;},{&quot;id&quot;:&quot;ba386057.845d3&quot;,&quot;type&quot;:&quot;mqtt-broker&quot;,&quot;broker&quot;:&quot;192.168.0.58&quot;,&quot;port&quot;:&quot;1883&quot;,&quot;clientid&quot;:&quot;&quot;},{&quot;id&quot;:&quot;228442dc.dd7bbe&quot;,&quot;type&quot;:&quot;mqtt in&quot;,&quot;name&quot;:&quot;From Emoncms Home/Curl &quot;,&quot;topic&quot;:&quot;Home/curl&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:129.75,&quot;y&quot;:565.2000198364258,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;d35ba7db.2ca458&quot;,&quot;9d04509f.62fbb&quot;]]},{&quot;id&quot;:&quot;6ffa34d0.9005cc&quot;,&quot;type&quot;:&quot;comment&quot;,&quot;name&quot;:&quot;EmonTX input &quot;,&quot;info&quot;:&quot;ie RFM12IN input&quot;,&quot;x&quot;:133,&quot;y&quot;:77,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;e4bfc607.1b4038&quot;,&quot;type&quot;:&quot;serial in&quot;,&quot;name&quot;:&quot;RFM12 Radio on serial port&quot;,&quot;serial&quot;:&quot;cb79af10.34865&quot;,&quot;x&quot;:121.75000762939453,&quot;y&quot;:197.75000286102295,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;c49746a9.3b68b8&quot;,&quot;8e712794.718ed8&quot;]]},{&quot;id&quot;:&quot;c49746a9.3b68b8&quot;,&quot;type&quot;:&quot;function&quot;,&quot;name&quot;:&quot;Parse EmonTX input&quot;,&quot;func&quot;:&quot;//we are expecting data in form \&quot;nodeid data1 data2 etc\&quot;\n// Note much of this is redundant - there is a splitter node available that can do this. \n// And you could also just copy msg payload without any processing. \n// I have left this like this in case I want to validate the data that comes in.\nmsg.payload = msg.payload.trim();\n\n var tokens = msg.payload.split(\&quot; \&quot;,66);&nbsp; //FM2Pi will have a max of 66 bytes payload\n var outString = null;\n var outTopic = null;\n var msg2 = null;\n var nodeid = tokens.shift();\n \n if(!isNaN(nodeid)) {\n&nbsp;&nbsp;&nbsp;&nbsp; nodeid = nodeid &amp; 0x1F; // strip out the additional flags\n&nbsp;&nbsp;&nbsp;&nbsp; var raw = tokens;\n&nbsp;&nbsp;&nbsp;&nbsp; buf = new Buffer(raw);\n&nbsp;&nbsp;&nbsp;&nbsp; outString = [];\n\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (var i=0; i&lt;(tokens.length); i+=2) {\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; outString.push( buf.readInt16LE(i) );\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n//Create topic from node number&nbsp; \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; outTopic = &#39;Home&#39; + nodeid;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg2 = { payload:outString, topic:outTopic};\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }\n// EmonTX data\n&nbsp; if (nodeid == \&quot;10\&quot;) {\n&nbsp;&nbsp;&nbsp; return [msg2, null,null];\n&nbsp; }\n// EmonTH No 1&nbsp; \n&nbsp; if (nodeid == \&quot;19\&quot;)&nbsp; {\n&nbsp;&nbsp;&nbsp; return [ null,msg2,null];\n&nbsp; }&nbsp; \n&nbsp; EmonTH No 2\n&nbsp; if (nodeid == \&quot;20\&quot;)&nbsp; {\n&nbsp;&nbsp;&nbsp; return [ null,null,msg2];\n&nbsp; }&quot;,&quot;outputs&quot;:&quot;3&quot;,&quot;x&quot;:431.99998474121094,&quot;y&quot;:196.99999618530273,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;9dfe7b06.620188&quot;,&quot;860efd52.79f1&quot;],[&quot;642d2457.9bd2dc&quot;,&quot;89ffe4c7.760018&quot;],[&quot;b87e983d.478168&quot;,&quot;7ba25e5.f845da&quot;]]},{&quot;id&quot;:&quot;9dfe7b06.620188&quot;,&quot;type&quot;:&quot;mqtt out&quot;,&quot;name&quot;:&quot;Publish node 10 RFM12&nbsp; data &quot;,&quot;topic&quot;:&quot;Home/10&quot;,&quot;qos&quot;:&quot;0&quot;,&quot;retain&quot;:&quot;true&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:720.9999694824219,&quot;y&quot;:145.99999618530273,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;860efd52.79f1&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;Node 10 Radio debug&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;true&quot;,&quot;x&quot;:699.9999694824219,&quot;y&quot;:177.99999618530273,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;8e712794.718ed8&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;From input A&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;true&quot;,&quot;complete&quot;:&quot;false&quot;,&quot;x&quot;:405.50000762939453,&quot;y&quot;:233.50000762939453,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;89a97de1.76568&quot;,&quot;type&quot;:&quot;mqtt in&quot;,&quot;name&quot;:&quot;MQTT Broker rfm12b Node 10&quot;,&quot;topic&quot;:&quot;Home/10&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:130.1999969482422,&quot;y&quot;:381.20001220703125,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;2fc0479c.d03fb8&quot;,&quot;7e2265fe.81dd9c&quot;]]},{&quot;id&quot;:&quot;2fc0479c.d03fb8&quot;,&quot;type&quot;:&quot;emoncms&quot;,&quot;name&quot;:&quot;Emoncms node 10 input&quot;,&quot;emonServer&quot;:&quot;39eb56aa.c614aa&quot;,&quot;nodegroup&quot;:&quot;10&quot;,&quot;x&quot;:438.2000274658203,&quot;y&quot;:350.20002365112305,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;7e2265fe.81dd9c&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;From MQTT node 10&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;false&quot;,&quot;x&quot;:426.2000274658203,&quot;y&quot;:380.4500198364258,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;d35ba7db.2ca458&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;From MQTT &quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;true&quot;,&quot;complete&quot;:&quot;true&quot;,&quot;x&quot;:388.45002365112305,&quot;y&quot;:596.200023651123,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;9d04509f.62fbb&quot;,&quot;type&quot;:&quot;function&quot;,&quot;name&quot;:&quot;fnSendtoXBMC&quot;,&quot;func&quot;:&quot;var paylmqtt =&nbsp; msg.payload;\nvar topicstr = msg.topic;\n// This is a lvl 2 topic\noutmsg = msg;\npayloadmqtto = &#39;{\&quot;lvl\&quot;:\&quot;2\&quot;,\&quot;sub\&quot;:&#39;\npayloadmqtto = payloadmqtto + &#39;\&quot;&#39; + topicstr + &#39;\&quot;,&#39;;\npayloadmqtto = payloadmqtto + &#39;\&quot;txt\&quot;:\&quot;&#39;+paylmqtt+&#39;\&quot;,\&quot;img\&quot;:\&quot;/home/pi/.xbmc/userdata/Thumbnails/background.png\&quot;,\&quot;delay\&quot;: \&quot;20000\&quot;}&#39;;\noutmsg.payload = payloadmqtto;\nreturn&nbsp; outmsg;&quot;,&quot;outputs&quot;:1,&quot;x&quot;:387.14290618896484,&quot;y&quot;:564.888879776001,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;ac384fd9.53c7b&quot;,&quot;f223ef04.0ddc1&quot;]]},{&quot;id&quot;:&quot;a311c387.5cee4&quot;,&quot;type&quot;:&quot;mqtt out&quot;,&quot;name&quot;:&quot;Send to TVs running XBMC&quot;,&quot;topic&quot;:&quot;/Home/xbmc1&quot;,&quot;qos&quot;:&quot;0&quot;,&quot;retain&quot;:&quot;true&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:841.805534362793,&quot;y&quot;:566.0833377838135,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;ac384fd9.53c7b&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;After massaging for XBMC&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;true&quot;,&quot;x&quot;:618.2658920288086,&quot;y&quot;:593.8928813934326,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;f223ef04.0ddc1&quot;,&quot;type&quot;:&quot;delay&quot;,&quot;name&quot;:&quot;12 sec delay&quot;,&quot;pauseType&quot;:&quot;delay&quot;,&quot;timeout&quot;:&quot;12&quot;,&quot;timeoutUnits&quot;:&quot;seconds&quot;,&quot;rate&quot;:&quot;1&quot;,&quot;rateUnits&quot;:&quot;second&quot;,&quot;randomFirst&quot;:&quot;1&quot;,&quot;randomLast&quot;:&quot;5&quot;,&quot;randomUnits&quot;:&quot;seconds&quot;,&quot;drop&quot;:false,&quot;x&quot;:571.0571594238281,&quot;y&quot;:565.2000370025635,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;a6d361ea.592ca&quot;,&quot;a311c387.5cee4&quot;]]},{&quot;id&quot;:&quot;a6d361ea.592ca&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;After delay&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;true&quot;,&quot;x&quot;:790.1641502380371,&quot;y&quot;:534.4500198364258,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;642d2457.9bd2dc&quot;,&quot;type&quot;:&quot;mqtt out&quot;,&quot;name&quot;:&quot;Publish Node19 RFM12 data&quot;,&quot;topic&quot;:&quot;Home/19&quot;,&quot;qos&quot;:&quot;0&quot;,&quot;retain&quot;:&quot;true&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:722.1999816894531,&quot;y&quot;:209.2000093460083,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;89ffe4c7.760018&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;Node19 Radio debug&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;true&quot;,&quot;x&quot;:699.1999816894531,&quot;y&quot;:241.20002365112305,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;1e8dda1e.e17226&quot;,&quot;type&quot;:&quot;mqtt in&quot;,&quot;name&quot;:&quot;MQTT Broker rfm12b Node19&quot;,&quot;topic&quot;:&quot;Home/19&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:127.70000457763672,&quot;y&quot;:413.20001792907715,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;d4e7d75b.2b1828&quot;,&quot;c50bff5d.3af4&quot;]]},{&quot;id&quot;:&quot;d4e7d75b.2b1828&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;From MQTT node 19&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;false&quot;,&quot;x&quot;:426.4500217437744,&quot;y&quot;:443.95001792907715,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;c50bff5d.3af4&quot;,&quot;type&quot;:&quot;emoncms&quot;,&quot;name&quot;:&quot;Emoncms node 19 input&quot;,&quot;emonServer&quot;:&quot;39eb56aa.c614aa&quot;,&quot;nodegroup&quot;:&quot;19&quot;,&quot;x&quot;:435.2000274658203,&quot;y&quot;:412.9500198364258,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;b87e983d.478168&quot;,&quot;type&quot;:&quot;mqtt out&quot;,&quot;name&quot;:&quot;Publish node 20 RFM12 data&quot;,&quot;topic&quot;:&quot;Home/20&quot;,&quot;qos&quot;:&quot;0&quot;,&quot;retain&quot;:&quot;true&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:725.2500076293945,&quot;y&quot;:271.50000381469727,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;7ba25e5.f845da&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;Node20 Radio debug&quot;,&quot;active&quot;:false,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;false&quot;,&quot;x&quot;:701.5000076293945,&quot;y&quot;:301.50000381469727,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;b6ebb0ce.49145&quot;,&quot;type&quot;:&quot;mqtt in&quot;,&quot;name&quot;:&quot;MQTT Broker rfm12b Node20&quot;,&quot;topic&quot;:&quot;Home/20&quot;,&quot;broker&quot;:&quot;ba386057.845d3&quot;,&quot;x&quot;:127.75,&quot;y&quot;:442.7500057220459,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[[&quot;7e3279de.81cd88&quot;,&quot;e1f23fca.1e0dc&quot;]]},{&quot;id&quot;:&quot;7e3279de.81cd88&quot;,&quot;type&quot;:&quot;emoncms&quot;,&quot;name&quot;:&quot;Emoncms node 20 input&quot;,&quot;emonServer&quot;:&quot;39eb56aa.c614aa&quot;,&quot;nodegroup&quot;:&quot;20&quot;,&quot;x&quot;:435.25000762939453,&quot;y&quot;:474.00000762939453,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]},{&quot;id&quot;:&quot;e1f23fca.1e0dc&quot;,&quot;type&quot;:&quot;debug&quot;,&quot;name&quot;:&quot;From MQTT node 20&quot;,&quot;active&quot;:true,&quot;console&quot;:&quot;false&quot;,&quot;complete&quot;:&quot;false&quot;,&quot;x&quot;:424.00000762939453,&quot;y&quot;:506.5000047683716,&quot;z&quot;:&quot;766e32e7.8991cc&quot;,&quot;wires&quot;:[]}]</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24678"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6498.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-6498.jpg" alt="sumnerboy&#039;s picture" title="sumnerboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6498.html" title="View user profile.">sumnerboy</a> on Mon, 20/10/2014 - 18:55.</div>
    <div class="content">
     <p>Nice one Ian - MQTT really does seem to be picking up steam - I am continuously trying to move anything I can to it!</p>
<p>FYI there is also&nbsp;an XBMC&nbsp;service in mqttwarn&nbsp;- I am using this for all sorts of home automation notifications, along with emonCMS events.</p>
<p>I haven&#39;t played with nodered but it sounds similar in concept to mqttwarn, but with a much fancier UI on top and a lot more options in terms of routing events around. I have seen some pretty clever things done on nodered that most definitely would not be possible with mqttwarn!</p>
<p>mqttwarn is more of a simple, low-overhead&nbsp;script for generating notifications from MQTT messages.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24688"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7039.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="ianw&#039;s picture" title="ianw&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/7039.html" title="View user profile.">ianw</a> on Tue, 21/10/2014 - 00:26.</div>
    <div class="content">
     <p>Thanks Ben. I have tried the XBMC option in MQTTwarn, and it works well.</p>
<p>There is an error in the node-red function I posted - a simple typo. There is a comment line in the Parse Emon TX input function that is not commented. Easy to spot, and trivial to fix so I won&#39;t post a correction. Anyone who has problems contact me.&nbsp; But the error will stop the flow and you won&#39;t get anything.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24754"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6903.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pbertra&#039;s picture" title="pbertra&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6903.html" title="View user profile.">pbertra</a> on Thu, 23/10/2014 - 07:45.</div>
    <div class="content">
     <p>Just a small question about the shields... I have a Mega, an ethernet&nbsp;shield and the emontx shield (no RF). Can I just stack them in this order with no other change? Does someone use this configuration?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24772"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6903.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="pbertra&#039;s picture" title="pbertra&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6903.html" title="View user profile.">pbertra</a> on Fri, 24/10/2014 - 11:48.</div>
    <div class="content">
     <p>I answer my own post because it can be useful to others.&nbsp;You can stack a mega, an ethernet shield an the emontx shield in this order. You even have to... Because the emontx shield does fit on an arduino mage when soldered in the recommended way: the jacks are at the place of&nbsp;the&nbsp;additional&nbsp;mega IOs.</p>
<p>You also have to set the jumper to let pin 10 free.</p>
<p>And finally, for any sketch you upload, do not forget to initialize the ethernet board when it is connected because if you don&#39;t do so, the USB becomes unavailable after a few seconds... No idea why.</p>
<p>With these precautions, the sketch is working, more or less:</p>
<ul>
<li>I get the IP address</li>
<li>I have the confirmation of the connection to the MQTT server</li>
<li>I see the first message (&quot;/clients/emontx&quot; topic)</li>
<li>I see the measures</li>
</ul>
<p>but I don&#39;t receive any &nbsp;&quot;emontx/+&quot; message... I still have to debug to find out why.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29400"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7167.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7167.jpg" alt="pb&#039;s picture" title="pb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/7167.html" title="View user profile.">pb</a> on Sun, 05/04/2015 - 00:44.</div>
    <div class="content">
     <p>A question mainly for Ben (sumnerboy), but feel free to chip in if you can help. &nbsp;</p>
<p>I have finally set up my system and decided on a very similar setup to yours. &nbsp;I have:</p>
<pre>
EtherTen [ EmonTx Shield -&gt; MQTT reporting ] -&gt; Raspberry Pi 2 [ MqttWarn -&gt; EmonCMS ]</pre><p>The EtherTen is running a modified version of the code you posted in this thread, I am using the onboard id chip to set the MAC address by changing TXShield Ch4 to IO6. &nbsp;</p>
<p>Everything seems to be&nbsp;generally working, except the &#39;Use Today&#39; in My Electric is always blank. &nbsp;Looking through the setup guides for EmonCMS this is generally driven by a separate input stream (something like &#39;Ch1 Wh&#39;). &nbsp;The code you posted does not generate this feed, just power. &nbsp;I presume this can be generated&nbsp;within EmonCMS&nbsp;by setting up a&nbsp;separate feed, do you mind sharing your config for this or point me in the right direction please?</p>
<p>On a side note, the MQTT/MQTTWarn path for data seems like a good one, it forms a nice common interface between systems which can be easily debugged. &nbsp;Thanks for sharing and writing&nbsp;up&nbsp;your work on here, it certainly has helped me. &nbsp;Once I get brave enough I might even dive into OpenHAB on the Pi2.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29411"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6498.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-6498.jpg" alt="sumnerboy&#039;s picture" title="sumnerboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6498.html" title="View user profile.">sumnerboy</a> on Sun, 05/04/2015 - 20:18.</div>
    <div class="content">
     <p>Hey PB, there is a bug on the My Electric page currently which means USE TODAY is always blank/NaN - I am seeing the same thing unfortunately. However you are right in that you need a separate feed for kWh/day. There are pretty good instructions here (<a href="https://github.com/openenergymonitor/documentation/blob/master/Applications/HomeEnergyMonitor/HomeEnergyMonitor.md#setting-up-emoncms" title="https://github.com/openenergymonitor/documentation/blob/master/Applications/HomeEnergyMonitor/HomeEnergyMonitor.md#setting-up-emoncms">https://github.com/openenergymonitor/documentation/blob/master/Applicati...</a>).</p>
<p>Basically you take your raw W input (from your EmonTx) and generate an accumulating kWh/d feed - this is all internal to EmonCMS so nothing for the EmonTx to worry about. Takes a bit of fiddling to get your head around the inputs/feeds stuff but once you have it sorted it is pretty straightforward.</p>
<p>Glad you are finding MQTT/mqttwarn useful - thanks for the kind words.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32326"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6512.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="aheyworth&#039;s picture" title="aheyworth&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6512.html" title="View user profile.">aheyworth</a> on Fri, 17/07/2015 - 18:10.</div>
    <div class="content">
     <p>Hi all</p>
<p>Firstly, good work! &nbsp;I&#39;m using MQTT across my network of Arduinos and interfacing them with OpenHAB. &nbsp;I&#39;ve planned to use Arduino Uno, Ethernet Shield and EmonTX shield, and for data to publish via MQTT which both EmonCMS&nbsp;(local server)&nbsp;and OpenHAB to independently collect.</p>
<p>With all of the hardware assembled I took to trying out Ben&#39;s code. &nbsp;I&#39;ve entered my broker IP, topics etc. &nbsp;I dont use a username and password locally to removed this from the code.</p>
<p>The serial output shows an IP has been obtained and its connected to successfully to the broker. &nbsp;Using MQTTlens&nbsp;I cannot see any data being published to topics.</p>
<p>I noticed that Ben&#39;s code - as good as it is - also wants manual calculations. &nbsp;Is there any chance that someone could produce/modify code that:</p>
<p>a) applies&nbsp;automatic calculations based on AC voltage readings fed directly into the emontx shield.<br />
b) allows static IP address assignment.<br />
c) includes temperature data from the&nbsp;onboard shield temperature sensor, publishing via MQTT.</p>
<p>Many thanks</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32412"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6512.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="aheyworth&#039;s picture" title="aheyworth&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6512.html" title="View user profile.">aheyworth</a> on Mon, 20/07/2015 - 19:25.</div>
    <div class="content">
     <p>Updating my last message.</p>
<p>I now can see MQTT data being posted; although only a &#39;1&#39; and then 30 seconds later or so, a &#39;0&#39;.</p>
<p>I am not seeing any actual data being published, this is with the original unmodified code (except IP and topics).</p>
<p>Assistance please, would be great.</p>
<p>Thank you.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32415"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6498.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-6498.jpg" alt="sumnerboy&#039;s picture" title="sumnerboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Continuous monitoring sketch with MQTT publishing (over ethernet)</h3>

    <div class="submitted">Submitted by <a href="../user/6498.html" title="View user profile.">sumnerboy</a> on Mon, 20/07/2015 - 20:28.</div>
    <div class="content">
     <p>What code are you running exactly?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/5922"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-VQvFgQKV2gJ69_5N8cJ0OW4uuYw5swta79wsNU9_iCg" value="form-VQvFgQKV2gJ69_5N8cJ0OW4uuYw5swta79wsNU9_iCg"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
