<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10331 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:49:09 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Delay emonhub startup on cold boot? | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Delay emonhub startup on cold boot?</h3>
        <span class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Mon, 16/03/2015 - 15:43</span>
        <div class="content"><p>Any ideas how emonHub&nbsp;service startup&nbsp;could be delayed on first boot?&nbsp;</p>
<p>I&#39;m currently working on the software for the emonPi. The plan is to use standard emonhub to decode data (in JeeLabs packet format)&nbsp;from the serial port in exactly the same way as with the RFM69Pi.&nbsp;</p>
<p>On the emonPi&nbsp;data received by&nbsp;the onboard&nbsp;RFM69CW&nbsp;(from emonTH, other emonTx etc)&nbsp;will be passed to the serial port in the same way as with the RFM69Pi. The emonPi&nbsp;will also perform local sampling from connected CT&#39;s and pass the values to emonhub in JeeLab packet format with a fixed node ID (default 5). &nbsp;As far as emonHub is concerned there will be no difference from and emonPi or an RFM69Pi receiving data from several nodes.&nbsp;</p>
<p>Like on the emonTx V3 the emonPi performs a 10s check of the CT inputs and AC voltage input at startup to decide what&#39;s connected and sample accordingly. The issue is when emonHub starts up BEFORE the emonPi is ready then hangs due to &#39;device communication error&#39;. Could the statup of emonhub be delayed on cold boot?&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11281.html" class="topic-previous" title="Go to previous forum topic">‹ Monitor energy usage of a generator in a Vehicle // Bad internet connection</a>
              <a href="10919.html" class="topic-next" title="Go to next forum topic">Multi Stacked Barchart ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-28740"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 17/03/2015 - 11:57.</div>
    <div class="content">
     <p>Hi Glyn.</p>
<p>I&#39;m not sure how the Pi or emonHub&nbsp;can determine what is a &quot;cold&quot; start without some sort of &quot;time since last run&quot; code. Therefore the delay would need to&nbsp;be added to every start, restart or reboot and unless the code is different for the emonPi it will delay for all emonHub users, neither of which is ideal.&nbsp;</p>
<p>How much time are you short? emonHub is already configured to be the last daemon to start, But&nbsp;If you are only a&nbsp;couple of seconds out then maybe we can jiggle things around a&nbsp;bit or increase the existing delay a&nbsp;little. The existing delays have been kept short for a quick boot-up but another second or 2 shouldn&#39;t hurt.</p>
<p>Are you using auto-detect for baud ? The current implementation needs re-visiting as it is not foolproof. This will be looked at once the &quot;b-directional&quot; changes are made for control and MQTT. Does the issue still occur if using a defined baud?</p>
<p>Can the order of setup events be shuffled in the emonPi sketch? or remove any initial serial &quot;chatter&quot; or debug stuff&nbsp;to establish a stable &amp; quiet serial conn sooner ?</p>
<p>I see the sketch actually pauses for 10 secs, is it possible to use a &quot;if not 10s since&quot; loop so that the serial could be setup whilst waiting?</p>
<p>We can certainly add a small delay if that will fix it but I think the 2&nbsp;unsynchronized startup&nbsp;routines could vary with updates, loading etc and whenever the&nbsp;test is done by emonHub&nbsp;it could clash with a &quot;no response period&quot;&nbsp;in the sketch&nbsp;so the only 100%&nbsp;fool proof solutions would be&nbsp;to make emonHub wait longer than any potential delay for a response, which testing 3 bauds&nbsp;could result in a very long connection routine, or eliminate/reduce the &quot;no response&quot; periods in the sketch. Some delays are unavoidable but any delay in the sketch has to be accommodated 3 times with room to spare<span style="line-height: 20.7999992370605px;">&nbsp;in&nbsp;</span>emonHub&#39;s<span style="line-height: 20.7999992370605px;">&nbsp;auto detection.</span></p>
<p><span style="line-height: 20.7999992370605px;">​Paul</span></p>
<p><span style="line-height: 20.7999992370605px;">ps I notice you are using &quot;v&quot; to change voltage in the sketch, this is used by jeelib to return the firmware version and therefore may cause unexpected results. although it should only be an issue if &nbsp;the &#39;v&#39; get&nbsp;prefixed with 1 or 2, which shouldn&#39;t happen but it&#39;s not impossible.</span></p>
<p><span style="line-height: 20.7999992370605px;">​</span></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28751"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/380.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-380.jpg" alt="mharizanov&#039;s picture" title="mharizanov&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/380.html" title="View user profile.">mharizanov</a> on Tue, 17/03/2015 - 19:07.</div>
    <div class="content">
     <p>I use</p>
<pre>
<strong>echo $(cut -d &#39; &#39; -f 1 &lt;/proc/uptime)</strong></pre><p>to determine uptime and hence cold boot; you can then use a delay as needed before starting it up</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28754"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 17/03/2015 - 19:45.</div>
    <div class="content">
     <p>Wouldn&#39;t&nbsp;that just tell you time since last boot? I think Glyn was looking for &quot;time since power applied&quot; to try and sync emonHub starting with the AVR&#39;s setup() routine. Although this method would work it would also slow down every reboot&nbsp;unnecessarily&nbsp;and I think this&nbsp;approach is&nbsp;a bit&nbsp;flawed as if a either devices &quot;setup&quot; routines timing alters or if a watchdog, manual reset or sketch upload restarts the AVR&#39;s setup&nbsp;routine,&nbsp;emonhub&nbsp;could try and get a response when the AVR isn&#39;t able to provide one.</p>
<p>I don&#39;t mind adding a delay but shifting the hole along the timeline doesn&#39;t remove the hole and it&#39;s only a matter of time before it causes a problem (probably a weird, random and apparently untraceable issue that we don&#39;t connect to this!)</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28761"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Wed, 18/03/2015 - 09:42.</div>
    <div class="content">
     <blockquote><p>Like on the emonTx V3 the emonPi performs a 10s check of the CT inputs and AC voltage input at startup to decide what&#39;s connected and sample accordingly. The issue is when emonHub starts up BEFORE the emonPi is ready then hangs due to &#39;device communication error&#39;.</p>
</blockquote>
<p>Couldn&#39;t the emonPi send a &#39;delay&#39; (or &#39;wait&#39;) response to emonhub during this initial startup period? Or is it completely unresponsive on the serial (why)?</p>
<p>J&ouml;rg.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28819"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Thu, 19/03/2015 - 17:14.</div>
    <div class="content">
     <p>Thanks for replies guys. Reading your replies made me question why exactly&nbsp;the 10s delay is needed, the conclusion was it&#39;s only needed on the emonTx V3 since residual charge in the reservoir&nbsp;capacitor in the AC-DC power supply circuit could cause an AC&nbsp;waveform to be falsely&nbsp;detected if an AC input has just been unplugged, hence the 10&#39;s delay. Since the emonPi does not power itself from AC there is no need for this delay at all = problem fixed!&nbsp;</p>
<p>Yes I am using auto baud detect to detect&nbsp;38400 which is used by the emonPi.&nbsp;</p>
<p>Good spot regarding using &#39;v&#39; to change AC-AC calibration for EU or US. This is indeed used by RF12 Demo to return version. I will change to using &#39;p&#39;</p>
<p>&quot;Available commands:\n&quot;<br />
&quot; &nbsp;&lt;nn&gt; i &nbsp; &nbsp; - set node IDs (standard node ids are 1..30)\n&quot;<br />
&quot; &nbsp;&lt;n&gt; b &nbsp; &nbsp; &nbsp;- set MHz band (4 = 433, 8 = 868, 9 = 915)\n&quot;<br />
&quot; &nbsp;&lt;nnn&gt; g &nbsp; &nbsp;- set network group (RFM12 only allows 212, 0 = any)\n&quot;<br />
&quot; &nbsp;&lt;n&gt; c &nbsp; &nbsp; &nbsp;- set collect mode (advanced, normally 0)\n&quot;<br />
&quot; &nbsp;...,&lt;nn&gt; a - send data packet to node &lt;nn&gt;, request ack\n&quot;<br />
&quot; &nbsp;...,&lt;nn&gt; s - send data packet to node &lt;nn&gt;, no ack\n&quot;<br />
&quot; &nbsp;...,&lt;n&gt; p &nbsp;- Set AC Adapter Vcal 1p&nbsp;= UK, 2p&nbsp;= USA\n&quot;<br />
&quot; &nbsp;v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Show firmware version\n&quot;<br />
;</p>
<p>On another unrelated topic do you see an issue using long or unsigned long as struct&nbsp;variables? I seem to have issue with emonHub posting an empty variable as well as the correct one when using long / unsigned long&nbsp;for pulse count</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28820"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Thu, 19/03/2015 - 17:50.</div>
    <div class="content">
     <p>That&#39;s excellent, although I do now wonder whether even the shorter&nbsp;sleep periods in any of the sketches&nbsp;could cause an issue. currently the time emonHub&nbsp;waits&nbsp;for a response is quite&nbsp;short, if this does clash with a sleep period it may not get a response before moving on (or results in an error) .</p>
<p>There shouldn&#39;t be any issue using a long datatype&nbsp;as a struct&nbsp;variable&nbsp;as long as have defined that in the nodes&nbsp;datacodes,in the conf, as emonHub&nbsp;would perceive&nbsp;the 4 extra bytes of an additional long to be 2 integers unless told otherwise.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38081"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7456.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="jvda&#039;s picture" title="jvda&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/7456.html" title="View user profile.">jvda</a> on Sun, 10/01/2016 - 11:58.</div>
    <div class="content">
     <p>Hi,</p>
<p>I am facing the same problem.</p>
<p>I have configured emonhub to automatically start when my raspberry pi boots up, but when I reboot my raspberry I get following warning in my emonhub log file and emonhub is also not receiving or forwarding&nbsp;anything.</p>
<blockquote><p>2016-01-10 12:30:54,169 INFO EmonHub Pre-Release Development Version (rc1.2)<br />
2016-01-10 12:30:54,174 INFO Opening hub...<br />
2016-01-10 12:30:58,206 WARNING Device communication error - check settings</p>
</blockquote>
<p>I managed to fix this problem by stopping the emonhub service, wait some time (20 seconds) (not sure if this waiting is needed) and start the emonhub service again.</p>
<p>In that case the emonhub&nbsp;log file doesn&#39;t contain the warning message (see below) and was receiving the data from emonTx and emonTh and forwarding it properly to emoncms.org</p>
<blockquote><p>2016-01-10 12:30:54,169 INFO EmonHub Pre-Release Development Version (rc1.2)<br />
2016-01-10 12:30:54,174 INFO Opening hub...<br />
2016-01-10 12:30:58,206 WARNING Device communication error - check settings<br />
2016-01-10 12:44:12,307 INFO EmonHub Pre-Release Development Version (rc1.2)<br />
2016-01-10 12:44:12,313 INFO Opening hub...</p>
</blockquote>
<p>Of course next time my raspberry pi reboots I will have the same problem and need to apply the same manual steps to get it fixed. &nbsp;Is there any solution I can apply that will work automatically&nbsp;also when my pi reboots ?</p>
<p>kr<br />
jan</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38085"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Delay emonhub startup on cold boot?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sun, 10/01/2016 - 12:50.</div>
    <div class="content">
     <p>If you define the &quot;com_baud = &quot; value in emonhub.conf it will not run the baud detection which is where the issue is being picked up, from a cold boot (power cycle) due to the rfm2pi being reset, a normal &quot;soft&quot; reboot should be ok. But if you know your baud, it is always best to define it if you can.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10331"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-6xxUxuYq61ehDo9vgyKTBi9-jbXRaGWfosXpxZ61ecM" value="form-6xxUxuYq61ehDo9vgyKTBi9-jbXRaGWfosXpxZ61ecM"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
