<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1771 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:18:13 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>New version of the Fusion sketch | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">New version of the Fusion sketch</h3>
        <span class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Mon, 31/12/2012 - 22:03</span>
        <div class="content"><p>Hi everyone,</p>
<p>Some of you may be familiar with the old &quot;Fusion&quot; sketch which I wrote some time ago. For those of you who haven&#39;t read about it my idea was to take Robin&#39;s MKII&nbsp;sketch and fuse it with the energy monitor and to send the results to an emonGLCD display.&nbsp;</p>
<p>The original version had a number of correlation issues with some of the other methods and, as a consequence, I rewrote it and achieved a much better correlation. The sketches associated with this new version were published some time ago.</p>
<p>In the past few weeks I have been working upon the sketches once again. I wanted to extend the capability and be able to read the infra red pulse output from the Elster&nbsp;AC100 meter. Sadly, I didn&#39;t get that working. Instead, I decided to add additional temperature monitoring capability and to also add a feature whereby the results could be sent to the web.</p>
<p>The picture below shows the output on the GLCD display. The bold numbering is the grid power, the smaller numbering is the solar power (on a wet Monday afternoon) and the four temperature outputs are shown on the right hand side of the display. &quot;3600&quot; is the energy bucket and the black spot shows a net import of energy. This changes to a heating coil when the PV dump is running and a white ring when the tank is full of hot water.</p>
<p><img alt="" height="532" src="../../../i36.photobucket.com/albums/e28/fmfm20j/PC317600.jpg" width="710" /></p>
<p>All of the old features are retained: LED&#39;s that turn from red (importing) to green (net export) and a combination of the two when heating the water). The LED&#39;s turn off under low light conditions but maintain a heart beat each time data is received from the emonTX.</p>
<p>I have added a Nanode&nbsp;RF&nbsp;SMT to the hardware and have modified an existing sketch so as to take the emonTX data and route it through to emoncms. I have been working upon a dual transmitter to emoncms and to cosm&nbsp;but have yet to get this operational. Rather than continue I wanted to publish what I know works OK.</p>
<p>My feed is directed to emoncms and I have configured a dashboard as shown below.<i>&nbsp;</i>It&#39;s a promising New Years Day morning and my wife has been cooking breakfast. We can see the griddle on the oven pulsing on and off while the kettle is simultaneously boiling (my contribution to breakfast is making the tea). The displays at the top show real time visualisations of grid and solar power together with the energy bucket and the top and bottom temperatures of the water tank. The probes on the tank are not invasive so give only an indication of temperature rather than what will come out of the shower. Lets hope that the PV dumper increases the temperature of the water tank. 3 degrees C is the outside temperature on the front of the house.</p>
<p>I also have dials which show the grid and solar power for the day. These normally reset at midnight.</p>
<p><img alt="" src="../../../i36.photobucket.com/albums/e28/fmfm20j/emoncmsNewYearsDayBreakfast_zps630c91ac.jpg" style="width: 400px; height: 354px;" /></p>
<p>&nbsp;</p>
<p>The bottom of the display shows a zoom of grid and solar power on the left hand side and bar charts day by day on the right.</p>
<p>The cms display was written using the web site tool. If anyone is interested, there are probably ways to share the code or the framework of the tool.</p>
<p>&nbsp;</p>
<p>Shown below is the schematic. There is a minor modification from the previous one in that the IO lines for the red and greed LED&#39;s are switched around. The rest is as before.</p>
<p>&nbsp;</p>
<p><img alt="" height="459" src="../../../i36.photobucket.com/albums/e28/fmfm20j/emonTXadditions.jpg" width="728" /></p>
<p>Should you wish to add temperature sensors beyond the one in the GLCD, you can add them and simply plug them into the temperature sensor port. The software will look for up to three of them.</p>
<p>The emonTX sketch has undergone a huge amount of change: as I mentioned before, the measurement algorithm has been reworked so as to comply with the OEM published versions. It runs over a six second window with a minor jump out to sum the results and send them into the wireless network. The MKII sketch runs in the background and in tandem with the energy monitor.</p>
<p>I did some trials to speed up the code. I took it about as far as it would go without resorting to integer mathematics. If I am honest, I found that speeding the code (taking more samples per mains cycle) didn&#39;t make very much difference beyond a certain point. Just to be sure, I ran some trials in VBA&nbsp;using various amounts of under sampling of waveforms with varying amounts of distortion and my simulations yielded the same conclusion: it doesn&#39;t make that much difference, to my mind at least.</p>
<p>So, what we have is reasonably slim code which draws upon some of what Robin has done together with what else is needed to measure solar channels and the odd temperature here and there. We can turn off un required&nbsp;features such as LED displays, apparent power calculation, transmission to the GLCD, power displayed on the serial monitor, etc. if we want to make some bits quicker. Best to play around a bit and see what suits.</p>
<p>What else is in there?</p>
<p>This version of code includes a simulator whereby the user can generate voltage and solar and grid currents with any amplitude and phase offset. A useful tool to debug code without needing transformers or a solar energy system.&nbsp;</p>
<p>There is also a feature to sweep phasecal independently of the grid and solar channels. This is a useful feature to allow you to characterise the phase lead/lag or each channel and work out which one correlates best with your reference.</p>
<p>If you use the emoncms&nbsp;software there is a mode where fixed data can be sent from the emonTX&nbsp;to the base station (and on to the web) so as to allow you to unravel which node id is which.</p>
<p>I&#39;ve also added a feature which allows the solar offset error to be removed from the transmitted data. It&#39;s really tough to get accurate power measurements on each channel across a wide spectrum of power. What is accurate at one end may be off at the other. With this feature, power which is repeatable but below a certain threshold is considered an offset error and a solar power value of zero is transmitted in the RF.... a kind of additional switchable high pass filter.</p>
<p>There&#39;s a load of other stuff which helps with the debugging&nbsp;as well: seeing all samples captured, seeing the energy bucket content periodically and the raw power calculation results. Most of this probably&nbsp;wont be needed... but is there just in case.</p>
<p>In terms of accuracy, I have run this against the usual loops of wire</p>
<p><img alt="" src="../../../i36.photobucket.com/albums/e28/fmfm20j/coilsofwire.jpg" /></p>
<p>and plug in energy&nbsp;monitor. It stands up pretty well against both of these for resistive loads and equally well when the power factor drops with some garage machines. It isn&#39;t quite as good when clamped around the power cables on the consumer unit as it&#39;s still a little off compared to the enviR monitors. Perhaps a little more calibration is in order... another day!</p>
<p>&nbsp;</p>
<p>If somebody can show me how to make my cms dashboard public I will gladly share it!</p>
<p>Anyway, feel free to having a play, code should be included at the end...</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="1878.html" class="topic-previous" title="Go to previous forum topic">‹ How to add delay without using delay()</a>
              <a href="1822.html" class="topic-next" title="Go to next forum topic">Current Transformer position ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-8806"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 01/01/2013 - 10:48.</div>
    <div class="content">
     <p>Looks good Ian.</p>
<p>I had a similar issue with the hot water temperatures reading 15-20 degrees below the real water temperature when the sensors&nbsp;were on the outside of the tank. In the end I managed to get the sensors into the thermostat tubes for the immersion heaters and now they read correctly (I assume!). Only works if you have top and bottom immersion heaters though.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8809"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1399.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1399.jpg" alt="Series530&#039;s picture" title="Series530&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Tue, 01/01/2013 - 11:37.</div>
    <div class="content">
     <p>Hi Martin,</p>
<p>I&#39;d seen your post in that regard and took the immersion heater apart. It was a tough call to get anything down the tube of ours and we only have a single heater anyway. In the end I have attacked them to the outside of the tank with copper tape and then wrapped insulation over the top of them. It does something of a job and indicates a trend if nothing else.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8810"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1774.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1774.jpg" alt="PaulOckenden&#039;s picture" title="PaulOckenden&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1774.html" title="View user profile.">PaulOckenden</a> on Tue, 01/01/2013 - 12:39.</div>
    <div class="content">
     <p>Shame you couldn&#39;t get the Elster&nbsp;reader working. I&#39;d imagine a lot of us have that particular meter installed.</p>
<p>&nbsp;</p>
<p>P.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8812"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 01/01/2013 - 12:53.</div>
    <div class="content">
     <p>It was a bit of a squeeze, I think they are probably a standard size as all the thermostats seem to be the same. There was just enough room at the end of the tube for the DS18B20 so I attached 3 very thin wires that would just go between the thermostat and the outer tube.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8816"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1399.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1399.jpg" alt="Series530&#039;s picture" title="Series530&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Tue, 01/01/2013 - 15:52.</div>
    <div class="content">
     <p>Hi Martin,</p>
<p>I bought the external versions of the temperature monitors and this adds a metal cap and some water resistant wiring. I did consider pulling them apart but it would have been a cross fingers and hope that I didn&#39;t break them. Even then I would have had an issue dealing with the lower stat - no place to put the monitor.</p>
<p>&nbsp;</p>
<p>Hi Paul,</p>
<p>The fact that I could get the Elster working frustrates me just as much as it does you. Goodness knows I tried all kinds of ways. I was working with Dave Berkeley&#39;s Elster sketch and the moment I tried to un attach the interrupt on the reader it simply would not come back. Suggestions, if anybody has some, are very welcome.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8819"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 01/01/2013 - 21:02.</div>
    <div class="content">
     <p>Hi Ian,</p>
<p>To get the correct value for Power Factor, I think you need to change the voltage term in this line:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sqV= filteredV * filteredV;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //1) square voltage values</p>
<p>to the relevant phase-shifted equivalent.&nbsp; This will then be the same value as is used in your instP calculation.&nbsp;</p>
<p>This is a long-standing emonLib bug which has been recently highlighted on <a href="17052679.html?page=1">another thread</a>.&nbsp; The code in my <a href="../sites/default/files/PhasecalChecker.ino_.zip">phasecal checker tool </a>is correct in this regard.&nbsp; You should be able to use this tool on your current sensors to establish the optimal phasecal value for each of them.&nbsp;</p>
<p>For each sensor, there will hopefully be a phasecal value which gives a PF close to 1.0 when using the tool.&nbsp; With this same PC value, your standard sketch should display a similar PF value when a resistive load is applied.&nbsp; For this to occur, the same voltage term needs to be used throughout ;)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8828"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1399.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1399.jpg" alt="Series530&#039;s picture" title="Series530&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Wed, 02/01/2013 - 09:26.</div>
    <div class="content">
     <p>Thanks for that information Robin. It may explain a number of peculiarities that I have always seen and never quite figured out while running code from this site.&nbsp;</p>
<p>I have a phase cal checker tool built into my sketches. I just need to enable it and sweep through. it uses the same code as the measurement algorithm. It will be interesting to see what effect the correction has upon the results that they give.</p>
<p>BTW, I now have a simultaneous feed to emon cms and Cosm working and will update this and correct and retrial the VI sections of the sketches later today.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8931"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1095.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="nbown&#039;s picture" title="nbown&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1095.html" title="View user profile.">nbown</a> on Mon, 07/01/2013 - 12:37.</div>
    <div class="content">
     <p>It&#39;s working a treat, much closer for the figure i been seeing</p>
<p>&nbsp;</p>
<p>I&#39;m just going to try to add the temp output from the GLCD to the emoncsm</p>
<p>&nbsp;</p>
<p>Thanks again</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9001"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1399.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1399.jpg" alt="Series530&#039;s picture" title="Series530&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: New version of the Fusion sketch</h3>

    <div class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Wed, 09/01/2013 - 08:57.</div>
    <div class="content">
     <p>I enabled the option to measure KVA yesterday and sent the vrms value of the mains to emoncms. When I did this I discovered that my VCAL value was well off (I&#39;ve had KVA turned off for some time now so didn&#39;t notice the problem). &nbsp;I&#39;ve now corrected this cal value for my sketch and will continue to monitor it against a plug in energy monitor.</p>
<p>Correcting this error pulled the results in nicely - we&#39;re now within 2.6% of the enviR at 460W of grid power and about 4% when up around 3.5KW and this is broadly in line with what I expect to see. I may try a phasecal sweep at some point just to be 100% sure that I am using the right numbers.</p>
<p>&nbsp;</p>
<p>My emoncms dashboard can be seen here :&nbsp;http://emoncms.org/series530&amp;id=2542</p>
<p>&nbsp;</p>
<p>I have no idea how a user can pick up my feed information or integrate this into their own dashboards.</p>
<p>&nbsp;</p>
<p>I also decided to dump the link to cosm&nbsp;on the nanodeRF sketch. I was finding an occasional hang and the only way around it was a reboot by pulling the nanodeRF power. I&#39;ve reverted to using the GIThub sketch with a few mods for my apikey and some twinkly lights so that I can see what is happening.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1771"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-T_4NlmlDy7DYG6tin1Bw_DM8vlAKP_c7UxU0LQHdUy4" value="form-T_4NlmlDy7DYG6tin1Bw_DM8vlAKP_c7UxU0LQHdUy4"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/1771 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:18:28 GMT -->
</html>
