<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/6001 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:01:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>emonTx_CT123_Voltage 3phase_Master | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">emonTx_CT123_Voltage 3phase_Master</h3>
        <span class="submitted">Submitted by <a href="../user/3879.html" title="View user profile.">ziporah</a> on Tue, 28/10/2014 - 09:21</span>
        <div class="content"><p>Not sure whether to put it in hardware or software.</p>
<p>Has anyone dare to take on the challenge to alter the constant Wh reading sketch to support the 3phase hardware described in this thread :&nbsp;http://openenergymonitor.org/emon/node/1170 ?</p>
<p>I quickly ran over the code, but it will probably take me quite some time to get this sorted out.</p>
<p>I build this setup a while ago, since I have a 3 phase system and want to do separate readings of my circuitry.<br />
I&#39;ve got 3 voltage sensors and 9 CT&#39;s in place, measuring positive and negative values.&nbsp;I&#39;m currently struggling with the new emoncms ( I haven&#39;t updated in quite some time to be honest), trying to get&nbsp;the my-electric to work. It would be nice to have the total Wh also available with this hardware.</p>
<p>I used to have this&nbsp;configuration for monitoring different totals:</p>
<p>CT1_phase1 : log to&nbsp;feed_phase1<br />
Power to kwh/d : feed_phase1_kwhd<br />
histogram : feed_phase1_hist<br />
+input ct_1_phase2<br />
+input ct_1_phase3<br />
log to feed : feed_phase_all<br />
power to kwh/d : feed_phase_all_kwhd<br />
histogram : feed_phase_all_hist<br />
-input ct_2_phase2 (my solar inverter)<br />
log to feed : feed_real_power_used<br />
power to kwh/d : feed_real_power_used_kwhd<br />
histogram : feed_real_power_used_kwhd</p>
<p>This would provide me with the values and historical&nbsp;timegraphs. If I try to do the same with&nbsp;the new version of emoncms, I don&#39;t get right readings for feed_phase_all, even after trying to use the power to kwh and kwh to power functions. I guess that&#39;s where the accumulated&nbsp;Wh is being designed for, to use those metrics as a seperate input and create the functions there.</p>
<p>As a side question. Why is the voltage removed from the payload package ? I always found it very nice to have it monitored as with the PV invertors in our grid, the voltage fluctuates a lot here in Belgium and I really liked the ability to graph this.<br />
​</p>
  <div class="forum-topic-navigation clear-block">
          <a href="5955.html" class="topic-previous" title="Go to previous forum topic">‹ xbee with arduino</a>
              <a href="5942.html" class="topic-next" title="Go to next forum topic">Mounting DS18B20s on pipework ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-24845"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6952.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="bond79&#039;s picture" title="bond79&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTx_CT123_Voltage 3phase_Master</h3>

    <div class="submitted">Submitted by <a href="../user/6952.html" title="View user profile.">bond79</a> on Tue, 28/10/2014 - 14:26.</div>
    <div class="content">
     <p>I am not sure if you are asking about the sketch or the input setup in emoncms.</p>
<p>If it is the input setup, take a look at my input setup. I haven&#39;t used older emoncms versions so I don&#39;t know if anything changed on the calculations setup, but this works for me. I am not sure if it is necessary but I am resetting the values to zero and reload the feed/input value when I want to reuse it, after something else was calculated.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24848"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTx_CT123_Voltage 3phase_Master</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 28/10/2014 - 20:48.</div>
    <div class="content">
     <p>The hardware side:</p>
<p>I have not heard of anyone merging MartinR's 'Full Fat' 3-emonTx V2 sketches and Robin's 'continuous' sketch. I know both reasonably well, and I think it will not be simple because in Martin's original, he uses the serial link between the 3 units to start the conversion in all 3 at the same instant, then the master unit collects the result of the measurement. To do a similar thing with Robin's, you will have to run the ADC continuously, and use the serial link to interrupt the accumulation of the values, send the results to the master and zero the accumulators. You will need to be certain that you have enough spare time in the main loop of the slave units to send the data via the serial link in between processing the result of the ADC in the ISR, and in the master unit you need to receive that plus transmit the values for the 3 phases by radio.</p>
<p>Robin has never been interested in voltage, so none of his diverter sketches, on which the 'continuous' sketch is based, have ever calculated the rms voltage, all they have done is taken the instantaneous value and multiplied it by the current to get power, which is then averaged. You can of course add in the maths to obtain the rms voltage and then include it in the payload, but you will need to check that the processor load is not excessive.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24860"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3879.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="ziporah&#039;s picture" title="ziporah&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTx_CT123_Voltage 3phase_Master</h3>

    <div class="submitted">Submitted by <a href="../user/3879.html" title="View user profile.">ziporah</a> on Wed, 29/10/2014 - 09:33.</div>
    <div class="content">
     <p>Thanks for the reset to zero tip, I didn&#39;t think about using that to do the logic. This might come in handy.<br />
&nbsp;</p>
<p>Regarding the merge of both sketches. I&#39;m glad I saw the same troubles/issues you are describing Robert. At least my processing of the code was correct and indeed it will be quite a challenge to incorporate this in one sketch. I&#39;m not sure if it is worth the effort. I might be better of trying to build a shield for an arduino mega and do all the processing on one device. That will be quite a challenge too, but at least I won&#39;t need to be bothered with an additional sync between the&nbsp;seperate devices.</p>
<p>I found this contribution already :&nbsp;https://github.com/gysmovoile/emonTxFirmware/blob/master/emonTx_Interrupts/emonTX_Interrupts_EthernetAndLCD</p>
<p>So that might be a starting point, the code&nbsp;is still interrupt driven, so it will still take some work to fix it to continuous sampling. I&#39;ll first start processing the code and the forums to see what has to be done and then take a shot at it</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-24861"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTx_CT123_Voltage 3phase_Master</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 29/10/2014 - 11:06.</div>
    <div class="content">
     <p>A more powerful processor with more inputs might be a better approach. Do a search because I think it's been done before and you might find something useful.<br />
I'm not sure what you mean by <i>"the code is still interrupt driven, so it will still take some work to fix it to continuous sampling"</i>. Robin's 'continuous' sketch <b>is</b> interrupt-driven. If you have only one ADC, you will need to be very careful with timing especially as you will be measuring 12 values per cycle (3 currents + 1 voltage, all x 3).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/6001"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-5Wsv4b77T1DTXesvos9TGa-8AjazLpSj6GEf6TAWINc" value="form-5Wsv4b77T1DTXesvos9TGa-8AjazLpSj6GEf6TAWINc"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
