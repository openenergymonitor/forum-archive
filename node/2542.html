<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2542 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:28:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Advantages of using the ATMega32U4 (Leonardo) chip for power measurement | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>
        <span class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Thu, 04/07/2013 - 12:35</span>
        <div class="content"><p>Several people have pointed out that the Leonardo board has better analogue design than other Arduino boards but another advantage of this board is that it uses the ATMega32U4 chip. One advantage of this chip is that it has built-in USB capability, so there is no need for the FTDI adaptor, but it also has a much more flexible analogue-to-digital converter than the one used in the ATMega328.</p>
<p>The main improvements to the ADC are:</p>
<p><strong>1</strong>. differential input capability<br />
	<strong>2.</strong> programmable gain<br />
	<strong>3</strong>. 2.56V internal reference<br />
	<strong>4</strong>. high speed mode<br />
	<strong>5</strong>. more inputs</p>
<p>The big advantage of <strong>1</strong> is that it does away with the need for DC offset removal since the ADC directly outputs positive and negative values. It also means that the input bias circuitry is far less important since all it needs to do is ensure that the ADC inputs stay within the 0-Vcc range. There is no problem with sharing a simple resistive divider between all inputs. In differential mode the ADC input range is &ndash;AREF to +AREF.</p>
<p>The gain options are x1, x10, x40 and x200. This means that if x1 is chosen to measure the normal maximum current of 100A, then the other ranges provide maximum values of 10A, 2.5A and 0.5A respectively.</p>
<p>The advantage of <strong>3</strong> is that it does away with the need to use AVCC for the voltage reference and therefore the need to measure VCC when running on batteries. Using this reference in differential mode means that the peak-to-peak input voltage can theoretically be up to 5.12V regardless to the VCC supply voltage, although the inputs still have to remain within the 0-Vcc range.</p>
<p><strong>4</strong> allows the ADC clock to run at 250kHz without any loss of resolution (but with a slight increase in power consumption). This is significant because differential mode is slower than single-ended mode due to the need to allow time for the internal amplifier to settle after changing the input selection. With careful design it is still possible to measure voltage and current at 50 times per mains cycle though.</p>
<p>Apart from this reduction in speed, the other disadvantage of differential mode is some loss of resolution but that has to be considered in context. For example, at 200x gain the claimed resolution is 7 bits but this still represents significantly better voltage resolution than the current emon design. With AREF at 5V and 10-bit ADC resolution, each ADC step of the current design is 4.88mV. With the same AREF in differential mode with x200 gain and an effective resolution of 7 bits each ADC step is 195&micro;V, or a 25x improvement in sensitivity.</p>
<p>I have created a modified version of EmonLib, called EmonLibDiff which makes use of the ATMega32U4 differential modes. The voltage function is the same but the pin options are only 0-3 and 5 as A4 is used as the negative input to the differential amplifier. The value for PHASECAL will also be slightly different due to timing changes. The current function has an additional gain parameter which may be 1,10,40 or 200 and here the pin options are restricted to 0-3. <strong>This library will only work with the ATMega32U4 chip.</strong></p>
<p>Apart from the need to add an analogReadDiff() function, the library is simpler than the standard one due to the removal of the high pass filters.</p>
<p>I have modified the library current only and voltage+current examples to work with the differential library, and I have also included an example of auto-ranging current only measurement.</p>
<p>Using this library it is possible to build a current-only power meter using only a Leonardo board, a CT and a single resistor as shown here..</p>
<p><img alt="" src="../sites/default/files/one_resistor_power_meter.png" style="width: 357px; height: 233px;" /></p>
<p>By connecting the negative amplifier input to the 2.56V of AREF we can keep the input roughly centred without using any components.&nbsp; It&rsquo;s also possible to build a current and voltage version using just 3 resistors.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2556.html" class="topic-previous" title="Go to previous forum topic">‹ directly connect emonbase ed emontx</a>
              <a href="2531.html" class="topic-next" title="Go to next forum topic">Data from RPI RFM12B ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-13393"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 04/07/2013 - 13:23.</div>
    <div class="content">
     <p>Without using any of the new features, were you able to get a feel for whether or not the LC decoupling on AVCC made much difference to the noise levels?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13399"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Thu, 04/07/2013 - 15:47.</div>
    <div class="content">
     <p>I didn&#39;t try the Leonardo in single-ended mode but my guess is that it won&#39;t make much difference. I did try adding an inductor in series with the AVCC feed on a shop board and I couldn&#39;t detect any improvement.</p>
<p>You are always going to get some toggling of the LSB and for a standard emonTx the LSB permanently on would look like 86W so it doesn&#39;t take that many toggles to get the few Watts that you normally see.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13427"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/07/2013 - 01:17.</div>
    <div class="content">
     <p><em>By connecting the negative amplifier input to the 2.56V of AREF we can keep the input roughly centred without using any components.</em></p>
<p>Are you sure that&#39;s allowed? &nbsp;I think they run the internally selected Vref out to AREF so you can stick a capacitor on it for decoupling, but generally it&#39;s a very high impedance source, so I don&#39;t think you can load it up with anything.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13429"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/380.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-380.jpg" alt="mharizanov&#039;s picture" title="mharizanov&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/380.html" title="View user profile.">mharizanov</a> on Fri, 05/07/2013 - 06:27.</div>
    <div class="content">
     <p>That is interesting, with the&nbsp;YHDC 30 A c.t. that has internal burden resistor, it would mean current measurement with no external components at all :)</p>
<p>I am subscribing to the topic</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13430"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Fri, 05/07/2013 - 06:57.</div>
    <div class="content">
     <p>dBC:<em> Are you sure that&#39;s allowed?&nbsp; I think they run the internally selected Vref out to AREF so you can stick a capacitor on it for decoupling, but generally it&#39;s a very high impedance source, so I don&#39;t think you can load it up with anything</em>.</p>
<p>It&#39;s not ideal, due to the risk of adding noise to AREF, but there is no load since the CT is isolated and therefore floating wrt AREF so you only have the tiny input&nbsp;current of the analogue inputs. I&#39;ve tried this with both current only and current+voltage and it seems to work fine, only showing about 1.5W of noise in x200 mode.</p>
<p>mharizanov:&nbsp;&nbsp;<em>That is interesting, with the YHDC 30 A c.t. that has internal burden resistor, it would mean current measurement with no external components at all :)</em></p>
<p>Even better - I like your thinking :)</p>
<p>It would be interesting to repeat the accuracy tests with this CPU since using auto-ranging it can accurately measure down to a few Watts and all the way up to 25kW.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13431"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/07/2013 - 07:12.</div>
    <div class="content">
     <p><em>so you only have the tiny input current of the analogue inputs.</em></p>
<p>Wouldn&#39;t they be high enough to potentially drag down AREF, right when you want it at its most stable? &nbsp; &nbsp;For best results you tend to need to drive them from a fairly low impedance source (&lt; 10K ohms from memory).</p>
<p>And I know the 2560 datasheet says if you want to measure the bandgap voltage at AREF use a high impedance voltmeter.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13443"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Fri, 05/07/2013 - 13:56.</div>
    <div class="content">
     <p>We are driving the inputs with a low impedance, 33 Ohm, but this is irrelevant anyway as the 10k recommendation only applies to single-ended inputs, when the pin is driving the sample and hold directly. In differential mode the internal amplifier is driving the sample and hold so the external driving impedance can be much higher.</p>
<p>The impedance seen by AREF is much higher too, just the analogue inputs to the internal amplifier, and I&#39;m sure these qualify as &quot;a high impedance voltmeter&quot;.</p>
<p>This is a very minor issue anyway. The reason for this thread was to promote discussion of&nbsp;the merits of having an ADC with differential inputs and gain. The suggestion of using AREF to bias the inputs was just to say it was possible and it works. It&#39;s just as easy to bias all the inputs with a single pair of resistors.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13444"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/07/2013 - 17:08.</div>
    <div class="content">
     <p><em>In differential mode the internal amplifier is driving the sample and hold so the external driving impedance can be much higher.</em></p>
<p>Yep, but still not that high, according to the datasheet:</p>
<p><em>If differential gain channels are used, the input circuitry looks somewhat different, although<br />
	source impedances of a few hundred k&Omega; or less is recommended.</em></p>
<p>&nbsp;</p>
<p><em>The impedance seen by AREF is much higher too, just the analogue inputs to the internal amplifier, and I&#39;m sure these qualify as &quot;a high impedance voltmeter&quot;.</em></p>
<p>I would imagine that depends on their amplifier. &nbsp;I used to think the 8M input impedance on my voltmeter classified as a high impedance voltmeter, until I went to measure the output of a pH probe with it. &nbsp;You really need an op-amp with JFET-inputs to measure one of them. &nbsp; &nbsp;The datasheet quote above makes me think their op-amp inputs aren&#39;t hugely high impedance. &nbsp; And that they specifically call out for a <strong>high impedance</strong> voltmeter to be used when measuring AREF makes me think it has very little ability to drive.</p>
<p>&nbsp;</p>
<p><em>It&#39;s just as easy to bias all the inputs with a single pair of resistors.</em></p>
<p>Exactly. &nbsp;Personally, for the cost of 2 resistors I&#39;d be staying well away from AREF. &nbsp;I think your design above is well outside the intended purpose of AREF, but your mileage may vary.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13451"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/07/2013 - 23:42.</div>
    <div class="content">
     <p>Actually, the datasheet is pretty clear:</p>
<p><em>Note that Vref is a high&nbsp;impedant source, and only a capacitive load should be connected in a system.</em></p>
<p>My reading of that is that it&#39;s &quot;for internal use only&quot;. &nbsp;They&#39;ve run it out to a pin so you can decouple it for them, but putting any load on it could at the very least degrade the A/D performance, and worst case, potentially damage the device over time. &nbsp; Putting a high impedance voltmeter on it in the lab while debugging is a lot different from permanently wiring it into an op-amp input.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13453"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 06/07/2013 - 01:10.</div>
    <div class="content">
     <p><em>They&#39;ve run it out to a pin so you can decouple it for them </em>because they can&#39;t fabricate an on-chip capacitor big enough,</p>
<p>FTFY.</p>
<p>I guess you&#39;d be OK to bootstrap it though.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13456"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sat, 06/07/2013 - 07:14.</div>
    <div class="content">
     <p>I was hoping this thread would provoke a debate about the merits of using a chip that does away with the need for high-pass filters, measuring battery voltage and the FTDI adaptor and solves the issue of measuring a wide power range, rather than nitpicking about an idle comment at the end of the post!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13459"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 06/07/2013 - 11:49.</div>
    <div class="content">
     <p><em>&quot;... the merits of using a chip that does away with the need for high-pass filters, measuring battery voltage and the FTDI adaptor and solves the issue of measuring a wide power range.&quot;</em></p>
<p>I thought that was self-evident. But from the OEM Shop&#39;s point of view, I can see that developing a brand new design and getting the manufacturing process under way is not trivial, and let&#39;s not lose sight of the fact that for many people - even the minority (but growing minority, I suspect) who are keen to monitor energy usage, a good indication is often good enough. The various energy suppliers&#39; schemes, devices that estimate energy purely from a measurement of current, etc are witness to that. The OEM / Arduino design is clearly better than much that is on offer, equally clearly improvement in the design and the choice of transducers is possible.</p>
<p>Glyn was working on an emonTx with switched gain current inputs (exactly like the Atmel prototype) but that seems to be on the back burner for now. Maybe that design should mutate and evolve and G&amp;T (and you!) should be thinking in terms of an EmonTxPro, with improved performance, more accurate transducers and ready expansion to suit the North American mains supply?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13464"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sat, 06/07/2013 - 16:57.</div>
    <div class="content">
     <p>From what I remember of Glyn&#39;s design it used external amplifiers and analogue switches and was deemed too costly to build and consequently was shelved, as you say,&nbsp;in favour of a cheaper alternative. I don&#39;t know if Glyn was aware of the enhancements to the ADC in the ATMega32U4 chip but maybe he could have used that in his design instead and produced a cheaper, simpler&nbsp;solution with similar features. The whole point in suggesting the ATMega32U4 is that it is a minimal cost increase over the SMD version of the ATMega328 and probably a cost saving if you take into account the cost of the FTDI adaptor.</p>
<p>I searched this site and couldn&#39;t find any mention of the ADC enhancements so it was reasonable for me to assume that they weren&#39;t being considered for future designs and so it would be worthwhile discussing them.</p>
<p>Anyway, I&#39;ve learned my lesson and will keep my ideas to myself in future.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13465"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 06/07/2013 - 17:43.</div>
    <div class="content">
     <p><em>&quot;Anyway, I&#39;ve learned my lesson and will keep my ideas to myself in future.&quot;</em>&nbsp; I don&#39;t see why you should be thinking that. I at least recognise that you&#39;ve made significant contributions with the 3-phase monitor that I&#39;ve pointed many people towards, and the interrupt-driven code, and I think a super-emonTx would certainly fill a niche amongst the members of the community who need something better than the standard version, especially at low powers where noise and resolution are significant problems. Without knowing too many details, I see no reason why it could not replace the emonTx V2, even though the V3 goes some way towards alleviating this by having a 4th low-current input. All I was saying is the V2 has got lots of momentum behind it.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13468"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 07/07/2013 - 05:17.</div>
    <div class="content">
     <p><em>Anyway, I&#39;ve learned my lesson and will keep my ideas to myself in future.</em></p>
<p>But then you wouldn&#39;t have learned you&#39;re not allowed to hang stuff off AREF ;-).</p>
<p>But seriously, there are lots of different designs floating around in here. &nbsp;Some use AVRs, some use PICs, some use various versions of the s/w published here, while some of us use dedicated front-end energy metering ICs. &nbsp;The more we all share our experiences, the better everyone&#39;s design becomes.</p>
<p>I&#39;ve just been playing around with &quot;AVR121: Enhancing ADC resolution by oversampling&quot; with stunning results. &nbsp; I&#39;ve now got my 2560 ADC effectively giving me 14-bit conversions. &nbsp;The ADC in the 2560 seems similar to the one in your Leonardo, but with less gain options. &nbsp;It helps that I only use it to measure very slow moving values (rainwater tank levels), and I&#39;ve got all the time in the world to oversample&nbsp;because all the time-sensitive stuff is done in dedicated ICs.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13470"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sun, 07/07/2013 - 11:36.</div>
    <div class="content">
     <p><em>But then you wouldn&#39;t have learned you&#39;re not allowed to hang stuff off AREF ;-).</em></p>
<p>Yeah, right, I can read you know! When interpreting data sheets, or any other set of rules for that matter, you need to understand the reason behind the requirement to see if it&#39;s applicable&nbsp;to your particular case. Here we&#39;re dealing with a high impedance signal that Atmel don&#39;t want you to put any significant load onto and probably don&#39;t want to have to constrain any future designs to a particular impedance, so they don&#39;t specify one. Clearly there is an acceptable load impedance which will not disturb the reference though</p>
<p>Just for you I tried measuring a 1.5V battery against the 2.56V reference while adding and removing the connection to A1 It made no difference to the ADC value and nor did measuring the reference with my Fluke multimeter, so the impedance can&#39;t be that high.</p>
<p><em>But seriously, there are lots of different designs floating around in here.&nbsp; Some use AVRs, some use PICs, some use various versions of the s/w published here, while some of us use dedicated front-end energy metering ICs.&nbsp; The more we all share our experiences, the better everyone&#39;s design becomes.</em></p>
<p>Yes I agree, but most people who have posted details of anything novel have drifted away either because there were no responses to their thread or due to derogatory comments from the keyboard warriors.</p>
<p><em>I&#39;ve just been playing around with &quot;AVR121: Enhancing ADC resolution by oversampling&quot; with stunning results.&nbsp;&nbsp; I&#39;ve now got my 2560 ADC effectively giving me 14-bit conversions.&nbsp; The ADC in the 2560 seems similar to the one in your Leonardo, but with less gain options.&nbsp; It helps that I only use it to measure very slow moving values (rainwater tank levels), and I&#39;ve got all the time in the world to oversample because all the time-sensitive stuff is done in dedicated ICs</em>.</p>
<p>Yes, I looked at that too but, as you say, only useful for slowly varying signals.</p>
<p>Robert - my comment wasn&#39;t in direct response to your post. You&#39;ve been incredibly helpful to me, and almost everyone else on here, and I&#39;ve learned a lot from you, for which I&#39;m very grateful. I think it&#39;s just finally dawned on me that this site is really just supporting the shop products and there&#39;s next to no real interest in pushing the boundaries, which is where my interest lies.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13471"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3903.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="michal&#039;s picture" title="michal&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3903.html" title="View user profile.">michal</a> on Sun, 07/07/2013 - 12:10.</div>
    <div class="content">
     <p>Please don&#39;t stop trying to push the boundaries.</p>
<p>Although I&#39;m only a beginner to electronics and energy monitory, my expectations lie beyond the boundaries (you could say I&#39;m slightly OCD) and any attempt to further accuracy, simplicity or performance of energy monitoring is highly appreciated.</p>
<p>I&#39;m sure there are many other like me who also share their appreciation. Challenging accepted ideas always draws opposition, but it&#39;s also one of the best ways of making significant progress.</p>
<p>Thank you for your contributions Martin, and please don&#39;t be discouraged or offended. I&#39;m sure most people are just playing devils&#39;&nbsp;advocate and wanting you to prove them wrong.</p>
<p>Regards,</p>
<p>Michal</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13473"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 07/07/2013 - 12:20.</div>
    <div class="content">
     <p><em>Clearly there is an acceptable load impedance which will not disturb the reference though</em></p>
<p>Sure, but as you say it&#39;s undocumented. &nbsp;And the input impedance of the op-amp is barely documented. &nbsp;There&#39;s also the risk of introducing noise as you conceded above. &nbsp; &nbsp;Your experiments suggest neither issue is a big problem in this case, but designs based on empirical &quot;I tried it and it works fine&quot; &nbsp;often turn out to be less robust in all the varying real-world environments they&#39;re likely to end up in. &nbsp;Sticking to the datasheet rules even when you understand the reason behind them, is best practice, particularly so in this case when the win (2 less resistors) seemed so trivial compared to the potential risks.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13474"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sun, 07/07/2013 - 13:03.</div>
    <div class="content">
     <p>Thanks, Michal that was a thoughtful and well-worded post, much appreciated.</p>
<p>dBC: You are in danger of becoming a keyboard warrior yourself with your patronising tone and constant desire to argue about a trivial side issue. I&#39;ll let you have the last word if that makes you happy but I&#39;ll leave you with this old cartoon since you reminded me of it....</p>
<p><img alt="" src="../../../imgs.xkcd.com/comics/duty_calls.png" style="width: 300px; height: 330px;" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13475"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 07/07/2013 - 13:08.</div>
    <div class="content">
     <p>Thank you for that vote of thanks!&nbsp; <em>&quot;I think it&#39;s just finally dawned on me that this site is really just supporting the shop products and there&#39;s next to no real interest in pushing the boundaries...</em>&quot;&nbsp; I think I understand why you think that, but isn&#39;t Robin&#39;s Mk2 a most notable exception? (OK, it <em>can</em> be made with an emonTx, but the original was an Arduino.) I remain unconvinced that a schematic, parts list and maybe a pcb for the super-emonTx written up in the same format would receive no attention, especially as it would be almost automatically directly plug-in compatible with everything downstream (RPi, emonCMS), and it shouldn&#39;t involve much learning for anyone who wanted to use it or modify the code.</p>
<p>I think what you&#39;re looking at is a matter of fear of the unknown and confidence. Anyone coming to this site will see the shop kit products and in most cases evaluate them as a proven, easy to build system that will work. Irrespective of facts, they perceive a design by an individual in a post as carrying some risk, possibly requiring knowledge and expertise they don&#39;t have and requiring effort to source all the parts, and it is that which you need to overcome, and where a full write-up will help. I&#39;m happy to edit and nit-pick to present it in the best light if you want.</p>
<p>[Edit]</p>
<p>dBC posted while I was writing that. Though I&#39;m generally with him on following data-sheet practice, one notable exception springs to mind. I understand that the very first Sinclair calculator (anyone remember that) used and exploited a function in the chip that his designers had discovered and the chip designers/manufacturer knew nothing about! (I forget the details, but I think I&#39;ve got one in a box somewhere if anyone wants to play.)</p>
<p>So pushing the boundaries can work to your advantage in a spectacular manner.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13476"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 07/07/2013 - 13:17.</div>
    <div class="content">
     <p><em>You are in danger of becoming a keyboard warrior yourself</em></p>
<p>I&#39;m sorry you feel that way.</p>
<p><em>constant desire to argue about a trivial side issue.</em></p>
<p>My only concern was that it was going to catch on as a good idea as indicated below:</p>
<p><em>mharizanov:&nbsp; That is interesting, with the YHDC 30 A c.t. that has internal burden resistor, it would mean current measurement with no external components at all :)</em></p>
<p><em>MartinR: Even better - I like your thinking :)</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13478"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 07/07/2013 - 13:48.</div>
    <div class="content">
     <p>Come on chaps. Bury the hatchet and preferably not in each other&#39;s skulls. If it&#39;s been shown that in the circumstances it&#39;s not an issue, isn&#39;t that what matters? I&#39;m quite prepared to bet that Atmel want to keep their options open to change the design internally that might result in a lower output capability, and that&#39;s their reason for specifying &#39;capacitor only&#39;. Or maybe they&#39;re worried about squirting noise in?</p>
<p>If you want to accept the risk that at some time in the future it will fail to work, or degrade performance unacceptably, or maybe reduce the life of the chip, then that&#39;s a valid engineering compromise decision that needs to be made; and if you do go ahead and use it, then (if it&#39;s a published design) you need to warn people or make periodic checks and change the design if it becomes an issue. And if it&#39;s just for yourself, you live with it until it dies.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13481"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3903.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="michal&#039;s picture" title="michal&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3903.html" title="View user profile.">michal</a> on Sun, 07/07/2013 - 14:33.</div>
    <div class="content">
     <p>Perhaps the solution here shouldn&#39;t become the defacto product, but what are we really risking here? Potentially less than 10 dollars? It just so happens I have a couple of Teensy 2.0&#39;s that would be ideally suited.</p>
<p>If you want to add resistors or capacitors then that&#39;s fine too. To each his own.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13494"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Advantages of using the ATMega32U4 (Leonardo) chip for power measurement</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 07/07/2013 - 22:19.</div>
    <div class="content">
     <p>Fair points. &nbsp;When I&#39;m at 38,000&#39; in an A380&nbsp;I hope the engineers didn&#39;t take any liberties with the datasheets, but to apply the same standards to the home hobbyist market is pretty silly. &nbsp;The &quot;risks&quot; I&#39;ve been banging on about are pretty trivial, thanks for the perspective Robert and Michal.</p>
<p>Apologies MartinR. &nbsp;I fear I crossed the line from design reviewer to evangelical preacher. &nbsp;You&#39;ve clearly made an informed design decision, and that should have been the end of it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2542"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-0QjtL-2QOzsPod1YVSUBrX6_NNqHdTgXmQBZ8csQJ5k" value="form-0QjtL-2QOzsPod1YVSUBrX6_NNqHdTgXmQBZ8csQJ5k"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
