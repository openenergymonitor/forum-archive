<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/376 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:42:20 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Pachube emonBase dont work | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Pachube emonBase dont work</h3>
        <span class="submitted">Submitted by Guest on Thu, 26/01/2012 - 19:52</span>
        <div class="content"><p>The pachube emonBase sketch dont work.</p>
<p>It sends readings alright but doesnt do anything when the internet crashes. Is it suposed to restart when theres a problem?</p>
<p>&nbsp;</p>
<p>Great site by the way.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="934.html" class="topic-previous" title="Go to previous forum topic">‹ Emoncms3 language issue</a>
              <a href="905.html" class="topic-next" title="Go to next forum topic">Multi hop Repeater  ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-2875"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Thu, 26/01/2012 - 21:33.</div>
    <div class="content">
     <p>&nbsp;Hi Baz,</p>
<p>The Pachube example is very much in a alpha stage of development as stated in the github readme.&nbsp;</p>
<p>It will only self reset if using the 'Uno' bootloader and if #define uno is active. If using the duemilanove bootloader you should comment out #define uno to disable the reset watchdog.&nbsp;</p>
<p>There are some issues with phasing the http responce from pachube, ongoing thread here:&nbsp;<a href="363.html">http://openenergymonitor.org/emon/node/363</a></p>
<p>Please send us a git pull request if you get it working. Our developments are mainly focused with posting to our own open-source energy web-app emoncms. The emonBase example for posting to emoncms are more developed.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2910"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Tue, 31/01/2012 - 00:00.</div>
    <div class="content">
     <p>&nbsp;There have been many discussions lately regarding emonBase Nanode/NanodeRF instability.</p>
<p>To constructively try and move forward, lets create a knowledge base of setups that are stable Vs. setups which are not. Hopefully this will help us to debug this issue and give us a framework in which to discuss problems.</p>
<p>See forum thread:&nbsp;<a href="../emonbase/stability.html">http://openenergymonitor.org/emon/emonbase/stability</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2932"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Tue, 31/01/2012 - 14:57.</div>
    <div class="content">
     <p>I think line 108 should be changed to be: <br />
get_header_line(1,off);      // Get the date and time from the header<br />
if (strcmp(line_buf,&quot;HTTP/1.1 200 OK&quot;)) {Serial.println(&quot;ok recieved&quot;); request_attempt = 0;}</p>
<p>Since the reply from Pachube is:</p>
<p>HTTP/1.1 200 OK<br />
Date: Tue, 31 Jan 2012 13:04:36 GMT<br />
Content-Type: text/plain; charset=utf-8<br />
Connection: close<br />
X-Pachube-Logging-Key: logging.xxxxxxxxxxxxxxxxxxxxxxxxx<br />
X-PachubeRequestId: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br />
Cache-Control: max-age=0<br />
Content-Length: 1<br />
Age: 0<br />
Vary: Accept-Encoding</p>
<p>Please report experiances.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2937"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Tue, 31/01/2012 - 19:07.</div>
    <div class="content">
     <p>&nbsp;I tried this (as suggested by Trystan) here&nbsp;<a href="363.html">http://openenergymonitor.org/emon/node/363</a>&nbsp;but it had no effect whatsover, with nothing, errors or otherwise, &nbsp;being reported via the serial monitor.</p>
<p>The serial monitor still continued to post it's normal HTTP/1.1 200 OK ect response, but nothing further.</p>
<p>It's almost as if the my_callback command is not being called correctly via the line;<br />
<span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 11px; line-height: 15px; text-align: left; background-color: rgb(238, 238, 238); ">website, PSTR(FEED), website, PSTR(APIKEY), stash.size(), sd,&nbsp;</span><strong style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 11px; line-height: 15px; text-align: left; background-color: rgb(238, 238, 238); ">my_callback</strong><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 11px; line-height: 15px; text-align: left; background-color: rgb(238, 238, 238); ">);</span></p>
<p><span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 11px; line-height: 15px; text-align: left; background-color: rgb(238, 238, 238); "><br type="_moz" /><br />
</span></p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3119"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andygodber&#039;s picture" title="Andygodber&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Andygodber (not verified) on Sun, 12/02/2012 - 15:39.</div>
    <div class="content">
     <p>&nbsp;Another type of error?</p>
<p>Using the existing sketch on Gihub, I can successfully post to Pachube, and have ammended it to post my import/export reading, PV generated, and a calculated consuming.</p>
<p>However, after a &quot;while&quot; the feed stops being accepted, Errror 400 and &quot;<span style="font-size: 14px; ">CSV Parser Error: CSV is invalid. Incorrect number of fields.&quot;. No further posts are then accepted until a reboot of the Nanode.</span></p>
<p>When I say a &quot;while&quot;, it is a matter of a few minutes (2-10). Ive tried varying the rate at which I post to Pachube, and a shorter post interval makes the Error 400 quicker, but posting at 2 per minute still fails eventually.</p>
<p>Any thoughts? Ive also noticed that the my_callback routine doesnt actually seem to get called, even with it added to the end of the Stash. Am I right? (Nanode5).</p>
<p>&nbsp;</p>
<p>Ive copied the serial output below, where it goes bad, with a couple of good posts before it./</p>
<p>&nbsp;</p>
<p>﻿</p>
<p>RF recieved 1050.00Generating:120.60,ImpExp:1050.00,Consuming:1170.60</p>
<p>REQUEST: 200</p>
<p>PUT <a href="http://api.pachube.com/v2/feeds/42644.csv" title="http://api.pachube.com/v2/feeds/42644.csv">http://api.pachube.com/v2/feeds/42644.csv</a> HTTP/1.0</p>
<p>Host: api.pachube.com</p>
<p>X-PachubeApiKey: p26blah0ZOSnlvaz0g</p>
<p>Content-Length: 32</p>
<p>&nbsp;</p>
<p>0,120.60</p>
<p>1,1050.00</p>
<p>2,1170.60</p>
<p>&nbsp;</p>
<p>RF recieved 1054.18Generating:120.60,ImpExp:1054.18,Consuming:1174.78&yuml;&yuml;&yuml;&yuml;&yuml;&yuml;</p>
<p>RF recieved 1045.76Generating:120.60,ImpExp:1045.76,Consuming:1166.361&quot;</p>
<p>RF recieved -113.23Generating:113.23,ImpExp:1045.76,Consuming:1158.99&yuml;&yuml;&yuml;&yuml;&yuml;&yuml;</p>
<p>REQUEST: 200</p>
<p>PUT <a href="http://api.pachube.com/v2/feeds/42644.csv" title="http://api.pachube.com/v2/feeds/42644.csv">http://api.pachube.com/v2/feeds/42644.csv</a> HTTP/1.0</p>
<p>Host: api.pachube.com</p>
<p>X-PachubeApiKey: p26n0blahxd0ZOSnlvaz0g</p>
<p>Content-Length: 32</p>
<p>&nbsp;</p>
<p>-PachubeRequestId: 9c2742324e805</p>
<p>RF recieved -113.48Generating:113.48,ImpExp:1045.76,Consuming:1159.241&quot;</p>
<p>RF recieved -112.91Generating:112.91,ImpExp:1045.76,Consuming:1158.67</p>
<p>REQUEST: 200</p>
<p>PUT <a href="http://api.pachube.com/v2/feeds/42644.csv" title="http://api.pachube.com/v2/feeds/42644.csv">http://api.pachube.com/v2/feeds/42644.csv</a> HTTP/1.0</p>
<p>Host: api.pachube.com</p>
<p>X-PachubeApiKey: p26n0BsblahYxd0ZOSnlvaz0g</p>
<p>Content-Length: 32</p>
<p>&nbsp;</p>
<p>o1xEVp</p>
<p>X-PachubeRequestId: 3013</p>
<p>REPLY:</p>
<p>HTTP/1.1 400 Bad Request</p>
<p>Date: Sun, 12 Feb 2012 15:26:01 GMT</p>
<p>Content-Type: text/plain; charset=utf-8</p>
<p>Connection: close</p>
<p>X-Pachube-Logging-Key: logging.y2Vp42Z0ldzaxso1xEVp</p>
<p>X-PachubeRequestId: ddfd528beeab90bea6f891d55f77058d481b1074</p>
<p>Cache-Control: no-cache</p>
<p>Content-Length: 61</p>
<p>Age: 0</p>
<p>&nbsp;</p>
<p>CSV Parser Error: CSV is invalid. Incorrect number of fields.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3121"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="igordutra&#039;s picture" title="igordutra&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by igordutra (not verified) on Sun, 12/02/2012 - 19:11.</div>
    <div class="content">
     <p>Hi Andy</p>
<p>I had pretty much the same problem which seems to be pretty much fixed by resetting the flags every now and then (or rebooting the nanode) - so far 5 days without a single crash here. It also seems UNO bootloader is a bir safer to run than the original nanode's duemilanove.&nbsp;</p>
<p>Check out this post for further details:</p>
<p><a href="363.html#comment-2993">http://openenergymonitor.org/emon/node/363#comment-2993</a></p>
<p>Igor</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3128"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andygodber&#039;s picture" title="Andygodber&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Andygodber (not verified) on Mon, 13/02/2012 - 18:43.</div>
    <div class="content">
     <p>&nbsp;ok, so Ive flashed the Nanode5 with the Opti bootloader, and uploaded the sketch again.</p>
<p>Still no joy - there seems to be a fundamental problem that the my_callback routine is never called. (despite adding it to the end of the line : website, PSTR(FEED), website, PSTR(APIKEY), stash.size(), sd, my_callback)</p>
<p>As a result, request_attempt never gets reset to zero, and therefore always does a reset when the count (currently 10) is exceeded.</p>
<p>Ive put a print statement in the callback, and it never prints, so i know its not being called.</p>
<p>Am I missing something basic?</p>
<p>(At least if I set the counter to a reasonable value, I know I will always reset, but thats not the right answer).</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3129"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Mon, 13/02/2012 - 19:09.</div>
    <div class="content">
     <p>&nbsp;Andy, I found exactly the same and asked the question about it being called in <a href="376.html#comment-2937">my post (above)</a>.&nbsp;</p>
<p>I'm probaby showing my lack of programming skills here, but it seems to me that the my_callback 'call' is rolled into the stash, which although is posted OK over the ethernet, does not call and run the local routine.</p>
<p>I also replaced the functions within my_callback with a Serial.print, which as you have also noticed does not print!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3130"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andygodber&#039;s picture" title="Andygodber&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Andygodber (not verified) on Mon, 13/02/2012 - 19:36.</div>
    <div class="content">
     <p>&nbsp;Yes, the code never seems to get run locally - I tried setting some other variables, and printing them both in and outside of the routine - they're never set.</p>
<p>&nbsp;</p>
<p>So Im wondering how the guys in the main thread (<strong>fjhug, Igor</strong>) are able to use other methods, as request_attempt never gets set??</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3132"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Mon, 13/02/2012 - 20:28.</div>
    <div class="content">
     <p>&nbsp;I don't think that they are getting automatically reset. <a href="376.html#comment-3121">Igor comments above</a> that he 'resets the flags every now and then', so they don't appear to be working as per the sketch.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3133"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andygodber&#039;s picture" title="Andygodber&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Andygodber (not verified) on Mon, 13/02/2012 - 20:27.</div>
    <div class="content">
     <p>&nbsp;Did we ever get to the cause of the actual problem?</p>
<p>Is it the code in the Nanode (Ethernet most likely?) causing a corruption? Im sure its programatic, as, if I had the patience to count, I thinks it vaguely related to the number of posts.</p>
<p>If I 'spam' Pachube with a post every second, I get the &quot;400 Error&quot;s approximately twice as quick as if I post every 2 seconds. The longer the distance between posts, the longer it take to get the error etc.&nbsp;</p>
<p>If I have time tomorrow, I might sit and count......</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3134"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Mon, 13/02/2012 - 20:39.</div>
    <div class="content">
     <p>&nbsp;From my experience, the problems arise when the Pachube api server develops a problem, and the Nanode doesnt seem to be able to reconnect without a reboot.</p>
<p>I have confirmed this by searching for frozen feeds via the Pachube website when my Nanode crashes, and on each occassion I have found loads of other feeds which have frozen at exactly the same time.&nbsp;</p>
<p>I contacted Pachube about this, and they confirmed to me that they are having intermittent server problems, and are in the process of migrating their data over to a new dedicated server to increase reliability and reduce downtime.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3135"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Tue, 14/02/2012 - 00:49.</div>
    <div class="content">
     <p>&nbsp;I'll setup a project on PacHube in the next few weeks, using NanodeRF.</p>
<p>The&nbsp;<strong>my_callback</strong> function is called when the request returns. I'll try to dig a bit to see why the request wouldn't return.</p>
<p>I'll log the server reply from PacHube to see if it can be part of the problem. I had no issue posting to emoncms (local and beta). It might be that the condition to reset the&nbsp;request_attempt is different on emoncms than on PacHube. I'll try to implement processing the http status code from get_header_line(1,off); in my_callback, with the actual reply data coming back from the request, and update error flags accordingly.</p>
<p>I'll keep the post updated as I go along...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3212"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andygodber&#039;s picture" title="Andygodber&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Andygodber (not verified) on Fri, 17/02/2012 - 13:03.</div>
    <div class="content">
     <p>&nbsp;Fails at 120 ish posts.</p>
<p>Ok, so Ive been trying to do more debugging.</p>
<p>Just to recap the position :</p>
<p>1.I can post virtually error free to EmonCMS, both locally and hosted.</p>
<p>2. The Pachube sketch works fine for a bit, but then starts returning Error 400 (which is not documented by Pachube) and various incorrect field format errors in the sketch serial output.</p>
<p>3. I had wondered if I was trying to flood Pachube, but the allowable rate is 100 per minute.</p>
<p>4. The SD_Callback function doesnt seem to work, so I used a the coded reset after so many posts.</p>
<p>I tried to determine what the number of posts or time was, when the errors occured, in case there was a correlation.</p>
<p>It doesnt seem as though there is any dependancy on how often (frequency) of posting is, any reasonable time frame.</p>
<p>However, whether I post at 60 per minute or 6 per minute, the errors occur after about 120 posts (range observed 110-140). Ive determined this simply by incrementing request_attempts, display it, and observing both the serial output and watching for an Error code of 400 in the Pachube Api Debug screen. I have inserted varioys DELAY values of between 500 and 8800 ms, and the results are consistent.</p>
<p>[Is there any way to code a higher DELAY value without the reset function kicking in?]</p>
<p>So I now know that I can get about 15 minutes (using delay of 8800) without a reset. Unfortunately, I want something nearer realtime (e.g 1S) which means a much shorter reset period - about 1 and half minutes. Also, unfortunately, this means I lose data for the period of the reset.</p>
<p>I have tried a couple of Nanodes, so its not a build problem, but it does lead me to conclude that <em>perhaps </em>the ethernet buffer is getting corrupted.&nbsp;</p>
<p>Im no nearer to a programatic solution, so please continue to investigate, while I mess about!</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3213"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Fri, 17/02/2012 - 22:38.</div>
    <div class="content">
     <p>&nbsp;I'm not sure that it's a fair test if you are hammering data at Pachube at such a high rate, as other factors will then influence its stability, such as delays/bottlenecks in the network transmission/servers, and you may be transmitting the next batch of data before you have received a reply from the last.</p>
<p>To introduce a delay without influencing the watchdog reset, you could try a time related 'IF' statement, something like this for creating a 5 second delay and include the code that you wish to delay in the statement;</p>
<p>if ((millis() - prevMillis) &gt; 5000) {<br />
prevMillis=millis();<br />
//The code or function that you want to delay goes here<br />
}</p>
<p>This way, the loop keeps running and resetting the watchdog, and jumps over the 'IF' condition unless more than 5 seconds has elapsed.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3214"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Fri, 17/02/2012 - 23:29.</div>
    <div class="content">
     <p>&nbsp;Playing with pachube, and because the sketch uses a different method to send data than emoncms (ether.tcpSend instead of ether.browseURL), the call back function is never called. This means the&nbsp;request_attempt is never reset. So in theory, the board will reset after the number set in the if statement before resetting error codes or waiting for watchdog.</p>
<p>Trying to make a sketch that can send to several destination (I would need local emoncms, remote emoncms and pachube). Need to dig into the EtherCard library, but at the end of the Pachube send, I reset the request_attempt. Will monitor this weekend...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3246"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Wed, 22/02/2012 - 23:34.</div>
    <div class="content">
     <p>Pachube working with POST.</p>
<p>Posting to pachube and emoncms from same NanodeRF for a week without problem.</p>
<p>I wrote a different sketch to send my data to pachube, and use POST instead of PUT from the pachube example provided. This gives me the control of the callback function.</p>
<p>It also implements server ports, as my local emoncms is running on port 8888.</p>
<p>Ended making a sketch to send to pachube and/or local emoncms and/or emoncms beta from one Nanode.</p>
<p>Sketch attached.</p>
<p>Any feedback or test to pachube would be welcome... Thanks</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3247"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Thu, 23/02/2012 - 10:59.</div>
    <div class="content">
     <p>Hi Francois</p>
<p>This sounds fantastic. We will give it test then put it on on the OEM github. Has anyone else given it a go? Please post up experiences.</p>
<p>Using POST instead of PUT to gain access to the callback is very interesting. We cam to the conclusion that the callback would not be accessible from Pachube without modifying&nbsp;the EtherCard library.&nbsp;&nbsp;</p>
<p>Good work!&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3249"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andygodber&#039;s picture" title="Andygodber&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Andygodber (not verified) on Thu, 23/02/2012 - 18:14.</div>
    <div class="content">
     <p>Going to give this a go...</p>
<p>&nbsp;....hmm getting 401 Unauthorised error and cant immediately see the problem,</p>
<p>Have change my feed and API, and commented out the Local and remote Emon CMS calls.</p>
<p>The IP stuff is resolving ok, but actual post is failing.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3250"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Thu, 23/02/2012 - 18:59.</div>
    <div class="content">
     <p>&nbsp;This is usually a wrong write api key / feed combination. I had this error when not setting up the correct api key.</p>
<p>Make sure your api key has full access to the feed, and that it is not restricted in the methods.</p>
<p>You can check the requests coming in pachube in the Debug info of your account in the help section. You will see the request and the reply sent by pachube.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3251"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andygodber&#039;s picture" title="Andygodber&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Andygodber (not verified) on Fri, 24/02/2012 - 13:09.</div>
    <div class="content">
     <p>&nbsp;Yes - schoolboy error/success</p>
<p>&nbsp;</p>
<p>Cut and Paste had left a random character in my key.</p>
<p>The good news is this looks like its working for me.</p>
<p>Ive already gone straight past my 120 post limit, and will let it run overnight.</p>
<p>Pachube feed 42644/Posts has a record of the number of successful posts. Please ignore anything prior to 21:00 GMT.</p>
<p>[manual reset for code update at 13:00 24/02 GMT after nearly 8000 successful posts]</p>
<p>Im also logging to VIS.EmonCMS concurrently.</p>
<p>I'll tempt fate and say &quot;good work&quot; Francois - thanks.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3260"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MarsFlyer&#039;s picture" title="MarsFlyer&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by MarsFlyer (not verified) on Sun, 26/02/2012 - 08:49.</div>
    <div class="content">
     <p>I was getting similar behaviour due to the CSV data or Pachube API becoming corrupted. This seemed to be worse when using Pragma / Flash strings. To help see the problem you can connect your nanode to your PC via Internet Connection Sharing and look at the actual TCP data being sent by using WireShark.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3271"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="igordutra&#039;s picture" title="igordutra&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by igordutra (not verified) on Mon, 27/02/2012 - 16:41.</div>
    <div class="content">
     <p>Hi Fran&ccedil;ois</p>
<p>I'm using your previous suggestion (resetting the error flags every few hundred cycles) and my Nanode hasn't had a single crash for over 3 weeks. I think I'll try the new sketch with my other nanode and compare the results.</p>
<p>And thanks for your contribution! It saved me a lot of time! :)</p>
<p>Igor</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3277"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="SomeRandomBloke&#039;s picture" title="SomeRandomBloke&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by SomeRandomBloke (not verified) on Mon, 27/02/2012 - 23:11.</div>
    <div class="content">
     <p>&nbsp;I'll post this here as it may be useful:</p>
<p>&nbsp;</p>
<p><span style="font-family: arial, sans-serif; ">I've been posting to pachube for a while now with a nanode-RF. I use</span><span style="font-family: arial, sans-serif; ">&nbsp;</span></p>
<p><span style="font-family: arial, sans-serif; ">EtherCard.&nbsp;</span></p>
<p style="font-family: arial, sans-serif; ">The line that sends it is:&nbsp;</p>
<p style="font-family: arial, sans-serif; ">&nbsp; &nbsp; &nbsp; &nbsp; ether.httpPost( PSTR(PACHUBEAPIURL), pachubeFeedPath,&nbsp;PSTR(PACHUBE_VHOST),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PSTR(PACHUBEAPIKEY),&nbsp;pachubeData ,&amp;browserresult_callback);&nbsp;</p>
<p style="font-family: arial, sans-serif; ">I am using the v2 api with urls similar to : /v2/feeds/12345.csv?_method=PUT&nbsp;</p>
<p style="font-family: arial, sans-serif; ">the /v2/feeds/ part is defined by PACHUBEAPIURL as its fixed, the rest&nbsp;is set in pachubeFeedPath. &nbsp;PACHBE_VHOST and the key are another pair&nbsp;of #defines.&nbsp;</p>
<p style="font-family: arial, sans-serif; ">the pachubeData is just a string built up of the data e.g.:&nbsp;</p>
<p style="font-family: arial, sans-serif; ">0,1234&nbsp;<br />
1,10.4&nbsp;<br />
2,123&nbsp;</p>
<p style="font-family: arial, sans-serif; ">etc.&nbsp;</p>
<p style="font-family: arial, sans-serif; ">This means I can use one request to post updates for multiple streams&nbsp;on the same feed.&nbsp;<br />
The callback function is executed when the response is received, and&nbsp;all I do in here at present is turn the green LED off as it was turned&nbsp;on before calling the httpPost function. It serves as an indication&nbsp;that something has happened.&nbsp;</p>
<p style="font-family: arial, sans-serif; ">Hope this helps&nbsp;</p>
<p>&nbsp;</p>
<p>SRB</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3278"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Tue, 28/02/2012 - 00:06.</div>
    <div class="content">
     <p>Glad to help Igor. Just started in the opensource world. I guess this is what&nbsp;<span style="font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 17px; text-align: left; ">collaborative projects are about.</span></p>
<p>Love the project. Great work</p>
<p>Still posting without issue to pachube and emoncms. Just need to start monitoring energy now... this is why I got into it after all!</p>
<p>Pachube feeds available at&nbsp;<a href="https://pachube.com/feeds/49831">https://pachube.com/feeds/49831</a>. Some interruptions are caused by sketch updates. Have another NanodeRF posting to private feed to test stability.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3295"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Scott216&#039;s picture" title="Scott216&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Scott216 (not verified) on Thu, 01/03/2012 - 16:11.</div>
    <div class="content">
     <p>When I try to compile (Arudnio 022) NanodeRFmulit I get this error</p>
<p>NanodeRFmulti:77: error: conflicting return type specified for 'virtual size_t PacketBuffer::write(uint8_t)'</p>
<p>It's having a problem with the bolded line below</p>
<pre>
class PacketBuffer : public Print {
public:
    PacketBuffer () : fill (0) {}
    const char* buffer() { return buf; }
    byte length() { return fill; }
    void reset()
    {
      memset(buf,NULL,sizeof(buf));
      fill = 0;
    }
<strong>    <em>virtual size_t write (uint8_t ch)</em> </strong>        
      { if (fill &lt; sizeof buf) buf[fill++] = ch; }
    byte fill;
    char buf[150];       
    private:
};
PacketBuffer str;

</pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3296"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Scott216&#039;s picture" title="Scott216&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Scott216 (not verified) on Thu, 01/03/2012 - 17:08.</div>
    <div class="content">
     <p>I figured it out by looking at the code in <a href="https://github.com/jcw/jeelib/blob/master/examples/RF12/packetBuf/packetBuf.ino">packetBuf.ino.</a>&nbsp; Code is differnet for Arduino 1 vs 022. </p>
<p>I added: </p>
<pre>
#if ARDUINO &lt; 100
    virtual void write(uint8_t ch)
    {
    if (fill &lt; sizeof buf)
      buf[fill++] = ch;
    }
#else
    virtual size_t write (uint8_t ch)
    {
     if (fill &lt; sizeof buf)
      buf[fill++] = ch;
    }
#endif
</pre><p>Now it compiles</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3298"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Scott216&#039;s picture" title="Scott216&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Scott216 (not verified) on Fri, 02/03/2012 - 05:11.</div>
    <div class="content">
     <p>I'm having some problems comparing the string returned in get_header_line in the callback_pac() function.&nbsp; First, I think the strcmp() code is wrong because if the two strings are equal, strcmp return zero; and the code in the if statement won't be executed.</p>
<pre>
  get_header_line(1, off); 
&nbsp; if (strcmp(line_buf,&quot;HTTP/1.1 200 OK&quot;)){...
&nbsp;
</pre><p>So I&nbsp;changed it to:</p>
<pre>
  get_header_line(1, off); 
&nbsp; if (strcmp(line_buf,&quot;HTTP/1.1 200 OK&quot;) == 0){...
</pre><p>But strcmp still doesn't think the strings are equal so it doesn't return zero.&nbsp; When I print line_buf to the serial monitor, its:&nbsp;HTTP/1.1 200 OK.&nbsp; So the seem to match.&nbsp; Could there be an issue with null terminator or something that's causing this problem?</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3300"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Scott216&#039;s picture" title="Scott216&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Scott216 (not verified) on Fri, 02/03/2012 - 14:03.</div>
    <div class="content">
     <p>I&nbsp;figured out what's going on.&nbsp; In the text returned by pachube, there is a return character before the end of line charachter.&nbsp; So pachube is sending this:</p>
<pre>
HTTP/1.1 200 OK\r\n</pre><p>and get_header_line() is returning:</p>
<pre>
HTTP/1.1 200 OK\r\0
</pre><p>I&nbsp;changed the strcmp to this (\r at the end):</p>
<pre>
if (strcmp(line_buf,&quot;HTTP/1.1 200 OK\r&quot;) == 0)
</pre><p>Now iot works fine.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3301"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Fri, 02/03/2012 - 14:43.</div>
    <div class="content">
     <p>&nbsp;Well done. I'll change my sketch at the week end to be able to process various codes returned. I'll keep the post updated.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3302"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Scott216&#039;s picture" title="Scott216&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by Scott216 (not verified) on Fri, 02/03/2012 - 16:12.</div>
    <div class="content">
     <p>Can someone explain what these two lines do.&nbsp; I'd guess the first one just loops until ether.packetLoop doesn't equal 0.&nbsp; Is the 2nd line reading one byte of data?</p>
<pre>

while (ether.packetLoop(ether.packetReceive()) != 0) {}
</pre><p>&nbsp;</p>
<pre>
ether.packetLoop(ether.packetReceive());
</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3305"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Fri, 02/03/2012 - 17:50.</div>
    <div class="content">
     <p>From the library, the while statement waits for the ethernet buffer to be empty (on receive or send).</p>
<p>the packetLoop is supposed to make sure no background low level activity &nbsp;(like ping request...) is on going before using the buffer.</p>
<p>Haven't looked into it much more than that, so it might be very high level explanation !</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3306"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Sat, 03/03/2012 - 21:32.</div>
    <div class="content">
     <p>&nbsp;This is really coming together now, and it's good to see the contribution that&nbsp;Francois has made in getting this to work.</p>
<p>I'm still resetting my board every every hour via a simple timer &amp; AVR watchdog, which although crude, works! However when I get some time I want to update the code as per this thread.</p>
<p>One question though, rather than use Francois's&nbsp;full sketch (as I have so many other things in the sketch), would it be possible to amend just this part of my existing sketch, shown here;</p>
<p>&nbsp;</p>
<div><strong>Stash::prepare(PSTR(&quot;PUT http://$F/v2/feeds/$F.csv HTTP/1.0&quot; &quot;\r\n&quot;</strong></div>
<div><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;Host: $F&quot; &quot;\r\n&quot;</strong></div>
<div><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;X-PachubeApiKey: $F&quot; &quot;\r\n&quot;</strong></div>
<div><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;Content-Length: $D&quot; &quot;\r\n&quot;</strong></div>
<div><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;\r\n&quot;</strong></div>
<div><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;$H&quot;),</strong></div>
<div><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; website, PSTR(FEED), website, PSTR(APIKEY), stash.size(), sd);<br />
</strong></div>
<div><strong>&nbsp; &nbsp; // send the packet - this also releases all stash buffers once done</strong></div>
<div><strong>&nbsp; &nbsp; ether.tcpSend();</strong></div>
<p>&nbsp;</p>
<p>to POST instead of PUT, so that it will call the my_callback function (which I can add myself)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3311"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fjhug&#039;s picture" title="fjhug&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by fjhug (not verified) on Sat, 03/03/2012 - 22:11.</div>
    <div class="content">
     <p>&nbsp;You can use your sketch, and provided the ip and dns bits are done, just use the following lines to send the str string:</p>
<p>&nbsp;</p>
<div>while (ether.packetLoop(ether.packetReceive()) != 0) {} // Make sure buffer is empty and not busy before using it.</div>
<div>ether.httpPost(PSTR(FEED_PAC), website, PSTR(APIKEY_PAC), str.buf, callback_pac); // post str string.</div>
<div>&nbsp;</div>
<div>You need the following defines:</div>
<div>
<div>#define FEED_PAC &nbsp;&quot;/v2/feeds/YOUR_FEED.csv?_method=put&quot;</div>
<div>#define APIKEY_PAC &quot;X-PachubeApiKey: YOUR_API_WRITE_KEY&quot;</div>
<div>&nbsp;</div>
<div>callback_pack is the function called on reply from the server. You can change it to your own callback.</div>
<div>&nbsp;</div>
<div>str needs to be formatted as streamName,streamValue crlf...</div>
<div>An example could be (don't forget the println when sending the value):</div>
<div>str.println(&quot;RF,0&quot;); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // RF recieved so no failure</div>
<div>str.print(&quot;ct1,&quot;); &nbsp; &nbsp;str.println(emontx.ct1);</div>
<div>&nbsp;</div>
</div>
<div>&nbsp;Let us know how you get on</div>
<div>&nbsp;</div>
<div>&nbsp;</div>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3312"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Sat, 03/03/2012 - 23:02.</div>
    <div class="content">
     <p>&nbsp;Francois, It may be a few days before I get time to make the changes, but thank you for your reply and help.</p>
<p>As you will see from my previous forum posts I have tried to get this to work for months without success, and it's great that you have brought your skills to the forum.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5246"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerjames99&#039;s picture" title="rogerjames99&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by rogerjames99 (not verified) on Mon, 16/07/2012 - 20:28.</div>
    <div class="content">
     <p>I wish I had seen this thread earlier, it might have saved me some time. Anyway here is a simple  NanodeRF sketch for posting to COSM that is compatible with the current emontx payload format in GitHub. Just patch in your COSM feed id and api key into the call to httpPost and make sure your COSM DataStream names match the ones hard coded in the csv data.</p>
<p>Roger</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5373"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerjames99&#039;s picture" title="rogerjames99&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by rogerjames99 (not verified) on Tue, 24/07/2012 - 13:17.</div>
    <div class="content">
     <p>Another version of my COSM sketch. This is very similar to fjhug's NanodeRFMulti sketch. I needs a small mod to tcpip.cpp in the JeeLabs EtherCard library. Just remove the static from tcp_client_state. This means I can can check for the tcp connection being properly closed before I go on to open a new one. A couple of observations about the Ethercard library;-</p>
<p>1. It does not handle out sequence tcp PDU fragments. I seem to get a lot of these from COSM. If the out sequence PDU happens to have the FIN flag set then the library will close the connection and discard data before I get a chance the see the HTTP 200 PDU. This causes timeouts and weirdness, but the sketch always seems to recover.</p>
<p>2. It cycles round a very small (255) number of source ports. This means that source ports in syns quickly come round again. This can confuse NAT gateways.</p>
<p>Enjoy,</p>
<p>&nbsp;</p>
<p>Roger</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5402"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1178.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1178.jpg" alt="alco&#039;s picture" title="alco&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/1178.html" title="View user profile.">alco</a> on Thu, 26/07/2012 - 14:26.</div>
    <div class="content">
     <p>hey roger,</p>
<p>nice post from your cosmemon scripts. i'm trying to make an nanodeRF&nbsp;work with and sensorshield and posting to emomcms and cosm. But I have difficulties with the call_back ..so I will try your script.</p>
<p>but it's give an error on the tcp_client_state. I probably have to mod. the tcpip.cpp for it (I read your comment)&nbsp;but what do I have to modify there? </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5486"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1178.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1178.jpg" alt="alco&#039;s picture" title="alco&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/1178.html" title="View user profile.">alco</a> on Wed, 01/08/2012 - 21:19.</div>
    <div class="content">
     <p>sollution:&nbsp;alter the tcip.cpp file line 32 with command out [//static byte tcp_client_state;]</p>
<p>save it, restart arduino IDE and load your sketch.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-5542"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Pachube emonBase dont work</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Mon, 06/08/2012 - 10:25.</div>
    <div class="content">
     <p>Hi Guys,</p>
<p>Thanks a lot for making good progress on the Pachube/Cosm example. Our development efforts have been focused around emoncms but there is obviously value in having a working NanodeRF Cosum example. I have just tested the code posted by Roger James. After a little tweak to support a change in the EtherCard API it worked first time. I have pushed this example to github as our NanodeRF Cosum example:&nbsp;<a href="https://github.com/openenergymonitor/NanodeRF">https://github.com/openenergymonitor/NanodeRF</a></p>
<p>I have tried to credit those involved, please let me know if I could do this better in any way.&nbsp;</p>
<p>Thanks again,</p>
<p>Glyn.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/376"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-iiUDFUygusPFRT8uflUO6jIRfgab6WqMZ3_c_mNsAcw" value="form-iiUDFUygusPFRT8uflUO6jIRfgab6WqMZ3_c_mNsAcw"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
