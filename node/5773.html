<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/5773 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:14:28 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>posting to emoncms.org using IP address | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">posting to emoncms.org using IP address</h3>
        <span class="submitted">Submitted by <a href="../user/3375.html" title="View user profile.">tomtobback</a> on Tue, 16/09/2014 - 03:30</span>
        <div class="content"><p>Hi, i have a couple of standard&nbsp;emonTx&#39;s running, but now i am trying to use Arduino+wifi&nbsp;to send data directly to emoncms.org. I am using a CC3000 wifi shield with an&nbsp;Adafruit library, and it works for Xively. But when i post to emoncms.org i get a &quot;408 Request Time-out&quot;. So i tried my json&nbsp;URL in my browser and noticed that it works fine when i use the hostname (which the Adafruit library does not allow me to do in the sketch), but not when i use the translated IP address:</p>
<p><a href="http://emoncms.org/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281" title="http://emoncms.org/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281">http://emoncms.org/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281</a> &gt;&gt;WORKS (returns &#39;ok&#39;)</p>
<p><a href="http://80.243.190.58/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281" title="http://80.243.190.58/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281">http://80.243.190.58/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281</a> &gt;&gt;DOES NOT WORK (returns &#39;404 not found&#39;)</p>
<p>This IP address is looked up by a library function. I tried the IP address mentioned here&nbsp;http://openenergymonitor.org/emon/node/3696 but same error.</p>
<p>Any ideas what i am doing wrong? Thanks in advance.</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11331.html" class="topic-previous" title="Go to previous forum topic">‹ emonTX high sensitivity CT input &amp; Solar PV</a>
              <a href="11227.html" class="topic-next" title="Go to next forum topic">Running a Pi from an External USB HDD ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-23823"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 16/09/2014 - 08:44.</div>
    <div class="content">
     <p>Try <a href="http://80.243.190.58/emoncms/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281">http://80.243.190.58/emoncms/input/post.json?apikey=d66xxx76a8&amp;node=10&amp;csv=622,281</a></p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23835"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3375.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3375.jpg" alt="tomtobback&#039;s picture" title="tomtobback&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/3375.html" title="View user profile.">tomtobback</a> on Tue, 16/09/2014 - 12:18.</div>
    <div class="content">
     <p>Thanks Paul, indeed that solves the issue in the browser.</p>
<p>Now next issue is that when i add this to my sketch, it still returns the &#39;408 Request Time-out&#39; so there must be something wrong in my code. I haven&#39;t found any examples of Adafruit&#39;s&nbsp;CC3000 library posting to emoncms.org so would be great if somebody could help. The format of the json seems correct becauseit works when i copy it from the Serial output into the browser. Just no clue why the GET request is not received on the server, causing the time-out.</p>
<p>&lt;code&gt;</p>
<p>String data = &quot;&quot;;<br />
	&nbsp;<br />
	&nbsp; data = data + &quot;/emoncms/input/post.json?&quot; + &quot;apikey=&quot; + apikey + &quot;&amp;node=10&quot; + &quot;&amp;csv=&quot; + String(humidity) + &quot;,&quot; + String(temperature) + &quot;\0&quot;; &nbsp;</p>
<p>&nbsp; Serial.println(&quot;data:&quot;);<br />
	&nbsp; Serial.print(data);<br />
	&nbsp; Serial.println();<br />
	&nbsp;<br />
	&nbsp; // Send request<br />
	&nbsp; Adafruit_CC3000_Client client = cc3000.connectTCP(ip, 80);<br />
	&nbsp; if (client.connected()) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.println(&quot;connection successfull, sending data.. &quot;);<br />
	&nbsp;&nbsp;&nbsp; // Make a HTTP request:<br />
	&nbsp;&nbsp;&nbsp; client.println(&quot;GET &quot; + data + &quot; HTTP/1.1&quot;);<br />
	&nbsp;&nbsp;&nbsp; client.println(&quot;Host: <a href="http://www.emoncms.org"/" title="www.emoncms.org&quot;">www.emoncms.org&quot;</a>);<br />
	&nbsp;&nbsp;&nbsp; client.println(&quot;Connection: close&quot;);<br />
	&nbsp;&nbsp;&nbsp; client.println();<br />
	&nbsp;&nbsp;&nbsp; Serial.println(&quot;GET request sent&quot;);<br />
	&nbsp; }<br />
	&nbsp; else {<br />
	&nbsp;&nbsp;&nbsp; // if you didn&#39;t get a connection to the server:<br />
	&nbsp;&nbsp;&nbsp; Serial.println(&quot;connection failed, will try again&quot;);<br />
	&nbsp; }<br />
	&nbsp; Serial.println(client.connected());<br />
	&nbsp;<br />
	&nbsp; Serial.println(F(&quot;-------------------------------------&quot;));<br />
	&nbsp; // if there are incoming bytes available from the server, read them and print them:<br />
	&nbsp; while (client.available()) {<br />
	&nbsp;&nbsp;&nbsp; char c = client.read();<br />
	&nbsp;&nbsp;&nbsp; Serial.print(c);&nbsp;&nbsp;&nbsp;&nbsp; // for debugging<br />
	&nbsp; }<br />
	&nbsp; client.close();<br />
	&nbsp;<br />
	&nbsp; Serial.println(F(&quot;-------------------------------------&quot;));<br />
	&nbsp;<br />
	&nbsp; Serial.println(F(&quot;\n\nDisconnecting&quot;));<br />
	&nbsp; cc3000.disconnect();</p>
<p>&lt;/code&gt;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23850"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 16/09/2014 - 17:24.</div>
    <div class="content">
     <p>It looks like your sketch is using <a href="http://www.emoncms,org/" title="www.emoncms,org">www.emoncms,org</a> AND /emoncms, that probably won&#39;t work, Have you tried replacing <a href="http://www.emoncms.org/" title="www.emoncms.org">www.emoncms.org</a> with the IP ?</p>
<blockquote><p>client.println(&quot;Host: 80.243.190.58&quot;);</p>
</blockquote>
<p>or maybe even just dropping the www. (without the /emoncms)</p>
<p>&nbsp;</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23860"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3375.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3375.jpg" alt="tomtobback&#039;s picture" title="tomtobback&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/3375.html" title="View user profile.">tomtobback</a> on Wed, 17/09/2014 - 01:48.</div>
    <div class="content">
     <p>Thanks Paul, i have tried the options but still getting the &#39;408 Request Time-out&#39; so it seems the server does not even receive the HTTP request. Below is my Serial Monitor output, with the exact HTTP request, maybe somebody sees what&#39;s wrong. Not a lack of memory it seems.</p>
<p>----Serial Monitor------------</p>
<p>FreeRam: 1200</p>
<p>Initializing CC3000...<br />
	Connected to WLAN!<br />
	Request DHCP<br />
	emoncms.org -&gt; 80.243.190.58<br />
	FreeRam: 1083<br />
	+++++++ HTTP request ++++++++++++++++++<br />
	GET /input/post.json?apikey=d66xxxx876a8&amp;node=10&amp;csv=571,281 HTTP/1.1<br />
	Host: <a href="http://www.emoncms.org/" title="www.emoncms.org">www.emoncms.org</a><br />
	Connection: close</p>
<p>+++++++++++++++++++++++++++<br />
	FreeRam: 843<br />
	TCP connection to emoncms.org successfull, sending above HTTP request..<br />
	GET request sent<br />
	843<br />
	1<br />
	FreeRam: 843<br />
	--------- HTTP reply&nbsp; ----------------------------<br />
	HTTP/1.1 408 Request Time-out<br />
	Date: Wed, 17 Sep 2014 01:42:05 GMT<br />
	Server: Apache/2.2.22 (Ubuntu)<br />
	Vary: Accept-Encoding<br />
	Content-Length: 325<br />
	Connection: close<br />
	Content-Type: text/html; charset=iso-8859-1</p>
<p>&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;<br />
	&lt;html&gt;&lt;head&gt;<br />
	&lt;title&gt;408 Request Time-out&lt;/title&gt;<br />
	&lt;/head&gt;&lt;body&gt;<br />
	&lt;h1&gt;Request Time-out&lt;/h1&gt;<br />
	&lt;p&gt;Server timeout waiting for the HTTP request from the client.&lt;/p&gt;<br />
	&lt;hr&gt;<br />
	&lt;address&gt;Apache/2.2.22 (Ubuntu) Server at h80-243-190-58.host.redstation.co.uk Port 80&lt;/address&gt;<br />
	&lt;/body&gt;&lt;/html&gt;<br />
	-------------------------------------</p>
<p>
	Disconnecting from WLAN</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29439"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7869.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="tonypascal&#039;s picture" title="tonypascal&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/7869.html" title="View user profile.">tonypascal</a> on Tue, 07/04/2015 - 10:05.</div>
    <div class="content">
     <p>Hello</p>
<p>I am also trying to make the CC3000&nbsp;wifi shield post data. Could you please let me know where you found the code and provide it to me ?</p>
<p>Regards</p>
<p>Romain</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29669"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4718.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Hayder&#039;s picture" title="Hayder&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/4718.html" title="View user profile.">Hayder</a> on Thu, 16/04/2015 - 21:28.</div>
    <div class="content">
     <p>Hello&nbsp;</p>
<p>I have same problem, Any help please.</p>
<p>B.R</p>
<p>Hayder</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31503"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8324.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squiza&#039;s picture" title="squiza&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/8324.html" title="View user profile.">squiza</a> on Fri, 19/06/2015 - 07:53.</div>
    <div class="content">
     <p>I would also love to find the answer to this problem.</p>
<p>i am trying to use an Arduino with hard wired ethernet to log optical pulses directly to the website. I am trying to avoid having to use an RF arrangement and dedicated base station.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34980"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8845.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="snoopy&#039;s picture" title="snoopy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/8845.html" title="View user profile.">snoopy</a> on Fri, 16/10/2015 - 13:08.</div>
    <div class="content">
     <p>Anything new with this? What shield wifi or&nbsp;ethernet are you using to push data to website?&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35364"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8905.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="lebritish&#039;s picture" title="lebritish&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: posting to emoncms.org using IP address</h3>

    <div class="submitted">Submitted by <a href="../user/8905.html" title="View user profile.">lebritish</a> on Mon, 26/10/2015 - 09:52.</div>
    <div class="content">
     <p>Hello to all,</p>
<p>Thanks to tomtobback I manage to post data to emoncms trough a CC3000 wifi shield.</p>
<p>You have to set <u>a static IP </u>to your shield first because DHCP is sooooooooooooooo long and rubbish.</p>
<p>However I am not using it anymore because the range of a CC3000 wifi shield is ridiculously short.</p>
<p>Anyway here is the code:</p>
<p>--------------------------</p>
<p>&nbsp;</p>
<p>/*************************************************<br />
&nbsp; This is an example for the Adafruit CC3000 Wifi Breakout &amp; Shield</p>
<p>&nbsp; Designed specifically to work with the Adafruit WiFi products:<br />
&nbsp; --&gt; <a href="https://www.adafruit.com/products/1469" title="https://www.adafruit.com/products/1469">https://www.adafruit.com/products/1469</a></p>
<p>&nbsp; Adafruit invests time and resources providing this open source code,<br />
&nbsp; please support Adafruit and open-source hardware by purchasing<br />
&nbsp; products from Adafruit!</p>
<p>&nbsp; Written by Limor Fried &amp; Kevin Townsend for Adafruit Industries. &nbsp;<br />
&nbsp; BSD license, all text above must be included in any redistribution<br />
&nbsp;**************************************************/<br />
&nbsp;<br />
&nbsp;/*<br />
This example does a test of the TCP client capability:<br />
&nbsp; * Initialization<br />
&nbsp; * Optional: SSID scan<br />
&nbsp; * AP connection<br />
&nbsp; * DHCP printout<br />
&nbsp; * DNS lookup<br />
&nbsp; * Optional: Ping<br />
&nbsp; * Connect to website and print out webpage contents<br />
&nbsp; * Disconnect<br />
SmartConfig is still beta and kind of works but is not fully vetted!<br />
It might not work on all networks!<br />
*/<br />
#include &lt;Adafruit_CC3000.h&gt;<br />
#include &lt;ccspi.h&gt;<br />
#include &lt;SPI.h&gt;<br />
#include &lt;string.h&gt;<br />
#include &quot;utility/debug.h&quot;<br />
#include &lt;TimerOne.h&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // for software watchdog</p>
<p>#include &quot;EmonLib.h&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Include Emon Library</p>
<p>&nbsp;</p>
<p>// These are the interrupt and control pins<br />
#define ADAFRUIT_CC3000_IRQ&nbsp;&nbsp; 3&nbsp; // MUST be an interrupt pin!<br />
// These can be any two pins<br />
#define ADAFRUIT_CC3000_VBAT&nbsp; 5<br />
#define ADAFRUIT_CC3000_CS&nbsp;&nbsp;&nbsp; 10<br />
// Use hardware SPI for the remaining pins<br />
// On an UNO, SCK = 13, MISO = 12, and MOSI = 11<br />
Adafruit_CC3000 cc3000 = Adafruit_CC3000(ADAFRUIT_CC3000_CS, ADAFRUIT_CC3000_IRQ, ADAFRUIT_CC3000_VBAT,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SPI_CLOCK_DIVIDER); // you can change this clock speed</p>
<p>
#define WLAN_SSID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;yournetwork &quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // cannot be longer than 32 characters!<br />
#define WLAN_PASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;yourpassword&quot;<br />
// const char WLAN_PASS[] = {0xAA, 0xAA, 0xCC, 0xBB, 0xCC, 0x00}; for WEP encryption ONLY</p>
<p>// Security can be WLAN_SEC_UNSEC, WLAN_SEC_WEP, WLAN_SEC_WPA or WLAN_SEC_WPA2<br />
//#define WLAN_SECURITY&nbsp;&nbsp; WLAN_SEC_WEP<br />
#define WLAN_SECURITY&nbsp;&nbsp; WLAN_SEC_WPA2</p>
<p>&nbsp;</p>
<p>#define IDLE_TIMEOUT_MS&nbsp; 3000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Amount of time to wait (in milliseconds) with no data<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // received before closing the connection.&nbsp; If you know the server<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // you&#39;re accessing is quick to respond, you can reduce this value.</p>
<p>// What page to grab!<br />
#define WEBSITE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;www.emoncms.org&quot;</p>
<p>uint32_t ip;</p>
<p>EnergyMonitor emon1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create an instance</p>
<p>unsigned long starttime;<br />
unsigned long sampletime_ms = 30000;&nbsp;&nbsp; //time between sendind data minimum 30s ;<br />
&nbsp;<br />
//last time the WDT was ACKd by the application<br />
unsigned long lastUpdate=0;<br />
&nbsp;//time, in ms, after which a reset should be triggered<br />
unsigned long timeout=60000;</p>
<p>void setup(void)<br />
{<br />
&nbsp; Serial.begin(9600); &nbsp;<br />
&nbsp;<br />
&nbsp; emon1.voltage(1, 248, 1.77);&nbsp; // Voltage: input pin, calibration, phase_shift<br />
&nbsp; emon1.current(0, 28.87);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Current: input pin, calibration.<br />
&nbsp;<br />
&nbsp; lastUpdate=millis();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // start watchdog<br />
&nbsp; //Timer1.initialize(1000000); //1 second pulses<br />
&nbsp; Timer1.attachInterrupt(longWDT); //code to execute<br />
&nbsp; starttime = millis();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //get the current time;<br />
&nbsp;<br />
}</p>
<p>void loop(void) {<br />
&nbsp;<br />
&nbsp;<br />
&nbsp; &nbsp;<br />
&nbsp;&nbsp; lastUpdate=millis();&nbsp; // tell watchdog all is fine</p>
<p>
&nbsp;&nbsp; if ((millis()-starttime) &gt; sampletime_ms)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if the sample time == 30s<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emon1.calcVI(20,2000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Calculate all. No.of half wavelengths (crossings), time-out<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emon1.serialprint();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Print out all variables (realpower, apparent power, Vrms, Irms, power factor)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float realPower&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = emon1.realPower;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Real Power into variable<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float apparentPower&nbsp;&nbsp; = emon1.apparentPower;&nbsp;&nbsp;&nbsp; //extract Apparent Power into variable<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float powerFactor&nbsp;&nbsp;&nbsp;&nbsp; = emon1.powerFactor;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Power Factor into Variable<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float supplyVoltage&nbsp;&nbsp; = emon1.Vrms;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Vrms into Variable<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float Irms&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = emon1.Irms;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Irms into Variable<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; // at the end of one reading cycle, connect and post to website<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp; Serial.println(F(&quot;starting CC3000&quot;));<br />
&nbsp; Serial.print(&quot;interval: &quot;); Serial.println(starttime/1000);<br />
&nbsp; Serial.print(&quot;Free RAM: &quot;); Serial.println(getFreeRam(), DEC);<br />
&nbsp; /* Initialise the module */<br />
&nbsp; if (!cc3000.begin())<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;Couldn&#39;t start CC3000! Check your wiring?&quot;));<br />
&nbsp;&nbsp;&nbsp; while(1);<br />
&nbsp; }<br />
&nbsp;<br />
&nbsp;<br />
&nbsp;<br />
&nbsp; Serial.print(F(&quot;Connecting to &quot;)); Serial.println(WLAN_SSID);<br />
&nbsp; if (!cc3000.connectToAP(WLAN_SSID, WLAN_PASS, WLAN_SECURITY)) {<br />
&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;Failed!&quot;));<br />
&nbsp;&nbsp;&nbsp; while(1);<br />
&nbsp; }<br />
&nbsp; Serial.println(F(&quot;Connected!&quot;));<br />
&nbsp;<br />
&nbsp;&nbsp; /* Optional: Set a static IP address instead of using DHCP.<br />
&nbsp;&nbsp;&nbsp;&nbsp; Note that the setStaticIPAddress function will save its state<br />
&nbsp;&nbsp;&nbsp;&nbsp; in the CC3000&#39;s internal non-volatile memory and the details<br />
&nbsp;&nbsp;&nbsp;&nbsp; will be used the next time the CC3000 connects to a network.<br />
&nbsp;&nbsp;&nbsp;&nbsp; This means you only need to call the function once and the<br />
&nbsp;&nbsp;&nbsp;&nbsp; CC3000 will remember the connection details.&nbsp; To switch back<br />
&nbsp;&nbsp;&nbsp;&nbsp; to using DHCP, call the setDHCP() function (again only needs<br />
&nbsp;&nbsp;&nbsp;&nbsp; to be called once).<br />
&nbsp; */<br />
&nbsp; /* //Your_network parameters<br />
&nbsp; uint32_t ipAddress = cc3000.IP2U32(192, 168, 2, 199);<br />
&nbsp; uint32_t netMask = cc3000.IP2U32(255, 255, 255, 0);<br />
&nbsp; uint32_t defaultGateway = cc3000.IP2U32(192, 168, 2, 1);<br />
&nbsp; uint32_t dns = cc3000.IP2U32(192, 168, 1, 254);<br />
&nbsp; if (!cc3000.setStaticIPAddress(ipAddress, netMask, defaultGateway, dns)) {<br />
&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;Failed to set static IP!&quot;));<br />
&nbsp;&nbsp;&nbsp; while(1);<br />
&nbsp; }<br />
&nbsp; */<br />
&nbsp;<br />
&nbsp; /* Optional: Revert back from static IP addres to use DHCP.<br />
&nbsp;&nbsp;&nbsp;&nbsp; See note for setStaticIPAddress above, this only needs to be<br />
&nbsp;&nbsp;&nbsp;&nbsp; called once and will be remembered afterwards by the CC3000.<br />
&nbsp; */<br />
&nbsp; /*<br />
&nbsp; if (!cc3000.setDHCP()) {<br />
&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;Failed to set DHCP!&quot;));<br />
&nbsp;&nbsp;&nbsp; while(1);<br />
&nbsp; }<br />
&nbsp;&nbsp; */</p>
<p>&nbsp;<br />
&nbsp;<br />
&nbsp; /* Wait for DHCP to complete<br />
&nbsp; Serial.println(F(&quot;Requesting DHCP&quot;));<br />
&nbsp; while (!cc3000.checkDHCP())<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; delay(100); // ToDo: Insert a DHCP timeout!<br />
&nbsp; } &nbsp;<br />
&nbsp; */<br />
&nbsp; ip = 0;<br />
&nbsp; // Try looking up the website&#39;s IP address<br />
&nbsp; Serial.print(WEBSITE); Serial.print(F(&quot; -&gt; &quot;));<br />
&nbsp; while (ip == 0) {<br />
&nbsp;&nbsp;&nbsp; if (! cc3000.getHostByName(WEBSITE, &amp;ip)) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;Couldn&#39;t resolve!&quot;));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; delay(1000);<br />
&nbsp; }<br />
&nbsp; cc3000.printIPdotsRev(ip);<br />
&nbsp; /* Try connecting to the website.<br />
&nbsp;&nbsp;&nbsp;&nbsp; Note: HTTP/1.1 protocol is used to keep the server from closing the connection before all data is read.<br />
&nbsp; */<br />
&nbsp; Adafruit_CC3000_Client www = cc3000.connectTCP(ip, 80);<br />
&nbsp; if (www.connected()) {<br />
&nbsp;&nbsp;&nbsp; www.fastrprint(F(&quot;GET &quot;));<br />
&nbsp;&nbsp;&nbsp; www.fastrprint(&quot;/input/post.json?node=0&amp;apikey=yourAPIkey&amp;csv=&quot;);<br />
&nbsp;&nbsp;&nbsp; www.print(powerFactor);<br />
&nbsp;&nbsp;&nbsp; www.print(&quot;,&quot;);<br />
&nbsp;&nbsp;&nbsp; www.print(apparentPower);<br />
&nbsp;&nbsp;&nbsp; www.print(&quot;,&quot;);<br />
&nbsp;&nbsp;&nbsp; www.print(realPower);<br />
&nbsp;&nbsp;&nbsp; www.fastrprint(F(&quot; HTTP/1.1\r\n&quot;));<br />
&nbsp;&nbsp;&nbsp; www.fastrprint(F(&quot;Host: &quot;)); www.fastrprint(WEBSITE); www.fastrprint(F(&quot;\r\n&quot;));<br />
&nbsp;&nbsp;&nbsp; www.fastrprint(F(&quot;\r\n&quot;));<br />
&nbsp;&nbsp;&nbsp; www.println();<br />
&nbsp; } else {<br />
&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;\nConnection failed&quot;));&nbsp;&nbsp; &nbsp;<br />
&nbsp; }</p>
<p>&nbsp; Serial.println(F(&quot;-----------------------------------&quot;));<br />
&nbsp;<br />
&nbsp; /* Read data until either the connection is closed, or the idle timeout is reached. */<br />
&nbsp; unsigned long lastRead = millis();<br />
&nbsp; while (www.connected() &amp;&amp; (millis() - lastRead &lt; IDLE_TIMEOUT_MS)) {<br />
&nbsp;&nbsp;&nbsp; while (www.available()) {<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char c = www.read();<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(c);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lastRead = millis();<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
&nbsp; www.close();<br />
&nbsp; Serial.println(F(&quot;-----------------------------------&quot;));<br />
&nbsp;<br />
&nbsp; /* You need to make sure to clean up after yourself or the CC3000 can freak out */<br />
&nbsp; /* the next time your try to connect ... */<br />
&nbsp; Serial.println(F(&quot;Disconnecting from CC3000&quot;));<br />
&nbsp; cc3000.disconnect();<br />
&nbsp;<br />
&nbsp;<br />
&nbsp; starttime = millis();<br />
&nbsp; Serial.println(F(&quot;\n\nStarting a new sensor measurement&quot;));<br />
&nbsp;&nbsp;&nbsp; }<br />
}</p>
<p>
/************************************************************************/<br />
/*!<br />
&nbsp;&nbsp; @brief Begins an SSID scan and prints out all the visible networks<br />
*/<br />
/************************************************************************/<br />
/*<br />
void listSSIDResults(void)<br />
{<br />
&nbsp; uint32_t index;<br />
&nbsp; uint8_t valid, rssi, sec;<br />
&nbsp; char ssidname[33];</p>
<p>&nbsp; if (!cc3000.startSSIDscan(&amp;index)) {<br />
&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;SSID scan failed!&quot;));<br />
&nbsp;&nbsp;&nbsp; return;<br />
&nbsp; }</p>
<p>&nbsp; Serial.print(F(&quot;Networks found: &quot;)); Serial.println(index);<br />
&nbsp; Serial.println(F(&quot;================================================&quot;));</p>
<p>&nbsp; while (index) {<br />
&nbsp;&nbsp;&nbsp; index--;</p>
<p>&nbsp;&nbsp;&nbsp; valid = cc3000.getNextSSID(&amp;rssi, &amp;sec, ssidname);<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;SSID Name&nbsp;&nbsp;&nbsp; : &quot;)); Serial.print(ssidname);<br />
&nbsp;&nbsp;&nbsp; Serial.println();<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;RSSI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : &quot;));<br />
&nbsp;&nbsp;&nbsp; Serial.println(rssi);<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;Security Mode: &quot;));<br />
&nbsp;&nbsp;&nbsp; Serial.println(sec);<br />
&nbsp;&nbsp;&nbsp; Serial.println();<br />
&nbsp; }<br />
&nbsp; Serial.println(F(&quot;================================================&quot;));</p>
<p>&nbsp; cc3000.stopSSIDscan();<br />
}<br />
*/<br />
/************************************************************************/<br />
/*!<br />
&nbsp;&nbsp; @brief Tries to read the IP address and other connection details<br />
*/<br />
/************************************************************************/<br />
/*</p>
<p>bool displayConnectionDetails(void)<br />
{<br />
&nbsp; uint32_t ipAddress, netmask, gateway, dhcpserv, dnsserv;<br />
&nbsp;<br />
&nbsp; if(!cc3000.getIPAddress(&amp;ipAddress, &amp;netmask, &amp;gateway, &amp;dhcpserv, &amp;dnsserv))<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; Serial.println(F(&quot;Unable to retrieve the IP Address!\r\n&quot;));<br />
&nbsp;&nbsp;&nbsp; return false;<br />
&nbsp; }<br />
&nbsp; else<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;\nIP Addr: &quot;)); cc3000.printIPdotsRev(ipAddress);<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;\nNetmask: &quot;)); cc3000.printIPdotsRev(netmask);<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;\nGateway: &quot;)); cc3000.printIPdotsRev(gateway);<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;\nDHCPsrv: &quot;)); cc3000.printIPdotsRev(dhcpserv);<br />
&nbsp;&nbsp;&nbsp; Serial.print(F(&quot;\nDNSserv: &quot;)); cc3000.printIPdotsRev(dnsserv);<br />
&nbsp;&nbsp;&nbsp; Serial.println();<br />
&nbsp;&nbsp;&nbsp; return true;<br />
&nbsp; }<br />
}<br />
*/</p>
<p>void (*resetFunc)(void) = 0;<br />
&nbsp;<br />
void longWDT(void)<br />
{<br />
&nbsp; if((millis()-lastUpdate) &gt; timeout)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; //enable interrupts so serial can work<br />
&nbsp;&nbsp;&nbsp; sei();<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; //detach Timer1 interrupt so that if processing goes long, WDT isn&#39;t re-triggered<br />
&nbsp;&nbsp;&nbsp; Timer1.detachInterrupt();<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; //flush, as Serial is buffered; and on hitting reset that buffer is cleared<br />
&nbsp;&nbsp;&nbsp; Serial.println(&quot;WDT triggered&quot;);<br />
&nbsp;&nbsp;&nbsp; Serial.flush();<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; //call to bootloader / code at address 0<br />
&nbsp;&nbsp;&nbsp; resetFunc();<br />
&nbsp; }<br />
}</p>
<p>--------------------</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/5773"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-2-GDCF2JTOPZRrBb4uFuzZrnY8haAL26MQQU02BrIDQ" value="form-2-GDCF2JTOPZRrBb4uFuzZrnY8haAL26MQQU02BrIDQ"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
