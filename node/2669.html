<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2669 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:23:26 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Where are the variables defined? | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Where are the variables defined?</h3>
        <span class="submitted">Submitted by Guest on Thu, 08/08/2013 - 17:25</span>
        <div class="content"><p>After finally figuring out all the hardware for the monitor, I&#39;m not going through the software for the emonlib. &nbsp;I went through the .h and .cpp files and wasn&#39;t able to find a few variables (i.e. where is the constant &quot;timeout&quot; defined and assigned a value or crossings same thing). &nbsp;Thanks!</p>
<p>	On another note, does anyone have a good handle on how often one should record power measurements in order to have a good handle on standard household loads? &nbsp;I&#39;m testing individual circuit breakers and want to capture power spikes, so I was thinking once per second would be adequate. &nbsp;Has anyone tested this out?</p>
  <div class="forum-topic-navigation clear-block">
          <a href="1644.html" class="topic-previous" title="Go to previous forum topic">‹ Changing data format on bargraph</a>
              <a href="2649.html" class="topic-next" title="Go to next forum topic">emonbase does not work longer than 10 minutes ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-14193"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 08/08/2013 - 18:36.</div>
    <div class="content">
     <p>Missing vaiables: Have you looked in the included files - the libraries? That&#39;s where you&#39;ll find them.</p>
<p>What do you mean by a &quot;power spike&quot;? - what timescale are you looking at. If you are interested in inrush - that&#39;s the surge of current that happens when a tungsten lamp is switched on, that lasts for a few cycles,for a fridge motor, it&#39;s a lot longer than that, around a second. If you&#39;re using emonLib that samples for 0.2 s every say 1s, clearly unless the event you&#39;re looking for lasts longer than 1 s, you&#39;re not guaranteed to see it, let alone capture it faithfully.</p>
<p>The alternative is to use MartinR&#39;s PLL sketch, which monitors continuously. You&#39;ll still not see the peak amplitude, only the average power over the averaging period, but at least you&#39;ll see something.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14195"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squareone&#039;s picture" title="squareone&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by squareone (not verified) on Thu, 08/08/2013 - 19:13.</div>
    <div class="content">
     <p>Hey again Robert. &nbsp;I found the declarations or that functions were looking for them, but the libraries didn&#39;t have something like timeout=500. &nbsp;That being the case, what is the timeout length? &nbsp;I read emonLib.h and emonlib.cpp which are the only files I believe are relevant in my energy monitoring compile. &nbsp;Should I not see the constants defined as a number in those files? &nbsp;Where are the function calls happening i.e. what calls this function -&gt; &nbsp;void EnergyMonitor::calcVI(int crossings, int timeout). &nbsp;Nothing appears to call it in the sketch, the header, or cpp file.</p>
<p>	I would like to capture lights coming on and the motor on the refrigerator kicking in, so sounds like .5s intervals would be better. &nbsp;I&#39;ll check out the PLL Sketch. &nbsp;Thanks for the tip.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14197"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 08/08/2013 - 20:25.</div>
    <div class="content">
     <p>Ah, I see what you are saying. You need to learn a bit of C++. How much C do you know? While I don&#39;t think it is absolutely necessary to be proficient in C, some knowledge will help. My bible for C is of course &quot;Kernigan &amp; Ritchie&quot; <a href="http://www.amazon.co.uk/C-Programming-Language-2nd/dp/0131103628/ref=sr_1_3?s=books&amp;ie=UTF8&amp;qid=1292502807&amp;sr=1-3" title="http://www.amazon.co.uk/C-Programming-Language-2nd/dp/0131103628/ref=sr_1_3?s=books&amp;ie=UTF8&amp;qid=1292502807&amp;sr=1-3">http://www.amazon.co.uk/C-Programming-Language-2nd/dp/0131103628/ref=sr_...</a>. This is the standard text book.&nbsp; The normal place I point people at who want to move up to C++ is <a href="http://www.relisoft.com/book/index.htm " title="http://www.relisoft.com/book/index.htm ">http://www.relisoft.com/book/index.htm </a> and that assumes you know C. Because the Arduino environment normally uses a very small subset of the language, neither are the best place for a beginner to start, nor are many of the other on-line tutorials. I&#39;d still suggest you have both of those, and maybe Bruce Eckel&#39;s &quot;Thinking in C++&quot; <a href="http://www.planetpdf.com/developer/article.asp?ContentID=6634" title="http://www.planetpdf.com/developer/article.asp?ContentID=6634">http://www.planetpdf.com/developer/article.asp?ContentID=6634</a> available for reference.</p>
<p>However, there is this: <a href="http://www.me.umn.edu/courses/me2011/arduino/arduinoGuide.pdf" title="http://www.me.umn.edu/courses/me2011/arduino/arduinoGuide.pdf">http://www.me.umn.edu/courses/me2011/arduino/arduinoGuide.pdf</a> which does look to be a good starting place for a beginner. It does not go as far as classes and methods that are used here, though. So after that, you&#39;ll need to progress on to Relisoft.</p>
<p>Briefly, EnergyMonitor is a <em>class</em>, and calcVI is one of its <em>methods</em>. <em>timeout</em> is a parameter that is passed in when the method is called.&nbsp; A class is a definition a bit like int or long, it becomes an entity when it is <em>instantiated </em>(you make an instance of it) which you do in the sketch (three times) with</p>
<p class="rteindent1">EnergyMonitor ct1,ct2,ct3;</p>
<p>So <em>timeout</em> gets its value (2000) in</p>
<p class="rteindent1">ct1.calcVI(20,2000);</p>
<p class="rteindent1">&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14199"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squareone&#039;s picture" title="squareone&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by squareone (not verified) on Thu, 08/08/2013 - 21:16.</div>
    <div class="content">
     <p>OMG, it was right in front of my face the whole time. &nbsp;I was digging in the header and cpp and not my own code. &nbsp;Sorry about that! &nbsp;Thanks Robert. &nbsp;Working on a solution now that will give me the averaging I want. &nbsp;I&#39;m not going to change the timeout or crossings, just was curious what I was working with. &nbsp;You say it should be sampling close to 5hz, so then I should be able to track that in the serial and then later write some code to get the data written to a SD card. &nbsp;I have the normal emon example sketch running now with a SD card write add on and found that the writing process was taking a long time (700ms or so). &nbsp;I&#39;m looking for a faster way to write it now and that way I can later see how much electricity I used total.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14202"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 08/08/2013 - 22:28.</div>
    <div class="content">
     <p>Take a step back. The emonLib calcVI reads the inputs for 20 zero crossings (10 cycles) then returns to your sketch. Per c.t.. Then it sends to RF or serial or whatever, then sleeps for 5 s. I didn&#39;t say 5 Hz, I don&#39;t know where that came from.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14207"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squareone&#039;s picture" title="squareone&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by squareone (not verified) on Fri, 09/08/2013 - 01:09.</div>
    <div class="content">
     <p>You said every .2s which is 5 hz, right? &nbsp;Glad I know about the sleep cycle now, but that&#39;s not a part of the basic emon Library-&gt;voltage and current sketch, right? &nbsp;I actually put a timer on the beginning and end of the calculations so the .2 secs is calculated every step instead of making the .2s assumption.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14208"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squareone&#039;s picture" title="squareone&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by squareone (not verified) on Fri, 09/08/2013 - 03:39.</div>
    <div class="content">
     <p>Robert, you seem very detailed oriented. &nbsp;Could you check my code to make sure I did the maths right for the 1 CT sensor and voltage measurement I have? &nbsp;I&#39;m using the standard emon Library and just trying to make a kW-h accumulator at this point. &nbsp;My LCD is showing me a number I would consider too high for my dishwasher. &nbsp;I think maybe (3600s&nbsp;* 1000W) does not fully convert realPower to kWh. &nbsp;Any help is appreciated. &nbsp;</p>
<p>[CODE]</p>
<p>#include &lt;Wire.h&gt;<br />
	#include &lt;LCD.h&gt;<br />
	#include &lt;LiquidCrystal_I2C.h&gt;<br />
	#include &quot;EmonLib.h&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Include Emon Library<br />
	#include &lt;SD.h&gt;<br />
	#include &lt;Time.h&gt;</p>
<p>#define I2C_ADDR 0x3F<br />
	#define BACKLIGHT_PIN 3<br />
	#define En_pin 2<br />
	#define Rw_pin 1<br />
	#define Rs_pin 0<br />
	#define D4_pin 4<br />
	#define D5_pin 5<br />
	#define D6_pin 6<br />
	#define D7_pin 7</p>
<p>File myFile;<br />
	LiquidCrystal_I2C lcd(I2C_ADDR,En_pin,Rw_pin,Rs_pin,D4_pin,D5_pin,D6_pin,D7_pin); //Create an instance of LCD<br />
	EnergyMonitor emon1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create an instance of EnergyMonitor<br />
	boolean run = false;<br />
	int ledR = 11;<br />
	int ledG = 12;<br />
	int ledB = 13;<br />
	unsigned long old_time=0;<br />
	unsigned long new_time=0;<br />
	double usekwh=0;</p>
<p>void setup()<br />
	{&nbsp;<br />
	&nbsp; Serial.begin(9600);<br />
	&nbsp; delay(1000);<br />
	&nbsp; emon1.current(1, 60.60606);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Current: input pin, calibration.<br />
	&nbsp; emon1.voltage(5,118.70,1.7);<br />
	&nbsp; lcd.begin (20,4,LCD_5x8DOTS);<br />
	&nbsp; lcd.setBacklightPin(BACKLIGHT_PIN,POSITIVE);<br />
	&nbsp; pinMode(ledR, OUTPUT);&nbsp;&nbsp;<br />
	&nbsp; pinMode(ledG, OUTPUT);<br />
	&nbsp; pinMode(ledB, OUTPUT);&nbsp;<br />
	&nbsp;</p>
<p>&nbsp; //Initialize the SD Card<br />
	&nbsp; //Serial.print(&quot;Initializing SD card...&quot;);<br />
	&nbsp; lcd.setBacklight(HIGH);<br />
	&nbsp; lcd.home();<br />
	&nbsp; lcd.print(&quot;Init. SD card...&quot;);<br />
	&nbsp; // On the Ethernet Shield, CS is pin 4. It&#39;s set as an output by default.<br />
	&nbsp; // Note that even if it&#39;s not used as the CS pin, the hardware SS pin<br />
	&nbsp; // (10 on most Arduino boards, 53 on the Mega) must be left as an output<br />
	&nbsp; // or the SD library functions will not work.<br />
	&nbsp; pinMode(10, OUTPUT);<br />
	&nbsp; lcd.setCursor(0,2);</p>
<p>&nbsp; if (!SD.begin(4)) {<br />
	&nbsp;&nbsp;&nbsp; //Serial.println(&quot;initialization failed!&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Init. Failed&quot;);<br />
	&nbsp;&nbsp;&nbsp; delay(5000);<br />
	&nbsp;&nbsp;&nbsp; return;<br />
	&nbsp; }<br />
	&nbsp; //Serial.println(&quot;initialization done.&quot;);<br />
	&nbsp; lcd.println(&quot;Init. done.&quot;);<br />
	&nbsp; delay(1000);<br />
	&nbsp; run=true;<br />
	&nbsp; lcd.clear();<br />
	&nbsp; usekwh=0;<br />
	}</p>
<p>void loop()<br />
	{<br />
	&nbsp; if(millis()&lt;15000){<br />
	&nbsp;&nbsp;&nbsp; usekwh=0;<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.home();<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Stabalizing current&quot;);<br />
	&nbsp; }<br />
	&nbsp; if (run=true) {<br />
	&nbsp; old_time=millis();&nbsp;<br />
	&nbsp; emon1.calcVI(20,2000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Calculate all. No.of half wavelengths (crossings), time-out<br />
	&nbsp; //emon1.serialprint();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Print out all variables (realpower, apparent power, Vrms, Irms, power factor)<br />
	&nbsp; double realPower&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = emon1.realPower;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Real Power into variable<br />
	&nbsp; double apparentPower&nbsp;&nbsp; = emon1.apparentPower;&nbsp;&nbsp;&nbsp; //extract Apparent Power into variable<br />
	&nbsp; double powerFActor&nbsp;&nbsp;&nbsp;&nbsp; = emon1.powerFactor;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Power Factor into Variable<br />
	&nbsp; double supplyVoltage&nbsp;&nbsp; = emon1.Vrms;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Vrms into Variable<br />
	&nbsp; double Irms&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = emon1.Irms;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Irms into Variable<br />
	&nbsp; String toFile=&quot;&quot;;<br />
	&nbsp; new_time=millis();<br />
	&nbsp; if (emon1.Vrms&lt;2) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; realPower=0;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; supplyVoltage =0;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; Irms=0;<br />
	&nbsp; }<br />
	&nbsp; usekwh+=(realPower * ((new_time-old_time))/3600000);<br />
	&nbsp; //Serial.print(ApparentWatts);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Apparent power<br />
	&nbsp; //Serial.print(&quot; &quot;);<br />
	&nbsp; //Serial.println(Irms);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Irms<br />
	&nbsp; //Serial.println(supplyVoltage,2);<br />
	&nbsp; //Display the information on the LCD<br />
	&nbsp; //Serial.println(new_time-old_time);<br />
	&nbsp; lcd.clear();<br />
	&nbsp; lcd.setBacklight(HIGH);<br />
	&nbsp; lcd.setCursor(0,0);<br />
	&nbsp; lcd.print(&quot;Real Pwr: &quot;);<br />
	&nbsp; lcd.print(realPower, 4);<br />
	&nbsp; lcd.print(&quot;W&quot;);<br />
	&nbsp;<br />
	&nbsp; lcd.setCursor(0,1);<br />
	&nbsp; lcd.print(&quot;Irms: &quot;);<br />
	&nbsp; lcd.print(Irms,4);<br />
	&nbsp; lcd.print(&quot;A&quot;);<br />
	&nbsp;&nbsp;<br />
	&nbsp; lcd.setCursor(0,2);<br />
	&nbsp; lcd.print(&quot;TkWh: &quot;);<br />
	&nbsp; lcd.print(usekwh,3);<br />
	&nbsp; lcd.print(&quot;&nbsp; &quot;);<br />
	&nbsp; lcd.print(new_time-old_time);<br />
	&nbsp; lcd.print(&quot;ms&quot;);<br />
	&nbsp;<br />
	&nbsp; lcd.setCursor(0,3);<br />
	&nbsp; lcd.print(&quot;V: &quot;);<br />
	&nbsp; lcd.print(supplyVoltage,2);<br />
	&nbsp; lcd.print(&quot;V&quot;);<br />
	&nbsp; lcd.print(&quot;&nbsp; &quot;);<br />
	&nbsp; lcd.print(new_time/(3600*1000),2);<br />
	&nbsp; lcd.print(&quot;hrs&quot;);<br />
	&nbsp; if (Irms&lt;=.25){<br />
	&nbsp;&nbsp;&nbsp;&nbsp; setColor(0,0,0);<br />
	&nbsp; }<br />
	&nbsp; else if ((Irms&gt;0.25) &amp;&amp; (Irms&lt;3)) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; setColor(0,255,0);<br />
	&nbsp; }<br />
	&nbsp; else if ((Irms&gt;=3) &amp;&amp; (Irms&lt;6)) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; setColor(100, 240, 0);<br />
	&nbsp; }<br />
	&nbsp; else if ((Irms&gt;=6) &amp;&amp; (Irms&lt;=10)) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; setColor(125, 125, 50);<br />
	&nbsp; }<br />
	&nbsp; else {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; setColor(255,0,50);<br />
	&nbsp; }<br />
	&nbsp; //Info for FileWrite<br />
	&nbsp; char tmp[10];<br />
	&nbsp; //timestamp info</p>
<p>&nbsp; toFile+=millis();<br />
	&nbsp; //Serial.println(toFile);<br />
	&nbsp;<br />
	&nbsp; toFile+=&quot;&nbsp; &quot;;<br />
	&nbsp; toFile+=dtostrf(realPower, 6,4,tmp);<br />
	&nbsp; toFile+=&quot;&nbsp; &quot;;<br />
	&nbsp; toFile+=dtostrf(Irms, 6, 4, tmp);<br />
	&nbsp; //Serial.println(toFile); //Show me what&#39;s written<br />
	&nbsp; /*<br />
	&nbsp; myFile = SD.open(&quot;test3.txt&quot;, FILE_WRITE);</p>
<p>&nbsp; // if the file opened okay, write to it:<br />
	&nbsp; if (myFile) {<br />
	&nbsp;&nbsp;&nbsp; myFile.println(toFile);<br />
	&nbsp;&nbsp;&nbsp; // close the file:<br />
	&nbsp;&nbsp;&nbsp; myFile.close();<br />
	&nbsp; }<br />
	&nbsp; else {<br />
	&nbsp;&nbsp;&nbsp; // if the file didn&#39;t open, print an error:<br />
	&nbsp;&nbsp;&nbsp; //Serial.println(&quot;error opening file&quot;);<br />
	&nbsp; }<br />
	&nbsp; }<br />
	&nbsp; */<br />
	&nbsp; //delay(500);<br />
	}<br />
	old_time=millis();<br />
	}</p>
<p>
	void setColor(int red, int green, int blue)<br />
	{<br />
	&nbsp; analogWrite(ledR, red);<br />
	&nbsp; analogWrite(ledG, green);<br />
	&nbsp; analogWrite(ledB, blue);&nbsp;<br />
	}</p>
<p>[/CODE]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14212"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 09/08/2013 - 10:24.</div>
    <div class="content">
     <p>The 0.2 s comes from the number of zero crossings (20) counted by calcVI, and it could be half a cycle longer while it waits for the first one to start counting. The delay is (or should be) in your main sketch.</p>
<p>I can&#39;t check all that now! Watch this space.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14217"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squareone&#039;s picture" title="squareone&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by squareone (not verified) on Fri, 09/08/2013 - 14:27.</div>
    <div class="content">
     <p>Hey Robert! &nbsp;Just so you know, a normal runtime from my &quot;old time&quot; and &quot;new time&quot; is about 70-100ms, which seems lower than I would have thought based on the .2s zero crossings. &nbsp;If the signal is 60 hertz, I would expect 20 zero crossings every 166ms as you suggested. &nbsp;Am I measuring the wrong block of time?</p>
<p>Sorry, alot of the code is LCDs and LEDs&nbsp;that I&#39;m using before I implement the SD card that is commented out here. &nbsp;The LCD and LEDs work fine. &nbsp;It&#39;s the (3600*1000) that I&#39;m weary of. &nbsp;I ran the dishwasher last night and it said 400kwh. &nbsp;Either my machine needs to never be used again or I made an error in the conversion, which is the more likely scenario! &nbsp;I saw on my output about 5.5A for a while, so if I was to do some math for a 1 hour run cycle at that draw, it should have been (5.5A * 120V)*1hr = .66kWh total. &nbsp;</p>
<p><strong>Edited in Bold</strong></p>
<p><strong>I think the error is that you cannot measure Watts and just multiply it by milliseconds. &nbsp;You must convert it to seconds and the multiple as you are looking to integrate the area of the power consumption curve and all units must match. &nbsp;This would mean the conversion should be:</strong></p>
<p><strong>usekwh+=(realPower * ((new_time-old_time))/(3600*1000*1000);&nbsp;</strong></p>
<p>I took the 3600000 from the Solar PV GLCD library since the emonGLCD displays the same kind of information I&#39;m looking to make as scrolling text on my LCD. &nbsp;It seemed to make sense because you have to convert the watts unit of time to hours which is the 3600 and then form kilo watts which is 1000 watts of course.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14226"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 09/08/2013 - 19:48.</div>
    <div class="content">
     <p>OK, I&#39;ve looked at your code.</p>
<p>1. Old-time = millis( ) is done at the end of loop( ) then again at the beginning - that&#39;s not right.</p>
<p>2. Tied in with that, usekwh is the energy measured over 10 cycles. It&#39;s not even a &#39;best guess&#39; at the energy for 1 complete loop.</p>
<p>3. I don&#39;t see why you&#39;re making a second copy of realPower etc.</p>
<p>4. I don&#39;t know what <strong>if (run=true)</strong> is doing. run has already been set to true, run=true is an assignment, not a logical comparison and in any case I think what you intended is redundant because loop( ) doesn&#39;t execute until setup( ) has completed. I think what you&#39;re trying to do is allow the software filters time to settle, and for that to happen you must run calcVI a number of times but ignore the values it returns. What I would do is:</p>
<p class="rteindent1">emon1.calcVI(20,2000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Calculate all. No.of half wavelengths (crossings), time-out</p>
<p class="rteindent1">if(millis()&lt;15000){<br />
	&nbsp;&nbsp;&nbsp; <strike>usekwh=0;</strike><br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.home();<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Stab<strong>i</strong>lizing current&quot;);<br />
	&nbsp; }<br />
	&nbsp; else {</p>
<p class="rteindent1">..... do everything else to the end</p>
<p>So long as your units are consistent, it doesn&#39;t matter what you actually use. But you need to pick sensible units for the accumulator to keep the numbers manageable. Watt-hours are probably a good choice (and sufficient precision as the billing unit is usually 1 kWh).</p>
<p>I assumed you were on a 50 Hz system hence 20 mS per cycle, so as you say 20 crossings should take 166 ms to 175 ms on a 60 Hz system, depending on how long it has to wait for the first crossing. But as I wrote above, you need to rethink what you are doing with time. I can&#39;t see why you need to measure the measurement period, don&#39;t you want to treat that power as representative of the power over the whole time of one loop - including writing to the display and the SD card - and use the loop time to estimate the energy. So immediately before you fetch new_time, you do old_time = new_time; then carry on as before, you never need to do old_time = millis( )</p>
<p><em>I ran the dishwasher last night and it said 400kwh.</em> That was quite a party then?</p>
<p>There&#39;s no such thing as ApparentWatts - they are called VA (volt-amperes).</p>
<p>And there are concerns with the life of an SD card when written frequently - I suggest you look at an alternative mechanism for storage - those who use it with&nbsp; RPi and emoncms see a life of a few months when written to every 5 s. Most seem to use a USB memory stick or a spinning hard disk.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14229"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squareone&#039;s picture" title="squareone&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by squareone (not verified) on Fri, 09/08/2013 - 20:47.</div>
    <div class="content">
     <p>Hey Robert,</p>
<p>I was seeing a weird .6khw show up at the beginning of the loops. &nbsp;I think it was from the system booting up and false signals creating some voltage and current in the system. &nbsp;If I reset it to zero for 15sec, it seemed to stabalize. &nbsp;I&#39;m quite certain I was off by a factor of 1000 now that I&#39;ve looked at it. &nbsp;I wonder how the GLCD&nbsp;loop calculates time or power because it is only dividing by (3600*1000). &nbsp;So either the conversion from ms is made OR the conversion to kwh and not both at the usekwh line of the cpp file. &nbsp;</p>
<p>ApparentWatts is just a name I made up so I knew that it was something other than the measured voltage and measured current. &nbsp;It is an artifact of older code since you got me all lined up on my hardware!</p>
<p>The run=true line allows the sd card time to boot up before the loops begin. &nbsp;I notice the loops started earlier than the SD card could catch up. &nbsp;It was very strange as I thought the Arduino would complete all of setup BEFORE the loops. &nbsp;It would activate the SD card, but the SD card wouldn&#39;t be up before the loops began. &nbsp;I haven&#39;t figured out the boot sequence yet on the Arduino.</p>
<p>I never thought to apply the power to the whole run-time, but you&#39;re right, I&#39;m missing power by only calculating it for the loops. I&#39;ll fix that tonight and try again.</p>
<p>Like you mentioned, I saw some strange calculations for the run-time at the beginning of the loops (i.e. up to 3 seconds to complete instead of 175ms). &nbsp;This generally lasts about 1 min and then evens out. &nbsp;I couldn&#39;t figure out why it was so slow. &nbsp;Is there a good reason for this?</p>
<p>I stole the following from the example code which is why i have most of these variables:</p>
<p>void loop()<br />
	{<br />
	&nbsp; emon1.calcVI(20,2000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Calculate all. No.of half wavelengths (crossings), time-out<br />
	&nbsp; emon1.serialprint();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Print out all variables (realpower, apparent power, Vrms, Irms, power factor)<br />
	&nbsp;<br />
	&nbsp; float realPower&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = emon1.realPower;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Real Power into variable<br />
	&nbsp; float apparentPower&nbsp;&nbsp; = emon1.apparentPower;&nbsp;&nbsp;&nbsp; //extract Apparent Power into variable<br />
	&nbsp; float powerFactor&nbsp;&nbsp;&nbsp;&nbsp; = emon1.powerFactor;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Power Factor into Variable<br />
	&nbsp; float supplyVoltage&nbsp;&nbsp; = emon1.Vrms;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Vrms into Variable<br />
	&nbsp; float Irms&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = emon1.Irms;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //extract Irms into Variable<br />
	}</p>
<p>Is that what you mean by the double declaration of realPower? &nbsp;Otherwise I don&#39;t see it initialized anywhere else.</p>
<p>Great to have you look it over. &nbsp;Thanks as always. &nbsp;TR</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14232"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 09/08/2013 - 21:34.</div>
    <div class="content">
     <p>There are software filters in emonLib that remove the offset that is inserted by the half-supply bias voltage in hardware. The wrong and high values on startup are while those settle. So as you found out, it is best to ignore the results totally while that is going on. But you must run the filters for them to settle.</p>
<p>The run=true line isn&#39;t doing what you intend. Read it again carefully. &quot;if (run=true) {&quot; is <strong>assigning</strong> the value true to run, that then always evaluates as true, so the statement is actually: if (true) {...&nbsp;&nbsp; so it is doing nothing useful.</p>
<p>(Hint: this is a very common C bug.)</p>
<p>But looking harder, I think the <em>return</em> in here is wrong.</p>
<p class="rteindent1">if (!SD.begin(4)) {<br />
	&nbsp;&nbsp;&nbsp; //Serial.println(&quot;initialization failed!&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Init. Failed&quot;);<br />
	&nbsp;&nbsp;&nbsp; delay(5000);<br />
	&nbsp;&nbsp;&nbsp; <strong>return;</strong><br />
	&nbsp; }</p>
<p>I think it will prematurely end setup( ), and crash into loop( ) with a failed SD card. Not what you wanted?</p>
<p>If there is a way to test the SD card, it needs to enter a loop within setup( ) and exit it when the SD card is proven OK, otherwise all you can do is put in a long delay before you end setup( ). If the card is proven not OK, it should enter a permanent loop, just displaying the warning and never exit, unless you want to show the data in any case, when you should make the SD card writes conditional on the SD card being healthy.</p>
<p><em>double realPower&nbsp;&nbsp; = emon1.realPower;</em> etc</p>
<p>You&#39;re not changing some of them except to make them zero on startup, and not using the rest at all, so it would be safer (less chance of you making a mistake) to remove them all and use emon1.realPower etc instead.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14265"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sun, 11/08/2013 - 20:11.</div>
    <div class="content">
     <p><em>squareone: My LCD is showing me a number I would consider too high for my dishwasher. &nbsp;I think maybe (3600s&nbsp;* 1000W) does not fully convert realPower to kWh. &nbsp;Any help is appreciated. &nbsp;</em></p>
<p>You may find it helpful to run one or more of the basic tools that appear at the start of my <a href="1757.html">Summary Page</a>.&nbsp; These will allow you to check how much of your ADC&#39;s input range is being used by your Current and Voltage sensors.&nbsp; The more range that you use, the better - providing that you never exceed the end-points.&nbsp; RawSamplesTool will give a graphical representation for each of your waveforms.</p>
<p>Using a simple resistive load, such as a 3kW kettle or a 60W light bulb, you can calibrate your measurement system to give the expected value.&nbsp; You should then have more confidence in the measured values for other household appliances such as your dishwasher.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14302"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="squareone&#039;s picture" title="squareone&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Where are the variables defined?</h3>

    <div class="submitted">Submitted by squareone (not verified) on Mon, 12/08/2013 - 20:37.</div>
    <div class="content">
     <p>Thanks Calypso. &nbsp;Looks like I was about to start working things you&#39;ve already thought of! &nbsp;Glad I have the library versus me creating it from scratch!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2669"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-Q_sY1PQ3rAKBMZp0uLhM_wiKTIhrUmKPKEBGK8LfUVg" value="form-Q_sY1PQ3rAKBMZp0uLhM_wiKTIhrUmKPKEBGK8LfUVg"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
