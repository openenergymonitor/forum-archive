<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/12184 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:54:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Energy diversion in an off-grid system | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Energy diversion in an off-grid system</h3>
        <span class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Tue, 16/02/2016 - 18:13</span>
        <div class="content"><p>This question is really aimed at the site moderators.</p>
<p>I&#39;ve written a longish article about the specific issues that I have found with surplus energy diversion in on off-grid system.&nbsp; It&#39;s about 5500 words plus 15 or so images. &nbsp; As well as the issues, I&#39;ve also describe my proposed solution based around EmonTx.</p>
<p>I&#39;d like to share the whole thing on OpenEnergyMonitor and I&#39;m just wondering where is the best place to put it.&nbsp; It seems a bit long compared to the typical forum post.&nbsp;</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="12378.html" class="topic-previous" title="Go to previous forum topic">‹ Label on y axis needed when posting visualisation to a website</a>
              <a href="12376.html" class="topic-next" title="Go to next forum topic">TED is DEAD: 0-3V 200A split core CTs from TED5000 on OpenEMON ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-39471"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 16/02/2016 - 21:47.</div>
    <div class="content">
     <p>If you post it, we can look at it and see where it best fits - unless you&#39;d like to attach it to a PM to me, if it&#39;s in a suitable format.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39522"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Fri, 04/03/2016 - 14:49.</div>
    <div class="content">
     <p>There is a lot of help and discussion on this web site about maximizing self-consumption of solar power under the heading &quot;Energy diversion.&quot;</p>
<p>I have an &quot;off-grid&quot; system and, based on my experience of operating this over the last 4+ years, I have come to two important conclusions: 1. that energy diversion in an off-grid system is more important than for a grid-connected system&nbsp; and 2. that the solutions for energy diversion in an on-grid system don&#39;t necessarily work in an off-grid system.</p>
<p>I&#39;ll briefly try and justify these two statements, before outlining my solution.</p>
<p>1. Energy diversion is more important in an off-grid system because one physically cannot export.&nbsp; The system does store surplus energy in batteries, but these are finite and can get full.&nbsp; Once batteries are full, if there is surplus production one MUST either adjust consumption so as to use it up, or reduce production.&nbsp; But reducing production would mean losing the&nbsp; value of the solar Feed-In-Tariffs - in my case that is 49p per unit, much greater than the 12p or so per unit that the typical on-grid person will benefit through self-consumption.</p>
<p>2. There are a couple of reasons why on-grid diversion systems aren&#39;t quite right for off-grid.&nbsp; Firstly the criterion for diverting is not just &quot;divert if there is excess power&quot; on its own, but rather &quot;divert if there is excess power AND the batteries are full&quot;.&nbsp; Secondly, the micro-grid is much more sensitive than the National Grid to harmonics and it doesn&#39;t like very frequent changes of load - ruling out both &quot;phase angle&quot; and &quot;burst mode&quot; diverters.&nbsp; [I should explain that our power production and consumption form a 230V AC &quot;micro-grid&quot; - there are other ways of being off-grid, for example one can be entirely DC but this is not for us].</p>
<p>Well, we do have an energy diversion system, and it does give us the benefits described in (1) above and it does avoid the problems described in (2) but it is far from perfect.&nbsp; I now think I know how to partly re-engineer it to be both more efficient and simpler.&nbsp; The purpose of this post is to describe the system and the proposed improvement in more detail, and if anyone has any feedback about this I would be very grateful.</p>
<p>I need to give a bit more background first.</p>
<p>I live in a normal domestic house with normal appliances.&nbsp; Everything is normal apart from not being connected to the National Grid.&nbsp;</p>
<p>The off-grid system that I have was originally built for me by the main importer of Victron devices, and is based around a <a href="https://www.victronenergy.com/inverters-chargers/multiplus-12v-24v-48v-800va-3kva" target="_blank">Victron MultiPlus inverter/charger</a>.&nbsp; The inverter/charger creates an &quot;AC micro-grid&quot; which the solar inverter also feeds into.</p>
<p>The overall set-up is shown in the picture below.&nbsp; An important thing to note is that between the solar inverter (red in the picture) and the inverter/charger (blue), power may flow in either direction (double-headed arrow in the picture.&nbsp;</p>
<p><img alt="Picture of off-grid set-up" src="../sites/default/files/OffGridSetupPartial.png" style="width: 700px; height: 644px;" /></p>
<p>The black lines indicate power flow and the green line indicates control information.&nbsp; Note the double-headed arrows, showing where power may flow in either direction:</p>
<p>If the output from the solar inverter is less than the load (washing machines, lights etc etc), then AC power will flow out of the inverter/charger.&nbsp; Unless the generator happens to be running, the inverter/charger will be extracting this power from the 48V battery bank.</p>
<p>If the output from the solar inverter is greater than the load, then the excess power flows into the inverter/charger and the inverter/charger uses it to charge up the batteries.</p>
<p>When the batteries are being charged in this way, by the excess solar power, then there is no control over the amount of power flowing into the batteries.&nbsp; The solar output is whatever it is, the loads are whatever they are, and the whole of the difference between them is going into the batteries.</p>
<p>This in itself is a bit undesirable: it seems to be generally agreed that the best way of charging lead-acid batteries is to follow a controlled &quot;charging curve&quot;, rather than just dumping randomly varying amounts of power onto them.&nbsp; But an even more basic problem is &quot;what happens when the batteries get full?&quot;&nbsp; As the batteries get more and more full, the inverter-charger has to raise the DC voltage in order to ensure that it can still get rid of all the excess AC power that is coming into it.&nbsp; Eventually we will reach the maximum safe voltage for the batteries.&nbsp; If we carry on shoving more power into the batteries - which at this point can&#39;t store any more - the batteries themselves will get rid of the excess power by (a) getting warmer and (b) electrolyzing the water to hydrogen and oxygen - &quot;gassing&quot; in other words.&nbsp; Both of these things are highly undesirable: at this point we are not merely wasting power, we are actively damaging the batteries.</p>
<p>In fact what happens is this.&nbsp; If the battery bank voltage rises beyond what is deemed to be a safe level, then the inverter/charger alters the frequency of the AC micro-grid, from the normal 50Hz up to 54Hz.&nbsp; When the solar inverter detects that the mains frequency has increased in this way, it takes it as a signal to turn itself off: to be precise it opens a relay so that it is no longer sending power into the micro-grid.&nbsp; (This is a standard way of signalling to a solar inverter that it needs to stop outputting).&nbsp;</p>
<p>Another thing I need to explain is that in the UK, an off-grid system IS eligible for feed-in tariffs (FITs).&nbsp; Despite their name, FITs are not a payment for feeding in to the grid, they are a payment for production.&nbsp; We have a meter on the output of the solar inverter; it measures all the AC produced from the solar inverter, and we get paid on the readings from that meter.&nbsp; As an early adopter, I am on a rate of about 49p per unit.&nbsp; The only thing we don&#39;t get is the &quot;deemed export payment&quot; but that is tiny by comparison.</p>
<p>So if my solar power turns itself off because it has been told to (via the frequency shift) by the inverter/charger signalling that it can&#39;t handle the power, then we are losing the 49p per unit that we would get if we use the power.&nbsp; In the absence of something (like immersion heaters) to absorb the extra power, this can lead to substantial losses.&nbsp; On a sunny summer day, the batteries will typically be full by mid-morning and then we would go through a very undesirable oscillation: solar power on, batteries full, battery voltage rises, inverter/charger signals the solar inverter to go off; solar inverter goes off, battery voltage falls, frequency goes back to normal, solar inverter comes on again, and repeat ad infinitum.&nbsp; It is not a rapid oscillation because there are time delays in the switching, but the point is that it leads to a considerable loss of solar production.</p>
<p>Here is an emonCMS screenshot showing the above scenario in action.</p>
<p><img alt="Solar power generation interrupted" src="../sites/default/files/SolarWhenBatteriesFull.png" style="width: 700px; height: 358px;" /></p>
<p>Each time that the solar power switches itself off, it waits about 2 minutes before coming on again.&nbsp; Then the batteries take about 3 minutes to reach maximum voltage again, and the whole cycle repeats.</p>
<p>I do in fact have a system that can switch in immersion heaters in this situation, so I don&#39;t suffer this problem.&nbsp; In the last 12 months a total of 1700 units of electricity have gone into my immersion heaters, meaning that I have earned about &pound;830 in FITs which I wouldn&#39;t have had if the solar had been switching itself off all the time as shown above.&nbsp; As well as the &pound;830 cash earned I have also benefited by not having to had to provide 1700 kWh of heat energy from other sources (which in my case would probably have come from wood).&nbsp; This also demonstrates why immersion heater diversion is much more important to an off-gridder (on a good rate of FITs) than it it is to someone who is on the National Grid.&nbsp; Someone who is on the grid who diverts a unit of electricity away from being exported and into their immersion heater instead basically benefits by getting a &quot;free&quot; unit of electricity (because exports aren&#39;t actually measured) - worth about 12p, say, whereas when I put a unit of electricity into my immersion heaters (when I would be &quot;exporting&quot; to the batteries but they are full) I not only get the free unit of electricity worth 12p but also the FIT payment worth 48p - a total benefit about 5 times that of the on-gridder.</p>
<p>I say all this, no to boast, but just to underline why the issue of immersion heater diversion is so important to anyone in my situation.&nbsp;</p>
<p>My solution to this problem is based around a <a href="http://www.4-noks.com/shop/self-consumption/power-reducer/?lang=en" target="_blank">product called the &quot;PowerReducer&quot;</a> from an Italian company called 4-noks.&nbsp; I have this product and I can say that it definitely works in this application.&nbsp; The reason that I have this particular product was because it was recommended by the original installers of the off-grid system who specifically stated that they had tried other types of power diverter and found that they were incompatible with the off-grid inverter charger (they said they had tried them and had actually been forced to take them out again).&nbsp; They didn&#39;t explain the reason for this but I think it is to do with the effect of different technologies on the sine wave of the power.</p>
<p>Here are 3 graphs taken from <a href="http://www.renewableenergyworld.com/articles/2013/09/the-importance-of-pv-immersion-control.html" target="_blank">www.renewableenergyworld.com/articles/2013/09/the-importance-of-pv-immersion-control.html</a> by Zuber Vindhani of 4-noks (it&#39;s worth reading the whole thing)</p>
<p><img alt="Phase angle control" src="../sites/default/files/phase-angle-trailing-edge.jpg" style="width: 600px; height: 320px;" /></p>
<p><img alt="Burst fire graph" src="../sites/default/files/burst-fire.png" style="width: 589px; height: 73px;" /></p>
<p><img alt="Burst fire graph" src="../sites/default/files/burst-fire2.png" style="width: 599px; height: 79px;" /></p>
<p><img alt="Pulsed AC" src="../sites/default/files/ac-pulse-width-modulation.png" style="width: 552px; height: 385px;" /></p>
<p>The basic problem that is being addressed is this: you&#39;ve got a fixed AC voltage, a fixed resistive load (eg immersion heater), and you want to vary the amount of power being taken by the resistive load.&nbsp; The three graphs represent three different ways of solving the problem, respectively named &quot;phase angle (trailing edge dimmer)&quot;, &quot;burst fire&quot; and &quot;pulse width modulation&quot;.&nbsp; It is this last method that is used by the 4-noks Power Reducer, and they claim that it is superior to the other methods.&nbsp; Zihani says</p>
<blockquote><p>&quot;By smoothing over the wave form, this method of control inherently reduces the level of harmonics generated through modulation &ndash; inducing little distortion to the overall sine wave. PWM is designed to reduce harmonics in apt wave-forms and enables this by producing a &lsquo;quasi-sine wave&rsquo;.&nbsp;</p>
</blockquote>
<blockquote><p>&quot;Following rigorous testing, 4-noks have found PWM to be the most suitable in altering the energy diverted to the load, whilst causing the least strain on the AC sine wave. With the inclusion of specific filters, harmonic emissions can be contained to acceptable levels, enabling the solution to meet the stringent CE and EMC compliancy for the domestic class.&quot;</p>
</blockquote>
<p>I think it is the question of harmonics that is crucial in the off-grid system.&nbsp; The National Grid doesn&#39;t really care if you pump out a few harmonics - it is huge and your little bit of noise will get lost.&nbsp; In a little one-house micro-grid, on the other hand, these harmonics can represent a substantial portion of the total power.&nbsp; To put it another way, look at this from the point of view of the inverter/charger.&nbsp; The inverter/charger&#39;s job is to create a sine wave.&nbsp; However if there is a phase-angle control dimmer in control of a lot of the power, then the inverter/charger has got a real problem: part of each sine wave cycle will be at high power, and the rest of the cycle at much lower power.&nbsp; Things are not much better with burst mode.&nbsp; Say that we have bursts of 3 cycles on, 3 cycles off.&nbsp; Suppose that there is a 200W normal load and a 3kW immersion heater connected through a burst mode controller.&nbsp; Then we are saying to the inverter/charger at one moment &quot;please output 3.2kW&quot;, then 0.06 seconds later we are asking it to output 0.2kW, then 0.06 seconds after that we are asking form 3.2kW again and so on.&nbsp;&nbsp; The National Grid doesn&#39;t mind if you do that, but it&#39;s a lot to ask from a 5kW inverter/charger.</p>
<p>That&#39;s the theoretical basis for saying that the Power Reducer will work in an off-grid system, and it seems that practical experience shows that it is indeed so.&nbsp;</p>
<p>There are a few points that are worth noting.&nbsp; Firstly the pulses are much narrower than the above graph would suggest.&nbsp; The technical manual for the Power Reducer says &quot;PWM a 19.2kHz&quot; - that would be 384 pulses per mains cycle.&nbsp; Secondly, I think that as well as just chopping up the sine wave, the Power Reducer has considerable ability to smooth it out again.&nbsp; Below is a picture of the innards of the Power Reducer and at the top of the picture I can see a very big chunky coil at the top centre of the picture.&nbsp; I have no idea how the thing works in detail but I&#39;m guessing that this coil has something to do with smoothing out the dents in the sine wave (in fact, to be precise, I think I&#39;m right in saying that the output from the Power Reducer is very much NOT a sine wave, but the smoothing means that the distortion does not feed back to the input, which is what matters).</p>
<p><img alt="Power Reducer Internals" src="../sites/default/files/power-reducer-innards-resized.jpg" style="width: 600px; height: 719px;" /></p>
<p>This problem of distorting the sine wave is obviously a well-known problem and the Power Reducer is not the only appliance to address it.&nbsp; For example the <a href="https://www.immersun.co.uk/" target="_blank">well-known ImmerSUN product</a> says</p>
<blockquote><p>The immerSUN uses TruSine&trade; power control technology. This means that the voltage is very smoothly adjusted to alter the power to the heater. The power going to the load is a non-distorted true sine wave, only the voltage is altered. This control technology is unique to the immerSUN and is more sophisticated than any similar product on the market. TruSine&trade; technology ensures trouble free operation with all inverters and compatibility with all import/export energy monitors [from https://www.immersun.co.uk/wp-content/uploads/2014/08/Instruction-Manual-v1.1.pdf]</p>
</blockquote>
<p>So possibly the ImmerSUN works in the same way as the Power Reducer; perhaps it is superior - I don&#39;t know.&nbsp; However the Power Reducer does have on advantage that is crucial for an off-grid situation: <u>it can be controlled by a 0-10V analog input</u>.&nbsp; So send it 10V and it will utilize the full resistive load; feed it 5V and it will output half that power, and so on.&nbsp;</p>
<p>It is this ability to control it via a 0-10V signal which I intend to base my solution around.</p>
<p>There are several different ways in which you can control the Power Reducer (ie tell it how big a pulse width to output at any particular moment).&nbsp;</p>
<p>One option is that you can set up the Power Reducer to get its control information directly from a CT (current transformer) on the house&#39;s grid connection.&nbsp; In this set-up the Power Reducer will (if there is excess power that would otherwise be exported) draw just enough power to reduce the export to around zero.&nbsp;</p>
<p>However, there is another option: you can also connect the Power Reducer to a separate external control device.&nbsp; In this scenario the external device tells the Power Reducer how much power to output, via the 0-10V analog input (in the picture above the analog input is the grey cable connected to the green terminal block at the bottom.)&nbsp; For this scenario, the manufacturers of the Power Reducer recommend (or specify) something called the <a href="http://www.elios4you.co.uk/" target="_blank">Elios4You</a>. The Elios4You is what I have got at the moment.</p>
<p><img alt="Elios4You" src="../sites/default/files/Elios4You-resized.jpg" style="width: 432px; height: 768px;" /></p>
<p>Elios4You is at heart a monitoring device: it uses CTs to measure your solar generation, load, and net power consumption (import or export).&nbsp; It will communicate over your LAN by WiFi and there are Apple and Android apps with cool visuals showing all this data in real time.&nbsp; However, as well as just monitoring and visualization, the Elios4You also has the ability to create the 0-10V analog control voltage that the Power Reducer needs.&nbsp; This is how mine is set up.&nbsp; The Elios4You acts as a PID controller (see <a href="https://en.wikipedia.org/wiki/PID_controller" target="_blank">en.wikipedia.org/wiki/PID_controller</a> ) - that is to say it has a feedback mechanism which means, basically, that it will continually vary the 0-10V analog signal until it finds the point where your export is zero (assuming that you have got excess power).&nbsp; If the sun comes out or goes in, or if the load from the house changes, the PID controller will rapidly find the stable point.</p>
<p>This is fine in an on-grid situation, but for an off-grid set-up there is a problem: the Elios4You knows nothing about the battery charging.&nbsp; The Elios4You wants to keep the amount of power that is exported to be slightly positive but as small as possible.&nbsp; In the case of an off-grid system this is not what we want: we do want power to be exported to the batteries provided that they are not full - but the Elios4You has no way of knowing about this.</p>
<p>So there is yet another component in the system, to address this problem.&nbsp; This is a bespoke box containing a <a href="http://www.schneider-electric.co.uk/en/product-range/531-zelio-logic" target="_blank">Schneider Zelio Logic plc</a> running some specially written logic.&nbsp; The Zelio Logic plc does have access to data about the battery voltage (though only in a limited way, as I shall shortly make clear) and it controls a relay that can turn on or off the supply of power coming out of the 4noks Power Reducer.&nbsp; So if (a) the plc thinks the batteries need charging and (b) there is excess solar power, the Zelio Logic plc will open its relay and then the Power Reducer&#39;s AC (modulated) output will be open-circuited. In this scenario even though the Elios4You is telling the plc that power is being &quot;exported&quot; and therefore it should be pushing some power out to the immersion heaters, the Power Reducer cannot do so because its output has been disconnected.&nbsp; Consequently, in this scenario, the excess power does flow to the batteries and they charge up.</p>
<p><img alt="Zelio PLC" src="../sites/default/files/ZelioPLC.jpg" style="width: 432px; height: 768px;" /></p>
<p>In the above photo, the Zelio Logic plc is the white box with an LCD display.&nbsp; The rest is basically trip switches and relays.&nbsp; The current transformers that measure the output to each of the two immersion heaters (via EmonTX3) can be seen in blue.</p>
<p>That, then, is the system that I have got and it does meet its main objective, ie it means that we never get to the situation where the inverter/charger wants to cut off the solar power because the battery voltage is too high.&nbsp; The plc closes its relay, and the Power Reducer diverts the excess power, before we ever get to that situation.&nbsp; And on sunny days, the batteries do get sort of more or less fully charged before the excess power diversion cuts in.&nbsp;</p>
<p>But there is still a problem with this set-up too.&nbsp;&nbsp; The main issue is that the Schneider plc gets its information about the battery voltage from another device:&nbsp; a Telemecanique RM4UA.&nbsp; This is a voltage-triggered relay: that is to say, it closes when a set voltage is exceeded.&nbsp; There is a little bit of sophistication to this, but not much.&nbsp; The voltage threshold is adjustable, as is the &quot;hysteresis&quot;, that is to say, if it closes when the voltage exceeds 58V then it will not open again until the voltage falls below 55V.&nbsp; The difference, 3V, being the hysteresis.&nbsp; However the minimum hysteresis that can be set is 5% of the threshold, so there is quite a big gap (for example if the threshold is set to 58V, then the minimum hysteresis will be 2.9V).&nbsp; There is also an adjustable time delay on the relay either opening or closing, although this seems to be set at zero in my set-up.</p>
<p><img alt="RM4UA" src="../sites/default/files/RM4UA.jpg" style="width: 432px; height: 744px;" /></p>
<p>Here is a diagram of the total system, as it exists at the time of writing this post.</p>
<p><img alt="" src="../sites/default/files/OffGridSetupFull2.png" style="width: 600px; height: 424px;" /></p>
<p>The Zelio Logic plc does not know the actual battery voltage; it only knows whether the RM4UA&#39;s relay is open or closed.&nbsp; We may say that as far as the Zelio Logic plc program is concerned, the battery voltage is in one of two states: the voltage is too low; or the voltage is too high.&nbsp;</p>
<p>The consequence of this is that the Zelio Logic plc is always oscillating between switching the power to the Power Reducer on, and switching it off again.&nbsp; The PowerReducer is capable of finding the stable spot where the amount of power flowing to the batteries is just a trickle, but this isn&#39;t what we want.&nbsp; What we actually want is for the PowerReducer to find the stable spot where the exact amount of power going to the immersion heaters is just enough to leave enough power over to keep the batteries at 58V.&nbsp; This can&#39;t be achieved by the present set-up.</p>
<p>So that is the problem.&nbsp; The present set-up is not only excessively complicated (and it is actually more complicated than I have described; I&#39;ve only included the essential features) but it doesn&#39;t really achieve what I want.</p>
<p>To sum up.&nbsp; What I want is to have the PowerReducer push out just the right amount of power (at any given moment) to the immersion heaters that leaves just enough power flowing to the batteries to keep them at 58V.</p>
<p>My proposed solution is to take out the Zelio Logic plc (and the relay that it controls), take out the Elios4You and take out the RM4UA voltage relay, and build a single new device which would replace all three.&nbsp; This new device would be based on an emonTx.&nbsp; This new device would&nbsp;</p>
<p>(a) know about the battery voltage, not just as a &quot;too low vs too high&quot; binary variable, but as a continuous variable so that it knows how close it is to the required voltage and</p>
<p>(b) know whether the generator is running (via a CT on the generator output)</p>
<p>(c) would directly control the PowerReducer by feeding it a 0-10V control signal.&nbsp;</p>
<p>The device that I have in mind would have the battery voltage as an analog input (stepped down by a voltage divider).&nbsp; It would have a 0-10V analog signal as an output - this output would go to the Power Reducer as its control signal.&nbsp; If the battery voltage exceeds 58V, the device would increase the 0-10V analog output.&nbsp; If the battery voltage goes below 58V, the device would decrease the 0-10V analog output.&nbsp; In this way, it would hunt for and find the precise 0-10V output that would keep the batteries very close indeed to 58V.&nbsp; If conditions change, ie the sun comes out, or someone switches something on or off, then the amount of excess power flowing to the batteries would change, and the voltage would move away from 58V.&nbsp; As soon as that happened, the device would start hunting for the new point where the battery voltage would be 58V again.</p>
<p>I have in mind to create this device from an EmonTxV4 with some extra circuitry to (a) step down the battery voltage to a level where the emonTX can receive it and (b) boost the analog output to the 0-10V range.&nbsp; Obviously it would need modified firmware too.</p>
<p>I shall now go into some detail about my ideas for this proposed system.</p>
<p>The EmonTXv3.4 has 8 analog inputs (numbered A0 thru A7) plus 14 digital IO (input-output) pins, numbered D0 thru D13). The 8 analog inputs can also be used for digital I/O, for which purposes they are numbered D14 through D21 (so A0 = D14, A1= D15 etc)</p>
<p>6 out of the 13 digital IO pins can provide a sort of pseudo-analog output by means of pulse width modulation (PWM). They are D2, D3, D5, D6, D10 and D11.</p>
<p>6 out of the 8 analog inputs are &quot;hard-wired&quot; to specific monitoring inputs, ie A0 is AC voltage, A1 thru A4 are current measurements and A7 is hard-wired to the internal battery.</p>
<p>Therefore in the emonTxV3.4 there are two &quot;spare&quot; analog inputs: A5 and A6. A5 (/D19) is wired to pin 5 of the green terminal block. A6 is wired to pin 8 of the RJ45 socket.</p>
<p>In the standard sketches, pin A5/D19 is used to power on and off a DS18B20 temperature sensor. However, this is purely a function of the firmware; as far as the emonTX hardware is concerned A5/D19 can be used for anything.</p>
<p>Also, in the standard sketches, pin D5 is used for DS18B20 temperature sensor data communications. But again this is purely a function of the firmware; as far as the emonTX hardware is concerned pin D5 can be used for anything.</p>
<p>Here is the information in a table:</p>
<table border="1" cellpadding="1" cellspacing="1" style="width: 600px;">
<tbody>
<tr>
<td>&nbsp;</td>
<td>Analog write (PWM) capable?</td>
<td>Analog read capable?</td>
<td>Digital read/write</td>
<td>EmonTxV3.4 hardware</td>
<td>EmonTX firmware</td>
<td>Green terminal block</td>
<td>RJ45 socket</td>
</tr>
<tr>
<td>A0/D14</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y</td>
<td>AC voltage</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>A1/D15</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y</td>
<td>AC current</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>A2/D16</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y</td>
<td>AC current</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>A3/D17</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y</td>
<td>AC current</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>A4/D18</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y</td>
<td>AC current</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>A5/D19</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y</td>
<td>&nbsp;</td>
<td>DS18B20 power</td>
<td>5</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>A6/D20</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>8</td>
</tr>
<tr>
<td>A7/D21</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>internal battery</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D0</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>serial port</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D1</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>serial port</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D2</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y</td>
<td>RFM12B radio</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D3</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>4</td>
<td>6</td>
</tr>
<tr>
<td>D4</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D5</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y</td>
<td>&nbsp;</td>
<td>DS18B20 data</td>
<td>6</td>
<td>4</td>
</tr>
<tr>
<td>D6</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y</td>
<td>LED</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D7</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D8</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>DIP switch</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D9</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>DIP switch</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D10</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y</td>
<td>RFM12B radio</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D11</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y</td>
<td>RFM12B radio</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D12</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>RFM12B radio</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D13</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>Y</td>
<td>RFM12B radio</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>This is a simplified and adapted version of the chart at <a href="http://wiki.openenergymonitor.org/index.php/EmonTx_V3.4#Port_Map" target="_blank">wiki.openenergymonitor.org/index.php/EmonTx_V3.4#Port_Map</a></p>
<p>I need an unused analog input for the battery bank monitoring and an unused PWM-capable output for the 0-10V control output.&nbsp; The obvious thing is to use analog A6 and digital D3 respectively, and both of these are already connectible to the outside world through the green terminal block and/or the RJ-45 connector.&nbsp; &nbsp;That way I can continue to also use the DS18B20 temperature monitoring function - I don&#39;t need to hijack its connections.</p>
<p>For battery bank monitoring, I need to scale down the voltage.&nbsp; The battery bank has a nominal 48V but can go up to 60V while charging.&nbsp; To give a safety margin I&#39;m going to call this 72V.&nbsp; So I need to scale this down to 5V for monitoring purposes.&nbsp; Here&#39;s my proposed set-up.</p>
<p><img alt="Voltage divider" src="../sites/default/files/VoltageDivider.png" style="width: 600px; height: 514px;" /></p>
<p>That was the easy bit.&nbsp; Less easy is the output side.&nbsp; The PWM output will produce a pulsed output which spends some of the time at 5V, some of the time at 0V, with the average being the requested percentage of 5V (eg analog write 25% would produce an average of 1.25V).</p>
<p>So the pulsed output signal needs to have two things done to it:&nbsp; (a) it needs to be smoothed and (b) it needs to be doubled, from 0-5V range up to 0-10V range.&nbsp; After much poking about on the internet, I find that the solution to the smoothing is a something called a &quot;low-pass filter&quot; and the solution to doubling the voltage is something called an op-amp.&nbsp;</p>
<p>That&#39;s the broad principle, but what values of resistors and capacitors does one need, and which of the many thousand op-amps out there is the right one for this application?&nbsp; As usual, the information is out there on the internet somewhere but the challenge is to filter out the good advice from the rest.&nbsp; After a few more weeks of blundering about, I came across an excellent freeware tool called LT Spice IV, which can be found here: <a href="http://www.linear.com/designtools/software/#LTspice" target="_blank">www.linear.com/designtools/software/#LTspice</a> It&#39;s a desktop program and I found it very easy to sketch a simple circuit and emulate its behaviour.</p>
<p>Now that I know about SPICE, I see that there are quite a few references to in this site. But it&#39;s like a lot of things in life, until I found it I wasn&#39;t looking for it because I didn&#39;t know I needed it.</p>
<p>Here&#39;s one of my sketches using LT Spice IV.&nbsp;</p>
<p><img alt="LT Spice circuit diagram" src="../sites/default/files/LTSpice-LM324.png" style="width: 600px; height: 236px;" /></p>
<p>But then I hit a problem with this program.&nbsp; Out of the box, it comes with a &quot;library&quot; of integrated circuits, and (since the program is provided by Linear Technology) it is no surprise that the library only contains devices made by LT themselves.&nbsp; SPICE is a standard, so you can import other manufacturer&#39;s devices into the library and I managed to do it for the LM324 as shown above, but I didn&#39;t figure out how to do a bulk import of another manufacturer&#39;s devices.&nbsp; Looking for op amps on-line in retail quantities, I found that the most popular brands by far were Texas Instruments and Analog Devices.&nbsp; So at this point I have a mis-match: I can design circuits using LT devices, but I can most easily buy TI devices.&nbsp; Not only are the TI devices easier to buy but I found it easier to work out exactly which one I needed using their very powerful selector tool, eg <a href="http://www.ti.com/lsds/ti/amplifiers-linear/precision-amplifier-products.page#~p78=In;Out&amp;p1498=Catalog&amp;p2954=PDIP&amp;p1261max=16;16&amp;p480=1;1" target="_blank">http://www.ti.com/lsds/ti/amplifiers-linear/precision-amplifier-products.page#~p78=In;Out&amp;p1498=Catalog&amp;p2954=PDIP&amp;p1261max=16;16&amp;p480=1;1</a> returns just 4 results.</p>
<p>So, rather than figure out how to import TI devices into the LT SPICE IV library, it seemed easier to download the equivalent TI SPICE program, which is called TINA-TI.&nbsp; This can be downloaded from <a href="http://www.ti.com/tool/tina-ti" target="_blank">www.ti.com/tool/tina-ti</a> (Top tip if downloading this program: you have to register and when you do so, don&#39;t put special characters in your password - it doesn&#39;t reject them but their server returns a 504 server error!&nbsp; Maybe only certain special characters do it, I don&#39;t know, I found this solution by trial and error).</p>
<p>So after finally managing to register with TI, I downloaded the program.&nbsp; Having compared LT SPICE IV with TINA-TI I would say that the LT program is more user-friendly, somewhat more intuitive to use for a beginner, and it produces nice easy-to-see circuit diagrams that look like engineering &quot;blueprints&quot; (eg above).&nbsp; However the TI program is probably more powerful.&nbsp; I&#39;m quite glad that I came across LT-Spice first, because it gave me a chance to get used to the concepts whereas I might have got depressingly bogged down if I had tried to use TINA-TI before I had any experience.</p>
<p>My shortlist of just 4 TI op-amps was based on a number of criteria, including simple things like through-hole mounting but also, importantly &quot;rail-to-rail&quot; operation.&nbsp; Here&#39;s my proposed circuit in the TI SPICE tool.&nbsp;&nbsp;&nbsp;</p>
<p><img alt="Filter and op-amp circuit" src="../sites/default/files/0To10V-V1.png" style="width: 700px; height: 222px;" /></p>
<p>Resistor R5 represents the input impedance of the PowerReducer&#39;s 0-10V input (the PowerReducer&#39;s manual helpfully gives this figure of 5k ohms).&nbsp; The Op Amp&#39;s 10V power supply will actually come from the Power Reducer, I have decided.&nbsp; The Power Reducer has three DC connections: ground, 0-10V control, and +10V.&nbsp; It took me a while to figure it out, but eventually I realised that the +10V connection is actually an output from the PowerReducer, not an input as I had originally assumed.&nbsp; I verified this by connecting the PowerReducer to its AC input only (DC inputs all disconnected) and then measuring the voltage between the ground and +10V connections: it turned out to be a nice steady 10.15V.&nbsp; In the present set-up.&nbsp; Also, the set-up manual for the Elios4You describes the three corresponding terminals as</p>
<p>16: Out 3.3V/In 10V<br />
17: In Dig4 / Out 0-10V<br />
18: Gnd (0-10V)</p>
<p>So the way it works is that the PowerReducer sends the Elios4You a steady +10V and the Elios replies with a signal in the range 0-10V, indicating what proportion of the immersion heater load it wants to be used.</p>
<p>I therefore decided that the neatest thing would be to use this +10V as the Power supply to my Op Amp.&nbsp; Not only does this save having to go out and buy a separate power supply; it also (it seems to me) emulates rather closely the present set-up.</p>
<p>Having made the decision to use the +10V from the PowerReducer as the power supply, a consequence is that I need a &quot;rail to rail&quot; op amp, because I want to output all the way up to +10V.&nbsp; That helps to narrow down the choice of op amps quite a lot, and then my other criteria are &quot;must accept power supply of 10V or greater&quot; and &quot;must have through-hole mounting option&quot;.&nbsp; That&#39;s how I got it down to a choice of just 4 possible TI models, and then I selected the TLV2402 as shown in the circuit diagram above.</p>
<p>One thing that I haven&#39;t mentioned so far is that not all this equipment is in the same place.&nbsp; The battery bank and solar inverter are in an outbuilding, whereas the immersion heaters are in the main house, about 70m away.&nbsp; The 4-noks PowerReducer needs to be near the immersion heaters, not in the outbuilding (if it was in the outbuilding then I would have to run another 70m of mains cable between the two buildings, and it has to be SWA - steel wire armoured - cable which is both expensive and awkward to install).&nbsp;</p>
<p>My plan, therefore is to put the filtering components next to the EmonTx (in the same case if I can fit them in), but have the op amp bits and pieces 70m away in the main house, next to the actual immersion heater.</p>
<p>As I understand it, one of the main things about an op-amp is that it will draw only a very small current from its inputs, while being able to deliver a higher current, if required, at its outputs.&nbsp; So, by putting the op-amp in the main house, we ensure that the 70m of thin wire only has to carry a small current at 0-5V, thus minimizing any worries about voltage drop along this thin wire (I intend to use standard UTP cable which is already in place between the two buildings).&nbsp;</p>
<p>Having built the circuit in TINA-TI, I have run a few simulations.&nbsp; I tried it with a 0% pulse, 50% pulse, 75% pulse, and steady +5V from the EmonTx and here are my results.&nbsp; The first one has a 50% pulse starting after 0.5s.&nbsp;</p>
<p><img alt="Output voltage with 50% pulse" src="../sites/default/files/50Percent.png" style="width: 700px; height: 319px;" /></p>
<p>Incidentally, the output while the pulse is 0% is around 130mV rather than exactly zero - I hope that this doesn&#39;t cause problems.&nbsp; The good news is that I can&#39;t detect the tiniest bit of ripple in this output.&nbsp; The &quot;reaction time&quot; to the change is well within half a second, which I think will be more than adequate for my purposes.&nbsp; Here it is with a 75% pulse (again starting after half a second)</p>
<p><img alt="Output voltage with 75% pulse" src="../sites/default/files/75Percent.png" style="width: 700px; height: 318px;" /></p>
<p>&hellip; and finally here it is with 100% output (steady 5V).</p>
<p><img alt="Output voltage when input is constant 5V" src="../sites/default/files/100PerCent.png" style="width: 700px; height: 267px;" /></p>
<p>&hellip;and the maximum output here is indeed 9.869V.</p>
<p>One problem here is that I tried and failed to work out how much power the op amp would be taking from the 10V power supply.&nbsp;</p>
<p>Looking at my circuit above, TINA is giving me the following current readings (50% pulse, steady state):</p>
<table border="1" cellpadding="1" cellspacing="1" style="width: 500px;">
<tbody>
<tr>
<td>Op amp pin 8 (power supply)</td>
<td>2.46&micro;A</td>
</tr>
<tr>
<td>Op amp pin 3 (input)</td>
<td>-24.39&micro;A</td>
</tr>
<tr>
<td>R3</td>
<td>4.88&micro;A</td>
</tr>
<tr>
<td>R5</td>
<td>-988&micro;A</td>
</tr>
</tbody>
</table>
<p>all measured in the direction where into the op amp is positive.&nbsp; Surely these should sum to zero?&nbsp; The R5 figure is surely correct (delivering 5V to a 5kohm impedance is around 1mA but where is this 1mA coming from?&nbsp; And surely Op amp pin 3 (input) should be positive current, however small?</p>
<p>On reflection I think I will change my mind about using the +10V from the PowerReducer as the OpAmp&#39;s power supply.&nbsp; I think I&#39;ll buy an off-the-shelf 12V power supply and use that.&nbsp; I don&#39;t understand the electronics well enough and the less I fiddle with the PowerReducer the better.&nbsp; It&#39;s an expensive bit of kit and I don&#39;t want to ruin it!</p>
<p>One thing I have said almost nothing about is implementing the PID controller in the EmonTx firmware.&nbsp; I&#39;m not so worried about this as I have a maths and computing background so I feel much more confident here than I do with the electronics.&nbsp; One thought I have is that there may well be a bit of a time delay before the battery voltage reacts to any load adjustment. So I&#39;ll need to have a fair bit of damping in there to ensure that it doesn&#39;t overshoot and oscillate.&nbsp; As long as it converges I don&#39;t think it will matter if it takes several seconds over it.&nbsp; I can experiment with this once I&#39;ve built the thing!</p>
<p>Well that&#39;s it for the time being.&nbsp; I wonder if anyone has read this far.&nbsp; I really would be grateful for any feedback, suggestions etc, and I&#39;d be happy to answer any questions that people may have about the setup.</p>
<p>Edit added 4 Mar 2016: if anyone is thinking of following this project and doing something similar, please be aware that I have not described all the safety features of the system.&nbsp; In particular, when sampling the voltages from a battery bank like this, there must be good protection against the consequences of short circuits, as these batteries can pack quite a punch.&nbsp; See in particular <a href="#comment-39969">this comment</a> and <a href="#comment-40107">this comment</a> and don&#39;t do it unless you really know what you are doing!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39526"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 18/02/2016 - 15:36.</div>
    <div class="content">
     <p>Thanks for posting all this. I think it deserves not to get buried in the forums so don&#39;t be too surprised if it disappears from here.</p>
<p>On the point of &quot;<em>how much power the op amp would be taking from the 10V power supply</em>&quot;, the answer&nbsp;is very little. The main current draw is the output current into the load, yes, it comes out of the supply. You know that is not greater than 2 mA (10 V into 5 k&Omega;). Added to that is the &quot;quiescent current&quot; - the data sheet gives you that, it&#39;s 1290 nA (yes, nano) per channel (so &times;&nbsp;2, worst case). My bet is that the 10 V output is designed to have a potentiometer connected to it in order to provide the variable input (control) voltage, so I wouldn&#39;t hesitate to connect your op-amp circuit to it.</p>
<p>I would hesitate at sending a high impedance signal the 70 m from your emonTx to the op-amp, I strongly suggest you send the PWM switched 5 V signal down the wire and have the filter next to the op-amp, because it&#39;ll need much more interference to mess up the signal before filtering than after, and the filter will take a lot of it out anyway, should it get in. If the 130 mV minimum output causes problems, it should be possible to do something about it. Try (in your simulation) connecting a resistor from the 10 V supply to the - input of the op-amp, and see what effect various values have. I&#39;d try a value&nbsp;of about 390&nbsp;k&Omega;.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39535"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 19/02/2016 - 08:50.</div>
    <div class="content">
     <p>There&#39;s lots of good stuff in there, and your simplification+improvement project sounds like a fun one. &nbsp;One issue I noticed that might cause you some grief is your resistor divider to monitor the battery voltage. &nbsp;I think it has an equivalent impedance of about about 64k (R1 and R2 in parallel). &nbsp; You really want that to be below 10k in order to get the ADC&#39;s sample-n-hold capacitor charged in time. &nbsp; &nbsp;You can see the Amtel&nbsp;datasheet for that 10k requirement, and a bit of a discussion on it (and scope trace)&nbsp;in this thread: &nbsp;<a href="11011.html">http://openenergymonitor.org/emon/node/11011</a></p>
<p>P.S. &nbsp;I&#39;m blown away that you Brits get paid for generating electricity even when you have no connection to the grid. &nbsp;For us foreigners, you might consider moving that detail closer to the beginning of your excellent write-up, as I was struggling with all the&nbsp;early talk about you not wanting to lose your FiT when you&#39;d declared it was all off-grid. &nbsp;I eventually got as far as &quot;Another thing I need to explain is....&quot; and all was indeed explained.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39539"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Fri, 19/02/2016 - 09:52.</div>
    <div class="content">
     <p>Hello Robert, thank you very much for that.&nbsp; Here is the revised circuit:</p>
<p><img alt="Revised filter and op amp circuit" src="../sites/default/files/0To10V-V2.png" style="width: 700px; height: 180px;" /></p>
<p>At first I thought that when you said &quot;Try (in your simulation) connecting a resistor from the 10 V supply to the - input of the op-amp&quot; you meant connect the new resistor to the inverting input of the op amp, but that didn&#39;t work. Then I figured out that you meant connect it to the negative of its power supply (pin 4 in the diagram): that worked like magic! (Slow on the uptake but all this is still very new to me).</p>
<p>I have tried the circuit with various values as here:</p>
<table border="1" cellpadding="1" cellspacing="1">
<tbody>
<tr>
<td>R6</td>
<td>Output when input is zero</td>
<td>Output when input is constant +5V</td>
</tr>
<tr>
<td style="text-align:right">39k&Omega;</td>
<td>22.45mV</td>
<td>9.87V</td>
</tr>
<tr>
<td>100k&Omega;</td>
<td>17.65mV</td>
<td>9.87V</td>
</tr>
<tr>
<td>390k&Omega;</td>
<td>15.33mV</td>
<td>9.87V</td>
</tr>
<tr>
<td>1.0M&Omega;</td>
<td>14.86mV</td>
<td>9.87V</td>
</tr>
<tr>
<td>3.9M&Omega;</td>
<td>14.55mV</td>
<td>9.87V</td>
</tr>
</tbody>
</table>
<p>&hellip; and the results with 50% pulse are unaffected by inserting R6.</p>
<p>I shall go for the 390k&Omega; resistor as you suggested.&nbsp; 15.33mV on a scale of 0-10 is 1.533 x 10<sup>-3</sup> so if the PowerReducer took this literally it would be driving the 3kW immersion heater at 4.6W, which is obviously not a problem.&nbsp;</p>
<p>I shall also go with your advice and put the filter and the op amp all together, next to the PowerReducer.</p>
<p>I&#39;ve also found in the PowerReducer manual it actually says that you can connect its +10V output to its 0-10V input and it acts as an &quot;over-ride switch&quot;, by which they must mean 100% AC output; here&#39;s a snippet taken out of the manual:</p>
<p>&nbsp;</p>
<p><img alt="" src="../sites/default/files/Power-reducer-override.png" style="width: 550px; height: 305px;" /></p>
<p>So that gives me even more confidence that the +10V can be used as a power supply.</p>
<p>Your response has given me the confidence to go ahead.&nbsp; I shall now order the parts and report back - it may be a while!&nbsp; Once I&#39;ve built the electronics I plan to run some simple test sketches in the EmonTx and just output a variety of constant pulse widths and measure the results. I&#39;ll do this before I connect it to anything real!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39545"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 19/02/2016 - 13:16.</div>
    <div class="content">
     <p><em>&quot;At first I thought that when you said &quot;Try (in your simulation) connecting a resistor from the 10 V supply to the - input of the op-amp&quot; you meant connect the new resistor to the inverting input of the op amp, but that didn&#39;t work. Then I figured out that you meant connect it to the negative of its power supply (pin 4 in the diagram): that worked like magic! &quot;</em></p>
<p>Er, NO! You had it right first time. I really did mean connecting to the inverting input. The object was to form a voltage divider with R3 so that the inverting ( - ) input would sit at 130 mV d.c., the same voltage as the non-inverting ( + ) input, so giving you zero output. &nbsp;[OK, it&#39;s a bit of a fudge because it will affect the op-amp gain, but only very, very&nbsp;slightly. So don&#39;t do this without understanding exactly what&#39;s going on. i.e. simulate it carefully!] &nbsp;I don&#39;t know why it didn&#39;t work for you, it does for me using a standard op-amp model in LTSpice. But I don&#39;t have the TI version of Spice and the particular model for the TLV2402&nbsp;so I haven&#39;t tried it.</p>
<p>What you have now&nbsp;<em>shouldn&#39;t</em>&nbsp;work. Just for information, the supply connections are usually called V<sub>CC</sub> and V<sub>DD</sub> for a dual rail op-amp, or V<sub>CC</sub> and GND in your case with a single-rail op-amp.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39551"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Fri, 19/02/2016 - 19:02.</div>
    <div class="content">
     <p>Hi dB</p>
<p>It&#39;s interesting about the feed-in tariffs for off-grid: very few people understand this.&nbsp; At <a href="http://www.energysavingtrust.org.uk/domestic/grid" target="_blank">www.energysavingtrust.org.uk/domestic/grid</a> you can read</p>
<blockquote><p>All renewable electricity generated by an eligible installation can receive payments under the Feed-in Tariff scheme.&nbsp;This is true for off-grid systems as well as on-grid ones &ndash; you will get the same generation tariff, though obviously you can&rsquo;t get export payments.</p>
</blockquote>
<p>... but I&#39;ve lost count of the number of newspaper articles that say that FITs are a payment for feeding surplus solar power back into the grid.&nbsp; In fact (as most visitors to this site know but the general public doesn&#39;t), even for people <u>on</u> the grid it is actually the case that the <u>less</u> you feed into the grid the more money you make (all other thing being equal) - because they don&#39;t actually <u>measure</u> your export, so the less you <u>really</u> export, the better.&nbsp; Unless you are one of those people with a consumption meter that can run backwards (they do exist, I&#39;m told), in which case, keep quiet about it and enjoy. I&#39;m talking about domestic installations here in the UK, not commercial ones, where you will have an actual export meter.</p>
<p>Regarding my voltage divider, I hadn&#39;t considered the point you made.&nbsp; I just chose nice big values so as to avoid draining my battery bank unnecessarily.&nbsp; Referring to my pencil sketch at <a href="../sites/default/files/VoltageDivider.png" title="http://openenergymonitor.org/emon/sites/default/files/VoltageDivider.png">http://openenergymonitor.org/emon/sites/default/files/VoltageDivider.png</a> I could change R1 to 150k&Omega; and R2 to 10k&Omega;.&nbsp; That would step 72V down to 4.5V, and considered in parallel it comes to 9.375k&Omega; which is just under the recommended maximum.&nbsp; The constant battery drain at 60V (which is the maximum value in practice) would then be 22.5mW which is perfectly acceptable. &nbsp;</p>
<p>Looking at <a href="11011.html" title="http://openenergymonitor.org/emon/node/11011">http://openenergymonitor.org/emon/node/11011</a>, I wonder how far they got?&nbsp; I notice that it hasn&#39;t been updated since August 2015.&nbsp; I have been happily monitoring my 48V battery bank since November 2014 - not just the total but each individual battery - using EmonPi - originally set up with help from here and Mr Robert Wall in particular - there is quite a full write-up at <a href="http://offgriduk.net/2014/12/06/monitoring-the-battery-bank-part-1/" target="_blank">offgriduk.net/2014/12/06/monitoring-the-battery-bank-part-1/&nbsp;&nbsp; </a>The graphs are very pretty.&nbsp;</p>
<p>That reminds me, when considering the present project (proportional power to the immersion heaters through the PowerReducer) I did spend a lot of time thinking about whether to build it on the Raspberry Pi (where, as just mentioned, I am already reading the battery data) or whether to build it on the EmonTx.&nbsp; In the end I think my logic was this: what I am building here is a machine that will sit there day after day doing just one job.&nbsp; It&#39;s an embedded thing: that&#39;s what Arduino&#39;s are for; whereas the Raspberry Pi is a general purpose computer.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39553"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Sat, 20/02/2016 - 09:42.</div>
    <div class="content">
     <p>Robert....I thought I had replied to your latest but it hasn&#39;t appeared, so I probably forgot to press &quot;Save&quot;.&nbsp; Apologies in advance if the following turns out to be a duplicate.</p>
<p>Anyway, following that clarification, I tried the following circuit in TINA-TI</p>
<p><img alt="Op amp circuit version 3" src="../sites/default/files/0To10V-V3_0.png" style="width: 700px; height: 211px;" /></p>
<p>but no matter what values I used for R6, I couldn&#39;t get rid of that annoying output voltage when the input was zero.</p>
<p>Here are the results with various values</p>
<table border="1" cellpadding="1" cellspacing="1">
<thead>
<tr>
<th scope="col">R6</th>
<th scope="col">Output voltage from zero input</th>
</tr>
</thead>
<tbody>
<tr>
<td>39k&Omega;</td>
<td>131.08mV</td>
</tr>
<tr>
<td>100k&Omega;</td>
<td>131.18mV</td>
</tr>
<tr>
<td>390k&Omega;</td>
<td>131.29mV</td>
</tr>
<tr>
<td>1M&Omega;</td>
<td>132.35mV</td>
</tr>
<tr>
<td>10M&Omega;</td>
<td>136.64mV</td>
</tr>
</tbody>
</table>
<p>I also tried varying R3/R4 but that had no effect either.</p>
<p>After staring at this for a while, I decided to try a different op-amp from my shortlist of 4: the TLV2371.&nbsp; Immediately the above problem disappeared!</p>
<p><img alt="Op amp circuit version 4" src="../sites/default/files/0To10V-V4_0.png" style="width: 700px; height: 214px;" />Here are the results with the above circuit</p>
<table border="1" cellpadding="1" cellspacing="1">
<thead>
<tr>
<th scope="col">Input</th>
<th scope="col">Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>0V constant</td>
<td>1.92mV</td>
</tr>
<tr>
<td>50% 5V pulse</td>
<td>4.46V within 0.5s</td>
</tr>
<tr>
<td>5V constant</td>
<td>9.92V</td>
</tr>
</tbody>
</table>
<p>... so (unless I get further comments) that is the circuit that I shall go with, and no need for R6.</p>
<p>As to why my earlier circuit based on a misunderstanding did &quot;appear&quot; to work, I did read somewhere that modelling an op-amp is quite hard to do exactly so they typically take some short-cuts which will produce totally realistic results if you use the op-amp in the way that it was intended to be used, but which may produce untrue results if you do something silly.&nbsp; Perhaps that&#39;s what happened.&nbsp; As to why the TLV2402 had the problem hitting zero output whereas the TLV2371 did not - I&#39;ll have to file that one under &quot;unexplained&quot; for the time being.&nbsp; The pragmatic thing is to proceed withe the TLV2371.&nbsp; In any case I&#39;ll be testing it in isolation before I connect it to anything else.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39555"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 19/02/2016 - 22:51.</div>
    <div class="content">
     <p>Yes, it&#39;s a less well-known fact that simulations&nbsp;don&#39;t always give the absolute truth, you only know that when you have the real device in operation. Nevertheless, they are a useful and important tool.</p>
<p>It is quite common to have an offset in an op. amp., if the manufacturer thinks it might be a problem, and they can afford the pins, they&#39;ll give you a pair of pins to use in an &#39;offset null&#39; circuit.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39556"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 19/02/2016 - 23:00.</div>
    <div class="content">
     <p><em>&nbsp;there is quite a full write-up at offgriduk.net/2014/12/06/monitoring-the-battery-bank-part-1/ &nbsp;</em></p>
<p>You&#39;re potentially exposed to the same input source impedance issue there too. &nbsp;If I&#39;m reading it all correctly your source impedance there is about 6.6k and is is predominantly determined by those Rs to GND on your RPi shield. &nbsp;Hopefully your shield designer did the research and determined that was low enough, although the excerpt from the Microchip datasheet below is a little troubling.</p>
<p>If you want to test it you can do a similar test to the one I did in the thread referenced above. &nbsp;The exact symptoms you get will depend on the internal design of the ADC. &nbsp;Some of them leave the sample-n-hold cap pretty much undisturbed during the conversion, others appear to discharge them at the end. &nbsp;So you might need to experiment to determine the worst case sampling-sequence scenario for yours. &nbsp; So start by driving it with a ridiculously high input impedance to make sure you can see the problem (although that would involve changing the Rs on your RPi shield).</p>
<p>For the Atmel ADCs, the worst case scenario&nbsp;appears to be to sample one pin at Vcc and then immediately sample another pin at GND. &nbsp;If it doesn&#39;t read 0 then you&#39;re probably not driving it hard enough (and if you keep sampling that second pin, you should see it decay down to 0). &nbsp;If your ADC discharges the cap at the end of the conversion then the sequence described here won&#39;t prove anything, but reversing the sampling order (GND first then Vcc) should.</p>
<p>Your ADC datasheet gives the size of the cap (3.2pF) and specifies the input impedance (as a function of gain) but I couldn&#39;t work out exactly how long the sampling switch is closed for (possibly one clock?). &nbsp;ADC specify all of that (the sampling switch is closed for 1.5 ADC clocks on the Atmel) and conclude with a nice guideline along the lines&nbsp;of &quot;keep your source impedance below 10K and you&#39;ll be fine&quot;. &nbsp;The closest I could find to that guideline in your datasheet is far more pessimistic:</p>
<p><em>The conversion accuracy can be affected by the input signal source impedance when any external circuit is connected to the input pins. The source impedance adds to the internal impedance and directly affects the time required to charge the internal sampling capacitor. Therefore, a large input source impedance connected to the input pins can degrade the system performance, such as offset, gain, and Integral Non-Linearity (INL) errors. Ideally, the input source impedance should be zero. This can be achievable by using an operational amplifier with a closed-loop output impedance of tens of ohms</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39559"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 22/02/2016 - 18:47.</div>
    <div class="content">
     <p>Thanks db, that&#39;s interesting.&nbsp; However I think it&#39;s in danger of taking me away from my present project!&nbsp; For my purposes, the point of the 2014 RPi-ADC-based project is to be able to produce graphs like this:</p>
<p><img alt="" src="../sites/default/files/BatteryCollapse_0.png" style="width: 700px; height: 162px;" /></p>
<p>telling me that battery B2 has a tendency to always &quot;collapse&quot; first, and for this purpose it already does the job perfectly.&nbsp; However, I always like adding to my education, and I can see that this voltage-monitoring malarkey is not quite as simple as I naively imagined.</p>
<p>I&#39;ll probably go quiet for a bit now and come back when I&#39;ve put the new circuit together and done some tests.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39560"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sat, 20/02/2016 - 10:16.</div>
    <div class="content">
     <p><em>no matter what values I used for R6, I couldn&#39;t get rid of that annoying output voltage when the input was zero.</em></p>
<p>Providing that the control system is linear, I doubt whether this small amount of residual offset will have any noticeable effect.&nbsp; The control mechanism will soon find the equilibrium point where everything balances.&nbsp; Any suitable looking op-amp should be OK for this application.</p>
<p>An interesting project and nicely presented.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39563"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Sat, 20/02/2016 - 13:01.</div>
    <div class="content">
     <blockquote><p>&quot;I&#39;ll probably go quiet for a bit now&quot;</p>
</blockquote>
<p>- famous last words.</p>
<p>I have another part to this project!&nbsp; Here&#39;s the problem.&nbsp; My peak solar output is slightly in excess of 4kW.&nbsp; The maximum that the PowerReducer can handle is 3kW.&nbsp; So I could be left with up to 1kW of &quot;excess power&quot; even after the present project is working.&nbsp; On sunny days (can&#39;t wait for them) this WILL happen</p>
<p>My proposed solution is this:</p>
<p>In fact (not previously mentioned) I have two immersion heaters (in one tank).&nbsp; They are 1.9kW and 2.8kW (at 230V).&nbsp; My idea is that the 2.8kW one will be controlled by the PowerReducer as previously described, so that its output can be set to any level from 0 to 2.8kW.&nbsp; The 1.9kW one will be controlled by a relay, so that it is either on or off.&nbsp;</p>
<p>When the level of power being got rid off rises above 2.2kW (79% on the proportional control scale), the system will switch in the 1.9kW heater by relay, and adjust the &quot;proportional control&quot; on the 2.8kW heater to soak up the rest.&nbsp; If the level of power being got rid of then falls below 2.0kW, the system will switch off the 1.9kW heater and leave the 2.8kW heater to do the whole job through the proportional control.&nbsp; The gap between the 2.2kW switch-on point and the 2.0kW switch-off point is designed to stop the relay &quot;flapping&quot;.&nbsp;</p>
<p>So I need a relay that can be driven by the EmonTx and can switch 1.9kW AC.</p>
<p>I have found this device: Crydom DR2260D30U.&nbsp; It is a DIN-rail mountable solid state relay that can handle 30A on the AC side.&nbsp; It is not cheap but I&#39;m only ever going to buy just the one.&nbsp; The data sheet at <a href="http://www.mouser.com/ds/2/93/Crydom_DR22_AC_series_DSL-793185.pdf" title="http://www.mouser.com/ds/2/93/Crydom_DR22_AC_series_DSL-793185.pdf">http://www.mouser.com/ds/2/93/Crydom_DR22_AC_series_DSL-793185.pdf</a> suggests that it can be switched on by 5V DC and will draw 10-15mA control current.&nbsp; From my reading, that&#39;s well within the limit of an Arduino digital output.&nbsp; Can I wire it straight to an output from the EmonTx or do I need something in between?&nbsp;</p>
<p>I plan to put the whole thing in a mains-safe, childproof etc enclosure so DIN rail mounting should be fine.&nbsp; I would then also add a trip-switch and an isolator.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39564"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 20/02/2016 - 14:33.</div>
    <div class="content">
     <p>The principle is sound, but unfortunately&nbsp;I don&#39;t think that will work with an emonTx, though it will with an Arduino. The data sheet says &quot;Minimum Turn-On Voltage&quot; is 4 V d.c., and you might get only 2.6&nbsp;V from an emonTx with its 3.3 V supply voltage, when you pull some current (the data sheet says 2.3 V out at 10 mA with a 3 V supply [page 313, V<sub>OH</sub>]). It <em>might</em> work, but it&#39;s not guaranteed. I&#39;d suggest you need a single transistor driver, run from whatever higher d.c. voltage is handy.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39566"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sat, 20/02/2016 - 15:42.</div>
    <div class="content">
     <p>When not using a triac, which works fine at 3.3V, I use this <a href="http://uk.farnell.com/crydom/d2425/ssr-25a-24-280vac-3-32vdc-zero/dp/1200241">Crydom 2425</a> relay.&nbsp; Although nominally controllable down to 3V, it works more relably when driven from a 5V system as I&#39;ve done here:</p>
<p><a href="../../../mk2pvrouter.co.uk/media/3284daa3b50b62f3ffff8018d4355564.jpg">http://mk2pvrouter.co.uk/media/3284daa3b50b62f3ffff8018d4355564.JPG</a></p>
<p>(the step-down stage for the 3.3V RFM12B is at the upper-right of the PCB)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39651"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 22/02/2016 - 17:39.</div>
    <div class="content">
     <blockquote><p>Providing that the control system is linear, I doubt whether this small amount of residual offset will have any noticeable effect.&nbsp; The control mechanism will soon find the equilibrium point</p>
</blockquote>
<p>I agree that if there is an equilibrium point, then the residual offset is irrelevant.&nbsp; The problem comes when we can&#39;t reach the equilibrium point because there isn&#39;t one (i.e. when there is no excess power, in fact there is a shortage).&nbsp; Then we want the immersion heater to be taking zero power. So I send a constant 0V from the PWM but (apparently, according to the simulation, if I&#39;d carried on using the TLV2402) get 130mV out of my circuit. A voltage of 130mV would correspond to about 40W of output power (on a scale of 0-10V, controlling a 3kW immersion).&nbsp; I don&#39;t want 40W going into the immersion heater constantly (our background consumption, e.g. overnight, when only the &quot;always-on&quot; appliances are on is around 180W so 40W would be a big increase).&nbsp;</p>
<p>[One becomes very aware of energy consumption in our situation.&nbsp; I&#39;ve just replaced all our 11W CFL bulbs with 3W LEDs.]</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39652"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 22/02/2016 - 17:44.</div>
    <div class="content">
     <p>Following the very helpful feedback, I&#39;m going to be using a ULN2003A Darlington array to drive the relay.&nbsp; The relay will be a Crydom CKRD2420, which I think is roughly the DIN-rail equivalent of the 2425.&nbsp;</p>
<p>The parts are on their way.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39655"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 22/02/2016 - 19:15.</div>
    <div class="content">
     <p>As I wrote earlier, if you have an offset problem with&nbsp;the op.amp, and in the absence of an offset&nbsp;null input, then you should be able to solve the problem by injecting a small voltage into one or the other input of the op-amp.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39659"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Mon, 22/02/2016 - 20:47.</div>
    <div class="content">
     <p><em>I don&#39;t want 40W going into the immersion heater constantly (our background consumption, e.g. overnight, when only the &quot;always-on&quot; appliances are on is around 180W so 40W would be a big increase).&nbsp;</em></p>
<p>When surplus power ceases, there needs to be some way of ensuring that the dump-load is fully off.&nbsp; Maybe you could use a spare IO port to suppress any residual control signal.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39701"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Tue, 23/02/2016 - 12:53.</div>
    <div class="content">
     <p>By changing from the op amp from TLV2402 to TLV2371 (as per <a href="#comment-39553">#comment-39553</a> above), I consider that I have solved the &quot;residual voltage problem&quot; (at least that&#39;s what the simulations are telling me).&nbsp;</p>
<table border="1" cellpadding="1" cellspacing="1">
<tbody>
<tr>
<td>&nbsp;</td>
<td>Output voltage when input is zero</td>
<td>Effect on 3kW heater</td>
</tr>
<tr>
<td>original circuit with TLV2402</td>
<td>137mV</td>
<td style="text-align:right;">41.1W</td>
</tr>
<tr>
<td>revised circuit with TLV2371</td>
<td>1.92mV</td>
<td style="text-align:right;">0.6W</td>
</tr>
</tbody>
</table>
<p>so it doesn&#39;t seem to me that I need any offset voltages or other ways of turning it off even more completely.&nbsp; 0.6W is as good as zero, and it may well be that 1.92mV is below the PowerReducer&#39;s threshold anyway.&nbsp;</p>
<p>At least that&#39;s the theory.&nbsp; I have to beware of trying to sound too much like an expert as I hadn&#39;t even heard of an op amp until a month or two ago.&nbsp;</p>
<p>Anyway, once the parts arrive I shall put it together and try and compare theory against the reality.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39804"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Thu, 25/02/2016 - 15:39.</div>
    <div class="content">
     <p>I have now got all the parts, and have started to put it together, breadboard-fashion inititally.</p>
<p>In the course of this, I have discovered a couple of little errors or out-of-dateness in the documentation.</p>
<p>At <a href="https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4#emonTx_V3.4_2" title="https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4#emonTx_V3.4_2">https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4#emonTx_V3.4_2</a><br />
there is a diagram of the board.&nbsp; At the bottom left is the terminal block with 6 connections.&nbsp; Connection no. 4 is labelled &quot;IRQ1 Dig2&quot;.&nbsp; But on my emonTxV3.4 delivered yesterday, this one is labelled on the PCB &quot;Dig 3 IRQ1&quot; and I believe that this is correct (Dig3 rather than Dig2).</p>
<p>A slightly bigger problem (for me) is the information about the RJ-45 connector.&nbsp; On page <a href="https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4" title="https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4">https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4</a> again, there is the statement &quot;The emonTx V3.4 uses a standard RJ45 DS18B20 pin-out as used by Sheepwalk Electronics and others&quot; followed by a pin-out diagram showing that pins 1, 3 and 5 are all GND.&nbsp; In reality (ie on my brand-new emonTxV3.4) only pin 5 is GND.&nbsp; I found this out the hard way, ie when I could not figure out why my little test program would not work (I had been using pin 1 as the GND). Then eventually, a bit further down the page I found more info on the connections, where, against connections 1 and 3 it states &quot;N/C in future&quot; in small print - I guess the future has arrived.&nbsp; NB If someone else can confirm that I have correctly identified these discrepancies, then I&#39;ll happily update the wiki page.</p>
<p>This just shows the benefit of &quot;test-driven development&quot;, ie get a little bit of it working, then build a bit more and test that and so on.&nbsp; So far I have a sketch that basically alternates between analogWrite(3,200) for 20 seconds and then analogWrite(3,255) for 20 seconds. I am now able to extract this signal via the emonTx4.3&#39;s RJ-45 connector (pins 5 and 6), feed it through my 2-step low-pass filter, and see the resultant voltage switch between a steady 2.547V and a steady 3.248V.&nbsp; The next stage will be to add the op amp.</p>
<p>The only surprise to me is that I was expecting 5V rather than 3.248V.&nbsp; But that&#39;s obviously a misunderstanding on my part - I think I have been reading Arduino documentation as if it could be applied unchanged to the emonTx.&nbsp; That&#39;s fine, anyway, it just means that my op amp stage will have to be configured to deliver x3 voltage multiplication rather than x2.&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39823"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 25/02/2016 - 21:18.</div>
    <div class="content">
     <p><em>&quot;The only surprise to me is that I was expecting 5V rather than 3.248V&quot;</em><br />
Sorry, I should have spotted that. The emonTx works on 3.3 V, so you&#39;ll never get 5 V out of it.</p>
<p>My V3.4 PCB is dated Oct 2014 and is an early one, the silk screen is &quot;IRQ1&nbsp;Dig 2&quot; on the top and &quot;Dig3&nbsp;IRQ1&quot; on the bottom&nbsp;against Pin 4. &nbsp;The circuit diagram and pcb layout both show D3 / IRQ0 and&nbsp;it definitely responds as Dig 3.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39867"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Fri, 26/02/2016 - 16:46.</div>
    <div class="content">
     <p>&quot;<em>The emonTx works on 3.3 V&quot;.&nbsp; </em>When I come to doing the input voltage measurement, I am planning to feed it into analog port A5 (pin 5 of the terminal block).&nbsp; Therefore this must be maximum 3.3V too, I&#39;m thinking - is that right?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39876"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Fri, 26/02/2016 - 17:55.</div>
    <div class="content">
     <p>This is my second electronics project, and when I look back on the first one, the thing that I am least satisfied about is the final packaging.&nbsp; How do you get a Raspberry Pi, with a mini-tower of add-on boards, plus a USB HDD, plus a USB hub, plus a home-made stripboard circuit with three RJ-45 sockets, all into a really neat box that doesn&#39;t rattle when you shake it?&nbsp; I think I spent a surprising amount of the cost on packaging and still wasn&#39;t really happy with the result.</p>
<p>Looking around on the internet, I see a lot of projects where someone has done something clever with the electronics and then stuffed it all rather messily into a plastic sandwich box.</p>
<p>I think I can do better this time.&nbsp; I think the emonTx packaging is really neat and I see that one can buy similar cases off-the-shelf.&nbsp; But then I figured out that I can squeeze my voltage divider into the existing emonTx case, ie have a second floor within the same case.&nbsp; (I am talking about the voltage divider which will scale the [up to] 60V from my battery bank down to 3.3V(?) for the emonTx ADC input).</p>
<p>Firstly, I removed the battery holder from the emonTx (sorry, but I don&#39;t plan to ever use it).&nbsp; It is held in place solely by its two electrical connections, and it wasn&#39;t too hard to unsolder these and judiciously lever it off.&nbsp; Then I treated my junior hacksaw to a new blade and sculpted a bit of stripboard of the correct width (100mm) so as to fit round the RJ-45 socket.&nbsp; This then fits into the top groove of the emonTx case.&nbsp; All should be clear from the following pictures.</p>
<p><img alt="" src="../sites/default/files/emonTxLoftExtension.jpg" style="width: 700px; height: 610px;" /></p>
<p><img alt="" src="../sites/default/files/emonTxLoftExtensionInPlace.jpg" style="width: 700px; height: 393px;" /></p>
<p>As far as I can see there is enough headroom in both directions.&nbsp; I have smoothed the cut edges with a file and will have to check and test that I haven&#39;t bridged any strips by my hacksawing.</p>
<p>What&#39;s more there are even some helpful holes in the PCB for the six terminal block connections.&nbsp; So I will be able to join my voltage divider to the main PCB entirely within the case.&nbsp; The only thing I haven&#39;t got room for is a socket to bring in the 60 or so volts from the battery bank.&nbsp; So I plan to have a dangling plug for this, which will be soldered to my stripboard.&nbsp; But actually, now that I think about it, a dangling plug is better than a socket.&nbsp; (There&#39;s a reason why our walls have sockets and our appliances have plugs, rather than the other way round!)</p>
<p>I think I&#39;ll build this bit next, so that I can test my ability to read the analog voltage.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39903"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 27/02/2016 - 19:29.</div>
    <div class="content">
     <p><em>&quot;Therefore this [input voltage] must be maximum 3.3V too, I&#39;m thinking - is that right?</em>&quot;</p>
<p>Indeed. Generally, if you can&#39;t derive the input from the 3.3 V supply, then you need to clamp it <em>and</em> current-limit it so that the inbuilt protection is not overloaded. In your case, provided the battery never gets disconnected and so the voltage coming down never exceeds the voltage that you design for, all should be OK. The pertinent question is, what if the PV output isn&#39;t held down by the battery?</p>
<p>&quot;<em>The only thing I haven&#39;t got room for is a socket to bring in the 60 or so volts from the battery bank.</em>&quot;</p>
<p>And remember that batteries can lash out with <strong>a lot</strong> of current, so you need at least a low-value fuse at the battery to protect the cable and your connections. You could split the voltage divider - have the &#39;top&#39; half local to the battery and the &#39;bottom&#39; (earthy) half in your box, that would inherently limit any fault current to a few mA.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39969"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 29/02/2016 - 17:20.</div>
    <div class="content">
     <p>Thanks for your response.</p>
<p>In my original post in this thread where I described the current system, I did not include all the safety features etc: It seemed to be quite a long post so I did leave out a certain amount of detail of things that don&#39;t affect the overall concept.</p>
<p>My existing voltage sampling works on a separate circuit from the main power handling.&nbsp; The photo below shows the connections at one of the battery terminals.</p>
<p>&nbsp;</p>
<p><img alt="Battery terminal connections" src="../sites/default/files/BatteryTerminalCloseup_0.jpg" style="width: 700px; height: 394px;" /></p>
<p>The thick black cable takes the power into the inverter/charger (up to 120A).&nbsp; The small red wire is for the voltage sampling.&nbsp; The black cartridge in the red wire is an in-line fuse holder containing a 500mA &quot;quick blow&quot; glass fuse.&nbsp; There are 17 of these fuses altogether; one on the positive of each battery and another one in the return cable at the negative end of the strings.&nbsp; I did actually blow these fuses once, while I was developing my Raspberry Pi-based battery monitoring system, by absent-mindedly short-circuiting across several batteries.&nbsp; The glass fuses all blew and everything else carried on as normal, thus demonstrating both that they were necessary, and also that they worked!&nbsp; All the current for the new sampling system will flow through one of these fuses - from the positive end of the string - (and back through the earth one).</p>
<p>Another thing not previously mentioned is that there is already another device in the system to protect against over-voltage of the batteries.&nbsp; In my original post I described how the inverter/charger can turn the solar power off by altering the mains frequency.&nbsp; The following screenshot shows the actual parameter settings in the inverter/charger:</p>
<p><img alt="Frequency shift parameters" src="../sites/default/files/FrequencySwitch_0.jpg" style="width: 645px; height: 485px;" /></p>
<p>&hellip; meaning that the frequency will change to 54.00Hz if the battery voltage goes higher than 59V for 30 seconds.&nbsp; As soon as the solar inverter detects the 54Hz it will isolate itself from the system.&nbsp; There will then be no &quot;surplus power&quot; flowing into the batteries and the battery string voltage will drop back.</p>
<p>However, there is a serious flaw in this idea.&nbsp; It will not work when the generator is running.&nbsp; When the generator is <u>not</u> running, the inverter/charger is in full charge of the voltage, frequency, and phase of the micro-grid.&nbsp; However, when the generator <u>is</u> running, it is the generator that is in control.&nbsp; In particular, the frequency is equal to the rotational speed of the diesel engine (which runs at a fixed speed): 3000rpm = 50Hz - in the US they have to run them at 3600rpm.&nbsp; (And when the generator comes on, incidentally, you get random phase-jump, but this is harmless).&nbsp; So you can get a scenario where the generator is running and the sun comes out.&nbsp; Excess power washes into the inverter/generator&#39;s output, which now can do nothing about it, because it can&#39;t change the frequency. Dangerous battery over-voltage may result.</p>
<p>I pointed out this flaw to the original installers, who came round fairly pronto and installed an additional voltage-driven relay, which just electro-mechanically isolates the solar input if the battery voltage exceeds a bit over 59V.&nbsp;</p>
<p>In fact, when I said in the original post, that this graph</p>
<p><img alt="Solar power and battery voltage graph" src="../sites/default/files/SolarWhenBatteriesFull.png" style="width: 700px; height: 358px;" /></p>
<p>&hellip; shows the frequency shift mechanism in operation, I think on reflection that what we are seeing there is actually the voltage-relay cutting in, because that happens immediately, whereas the frequency shift is currently set to wait for 30 seconds.</p>
<p>So the bottom line is that the battery voltage cannot go above 60V or so.&nbsp; In my voltage divider, I intend to have a bit of a safety margin and scale 72V to 3.3V.&nbsp; Safety mechanisms can go wrong, I suppose, but the way I look at it is that if the battery string voltage goes above 72V then we have got bigger problems than just burning out an emonTx.&nbsp;</p>
<p>I have now started thinking about &quot;input impedance&quot; for the voltage sampling.&nbsp; After a bit of reading and a bit of algebra, I think I understand the concept.&nbsp; In the following voltage divider circuit:</p>
<p><img alt="Voltage divider circuit" src="../sites/default/files/VoltageDivider2.png" style="width: 285px; height: 224px;" /></p>
<p>(which are the actual values I intend to use) I think I am right in saying that the &quot;input impedance&quot; of this circuit is exactly equal to R1 (plus any internal impedance of the batteries) and does not depend on R2 at all.&nbsp; The voltage at VF1 will obviously depend on the ratio of R1 to R2 but the input impedance itself is independent of R2.&nbsp; Having worked this out laboriously by algebra I think I can now see it more intuitively: that if you want to draw a current from VF1 to ground, that current has got to be pulled through R1 (and the batteries) but not through R2.&nbsp; The fact that you are simultaneously leaking some of the battery power to ground through R2 is neither here nor there.</p>
<p>If the above is correct, then I have begun to understand the concept of input impedance.&nbsp; If not, then not, and I look forward to being corrected!</p>
<p>Having got that out of the way, there seems to be a variety of opinion on what is the maximum reasonable input impedance.&nbsp; I have seen a suggested figure of 10kΩ, but if I put R1=10kΩ, R2=0.47kΩ then I am using about 344mW (at 60V) which seems to me to be a bit on the high side (it is about the maximum power of any of the resistors in my possession).&nbsp;</p>
<p>I have also seen it suggested that you can go much higher than 10kΩ if you are prepared to allow more &quot;settling time&quot; and that this can be simply done by doing the same analogRead twice in succession and just using the second value.&nbsp; See <a href="http://forum.arduino.cc/index.php?topic=99170.0" title="http://forum.arduino.cc/index.php?topic=99170.0">http://forum.arduino.cc/index.php?topic=99170.0</a> for example.&nbsp; In fact that is what I think I will try.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39975"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 29/02/2016 - 20:45.</div>
    <div class="content">
     <p>I wouldn&#39;t have any concerns wih those resistor values, they look sensible to me.</p>
<p>But I&#39;m afraid your concept of impedance (or more strictly resistance in this case because there are no reactive components) isn&#39;t quite right. The input impedance is actually R1 PLUS (R2 in parallel with whatever is off to the right). So it will be between 100 k&Omega; and 104.7 k&Omega; (100 with a dead short off the page, 104.7 with nothing connected). So what in fact you had was the resistance that would limit the fault current given a short circuit off the page to the right.</p>
<p>Looking back from the right-hand side, your circuit has a source impedance of 4.7 k&Omega; in parallel with (100 k&Omega; plus the battery internal resistance), so in practical terms 4.7 k&Omega;. And that&#39;s fine for feeding into the ADC. So it&#39;s equivalent to a 2.154 V battery in series with a 4.489 k&Omega; resistor. (It&#39;s Th&eacute;venin&#39;s Theorem, but I guess you&#39;ve read that by now).</p>
<p>I hope you don&#39;t mind me mentioning these safety considerations, but somebody following this who doesn&#39;t understand the implications could get into serious trouble if they didn&#39;t understand the dangers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40107"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Fri, 04/03/2016 - 14:26.</div>
    <div class="content">
     <p>Where have I been for the last 4 days?&nbsp; Learning about Th&eacute;venin&#39;s Theorem (and the Norton equivalent), and I now think that I really <u>do</u> understand the concept of source impedance.</p>
<p>That&#39;s the trouble with being self-taught; one&#39;s knowledge is so erratic.&nbsp; I wish they had done this sort of thing when I was at school.&nbsp; Never too late to learn, though!</p>
<p>I don&#39;t in the least mind you mentioning the safety precautions.&nbsp; In fact I will re-edit the earlier posts to flag them up.&nbsp; Another really good safety precaution (again not previously mentioned) is battery terminal covers, as shown in this photo.</p>
<p>I shall be back on the project soon.</p>
<p><img alt="Battery terminal covers" src="../sites/default/files/BatteryTerminalCover.jpg" style="width: 700px; height: 394px;" /></p>
<p>They were surprisingly hard to source - ie finding ones with the right size and cable entry (and the supplier I got them from doesn&#39;t seem to stock them any more).</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40109"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Fri, 04/03/2016 - 15:45.</div>
    <div class="content">
     <p>PS in learning about Th&eacute;venin&#39;s theorem, I found this resource: <a href="http://www.facstaff.bucknell.edu/mastascu/elessonshtml/source/source2.html" title="http://www.facstaff.bucknell.edu/mastascu/elessonshtml/source/source2.html">http://www.facstaff.bucknell.edu/mastascu/elessonshtml/source/source2.html</a> There may be better out there, but this one seemed to be just at my level, and I liked the tests.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40113"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 04/03/2016 - 20:36.</div>
    <div class="content">
     <p>Hmm. I don&#39;t think much of a teaching website that can&#39;t use&nbsp;the correct symbol for the units&nbsp;of resistance. It&#39;s not hard, all they need is the HTML entity &amp;Omega; and&nbsp;Hey Presto, &Omega; appears.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40479"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 21/03/2016 - 10:04.</div>
    <div class="content">
     <p>I have made some progress with this project but now I am stuck and would appreciate any suggestions.</p>
<p>The immediate problem is that I am trying to get an on/off signal at terminal 8 of the RJ-45 connector of the emonTxV3.4 and I can&#39;t get it to work.&nbsp; All the documentation suggests that I should be able to get a signal here by writing to Dig20 as an output.</p>
<p>I have got a basic test circuit consisting of a red LED in series with an 330 Ω resistor.&nbsp; I am using terminal 5 of the RJ-45 as the ground.&nbsp; Here are the results of my tests</p>
<table border="1" cellpadding="1" cellspacing="1">
<tbody>
<tr>
<td width="160">analogWrite to channel 5</td>
<td>Signal appears on RJ-45 pin&nbsp;4, test circuit LED lights up (with brilliance depending on pulse)</td>
</tr>
<tr>
<td>analogWrite to channel 3</td>
<td>Signal appears on RJ-45 pin&nbsp;6, test circuit LED lights up (with brilliance depending on pulse)</td>
</tr>
<tr>
<td>digitalWrite to channel 20</td>
<td>Signal expected on RJ-45 pin 8, but test circuit LED does not light up</td>
</tr>
</tbody>
</table>
<p>I have checked and re-checked everything and tested for continuity and I don&#39;t know what else to try.&nbsp; Specifically I have measured the resistance between pin 8 of the RJ-45 socket on the emonTx and the positive leg of the LED and I see 331Ω which is the value of the resistor in the test circuit.&nbsp;&nbsp;</p>
<p>Going back a bit, the overall objective is to be able to (1) read a battery voltage (2) control one immersion heater via an analog signal and (3) control a second immersion heater via an on/off signal.&nbsp; I therefore need one channel with digitalRead ability, one channel with analogWrite ability, and one channel with digitalWrite capability.</p>
<p>I have analyzed what &quot;spare&quot; channels are connected to the outside world on the emonTxV3.4, and I have come to the conclusion that there are only really 3 such spare channels.&nbsp; The following table shows 4 channels:</p>
<table border="1" cellpadding="1" cellspacing="1">
<tbody>
<tr>
<td>channel</td>
<td>analogRead</td>
<td>analogWrite</td>
<td>Terminal block</td>
<td>RJ-45 socket</td>
</tr>
<tr>
<td>D3</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y (4)</td>
<td>Y (6)</td>
</tr>
<tr>
<td>D5</td>
<td>&nbsp;</td>
<td>Y</td>
<td>Y (6)</td>
<td>Y (4)</td>
</tr>
<tr>
<td>D19/ ADC5</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y (5)</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>D20 / ADC6</td>
<td>Y</td>
<td>Y</td>
<td>&nbsp;</td>
<td>Y(8)</td>
</tr>
</tbody>
</table>
<p>&hellip; but then I read in the small print &quot;DIO 19 / A5 &amp; DIO 5 are linked by a 4.7 kΩ resistor R27&quot;.&nbsp; This is presumably something to do with their use for OneWire connections, but for my purposes I think it means that I cannot treat them as two independent channels, so that reduces my total to 3.&nbsp; My plan therefore is&nbsp; this</p>
<table border="1" cellpadding="1" cellspacing="1">
<tbody>
<tr>
<td>&nbsp;</td>
<td>Channel</td>
<td>Connection</td>
</tr>
<tr>
<td>Reading battery voltage</td>
<td>ADC5 (D19)</td>
<td>Terminal block (5)</td>
</tr>
<tr>
<td>Analog control of immersion heater 1</td>
<td>D3</td>
<td>RJ-45 (6)</td>
</tr>
<tr>
<td>On/off control of immersion heater 2</td>
<td>D20</td>
<td>RJ-45 (8)</td>
</tr>
</tbody>
</table>
<p>I have already verified that I can read the battery voltages (via voltage divider) on ADC5 with analogRead.&nbsp; And analog output on D3 is working fine.</p>
<p>Basically it is just the digitalWrite to channel 20 that appears to not be working, and this is where I am stuck.</p>
<p>Here is my complete test program.</p>
<pre>
#include &lt;Ports.h&gt;

const byte LEDpin =  6;
const byte PWMPin1 =  3;
const byte PWMPin2 = 5;
const byte DigPin = 20;

const byte ProgramVersion = 5;
void setup() {  
  pinMode(LEDpin, OUTPUT);
  pinMode(PWMPin1, OUTPUT);
  pinMode(PWMPin2, OUTPUT);
  pinMode(DigPin, OUTPUT);
 
//Blink to show the version of the program
  for (int i=0; i&lt;ProgramVersion; i++)  {
    digitalWrite(LEDpin, HIGH); delay(200);
    digitalWrite(LEDpin, LOW); delay(300);
  }
}

void loop() {
    delay (2000);
    digitalWrite(DigPin, HIGH);
    digitalWrite(LEDpin, HIGH);
    analogWrite(PWMPin1, 64);
    analogWrite(PWMPin2, 64);
    
    delay(2000);
    analogWrite(PWMPin1, 255);
    analogWrite(PWMPin2, 0);
    
    delay (2000);
    digitalWrite(DigPin, LOW);
    digitalWrite(LEDpin, LOW);
    analogWrite(PWMPin1, 0);
    analogWrite(PWMPin2, 255);
}
</pre><p>Am I making some elementary mistake? Or is something broken? If it&#39;s not going to work like this is there another way of achieving the same thing?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40482"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Mon, 21/03/2016 - 10:52.</div>
    <div class="content">
     <p>Maybe it should be port 19 rather than 20.&nbsp; The lowest numbered port is 0 rather than 1, and there only 20 in total.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40486"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 21/03/2016 - 11:26.</div>
    <div class="content">
     <p>It seems that you cannot use ADC 6&nbsp;as a digital output. Section&nbsp;23.9.5 (DIDR0 &ndash; Digital Input Disable Register 0) of the data sheet does not show ADC&nbsp;6&nbsp;&amp; 7 on the bit map and says &quot;Note that ADC pins ADC7 and ADC6 do not have digital <em><strong>input</strong></em>&nbsp;<em>[my emphasis]&nbsp;</em>buffers, and therefore do not&nbsp;require Digital Input Disable bits.&quot; Additionally, on the pin-out diagram for the 32 MLF package, ADC&nbsp;6 &amp; 7 do not belong to any port, and that indicates to me (by that omission) that there isn&#39;t a port register where you can set and use it as a digital&nbsp;output, or indeed anything other than an analogue input.</p>
<p>I&#39;m open to correction on any of this.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40489"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 21/03/2016 - 12:04.</div>
    <div class="content">
     <p>Regarding the numbering, I&#39;m going by I am going by the table at <a href="https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4#emonTx_V3.4_2" title="https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4#emonTx_V3.4_2">https://wiki.openenergymonitor.org/index.php/EmonTx_V3.4#emonTx_V3.4_2</a> which shows ports numbered D0 thru D21 (making 22 in all) and I&#39;m writing (or rather, attempting to write) to D20 (which is the 21st port if you count the first as 1).</p>
<p>Now that I look more closely at that table, I see that in the column headed &quot;ATmega328 port&quot;, D20 and D21 have blanks whereas all the other ports have a value in this column, which seems to fit in with Robert Wall&#39;s explanation.</p>
<p>That would have taken me a <u>long</u> time to figure out on my own.&nbsp;</p>
<p>So, if D20/A6 is in fact <u>only</u> capable of being used as an analog input, then I&#39;ll <u>have</u> to use this one to do my battery voltage monitoring.&nbsp; That is a slight shame because I&#39;d been hoping to use the terminal block for the battery monitoring and the RJ-45 socket for the immersion heater control - purely because of the convenience in connecting up.&nbsp; But never mind, at least it&#39;s not because something&#39;s broken, and at least I&#39;m not stuck any more.</p>
<p>So the revised plan is to do this:</p>
<table border="1" cellpadding="1" cellspacing="1">
<tbody>
<tr>
<td>&nbsp;</td>
<td>Channel</td>
<td>Connection</td>
</tr>
<tr>
<td>Reading battery voltage</td>
<td>ADC6 (D20)</td>
<td>RJ-45 (8)</td>
</tr>
<tr>
<td>Analog control of immersion heater 1</td>
<td>D3</td>
<td>Terminal block (4)</td>
</tr>
<tr>
<td>On/off control of immersion heater 2</td>
<td>D5</td>
<td>Terminal block (6)</td>
</tr>
</tbody>
</table>
<p>I shall now repeat the tests to make sure that this plan is workable.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40497"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 21/03/2016 - 14:21.</div>
    <div class="content">
     <p>OK, the latest plan as per previous post, is now working, ie I can do analogRead on channel A6 via the RJ-45 connection # 8, while simultaneously writing to D3 (PWM) on terminal block #4 and writing to D5 (on-off) on terminal block #6.</p>
<p>Here is the complete test program.</p>
<pre>
#include &lt;Ports.h&gt;

const byte LED =  6;
const byte PWMImmersion =  3; // terminal block connection #4
const byte DigImmersion = 5; // terminal block connection #6
const byte AnalogBV = 6;  // analog input 6 = D20 = RJ-45 connection #8

int int1023Voltage;  // battery voltage on a scale of 0 - 1023

const byte ProgramVersion = 6;

void setup() {  
  pinMode(LED, OUTPUT);
  pinMode(PWMImmersion, OUTPUT);
  pinMode(DigImmersion, OUTPUT);
 
  Serial.begin(9600);

//Blink to show the version of the program
  for (int i=0; i&lt;ProgramVersion; i++)  {
    digitalWrite(LED, HIGH); delay(200);
    digitalWrite(LED, LOW); delay(300);
  }
}

void loop() {
    int1023Voltage = analogRead (AnalogBV);
    Serial.print(&quot;Voltage out of 1023: &quot;); Serial.println(int1023Voltage);
    Serial.print(&quot;Voltage in volts: &quot;); Serial.println(3.3 * int1023Voltage / 1023);
    delay (2000);
    digitalWrite(DigImmersion, HIGH);
    digitalWrite(LED, HIGH);
    analogWrite(PWMImmersion, 64);
        
    delay(2000);
    analogWrite(PWMImmersion, 255);
    
    delay (2000);
    digitalWrite(DigImmersion, LOW);
    digitalWrite(LED, LOW);
    analogWrite(PWMImmersion, 0);
}</pre><p>... and the measured voltage is correct to 1% or less.</p>
<p>The next step is to use the Darlington array IC (ULN2003A to drive the relay (Crydom CKRD2420) - again just on a test basis.&nbsp; I shall rig up a light bulb or something to test the mains switching.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40500"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 21/03/2016 - 15:33.</div>
    <div class="content">
     <p>It will&nbsp;probably be best to get the zero voltage switching version of the&nbsp;Crydom CKRD2420.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40504"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Andrew Wedmore&#039;s picture" title="Andrew Wedmore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Energy diversion in an off-grid system</h3>

    <div class="submitted">Submitted by <a href="../user/5733.html" title="View user profile.">Andrew Wedmore</a> on Mon, 21/03/2016 - 18:48.</div>
    <div class="content">
     <p>I have now got the thing to control a 230&thinsp;V / 11&thinsp;W lightbulb.&nbsp; Here is a photo:</p>
<p><img alt="" src="../sites/default/files/ControllingALightBulb.jpg" style="width: 700px; height: 451px;" /></p>
<p>The light bulb goes on and off as the emonTx&#39;s Dig5 output goes high and low.&nbsp; And the red LED glows according to the pulse width on Dig3.&nbsp; That&#39;s basically what I need.&nbsp; The Crydom CKRD2420 shows not the slightest sign of warmth while all this is going on.&nbsp; Of course I&#39;m only driving an 11&thinsp;W lightbulb, but the Crydom is rated to 240&thinsp;V / 20&thinsp;A, so it should be happy to drive a 3&thinsp;kW immersion heater.&nbsp;</p>
<p>The chip in the middle of the breadboard is the ULN2003A.&nbsp; This seems to be the recognized way of driving a relay from an Arduino.&nbsp; As I understand it, it works like this:&nbsp; the + input (terminal 3) on the relay is always going to be +12&thinsp;V in my set-up (I&#39;ve wired it direct to the power supply).&nbsp; The +12&thinsp;V power supply is also wired to the &quot;COM&quot; input (pin 9) of the ULN2003A.&nbsp; Now, if an input to the ULN2003A is low, then the corresponding output from the ULN2003A will be +12&thinsp;V.&nbsp; That output goes to the other input (terminal 4) of the relay, and while both relay inputs are at +12&thinsp;V there is no potential difference so the relay remains open.&nbsp; If the input to the ULN2003A is driven high, then the corresponding output drops to ground.&nbsp; The relay then sees a potential difference of 12&thinsp;V across its control inputs, and closes, with the result that the light bulb lights up.</p>
<p>Never has a light bulb going on and off seemed so entertaining!&nbsp; I could watch it for hours.</p>
<p>The 12&thinsp;V power supply and the Crydom CKRD2420 will be part of the finished solution.&nbsp; The red LED (and its resistor), which are driven by analogWrites to Dig3, will be replaced by the op-amp circuit so as to boost this output to 0-10&thinsp;V.&nbsp; That is the next thing that I will try.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/12184"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-vlRGis32MSV8nxHYWtyGYu_2aFfoCLo1p7a3R4W_e4c" value="form-vlRGis32MSV8nxHYWtyGYu_2aFfoCLo1p7a3R4W_e4c"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/12184 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:55:13 GMT -->
</html>
