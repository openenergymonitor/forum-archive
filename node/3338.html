<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/3338 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:10:41 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>How to process power and gas meter? | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">How to process power and gas meter?</h3>
        <span class="submitted">Submitted by <a href="../user/4909.html" title="View user profile.">Phunkafizer</a> on Sun, 15/12/2013 - 14:21</span>
        <div class="content"><p>Hello,</p>
<p>&nbsp;</p>
<p>I&#39;m new to oem and I already succeeded to put some measures to emoncms:</p>
<p><a href="http://www.emoncms.org/Phunkafizer/test" title="http://www.emoncms.org/Phunkafizer/test">http://www.emoncms.org/Phunkafizer/test</a></p>
<p>It&#39;s working perfectly, thanks a lot to the community so far!</p>
<p>Two questions:</p>
<p>- I have a homebrew gasmeter, that reports the absolute impulse count everytime it increases. Because of the radio link sometimes a frame is lost, and sometimes, if there is no count over a certain time the current value is repeated, so here is an example row of data:</p>
<p>5, 6, 8, 9, 10, 11, 13, 13, 13, 14, 15, 17, 0, 0, 1, 2, 4, 4, 5, 7, 7</p>
<p>Aditionally, if the battery has to be replaced, the value starts from 0 again. Every impulse means 1/100 m&sup3;</p>
<p>What is the best way to process this data in detail? I want to see the gasusage over the day</p>
<p>- Very similar to that, I have a electrical power meter (EMT7110), which reports the consumed energy in absolute float values:</p>
<p>5.67, 5.68, 5.90, 5.95, 5.97, 6.01, 0.0, 0.01, 0.04</p>
<p>The unit is kWh, also here it goes back to zero when it is unplugged</p>
<p>How to process this one?</p>
<p>&nbsp;</p>
<p>At this oppurtinity I&#39;d like to present my own hardware I&#39;m using for receiving radio-thermometers und transmitting gasmeter:</p>
<p><a href="http://www.seegel-systeme.de/index.php?page=rf-soap" title="http://www.seegel-systeme.de/index.php?page=rf-soap">http://www.seegel-systeme.de/index.php?page=rf-soap</a></p>
<p>&nbsp;</p>
<p>Finally here is my current OEM setup:</p>
<p>- Various commercial radio thermometers and hygrometers</p>
<p>- Received by RFSoap module which converts received data to JSON packets, sending them via USB to</p>
<p>- iomega iConnect, on which a small pyhton script is running, sending the data to emoncms</p>
<p>&nbsp;</p>
<p>Regards</p>
<p>Stefan</p>
  <div class="forum-topic-navigation clear-block">
          <a href="3389.html" class="topic-previous" title="Go to previous forum topic">‹ Raspberry boot problem with  the downloaded image: emoncmsraspberrypihdd_stack.tar.gz (791Mb), </a>
              <a href="936.html" class="topic-next" title="Go to next forum topic">EMON sample rate critical? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-16847"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: How to process power and gas meter?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 17/12/2013 - 22:58.</div>
    <div class="content">
     <p>Jerome has thought quite a lot about this problem. I&#39;m not sure if he found a perfect solution, but you could try searching through his posts to see what he has written.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-16859"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: How to process power and gas meter?</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Wed, 18/12/2013 - 11:52.</div>
    <div class="content">
     <p>Indeed, I configured my TX to send the pulses the same way your gasmeter does.</p>
<p>This is ongoing work, and I&#39;m currently stuck with range issues, so I haven&#39;t been working on it lately.</p>
<p>I&#39;ll propose it for integration when it&#39;s all validated. In the meantime, you may want to have a look to:</p>
<ul>
<li>
		The <a href="https://github.com/Jerome-github/oem_emonTxFirmware/blob/emontx_pulse_power_temp/emonTx_Pulse_Power_Temperature/emonTx_Pulse_Power_Temperature.ino">sketch</a> I&#39;m using in the TX. (Actually you don&#39;t need this, but someone who&#39;s interested in this thread could.)</li>
<li>
		The <a href="https://github.com/Jerome-github/emoncms_emoncms/compare/pulse_to_power">modifications I made to emoncms</a>.</li>
</ul>
<p>Current issues:</p>
<ul>
<li>
		emoncms needs to discriminate between counter being reset and counter wrapping around. In the general case, this takes the knowledge of the max counting rate. Since I don&#39;t know how to pass this as a parameter to the pulse_diff function, there is a hardcoded 1 <a href="https://github.com/Jerome-github/emoncms_emoncms/blob/pulse_to_power/Modules/input/process_model.php#L780">here</a>.</li>
<li>
		When the received counter value is similar to last value, emoncms computes a power of 0. Then, if the counter is incremented and received just a second later, the power calculated is huge and wrong, because the energy was not actually consumed only in the last second, but also before.</li>
</ul>
<p>For this particular issue, I modified emoncms so that when the counter is received with a value equal to the last one, the processing is stopped and the power not calculated. Therefore, when the value is actually increased, the power is computed on a time interval that goes back to the last increment. This is the best we can do with the meter precision.</p>
<p>The issue is with the graphical representation. In practice, you get power profiles (in kW) roughly like this:</p>
<p>12 13 12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 12 13 12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</p>
<p>This is for a boiler that goes on for a few minutes every 20 minutes. You get more or less flat peaks, almost like a square wave. And before each peak, you have a low power value that accounts for the energy consumed during the interval between the peaks. This can be real energy (little gas consumption, for cooking or hot water) or an artefact due to the meter precision. In any case, there&#39;s nothing we can do about it.</p>
<p>To graphically represent this, I&#39;d like to see a square wave, with a value close to but not 0 between the peaks. (In fact it can never be a perfect 0.) With the current emoncms graphical visualisation, the power points are linked linearly: draw each point, then add a line between them, so as to get a continuous function. But we need a step function: each value is the value of the power for the time passed since last sample. There is no interpolation to make. And if there was, it would be between the points that are at the middle of each segment.</p>
<p>We don&#39;t want the visualization to make the graph continuous.</p>
<p>I suppose this would take a new visualization type. I had a quick peek in the code and it wasn&#39;t obvious to me how to create one.</p>
<p>Am I making myself clear ? I hope so because this is also a call for help, regarding the visualization need.</p>
<p>I tried to trick the visualization: each time a new power value is computed, before entering it in the database, add another sample with the same value and the time of the last sample, to force the curve to appear as a step function. Obviously, this is a dirty hack. I just wanted to see what it would look like. I couldn&#39;t test because of another issue on my setup. This is not pushed on my github branch anyway.</p>
<p>Related threads:</p>
<p><a href="3183.html" title="http://openenergymonitor.org/emon/node/3183">http://openenergymonitor.org/emon/node/3183</a></p>
<p><a href="1585.html" title="http://openenergymonitor.org/emon/node/1585">http://openenergymonitor.org/emon/node/1585</a></p>
<p><a href="2850.html" title="http://openenergymonitor.org/emon/node/2850">http://openenergymonitor.org/emon/node/2850</a></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-16862"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4253.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="charliemic&#039;s picture" title="charliemic&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: How to process power and gas meter?</h3>

    <div class="submitted">Submitted by <a href="../user/4253.html" title="View user profile.">charliemic</a> on Wed, 18/12/2013 - 13:37.</div>
    <div class="content">
     <p>Jerome,</p>
<p>I am reading your stuff with great interest, as I will soon be coming across these issues. My next step is to see if I can get a magnetic pulse reading from my meter, so a few steps behind you!</p>
<p>I am hoping that I will be able to power my EmonTx from a mains adapter rather than battery, so I&#39;m not so bothered about saving power.</p>
<p>You may have already thought this through, but instead of using emoncms to calculate power from the number of pulses received (if I understand the sketch correctly), why not calculate the rate of power on the emonTX and send this value?</p>
<p>So transmit from the emonTX every 60 seconds, counting the number of pulses each time, and therefore the kW over this 1 minute period. At low gas consumption figures this will give slightly odd results though?</p>
<p>Chris</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-16864"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4253.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="charliemic&#039;s picture" title="charliemic&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: How to process power and gas meter?</h3>

    <div class="submitted">Submitted by <a href="../user/4253.html" title="View user profile.">charliemic</a> on Wed, 18/12/2013 - 13:48.</div>
    <div class="content">
     <p>Some questions on your emonTX sketch (I&#39;m pretty new to coding Arduino sketches);</p>
<p>&nbsp;</p>
<p>Line 30: doesn&#39;t this code get run first if it is located before the setup? Shouldn&#39;t this go after the void loop section?</p>
<p>Line 78: detachInterrupt(1)- doesn&#39;t this turn off the interrupt? What is this used for?</p>
<p>Line 85: if(digitalRead(3)==LOW)- what is this if statement for?</p>
<p>Line 91: is the watch dog timer there to count the time between pulses?</p>
<p>Chris</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-16868"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: How to process power and gas meter?</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Wed, 18/12/2013 - 15:33.</div>
    <div class="content">
     <p>Line 30: No. This is the handler interrupt. It is called when a falling edge is received on the interrupt in, thanks to line 69:</p>
<pre>
attachInterrupt(1, Pulse, FALLING);</pre><p>(See, &quot;Pulse&quot; is the name of the handler function.)</p>
<p>Line 78: The interrupt is detached for a short amount of time (10ms + computation and RF send) to debounce the signal, otherwise, the Reed switch would generate several interrupts for the same wheel turn. it is then reattached after that, at the beginning of the next loop iteration.</p>
<p>Line 85: This checks that after the 10 ms debounce period, the signal is still low. If not, it was just noise.</p>
<p>Line 91: No. See next paragraph.</p>
<p>I&#39;m using deep sleep mode. If you&#39;re on grid, most of the complications in my sketch are useless to you.</p>
<p>In this mode, only the watchdog and the interrupt can wake the TX up. The TX awakes only if a falling edge is received (wheel turn) or the watchdog reaches its end (8s in my case, which is the maximum, but this is not precise, it is rather a minimum).</p>
<p>Because of this, there is no way to compute the power on the TX, because it does not know how much time elapsed since last interrupt: while sleeping, it loses the notion of time. Because of the watchdog precision, and because when the interrupt triggers, we don&#39;t know how much time was left in the watchdog (I think, I&#39;m not 100% sure).</p>
<p>You can do the calculations in the TX if you use a lighter sleep mode where you can use a counter. Perhaps is this a better idea. I mean, even on battery, if it does not consume much more, it could be a good idea. I didn&#39;t investigate this, thinking if a post-processing is possible, we might as well allow the TX to sleep.</p>
<p>Another option we did not explore is the power computation in the base...</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-16913"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4253.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="charliemic&#039;s picture" title="charliemic&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: How to process power and gas meter?</h3>

    <div class="submitted">Submitted by <a href="../user/4253.html" title="View user profile.">charliemic</a> on Fri, 20/12/2013 - 17:58.</div>
    <div class="content">
     <p>Jerome,</p>
<p>Thanks for the detailed reply and explanation. I think it mostly makes sense to me now.</p>
<p>You mention in another thread that you are concerned about the reliability of the wireless transmission of pulses (from the emonTX to the Pi), which is why you are using a counter to send the total number of pulses achieved, then post processing to get the kW over that period. Have I understood correctly?</p>
<p>If I have, I would assume that even if using a power supply for the emonTX, I would have the same issue that occasionally the transmission of a pulse might fail to get to the RPi (wireless transmissions I assume are occasionally a bit dodgy just like my internet at home!)</p>
<p>This isn&#39;t a problem with the electrical monitoring using a CT clamp, as if the wireless cuts out for a few seconds it makes no difference, as the TX is broadcasting all the time. But if trying to capture pulses, at low pulse rates this could make a bit more difference. If there was only one pulse per minute, and the wireless transmission failed for some reason, I would get no reading.</p>
<p>Chris</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-16946"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: How to process power and gas meter?</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Sat, 21/12/2013 - 16:46.</div>
    <div class="content">
     <blockquote><p>You mention in another thread that you are concerned about the reliability of the wireless transmission of pulses (from the emonTX to the Pi), which is why you are using a counter to send the total number of pulses achieved, then post processing to get the kW over that period. Have I understood correctly?</p>
</blockquote>
<p>Right.</p>
<blockquote><p>If I have, I would assume that even if using a power supply for the emonTX, I would have the same issue that occasionally the transmission of a pulse might fail to get to the RPi (wireless transmissions I assume are occasionally a bit dodgy just like my internet at home!)</p>
</blockquote>
<p>True.</p>
<blockquote><p>This isn&#39;t a problem with the electrical monitoring using a CT clamp, as if the wireless cuts out for a few seconds it makes no difference, as the TX is broadcasting all the time. But if trying to capture pulses, at low pulse rates this could make a bit more difference. If there was only one pulse per minute, and the wireless transmission failed for some reason, I would get no reading.</p>
</blockquote>
<p>Using the TX on power supply, you could take a different approach, use time knowledge to compute the power in the TX and send the power. In this case, if you miss a frame, it can&#39;t be repeated, the value is interpolated, which is generally fine but not great with a low pulse rate. You may be better off using the counter approach as well.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/3338"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-dHOkNIR8QVjj4zeA7ctbOYN-88Ds7u8wGajFyF20FtE" value="form-dHOkNIR8QVjj4zeA7ctbOYN-88Ds7u8wGajFyF20FtE"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/3338 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:10:41 GMT -->
</html>
