<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11231 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:29:59 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonTH &amp; DS18b20&#039;s | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonTH &amp; DS18b20&#039;s</h3>
        <span class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Wed, 09/09/2015 - 23:31</span>
        <div class="content"><p>Well, here we go again lol.</p>
<p>I got my EmonTH&#39;s today and started playing with one. One of them I want to have monitor the T&amp;H using the onboard DHT22, as well as two DS18b20&#39;s. In the Github repository for the EmonTH, I found the &#39;emonTH_DHT22_dual_DS18B20&#39; sketcha nd thought &#39;Awesome! All I need to do is change the DS18B20 addresses and of fI go!&#39;. Well, not so much.</p>
<p>That Dual DS18b20 script is apparently based on the &#39;emonTH_DHT22_DS18B20&#39;, which on looking closer seems to not be the one that came on the EmonTH. It seems the original FW is actually &#39;emonTH_DHT22_DS18B20_RFM69CW&#39;. But when I loaded the Dual DS18b20 sketch up, it didn&#39;t work, and the serial output is flaky.</p>
<p>&nbsp;</p>
<p>I get this in the output (garbled text and all):</p>
<p>emo&lsaquo;&hellip;: OpenEnergyMon&Ntilde;&frac12;&Eacute;&sup1;org<br />
Node: 19 Freq: 433Mhz Network: 210<br />
&uuml;TW&Ouml;&Ntilde;&bull;&lsquo;DHT22 temp &amp; humidity sensor<br />
&frac12;&Otilde;&sup1;&lsquo;DS18B20 External 1<br />
Found DS18B20 External2<br />
emonTH payload:<br />
&nbsp; Battery voltage: 0.60V<br />
&nbsp; External sensor 1: 25.60C<br />
&nbsp; External sensor 2: 25&thorn;</p>
<p>&nbsp;</p>
<p>After some more looking and comparing, it seems the hardware or at least coding of the dual ds18b20 sketch is not much like the newer sketch. at the very least, pin assignments seemt o be quite different. I&#39;ve been trying to &#39;graft&#39; things over from the &#39;emonTH_DHT22_dual_DS18B20&#39; sketch to the and so far I haven&#39;t been able to get it to compil e&#39;emonTH_DHT22_DS18B20_RFM69CW&#39;</p>
<p>&nbsp;</p>
<p>This is the error log from the most recent attempt to compile:</p>
<p>emonTH_DHT22_DS18B20_RFM69CW:65: error: redefinition of &#39;const int time_between_readings&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:62: error: &#39;const int time_between_readings&#39; previously defined here<br />
emonTH_DHT22_DS18B20_RFM69CW.ino: In function &#39;void setup()&#39;:<br />
emonTH_DHT22_DS18B20_RFM69CW:146: error: assignment of read-only variable &#39;nodeID&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:147: error: assignment of read-only variable &#39;nodeID&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:148: error: assignment of read-only variable &#39;nodeID&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:149: error: assignment of read-only variable &#39;nodeID&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:156: error: &#39;struct Payload&#39; has no member named &#39;temp&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:161: error: &#39;struct Payload&#39; has no member named &#39;temp&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:238: error: &#39;numSensors&#39; was not declared in this scope<br />
emonTH_DHT22_DS18B20_RFM69CW:242: error: &#39;allAddress&#39; was not declared in this scope<br />
emonTH_DHT22_DS18B20_RFM69CW.ino: In function &#39;void loop()&#39;:<br />
emonTH_DHT22_DS18B20_RFM69CW:289: error: &#39;numSensors&#39; was not declared in this scope<br />
emonTH_DHT22_DS18B20_RFM69CW:289: error: &#39;allAddress&#39; was not declared in this scope<br />
emonTH_DHT22_DS18B20_RFM69CW:292: error: &#39;allAddress&#39; was not declared in this scope<br />
emonTH_DHT22_DS18B20_RFM69CW:296: error: &#39;struct Payload&#39; has no member named &#39;temp&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:297: error: &#39;struct Payload&#39; has no member named &#39;temp_external&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:309: error: &#39;struct Payload&#39; has no member named &#39;temp&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:324: error: &#39;struct Payload&#39; has no member named &#39;temp_external&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:325: error: &#39;struct Payload&#39; has no member named &#39;temp&#39;<br />
emonTH_DHT22_DS18B20_RFM69CW:332: error: &#39;struct Payload&#39; has no member named &#39;temp&#39;</p>
<p>&nbsp;</p>
<p>Any tips to get this working right? I&#39;m goign to keep plugging away at it and see if I can get it, but as usual, any help would be apprecaited.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11261.html" class="topic-previous" title="Go to previous forum topic">‹ Any plans to update the emontx shield to being similar to v3.4?</a>
              <a href="11257.html" class="topic-next" title="Go to next forum topic">Connecting an RFM12Pi to raspberry pi via serial(just for education purposes) ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-34000"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 10/09/2015 - 00:02.</div>
    <div class="content">
     <p>You need to get rid of those errors starting at the top.  Note the error is <i>usually</i> on the line it gives, but sometimes it can be one or more lines before.</p>
<p>Over time, the way things are done has changed in detail, but the objective has remained pretty much the same.</p>
<p>"redefinition of 'const int time_between_readings'"  means you've got that twice. That's not legal.</p>
<p>"assignment of read-only variable 'nodeID'" means it's defined as a const (unchangeable) but now you're trying to give it a new value (or maybe the same value again).</p>
<p>"'struct Payload' has no member named 'temp'" means you're referring to something that's not there in the Payload. Either the name has changed or you haven't added it in the definition of Payload.</p>
<p>"....was not declared in this scope" means (probably) it's a new/different name for a quantity, or you've forgotten to declare it. The concept of 'scope' is too long to spell out here, a C / C++ programming tutorial will help you (e.g.http://www.relisoft.com/book/index.htm).</p>
<p>I've had to be fairly general because I don't know what changes you've made to provoke those errors.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34051"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Wed, 16/09/2015 - 23:14.</div>
    <div class="content">
     <p>I think I&#39;m going to throw in the towel here. I copied everything that I could see that seemed relevant from the newer sketch to the dual DS18B20 sketch; Changed it to the JeeLib.h rather than RFu_JeeLib.h, added in the dip switch code, changed the nodeID from &#39;const int&#39; to &#39;int&#39;, and probably a few other things I can&#39;t think of, and after fighting through a bunch of compile errors, I was able to get it to compile and write to the TH, but still no go. I actually thought it somehow fried the radio in it as after loading it up, it still wasn&#39;t getting to the EmonHUB. Turns out it was the fact that I had change dht payload structure; apparently the payload didn&#39;t match to the EmonHUB was ignoring it.</p>
<p>With the attached sketch, I&#39;m still getting a messed up boot over the serial:</p>
<p>emo&lsaquo;&hellip;: OpenEnergyMon&Ntilde;&frac12;&Eacute;&sup1;org<br />
Node: 19 Freq: 433Mhz Network: 210<br />
&uuml;TW&Ouml;&Ntilde;&bull;&lsquo;DHT22 temp &amp; humidity sensor<br />
Unable to find address for DS18B20 External 1... check hard coded address<br />
Unable to V&Euml;&lsaquo;address for DS18B20 External 2... check hard coded address<br />
emonTH payload:<br />
&nbsp; Battery voltage: 3.20V<br />
&nbsp; External sensor 1:&nbsp; not present<br />
&nbsp; External sensor 2:&nbsp; not pre&yuml;</p>
<p>
It just locks up there and never moves again.</p>
<p>Any clues? I feel like an infant trying to build a race motor in trying to piece the two sketches together...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34067"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 11/09/2015 - 13:04.</div>
    <div class="content">
     <p>I too see the corrupted serial output - it's usually caused by printing too much to the serial terminal!</p>
<p>For a start, you don't <i>need</i> the DIP switch code. The switches are there so that people without programmers can change the Node ID. If you've got a programmer, you can define it in the code and not bother with the switches.</p>
<p>Those last 2 error messages say it can't find your 2 sensors, so the sketch is designed to stop there and do nothing more. Having failed to find your sensors, it's doing exactly as it should!</p>
<p>You need to get the two external sensors to respond. Obviously I can't check the addresses of your sensors - did you get the addresses using the "Temperature Search" sketch from <a href="https://github.com/openenergymonitor/emonTH/tree/master/Simple emonTH Sensor Test/emonTH_temperature_search">here</a>?<br />
(I can't test this as I haven't got a spare sensor.)</p>
<p>Which version of the emonTH do you have - in other words, is<br />
&nbsp;&nbsp;const int DS18B20_PWR  = 5;<br />
&nbsp;&nbsp;const int DHT_PWR      = 6;<br />
correct <u>for your hardware version</u>? (What you have should be correct for V1.4 &amp; 1.5.)</p>
<p>What happens when it tries to read a sensor is:<br />
1. It turns the power on: digitalWrite(DS18B20_PWR, HIGH);<br />
2. Tells the sensors to initialise: sensors.begin();<br />
3. Sees if a sensor is at the address you give: sensors.getAddress(EXT_SENSOR1, 0);<br />
4. Tell you what it found,<br />
5. Turns the power off: digitalWrite(DS18B20_PWR, LOW);</p>
<p>If you have a multimeter, you could extend the delay after the power is turned on (to give you time to see something!) and check the power supply to the sensor. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34069"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Fri, 11/09/2015 - 13:20.</div>
    <div class="content">
     <p>Could the serial corruption be due to the Serial connection being accessed (tested for) before the baud is set ?</p>
<p>debug = Serial ? 1 : 0;<br />
if (!debug)&nbsp;<br />
&nbsp; &nbsp; return;&nbsp;<br />
Serial.begin(9600);</p>
<p>I know what this is trying to do, but does it work 100% ?</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34070"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Fri, 11/09/2015 - 13:30.</div>
    <div class="content">
     <p>I have 1.5.2 TH&#39;s. It doesn&#39;t see the DS sensors because at that time, they were not connected (only the DHT22 was), When connected, it finds them both, but it still doesn&#39;t work.. If I &#39;m not mistaken, the code is written so that if it doesn&#39;t find ANY sensors it stops and sleeps forever. t did have the DHT22 attached, so it had a sensor and could coninue.<br />
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34076"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 11/09/2015 - 18:33.</div>
    <div class="content">
     <p>Knowing what you don't have connected makes a difference, believe it or not! It does help people to help you if you don't hide material facts like that.</p>
<p>I've converted back to RFu_JeeLib (because my emonTH is that sort) and you're right about it should work with only the DHT22, your sketch seems to work for me like that (notwithstanding the corrupted serial output). When I wrote the last post, I hadn't noticed that "üTWÖÑDHT22 temp &amp; humidity sensor" was the correct number of characters for "Detected DHT22 temp &amp; humidity sensor".</p>
<p>Note that the last output line isn't printed until the next set of readings 5 minutes or so later. You can put Serial.flush() at the end of print_payload() if you wish.</p>
<p>So barring a soldering fault on the radio module (and haven't you had it transmitting, in which case that's improbable), I can't see why the sketch doesn't work for you.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34082"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Fri, 11/09/2015 - 20:23.</div>
    <div class="content">
     <p>I wouldn&#39;t call it hiding. Forgetting to mention or simply leaving that detail out, sure. Hiding indicates ill intent. :)</p>
<p>Yes, it&#39;s been transmitting fine - I loaded up the original sketch last night and it&#39;s been happily reporting to the base all night and all day today.</p>
<p>So I missed that the older sketch was polling every 5 minutes - I changed that to 1 and uploaded it; It seems it doesn&#39;t hang, but instead does keep polling data (lots of errors in the serial output still though), but it&#39;s not transmitting (Or at least it doesn&#39;t seem to be). It never checks in with the base. And it may be a coincidence, but it seemed like it may have been somehow interfering with the other TH&#39;s. While the modified firmware was running, the other two stayed out of contact a lot longer than they usually do. They normally don&#39;t get more than 65 seconds out or so. With his one up, they were approaching 90-180 seconds out.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34086"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 11/09/2015 - 21:45.</div>
    <div class="content">
     <p>You do have a 433 MHz network?</p>
<p>And you have got the payload set up correctly - 5 signed integers - in emonHub?</p>
<p>Bearing in mind I'm using a different library, I can't see anything that might mean that this one is blocking the others, and mine certainly is only transmitting when it's expected. (With 'minutes' set to 5, it actually waited 4' 45" between transmissions.)</p>
<p>[Paul:</p>
<pre>  debug = Serial ? 1 : 0;                              
  if (!debug)
    return;
  Serial.begin(9600);
</pre><p>makes no difference. The docs say all but the Leonardo always return true, so I guess "Serial" for the Uno does nothing except return anyway.]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34089"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 11/09/2015 - 22:42.</div>
    <div class="content">
     <p><em>I too see the corrupted serial output - it&#39;s usually caused by printing too much to the serial terminal!</em></p>
<p>That sounds bogus to me. &nbsp;How much is &quot;too much&quot;?</p>
<p><em>Note that the last output line isn&#39;t printed until the next set of readings 5 minutes or so later. You can put Serial.flush() at the end of print_payload() if you wish.</em></p>
<p>If you do, does that cure the data corruption problem?</p>
<p>It sounds like you might be putting the CPU to sleep while it&#39;s busy transmitting on the UART. &nbsp; &nbsp;If that&#39;s not snyc&#39;d&nbsp;up with the&nbsp;current byte completing I&#39;d expect you&#39;d see the corruption you&#39;re seeing.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34090"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 11/09/2015 - 22:52.</div>
    <div class="content">
     <p>Download the sketch and try it yourself - it's attached to the 3rd post in this thread.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34091"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 11/09/2015 - 22:57.</div>
    <div class="content">
     <p>I don&#39;t have any suitable hardware to run it on, and I assume it would need quite a bit of modification to run on anything I do have. &nbsp; &nbsp;But I repeat my question for anyone who does:</p>
<p>Does calling&nbsp;Serial.flush() before going to sleep cure the data corruption problem?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34092"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 12/09/2015 - 00:01.</div>
    <div class="content">
     <p><i>&quot;Does calling Serial.flush() before going to sleep cure the data corruption problem?&quot;</i></p>
<p>No, looking at the printout, the major corruption is the first that is sent in setup( ). Everything in loop( ) is OK for me (but not for Dave, he&#39;s using the expanded JeeLib whereas I&#39;m using RFu_JeeLib).</p>
<p>I&#39;m not familiar with the way the compiler arranges the code and data, but in my experience string corruption is the first symptom of running out of memory. I do note that the print call in question is inside a function, so that&#39;s a bit more stack used than normal.</p>
<p>[EDIT] <i>&quot;Does calling Serial.flush() before going to sleep cure the data corruption problem?&quot;</i></p>
<p>That triggered a thought. No it doesn&#39;t, but calling it <i>after</i> each block of printing <u>does</u> cure the corruption problem. Whether that&#39;s after printing or before it does anything with the OneWire bus, I&#39;m not sure.</p>
<p>[Edit 2]</p>
<p>Attached the file with Serial.flush(); inserted.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34093"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sat, 12/09/2015 - 01:07.</div>
    <div class="content">
     <p>Is it possible that it actually is transmitting data, but there&#39;s corruption there too, causing the Base to ignore the packets?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34094"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 12/09/2015 - 01:11.</div>
    <div class="content">
     <p>I didn&#39;t see any - but I didn&#39;t look past the 1st 6 bytes.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34095"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sat, 12/09/2015 - 01:57.</div>
    <div class="content">
     <p>Hmm. Well, I don&#39;t know where to go from here. I&#39;m an IT administrator by day, am proficient in networking, Windows server OSes and functions, virtualization, security, firewalls, etc, but I cant grasp the arduino coding. I started trying to play with PIC micro controllers a few years ago, and no matter what I read, I couldn&#39;t grasp that. Without a walk through tutorial, I couldn&#39;t even make a LED blink. About a year ago, addressable LED Pixels &amp; arduinos caught my attention, but as with the PICs, I just can&#39;t grasp it no matter what I read. I haven&#39;t even been able to figure out how to make a pixel blink or change colors. The only way I can do anything with the Aduinos is if I find something out on the web that&#39;ll do what I want.</p>
<p>The last arduino/Atmega 328p based project I attempted I essentially tossed in the bin because as soon as I deviated from the original creators coding in the slightest degree, it fell apart like a hose of cards. I still have the PCBs I designed and had made, as the tep nodes work well as standalone units, but the intent was to transmit back to a RPi (by way of an arduino) and that part just kept failing miserably.</p>
<p>If it&#39;s REAL simple, like on the TX, changing the calibration values for the CTs or its address, that I can get, but when it comes to how all the code works, I&#39;m totally lost. The copy &amp; pasting I&#39;ve been doing is just taking WAGs and see what happens. I&#39;ve been able to clear up errors that prevents it from compiling with the help of google, but it doesn&#39;t help me understand how it all works, and as evidenced by my attempts with the TX &amp; this, it doesn&#39;t mean it WILL work. So this makes for two emon related things that I&#39;ve tried to customize and make and totally failed at (the first being hardcoding DS18b20 addresses into the TX).</p>
<p>It&#39;s so frustrating. The Arduinos (and arduino based things such as the emon products) are so cool and flexible, but despite my tech background, I can&#39;t grasp what is arguably (by some) simpler than the things I do on a daily basis. I guess everyone has their niche, and this just isn&#39;t mine.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34097"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 12/09/2015 - 04:45.</div>
    <div class="content">
     <p><em>No, looking at the printout, the major corruption is the first that is sent in setup( )</em></p>
<p>But print_welcome_message() enqueues a bunch of strings to the serial port and immediately calls dodelay() right? In fact there are&nbsp;calls to dodelay() all over the place without any regard for what&#39;s in the output queue.</p>
<p>Did you try a single call to Serial.flush() inside dodelay(), before it does anything else? &nbsp;That would ensure that you never put the CPU to sleep right while it&#39;s trying to clock out the 10-bits of a&nbsp;UART byte.</p>
<p><em>I&#39;m not familiar with the way the compiler arranges the code and data,</em></p>
<p>The code lives in flash, and is executed from flash, so you can&#39;t corrupt that unless you try really hard (like the bootloader does). &nbsp;</p>
<p>.data lives below .bss, so if the stack is trampling over your strings it&#39;s probably already taken out your static variables on the way down.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34100"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 12/09/2015 - 12:00.</div>
    <div class="content">
     <p>I&#39;m only trying by remote control to debug a sketch that isn&#39;t written the way I might have done it in the first place, using (slightly) different hardware! The reason I put the flush() in 'everywhere' is the Arduino documentation is wonderfully unclear about what happens when the serial port isn&#39;t open (debug became false), so I put it in only where debug is true. dodelay(&nbsp;) appears to be everywhere, but in fact it misses one!</p>
<p>Dave: I&#39;ve managed networks in the past, so I understand where you&#39;re coming from. You think big. In this area, you need to think small! I&#39;ll do my best to steer you through, assuming that&#39;s what you&#39;d want? It WILL work&nbsp;- together we&#39;ll battle it into submission.</p>
<p>I&#39;m using an emonGLCD running a &#39;Debugger&#39; sketch - it just receives radio packets and displays them as bytes. That&#39;s showing exactly the same as the serial display, so I&#39;m reasonably confident that it&#39;s not sending rubbish (at least not now):</p>
<pre>
emonTH : OpenEnergyMonitor.org
Node: 19 Freq: 433MHz Network: 210
Detected DHT22 temp &amp; humidity sensor
Unable to find address for DS18B20 External 1... check hard coded address
Unable to find address for DS18B20 External 2... check hard coded address
emonTH payload: 
  Battery voltage: 0.00V
  External sensor 1:  not present
  External sensor 2:  not present
  Internal DHT22 temperature: 19.50C, Humidity: 65.30% 
</pre><p>In the photo, bytes 0&amp;1 are 0 0 (battery&nbsp;voltage)<br />
bytes&nbsp;2&amp;3 are 8d 02&nbsp;= 653&nbsp;(= 65.3&nbsp;* 10 = humidity)<br />
bytes 4&amp;5 are c3 00 = 195 (=19.5 * 10 = internal temp)<br />
the rest (external sensors) are zero.</p>
<p>&nbsp;</p>
<p>If you've loaded that file and you're still having trouble at this point, what does your emonhub.conf file say about Node 20?<br />
You need it to be looking for either 5 signed integers, or the default ("datacode = " instead of "datacode<b>s</b> = ...", meaning any number of signed integers)</p>
<pre>
[[20]]
    nodename = emonTH
    firmware = mod2.ino
    hardware = emonTH
    [[[rx]]]
       names = battery, humidity, intTemp, extTemp1, extTemp2
       datacodes = h, h, h, h, h
       scales = 0.1, 0.1, 0.1, 0.1, 0.1
       units = V, %, C, C, C
</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34119"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sun, 13/09/2015 - 17:26.</div>
    <div class="content">
     <p>Robert, what I had in the emonhub config with the changed code for that TH was:</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp; nodename = emonTH_2<br />
&nbsp;&nbsp;&nbsp; firmware = emonTH_DHT22_DS18B20.ino<br />
&nbsp;&nbsp;&nbsp; hardware = emonTH_(Node_ID_Switch_DIP1:ON_DIP2:OFF)<br />
&nbsp;&nbsp;&nbsp; [[[rx]]]<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; names = battery, humidity, internalTemp, externalTemp1, externalTemp2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; datacode = h<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scales = 0.1,0.1,0.1,0.1,0.1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; units = V,%,C,C,C</p>
<p>&nbsp;</p>
<p>Essentially identical to what you posted other than the &#39;externalTemp1&#39; and the firmware name, which is how the sensors are listed in the firmware, although I&#39;m assuming those don&#39;t really matter if they match as that info isn&#39;t actually transmitted.</p>
<p>My question now is which would really be the better approach? Trying to modify the &#39;emonTH_DHT22_dual_DS18B20&#39; to work on the emonTH 1.5.2 that should be running the &#39;emonTH_DHT22_DS18B20_RFM69CW&#39; code, or modifying the &#39;emonTH_DHT22_DS18B20_RFM69CW&#39; code to make the multiple DS18b20&#39;s work on that? I&#39;m kind of thinking the latter would be the better approach. This way we&#39;re starting out with code that is meant for that exact hardware and works as it should, rather than trying to take the older code that does things in different ways and modifying it to work on the newer hardware - Obviously, I was able to get it to doing something, but for example, the dip switches didn&#39;t seem to be functioning - Yes, I know they&#39;re not required, but why not have them working?</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34121"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 13/09/2015 - 20:07.</div>
    <div class="content">
     <p>"datacode = h" will accept any number of signed integers, whereas I'd specified the exact number. As you say, both versions are essentially equivalent so it doesn't matter which one you use.</p>
<p>Which sketch we start with also shouldn't matter, we ought to end up with something that works either way. Have you had chance to try the "mod2" version that I'd changed? Without the external sensors, that is now behaving properly (for me at least but bear in mind I have a V1.4 emonTH, so it's using a different JeeLib).</p>
<p>I'd like you to try that one, but long-term we'll go with later version if that's which you prefer.</p>
<p>The DIP switches aren't mission-critical, we can worry about those once the important bit is working.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34125"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sun, 13/09/2015 - 20:58.</div>
    <div class="content">
     <p>I just loaded that one up and the serial output is now clear, however, nothing is getting to the base.</p>
<p>Interestingly, it seems like it doesn&#39;t care about hte DS18b20 addresses - When I initially loaded the sketch, it had one correct address and one incorrect one (one of the sensors I was using earlier was still on my desk, the other got placed somewhere, so I got the address of another one and hooked it up). Witht he wrong address, it still was giving me a temp reading off both, not complaining of a missing address or anything. I&#39;m not sure if that&#39;s supposed to work that way...</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>emonTH : OpenEnergyMonitor.org<br />
Node: 20 Freq: 433MHz Network: 210<br />
Detected DHT22 temp &amp; humidity sensor<br />
Found DS18B20 External 1<br />
Found DS18B20 External 2<br />
emonTH payload:<br />
&nbsp; Battery voltage: 0.40V<br />
&nbsp; External sensor 1: 24.80C<br />
&nbsp; External sensor 2: 24.60C<br />
&nbsp; Internal DHT22 temperature: 25.00C, Humidity: 36.90%</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>[[20]]<br />
&nbsp;&nbsp;&nbsp; nodename = emonTH_2<br />
&nbsp;&nbsp;&nbsp; firmware = emonTH_DHT22_DS18B20.ino<br />
&nbsp;&nbsp;&nbsp; hardware = emonTH_(Node_ID_Switch_DIP1:ON_DIP2:OFF)<br />
&nbsp;&nbsp;&nbsp; [[[rx]]]<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; names = battery, humidity, internalTemp, externalTemp1, externalTemp2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; datacode = h<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scales = 0.1,0.1,0.1,0.1,0.1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; units = V,%,C,C,C</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34128"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 13/09/2015 - 23:03.</div>
    <div class="content">
     <p>My emonPi isn't receiving either, but I haven't yet had time to find out why. The emonTH is certainly transmitting the right things, but I've not has the Pi long and I haven't had time to do much with it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34129"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sun, 13/09/2015 - 23:39.</div>
    <div class="content">
     <p>Well, with the attached Mod4 sketch, I&#39;ve gotten *somewhere*. I get sane text in the serial output, and I get *some* data on the base.</p>
<p>01<br />
emonTH - Firmware V1.6.1<br />
OpenEnergyMonitor.org<br />
RFM69CW Init&gt;<br />
Node: 20 Freq: 433Mhz Network: 210<br />
Detected DHT22 temp &amp; humidity sesnor<br />
Detected 2 DS18B20<br />
DS18B20 and DHT22 found, assuming DS18B20 is external sensor<br />
emonTH payload:<br />
&nbsp; Battery voltage: 3.20V<br />
&nbsp; External sensor 1:&nbsp; not present<br />
&nbsp; External sensor 2:&nbsp; not present<br />
&nbsp; Internal DHT22 temperature: 25.70C, Humidity: 34.50%</p>
<p>&nbsp;</p>
<p>I don&#39;t know what the &#39;01&#39; in the first line is about, and for some reason I haven&#39;t figured out, it&#39;s saying that the external sensors are both not present in the serial output, although it&#39;s sending data back to the base for the DHT22 and one of the DS18b20&#39;s.</p>
<p>With the &#39;Mod5&#39; sketch, after probably an hour of messing around and resolving errors, I got it to compile, and uploaded it. The serial output is broken though:</p>
<p>01<br />
emonTH - Firmware V1.6.1<br />
OpenEnergyMonitor.org<br />
RFM69CW Init&gt;<br />
Node: 20 Freq: 433Mhz Network: 210<br />
Detected DHT22 temp &amp; humidity sesnor<br />
Detected 2 DS18B20<br />
DS18B20 and DHT22 found, assuming DS18B20 is external sensor<br />
emonTH payload:<br />
&nbsp; Battery voltage: 3.20V<br />
&nbsp; External sensor 1:&nbsp; not present<br />
&nbsp; External sensor 2:&nbsp; not pre&yuml;&sup1;&Ntilde;5<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Internal DHT22 temperature: 26.60C, Humidity: 34.40%</p>
<p>emonTH payload:<br />
&nbsp; Battery voltage: 3.20V<br />
&nbsp; External sensor 1:&nbsp; not present<br />
&nbsp; External sensor 2:&nbsp; not pre&yuml;&sup1;&Ntilde;5<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Internal DHT22 temperature: 26.60C, Humidity: 34.90%</p>
<p>&nbsp;</p>
<p>But it IS transmitting some data over to the base - it&#39;s sending battery and DHT22 readings over, but no DS18b20 readings...</p>
<p>&nbsp;</p>
<p>Edit: I looked at the one that you added &#39;Serial.flush();&#39; to and added that in all the same places in the &#39;Mod5&#39; sketch, and now have sane serial output:</p>
<p>01<br />
emonTH - Firmware V1.6.1<br />
OpenEnergyMonitor.org<br />
RFM69CW Init&gt;<br />
Node: 20 Freq: 433Mhz Network: 210<br />
Detected DHT22 temp &amp; humidity sesnor<br />
Detected 2 DS18B20<br />
DS18B20 and DHT22 found, assuming DS18B20 is external sensor<br />
emonTH payload:<br />
&nbsp; Battery voltage: 3.20V<br />
&nbsp; External sensor 1:&nbsp; not present<br />
&nbsp; External sensor 2:&nbsp; not present<br />
&nbsp; Internal DHT22 temperature: 26.30C, Humidity: 35.90%</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34132"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Mon, 14/09/2015 - 00:39.</div>
    <div class="content">
     <p>Holy Mackerel! I may have actually gotten it!</p>
<p>With the attached &#39;Mod8&#39; sketch, I am getting mostly sane serial output, and it&#39;s sending all the data over to the base:</p>
<p>01<br />
emonTH - Firmware V1.6.1<br />
OpenEnergyMonitor.org<br />
RFM69CW Init&gt;<br />
Node: 20 Freq: 433Mhz Network: 210<br />
&uuml;TW&Ouml;&Ntilde;&bull;&lsquo;DHT22 temp &amp; humidity sensor<br />
Found DS18B20 External 1<br />
Found DS18B20 External 2<br />
emonTH payload:<br />
&nbsp; Battery voltage: 3.20V<br />
&nbsp; External sensor 1: 25.50C<br />
&nbsp; External sensor 2: 25.10C<br />
&nbsp; Internal DHT22 temperature: 25.60C, Humidity: 36.90%</p>
<p>emonTH payload:<br />
&nbsp; Battery voltage: 3.20V<br />
&nbsp; External sensor 1: 31.70C<br />
&nbsp; External sensor 2: 25.00C<br />
&nbsp; Internal DHT22 temperature: 25.60C, Humidity: 36.80%</p>
<p>&nbsp;</p>
<p>With the &#39;Mod7&#39; sketch, I got similar results, except it wasn&#39;t respecting the hardcoded addresses for the DS18b20s (they were swapped), so took a guess and commented out</p>
<p>&nbsp;EXT_SENSOR1_PRESENT = sensors.getAddress(EXT_SENSOR1, 0);<br />
&nbsp;EXT_SENSOR2_PRESENT = sensors.getAddress(EXT_SENSOR2, 1);</p>
<p>which gave me &#39;Mod8&#39; and reporting the sensors in their proper places. I don&#39;t know why &#39;Detected DHT22 temp &amp; humidity sensor; is partially garbled - I tried adding &#39;Serial.flush();&#39; in a few places that &#39;seemed&#39; right, but no change.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34146"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Mon, 14/09/2015 - 21:25.</div>
    <div class="content">
     <p>Ok, did some more testing - it seems that the hardcoded addresses in the sketch aren&#39;t doing anything. I added a third sensor, and all the displays were right, but I knocked out one of the other two sensors when connecting the third, and it was still showing 1 &amp; 2, with 3 not connected, but it was either 1 or 2 and three that were connected. I also note that if I change one to a bogus address, it still brings up data for all three sensors. It doesn&#39;t complain about not being able to find that address. They also arent&#39; in the order that they are specified, so it would seem that while I&#39;m getting data, I&#39;m still missing something that actually make suse of the hardcoded addresses.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34167"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 15/09/2015 - 16:20.</div>
    <div class="content">
     <p>I'm looking only at your ...mod8 sketch. I can't see why it should be ignoring the hardcoded addresses - IF the library is doing what the comments claim.</p>
<p>In initialise_DS18B20(), it calls sensors.getAddress(EXT_SENSOR1, 1) which says it checks that the sensor in question is at that address. But the name of the method worries me. Why is it called "getAddress" and not "checkAddress" or "proveAddress" if it's doing what it claims? More to the point, it uses the OneWire::search method, and that searches for the next available device, and <u>THAT</u> overwrites the address you gave it.</p>
<p>Then in take_ds18b20_reading () it does temp1=(sensors.getTempC(EXT_SENSOR1)). But if that sensor address "EXT_SENSOR1" was changed by getAddress, the address you set at the top has been overwritten, which would explain what you're seeing. So I think the comment that explains what the method does is misleading.</p>
<p>That's how I read the code. The way to prove this would be to set a completely bogus address, then print it immediately before and after the call to getAddress(). But I think that's beyond your knowledge at present.</p>
<p>I'll try to get hold of a couple of DS18B20s so that I can experiment.</p>
<p>But I think you shouldn't be using the RFM69 sketch as your starting point, because it's going to need a lot more effort to change that to use hard-coded addresses than it will be to change the older sketch to use the RFM69CW and the DIP switches.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34169"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Tue, 15/09/2015 - 17:48.</div>
    <div class="content">
     <p>How your stating it is pretty muck how I read it too. However, I also posted this over on the arduino forums, and in short, I&#39;m told that &#39;getAddress changes value of EXT_SENSORx&#39; is the problem - &#39;sensors.getAddress(EXT_SENSOR1, 0) does not check if the sensor whose address is in EXT_SENSOR1 is present. It finds the first sensor on the bus (i.e. at index 0) and stores its address in EXT_SENSOR1 thereby overwriting what you had initialized it to.&#39; That acutaully makes sense... They linked to code <a href="http://www.hacktronics.com/Tutorials/arduino-1-wire-tutorial.html">here</a> that they say does work that way - it looks largely identical to the Emon code, except for the lack of the &#39;sensors.getAddress(EXT_SENSOR1, 0)&#39;.</p>
<p>Later on, I&#39;ll load the sketch in tha tlink up into one of my Arduinos and see what I get from it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34178"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Wed, 16/09/2015 - 03:52.</div>
    <div class="content">
     <p>So I tried out the sketch in the linked article, and it worked 100%. With the proper addresses, it pulled readings from the proper sensors, and if I put in a bogus address, it gave me a failure for that snesor.</p>
<p>So it would seem the answer is to remove the following lines and work from ther eto get it to work:</p>
<p>EXT_SENSOR1_PRESENT = sensors.getAddress(EXT_SENSOR1, 0);<br />
EXT_SENSOR2_PRESENT = sensors.getAddress(EXT_SENSOR2, 1);</p>
<p>EXT_SENSOR1_PRESENT = EXT_SENSOR1_PRESENT ? EXT_SENSOR1_PRESENT : sensors.getAddress(EXT_SENSOR1, 1);<br />
EXT_SENSOR2_PRESENT = EXT_SENSOR2_PRESENT ? EXT_SENSOR2_PRESENT : sensors.getAddress(EXT_SENSOR2, 0);</p>
<p>The question there is how do we get it to detect the presence of the sensors? Or maybe we don&#39;t - for these purposes, personally, I&#39;m fine if we don&#39;t do a &#39;detect the sensors and adjust&#39; the way it&#39;s doing... If I say there are sensors 1, 2 &amp; 3 and it only finds 1 &amp; 3, I&#39;m fine with it continuing on and guiving no data...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34190"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 16/09/2015 - 12:58.</div>
    <div class="content">
     <p>What "they" were trying to do (I think) was to put the sensors in the same places in the array each time. I haven't studied the Dallas library in great detail, but from what I've managed to work out so far, the manufacturer's algorithm for searching addresses involves querying the bus with partial addresses and seeing what responds, and because of the way that addresses are transmitted, the addresses get recognised in "reverse order", i.e. as I think I said some way up this thread, they are recognised and sorted Least Significant Bit first. So when written MSB first, the addresses appear to be in random order when in fact they're not, and given the correct sorting algorithm, the order can be predicted. I don't see anything in that sketch (the one that uses getAddress) that will prevent the order changing when a sensor fails to respond. So your hard-coded addresses and getAddress( ) commented out does what you want.</p>
<p>What might work for you is (quote from DallasTemperature.cpp): </p>
<p>// attempt to determine if the device at the given address is connected to the bus<br />
bool DallasTemperature::isConnected(uint8_t* deviceAddress)</p>
<p>I assume it returns true if the sensor is connected. You could try</p>
<p>if (sensors.isConnected(EXT_SENSOR1))<br />
{<br />
&nbsp;Serial.println("Sensor 1 present");<br />
&nbsp;// and/or whatever you want in here to read the temperature and send it<br />
}<br />
else<br />
{<br />
&nbsp;Serial.println("Sensor 1 not found");<br />
&nbsp;// and/or send an identifiable invalid value<br />
}</p>
<p>or something like that, either to tell you or to send a recognisable invalid value that you can deal with as you want.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34221"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTH & DS18b20's</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Thu, 17/09/2015 - 01:48.</div>
    <div class="content">
     <p>I think I got it.... With the attached sketch, I get the following:</p>
<p>01<br />
emonTH - Firmware V1.6.1<br />
OpenEnergyMonitor.org<br />
RFM69CW Init&gt;<br />
Node: 20 Freq: 433Mhz Network: 210<br />
&uuml;TW&Ouml;&Ntilde;&bull;&lsquo;DHT22 temp &amp; humidity sensor<br />
Unable to find address for DS18B20 External 1... check hard coded address<br />
Unable to find address for DS18B20 External 2... check hard coded address<br />
Unable to find address for DS18B20 External 3... check hard coded address<br />
emonTH payload:<br />
&nbsp; Battery voltage: 0.00V<br />
&nbsp; External sensor 1: 23.80C<br />
&nbsp; External sensor 2: 24.20C<br />
&nbsp; External sensor 3: 23.70C<br />
&nbsp; Internal DHT22 temperature: 24.00C, Humidity: 41.90%</p>
<p>emonTH payload:<br />
&nbsp; Battery voltage: 0.00V<br />
&nbsp; External sensor 1: 23.80C<br />
&nbsp; External sensor 2: 30.00C<br />
&nbsp; External sensor 3: 23.70C<br />
&nbsp; Internal DHT22 temperature: 24.00C, Humidity: 41.60%</p>
<p>And it&#39;s sending the valid data over to EmonCMS. I&#39;ll have to do a little more experimentation, but it seems to be working right.</p>
<p>Oddly, with the check for address in the beginning, with the valid addresses, it says it can&#39;t find it, but with an INVALID address, it says it found the sensor. But the expected sensors are respinding. When I put in an invalid address, that sensor in the list reads &#39;0&#39;. I had moved the &#39;setResolution&#39; up into &#39;void setup&#39; as it is in that other tutorial, but I was getting &#39;85&#39; from all three DS18b20&#39;s, which I believe has somethign to do with powerup. I moved the &#39;setResolution&#39; back down into the &#39;void take_ds18b20_reading&#39; section and it then returned valid values.</p>
<p>The sketch is a filthy train wreck, in need of much cleaning, but it seems to be working. It might be nice to get the search in the beginning working, but honestly, it it can&#39;t be done with the way the hardcoding is set up, I can certainly live with that.</p>
<p>&nbsp;</p>
<p>Edit: After a little testing, the addressing is definitely working. I took three different temperatures of water (Hot, warm, cold) and dropped one of each of the three probes in each one (1 in hot, 2 in warm, 3 in cold) and then moved which external sensor was each address and the readings moved around as expected.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11231"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-F06--XkAelMKj-jTbsKbyXLoLseRdPOJsXANQF1girY" value="form-F06--XkAelMKj-jTbsKbyXLoLseRdPOJsXANQF1girY"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
