<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/3759 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:28:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Adjustable gain monitoring | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Adjustable gain monitoring</h3>
        <span class="submitted">Submitted by <a href="../user/3870.html" title="View user profile.">arnoldh</a> on Sun, 02/02/2014 - 17:45</span>
        <div class="content"><p>Some time ago Glyn posted a note on <a href="http://openenergymonitor.blogspot.co.uk/2012/06/high-accuracy-current-measurement-over.html">High Accuracy Current Measurement Over a Wide Range</a> using adjustable gain to improve measurement resolution at low currents. I can&#39;t find any further references to this.</p>
<p>
	My free running&nbsp;EmonTx based monitor is getting better than 0.5% accuracy relative to the utility meter. I&#39;m fairly pleased with this, but would like to improve the accuracy when current measured drops to a low value.</p>
<p>
	I&#39;ve been considering adding variable gain to my monitor, but I&#39;m not clear about how well it would work in practice, particularly as I&#39;ll be using a burst fire PV controller.</p>
<p>
	The adjustable gain design in the above note is based on an ATmel Application Note. The Atmel firmware appears to wait about 100 samples before switching the gain. In my case this would be after about 2 cycles. If a burst fire controller is switching current on and off every few cycles this would not appear to work. But maybe I&#39;ve misunderstood how the adjustable gain modification would operate.</p>
<p>Has any anyone done anything further on adjustable gain in&nbsp;EmonTx?</p>
  <div class="forum-topic-navigation clear-block">
          <a href="3769.html" class="topic-previous" title="Go to previous forum topic">‹ Placement of AC-AC adapter</a>
              <a href="3753.html" class="topic-next" title="Go to next forum topic">Encapsulated DS18B20 temperature sensor + emonTx V3 ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-18131"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adjustable gain monitoring</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 03/02/2014 - 01:42.</div>
    <div class="content">
     <p>You could try looking through the blog posts, but I think I read that the project has been dropped. I can see what you mean about a measurement delay. I haven&#39;t studied the software in that much detail so I can&#39;t confirm that. But it sounds reasonable for normal purposes, if not for you. You cannot know what gain you will need until the cycle has hit a peak one way or the other, but maybe you could risk switching after only 13 samples if you know where the zero crossings are, and start counting then (just a thought).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18137"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3870.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arnoldh&#039;s picture" title="arnoldh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adjustable gain monitoring</h3>

    <div class="submitted">Submitted by <a href="../user/3870.html" title="View user profile.">arnoldh</a> on Mon, 03/02/2014 - 09:40.</div>
    <div class="content">
     <p>Good to know I&#39;m thinking along the right lines. I couldn&#39;t find any blog posts, but I might have missed one.</p>
<p>The kind of problem I envisage is this. It&#39;s summer and there&#39;s little power being used, apart from what&#39;s being diverted from the solar PV to the immerser. The burst fire controller has switched off the heater and the monitor is sampling current using the highest gain. The controller switches on and the ADC goes off scale. By the time a lower gain has been selected and things have settled there have been a lot of far too low current readings. Then the controller switches the current off.....</p>
<p>My suspicion is that I&#39;d get worse accuracy with variable gain than without.</p>
<p>What puzzles me is that the&nbsp;<a href="http://www.atmel.com/Images/Atmel-2566-Single-Phase-Power-Energy-Meter-with-Tamper-Detection_Ap-Notes_AVR465.pdf">Atmel&nbsp;Application Note</a>&nbsp;is dated August 2013 and there&#39;s no mention of problems with burst fire controllers. This is why I thought I must be misunderstanding how the variable gain mode operates.</p>
<p>I could try using zero crossing points to be a bit smarter, but I&#39;m not currently using these. As the sampling is free running, I decided it was better not to make assumptions about the shape of the waveform.</p>
<p>Actually it&#39;s maybe not as bad as I&#39;ve made out. If there&#39;s very little current being used in the house apart from the immerser, the burst fire controller would not need be active, and the immersion thermostat would be controlling the heater.</p>
<p>All the same, I think I will give variable gain a miss. But if anyone has used it successfully with a PV controller, I&#39;d be interested to know.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18146"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adjustable gain monitoring</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 03/02/2014 - 13:08.</div>
    <div class="content">
     <p>Hmm. The only difference between the thermostat and the triac is one switches more frequently, and the other switches at a random point!</p>
<p>The other thing you need to consider is how big are the gain steps? You&#39;re assuming that the dump load will always take the input off-scale. That might be right but I think it doesn&#39;t need to be. If the gain is set so that adequate resolution is obtained, rather than maximum resolution, then if the steps are the right size you might have enough range left to still be inside full-scale when the dump load comes on. I suggest you look carefully at their control algorithm and the gain steps, because in the back of my mind I&#39;ve got the feeling that I looked at this and it had been thought about.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18150"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3870.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arnoldh&#039;s picture" title="arnoldh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adjustable gain monitoring</h3>

    <div class="submitted">Submitted by <a href="../user/3870.html" title="View user profile.">arnoldh</a> on Mon, 03/02/2014 - 19:35.</div>
    <div class="content">
     <p>You&#39;re correct about the gain steps. I found the Atmel sources and the firmware does limit the gain thresholds. The algorithm does not take the all or nothing approach I was implying. I confess I hadn&#39;t found the code before. I&#39;d just used the documentation.</p>
<p>Isn&#39;t the difference between using the thermostat and the&nbsp;triac&nbsp;that the switching period of the thermostat is of the order of minutes or tens of seconds, but for the triac&nbsp;it&#39;s of the order of cycles?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18156"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adjustable gain monitoring</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 03/02/2014 - 22:14.</div>
    <div class="content">
     <p>The triac switching frequency depends on your algorithm of course, and that in turn depends on your meter and the way you are charged for energy. Here in the UK, meters tend to have an energy packet size of 3600 J - meaning that when the energy taken crosses that threshold, a unit of charge is applied. Inside that packet, energy can shuttle back and forth without charge (see the meters page in BB). So if you allow the dump load to be on until a nett 3599 J has been consumed, and then you export energy until the same 3599 J has been returned, there is no charge. Of course, in practice you allow a guard band at each end; but even so, in the case of Robin&#39;s anti-flicker sketches, the switching frequency is seconds, not cycles. It is still mush faster than the thermostat though, which will be minutes or possibly tens of minutes.</p>
<p>What you&#39;re getting at is the error (given that the monitor saturates) is proportional to the time it spends saturated out of the total.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18167"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5455.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="keduro&#039;s picture" title="keduro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Adjustable gain monitoring</h3>

    <div class="submitted">Submitted by <a href="../user/5455.html" title="View user profile.">keduro</a> on Tue, 04/02/2014 - 21:01.</div>
    <div class="content">
     <p><strong>arnnoldh </strong>re &quot;But if anyone has used it successfully with a PV controller, I&#39;d be interested to know.&quot; .... yes, I have successfully used variable gain in my PV controller!</p>
<p>For the variable gain I used the same hardware design as given in the <a href="http://www.atmel.com/Images/doc2566.pdf">Atmel app-note</a>&nbsp;the only difference is that my op-amp feedback resistance (R2) is 500 kohm (2 x 1Mohm in parallel).</p>
<p>The gain is determined for each mains cycle based on the average current measured in the previous mains cycle, so reacts quickly.</p>
<p>The diverter has been running now for well over a year.&nbsp;The design was based heavily on <a href="841.html">Robin&#39;s&nbsp;Mk2 </a>and <a href="1002.html">Stuart&#39;s&nbsp;&nbsp;interrupt driven modifications</a>. It uses burst mode firing driving two external solid state relays. Never had any flicker problems, but then we only have one neighbour on the same phase and next nearest neighbours are some way away. Some features of the diverter:</p>
<ol>
<li>
		built starting with ATMega328PU chip (i.e. DIY Arduino)</li>
<li>
		single phase monitoring</li>
<li>
		variable gain on the current measurement</li>
<li>
		drives two separate dump loads using solid state relays - can dump to neither, to the first, to the second, or to both (dumps to second when energy in energy bucket continues to rise)</li>
<li>
		incorporates a Real Time Clock to allow daily tracking of energy</li>
<li>
		tracks total energy exported, imported, and dumped</li>
<li>
		two line LCD showing in turn &#39;instantaneous&#39; power usage, energy imported, energy exported, energy dumped</li>
<li>
		saves configuration parameters in EEPROM (phase calibration, power calibration, safety margin, and SSR firing delay)</li>
<li>
		command line based interface through USB connection - allows updating of configuration parameters, setting of date/time, capture and subsequent tabulating/charting of samples over a mains cycle, continuous monitoring of key values</li>
</ol>
<p>I have attached the sketch for anyone with an interest - it is pretty well commented throughout. I have used floats extensively for readability, rather than converting all code to run using integer arithmetic.Compiled code takes up almost 23kb of the 30kb of available program memory. Only just runs within the 2kb of SRAM - learned the hard way that things go real strange when you run out! (addressed through use of F(&#39;string&#39;) to put constant strings into program memory).</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/3759"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-0Hhne7IrgvjudlJElzQjE6pTN6SzLHN7vrb26Dd2O3A" value="form-0Hhne7IrgvjudlJElzQjE6pTN6SzLHN7vrb26Dd2O3A"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
