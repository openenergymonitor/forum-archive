<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1585 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:26:06 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Wireless Pulse Module | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Wireless Pulse Module</h3>
        <span class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Fri, 07/12/2012 - 11:13</span>
        <div class="content"><p>I want to connect my domestic gas meter to emonCMS.</p>
<p>The plan is to use my Raspberry PI or Nanode as the base station and make my own pulse module board.</p>
<p>I&#39;m just waiting back on a price for the pulse module (IN-Z62) that fits my meter.&nbsp; Looking at the datasheet its just a reed switch but as usual they don&#39;t tell you what one pulse equals!</p>
<p>I want to make it easier to set the address so I am thinking of adding a DIP switch to set the address of the node rather than having to reprogram.</p>
<p>So far I have come up with the following schematic.&nbsp; This is my first time using Eagle and I am a novice to electronics so bear with me.</p>
<p><a href="../../../dl.dropboxusercontent.com/u/77986082/Wireless%20Pulse%20Module.html">Schematic</a></p>
<p><img alt="" src="../../../dl.dropboxusercontent.com/u/77986082/Wireless%20Pulse%20Module.html" style="width: 686px; height: 500px;" /></p>
<p>Would this work, am I on the right track?</p>
  <div class="forum-topic-navigation clear-block">
          <a href="1615.html" class="topic-previous" title="Go to previous forum topic">‹ RESOLVED - EmonGLCD not restarting via USB power</a>
              <a href="2066.html" class="topic-next" title="Go to next forum topic">How to control the LED on an emonTx ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-8029"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Fri, 07/12/2012 - 12:25.</div>
    <div class="content">
     <p>I think you are going to have shock when you find out the price!</p>
<p><a href="http://www.plumbcenter.co.uk/en/heating-parts/energy-parts/elster-jeavons-in-z61-meter-pulse-unit-lead-88229" title="http://www.plumbcenter.co.uk/en/heating-parts/energy-parts/elster-jeavons-in-z61-meter-pulse-unit-lead-88229">http://www.plumbcenter.co.uk/en/heating-parts/energy-parts/elster-jeavon...</a></p>
<p>I&#39;m trying (trying being the right word!) to do a similar thing.</p>
<p>Rather than purchase the kit I&#39;m just using a reed switch stuck in the same place as the unit would fit with some blutak.</p>
<p>The reed switch is actuated by a magnet on the smallest dial of your gas meter which in my case, 1 rotation equates to 0.01m3.</p>
<p>I have a cobbled together arduino sketch that has an interrupt function that get triggered on the change of state.&nbsp;</p>
<p>Where I am struggling is with the bounce on the circuit triggering false counts so now I&#39;m reading up about debounce circuits!</p>
<p>&nbsp;</p>
<p>Given you are going to have a sketch on your controller to format the data and eventually broadcast something, I don&#39;t understand why you would want to manually then change the node?</p>
<p>&nbsp;</p>
<p>Hope the above was useful, I&#39;d be very interested in keeping track of how you get on.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8030"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/349.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-349.jpg" alt="EnergyRnR&#039;s picture" title="EnergyRnR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/349.html" title="View user profile.">EnergyRnR</a> on Fri, 07/12/2012 - 12:34.</div>
    <div class="content">
     <p>guys,</p>
<p>&nbsp;I got mine from&nbsp;<a href="http://www.utilitymeterswarehouse.com/gas-meters/gas-accessories/pulse-blocks/pulse-block-for-elster-jeavons-u6-u160.html/">http://www.utilitymeterswarehouse.com/gas-meters/gas-accessories/pulse-blocks/pulse-block-for-elster-jeavons-u6-u160.html/</a>&nbsp;last Aug. Their site appears to be down at the moment but it cost &pound;34, which included &pound;8 for shipping to Ireland.... might be worth checking.... snippet of invoice attached fyi.</p>
<p>Eamonn</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8032"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Fri, 07/12/2012 - 13:42.</div>
    <div class="content">
     <p>The reason for the addressing was that I was trying to figure out an easier way of deploying a node without the need for programming each one individually.</p>
<p>In a house with one gas meter, not a major issue but in a building with multiple gas, water and electricity meters.&nbsp; It would be easier to set the address on a switch and have an easy way of setting the pulse multiplier for each one from one place.</p>
<p>I haven&#39;t quite thought through the whole data processing scenario fully but instead of doing the calcs at the meter, could it be done at the web interface?</p>
<p>I hadn&#39;t thought of de-bouncing, I&#39;m glad you brought it up.</p>
<p>Thanks for the link for the pulse module.&nbsp; I would prefer a nice clean connection rather than have British Gas freak out when they see something blu-tack&#39;d to the meter.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8034"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Fri, 07/12/2012 - 14:58.</div>
    <div class="content">
     <p>You might also want to take a look at <a href="https://www.flukso.net/content/gas-probe" title="https://www.flukso.net/content/gas-probe">https://www.flukso.net/content/gas-probe</a> if it fits your meter. As you can see its recessed in a hollow underneath the dial. Is your idea that the dip switches control the nodeID that the RfM12 is broadcasting on?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8035"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Fri, 07/12/2012 - 15:54.</div>
    <div class="content">
     <p>That doesn&#39;t look a bad solution, thanks.&nbsp; Still waiting back for prices though but have found everywhere else I have looked to be around &pound;33 so not holding out much hope.</p>
<p>Yes my idea was to use the dip switches to control the nodeID.</p>
<p>Five switches gives you 0 - 31 addressing (note: you wouldn&#39;t be able to use address 0 or 31 see <a href="https://learn.openenergymonitor.org/?redirect=rfm12b2">here</a>)</p>
<p>How are you going about your debouncing, hardware or software?</p>
<p>I have found a stripped down circuit of a digital input from a commercial controller if that&#39;s any help to you.</p>
<p><img alt="" src="../../../dl.dropboxusercontent.com/u/77986082/Digital%20Input.html" /></p>
<p>Note that this circuit accepts 24v~ as well as logic input.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8041"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Fri, 07/12/2012 - 20:07.</div>
    <div class="content">
     <p>My plan is to do try to debounce using hardware as I want to keep the interrupt loop as simple as possible.</p>
<p>I&#39;m planning to do this via a 555 switch IC.&nbsp;</p>
<p>But I&#39;m far more at home in software than a hardware so it&#39;s slow going as I learn from my mistakes.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8046"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Fri, 07/12/2012 - 23:17.</div>
    <div class="content">
     <p>Although I&#39;m more electrical than electronic I feel more at home with the hardware than the software.&nbsp; Good news as we can try and help each other!</p>
<p>I think I may have found a more elegant solution to your 555 switch.</p>
<p><a href="http://uk.rs-online.com/web/p/bounce-eliminator-circuits/7326848/">Switch Debouncer.</a></p>
<p>I will revise the circuit over the weekend and post back a schematic.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8049"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sat, 08/12/2012 - 08:41.</div>
    <div class="content">
     <p>Surely it&#39;s trivial to debounce in software? Once you detect a change you simply ignore all further changes for a period slightly longer than maximum bounce time.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8082"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Mon, 10/12/2012 - 09:27.</div>
    <div class="content">
     <p>Considering the node needs to be powered by battery what would be the most power efficient method?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8137"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Wed, 12/12/2012 - 21:22.</div>
    <div class="content">
     <p>MartinR&nbsp;- the reason I plan to use hardware is purely because I&#39;m trying to improve my understanding&nbsp;of electronics.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8676"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Sun, 23/12/2012 - 22:53.</div>
    <div class="content">
     <p>ukmoose, the Hall effect sensor does not have the bouncing issue, and as far as I understand (not tried yet) it is usable plug-n-play on the pulse input of the TX.</p>
<p>What are the pros for a reed switch ? Power consumption ?</p>
<p>Or are you using this out of fun/interest/... ?</p>
<p>(Don&#39;t think I believe I know better, I&#39;m really asking.)</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9026"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Thu, 10/01/2013 - 17:04.</div>
    <div class="content">
     <p>I don&#39;t think there is a way to de-bounce in software if you are using interrupts from what I can tell.&nbsp; I may be wrong though.</p>
<p>There are no pro&#39;s to using a reed switch but I want the module to be robust to be used for any digital input, hence the hardware de-bouncing.&nbsp; Its also handy to test manually if something is working if you can just manually create a pulse across the connection terminals.</p>
<p>I would ideally like the pulse module to wakeup on a pulse, send the recorded pulse and go back to sleep if there are no more pulses for a given time period.</p>
<p>I&#39;m still waiting for the sensor from Flukso to fit on the gas meter but initial tests using a piece of wire across an input result in horrific bounce.</p>
<p>I have a MAX6816 but being so naive I had no idea it was so small.&nbsp; Until a SOT143 breakout board arrives for me to &#39;attempt&#39; to solder it to, I can&#39;t test it.</p>
<p>Another option I have seen uses a capacitor and inverting smitt trigger.&nbsp; <a href="http://www.youtube.com/watch?v=CRJUdf5TTQQ">http://www.youtube.com/watch?v=CRJUdf5TTQQ</a></p>
<p>I have managed to add some code for the nodeID DIP switch to <span rel="author">Trystan</span>&#39;s emonTX_Pulse firmware sketch but I have not fully got my head around what all the rest of code does.&nbsp; I&#39;m completely out of my depth but learning a great deal as I go.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11591"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 25/04/2013 - 09:00.</div>
    <div class="content">
     <p><em>I don&#39;t think there is a way to de-bounce in software if you are using interrupts from what I can tell.&nbsp; I may be wrong though.</em></p>
<p>Wouldn&#39;t you just set a flag, and only proclaim a change-of-state if the flag is still set after a certain period has elapsed?&nbsp; That&#39;s essentially what the hardware equivalent is doing.&nbsp; By waiting until a capacitor has charged up, any rapid transitions are filtered out.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11593"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Thu, 25/04/2013 - 09:16.</div>
    <div class="content">
     <p><em>I don&#39;t think there is a way to de-bounce in software if you are using interrupts from what I can tell.&nbsp; I may be wrong though.</em></p>
<p>This depends a bit on your software architecture. One easy way is to just do a small (e.g. 10ms) delay inside the IRQ and read the stabilized value of the input a second time. Reed contacts are usually bouncing really fast (if at all), so a smaller delay should also work then.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11715"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Mon, 29/04/2013 - 23:44.</div>
    <div class="content">
     <p>I&#39;m afraid it is not that simple because <a href="http://www.engblaze.com/we-interrupt-this-program-to-bring-you-a-tutorial-on-arduino-interrupts/">delay() won&rsquo;t work within an ISR</a>. I&#39;m surprised I didn&#39;t find another source about this.</p>
<p>For instance, here is an example of an interrupt handler with a delay:</p>
<pre>
void countP()
{
    delay(10);
    if (digitalRead(3) == LOW){
      // Debounced interrupt action
      count++;
      Serial.println (count);
    }
}</pre><p>This does not work, apparently.</p>
<p>It can work if the debouncing is done in the main loop :</p>
<pre>
boolean interrupt_received = false;

void setup()
{

  // Setup pulse counting interrupt
  pinMode(3, INPUT);       // set interrupt0 (pin3) as input
  digitalWrite(3, HIGH);   // and enable it&#39;s internal pull-up resistor
  attachInterrupt(1, countP, FALLING);  // device signals a low when active
  delay(100);

  // Setup serial link
  Serial.begin(57600);
  Serial.println (&quot;Start&quot;);   // signal initialization done
}

void loop()
{
  static unsigned long count = 0;

  // Software debounce (10 ms)
  if (interrupt_received == true){
    delay(10);
    if (digitalRead(3) == LOW){
      // Debounced interrupt action
      count++;
      Serial.println (count);
    }
    interrupt_received = false;
  }
}

void countP()
{
  interrupt_received = true;
}
</pre><p>But then, issues arise if one wants to add a delay() in the main loop.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11718"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 30/04/2013 - 00:02.</div>
    <div class="content">
     <p>Isn&#39;t the technique to disable this interrupt for a short while?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11721"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Tue, 30/04/2013 - 06:40.</div>
    <div class="content">
     <p>I&#39;ve been thinking, the need for a delay in the main loop can be addressed with millis().</p>
<p>Still, it is not ideal. If the loop happened to last too long (sending over serial, or worse, over internet), we could reach a point where the Reed is open again. Perhaps this can be addressed with millis() as well. And perhaps we could consider it won&#39;t happen because the wheel does not run that fast.</p>
<p>Another way would be to add in the ISR handler a long task, such as writing on the serial port. A task for which we would know it will take a minimum amount of time. This is generally considered as bad practice.</p>
<p>Disabling the interrupt while debouncing would look nicer. Yet, I don&#39;t think it solves this specific issue. Say we disable the interrupt in its own handler. Then, in the debounce code, after incrementing the counter, we enable it again. We still don&#39;t have perfect control on the debounce delay. It could be much higher than we want it if the loop takes too much time to execute. Or did I miss something ?</p>
<p>The answer may well be that in our case the Reed is closed so long we can&#39;t miss it. One could try to know that with a test code that would print time on both falling and raising edge, and run the meter full speed (open all taps, force boiler and all gas appliances full charge, perhaps not that easy but you get the point, and you can use a great security margin, it&#39;s just about having an order of magnitude). Or more theoretically, figure out the max power of the house appliances, which leads to the maximum wheel speed.</p>
<p>Or perhaps a hardware debounce is simpler after all...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11726"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 30/04/2013 - 08:38.</div>
    <div class="content">
     <p>If you can find the specs for your meter, it should have a maxium flow rate. &nbsp;From there you should be able to work out the minimum pulses you&#39;ll see. &nbsp;For example, with my Elster water meter running at max flow rate (nothing I&#39;ve ever come close to doing) I should see a &#39;1&#39; (switch open) for at least&nbsp;685 msecs and a &#39;0&#39; (switch closed) for at least&nbsp;1600 msecs.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11728"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Tue, 30/04/2013 - 09:10.</div>
    <div class="content">
     <p>Good point, dBC. My gas meter ranges up to 6 m3/h and generates a 0.01 m3 pulse, that is a maximum of one pulse every 6 seconds.</p>
<p>I don&#39;t know how long the switch remains open, though, and I suppose it depends on its sensitivity, its distance to the meter, the way it is fixed, magnetic perturbations, and all.</p>
<p>One approach could be to disable the interrupt for 3 seconds so we won&#39;t trigger on a release bounce and assume the loop() won&#39;t be stuck more than 2 seconds more so we won&#39;t miss the next pulse. This is simple and should work but inelegantly depends on the meter&#39;s max cycle if the order of magnitude is quite different on other meters.</p>
<p>BTW, with the Reed I&#39;ve been trying, I saw closing bouncing (about 4 pulses) but no opening bouncing. Dealing with only closing bouncing is even easier but just because I didn&#39;t see it happening, does not mean it is not possible.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11730"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 30/04/2013 - 09:37.</div>
    <div class="content">
     <p><em>that is a maximum of one pulse every 6 seconds.</em></p>
<p>That sounds comfortable enough that you should easily be able to nail it in software. &nbsp;I don&#39;t see any need to disable interrupts. &nbsp;Just have the ISR set a boolean flag to say it occurred. &nbsp;Then your main loop can check the flag every 6 seconds and see if it is set. &nbsp;If it is, clear it, and count the pulse. &nbsp; OK... maybe every 4 or 5 seconds if you want to make sure you don&#39;t miss 2 back-to-back pulses.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11731"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Tue, 30/04/2013 - 09:42.</div>
    <div class="content">
     <p>I don&#39;t think this is absolutely safe. Consider a single pulse. If the bouncing occurs precisely around a check (really unlikely, I admit), the flag is cleared between two bounces and the pulse is counted twice.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11732"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Wireless Pulse Module</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 30/04/2013 - 10:06.</div>
    <div class="content">
     <p>Good point. &nbsp;In that case make the &quot;boolean flag&quot; a timestamp.</p>
<p>Check the timestamp in the main loop every 2 seconds (say). &nbsp;If it&#39;s zero or &lt; 100 msecs ago, ignore it.</p>
<p>Otherwise clear it, and count it as a pulse.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1585"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-nKv75uNxixVa2-9aPH8DQ2VvN-c89KBgRU0vT1_bPZg" value="form-nKv75uNxixVa2-9aPH8DQ2VvN-c89KBgRU0vT1_bPZg"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
