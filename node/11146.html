<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11146 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:30:00 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonTX &amp; Multiple DS18B20 | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonTX &amp; Multiple DS18B20</h3>
        <span class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Fri, 21/08/2015 - 03:38</span>
        <div class="content"><p>After reading around, I got my EmonTX reading multiple DS18B20 sensors. When I first connected two, it read real funky, like double the proper value. That may have had something to do with one being on the screw terminals and the other on the RJ45. I put both probes on the RJ45 and now, finally, have two proper temperature readings. The problem is, they are auto detected, so on a reboot, it&#39;s entirely possible that the sensors could swap positions depending on which one answers first. From reading, I know it&#39;s possible to specify &#39;Temp1&#39; is sensor &#39;x&#39;, &#39;Temp2&#39; is sensor &#39;y&#39; and so on, but I have not found anything that makes sense with regards to setting an EmonTX 3.4 running firmware 1.8 to register specific addresses as specific sensors.</p>
<p>Does anyone have a EmonTX v3.4 sketch that is set up and working with multiple DS18B20 sensors that are explicitly addressed?</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11244.html" class="topic-previous" title="Go to previous forum topic">‹ enphase monitoring</a>
              <a href="11230.html" class="topic-next" title="Go to next forum topic">EmonPi | Raspberry won&#039;t start. What to check... ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-33492"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 21/08/2015 - 12:06.</div>
    <div class="content">
     <p>Probably not, but you could connect each sensor in turn and run the &quot;temperature_search&quot; sketch that queries its address, then steal the code from the emonTx V2 &quot;emontx_temperature_power&quot; sketch that addresses the sensors individually, and graft it into the V3.4 sketch.</p>
<p>(Both in&nbsp;emonTxFirmware/emonTxV2/emonTx_temperature_examples on GitHub)</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33494"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Fri, 21/08/2015 - 12:47.</div>
    <div class="content">
     <p>I have the addresses - I found a sketch out on the internet and loaded it onto an Uno and got the addresses of the two sensors I now have connected to the TX. The problem is making it work on the TX. I already looked at the sketch you referenced, but I have no idea how to make that work with the 3.4. The code is way different.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33495"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 21/08/2015 - 13:37.</div>
    <div class="content">
     <p>Way different? Really?&nbsp;</p>
<p>First, add the array defining&nbsp;the addresses of your two sensors.<br />
Next, look at the &#39;if&#39; block controlled by &quot;if (DS18B20_STATUS==1)&quot;<br />
In there, all you need is to take out the line &quot;float temp=....&quot; and&nbsp;include in its place</p>
<p>&nbsp;&nbsp;emontx.temp[0]&nbsp;= sensors.getTempC(address_T1) * 10;<br />
&nbsp; emontx.temp[1]&nbsp;= sensors.getTempC(address_T2) * 10;</p>
<p>You can include the bounds check on each if you wish. I haven&#39;t tested that (on account of not having two sensors) but I think it&#39;s OK.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33497"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Fri, 21/08/2015 - 22:30.</div>
    <div class="content">
     <p>You&#39;re talking with someone who&#39;s a complete moron when it comes to coding. I&#39;ve been trying to learn Arduino for a while, but I just haven&#39;t &#39;caught on&#39;. If it&#39;s clearly spelled out, I can handle it, but unless we&#39;re talking about real small changes, I&#39;m pretty much lost.</p>
<p>To me, the code in the EmonTXv2 and v3 look WAY different....</p>
<p>I&#39;ll give it a shot, but I have my doubts that I&#39;ll do it right...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33499"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 21/08/2015 - 23:17.</div>
    <div class="content">
     <p>I have no way of knowing what your level of knowledge is, so at first sight the two probably look a lot different. But when you look in detail, you'll see almost exactly the same thing in each.</p>
<p>In small steps then:</p>
<p>1.<br />
Find the array in the V2 sketch. You want the first 2 elements:<br />
&nbsp;DeviceAddress address_T1 = { 0x28, 0x22, 0x70, 0xEE, 0x02, 0x00, 0x00, 0xB8 };<br />
&nbsp;DeviceAddress address_T2 = { 0x28, 0x85, 0x7A, 0xEE, 0x02, 0x00, 0x00, 0xDC };<br />
Just above them is "DallasTemperature sensors(&amp;oneWire);" Find that in the V3.4 sketch and copy those lines to just beneath it.</p>
<p>2.<br />
What I wrote above is slightly wrong - the sketch on GitHub has been changed!</p>
<p>Go down to loop( ) in the V2 sketch, and to the 'if' block in the v3.4 sketch.<br />
Find "sensors.requestTemperatures();" in both.<br />
In the V2, see how the temperature is actually read: "sensors.getTempC(address_T1)" ?<br />
In the V3.4 sketch, can you see much the same thing, but it's inside a "for" loop getting <i>all</i> the sensors? The only difference there is in the V2, you have one sensor's address repeated 4 times, and in the V3.4, you have the sensors in turn but with the addresses that it picked up in setup( ). The actual reading is got by a function right at the bottom of the sketch, that also includes the range check. You can do the same range check similarly if you wish:</p>
<p>float temp=(sensors.getTempC(address_T1);<br />
  if ((temp<125.0) &amp;& (temp>-55.0)) emontx.temp[0] = temp * 10;<br />
temp=(sensors.getTempC(address_T2);<br />
  if ((temp<125.0) &amp;& (temp>-55.0)) emontx.temp[1] = temp * 10;</p>
<p>So instead of getting all the sensors in the loop, by replacing that line with 2 pairs of lines that specify the exact address of each sensor in turn, then check the result, you'll get the same sensor each time because its address is hard-coded. You put those two temperatures into a temporary variable, then if it's in-range, store the temperature &times; 10 into the temp[ ] array inside the emontx structure.</p>
<p>The other bits that might be worrying you are "digitalWrite(DS18B20_PWR, HIGH);" and the corresponding "digitalWrite(DS18B20_PWR, LOW);"  - those turn the power to the sensors on and off, and that wasn't done in the V2. "Sleepy" is to allow the sensor to stabilise, because it's not powered continuously now.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33500"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Fri, 21/08/2015 - 23:21.</div>
    <div class="content">
     <p>Ok - Made some changes... Added the following:</p>
<p>// By using direct addressing its possible to make sure that as you add temperature sensors<br />
// the temperature sensor to variable mapping will not change.<br />
// To find the addresses of your temperature sensors use the: **temperature_search sketch**<br />
DeviceAddress address_T1 = { 0x28, 0xFF, 0xD9, 0x47, 0x64, 0x14, 0x04, 0x0E };<br />
DeviceAddress address_T2 = { 0x28, 0xFF, 0x9F, 0x40, 0x64, 0x14, 0x04, 0xFD };[/code]</p>
<p>underneath</p>
<p>//Setup DS128B20<br />
OneWire oneWire(ONE_WIRE_BUS);<br />
DallasTemperature sensors(&amp;oneWire);<br />
byte allAddress [MaxOnewire][8];&nbsp; // 8 bytes per address<br />
byte numSensors;</p>
<p>&nbsp;</p>
<p>and removed &#39;&nbsp; float temp=(sensors.getTempC(allAddress[sensor]));&#39; and replaced it with</p>
<p>&nbsp; emontx.temp[0] = sensors.getTempC(address_T1) * 10;<br />
&nbsp; emontx.temp[1] = sensors.getTempC(address_T2) * 10;</p>
<p>When I compiled it, it failed due to the &#39;if&#39; line under it, so I commented that out and it compiled. When uploaded, according to the serial monitor, it detected both sensors, but was only reporting Sensor 1. Sensor 2 was reporting &#39;0&#39;. Uploaded the previous sketch and it was back to operating right.... so I obviously missed somthing....</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33503"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sat, 22/08/2015 - 02:09.</div>
    <div class="content">
     <p>I must be exceptionally dense lol. I attempted to follow your instructions (read through them several times and back and forth in bits and pieces along with going between the v2 and v3.4 sketches), and I still can only get it to report the first sensor. Below is the serial output with the attached script loaded. I tried a few different things, all with the same result. Obviously I&#39;m missing and/or misunderstanding something....</p>
<p>&nbsp;</p>
<blockquote><p>emonTx V3.4 Discrete Sampling V1.80 RFM69CW<br />
OpenEnergyMonitor.org<br />
POST.....wait 10s<br />
CT 1 Cal 66.05<br />
CT 2 Cal 65.70<br />
CT 3 Cal 88.10<br />
CT 4 Cal 16.30<br />
RMS Voltage on AC-AC&nbsp; is: ~249V<br />
AC-AC detected - Real Power measure enabled<br />
assuming pwr from AC-AC (jumper closed)<br />
USA mode active<br />
Vcal: 132.90<br />
Phase Shift: 1.70<br />
CT 1 detected<br />
CT 2 detected<br />
CT 3 detected<br />
CT 4 detected<br />
Detected Temp Sensors:&nbsp; 2<br />
RFM69CW<br />
Node: 10 Freq: 433Mhz Network: 210<br />
CT1 CT2 CT3 CT4 VRMS/BATT PULSE Temperature 1-2<br />
2724 1683 655 389 12197 10 276 0 &nbsp;<br />
2736 1682 652 389 12196 65 276 0 &nbsp;<br />
2738 1699 661 388 12202 120 276 0 &nbsp;<br />
2735 1731 663 381 12209 175 276 0 &nbsp;<br />
2741 1721 658 382 12209 230 276 0 &nbsp;<br />
2735 1705 660 385 12216 285 276 0 &nbsp;</p>
<p>&nbsp;</p>
</blockquote>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33520"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 22/08/2015 - 11:46.</div>
    <div class="content">
     <p>You've left the old 'read the sensors all together' line in:</p>
<p>&nbsp;for(byte j=0;j&lt;numSensors;j++) emontx.temp[j]=get_temperature(j); </p>
<p>so that's probably overwriting sensor T2.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33533"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sat, 22/08/2015 - 16:14.</div>
    <div class="content">
     <p>I might actually have finally gotten it...</p>
<p>I started off with commenting that line out, and it then was reporting values for two temp probes, but only two digits:</p>
<blockquote><p>CT1 CT2 CT3 CT4 VRMS/BATT PULSE Temperature 1-2<br />
1308 604 645 389 12154 2 22 18&nbsp;</p>
</blockquote>
<p>So that was reporting to EmonCMS as 2.2 &amp; 1.8. It would seem the &#39;float&#39; section at the end wasn&#39;t doing anything. So I changed the getTempC lines to read the following:</p>
<blockquote><p>emontx.temp[0] = sensors.getTempC(address_T1) * 10;<br />
emontx.temp[1] = sensors.getTempC(address_T2) * 10;</p>
</blockquote>
<p>Now it was reporting three digits and thus a more proper reading to EmonCMS, BUT..... the values wouldn&#39;t change... and turned out to be a bit off from actual. I held one of the probes in my hand and the value didn&#39;t fluctuate at all.</p>
<blockquote><p>CT1 CT2 CT3 CT4 VRMS/BATT PULSE Temperature 1-2<br />
1322 598 635 395 12217 2 222 185 &nbsp;<br />
1337 612 640 401 12173 3 222 185 &nbsp;<br />
1333 511 634 391 12172 4 222 185 &nbsp;<br />
1331 536 635 388 12207 5 222 185 &nbsp;<br />
1338 546 639 397 12216 6 222 185 &nbsp;<br />
1336 546 639 397 12171 10 222 185 &nbsp;<br />
1333 551 642 406 12210 11 222 185&nbsp;</p>
</blockquote>
<p>Loaded my original sketch back in and the probe reacted quickly to me holding it:</p>
<blockquote><p>CT1 CT2 CT3 CT4 VRMS/BATT PULSE Temperature 1-2<br />
1311 548 633 393 12146 2 297 182 &nbsp;<br />
1321 545 625 379 12156 3 295 182 &nbsp;<br />
1320 550 636 393 12142 4 293 182 &nbsp;<br />
1317 537 633 393 12184 6 310 182 &nbsp;</p>
</blockquote>
<p>I then un-commented out the &#39;sensors.requestTemperatures();&#39; (I forget why I had commented it out) and then it started returning better values, but still only two digits (I removed the &#39;* 10&#39; from the sensorsGetTemp line thinking maybe the lack of the &#39;requestTemperatures&#39; line somehow caused the float line to not work). So I added the * 10 back in and now I seem to be getting proper readings.</p>
<p>Does everything seem ok, and/or is there anything left hang around that might cause issues and should be cleaned up?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33535"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 22/08/2015 - 16:59.</div>
    <div class="content">
     <p>That looks OK - if it works, it works!</p>
<p>You won't get a warning (or a default value) if a sensor goes AWOL or a value that's clearly silly, but you can add that as you get the hang of programming.</p>
<p>If it's important to you to put that in now, then after you've got the temperature, you need to something like:</p>
<p>&nbsp;if ((emontx.temp[0] &gt; 125.0) || (emontx.temp[0] &lt; -30.0))<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;emontx.temp[0] = 300.0;</p>
<p>That will report the value fixed 300.0 if the temperature is greater than 125&deg; or less than 30&deg;. (And likewise for the second.)</p>
<p>[I was actually just starting to look at doing it a neater way, possibly using the non-volatile RAM to store the values indefinitely.]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33560"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sun, 23/08/2015 - 18:40.</div>
    <div class="content">
     <p>Well, it seems that there might be something wrong with my modifications to the sketch. About 12 hours ago, the TX stopped reporting. I just looked at my EmonCMS and noticed it. Checked TX and no led blinking. The reset button brought it back. Maybe its a fluke, but its been rock solid until this. We&#39;ll see if it happens again...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33629"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Wed, 26/08/2015 - 12:54.</div>
    <div class="content">
     <p>Well, it did it again. dropped off about 8 hours ago. Any ideas what might be causing it? I never had it drop off until i loaded this firmware modified for hardcoded sensors.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33639"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 26/08/2015 - 21:42.</div>
    <div class="content">
     <p>I did look at the sketch and I didn't spot anything out of place, how long does it run for after a reset before it stops reporting?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33642"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Wed, 26/08/2015 - 22:32.</div>
    <div class="content">
     <p>The first time it went just under 15 hours before going AWOL (Aug23 @ 11:05am to Aug 24 @ 1:48am). The second time was about 57 hours (Aug 23 @ 14:00 to Aug 25 @ 23:30). The varying timeframes seem odd, but prior to the sketch change, it had been up for 8 days, With the reason it went down prior being to test and calibrate the Wattcore CTs.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33643"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 26/08/2015 - 22:45.</div>
    <div class="content">
     <p>Not consistent then. I'd be inclined to drop a small delay, say 10 ms (or maybe more, I haven't got the time for a transmission in my head!), between the two getTemps, just in case it's trying to fire off the second request while the last data for the first is still coming in, and see if that helps.</p>
<p>I'll have another look at the sketch, but unless there's something deeply buried, I think it's OK.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33657"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Thu, 27/08/2015 - 22:10.</div>
    <div class="content">
     <p>I assume adding a delay between the readings would be accomplished bu adding &#39;delay(50);&#39;(where 50 in this example is 50ms, I assume?) between &#39;emontx.temp[0] = sensors.getTempC(address_T1) * 10;&#39; and &#39;emontx.temp[1] = sensors.getTempC(address_T2) * 10;&#39;?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33661"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 27/08/2015 - 23:32.</div>
    <div class="content">
     <p>Yes, that's correct. I don't know that it will work (and I can't investigate because as I mentioned before, I don't have 2 temperature sensors), but as the OneWire is a serial protocol, it's worth a try.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33676"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2292.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="jpm32526&#039;s picture" title="jpm32526&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/2292.html" title="View user profile.">jpm32526</a> on Fri, 28/08/2015 - 21:06.</div>
    <div class="content">
     <p>Hi Dave, this is what I came up with for my heat pump monitoring.&nbsp; It is based on the emontx.v2 code.</p>
<p>The data struct and DS18x20 Library Initilization code goes before setup(), and I think Emontx.v3 uses 5 for ONE_WIRE_BUS, you may need to change this, and as Robert suggested you need to copy the addresses of the DS devices and paste them into the DeviceAddress array.&nbsp; You can change the airIn/airOut names to better describe your sensor locations.</p>
<p>BTW, when you send the sensors.requestTemperatures() command, all devices on the buss immediately measure and store the temperature in their internal register, and the getTempC() command returns the addressed devices temperature it measured at the time it received the requestTemp command so it&#39;s best to send this immediately before the getTemp sequence unless you have a reason to defer.<br />
&nbsp;</p>
<pre>
//
//  -----[ Data Package Structure ]---------------------------------------
//
typedef struct {
  int T1;         // temperature sensor airIn
  int T2;         // temperature sensor airOut
  int T3;         // temperature sensor refIn
  int T4;         // temperature sensor refOut
  } Payload;  Payload emontx;       // plus whatever else needed in the data pkg

//
//  -----[ DS18x20 Library Initilization ]-------------------------------
//
#include &lt;OneWire.h&gt;
#include &lt;DallasTemperature.h&gt;

#define ONE_WIRE_BUS 4                    // Arduino D4; P1-DIO of the JeeNode layout
OneWire oneWire(ONE_WIRE_BUS);            // Setup a oneWire instance
DallasTemperature sensors(&amp;oneWire);      // Pass our oneWire reference to Dallas Temperature.

// By using direct addressing its possible to make sure that as you add temperature sensors
// the temperature sensor to variable mapping will not change.
// To find the addresses of your temperature sensors use the: **temperature_search sketch**
// This won&#39;t work until you use YOUR addresses......
DeviceAddress airIn   = { 0x28, 0x92, 0xBD, 0xEA, 0x05, 0x00, 0x00, 0x05 };
DeviceAddress airOut  = { 0x28, 0x25, 0xBA, 0xEA, 0x05, 0x00, 0x00, 0xD6 };
DeviceAddress refIn   = { 0x28, 0xEF, 0x7E, 0xEF, 0x02, 0x00, 0x00, 0x40 };
DeviceAddress refOut  = { 0x28, 0xDF, 0x6B, 0xEF, 0x02, 0x00, 0x00, 0x03 };
.....</pre><div>in...</div>
<div>
<pre>
void setup() {
  sensors.begin();

... and in ...
</pre></div>
<pre>
void loop()
{
  sensors.requestTemperatures();          // Send the command to get temperatures
  // use getTempC() for civilized locations
  emontx.T1 = sensors.getTempF(airIn)  * 100;
  emontx.T2 = sensors.getTempF(airOut) * 100;
  emontx.T3 = sensors.getTempF(refIn)  * 100;
  emontx.T4 = sensors.getTempF(refOut) * 100;
....</pre><p>My device has been up for a few months without failure, so hope this helps.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33677"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3208.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dominator99&#039;s picture" title="dominator99&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/3208.html" title="View user profile.">dominator99</a> on Fri, 28/08/2015 - 21:54.</div>
    <div class="content">
     <blockquote><p>....... I&#39;d be inclined to drop a small delay, say 10 ms (or maybe more, I haven&#39;t got the time for a transmission in my head!), between the two getTemps, just in case it&#39;s trying to fire off the second request while the last data for the first is still coming in.....</p>
</blockquote>
<p>&nbsp;</p>
<p>The delay between device reads needs to be chosen to suit DS18B20 resolution (9-bit = 93.75ms, 10-bit = 187.5ms, 11-bit = 375ms &amp; 12-bit = 750ms)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33679"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 28/08/2015 - 22:26.</div>
    <div class="content">
     <p>Thanks, Dominator. I see JPM doesn't include a delay - is it taken care of in the library so that getTemp doesn't return until the transmission is complete, or is there a danger that the bus hasn't settled when the next interrogation is sent? I'm inclined to think that the locking up is not related to having two sensors, but was worth a try. Can either of you see anything wrong with Dave's sketch, because I can't.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33680"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Sat, 29/08/2015 - 00:21.</div>
    <div class="content">
     <p>Thanks guys. unfortunately, it went on a walkabout again this afternoon.... So in teh interests in ruling things out, I&#39;ve loaded up the original unmolested sketch and I&#39;m going to run that for a while and see if the problem goes away or not.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33688"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8255.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="goodfidelity&#039;s picture" title="goodfidelity&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8255.html" title="View user profile.">goodfidelity</a> on Sat, 29/08/2015 - 16:00.</div>
    <div class="content">
     <p>I dont know anything about programming, and even less about Arduino.</p>
<p>But i have an idea about how to handle the multiple sensor issue if they keep getting mixed up when resetting the unit.</p>
<p>Since all Dallas sensors have a unique serial number, the code should be designed in such way that uploading sensor data to the emoncms should be done in a certain order of serial numbers for the sensors.</p>
<p>For example the lowest serial number first, and then rising.</p>
<p>&nbsp;</p>
<p>This way you don&#39;t need to write a special sketch with the ID of every sensor, the code in the emonTX will make sure that sensor data&nbsp;uploads in the same order every time.</p>
<p>If the serials in production are always produced with increasing serial number, this will make it very easy to sort out also if one unit needs to be changed due to technical problems. Just make sure the serials of the sensors are in the same numerical order as befor and the data in emoncms will be unchanged.</p>
<p>&nbsp;</p>
<p>This all works if the serials are in fact numbers and not letter, but probably you can sort them both by letter and by number anyways.</p>
<p>&nbsp;</p>
<p>Anyone knows if this will work?</p>
<p>&nbsp;</p>
<p>//J</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33691"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 29/08/2015 - 18:17.</div>
    <div class="content">
     <p>I've got a sketch that stores the serial numbers in EEPROM the first time it is used, thereafter it reads from EEPROM instead of checking the sensors. It's not a bullet-proof arrangement, I'm working on it. And I can see flaws in your idea too, Goodfidelity, when replacing a sensor. Sorting isn't good enough! It probably needs a merge of both your approach and mine. You need to check each one as it's detected and then insert the 'new replacement' in the place previously occupied by one that's now missing, or presumably at the end if it's genuinely 'new'.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33698"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8255.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="goodfidelity&#039;s picture" title="goodfidelity&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8255.html" title="View user profile.">goodfidelity</a> on Sun, 30/08/2015 - 10:02.</div>
    <div class="content">
     <p>I agree to your points Robert.</p>
<p>&nbsp;</p>
<p>The way i thought about it actually has some things that are required.</p>
<p>&nbsp;</p>
<p>- Serialnumbers of the sensors must be increasing in production phase. So that a new sensor won&#39;t have a lower number then old sensors.</p>
<p>- If a sensor is dead/defect, you might have to rearrange the sensors physically, when adding the new sensor. So that the order of the sensors are still the same physically on the point where you are &nbsp;measuring.&nbsp;</p>
<p>&nbsp;</p>
<p>This means that if you replace one sensor, you might have to move around all the other sensors in the house or what ever object you are measuring.</p>
<p>&nbsp;</p>
<p>Example:</p>
<p>&nbsp;</p>
<p>- #1 Kitchen</p>
<p>- #2 Living room</p>
<p>- #3 Garage</p>
<p>Now sensor number two fails, this menas a new sensor will come in with the serial number #4.</p>
<p>If you just swap it, it will be:</p>
<p>- #1 Kitchen</p>
<p>- #4 Living room</p>
<p>- #3 Garage</p>
<p>This will be reported wrong to the emoncms if the sketch is programmed the way i suggest. And it will mix up the livingroom with the garage.</p>
<p>So the sensors will have to be rearranged in this order for it to work:</p>
<p>- #1 Kitchen</p>
<p>- #3 Living room</p>
<p>- #4 Garage</p>
<p>This way it will still keep sorting the sensors in the correct order, and feeding the data to the correct feed in emoncms. It basically means putting the new sensor in the garage, and moving the garage sensor to the living room.</p>
<p>This is not a perfect idea, and i dont know anything about programming. To me the very best idea is to have multiple one wire ports on the board, and assign each port to a feed. And whatever you measure on this port with a one wire unit will be logged to the same feed in emoncms.</p>
<p>I dont&nbsp;know what will happen if a humiditysensor is swapped for a temperaturesensor, or how to handle that. But i really like the idea of having multiple ports on the board instead of using the same one wire bus for all of them.</p>
<p>My idea was just the first thing that came to mind. I am sure that a good programmer can handle this easier or more bullet proof.</p>
<p>//J</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33700"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 30/08/2015 - 11:40.</div>
    <div class="content">
     <p>Expanding on how I think your and my ideas merged would work using your example:</p>
<p>The program starts up and reads sensors 1, 2 &amp; 3 and places the serial numbers in EEPROM. Each time it starts up, it flags all the sensors as 'potentially missing', reads the numbers off the sensors and as they are found in EEPROM, it cancels the flag. If the sensor isn't in EEPROM, it's new.</p>
<p>Then, when all the sensors have been detected, if there's one missing and one new, it assigns the new serial number to the missing location. If there isn't a missing one, it adds it as no.4. If there are missing sensors but no new ones, we know there's a problem. The way around two or more failing simultaneously is to always use the lowest place first, so the replacement sensors have to be installed one at a time, first one first. So in your example, if both Kitchen &amp; Garage have failed, you <i>must</i> replace the kitchen one first (else they get swapped!). </p>
<p>The OneWire bus was invented for good reason. The problem with multiple OneWire buses is, apart from losing out on versatility, they cost I/O pins and connectors, and that's expensive as, on top of the raw cost of the connectors, it makes the pcb and the case larger and more expensive too.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33704"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/937.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Bramco&#039;s picture" title="Bramco&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/937.html" title="View user profile.">Bramco</a> on Sun, 30/08/2015 - 13:21.</div>
    <div class="content">
     <p>Guys,</p>
<p>I think you are making this more complicated than it needs to be.</p>
<p>I&#39;ve had 5 sensors on my heat bank for the last couple of years with no failures and only occasionally a mis-read (as far as I can tell only 2 or 3 times).</p>
<p>Given your sensors are in different rooms (in my case different places on the heat bank) they will show different temperatures. It is far easier to simply find out the addresses of the sensors on the 1 wire bus <em>during setup</em> and then read each of them in turn in the main loop using the addresses you found&nbsp;and send the temperature readings to emoncms.</p>
<p>In emoncms according to the temperatures reported you can easily work out which input is which. If there are 2 or more reporting similar temperatures, simply drop one of them in a glass of cold water. It will soon be obvious from the input page which one that is. Label it, say &#39;kitchen&#39; and move on to the next one. They don&#39;t change over time because the addresses of the sensors are unique and preset.</p>
<p>You don&#39;t need to preset the addresses of the sensors in the code. And in the case of a failure, all you have to do is just replace the sensor, the code will automatically pick up the new sensor if you restart the emonTx or whatever you are running the code on. If there is any change in the order in which they are found on the bus then you simply change the inputs in emoncms to make sure they are named correctly again.</p>
<p>Here are some snippets of code.</p>
<p>// DS18B20 sensor data&nbsp;<br />
#define MAXSENSORS 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// maximum number of sensors on the one wire bus<br />
byte DS18B20Address [MAXSENSORS][8]; &nbsp;// 8 bytes per address<br />
float temperatures [MAXSENSORS]; &nbsp; &nbsp; &nbsp;// latest temperature readings<br />
int numTempSensors; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // number of sensors detected &nbsp; &nbsp;<br />
int nextTempSensor; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // used to work out which sensor to read next - read one every main loop</p>
<p>&nbsp;</p>
<p>OneWire oneWire(13); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// One wire object<br />
DallasTemperature tempSensors(&amp;oneWire);</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>In setup</p>
<p>&nbsp; // set up the Dallas Temp sensors find out how many are connected and get their Ids<br />
&nbsp; tempSensors.begin();<br />
&nbsp; numTempSensors=(tempSensors.getDeviceCount());&nbsp;<br />
&nbsp; Serial.print(&quot;Number of sensors: &quot;); Serial.println(numTempSensors);&nbsp;<br />
&nbsp;&nbsp;<br />
&nbsp; int j=0; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // search for one wire devices and<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// copy to device address arrays.<br />
&nbsp; while ((j &lt; numTempSensors) &amp;&amp; (oneWire.search(DS18B20Address[j]))) &nbsp;j++;</p>
<p>&nbsp; // now turn off WaitforConversion so that any RequestTemperatures returns asap<br />
&nbsp; // the read next temperatures routine will be attached to a 750Ms timer<br />
&nbsp; // so the temperature readings will always be ready<br />
&nbsp; tempSensors.setWaitForConversion(false); &nbsp; &nbsp; &nbsp; &nbsp; // turn off the wait for conversion<br />
&nbsp; tempSensors.setResolution (12); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// set global resolution to 12 bit<br />
&nbsp; tempSensors.requestTemperatures(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Do command to start conversions</p>
<p>&nbsp; nextTempSensor=0; &nbsp; &nbsp; // initialise the counter used to select first sensor to read &nbsp; &nbsp;&nbsp;</p>
<p>&nbsp;</p>
<p>and a routine to read the next sensor</p>
<p>// Routine to get next temperature reading. Called every 750Ms by attaching to a timer.<br />
void readnexttemp()<br />
{<br />
&nbsp; // get temperature from next sensor and reset counter to zero when all read<br />
&nbsp; // routine activated every 750Ms<br />
&nbsp; // a requestTemperatures has been sent with waitForConversion OFF<br />
&nbsp; // so get temperature reading for next sensor which should be ready</p>
<p>&nbsp; float temp=(tempSensors.getTempC(DS18B20Address[nextTempSensor])); &nbsp; &nbsp; &nbsp; &nbsp;</p>
<p>&nbsp; // if reading is within range for the sensor convert float to int and save it<br />
&nbsp; if ((temp&lt;125.0) &amp;&amp; (temp&gt;-40.0)) temperatures[nextTempSensor]=(temp*10);&nbsp;<br />
&nbsp; &nbsp; &nbsp;else errorcode = 60 + nextTempSensor +1; &nbsp; &nbsp;&nbsp;<br />
&nbsp; Serial.print(&quot;Sensor number: &quot;); Serial.print(nextTempSensor);&nbsp;<br />
&nbsp; Serial.print(&quot; &nbsp;temperature: &quot;); Serial.println(temperatures[nextTempSensor]*0.1);&nbsp;</p>
<p>&nbsp; // get ready to read the next sensor at the next interval<br />
&nbsp; // if we have cycled through all of the sensors, detach the routine from the timer<br />
&nbsp; // the timer for the bigger loop will reattach this routine to the timer again<br />
&nbsp; if (nextTempSensor == (numTempSensors -1)) {<br />
&nbsp; &nbsp; nextTempSensor = 0;<br />
&nbsp; &nbsp; NextTempTimer.detach ();<br />
&nbsp; }<br />
&nbsp; &nbsp; else {<br />
&nbsp; &nbsp; nextTempSensor++;<br />
&nbsp; &nbsp; tempSensors.requestTemperatures(); &nbsp; &nbsp; &nbsp; &nbsp; // Send the command to start conversion<br />
&nbsp; }<br />
}</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33711"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 30/08/2015 - 15:54.</div>
    <div class="content">
     <p>The problem is people who don't have a programmer to program their emonTx. It's been said several times before that hard coding the address is the safe way, but that is an option that is only available with a programmer. It's also been asserted several times that the order in which the sensors respond is not deterministic. </p>
<p>Having just studied the algorithm (explained in detail in <a href="http://pdfserv.maximintegrated.com/en/an/AN937.pdf" title="http://pdfserv.maximintegrated.com/en/an/AN937.pdf">http://pdfserv.maximintegrated.com/en/an/AN937.pdf</a> (Section C3, p.51)) I think that's not true, but without spending a lot more time on it, it's not clear to me what the order is in which the devices are discovered. I don't have the patience to step through the algorithm for enough devices to see a pattern, so until I do, I have to conclude that if a device is replaced, all the devices <i>may</i> be discovered subsequently in a different order, so the original problem - getting allocated different slots by the emonTx sketch - persists.</p>
<p>The point of keeping the same locations in the same slots is so that it's not necessary to swap things around in emonCMS (and in the process foul up the historical data, which has also been asserted).</p>
<p>If it's possible to write a function/method that will solve the problem and not force users to buy a programmer and learn how to use it (and haven't you noticed that there are increasing numbers of users who aren't keen to assemble hardware and program?) then I see no harm in that.</p>
<p>[BTW, I know temperatures change relatively slowly, but waiting 23&frac34; years (750 Ms = 750 &times; 10<sup>+6</sup> s is a bit much!]</p>
<p>[Edit]<br />
Having looked again, it appears that the order that sensors are discovered is low address to high address <b><i>when the bit order of the address is reversed</i></b>.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33712"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/937.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Bramco&#039;s picture" title="Bramco&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/937.html" title="View user profile.">Bramco</a> on Sun, 30/08/2015 - 16:29.</div>
    <div class="content">
     <p>Robert, thanks for catching my typo! Indeed even in this inclement weather my heat bank warms and cools faster than that.</p>
<p>Interestingly, this afternoon, I disconnected my 5 DS18B20s on the heat bank from my emonTx and connected them to the esp8266 controller I&#39;m building to manage the backup firing of the boiler better.</p>
<p>They came out in exactly the same order as they had been on the emonTx and connecting them back to the emonTx they were still in the same order.</p>
<p>As for losing the data if they were to switch around, surely we&#39;d be talking feeds here not inputs, so if one did switch as an input to emonCMS and that input was then realigned to the feed you wouldn&#39;t lose data. If you see what I mean.&nbsp;</p>
<p>Simon</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33959"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8255.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="goodfidelity&#039;s picture" title="goodfidelity&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8255.html" title="View user profile.">goodfidelity</a> on Tue, 08/09/2015 - 15:08.</div>
    <div class="content">
     <p>Hi guys!</p>
<p>&nbsp;</p>
<p>The problem can be solved in the emoncms to, as stated above.. If the ID of the temperature&nbsp;sensor is associated with one feed, there should not be a problem to create a function that will allow a new temperature sensor to be associated with the same feed.&nbsp;</p>
<p>Two important things here:</p>
<p>1. User&nbsp;don&#39;t want to&nbsp;loose historical data or continuity in feed when temperature sensor is replaced.</p>
<p>2. User wants to be able to replace temperature sensor with no programming what so ever of the emon unit.</p>
<p>If both can be solved inside the emoncms, thats just a nice thing =)</p>
<p>Until then, it needs to be adressed in the Emon hardware, wich&nbsp;probably is a pain for most users.. Even experienced users will still need to waste time on the process. And time is valueble.</p>
<p>&nbsp;</p>
<p>//J</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33987"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Wed, 09/09/2015 - 13:01.</div>
    <div class="content">
     <p>Well, it&#39;s been about 10 days since I loaded the original sketch up to the EmonTX and there hasn&#39;t been a hiccup since, so there has to be *something* about the one I modified to hard code the sensor addresses that was making it take a walk in the park.</p>
<p>&nbsp;</p>
<p>Since it seems the sensors always load up in the same order, it would seem that theyr may be loaded up in S/N order?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33994"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 09/09/2015 - 14:51.</div>
    <div class="content">
     <p>See my edit above - the order is determined by the serial number, but in a way that's not obvious.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33999"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8530.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="davekramkowski&#039;s picture" title="davekramkowski&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/8530.html" title="View user profile.">davekramkowski</a> on Wed, 09/09/2015 - 22:57.</div>
    <div class="content">
     <p>Yeah, I missed that post - when you say &#39;when the byte order is reversed&#39;, do you mean like this (where the bracketed line is the original s/n, and the 0x has been replaced with a &#39;.&#39;):</p>
<p>&nbsp;</p>
<p>{28.FF.D9.47.64.14.04.0E}<br />
0E.04.14.64.47.D9.FF.28</p>
<p>
{28.FF.9F.40.64.14.04.FD}<br />
FD.04.14.64.40.9F.FF.28</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34001"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTX & Multiple DS18B20</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 10/09/2015 - 00:15.</div>
    <div class="content">
     <p>No, I said bit order, not byte order. </p>
<p>The sensor sends the address least significant bit first, and the search handles the sensor addresses one bit at a time. You need to read the description in the data sheet, then check the flow chart in the Library documentation. The latter claims it implements the same algorithm, and it looks like it, but I didn't check it in detail.</p>
<p>So if the serial nos ended 0x7E and 0x31, 0x7E would come before 0x31 because what we see as the least significant bit, it regards as the most significant.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11146"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-n4BzY3nwMJV0rgGzfzTw9GWVPqYAY5pK7RwJZSBRlcg" value="form-n4BzY3nwMJV0rgGzfzTw9GWVPqYAY5pK7RwJZSBRlcg"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
