<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2342 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:02:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Which meter to believe ? | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Which meter to believe ?</h3>
        <span class="submitted">Submitted by <a href="../user/3594.html" title="View user profile.">nothing clever</a> on Mon, 06/05/2013 - 10:29</span>
        <div class="content"><p>OK, so I have a 2kW solar PV system up and running for about 10 days now, and I&#39;m dismayed at the variation in meter readings I&#39;m getting.</p>
<p>I have an Elster A100C meter for my official generation readings - I assume this has been calibrated.</p>
<p>I have a Fronius IG20 Inverter, and to be fair the manual does say - &quot;Due to different monitoring systems there can be deviations in comparison with readings of other metering instruments. For invoicing of the energy supplied only the readings of the calibrated meter supplied by the electric utility company are relevant&quot;.</p>
<p>And finally, the OpenEnergyMonitor emonTX and emonGLCD with raspberry pi base.</p>
<p>Let&#39;s say in a day the Elster increases 11.0kW/Hr. The Fronius will add between 2 and 2.5Kw/hr to say 13kW/hr - it doesn&#39;t report decimal places, and the OpenEnergyMonitor is about 600 to 700W/Hr low, and that&#39;s reading off the emonGLCD.</p>
<p>I&#39;ve just checked the emonTx over with the various diagnostic software, and it seems OK - though I can see that it&#39;s not very good at low current levels. Could the emonGLCD be low because it is missing some RF transmissions, or could it be that in low light levels, the power produced is getting lost in the &quot;noise&quot;.</p>
<p>Are there any other reasons why the OpenEnergyMonitor stuff would be about 15% low</p>
<p>Mike</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2394.html" class="topic-previous" title="Go to previous forum topic">‹ PIC32-PINGUINO-MICRO</a>
              <a href="2380.html" class="topic-next" title="Go to next forum topic">Fridge on timer ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-11896"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 06/05/2013 - 11:27.</div>
    <div class="content">
     <p>Have you calibrated your emonTx? Depending on the tolerance of the divider and burden resistors, the ac adapter, the c.t itself and the processor&#39;s internal reference voltage, at worst case those might indeed add up to close to your 15%. That is the first thing to do.</p>
<p>I don&#39;t think noise will <em>decrease</em> the reading - if anything it should increase it. Lost transmissions might affect the totalizer in the emonGLCD, you could prove this by adding a few lines in the emonTx and checking with the serial monitor.</p>
<p>[BTW, the unit of energy is kWh - watts times time to give the accumulated total. It&#39;s not kW per hour.]&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11923"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3594.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3594.jpg" alt="nothing clever&#039;s picture" title="nothing clever&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/3594.html" title="View user profile.">nothing clever</a> on Tue, 07/05/2013 - 17:41.</div>
    <div class="content">
     <p>Thanks for the reply.</p>
<p>I can&#39;t find any instructions anywhere on how to calibrate emonTX. There are references to these<a href="https://learn.openenergymonitor.org/?redirect=ct-and-ac-power-adaptor-installation-and-calibration-theory">http://openenergymonitor.org/emon/buildingblocks/ct-and-ac-power-adaptor-installation-and-calibration-theory</a> instructions, but it doesn&#39;t tell me HOW to do it.</p>
<p>Have I got to measure the mains AC and the PSU output AC simultaneously, and where do the numbers in the formula</p>
<p>voltage constant = 230 * 11 / (9+20%) = 234.26</p>
<p>come from ? I guess the 11 is the R13/R14 divder ratio, but 20% of what ? Can&#39;t be the 9 surely, why not just write 10.8.</p>
<p>I find these instructions very confusing.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11924"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Tue, 07/05/2013 - 18:30.</div>
    <div class="content">
     <p>Mike,</p>
<p>I think it is not really necessary&nbsp; to understand the formula (which is a bit weird, using a percentage sign without clear reference inside the formula !?!).</p>
<p>You get a reading from your measurement either on the serial output of the emonTx or displayed on the emonGLCD or on one of the inputs of the emoncms. Then you measure the momentary value of your AC mains voltage with a true RMS multimeter. If these two values do not fit, change the voltage constant accordingly (use the ratio of measured to displayed voltage as correction factor).</p>
<p>J&ouml;rg.</p>
<p>PS: you do not say which sketch you are using, but the voltage constant is mostly specified in the function call like&nbsp;</p>
<p>ct1.voltageTX(234.26, 1.7);</p>
<p>just change the 234.26 to the correct value.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11940"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3594.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3594.jpg" alt="nothing clever&#039;s picture" title="nothing clever&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/3594.html" title="View user profile.">nothing clever</a> on Wed, 08/05/2013 - 10:52.</div>
    <div class="content">
     <p>OK. Thanks for the reply.</p>
<p>Re-reading the stuff all again, I think the formulea is</p>
<p>voltage constant = 230 * 11 / (9+20%) = 234.26</p>
<p>where 230 is the measured mains voltage, and 9+20% is the measured adaptor output voltage - a nominal 9v under full load + the &quot;transformer regulation&quot;.</p>
<p>So I get 245.2 * 11 / 11.52 = 234.1319</p>
<p>The sketch emonTX_CT123_voltage used to have a value of 228.268 for CT1 and 234.26 for CT2. Not quite sure why they were different.</p>
<p>For the current side of things I&#39;m using the standard SCT013 with 18R resistors. Tried measuring the 18R resistors &amp; my meter just says 18 so they are either spot on or the variation is so small it&#39;s not measurable.</p>
<p>I&#39;ll reprogram emonTX with this and see how this compares with my generation meter over the next few days.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11947"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/450.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/450.html" title="View user profile.">stuart</a> on Wed, 08/05/2013 - 12:20.</div>
    <div class="content">
     <p>I&#39;ve a similar problem with an SMA inverter, it under measures the kWh readings - over&nbsp; a month about 2% out compared to an Elster AC100 meter.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-11950"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 08/05/2013 - 12:58.</div>
    <div class="content">
     <p>I believe the accuracy required of the tariff meter is 1%, which might mean the two are at opposite ends of a 1% tolerance band.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12248"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1399.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1399.jpg" alt="Series530&#039;s picture" title="Series530&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Sun, 19/05/2013 - 06:17.</div>
    <div class="content">
     <p>In our house, we have the Elster&nbsp;AC100 which, like yours, acts as the reference for generation and billing. I also have an EnviR system which records visible generation meter pulses from the Elster and stores them on a display. This correlates very closely with the numerical output from the Elster and has the added advantage of giving the average power reading every six seconds or so. In addition to this I have one EmonTX unit which constantly reads the iRDA output of the Elster (and sends it to EMONCMS via the EMon Base unit and a second EMonTX which reads the voltage and power on both the generation circuit and the consumption circuit.</p>
<p>Over a twenty day period, as an example, I monitored the total energy generated using the Elster&nbsp;and compared it to the total Energy generated by the EmonTX&nbsp;and as read using EMONCMS. Bearing in mind that the Elster method is a direct read of the meter and the EMON TX method is a constant analog sampling approach with maths, the two would never be the same.</p>
<p>The EMON&nbsp;TX was under reading by 0.48% over 249 KWh of generation. Over this period roughly half the days gave a decent level &nbsp;of PV and half were iffy to say the least. In my book, a fairly reasonable profile.&nbsp;</p>
<p>Now, some may say that these results are flawed or less good than is possible. To me, they are pretty decent and show what is possible with a pretty inexpensive rig.</p>
<p>To get to this point I was very careful to site the voltage monitor close to the consumer unit which, in turn, is close to the generation meter and to accurately calibrate measured RMS supply voltage with a decent voltmeter. It&#39;s all about setting the calibration constants mentioned previously so as to align one with the other. FWIW, I constantly display the RMS&nbsp;supply voltage on an EMON&nbsp;GLCD display and periodically check it with a meter. I can see the voltage fluctuating as the household load changes, all in line with series resistance in the cabling.</p>
<p>From there I have tweaked the current ratios so as to correlate the average power during the sampling window with the power readings from the EnivR&nbsp;- it lining up very closely with the Elster over many months of measurement. Getting the current ratio values right takes a huge amount of tweaking over a long period. Even changing the current ratio by 0.01 can have a significant affect upon the power reading so you need to be patient.</p>
<p>&nbsp;</p>
<p>I&#39;ve tended to err toward getting a good current ratio at high power reading as this is most significant overall. That said, getting the current ratio right there tends to look after itself at lower power reasonably well as the EMON&nbsp;is reasonably linear (for me at least) unless I am trying to measure a really low power value.&nbsp;</p>
<p>Overall, the EMON&nbsp;TX approach is really good. It&#39;s a lot more accurate than my other Wattson system (typical current clamp only , also known as a chocolate fire guard) and, with the added inclusion of the MK two energy dump, tank temperature monitoring on four nodes and visual alarms on both the web and on the EMON Base really cannot be beaten for the money in my humble opinion.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12251"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sun, 19/05/2013 - 07:23.</div>
    <div class="content">
     <p>Ian, if you are up for it sometime, I&#39;d be interested to know how well my <a href="2059.html">ICAL calibration tool </a>compares with your long-term determination of the current ratio (this sketch will calculate the current ratio from the visible meter pulses).</p>
<p>Did you spend much time looking at phase correction? Since you have very good results I&#39;m assuming you must either have it very close or it is not that significant.</p>
<p>-martin</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12252"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1399.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1399.jpg" alt="Series530&#039;s picture" title="Series530&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Sun, 19/05/2013 - 10:20.</div>
    <div class="content">
     <p>Hi Martin,</p>
<p>&nbsp;</p>
<p>to be honest, I hadn&#39;t seen your sketch (having been away on business for much of very week recently). If I get the chance I will have a play with it.</p>
<p>&nbsp;</p>
<p>In the early days I spent a huge amount of time playing with phase correction and goodness knows what else. I built loads of spreadsheets with varying phase calibrations and tuned things for various types of loads (not just resistive, although resistive tends to dominate when the power is high). As I recall, and it was back in January, the phase calibration didn&#39;t make a huge difference. The key thing was to get the voltage ratio correct first. This is a pretty easy thing to do as its simply correlating the emonTX&nbsp;reading with a decent voltmeter on the same monitor. This seems intuitive and visual. Current is less so. Like I said, that monitor needs to be pretty close to the generation meter so as to be accurate (at least with our house wiring). It&#39;s also important to put the monitor directly onto a main socket or to know what the performance loss of the trailing socket that you are using is. In my garage, which isn&#39;t blessed with masses of mains sockets but does have a huge range of power tools, several machines sharing the same trailing socket as the voltage monitor could introduce significant transient errors, for example.</p>
<p>&nbsp;</p>
<p>I then started playing with the light bulbs and coils of wire which are popular on here. That gave me a feel for what the current drain was but it was far from accurate. So I bought a decent plug in energy monitor (the most accurate domestic one that I could find at a reasonable price) and cross correlated the power that this was reading with what the emonTX thought was there. I did the same for the measured supply voltage too. I also played with various load power factors (easy when you have a variety of electrical machines!). At this time I did phase correct sweeps and studied the results in excel. If I am honest, for the most part I found that the power measurement changes were gradual with varying phase cal. Within reason, the value chosen wasn&#39;t that important.</p>
<p>&nbsp;</p>
<p>So, having set V and I cal values I started monitoring measurements through EMON CMS over a longer period. Typically, I ran for a day or more (as EMON CMS only gave me one decimal place) and I tweaked ICAL even more. I probably spent a good month overall tweaking until I settled on a figure. This section of the calibration made by far the biggest difference. In all honesty, I could almost rip up what I did with the light bulbs and with the electrical machines. The long term average approach was the best way. Having the ability to read watt hour values using the iRDA&nbsp;port on the Elster helps a lot and having the patience to wait over several days and recording from EMON CMS also helps. I revisited it several times since and tweaked ICAL again fractionally. Half a percent low is fine for me. I want to under read as this stuff is also used for the PV dump and I dont want to be paying for using the immersion heater! &nbsp;</p>
<p>&nbsp;</p>
<p>I feel lucky in that I have some decent enough references against which to calibrate. In some regards, getting VCAL and then tweaking ICAL so that it correlates with a medium term reference may be considered cheating by some. It gives correlated numbers &nbsp;though and that&#39;s good enough for me at the moment.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12253"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sun, 19/05/2013 - 10:09.</div>
    <div class="content">
     <p>Sounds like you&#39;ve spent even more time on this than me Ian&nbsp;- and I thought I was obsessive! :)</p>
<p>Just be glad you&#39;ve only got one phase to worry about. Imagine my situation with 3 VCALS and 3 ICALs to set and only one meter reading to compare it with. VCAL is ok, it just takes 3 times as long, but you can get in a right mess with ICAL. In the end I automated the process with a sketch that applies the dump loads to each phase in turn and measures the total power&nbsp;via the meter LED at the same time. This gives me 3 simultaneous equations with 3 variables which I can then solve with a matrix - all on the emonTx.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-12263"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="ffimon&#039;s picture" title="ffimon&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Which meter to believe ?</h3>

    <div class="submitted">Submitted by ffimon (not verified) on Mon, 20/05/2013 - 01:28.</div>
    <div class="content">
     <p>@ nothing clever&nbsp;</p>
<p>I think you may find that your&nbsp;Elster A100C&nbsp;may not be as accurate as you may think especially in low light conditions on a 2kW system.</p>
<p>I find my&nbsp;Elster A100C&nbsp;doesnt measure small flows at all well. For example at dawn my energy import (Pulse Metered) drops off by upto&nbsp;80W&nbsp;upto a couple of hours before my elster A100C says there is any generation. My consumption is static (other than my fridge freezers) yet my import drops this energy must be coming from my Solar PV but isn&#39;t&nbsp;being Metered.&nbsp;</p>
<p>I ended writing my own routine for reading the Elster A100C&nbsp;irDA&nbsp;pulses which uses 600Bytes less ram than the previous one I used See Bellow. It may be of some use to those of you who wish to read the &nbsp;A100C. I also have a version that will fetch the Serial No and Status bits If needed.</p>
<p>[code]</p>
<p>/*</p>
<p>Elster A100c Meter Reader Software<br />
	Reads a 2400 baud stream Stream Starts after MinimumInterBlockGap (uS)<br />
	(c) No one Please feel free to do with as you please.</p>
<p>*/<br />
	#define PulseGap 390&nbsp; // Approximate Pulse Gap its actually 416uS But 390 allows a little margin for error<br />
	#define ReadByteLength 54 // The Number of Bytes to read from the stream we only need to read upto the end of the<br />
	#define MeterReadingDataStart 49 // The Starting Position of the BCD Meter Data<br />
	#define MeterReadingDataEnds 53 // The Ending Position of the BCD Meter Data<br />
	#define MinimumInterBlockGap 100000 // The Gap Between Frames In (uS)</p>
<p>volatile unsigned long LastPulse; // The micros() of the last Pulse<br />
	volatile unsigned long ThisPulseMicrosTemp; // The micros() of the this Pulse<br />
	volatile unsigned long MicrosSinceLastPulse; // Gap in uS Between This and the Last Pulse<br />
	volatile unsigned long NEWreading_A100C_Reading_1; // Varible To Convert the BCD Reading into<br />
	volatile byte BuffPtr; // Current Character Position in Stream<br />
	volatile byte ReadByte; // Current Character<br />
	volatile byte BitPos; // The bit position of the current Pulse<br />
	volatile bool FirstRead; // Flag showing this as the First read I ignore the first meter reading as it seems to be corrupt 1 in 10 times<br />
	//Following reads all seem fine.</p>
<p></p>
<p>void HandlePulse()<br />
	{<br />
	// Recieved an IR Pulse. Let the Games Commence<br />
	// Grab micros soon as the pulse arrives to give the most accurate Inter pulse Gap<br />
	ThisPulseMicrosTemp=micros();<br />
	MicrosSinceLastPulse=(ThisPulseMicrosTemp-LastPulse);<br />
	if (MicrosSinceLastPulse&gt;MinimumInterBlockGap) {<br />
	&nbsp; // Its a Big Gap ... The Frame has just begun<br />
	&nbsp; BuffPtr=0;BitPos=0;ReadByte=255;NEWreading_A100C_Reading_1=0;<br />
	}<br />
	else<br />
	{<br />
	&nbsp; // Process Each bit if we haven&#39;t Passed the end of where we want to read to.<br />
	&nbsp; if (BuffPtr&lt;ReadByteLength)<br />
	&nbsp; {<br />
	&nbsp;&nbsp; // Calculate the number of bits forward the next &quot;0&quot; pulse is<br />
	&nbsp;&nbsp; BitPos+=(MicrosSinceLastPulse/PulseGap);<br />
	&nbsp;&nbsp; if (BitPos &gt; 8){</p>
<p>&nbsp;&nbsp;&nbsp; // If the next &quot;0&quot; pulse is after the end of the byte<br />
	&nbsp;&nbsp;&nbsp; // IE the next start BIT then the current Byte next valid character in the stream</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; if (!(BuffPtr&lt;MeterReadingDataStart) &amp;&amp; !(BuffPtr&gt;MeterReadingDataEnds))<br />
	&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // This character is part of the meter reading<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Convert the BCD to Unsigned Long<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NEWreading_A100C_Reading_1=(NEWreading_A100C_Reading_1*100);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NEWreading_A100C_Reading_1+=(ReadByte /16)*10+(ReadByte % 16);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((BuffPtr==MeterReadingDataEnds)) // Its the Last Character Call the Reading Complete with the results<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(FirstRead) FirstRead=false;&nbsp; // If its not the first reading then ignore it.<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else ReadingComplete(NEWreading_A100C_Reading_1);&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp; BuffPtr++;ReadByte=255;BitPos=0;<br />
	&nbsp;&nbsp; }<br />
	&nbsp;&nbsp; else<br />
	&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp; // Unset this bit as it has a pulse in it and Pulses are 0&#39;s<br />
	&nbsp;&nbsp;&nbsp; switch (BitPos){<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 1:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte -=1;break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 2:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte -=2;break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 3:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte -=4;break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 4:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte-=8;break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 5:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte-=16;break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 6:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte-=32;break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 7:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte-=64;break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; case 8:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReadByte-=128;break;<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp; }<br />
	&nbsp; }<br />
	}<br />
	// Finally Don&#39;t Forget to set the last pulse time to this pulse time so we can calculate the next gap.<br />
	LastPulse=ThisPulseMicrosTemp;<br />
	}</p>
<p>void StartA100cMeterReader(byte IRQ){<br />
	// This Starts the meter Reader<br />
	FirstRead = true;<br />
	LastPulse=micros();<br />
	attachInterrupt(IRQ,HandlePulse,RISING);<br />
	}</p>
<p>void ReadingComplete(unsigned long Reading)<br />
	{<br />
	// This is called everytime there is a succesfull meter reading usually around once per second<br />
	// PS Calling Serial.print() in here is probably not a good thing as it is called from an ISR.</p>
<p>Serial.println(Reading);<br />
	}</p>
<p>void setup()<br />
	{</p>
<p>&nbsp; /* add setup code here */</p>
<p>Serial.begin(57600);<br />
	delay(1000);<br />
	Serial.println(&quot;starting&quot;);<br />
	StartA100cMeterReader(0);</p>
<p>}</p>
<p>void loop()<br />
	{</p>
<p>&nbsp; /* add main program code here */</p>
<p>}</p>
<p>[/code]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2342"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-LPnJZULKWMtINlfmr5l6UaW2t1n4FVfihCe-e41pNOE" value="form-LPnJZULKWMtINlfmr5l6UaW2t1n4FVfihCe-e41pNOE"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
