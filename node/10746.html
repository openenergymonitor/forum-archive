<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10746 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Publish to MQTT - how do you set it up? [Solved] | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Publish to MQTT - how do you set it up? [Solved]</h3>
        <span class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Sun, 24/05/2015 - 07:31</span>
        <div class="content"><p>Hi</p>
<p>I just noticed publish to MQTT in the input configuration. Where and how do you set up the mqtt&nbsp;broker URL and are the topic names fixed or can you set them up?</p>
<p>Regards&nbsp;</p>
<p>Ian</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10767.html" class="topic-previous" title="Go to previous forum topic">‹  Notice: Trying to get property error</a>
              <a href="10752.html" class="topic-next" title="Go to next forum topic">Multigraph problem on the Extended version ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-30609"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Sun, 24/05/2015 - 08:10.</div>
    <div class="content">
     <p>There is some information about it<a href="10732.html"> in this thread</a>. which may help</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30611"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Sun, 24/05/2015 - 08:36.</div>
    <div class="content">
     <p>Thanks Paul,</p>
<p>I don&#39;t use emonhub&nbsp;because my set up is multiple&nbsp;nanodeRFs and a local&nbsp;Pi server without the RFM because my sensors are in remote locations sending data over the internet.</p>
<p>Can version 8.5 be used in that situation as all the reference seem to suggest it is for emonhub only? The ultimate for me would be to also post into node-red and a mosquitto broker I have running on a seperate&nbsp;Pi on the same local network as the&nbsp;emoncms server.</p>
<p>I am slowly building in remote control at the remote sites and as a non programmer node red seems the obvious way to go. l am using thingstudio&nbsp;(<a href="http://www.thingstud.xn--io-2ca/" title="http://www.thingstud.io ">http://www.thingstud.io </a>) as the control interface to&nbsp;node red.</p>
<p>Regards</p>
<p>Ian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30613"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Sun, 24/05/2015 - 08:53.</div>
    <div class="content">
     <p>It's my understanding that the oem version of Emonhub is a necessity, to feed the data to one of the emoncms modules, in order for it to work.<br />
I'm also using node-red for the same purpose.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30614"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sun, 24/05/2015 - 10:31.</div>
    <div class="content">
     <p>I thought the &quot;publish to mqtt&quot; process was previously working in v8.4 (I didn&#39;t use it so cannot confirm) <a href="5943.html#comment-24895">this section of the&nbsp;&quot;MQTT and node-red for emonHub&quot; discussion</a> suggests it was.</p>
<p>It relies on the&nbsp;<a href="https://github.com/emoncms/emoncms/blob/master/scripts/phpmqtt_input.php">phpmqtt_input.php</a>&nbsp;script running in the background and&nbsp;<a href="https://github.com/emoncms/emoncms/blob/master/default.settings.php#L18">$mqtt_enabled = True, being set in settings.php</a>&nbsp;in emoncms.</p>
<p>The <a href="https://github.com/emoncms/emoncms/blob/master/scripts/phpmqtt_input.php#L45">mqtt server settings appear to be hard&nbsp;coded in the script</a>&nbsp;which is located in the emoncms/scripts folder.</p>
<p>Then just run</p>
<p><strong>sudo php phpmqtt_input.php&amp;</strong></p>
<p>Or to run the script automatically at start up you need to create an&nbsp;init&nbsp;script or just&nbsp;add the run command to the end of the /etc/rc.local file.</p>
<p>Then it should just be a case of just defining the &quot;publish to&quot;&nbsp;topic in each &quot;publish to&nbsp;mqtt&quot; process for the&nbsp;values you wish to publish.</p>
<p>I&#39;ve not tested any of this but that&#39;s how I understood things. I pretty sure this will clash with v8.5 which does work more&nbsp;closely&nbsp;with the &quot;emonpi&quot; variant of emonhub for mqtt.</p>
<p>Let us know how you get on if you do try it.</p>
<p>As for using emonhub&nbsp;across&nbsp;multiple sire via a SocketInterfacer&nbsp;it should&nbsp;be built into the next version of emonHub as I have it working in an experimental version already, if you wanted to &quot;hack&quot; the current emonhub it wouldn&#39;t be too difficult&nbsp;to add a quick &quot;discard if apikey doesn&#39;t match&quot; check one-liner to get get you up and running for now.</p>
<p>Paul<br />
&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30615"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Sun, 24/05/2015 - 11:51.</div>
    <div class="content">
     <p>Hi Paul (pb66)</p>
<p>Followed instructions. The only slight change is I had to run sudo php phpmqtt_input.php&amp; from the script folder or I got an error about not finding a file.</p>
<p>​Went to Mosquitto log and saw nothing about emoncms topics. Went back to where I started phpmqtt_input.php and found this error continuously&nbsp;scrolling.</p>
<p>​Warning: fread() expects parameter 1 to be resource, boolean given in /var/www/emoncms/Lib/phpMQTT.php on line 160<br />
PHP Warning: &nbsp;feof() expects parameter 1 to be resource, boolean given in /var/www/emoncms/Lib/phpMQTT.php on line 159</p>
<p>Regards</p>
<p>Ian</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30616"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sun, 24/05/2015 - 12:27.</div>
    <div class="content">
     <p>You&#39;re right, the command does need a path, sorry &#39;bout that, it should be (assuming default install locations)</p>
<p><strong>sudo php /var/www/emoncms/scripts/phpmqtt_input.php&amp;</strong></p>
<p>As for the errors, and&nbsp;I&#39;m guessing here as both mqtt and php are out of my comfort zone, might suggest there is no connection with the mqtt server.</p>
<p>You will probably be better off dropping the ambersand from the end of the command line until you have it running ok as that just causes the script to run in the background so you can log-off or close the ssh window etc and the script continues, but that also means there is no screen updates.</p>
<p>Are you already using mqtt on that server? you may need to allow that port in the UFW firewall if you use a fixed LAN IP&nbsp;rather than&nbsp;&#39;locahost&#39;</p>
<p>&nbsp;</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30617"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Sun, 24/05/2015 - 13:42.</div>
    <div class="content">
     <p>Hi Paul</p>
<p>Running without ampersand seems to take me a bit closer. Emoncms&nbsp;window shows:-</p>
<p>Subscribing to: rx/#&nbsp;</p>
<p>and the emoncms&nbsp;connection shows up in the mosquitto log. Unfortunately it then disconnects with a timeout error.</p>
<p>I have seen this with other mqtt&nbsp;clients and it is usually set up being wrong in some way e.g no client_ID&nbsp;being posted to broker. (It seems to take 2 days per incident to track this kind of thing. At the moment I go forward 2 days and back 1.9 days in my mqtt&nbsp;adventure. I have even managed to find some errors in the&nbsp;latest&nbsp;mosquitto packages that only effect me I guess because I know so little about linux&nbsp;and other users work out what is wrong and fix the issue without thinking and then don&#39;t report the issue.)</p>
<p>I am chary&nbsp;of&nbsp;trying emonHub&nbsp;with a hack as your other&nbsp;suggestion as I don&#39;t want to mess up my running system unless there is a way I can do this and revert back if I hit problems.&nbsp;</p>
<p>Regards</p>
<p>Ian</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30619"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sun, 24/05/2015 - 15:42.</div>
    <div class="content">
     <p>Hi Ian</p>
<p>I totally get what you say about making progress It is definitely an up hill struggle.&nbsp;</p>
<p>The<a href="https://github.com/bluerhinos/phpMQTT"> bluerhino&nbsp;phpMQTT module</a> doesn&#39;t seem to have changed much beyond extending the auto-reconnect, Have you tried connecting to another broker to see if the issue is client or sever related?&nbsp;</p>
<p>I don&#39;t think the emonHub hack would be<em> too</em> difficult to implement or change back but I&#39;m not sure it helps&nbsp;with the mqtt,&nbsp;as it would simply&nbsp;move&nbsp;things around but&nbsp;MQTT&nbsp;would still need implemented somewhere if thats&nbsp;the way you&#39;re going. My comment was directed specifically at the &quot;unable to use socket inputs&nbsp;remotely&quot; aspect.</p>
<p>Also just found this&nbsp;<a href="https://github.com/emoncms/emoncms/blob/master/scripts/multiuser.md">https://github.com/emoncms/emoncms/blob/master/scripts/multiuser.md</a>&nbsp;it says this needs adding below line 107, but i&#39;m not sure which file or if the line number has altered</p>
<p>There are also a couple of <a href="https://github.com/emoncms/emoncms/tree/master/scripts/examples">standalone examples</a> that may help diagnosis.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30646"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Tue, 26/05/2015 - 08:19.</div>
    <div class="content">
     <p>Over the weekend I took another look at this and read all the posts I could find relating to mqtt.</p>
<p>I also updated and upgraded all the Pi software as I have not done that for a while. The result of all this is that I believe&nbsp;phpmqtt_input.php is now running correctly. Starting with the ampersand I get this on the emoncms&nbsp;server:-</p>
<p>pi@StudioPiServer ~ $ sudo php /var/www/emoncms/scripts/phpmqtt_input.php&amp;<br />
[1] 3946<br />
pi@StudioPiServer ~ $ Subscribing to: emoncms/#</p>
<p>In the mosquitto&nbsp;log I see frequent:-</p>
<p>1432627234: Received PINGREQ from Emoncms input subscriber<br />
1432627234: Sending PINGRESP to Emoncms input subscriber</p>
<p>I tracked the earlier error I had. You get this if the broker is not available. It remains even if the broker is then&nbsp;started while phpmqtt_input.php is running&nbsp;. Emoncms mqtt does not reconnect so I guess that is something that will need looking at some time. I have to restart&nbsp;phpmqtt_input.php to reconnect to the broker.</p>
<p>The only problem I now have is that I am not seeing the input that I have set up to &quot;Publish to mqtt&quot; appearing at the broker. Is there&nbsp;anything special about the formatting? The only thing I see is the number 35 appears in the process list:-</p>
<p>x&nbsp;log&nbsp;<u><strong>35</strong></u>&nbsp;kwhkwhd&nbsp;kwhkwhd 7s ago</p>
<p>Any ideas as to what to try next would be appreciated. Or even confirmation that it doe/does not work with v8.4.0 not using emonHub.</p>
<p>Regards</p>
<p>Ian</p>
<p>
&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30648"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 26/05/2015 - 11:09.</div>
    <div class="content">
     <p>Hi Ian.</p>
<p>Glad you have made progress:-)</p>
<p>You could try updating phpMQTT.php to tackle the first issue of not reconnecting after attempting to connect to a unavailable broker, see this commit from March, the MQTT stuff was added to emoncms back&nbsp;in Oct.</p>
<p><a href="https://github.com/bluerhinos/phpMQTT/commit/4c397342d74b01fdbe40a9a22723ea58f66553c3">https</a><a href="https://github.com/bluerhinos/phpMQTT/commit/4c397342d74b01fdbe40a9a22723ea58f66553c3">://github.com/bluerhinos/phpMQTT/commit/4c397342d74b01fdbe40a9a22723ea58f66553c3</a></p>
<p>​And I just did a little more digging into emoncms and found <a href="https://github.com/emoncms/emoncms/blob/master/Modules/input/process_model.php#L38">the &quot;publish to&nbsp;MQTT&quot;&nbsp;broker details seem to be hardcoded in a different location</a> to the broker details for the&nbsp;&quot;MQTT<span style="line-height: 20.7999992370605px;">&nbsp;input subscriber&quot;.</span></p>
<p><span style="line-height: 20.7999992370605px;">It seems both work independently of each other and I would expect no reliance in emonhub, certainly at the time of conception that was the case but I cannot confirm for sure.</span></p>
<p><span style="line-height: 20.7999992370605px;">Paul</span></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30652"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Tue, 26/05/2015 - 12:21.</div>
    <div class="content">
     <p>Hi Pau</p>
<p>Many thanks. There are 3 phpMQTT.php on my server:-</p>
<p>pi@StudioPiServer ~ $ sudo find / -name &quot;phpMQTT.php&quot;<br />
/var/www/emoncms/Lib/phpMQTT.php<br />
/var/www/emoncms/emoncms/Lib/phpMQTT.php<br />
/var/www/emoncms/Modules/event/scripts/mqtt/phpMQTT.php</p>
<p>Should I replace them all?</p>
<p>Ian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30653"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Tue, 26/05/2015 - 12:28.</div>
    <div class="content">
     <p>Ian,  how come you have a emoncms folder within emoncms?<br />
Have you installed emoncms twice?</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30654"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 26/05/2015 - 12:52.</div>
    <div class="content">
     <p>The easy answer is yes that way you won&#39;t get the wrong one, but I also wonder which one you are using and as Paul says why do you have emoncms in emoncms? I assume therefore you have 2 of every thing so are you editing the correct input processing file and the correct mqtt&nbsp;subscriber etc.</p>
<p>Try updating&nbsp;/var/www/emoncms/Lib/phpMQTT.php and possibly&nbsp;/var/www/emoncms/Modules/event/scripts/mqtt/phpMQTT.php as although ideally the events module should be using the same phpmqtt.php it won&#39;t be unless you edit the hardcoded&nbsp;path&nbsp;and that may break later if you update the events module etc</p>
<p>Try renaming the additional emoncms&nbsp;folder to see if it&#39;s being used at all before deleting.</p>
<p>Ideally the broker details should be in setting.php and the events module should use Lib/phpMQTT.php.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30655"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Tue, 26/05/2015 - 14:20.</div>
    <div class="content">
     <p>Hi</p>
<p>I have no idea how I have ended up with an&nbsp;emoncms&nbsp;folder within&nbsp;emoncms. I am definitely&nbsp;using the top version for&nbsp;mqtt&nbsp;because that is where the script file I have been changing is located and I can see the effects of my changes.</p>
<p>The great thing I can report is that&nbsp;<strong>publish to&nbsp;mqtt</strong>&nbsp;is now working&nbsp;following the change to&nbsp;process_model.php. so I have&nbsp;acheived&nbsp;my aims. However the &nbsp;way the&nbsp;emoncms&nbsp;mqtt&nbsp;client works is clearly different from all the other clients I am using.&nbsp;&nbsp;I hesitate to say it is working incorrectly because I don&#39;t have the knowledge. But I have seen some strange things in the&nbsp;mosquitto&nbsp;log all relating to&nbsp;emoncms. Unfortunately I can&#39;t show them as I have&nbsp;mosquitto&nbsp;logging to&nbsp;stdout&nbsp;at the moment as I have a&nbsp;problem with file logging on the latest&nbsp;mosquitto&nbsp;version (Which I have to use as it has&nbsp;websockets&nbsp;required by another client!). It almost looks as if there are 2&nbsp;emoncms&nbsp;clients. At the moment I can see:-</p>
<p>1432647530: Received DISCONNECT from&nbsp;Emoncms&nbsp;Publisher<br />
1432647530: Client&nbsp;Emoncms&nbsp;Publisher disconnected.<br />
1432647534: Received&nbsp;PINGREQ&nbsp;from&nbsp;mqtt_beffa049.41006<br />
1432647534: Sending&nbsp;PINGRESP&nbsp;to&nbsp;mqtt_beffa049.41006<br />
1432647538: Received&nbsp;PINGREQ&nbsp;from&nbsp;Emoncms&nbsp;input subscriber<br />
1432647538: Sending&nbsp;PINGRESP&nbsp;to&nbsp;Emoncms&nbsp;input subscriber<br />
1432647538: Received&nbsp;PINGREQ&nbsp;from&nbsp;Emoncms&nbsp;input subscriber<br />
1432647538: Sending&nbsp;PINGRESP&nbsp;to&nbsp;Emoncms&nbsp;input subscriber<br />
1432647541: New connection from 79.78.46.160 on port 1883.<br />
1432647541: New client connected from 79.78.46.160 as&nbsp;Emoncms&nbsp;Publisher (c1, k10).<br />
1432647541: Sending&nbsp;CONNACK&nbsp;to&nbsp;Emoncms&nbsp;Publisher (0, 0)<br />
1432647541: Received PUBLISH from&nbsp;Emoncms&nbsp;Publisher (d0, q0, r0, m0, &#39;rain&#39;, ... (5 bytes))<br />
1432647541: Sending PUBLISH to&nbsp;mqtt_beffa049.41006 (d0, q0, r0, m0, &#39;rain&#39;, ... (5 bytes))<br />
1432647541: Received DISCONNECT from&nbsp;Emoncms&nbsp;Publisher</p>
<p>Continually scrolling.</p>
<p>Note there is&nbsp;Emoncms&nbsp;Publisher and&nbsp;Emoncms&nbsp;input. It would seem that the&nbsp;mqtt&nbsp;code in&nbsp;emoncms&nbsp;needs some work. I wish I had the knowledge to do this my self but I am out of my depth with PHP.</p>
<p>Thanks for all the help</p>
<p>Regards</p>
<p>Ian</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30656"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Tue, 26/05/2015 - 14:48.</div>
    <div class="content">
     <p>Hi</p>
<p>I have just taken this a bit further.&nbsp;I rebooted the emoncms&nbsp;server and immediately I was getting&nbsp;traffic from&nbsp;emoncms at the mqtt&nbsp;broker. So you do not need to run&nbsp;phpMQTT_input.php.</p>
<p>Therefore the probable cause of me not being able to publish to mqtt was the hard coded address in process_model.php. If this could be moved to settings.php the current code may well&nbsp;be good to go.</p>
<p>Not running&nbsp;phpMQTT_input.php also stops the two different clients appearing from emoncms. It does not stop the continuouse&nbsp;connect/disconnect from emoncms you see in the broker log. This can&#39;t be good for low overhead. All the other clients I have running just use a very occasional&nbsp;ping like so:-</p>
<p>Received PINGREQ from mqtt_2473f66c.db8c0a<br />
Sending PINGRESP to mqtt_2473f66c.db8c0a</p>
<p>Any way at least I am&nbsp;running so now I can move on to the next objective which is remote control of irrigation based&nbsp;on the rain fall logged into emoncms. If any one is interested&nbsp;the irrigation is solar powered on a remote site with no wifi access (At the moment, our town is very proactive in providing public&nbsp;wifi&nbsp; everywhere) so I am using text messages to monitor and control the irrigation with a mobile phone shield on an arduino. With emoncms,&nbsp;mqtt&nbsp;&amp;&nbsp;node-red I have the possibility of making the whole process automatic.</p>
<p>Again many thanks. I would not have achieved&nbsp;much without the support I have received.</p>
<p>Regards</p>
<p>Ian</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30657"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 26/05/2015 - 15:14.</div>
    <div class="content">
     <p>The &quot;Emoncms&nbsp;input subscriber&quot; and the &quot;Emoncms&nbsp;Publisher&quot; will be independent clients the way they are currently coded as would the events module i guess, but I&#39;m even less familiar with that so can&#39;t be sure.</p>
<p>If you only need to publish you can indeed not run the&nbsp;phpMQTT_input.php.</p>
<p><a href="https://github.com/emoncms/emoncms/blob/v8.5/Modules/input/process_model.php#L641-L647">the way the &quot;publish to mqtt&quot; process works it will connect,&nbsp;publish and then disconnect each update</a>.&nbsp;</p>
<p>I like the concept of the &quot;publish to mqtt&quot; but didn&#39;t realize the way it worked, perhaps a long timeout rather than closing the connection combined with a &quot;connect if not connected&quot; check on each update would work better.</p>
<p>I&#39;m in the same boat with php.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30658"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Tue, 26/05/2015 - 15:34.</div>
    <div class="content">
     <p><em>Unfortunately I can&#39;t show them as I have&nbsp;mosquitto&nbsp;logging to&nbsp;stdout&nbsp;at the moment</em></p>
<p>Hi Ian,</p>
<p>Good to see you&#39;ve solved your MQTT issues. Had you thought of using the Linux tee command to write the console output to a file as well as display it on the console at the same time?</p>
<p>Something like: &lt;your command here&gt; | tee -a output.file&nbsp; (-a = append to file)</p>
<p>Bill</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30659"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Tue, 26/05/2015 - 15:51.</div>
    <div class="content">
     <p>Hi Bill</p>
<p>Thanks, that works a treat. Another linux command I must remember.</p>
<p>Regards</p>
<p>Ian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30690"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Wed, 27/05/2015 - 16:32.</div>
    <div class="content">
     <p>Hi</p>
<p>Just to confirm that updating&nbsp;phpMQTT&nbsp;from:-&nbsp;</p>
<p><a href="https://github.com/bluerhinos/phpMQTT/commit/4c397342d74b01fdbe40a9a22723ea58f66553c3" title="https://github.com/bluerhinos/phpMQTT/commit/4c397342d74b01fdbe40a9a22723ea58f66553c3">https://github.com/bluerhinos/phpMQTT/commit/4c397342d74b01fdbe40a9a2272...</a> as suggested by Paul (pb66)</p>
<p>solves the problem of reconnecting and removes the error when the broker stop running described in my earlier post.</p>
<p>I now have mqtt data being published <em><strong>and</strong></em> received in emoncms. Received data&nbsp;appears in the input list with the topic name as the node name. Magic! I am impressed how this all works.</p>
<p>The only thing I have left to do is get&nbsp;phpmqtt_input.php running on Pi boot as if I run from ssh it stops running when I shut down the ssh pc.</p>
<p>&nbsp;</p>
<p>Regards</p>
<p>Ian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30692"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Wed, 27/05/2015 - 18:19.</div>
    <div class="content">
     <p>Ian,</p>
<p>As a temporary measure (unless of course you&#39;ve already solved the startup issue) you could start<br />
phpmqtt_input.php appended with an ampersand i.e. <em><strong>phpmqtt_input.php &amp;</strong></em><br />
and it&#39;ll continue to run after you close the ssh session.</p>
<p>Regards,</p>
<p>Bill</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30699"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Wed, 27/05/2015 - 20:49.</div>
    <div class="content">
     <p>Ian, wondered if phpmqtt_input.php could be run from within&nbsp;node-red itself?&nbsp;would this <a href="http://flows.nodered.org/node/node-red-node-daemon">node-red node</a>&nbsp;fulfill&nbsp;that function?</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30716"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Thu, 28/05/2015 - 12:01.</div>
    <div class="content">
     <p>Hi</p>
<p>Bill, I did start&nbsp;phpmqtt_input.php &nbsp;with the ampersand but it still seems to stop running when I close SSH.</p>
<p>Paul,&nbsp;I am running node red and the mosquitto&nbsp;broker on a different Pi to emoncms. I think I did this because I was at one time having problems with routing to different ports on the same local address on the network. I have a fixed IP and all my incoming connections&nbsp;to mqtt and emoncms&nbsp;(apart from testing) are actually routed over the internet.&nbsp;</p>
<p>I am a bit cautious about putting them all on the same Pi until I have every thing setup. That would be ideal ultimately because I run&nbsp;my router&nbsp;and the emoncms server PI&nbsp;on a 48volt DC solar powered system for about 10 months of the year. &nbsp;</p>
<p>Regards</p>
<p>Ian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30718"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Thu, 28/05/2015 - 13:16.</div>
    <div class="content">
     <p>Hi Ian,&nbsp;</p>
<p>The ambersand&nbsp;just tells the calling script not to wait for any response from that command, effectively splintering it off to the &quot;background&quot; if you are using <strong>sudo&nbsp;php&nbsp;phpmqtt_input.php &amp;&nbsp;</strong>it should continue running but without sudo it may terminate when the <u>user</u> is no longer logged in (ie when the ssh is ended).</p>
<p>This method will still need manually starting at each reboot unless you automate it by either the &quot;quick and dirty&quot; method of adding &quot;sudo&nbsp;php&nbsp;phpmqtt_input.php &amp;&quot; before the &quot;exit 0&quot; in /etc/rc.local or the &quot;proper&quot; method of writing an init script. The &quot;quick and dirty&quot; will work but if you prefer the &quot;proper&quot; route there is a template included the Raspbian OS at&nbsp;/etc/init.d/skeleton, copy that to /etc/init.d/??? and edit the file names paths etc</p>
<p>Paul</p>
<p>PS you will also need to run&nbsp;sudo update-rc.d NameOfYourScript defaults to get it to start at boot, and here is a real barebones&nbsp;example and how to&nbsp;<a href="http://www.stuffaboutcode.com/2012/06/raspberry-pi-run-program-at-start-up.html">http://www.stuffaboutcode.com/2012/06/raspberry-pi-run-program-at-start-up.html&nbsp;</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30727"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Thu, 28/05/2015 - 16:03.</div>
    <div class="content">
     <p>Hi Paul</p>
<p>Slightly more to this than meets the eye! Last night I exited SSH and my emoncms&nbsp;mqtt&nbsp;input stopped updating so I assumed phpmqtt_input had stopped&nbsp;( I am injecting an mqtt message into emoncms every 5 minutes from Node Red).</p>
<p>I had started with&nbsp;sudo php /var/www/emoncms/scripts/phpmqtt_input.php &amp;</p>
<p>So I opened up an&nbsp;SSH session and started phpmqtt_input&nbsp;and&nbsp;got this message :-</p>
<p>pi@StudioPiServer ~ $ sudo php /var/www/emoncms/scripts/phpmqtt_input.php &amp;<br />
[1] 4367<br />
pi@StudioPiServer ~ $ Already running</p>
<p>BUT emoncms is not receiving any mqtt&nbsp;messages. So I ctrl C out of phpmqtt_input, typed the command&nbsp;again and every thing starts working.</p>
<p>pi@StudioPiServer ~ $ sudo php /var/www/emoncms/scripts/phpmqtt_input.php &amp;<br />
[1] 4388<br />
pi@StudioPiServer ~ $ Subscribing to: emoncms/#<br />
emoncms/test 2<br />
emoncms/test 2</p>
<p>I am not over concerned as I intend to implement start on boot but it suggests there are some quirks in the emoncms&nbsp;php&nbsp;mqtt coding.</p>
<p>Regards</p>
<p>Ian</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30731"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Thu, 28/05/2015 - 21:21.</div>
    <div class="content">
     <p>That doesn&#39;t sound good,&nbsp;</p>
<blockquote><p><em>pi@StudioPiServer ~ $ sudo php /var/www/emoncms/scripts/phpmqtt_input.php &amp;<br />
[1] 4367<br />
pi@StudioPiServer ~ $ Already running</em></p>
</blockquote>
<p>The &quot;[1] 4367&quot; process id is normal and usually the only output when the ampersand is used. But the &quot;Already running&quot; isn&#39;t explicitly&nbsp;saying whether it has crashed, aborted starting or opened another instance. If multiple copies are open it may&nbsp;result in conflicts which stop the process(es). Using an init script can prevent multiple instances&nbsp;if configured correctly but there again if it is only ever started once at boot and never fails there should only ever be one instance.</p>
<p><strong>ps -ef | grep&nbsp;phpmqtt_input</strong></p>
<p>will show all running instances of&nbsp;phpmqtt_input ( it will also always show 1 apparently extra process as the search process itself contains the search term too). hopefully it is just multiple copies as that will be avoided in normal use.</p>
<p>Paul</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30733"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Thu, 28/05/2015 - 21:38.</div>
    <div class="content">
     <p>The &quot;extra&quot; process can be eliminated by issuing the command like this:</p>
<p><strong>ps -ef | grep [p]hpmqtt_input</strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30736"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Thu, 28/05/2015 - 22:01.</div>
    <div class="content">
     <p>Good call Bill! Now I just need to figure out why it only works on one Pi and not the other, Technology...&nbsp;don&#39;t ya jus&#39; luv it&nbsp;:-)</p>
<p><img alt="" src="../sites/default/files/processes.png" style="width: 700px; height: 364px;" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30742"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Thu, 28/05/2015 - 22:24.</div>
    <div class="content">
     <p><em>Good call Bill!</em></p>
<p>Thanks, Paul!</p>
<p><em>Now I just need to figure out why it only works on one Pi and not the other</em></p>
<p>The answer to <strong><em>that</em></strong> ought to be interesting.... It&#39;s never failed to work for me. (on several Linux distros and FreeBSD)</p>
<p>I have a Model B PI2, and an early 256MB Model B. It works OK on both of <em>them.</em></p>
<p>Reminds me of the old saying, truth is sometimes stranger than fiction!</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30749"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Publish to MQTT - how do you set it up? [Solved]</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Fri, 29/05/2015 - 08:44.</div>
    <div class="content">
     <p>Hi</p>
<p>Last night I added a monitor and keyboard to the &nbsp;emoncms pi server and started&nbsp;phpmqtt_input.php from there in the hope it would keep running when I shut down my pc.</p>
<p>That worked and emoncms is still showing the mqtt&nbsp;input every minute this morning. (I changed the node red trigger to 1 minute for testing purposes).</p>
<p>Also last night I added another mqtt output from node red&nbsp;into emoncms as the beginnings of what I am trying to achieve&nbsp;rather than just testing. The strange thing is this does NOT show up in emoncms. I came into the office and looked at the emoncms server and clearly there I am logging both inputs into emoncms!</p>
<p>I then ran SSH into the emoncms server and ran the command suggested with this result:-</p>
<p>pi@StudioPiServer ~ $ ps -ef | grep [p]hpmqtt_input<br />
root &nbsp; &nbsp; &nbsp;4506 &nbsp;4492 &nbsp;0 May28 tty1 &nbsp; &nbsp; 00:00:00 sudo php /var/www/emoncms/scripts/phpmqtt_input.php<br />
root &nbsp; &nbsp; &nbsp;4507 &nbsp;4506 &nbsp;0 May28 tty1 &nbsp; &nbsp; 00:04:20 php /var/www/emoncms/scripts/phpmqtt_input.php<br />
pi@StudioPiServer ~ $</p>
<p>&nbsp;</p>
<p>So I do have 2 instances.</p>
<p>I have not yet set up&nbsp;phpmqtt_input.php to run at boot as its going to take a while to get my head around&nbsp;/etc/init.d/skeleton.</p>
<p>I am just about to reboot the emoncms server which is something I rarely do to see where that gets me.</p>
<p>OK after reboot no instances of&nbsp;phpmqtt_input.php. I started phpmqtt_input direct at the server with sudo but no ampersand. Result at SHH&nbsp;is:-</p>
<p>pi@StudioPiServer ~ $ ps -ef | grep [p]hpmqtt_input<br />
pi@StudioPiServer ~ $ ps -ef | grep [p]hpmqtt_input<br />
root &nbsp; &nbsp; &nbsp;2972 &nbsp;2958 &nbsp;0 09:26 tty1 &nbsp; &nbsp; 00:00:00 sudo php /var/www/emoncms/script &nbsp; &nbsp; &nbsp; &nbsp; s/phpmqtt_input.php<br />
root &nbsp; &nbsp; &nbsp;2973 &nbsp;2972 &nbsp;5 09:26 tty1 &nbsp; &nbsp; 00:00:01 php /var/www/emoncms/scripts/php &nbsp; &nbsp; &nbsp; &nbsp; mqtt_input.php<br />
pi@StudioPiServer ~ $</p>
<p>So a single command seems to cause 2 instances. Can this be a self call in the code somewhere?</p>
<p><strong>However&nbsp;the reboot does result in my second mqtt input showing up in emoncms!</strong></p>
<p>So my conclusion is that emoncms&nbsp;mqtt&nbsp;can be made to work and hopefully will do what I want but the coding has a few issues<span style="line-height: 1.6;">. Out of interest is it the same code used for mqtt when running emonHub?</span></p>
<p><span style="line-height: 1.6;">Yet again thanks for all the help (there needs to be a virtual way we can send real beer or something).</span></p>
<p><span style="line-height: 1.6;">Regards</span></p>
<p><span style="line-height: 1.6;">Ian</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10746"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-s0PI_W7480e8KoNcAeWdO1XEhn-YqKH2bwrKG2Wa8QA" value="form-s0PI_W7480e8KoNcAeWdO1XEhn-YqKH2bwrKG2Wa8QA"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
