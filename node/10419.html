<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10419 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:49:24 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>emonTxV3_4_3Phase_Voltage sketch reporting incorrect values | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>
        <span class="submitted">Submitted by <a href="../user/7723.html" title="View user profile.">daturach</a> on Wed, 01/04/2015 - 10:58</span>
        <div class="content"><p>I have started calibrating the EmonTx using just one phase.<br />
As suggested, I put my 3 CTs on the same phase and adjusted voltage, current and Power factor using a &quot;pure&quot; resistive load.<br />
So far so good.</p>
<p>After a few seconds, I got some&nbsp;values reported as &quot;ovf&quot;. This is not happening all the time. See below for more info.</p>
<pre>
emonTx V3 CT1234 Voltage 3 Phase example
OpenEnergyMonitor.org
Node: 10 Freq: 433Mhz Network: 210
Voltage: 234.28
 Current 1: 0.04 Power 1: -0.07 VA 1: 9.37 PF 1: -0.01
 Current 2: 0.11 Power 2: -1.01 VA 2: 25.30 PF 2: -0.04
 Current 3: 0.06 Power 3: 0.40 VA 3: 13.75 PF 3: 0.03

Voltage: 234.27
 Current 1: 0.04 Power 1: 0.78 VA 1: 8.36 PF 1: 0.09
 Current 2: 0.09 Power 2: -0.39 VA 2: 21.81 PF 2: -0.02
 Current 3: 0.06 Power 3: <strong>ovf </strong>VA 3: 13.06 PF 3: <strong>ovf</strong>

Voltage: 233.81
 Current 1: 0.02 Power 1: 0.37 VA 1: 4.21 PF 1: 0.09
 Current 2: 0.10 Power 2: 3.75 VA 2: 24.28 PF 2: 0.15
 Current 3: 0.06 Power 3: 0.62 VA 3: 14.26 PF 3: 0.04

Voltage: 224.88
 Current 1: 8.25 Power 1: 1841.05 VA 1: 1856.13 PF 1: 0.99
 Current 2: 8.23 Power 2: -919.64 VA 2: 1850.35 PF 2: -0.50
 Current 3: 8.30 Power 3: <strong>ovf</strong> VA 3: 1865.43 PF 3: <strong>ovf</strong>

Voltage: 225.32
 Current 1: 8.05 Power 1: 1799.15 VA 1: 1813.50 PF 1: 0.99
 Current 2: 8.03 Power 2: -907.10 VA 2: 1809.03 PF 2: -0.50
 Current 3: 8.08 Power 3: -911.09 VA 3: 1820.89 PF 3: -0.50

Voltage: 224.98
 Current 1: 8.02 Power 1: 1790.43 VA 1: 1804.50 PF 1: 0.99
 Current 2: 8.00 Power 2: -903.17 VA 2: 1799.96 PF 2: -0.50
 Current 3: 8.06 Power 3: -914.48 VA 3: 1813.90 PF 3: -0.50

Voltage: 225.49
 Current 1: 8.04 Power 1: 1797.78 VA 1: 1811.91 PF 1: 0.99
 Current 2: 8.01 Power 2: -893.13 VA 2: 1807.02 PF 2: -0.49
 Current 3: 8.07 Power 3: <strong>ovf</strong> VA 3: 1819.44 PF 3: <strong>ovf</strong>

Voltage: 225.52
 Current 1: 8.04 Power 1: 1799.86 VA 1: 1813.91 PF 1: 0.99
 Current 2: 8.01 Power 2: -898.48 VA 2: 1807.46 PF 2: -0.50
 Current 3: 8.06 Power 3: -914.16 VA 3: 1817.13 PF 3: -0.50

Voltage: 233.52
 Current 1: 0.21 Power 1: 1.52 VA 1: 49.74 PF 1: 0.03
 Current 2: 0.17 Power 2: 0.93 VA 2: 39.27 PF 2: 0.02
 Current 3: 0.24 Power 3: 0.93 VA 3: 55.83 PF 3: 0.02</pre><p>&nbsp;</p>
<p>I read in this forum it could be a problem with the memory.<br />
Is there anything we can do to fix this?</p>
<p>Thanks for your help.</p>
<p>Walter</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11767.html" class="topic-previous" title="Go to previous forum topic">‹ Unable to register neither login on new installation - [SOLVED]</a>
              <a href="11818.html" class="topic-next" title="Go to next forum topic">Scheduled upload to Emoncms.org? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-29274"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 01/04/2015 - 15:52.</div>
    <div class="content">
     <p>I'm working on it - unfortunately there have been more pressing problems and I have not been able to put as much effort in as I would have liked.<br />
The problems seem to have arisen since JeeLib was expanded to include the RFM69CW radio module.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29279"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7723.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7723.jpg" alt="daturach&#039;s picture" title="daturach&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7723.html" title="View user profile.">daturach</a> on Wed, 01/04/2015 - 19:10.</div>
    <div class="content">
     <p>Thanks Robert</p>
<p>If I&nbsp;can be of any help for testing, just let me know.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29286"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 01/04/2015 - 21:35.</div>
    <div class="content">
     <p>Which radio module do you have - RFM12B or RFM69CW?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29316"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7723.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7723.jpg" alt="daturach&#039;s picture" title="daturach&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7723.html" title="View user profile.">daturach</a> on Thu, 02/04/2015 - 08:13.</div>
    <div class="content">
     <p>RFM12B</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29325"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 02/04/2015 - 09:18.</div>
    <div class="content">
     <p>In that case, I might have a solution. I've thrown out JeeLib and used the low-level SPI commands to operate the RFM12B (courtesy of MartinR's PLL sketch), and mine seems to be OK like that (but I need to do more checks, and there's no watchdog as that's part of JeeLib too). Next task is to do the same for the RFM69CW, but you don't need that (hence the question!)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29331"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7665.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7665.jpg" alt="TimSmall&#039;s picture" title="TimSmall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7665.html" title="View user profile.">TimSmall</a> on Thu, 02/04/2015 - 13:53.</div>
    <div class="content">
     <p>FWIW, I&#39;ve been looking into this too, no conclusions yet, but total memory usage appears to be pretty low, so it&#39;s either not connected with total memory use, or something is causing memory fragmentation (which could only be use of dynamically allocated&nbsp;C++ classes I think). &nbsp;Hopefully I&#39;ll get a chance to look into it a bit more later on today.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29335"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7665.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7665.jpg" alt="TimSmall&#039;s picture" title="TimSmall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7665.html" title="View user profile.">TimSmall</a> on Thu, 02/04/2015 - 15:14.</div>
    <div class="content">
     <p>No hidden allocation from Arduino libs by the look of it, not likely to get any more time to debug today.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29339"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 02/04/2015 - 16:10.</div>
    <div class="content">
     <p>Try this. I have not fully tested it, but then I have only changed the code that called JeeLib. There is no watchdog timer, therefore if the sketch hangs for any reason, it is not likely to recover and will need a manual reset or power-down / power-up.</p>
<p>As it comes, it is set for 868 MHz,&nbsp;though it also appears to work at 433 MHz.</p>
<p>You will want to copy your calibration values from your existing sketch.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29358"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7723.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7723.jpg" alt="daturach&#039;s picture" title="daturach&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7723.html" title="View user profile.">daturach</a> on Fri, 03/04/2015 - 10:29.</div>
    <div class="content">
     <p>Thanks for the sketch.</p>
<p>I have done a few more tests with the following parameters. I have basically changed the RF frequency, disabled CT4 and calibrate:</p>
<pre>
#define RF12_433MHZ

//#define CT4LINE 1 

double Vcal = 244.6;   // Calibration constant for voltage input
double Ical1 = 90.9;   // Calibration constant for current transformer 1
double Ical2 = 90.9;   // Calibration constant for current transformer 2
double Ical3 = 90.9;   // Calibration constant for current transformer 3
double Ical4 = 16.6;   // Calibration constant for current transformer 4
double Phasecal1 = 1.00;  // Calibration constant for phase shift L1
double Phasecal2 = 1.35;  // Calibration constant for phase shift L2
double Phasecal3 = 2.00;  // Calibration constant for phase shift L3
double Phasecal4 = 1.10;  // Calibration constant for phase shift CT 4</pre><p>&nbsp;</p>
<p>I am getting the following log: as you can see, I still have a problem with phase 3 (ovf?)</p>
<pre>
emonTx V3.4 CT1234 Voltage 3 Phase example
OpenEnergyMonitor.org
Node: 10 Freq: 433MHz Network: 210
Voltage: 235.17
 Phase 1: 0.26 A, -0.06 W, 61.30 VA, PF=-0.00
 Phase 2: 0.18 A, 4.13 W, 43.18 VA, PF=0.10
 Phase 3: 1.03 A, -573527.37 W, 243.10 VA, PF=-2359.25

Voltage: 235.09
 Phase 1: 0.20 A, 0.28 W, 48.11 VA, PF=0.01
 Phase 2: 0.10 A, 1.66 W, 22.58 VA, PF=0.07
 Phase 3: 0.79 A, 0.37 W, 186.80 VA, PF=0.00

Voltage: 235.14
 Phase 1: 0.16 A, 0.91 W, 37.89 VA, PF=0.02
 Phase 2: 0.10 A, 0.94 W, 24.58 VA, PF=0.04
 Phase 3: 0.62 A, -87557.59 W, 145.97 VA, PF=-599.85

Voltage: 235.07
 Phase 1: 0.14 A, -0.58 W, 31.95 VA, PF=-0.02
 Phase 2: 0.10 A, 0.64 W, 22.92 VA, PF=0.03
 Phase 3: 0.49 A, 2.04 W, 114.10 VA, PF=0.02

Voltage: 226.98
 Phase 1: 8.34 A, 1878.62 W, 1892.75 VA, PF=0.99
 Phase 2: 8.26 A, -937.68 W, 1875.39 VA, PF=-0.50
 Phase 3: 8.35 A, 43404.50 W, 1894.29 VA, PF=22.91

Voltage: 227.13
 Phase 1: 8.22 A, 1853.80 W, 1868.12 VA, PF=0.99
 Phase 2: 8.17 A, -931.28 W, 1855.10 VA, PF=-0.50
 Phase 3: 8.25 A, 2895922.25 W, 1873.78 VA, PF=1545.50

Voltage: 227.02
 Phase 1: 8.17 A, 1840.15 W, 1854.42 VA, PF=0.99
 Phase 2: 8.10 A, -919.67 W, 1839.48 VA, PF=-0.50
 Phase 3: 8.18 A, 183022.01 W, 1856.11 VA, PF=98.61

Voltage: 226.95
 Phase 1: 8.14 A, 1832.65 W, 1846.83 VA, PF=0.99
 Phase 2: 8.07 A, -922.17 W, 1831.37 VA, PF=-0.50
 Phase 3: 8.15 A, 184728.89 W, 1849.58 VA, PF=99.88

Voltage: 226.99
 Phase 1: 8.11 A, 1827.18 W, 1841.18 VA, PF=0.99
 Phase 2: 8.04 A, -912.86 W, 1826.09 VA, PF=-0.50
 Phase 3: 8.14 A, 3009028.75 W, 1846.66 VA, PF=1629.44

Voltage: 227.25
 Phase 1: 8.11 A, 1829.05 W, 1842.76 VA, PF=0.99
 Phase 2: 8.05 A, -913.08 W, 1828.47 VA, PF=-0.50
 Phase 3: 8.14 A, 188855.96 W, 1848.84 VA, PF=102.15

Voltage: 227.47
 Phase 1: 8.12 A, 1832.36 W, 1846.32 VA, PF=0.99
 Phase 2: 8.04 A, -913.90 W, 1829.82 VA, PF=-0.50
 Phase 3: 8.13 A, 12276179.00 W, 1849.86 VA, PF=6636.27

Voltage: 227.08
 Phase 1: 8.10 A, 1826.06 W, 1840.12 VA, PF=0.99
 Phase 2: 8.04 A, -918.39 W, 1825.26 VA, PF=-0.50
 Phase 3: 8.12 A, 46904.33 W, 1843.67 VA, PF=25.44

Voltage: 227.26
 Phase 1: 8.12 A, 1831.49 W, 1845.37 VA, PF=0.99
 Phase 2: 8.04 A, -913.41 W, 1827.77 VA, PF=-0.50
 Phase 3: 8.14 A, 3077577.75 W, 1849.75 VA, PF=1663.78

Voltage: 235.40
 Phase 1: 0.17 A, 0.20 W, 39.75 VA, PF=0.01
 Phase 2: 0.26 A, 1.68 W, 60.65 VA, PF=0.03
 Phase 3: 0.12 A, 2563.67 W, 28.17 VA, PF=91.02

</pre><p>Note that I&nbsp;haven&#39;t tried to connect EmonTx to the Raspi though RF yet.</p>
<p>I will run a couple of more tests with CT4 enabled even if I don&#39;t need it. I will try to get&nbsp;<br />
Phasecal3&nbsp;below 2.00 because&nbsp;I have reached the upper limit according to the recommendations.</p>
<p>Thanks</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29359"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7723.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7723.jpg" alt="daturach&#039;s picture" title="daturach&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7723.html" title="View user profile.">daturach</a> on Fri, 03/04/2015 - 12:10.</div>
    <div class="content">
     <p>These&nbsp;are&nbsp;the new settings for this test. CT4 <strong>enabled, </strong>PHASE2 and PHASE3&nbsp;changed, calibration done.</p>
<pre>
#define CT4LINE 1
#define PHASE2 6
#define PHASE3 14

double Phasecal1 = 1.00; 
double Phasecal2 = 1.50; 
double Phasecal3 = 1.40; 
double Phasecal4 = 1.10;</pre><p>Log file:</p>
<pre>
emonTx V3.4 CT1234 Voltage 3 Phase example
OpenEnergyMonitor.org
Node: 10 Freq: 433MHz Network: 210
Voltage: 234.87
 Phase 1: 0.25 A, -3.43 W, 58.05 VA, PF=-0.06
 Phase 2: 0.78 A, 3.93 W, 183.88 VA, PF=0.02
 Phase 3: 1.58 A, 6.69 W, 371.47 VA, PF=0.02
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.39
 Phase 1: 8.37 A, 1879.80 W, 1894.68 VA, PF=0.99
 Phase 2: 8.31 A, -938.00 W, 1881.16 VA, PF=-0.50
 Phase 3: 8.42 A, -956.80 W, 1906.86 VA, PF=-0.50
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.34
 Phase 1: 8.28 A, 1859.32 W, 1874.27 VA, PF=0.99
 Phase 2: 8.20 A, -940.03 W, 1856.33 VA, PF=-0.51
 Phase 3: 8.31 A, -935.85 W, 1880.62 VA, PF=-0.50
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.50
 Phase 1: 8.22 A, 1846.19 W, 1860.77 VA, PF=0.99
 Phase 2: 8.15 A, -933.84 W, 1844.88 VA, PF=-0.51
 Phase 3: 8.24 A, -926.17 W, 1865.68 VA, PF=-0.50
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.53
 Phase 1: 8.16 A, 1834.04 W, 1848.49 VA, PF=0.99
 Phase 2: 8.09 A, -930.99 W, 1833.36 VA, PF=-0.51
 Phase 3: 8.19 A, -918.96 W, 1856.11 VA, PF=-0.50
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.39
 Phase 1: 8.12 A, 1825.09 W, 1839.39 VA, PF=0.99
 Phase 2: 8.05 A, -927.96 W, 1823.49 VA, PF=-0.51
 Phase 3: 8.16 A, -912.52 W, 1848.31 VA, PF=-0.49
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.33
 Phase 1: 8.12 A, 1823.74 W, 1837.75 VA, PF=0.99
 Phase 2: 8.04 A, -925.30 W, 1820.50 VA, PF=-0.51
 Phase 3: 8.14 A, -907.65 W, 1841.45 VA, PF=-0.49
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.60
 Phase 1: 8.11 A, 1822.95 W, 1836.86 VA, PF=0.99
 Phase 2: 8.04 A, -919.62 W, 1821.31 VA, PF=-0.50
 Phase 3: 8.14 A, -908.94 W, 1844.91 VA, PF=-0.49
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.27
 Phase 1: 8.09 A, 1816.09 W, 1829.62 VA, PF=0.99
 Phase 2: 8.03 A, -924.53 W, 1816.05 VA, PF=-0.51
 Phase 3: 8.13 A, -899.84 W, 1838.58 VA, PF=-0.49
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.43
 Phase 1: 8.09 A, 1819.09 W, 1832.81 VA, PF=0.99
 Phase 2: 8.03 A, -924.78 W, 1819.30 VA, PF=-0.51
 Phase 3: 8.13 A, -902.39 W, 1840.23 VA, PF=-0.49
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.49
 Phase 1: 8.10 A, 1820.83 W, 1833.93 VA, PF=0.99
 Phase 2: 8.03 A, -925.47 W, 1818.38 VA, PF=-0.51
 Phase 3: 8.12 A, -899.77 W, 1838.00 VA, PF=-0.49
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan

Voltage: 226.45
 Phase 1: 8.10 A, 1820.59 W, 1834.18 VA, PF=0.99
 Phase 2: 8.02 A, -926.46 W, 1816.89 VA, PF=-0.51
 Phase 3: 8.13 A, -901.33 W, 1841.12 VA, PF=-0.49
 Input 4: 0.00 A, 0.00 W, 0.00 VA, PF=nan</pre><p>&nbsp;</p>
<p>Input 4 has been left floating. All in one, it&#39;s looking better.</p>
<p>What do you think?</p>
<p>Thanks</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29362"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 03/04/2015 - 14:45.</div>
    <div class="content">
     <p>I'm afraid I can't reproduce your error with CT4 disabled. I took L3 up to 100 A (>25 kVA indicated due to non-calibration of the voltage) but on the same phase as L1, and there was no hint of corruption.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30231"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="jdpmendes&#039;s picture" title="jdpmendes&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by jdpmendes (not verified) on Sat, 09/05/2015 - 20:43.</div>
    <div class="content">
     <p>Hello all,</p>
<p>I have just started using my new emonTx&nbsp;in three phase from the latest sketch in git and also encountered this issue.</p>
<p>From code analysis, I believe that the issue is the following piece of code:</p>
<blockquote><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Count the number of zero crossings - the first cycle loads the buffer, otherwise it is not used.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lastVCross = checkVCross; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; checkVCross = (sampleV &gt; startV) ? true : false;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (numberOfSamples==1)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lastVCross = checkVCross; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (lastVCross != checkVCross)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crossCount++;</p>
</blockquote>
<p>lastVCross&nbsp;&amp;&nbsp;checkVCross are not initialized, and therefore can be garbage. checkVCross is initialized on the first sampling iteration, but &nbsp;lastVCross is not. This causes the following inequality check to be true, and the&nbsp;crossCount to be wrongly incremented in this iteration. End effect is that only half of the storedV buffer is properly populated, leading to garbage calculations on the phase3.</p>
<p>I believe what was intended,&nbsp;and fixes my issue is:</p>
<blockquote><p><strong>&nbsp; &nbsp; &nbsp; &nbsp; if (numberOfSamples==0)</strong><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastVCross&nbsp;=&nbsp;checkVCross; &nbsp;&nbsp;</p>
</blockquote>
<p>&nbsp;</p>
<p>Cheers,</p>
<p>Jose</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30249"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7665.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7665.jpg" alt="TimSmall&#039;s picture" title="TimSmall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7665.html" title="View user profile.">TimSmall</a> on Sun, 10/05/2015 - 20:14.</div>
    <div class="content">
     <p>FWIW, I have a work-in progress version of the code here:</p>
<p><a href="https://github.com/tim-seoss/emonTxFirmware/blob/master/emonTxShield/Shield_CT1234_3Phase_Voltage/Shield_CT1234_3Phase_Voltage.ino" title="https://github.com/tim-seoss/emonTxFirmware/blob/master/emonTxShield/Shield_CT1234_3Phase_Voltage/Shield_CT1234_3Phase_Voltage.ino">https://github.com/tim-seoss/emonTxFirmware/blob/master/emonTxShield/Shi...</a></p>
<p>... which does a few tidy-ups (and I think would catch that bug too, but other means, but I haven&#39;t looked to check), and also decreased memory usage (which BTW didn&#39;t actually look that bad when I debugged it).</p>
<p>I was thinking of trying a few other changes to this code, including possibly making it into a library (since there are currently multiple versions of it copied across the source tree).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30260"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 11/05/2015 - 16:42.</div>
    <div class="content">
     <p>jdpmendes:</p>
<p>That section was lifted straight out of emonlib, so if that is indeed the problem, it's been present in emonlib for as long as I can remember.</p>
<p>I don't have the time at present to recheck the logic.</p>
<p>TimSmall:<br />
You need to be aware that there are many problems that are inherent in the approach, and it can never achieve a high degree of accuracy because so much depends on external factors that cannot be controlled - the principal ones being the system frequency and the voltage balance between the phases. I did think about making it into a library, but decided it was not worth the effort. If at some stage G&amp;T decide to develop a real 3-phase emonTx (and I think the demand is probably there), then a whole new world opens up. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30265"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7665.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7665.jpg" alt="TimSmall&#039;s picture" title="TimSmall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7665.html" title="View user profile.">TimSmall</a> on Mon, 11/05/2015 - 20:37.</div>
    <div class="content">
     <p>Robert Wall:</p>
<p>&quot;it can never achieve a high degree of accuracy because so much depends on external factors that cannot be controlled - the principal ones being the system frequency and the voltage balance between the phases&quot;</p>
<p>Thanks for the comments.</p>
<p>My assumption (which may be incorrect) is that it&#39;s likely to be accurate to within a couple of percent when used at&nbsp;a site&nbsp;with relatively low supply impedance, and on a relatively stable grid frequency (such as the UK), and nearly always better than just measuring VA.</p>
<p>My feeling is that&#39;s probably&nbsp;good enough for most users and applications (it&#39;s certainly good enough for mine).</p>
<p>I also assume that&nbsp;the preferred solution (given current available kit) would be to use 3 (or more)&nbsp;emonTx, with one AC-AC transformer on each phase?</p>
<p>Given that setting this up&nbsp;will normally require an electrician in (to make the necessary sockets available for all phases, it&#39;d be rare to have them available already I&#39;d think), I assume this will be unappealing to the majority of users.</p>
<p>The same thing would of course go for any new hardware which would require the same changes to the electrical installation.</p>
<p>Given that, I think there&#39;s still merit in working on the existing 3 phase code.</p>
<p>I&#39;ve also been wondering whether any jitter results from the calculations (which would be the case if&nbsp;some calculation steps&nbsp;require variable numbers of clock cycles)? &nbsp;A spare digital output could be pulsed in the code&nbsp;to check this I suppose...</p>
<p>Any thoughts welcome!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30268"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 11/05/2015 - 21:04.</div>
    <div class="content">
     <p><i>My assumption (which may be incorrect) is that it's likely to be accurate to within a couple of percent when used at a site with relatively low supply impedance, and on a relatively stable grid frequency (such as the UK), and nearly always better than just measuring VA.</p>
<p>My feeling is that's probably good enough for most users and applications (it's certainly good enough for mine).</p>
<p>I also assume that the preferred solution (given current available kit) would be to use 3 (or more) emonTx, with one AC-AC transformer on each phase?</i></p>
<p>That would indeed give more accurate results - and the ability to measure more circuits.</p>
<p><i>Given that setting this up will normally require an electrician in (to make the necessary sockets available for all phases, it'd be rare to have them available already I'd think), I assume this will be unappealing to the majority of users.</p>
<p>The same thing would of course go for any new hardware which would require the same changes to the electrical installation.</i></p>
<p>Exactly. But then again, it appears that there are people willing to go to those lengths. Or maybe there's no need to. One alternative to the requirement for a 3-phase supply (or 3 single phases) would be one socket for power and the voltage monitor on phase 1, and capacitive pick-ups on the remaining phases. The snag there is, the capacitive "transformers" require a high impedance buffer amplifier, so it's not a single chip job.</p>
<p><i>Given that, I think there's still merit in working on the existing 3 phase code.</i></p>
<p>As I said, I had intended to clean it up but it wasn't high on the list of priorities as it worked (until JeeLib expanded!). And it appears to work again with the slimmed-down radio code.</p>
<p><i>I've also been wondering whether any jitter results from the calculations (which would be the case if some calculation steps require variable numbers of clock cycles)?  A spare digital output could be pulsed in the code to check this I suppose...</i></p>
<p>Most probably there is. But is it serious? How big is the error compared to all the others? As you said above, a percent or two is good enough for most people, and however bad it is, it's a lot better than guessing the voltage and the power factor, which is what nameless commercial units do.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30269"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 11/05/2015 - 21:08.</div>
    <div class="content">
     <p><i>"My assumption (which may be incorrect) is that it's likely to be accurate to within a couple of percent when used at a site with relatively low supply impedance, and on a relatively stable grid frequency (such as the UK), and nearly always better than just measuring VA.</p>
<p>My feeling is that's probably good enough for most users and applications (it's certainly good enough for mine).</p>
<p>I also assume that the preferred solution (given current available kit) would be to use 3 (or more) emonTx, with one AC-AC transformer on each phase?"</i></p>
<p>That would indeed give more accurate results - and the ability to measure more circuits.</p>
<p><i>"Given that setting this up will normally require an electrician in (to make the necessary sockets available for all phases, it'd be rare to have them available already I'd think), I assume this will be unappealing to the majority of users.</p>
<p>The same thing would of course go for any new hardware which would require the same changes to the electrical installation."</i></p>
<p>Exactly. But then again, it appears that there are people willing to go to those lengths. Or maybe there's no need to. One alternative to the requirement for a 3-phase supply (or 3 single phases) would be one socket for power and the voltage monitor on phase 1, and capacitive pick-ups on the remaining phases. The snag there is, the capacitive "transformers" require a high impedance buffer amplifier, so it's not a single chip job.</p>
<p><i>"Given that, I think there's still merit in working on the existing 3 phase code."</i></p>
<p>I had intended to clean it up but it wasn't high on the list of priorities as it worked (until JeeLib expanded!). And it appears to work again with the slimmed-down radio code.</p>
<p><i>"I've also been wondering whether any jitter results from the calculations (which would be the case if some calculation steps require variable numbers of clock cycles)?  A spare digital output could be pulsed in the code to check this I suppose..."</i></p>
<p>Most probably there is. But is it serious? How big is the error compared to all the others? As you said above, a percent or two is good enough for most people, and however bad it is, it's a lot better than guessing the voltage and the power factor, which is what nameless commercial units do.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30272"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 12/05/2015 - 00:19.</div>
    <div class="content">
     <p><em>That section was lifted straight out of emonlib, so if that is indeed the problem, it&#39;s been present in emonlib for as long as I can remember.</em></p>
<p>But in emonlib:&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</p>
<p>numberOfSamples++; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Count number of times looped. &nbsp;</p>
<p>happens at the beginning of the loop, so comparing it to 1 correctly identifies the first time through.</p>
<p>In the 3-phase sketch, that increment got moved to the end of the loop, so I think Jose&#39;s patch is appropriate. Referencing that unitialised stack variable probably explains why the behaviour is so sensitive to other unrelated changes to the image.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30288"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 12/05/2015 - 19:40.</div>
    <div class="content">
     <p>I NEVER increment a loop at the beginning, and that's why I'd completely missed that. That's always the problem with picking up someone else's code. I still need to find the time to check the logic all the way through.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30638"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 25/05/2015 - 21:15.</div>
    <div class="content">
     <p>We all missed the real bug: On the first cycle, the buffer array was being addressed outside its limits, thus writing rubbish I know not where (but definitely in the wrong place!).</p>
<p>Tim: Don't do any more work for now. I'll let Glyn have the updated version in a few days.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30641"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 26/05/2015 - 00:45.</div>
    <div class="content">
     <p>I must confess to only having&nbsp;a cursory look at the code to review Jose&#39;s patch, &nbsp;and am happy to hand over to someone far one more familiar with it than I am. &nbsp; But isn&#39;t numberOfSamples initialised to zero for the first cycle?</p>
<p>There&#39;s a very good chance I&#39;m looking at the wrong sketch. &nbsp;I&#39;m referring to this one:</p>
<p><a href="https://github.com/openenergymonitor/emonTxFirmware/blob/master/emonTxV3/RFM/emonTxV3.4/emonTxV3_4_3Phase_Voltage/emonTxV3_4_3Phase_Voltage.ino">https://github.com/openenergymonitor/emonTxFirmware/blob/master/emonTxV3/RFM/emonTxV3.4/emonTxV3_4_3Phase_Voltage/emonTxV3_4_3Phase_Voltage.ino</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30958"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 06/06/2015 - 09:48.</div>
    <div class="content">
     <p><em>My assumption (which may be incorrect) is that it&#39;s likely to be accurate to within a couple of percent when used at&nbsp;a site&nbsp;with relatively low supply impedance, and on a relatively stable grid frequency (such as the UK), and nearly always better than just measuring VA.</em></p>
<p>Came across this graph today, which throws some more light (or at least one datapoint) on how well that assumption works in these parts (SE Queensland).</p>
<p><img alt="" src="../sites/default/files/fig18.png" /></p>
<p>Actually the entire report (<a href="https://www.aer.gov.au/sites/default/files/Energex - 29. Power Quality Strategic Plan - October 2014.pdf">https://www.aer.gov.au/sites/default/files/Energex%20-%2029.%20Power%20Quality%20Strategic%20Plan%20-%20October%202014.pdf</a>) is an interesting read and highlights how difficult voltage regulation is. &nbsp; Poor ol&#39; PV cops most of the blame, which for the most part is probably fair, but I think the above graph suggests they&#39;ve got more fundamental problems. &nbsp;It&#39;s the evening peak (long after the sun has gone down), when their phase balance comes off the rails.</p>
<p>I don&#39;t live in Bundamba, but I suspect I live on the local equivalent of the blue phase. &nbsp;I always see my crazy-high voltages during the evening peak. &nbsp;Maybe they&#39;re winding things up so the local equivalent of the&nbsp;Yellow phase doesn&#39;t droop too low, and those of us on the Blue get pushed off the top. &nbsp; I recently added Vpeak&nbsp;tracking to my energy monitor, and my all time record so far is 365.9V &nbsp;(that&#39;s Vpeak,&nbsp;not to be confused with Vrms).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30963"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 06/06/2015 - 12:30.</div>
    <div class="content">
     <p><i>"But isn't numberOfSamples initialised to zero for the first cycle?"</i> Indeed it was, and that was the problem!  I ruefully admit it took me a while to spot it.</p>
<p>Tim: Unfortunately, work has stopped due to other commitments plus having blown up my emonTx V3.4. I was checking the ac adapter power supply, because it was originally designed for the emonTx with a RFM12B radio module, and the higher power demand of the RFM69CW has had a negative effect.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30966"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 06/06/2015 - 14:16.</div>
    <div class="content">
     <p><i>"how well that assumption <strike>works</strike> DOESN'T WORK"</i> &mdash; FTFY.</p>
<p>And given a supply like that, even measuring VA looks to be little better than guesswork, and to obtain any sort of accuracy there's little choice but to have a voltage monitor on each phase.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31131"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7723.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7723.jpg" alt="daturach&#039;s picture" title="daturach&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7723.html" title="View user profile.">daturach</a> on Tue, 09/06/2015 - 20:36.</div>
    <div class="content">
     <p>It has been a while since my last message in this thread. Thanks to those who contributed. I would like to make some comments regarding the accuracy of the sketch I use&nbsp;(the one attached here above).</p>
<p>I checked my energy consumption during one week and compared the value with the company counter. Amazingly, I am off by just 1%. This is just fantastic. There are many factors that contribute to this accuracy:</p>
<ul>
<li>The stability of the grid frequency&nbsp;(see <a href="http://www.swissgrid.ch/swissgrid/en/home/reliability/frequency.html">here</a> for the current values and for some more general info)</li>
<li>The voltage of the 3 phases and their angle (120&deg;)</li>
<li>And last but not least, the sketch itself</li>
</ul>
<p>I have one&nbsp;question:</p>
<p>I use&nbsp;an adaptor that outputs&nbsp;12VAC and would like to power the EmonTx&nbsp;as well. Any surprises with such a voltage?</p>
<p>Thanks</p>
<p>Walter</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31132"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 09/06/2015 - 21:13.</div>
    <div class="content">
     <p>Does your adapter actually output 12 V ac, or is that the stated output? (The reason for the question: When powering the emonTx, the transformer is to all intents under no load, therefore the voltage rise due to regulation must be added to the stated voltage, which is for full load.)<br />
If the output really is 12 V at your normal mains voltage, then you should be OK, even at nominal mains voltage +20%.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31169"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7723.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7723.jpg" alt="daturach&#039;s picture" title="daturach&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7723.html" title="View user profile.">daturach</a> on Wed, 10/06/2015 - 17:16.</div>
    <div class="content">
     <p>The output is around 12 at no load.</p>
<p>One more comment about my setup: I have installed the&nbsp;100&nbsp;A max clip-on CTs. However, the current goes&nbsp;barely above 10 A per phase at max. power which is really for a very short time. So, the CTs are used in the very low range and still the accuracy of the system is pretty high.</p>
<p>Walter</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32353"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7718.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="hanguyen&#039;s picture" title="hanguyen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7718.html" title="View user profile.">hanguyen</a> on Sat, 18/07/2015 - 08:04.</div>
    <div class="content">
     <p>below is my Calibration coefficients, the Irms is correct but some time it show the "ovf" for power Factor. How can i Do to get the correct, i test it with single phase, 3 cts in 1 line. </p>
<p>//These need to be set in order to obtain accurate results<br />
double Vcal = 244.6;                             // Calibration constant for voltage input<br />
double Ical1 = 90.9;                             // Calibration constant for current transformer 1<br />
double Ical2 = 90.9;                             // Calibration constant for current transformer 2<br />
double Ical3 = 90.9;                             // Calibration constant for current transformer 3<br />
double Ical4 = 16.6;                             // Calibration constant for current transformer 4</p>
<p>double Phasecal1 = 1.00;<br />
double Phasecal2 = 1.5;<br />
double Phasecal3 = 1.40;<br />
double Phasecal4 = 1.10;  </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32358"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 18/07/2015 - 10:18.</div>
    <div class="content">
     <p>Are you using V.4 (16/6/2015) of the emonTx V3.4 sketch?<br />
There was an addressing problem in earlier versions that corrupted memory and is probably responsible for the "ovf" error.</p>
<p>Your calibration coefficients are for your setup - they will vary slightly for the particular combination of current and voltage transformer and the 3.3 V regulator and scaling resistors inside your emonTx. As long as they are not a long way from the values we state on the calibration pages, they will be OK. They're no use to anyone else, as their components may differ slightly due to manufacturing tolerances.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32370"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7718.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="hanguyen&#039;s picture" title="hanguyen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7718.html" title="View user profile.">hanguyen</a> on Sat, 18/07/2015 - 14:16.</div>
    <div class="content">
     <p>when i measure 3 phase with emon1,emon2,emon3. it's ok. this mean that i measure 3 single phase 230V ,3 ct lines &amp; sensor voltage. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32866"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7049.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="christophe_meyers&#039;s picture" title="christophe_meyers&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/7049.html" title="View user profile.">christophe_meyers</a> on Fri, 31/07/2015 - 15:53.</div>
    <div class="content">
     <p>Hello all,</p>
<p>Thanks for the previous input above, helped me in fixing the 3-phase issue (I&nbsp;believe).<br />
So here is my logic (inside &#39;<em>calcVI3Ph</em>&#39; function):</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; <strong><em>//-----------------------------------------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; // B) Apply digital high pass filters to remove 2.5V DC offset (to&nbsp;centre&nbsp;wave on 0).<br />
&nbsp; &nbsp; &nbsp; &nbsp; //-----------------------------------------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;offsetV&nbsp;=&nbsp;offsetV&nbsp;+ ((sampleV-offsetV)/1024);<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;filteredV&nbsp;=&nbsp;sampleV&nbsp;-&nbsp;offsetV;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;offsetI1&nbsp;=&nbsp;offsetI1&nbsp;+ ((sampleI1-offsetI1)/1024);<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;filteredI1&nbsp;=&nbsp;sampleI1&nbsp;-&nbsp;offsetI1;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;offsetI2&nbsp;=&nbsp;offsetI2&nbsp;+ ((sampleI2-offsetI2)/1024);<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;filteredI2&nbsp;=&nbsp;sampleI2&nbsp;-&nbsp;offsetI2;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;offsetI3&nbsp;=&nbsp;offsetI3&nbsp;+ ((sampleI3-offsetI3)/1024);<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;filteredI3&nbsp;=&nbsp;sampleI3&nbsp;-&nbsp;offsetI3;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; #ifdef&nbsp;CT4<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;offsetI4&nbsp;=&nbsp;offsetI4&nbsp;+ ((sampleI4-offsetI4)/1024);<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filteredI4&nbsp;=&nbsp;sampleI4&nbsp;-&nbsp;offsetI4;<br />
&nbsp; &nbsp; &nbsp; &nbsp;#endif</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;storedV[ (numberOfSamples%samplesPerCycle) ] =&nbsp;filteredV; &nbsp;// store this voltage sample in circular buffer<br />
​</em></strong></p>
<p><strong><em>&nbsp; &nbsp; &nbsp; &nbsp; //-----------------------------------------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; // C) &nbsp;Find the number of times the voltage has crossed the initial voltage<br />
&nbsp; &nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp; &nbsp;- every 2 crosses we will have sampled 1 wavelength&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; &nbsp; &nbsp;- so this method allows us to sample an integer number of half wavelengths which increases accuracy<br />
&nbsp; &nbsp; &nbsp; &nbsp; // &nbsp; &nbsp; Build&nbsp;storedV&nbsp;array<br />
&nbsp; &nbsp; &nbsp; &nbsp; //----------------------------------------------------------------------------- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</em></strong></p>
<p><strong><em>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;lastVCross&nbsp;=&nbsp;checkVCross; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;checkVCross&nbsp;= (sampleV&nbsp;&gt;&nbsp;startV)? true : false;<br />
&nbsp; &nbsp; &nbsp; &nbsp; if (numberOfSamples==0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;lastVCross&nbsp;=&nbsp;checkVCross; &nbsp; &nbsp;// Initial set for condition below<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; if (lastVCross&nbsp;!=&nbsp;checkVCross)&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;crossCount++;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (crossCount&nbsp;== 0) &nbsp; &nbsp; &nbsp; &nbsp; // Started recording at -2 crossings so that one complete cycle has been stored before accumulating.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;samplesPerCycle&nbsp;=&nbsp;numberOfSamples; &nbsp; &nbsp; //&nbsp;storedV[] size now&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;storedV[0] =&nbsp;filteredV;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;storedV[samplesPerCycle] = 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumV&nbsp;&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI1&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI2&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI3&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI4&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP1&nbsp;= 0; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP2&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP3&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP4&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;numberOfPowerSamples&nbsp;= 0;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; }</em></strong></p>
<p><strong><em>&nbsp; &nbsp; &nbsp; &nbsp; //-----------------------------------------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; // D) Root-mean-square method voltage<br />
&nbsp; &nbsp; &nbsp; &nbsp; //----------------------------------------------------------------------------- &nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumV&nbsp;+=&nbsp;filteredV&nbsp;*&nbsp;filteredV; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// sum += square voltage values</em></strong></p>
<p><strong><em>&nbsp; &nbsp; &nbsp; &nbsp; //-----------------------------------------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; // E) Root-mean-square method current<br />
&nbsp; &nbsp; &nbsp; &nbsp; //----------------------------------------------------------------------------- &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI1&nbsp;+=&nbsp;filteredI1&nbsp;*&nbsp;filteredI1; &nbsp; &nbsp; &nbsp; // sum += square current values<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI2&nbsp;+=&nbsp;filteredI2&nbsp;*&nbsp;filteredI2;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI3&nbsp;+=&nbsp;filteredI3&nbsp;*&nbsp;filteredI3;<br />
#ifdef&nbsp;CT4<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumI4&nbsp;+=&nbsp;filteredI4&nbsp;*&nbsp;filteredI4;<br />
#endif</em></strong></p>
<p><strong><em>&nbsp; &nbsp; &nbsp; &nbsp; //-----------------------------------------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; // F) Phase calibration - for Phase 1: shifts V1 to correct transformer errors<br />
&nbsp; &nbsp; &nbsp; &nbsp; // &nbsp; &nbsp;for phases 2 &amp; 3 delays V1 by 120 degrees &amp; 240 degrees respectively&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; // &nbsp; &nbsp;and shifts for fine adjustment and to correct transformer errors.<br />
&nbsp; &nbsp; &nbsp; &nbsp; //-----------------------------------------------------------------------------&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; if (crossCount&nbsp;&gt;= 0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //compute indexes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V3_current = (numberOfSamples%samplesPerCycle) - round((samplesPerCycle/3)) -&nbsp;PHASE3;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V3_prev&nbsp;= (numberOfSamples%samplesPerCycle) - round((samplesPerCycle/3)) -1 -&nbsp;PHASE3;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V2_current = (numberOfSamples%samplesPerCycle) - round(2*(samplesPerCycle/3)) -&nbsp;PHASE2;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V2_prev&nbsp;= (numberOfSamples%samplesPerCycle) - round(2*(samplesPerCycle/3)) -1 -&nbsp;PHASE2; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (V2_current&lt;0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V2_current +=&nbsp;samplesPerCycle;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (V2_prev&lt;0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V2_prev&nbsp;+=&nbsp;samplesPerCycle;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (V3_current&lt;0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V3_current +=&nbsp;samplesPerCycle;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (V3_prev&lt;0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; V3_prev&nbsp;+=&nbsp;samplesPerCycle;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;phaseShiftedV1&nbsp;=&nbsp;lastFilteredV&nbsp;+&nbsp;Phasecal1&nbsp;* (filteredV&nbsp;-&nbsp;lastFilteredV);<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;phaseShiftedV2&nbsp;=&nbsp;storedV[V2_prev] +&nbsp;Phasecal2&nbsp;* (storedV[V2_current] -&nbsp;storedV[V2_prev]);<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;phaseShiftedV3&nbsp;=&nbsp;storedV[V3_prev] +&nbsp;Phasecal3&nbsp;* (storedV[V3_current] -&nbsp;storedV[V3_prev]);<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; //-----------------------------------------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; // G) Instantaneous power&nbsp;calc<br />
&nbsp; &nbsp; &nbsp; &nbsp; //----------------------------------------------------------------------------- &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP1&nbsp;+=&nbsp;phaseShiftedV1&nbsp;*&nbsp;filteredI1; &nbsp; // Sum &nbsp;+= Instantaneous Power<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP2&nbsp;+=&nbsp;phaseShiftedV2&nbsp;*&nbsp;filteredI2;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP3&nbsp;+=&nbsp;phaseShiftedV3&nbsp;*&nbsp;filteredI3;<br />
#ifdef&nbsp;CT4<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;sumP4&nbsp;+=&nbsp;phaseShiftedV1&nbsp;*&nbsp;filteredI4;<br />
#endif<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;numberOfPowerSamples++; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Count number of times looped for Power averages (reminder: different from counter below)<br />
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;numberOfSamples++; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Count number of times looped. &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; //Serial.print(&quot;looped&nbsp;numberOfSamples: &quot;); Serial.println(numberOfSamples);&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; //Serial.print(&quot;time&nbsp;elasped: &quot;); Serial.println(millis()-start);&nbsp;</em></strong></p>
<p><strong><em>&nbsp; &nbsp; }</em></strong></p>
<p>Logic is as follows:<br />
&nbsp;&nbsp; - <em>storedV[]</em> is set to size 30, just to be on safe side as usually 24-26 samples per cycle<br />
&nbsp;&nbsp; - under section B <em>storedV[]</em> index=&quot;<em>numberOfSamples%samplesPerCycle&quot;</em>&nbsp;is always used for storing new values<br />
&nbsp;&nbsp;- then under section C once &quot;<em>crossCount=0</em>&quot;&nbsp;is reached, last stored value is moved to index=0&nbsp;and removed from current index. This as applying the new value to of &quot;<em>samplesPerCycle&quot;</em> to &quot;<em>numberOfSamples%samplesPerCycle&quot;</em>, will cause the subsequent value&nbsp;to be stored at index=1, as well as the fact that index=&quot;<em>numberOfSamples%samplesPerCycle</em>&quot;&nbsp;will not be used subsequently.<br />
- under section F, &quot;<em>V3_current</em>&quot;, &quot;<em>V3_prev</em>&quot;,&nbsp;&quot;<em>V2_current</em>&quot; &amp; &quot;<em>V2_prev</em>&quot;&nbsp;for phase shifted V2 and V3 are computed. Logic is simply to go back 1/3 or 2/3 of a cycle in the <em>storedV[] </em>array. Fine tuning an extra 1 or 2 array indexes&nbsp;with &quot;<em>PHASE2&quot;</em>&nbsp;&amp; &quot;<em>PHASE3</em>&quot; is possible. Finally in the case negative array indexes are obtained, &quot;<em>samplesPerCycle</em>&quot; is added (simple logic).</p>
<p>So that seems to be it, rethinking the voltage array procedure.<br />
Please let me know if it works for you, as my code&nbsp;surely requires more testing and feedback.</p>
<p>Thanks</p>
<p>Christophe</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-37174"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9046.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Bart&#039;s picture" title="Bart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/9046.html" title="View user profile.">Bart</a> on Fri, 18/12/2015 - 11:52.</div>
    <div class="content">
     <p>I have the same problem and tried to solve it with your code, only an error occurs.</p>
<p>stray \&#39;342\ in program, due to copying from the website. It is I think a&nbsp;character problem, but I can&#39;t find which.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-37181"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: emonTxV3_4_3Phase_Voltage sketch reporting incorrect values</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 18/12/2015 - 14:53.</div>
    <div class="content">
     <p>"copying from the website" How?</p>
<p>You should download the <b>RAW</b> file from GitHub and save that from your browser window, not the first file you first see that has line numbers.</p>
<p>[You really should have started a new thread - your problem is compiling the sketch, not that it gives you wrong values. I've deleted your duplicate post.]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10419"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-mP4hj-Ri57NoUPY31XfquNCLRrDzuD3Gooiusw57ZB4" value="form-mP4hj-Ri57NoUPY31XfquNCLRrDzuD3Gooiusw57ZB4"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/10419 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:49:24 GMT -->
</html>
