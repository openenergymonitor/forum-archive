<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10413 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:32:08 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Double Checking Emon Measurements and speed. | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Double Checking Emon Measurements and speed.</h3>
        <span class="submitted">Submitted by <a href="../user/7815.html" title="View user profile.">officeboy</a> on Mon, 30/03/2015 - 21:35</span>
        <div class="content"><p>Has anyone been able to get their emon to output data similar to an oscilloscope? &nbsp;I know I can&#39;t Serial.print&nbsp;that fast, but I wonder if I were to output a single measurement&nbsp;at a set time like 1ms more than cycle speed. (21ms for 50hz, 17 or 18 for NA 60hz.) &nbsp;I want to compare with an actual Oscope&nbsp;to verify readings are as expected.&nbsp;&nbsp;Does anyone have any experience&nbsp;having done that? &nbsp;I am afraid that my ability to search the forums here hits the snag of too many common words. &nbsp;</p>
<p>Second, I was trying to see if I could report &quot;numberOfSamples&quot;&nbsp;but it seems to be undeclared in this scope, despite my efforts to declare it. &nbsp;Is this A) a useful number for me to see how many times realpower is being calculated? and B, is there a better way?</p>
<p>Details on my project are North American, 120/240 whole house monitoring, aiming for 14 circuits of measurements, and using a spark core as a collection and uploading system. (Kind of like the emon pi shield) .</p>
<p>Since the spark.io unit has a few interesting implementation details I want/need to retrace some development steps from the start to see if I am having any problems. &nbsp; One fun and interesting feature of Spark development is that I can set the output on any Digital or Analog pin so that with a jumper it can be read as an input on another pin. &nbsp;It is an easy way to check that main functions are working. &nbsp;And this can be done while I am at the office and the Core is sitting at home.&nbsp;</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10406.html" class="topic-previous" title="Go to previous forum topic">‹ US 240V circuits</a>
              <a href="10399.html" class="topic-next" title="Go to next forum topic">DC-DC stepUp ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-29210"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 30/03/2015 - 22:55.</div>
    <div class="content">
     <p>I've had no trouble printing numberOfSamples to serial, but you have to customise emonLib to do it, because it's local to calcVI( ). (So if you declared it as a global, you'd have two quite independent variables both called "numberOfSamples".) It's useful to see how many samples per cycle you're actually getting, and that in turn is useful when looking for ways to optimise the calculations. But that's all I've used it for, except that this knowledge is useful for answering forum questions about the sample rate.</p>
<p>Writing a value to an unused analogue output might be useful in some circumstances, but it would naturally slow the code and of course change the numberOfSamples. I'm not an Apple user so I can't comment further about Oscope. But am I missing the point? I can't see the purpose of outputting a quantity (which quantity?) in analogue form at 58.82 Hz. What do you have in mind and why?</p>
<p>Or are you looking for something like <a href="1757.html">Robin's Tools</a>?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29212"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7815.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7815.jpg" alt="officeboy&#039;s picture" title="officeboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/7815.html" title="View user profile.">officeboy</a> on Tue, 31/03/2015 - 05:33.</div>
    <div class="content">
     <p>I got number of samples to display (logging&nbsp;to emoncms), but I wonder if you could help me with the details of its output?</p>
<blockquote><p>//Calculation power values<br />
&nbsp; realPower = V_RATIO * I_RATIO * sumP / numberOfSamples;<br />
&nbsp; apparentPower = Vrms * Irms;<br />
&nbsp; powerFactor=realPower / apparentPower;<br />
&nbsp; //added for testing sample speed.<br />
&nbsp; <u>samp = numberOfSamples;</u></p>
<p>&nbsp; //Reset accumulators</p>
</blockquote>
<p>I grabbed that # of samples (from &quot;Post Loop Calculations&quot;) but no matter the reporting cycle, from&nbsp;2&nbsp;seconds up to 30&nbsp;it just reports back 1484. &nbsp;Maybe I should be grabbing another variable? &nbsp; There is a whole lot of good stuff in Robin&#39;s Tools, thanks for sharing that link.&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29219"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 31/03/2015 - 12:15.</div>
    <div class="content">
     <p>Hmmm. <i>"There is a whole lot of good stuff in Robin's Tools, thanks for sharing that link. "</i> You haven't read the 'stickies' at the top of the forums, have you?</p>
<p>I'm afraid you're all mixed up. The code you quote is from calcVI( ), yet the number of samples you're reading is the fixed value from calcIrms( ). You're looking at the wrong piece of code.</p>
<p>CalcVI( ) calculates the real and apparent powers, rms voltage and current over a fixed number of cycles. CalcIrms( ) calculates the rms current over a fixed number of samples (1480 is the default).</p>
<p>I get 530 or 531 from calcVI( ), which is much closer to the expected value of 53 samples per cycle, and represents 2650 sample pairs per second. That's 188 &mu;s per sample and includes all the per-sample processing.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29226"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7815.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7815.jpg" alt="officeboy&#039;s picture" title="officeboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/7815.html" title="View user profile.">officeboy</a> on Tue, 31/03/2015 - 17:27.</div>
    <div class="content">
     <blockquote><p>I&#39;m afraid you&#39;re all mixed up. The code you quote is from calcVI( ), yet the number of samples you&#39;re reading is the fixed value from calcIrms( ). You&#39;re looking at the wrong piece of code.</p>
</blockquote>
<p>You sure have a sweet way with words. &nbsp;Possibly the code is all mixed up. &nbsp;I am using <a href="https://github.com/Cinezaster/EmonLib">this</a>&nbsp;lib adapted for Spark,&nbsp;and a modified&nbsp;NanodeRF sketch. I am going to start integrating with the emontxV3&nbsp;to try and stay close to the original project. &nbsp;My code is <a href="https://github.com/officeboy/EmonCore">here</a>.</p>
<p>If you notice how the calcIrms&nbsp;Number_of_Samples is leaking into numberOfSamples&nbsp;I would love to hear where that is happening.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29228"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7815.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7815.jpg" alt="officeboy&#039;s picture" title="officeboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/7815.html" title="View user profile.">officeboy</a> on Tue, 31/03/2015 - 17:55.</div>
    <div class="content">
     <blockquote><p>&nbsp;You haven&#39;t read the &#39;stickies&#39; at the top of the forums, have you?</p>
</blockquote>
<p>No, I normally wouldn&#39;t look at much in the general section of a forum. &nbsp;&nbsp;I did find it now and also see that my posts are not showing up so I guess that means I have been flagged for moderation. &nbsp;</p>
<p>*edit - Since this post was not flagged I guess it was the links included in the other post that caused it to be auto flagged.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29230"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 31/03/2015 - 18:53.</div>
    <div class="content">
     <p><i>"If you notice how the calcIrms Number_of_Samples is leaking into numberOfSamples I would love to hear where that is happening."</i></p>
<p>I can't see where that is happening, but at the same time I can't see "samp" either. So I'm not looking at the same code that you posted earlier. So the links to GitHub aren't helping.</p>
<p>But it seems a very strange coincidence that you're reading the number that I would expect at the end of calcIrms( ), when you have calcVI( ) calculating over the same number of cycles as I was and I got 530 sample pairs in 200 ms. 1480 sample pairs tends to imply sampling for 558 ms (assuming the same ADC and clock frequency), and that's a lot more than 10 cycles. Your system frequency would need to be 18 Hz - what is it?</p>
<p>I think you need to write a stripped-down-to-the-bare-minimum sketch to see if you get a sensible number and establish just how many sample pairs you see per cycle. If that's successful, you can start adding bits back and see where the corruption - if indeed that's what it is - is happening. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29233"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7815.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7815.jpg" alt="officeboy&#039;s picture" title="officeboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/7815.html" title="View user profile.">officeboy</a> on Tue, 31/03/2015 - 19:23.</div>
    <div class="content">
     <p>Shoot, I need to add a dev branch to my copy of emonlib for this sort of thing.&nbsp;</p>
<p>I am working with 60hz.&nbsp;</p>
<p>Backing off to almost nothing and then adding thing in bit by bit might be what I have to do. &nbsp;And something I should do as am not clear how things like the PLL work. &nbsp;</p>
<p>Also <a href="http://docs.spark.io/hardware/">different hardware</a> will make things interesting. And is a good reason to break thing back down to bare bones to verify data.</p>
<ul>
<li>ARM 32-bit Cortex&trade;-M3 CPU Core</li>
<li>72Mhz operating frequency, 1.25 DMIPS/MHz (Dhrystone 2.1)</li>
<li>128KB of Flash memory</li>
<li>20KB of SRAM</li>
<li>12 bit ADC</li>
<li>USB 2.0 full-speed interface</li>
<li>USART, SPI and I2C interfaces</li>
</ul>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29235"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7815.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-7815.jpg" alt="officeboy&#039;s picture" title="officeboy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/7815.html" title="View user profile.">officeboy</a> on Tue, 31/03/2015 - 19:45.</div>
    <div class="content">
     <blockquote><p>I can&#39;t see where that is happening, but at the same time I can&#39;t see &quot;samp&quot; either. So I&#39;m not looking at the same code that you posted earlier. So the links to GitHub aren&#39;t helping.</p>
</blockquote>
<p>&nbsp;</p>
<p><a href="https://github.com/officeboy/EmonLib/tree/dev-counts/firmware " title="https://github.com/officeboy/EmonLib/tree/dev-counts/firmware ">https://github.com/officeboy/EmonLib/tree/dev-counts/firmware </a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29236"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Double Checking Emon Measurements and speed.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 31/03/2015 - 19:51.</div>
    <div class="content">
     <p>If you're using (or going to be using) a different processor and ADC, all bets are off regarding speed, etc. The core algorithms will of course work without any serious changes.</p>
<p>But which PLL are you referring to? Neither EmonLib nor the basic demo "DiscreteSampling" sketch, on which I think yours is based, use a PLL. The "continuous monitoring" sketches are interrupt-driven, but that's still not the same thing as a PLL. As far as I'm aware, only "Solar PV power diversion with emonTx using a PLL, emonGLCD and temperature measurement" by Martin Roberts, and its derivatives, use a PLL.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10413"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-Z1-I3hDWqAm4DvxQj8qKgt_W3wHAHS9mDcyeHU_pHew" value="form-Z1-I3hDWqAm4DvxQj8qKgt_W3wHAHS9mDcyeHU_pHew"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
