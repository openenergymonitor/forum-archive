<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10031 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:00:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Questions on MartinR&#039;s PLL sketch | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Questions on MartinR&#039;s PLL sketch</h3>
        <span class="submitted">Submitted by <a href="../user/4575.html" title="View user profile.">ioannamirto</a> on Tue, 20/01/2015 - 12:01</span>
        <div class="content"><p>Hello everybody,</p>
<p>and I&#39;m sorry for creating a topic every time but I can&#39;t see where else I should start this conversation. Also thanks very much for the support until now :)</p>
<p>I started trying to understand MartinR&#39;s PLL sketch in order to monitor voltage and a single-phase voltage. I am trying to clean the code out of the diversion part and try to make sense with the rest of it.</p>
<p>I have some questions until now :</p>
<p>1) What if I want to use the internal reference voltage as used in Emonlib which means calculating V_RATIO every time as follows:</p>
<p>
#define ADC_COUNTS&nbsp; (1&lt;&lt;ADC_BITS)</p>
<p>and then inside calculateVIPF put the following code:</p>
<p>int SUPPLYVOLTAGE = readVcc();<br />
double V_RATIO = VCAL *((SUPPLYVOLTAGE/1000.0) / (ADC_COUNTS));<br />
double I1_RATIO = I1CAL *((SUPPLYVOLTAGE/1000.0) / (ADC_COUNTS));</p>
<p>2) How to I determine I1LEAD?</p>
<p>3) VOLTSPIN 2 means A2 eh?</p>
<p>3)I can&#39;t print my sampleV inside the interrupt so I can&#39;t really check my results. Where should I check it? It doesn&#39;t print even inside updatePLL.</p>
<p>4) I made sendResults a printResults function and for Vrms,Irms,frequency I get</p>
<p>nan nan&nbsp; PLL is unlocked<br />
nan nan&nbsp; PLL is unlocked</p>
<p>Any ideas?(Ok. If I get to print anything I could check it myself too)</p>
<p>I haven&#39;t changed anything inside the code except for the PINS and the diversion part. Maybe that&#39;s also the problem...</p>
<p>Thanks anyway for the feedback :)</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10038.html" class="topic-previous" title="Go to previous forum topic">‹ Barking up the wrong tree ?</a>
              <a href="10049.html" class="topic-next" title="Go to next forum topic">Commercial Off the Shelf Display Solution ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-26890"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 20/01/2015 - 12:17.</div>
    <div class="content">
     <p>Have you read the description of how the sketch works?</p>
<p>If you do NOT want energy diversion, and simply want to understand how the PLL works, then look at <a href="1377.html" title="http://openenergymonitor.org/emon/node/1377">http://openenergymonitor.org/emon/node/1377</a> </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26891"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4575.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4575.png" alt="ioannamirto&#039;s picture" title="ioannamirto&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/4575.html" title="View user profile.">ioannamirto</a> on Tue, 20/01/2015 - 12:22.</div>
    <div class="content">
     <p>yes step by step while reading <a href="http://maxembedded.com/2011/06/the-adc-of-the-avr/">this</a> very nice blog but i still don&#39;t really feel very comfortable with all this.</p>
<p>For example this printing thing, I can&#39;t debug without printing :(</p>
<p>But thanks thanks thanks for the link it seems i could have saved some time...</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><i>[Do not double post. If your post is held for moderation, please wait for it to be attended to.]</i></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26895"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4575.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4575.png" alt="ioannamirto&#039;s picture" title="ioannamirto&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/4575.html" title="View user profile.">ioannamirto</a> on Tue, 20/01/2015 - 14:19.</div>
    <div class="content">
     <p>*and i also don&#39;t understand what the code is doing here:</p>
<p>result = ADCL;<br />
result |= ADCH&lt;&lt;8;</p>
<p>(...)</p>
<p>&nbsp;sampleV = result;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26899"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 20/01/2015 - 17:18.</div>
    <div class="content">
     <p>Those are absolutely standard C language operators. Any moderately good tutorial on the C language will explain. Type "C operators" into your favourite search engine.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26905"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 20/01/2015 - 21:35.</div>
    <div class="content">
     <p>The ADC result is a 10-bit number but the interface to the ADC is through 8-bit registers, so you need to extract the low byte (ADCL) and the high byte (ADCH) and get them into the right place in your 16-bit variable, which is all the above code snippet is doing. &nbsp;</p>
<p>Alternatively, you could let the compiler do the work for you and simply use &quot;ADC&quot;&nbsp;which is the symbol used to indicate the 16-bit result. &nbsp;You can see in the code snippets below, this results in significantly less machine code.</p>
<pre>
uint16_t adc_value;

void setup() {  
  adc_value = ADCL;
  adc_value |= ADCH &lt;&lt; 8;
}

produces:

000000a6 &lt;setup&gt;:
  a6:   80 91 78 00     lds     r24, 0x0078
  aa:   40 91 79 00     lds     r20, 0x0079
  ae:   34 2f           mov     r19, r20
  b0:   20 e0           ldi     r18, 0x00       ; 0
  b2:   90 e0           ldi     r25, 0x00       ; 0
  b4:   28 2b           or      r18, r24
  b6:   39 2b           or      r19, r25
  b8:   30 93 01 01     sts     0x0101, r19
  bc:   20 93 00 01     sts     0x0100, r18
  c0:   08 95           ret

</pre><p>while</p>
<pre>

uint16_t adc_value;

void setup() {  
  adc_value = ADC;
}

produces:

000000a6 &lt;setup&gt;:
  a6:    80 91 78 00    lds     r24, 0x0078
  aa:    90 91 79 00    lds     r25, 0x0079
  ae:    90 93 01 01    sts     0x0101, r25
  b2:    80 93 00 01    sts     0x0100, r24
  b6:    08 95          ret

</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26909"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Tue, 20/01/2015 - 23:22.</div>
    <div class="content">
     <p><em>The ADC result is a 10-bit number but the interface to the ADC is through 8-bit registers, so you need to extract the low byte (ADCL) and the high byte (ADCH) and get them into the right place in your 16-bit variable, which is all the above code snippet is doing. &nbsp;</em></p>
<p>&nbsp;</p>
<p>dBC,</p>
<p>Thanks for the explanation and the comparison. As an Electronics Tech, my specialty is hardware, so my C skills are not much more than beginner. Your answer helped me a lot.</p>
<p>Thanks again,</p>
<p>Bill</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26920"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4575.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4575.png" alt="ioannamirto&#039;s picture" title="ioannamirto&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/4575.html" title="View user profile.">ioannamirto</a> on Wed, 21/01/2015 - 12:01.</div>
    <div class="content">
     <p>dBC,</p>
<p>oh thaaaank you very much !</p>
<p>I both got it and changed it :)</p>
<p>&nbsp;</p>
<p>Robin,</p>
<p>thanks too, i promise i have worked a lot till now (i haven&#39;t done anything with c for the last 5 years so it&#39;s pretty chinese at this level)</p>
<p>Anyways I still get :</p>
<p>nan nan PLL is unlocked</p>
<p>The code that you gave me is working and the main difference I found was that part because it reads the result not with the ADC but with&nbsp;analogRead.</p>
<p>So ... still trying to find what is the useful thing I accidentally erased :)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26978"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5612.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Geoff Soord&#039;s picture" title="Geoff Soord&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/5612.html" title="View user profile.">Geoff Soord</a> on Thu, 22/01/2015 - 09:29.</div>
    <div class="content">
     <p>Surely less code is better? Is there any reason by reading the high and low values is preferred over the single read? It is like this for older processors as the assembler instructions that do the actual read, IMO, look the same.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26985"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 22/01/2015 - 10:24.</div>
    <div class="content">
     <p>As I understand it, "analogRead" does much more than just transfer the values from the registers, that is unnecessary in this case. Speed is of the essence, which is why Martin did it the way he did. Maybe he didn't realise the 16-bit instruction existed.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-26994"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 22/01/2015 - 11:54.</div>
    <div class="content">
     <p>analogRead() programs up the MUX, initiates a conversion, waits for the conversion to finish (typically about 110usecs with the most common clock settings), then fetches and returns the result. &nbsp;It offers a completely synchronous interface to the ADC&nbsp;which is simple to understand&nbsp;but incredibly wasteful of clock cycles. &nbsp;The CPU does nothing useful for the entire duration of the conversion.</p>
<p>The snippet of code above merely fetches the result of a previously completed conversion. &nbsp;It takes just a handful of instructions, &nbsp;and an even&nbsp;smaller handful if you use the 16-bit symbol rather than the two 8-bit symbols.</p>
<p>So it&#39;s not just that analogRead() does unnecessary stuff, it does destructive stuff if the results of a previous conversion were sitting there waiting to be fetched. &nbsp;By the time analogRead() returns, the results of the previous conversion will be lost forever and replaced by a whole new conversion.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27004"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 22/01/2015 - 13:10.</div>
    <div class="content">
     <p>I think the whole point, which ioannamirto might have missed, is that towards the end of the Interrupt Service Routine, it sets the next input and starts the next conversion, then returns control to the main loop, which continues doing the things it does. When the conversion is complete 110 &mu;s later, an interrupt is triggered, the main loop stops where it happens to be, and the ISR takes over, collects the data from the just-completed conversion and puts it where the main loop can reach it, then sets the next input etc. </p>
<p>[Edit: I have just checked - this <b>is</b> in Part 4 of the article about Martin's controller.]</p>
<p>Doing analogRead means that 110 &mu;s of processing time is lost for each reading, and it is not possible to read samples continuously and send data by radio etc.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27008"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5612.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Geoff Soord&#039;s picture" title="Geoff Soord&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Questions on MartinR's PLL sketch</h3>

    <div class="submitted">Submitted by <a href="../user/5612.html" title="View user profile.">Geoff Soord</a> on Thu, 22/01/2015 - 14:04.</div>
    <div class="content">
     <p>I agree with your comments Robert. I did not know a single read existed. The timing is controlled by the ISR.&nbsp;</p>
<p>I have seen the common pattern of reading high and low in several sketches perhaps for the same reason. If there are no negative effects for a single read then surely this is better use of code.</p>
<p>But I am still a novice when it comes to Arduino.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10031"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-9W9Dx-MBac7X_l_VuPLhwEVxVGOb4hzECW4xXypwZx4" value="form-9W9Dx-MBac7X_l_VuPLhwEVxVGOb4hzECW4xXypwZx4"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
