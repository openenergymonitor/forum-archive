<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1683 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:23:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Trying to make the emontx shield working... | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Trying to make the emontx shield working...</h3>
        <span class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Mon, 17/12/2012 - 23:01</span>
        <div class="content"><p>Having built several emon.... boards i am only now starting to hit my head to the brick wall. No clue how to make the emontx shield working ?arduino uno programs well,have ct1 jack installed and no rfbm12 installed -all components double checked but does not read CT voltage. Any hints ???</p>
  <div class="forum-topic-navigation clear-block">
          <a href="1705.html" class="topic-previous" title="Go to previous forum topic">‹ Tracking DC-offset using lobe timing instead of HPF</a>
              <a href="1721.html" class="topic-next" title="Go to next forum topic">Arduino Mega 2560 + Wiznet w5100 based Arduino shield ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-8318"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 18/12/2012 - 00:23.</div>
    <div class="content">
     <p>Hints:</p>
<ol>
<li>
		Check your assembly - component values, orientation of polarised components once more.</li>
<li>
		Check you have the correct sketch.</li>
<li>
		Check your voltages. Do you have approx 2.5 V d.c. on the positive end of C10? Do you read the same voltage on the Arduino IO ADC0 (ATMega pin 23 I believe)? Do you read approx 1 V a.c across R14?</li>
</ol>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8425"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Wed, 19/12/2012 - 18:10.</div>
    <div class="content">
     <p>Ah... find the problem. I am trying to measure AD0 and AD5 using analogRead. This seems to mess up the emonlib somehow making the readings inconsistent.</p>
<p>Need a hint here how to read AD0 and AD5 (AD0 disconnected from Vrms circuit). The need behind this is to read the LifePO4 battery voltage and current for battery management.</p>
<p>currentB = (float)((10*5*analogRead(current_AD)/256)*(5/Vcc))-100;<br />
	voltageB = (float)10*analogRead(voltage_AD)/256;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8445"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1994.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="RobertK&#039;s picture" title="RobertK&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1994.html" title="View user profile.">RobertK</a> on Wed, 19/12/2012 - 23:33.</div>
    <div class="content">
     <p>You say you are trying to use emonLib? emonLib does not include support for the emonTx shield. If you look at the place where the pin numbers are substituted for channel numbers, you will see 3 only:</p>
<div class="line rteindent1" id="LC46">
<div class="line" id="LC39">
		<span class="kt">void</span> <span class="n">EnergyMonitor</span><span class="o">::</span><span class="n">voltageTX</span><span class="p">(</span><span class="kt">double</span> <span class="n">_VCAL</span><span class="p">,</span> <span class="kt">double</span> <span class="n">_PHASECAL</span><span class="p">)</span></div>
<div class="line" id="LC40">
		<span class="p">{</span></div>
<div class="line" id="LC41">
		&nbsp;&nbsp;&nbsp;<span class="n">inPinV</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span></div>
<div class="line" id="LC42">
		&nbsp;&nbsp;&nbsp;<span class="n">VCAL</span> <span class="o">=</span> <span class="n">_VCAL</span><span class="p">;</span></div>
<div class="line" id="LC43">
		&nbsp;&nbsp;&nbsp;<span class="n">PHASECAL</span> <span class="o">=</span> <span class="n">_PHASECAL</span><span class="p">;</span></div>
<div class="line" id="LC44">
		<span class="p">}</span></div>
<div class="line" id="LC45">
		&nbsp;</div>
<div class="line" id="LC46">
		&nbsp;</div>
<p>	<span class="kt">void</span> <span class="n">EnergyMonitor</span><span class="o">::</span><span class="n">currentTX</span><span class="p">(</span><span class="kt">int</span> <span class="n">_channel</span><span class="p">,</span> <span class="kt">double</span> <span class="n">_ICAL</span><span class="p">)</span></div>
<div class="line rteindent1" id="LC47">
	<span class="p">{</span></div>
<div class="line rteindent1" id="LC48">
	&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">inPinI</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span></div>
<div class="line rteindent1" id="LC49">
	&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">_channel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">inPinI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div>
<div class="line rteindent1" id="LC50">
	&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">_channel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">inPinI</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></div>
<div class="line rteindent1" id="LC51">
	&nbsp;&nbsp;&nbsp;<span class="n">ICAL</span> <span class="o">=</span> <span class="n">_ICAL</span><span class="p">;</span></div>
<div class="line rteindent1" id="LC52">
	<span class="p">}</span></div>
<div class="line rteindent1">
	&nbsp;</div>
<div class="line">
	Then when you compare the circuit diagrams:</div>
<div class="line">
	&nbsp;</div>
<div class="line">
<table border="1" cellpadding="1" cellspacing="1" height="123" width="432">
<thead>
<tr>
<th scope="col">
					&nbsp;Channel</th>
<th scope="col" style="width: 164px;">
					EmonTx input</th>
<th scope="col" style="width: 134px;">
					Shield input</th>
</tr>
</thead>
<tbody>
<tr>
<td>
					C.T. 1</td>
<td style="width: 164px;">
					ADC 3</td>
<td style="width: 134px;">
					ADC 1</td>
</tr>
<tr>
<td>
					C.T. 2</td>
<td style="width: 164px;">
					ADC 0</td>
<td style="width: 134px;">
					ADC 2</td>
</tr>
<tr>
<td>
					C.T. 3</td>
<td style="width: 164px;">
					ADC 1</td>
<td style="width: 134px;">
					ADC 3</td>
</tr>
<tr>
<td>
					C.T. 4</td>
<td style="width: 164px;">
					&nbsp;&nbsp; -</td>
<td style="width: 134px;">
					ADC 4</td>
</tr>
<tr>
<td>
					Voltage</td>
<td style="width: 164px;">
					ADC 2</td>
<td style="width: 134px;">
					ADC 5</td>
</tr>
</tbody>
</table>
</div>
<p>You need to change your copy of emonLib (and call it by a different name!). If you look at the code and the table, all should become clear.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8492"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Thu, 20/12/2012 - 14:37.</div>
    <div class="content">
     <p>Try using the emonTxShield examples that are in the enonTx&nbsp;repository, they have got the emonTxShield pin mappings and correct calibration built in: <a href="https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTxShield" title="https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTxShield">https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTxSh...</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8494"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Thu, 20/12/2012 - 15:05.</div>
    <div class="content">
     <p>Thanks chaps - i guess we are now talking about different things. A) got emonshield working after removing analogRead() from my code, B) can not find a way to use analogRead(5) when emonlib is running. Using analogRead() inside void() makes emonlib unstable with inconsistent readings. Need analogread to be able to measure battery voltage and current. Please advice how to use analogRead() with emonlib ???</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8500"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 20/12/2012 - 16:37.</div>
    <div class="content">
     <p>I don&#39;t understand your problem. What do you mean by void( )?&nbsp; &quot;void&quot; defines the return type of a function. You cannot <strong>name</strong> a function &quot;void&quot;. I don&#39;t know which compiler you are using, mine complains if you try.</p>
<p>I need to see your code, because there should be no reason why you cannot read an analogue input independently of the calls to the library methods.</p>
<p>You aren&#39;t trying to use a c.t. input to measure battery current, are you?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8511"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Thu, 20/12/2012 - 20:50.</div>
    <div class="content">
     <p><em>In a way I am trying to use emonlib Vcc input (ad direct connection to AD0) and the free AD port 5 to read analog data (The Vcc input is disconnected on PCB). </em></p>
<p><em>I can make the emonshield work as a standalone and give reliable CT1 values. Also the can read the battery voltage (using a voltage divider) and current (using ACS758 chip) using normal arduino uno script. </em></p>
<p><em>When adding analogRead(0) or analogRead(5) to void loop() (which we used to call main() some 20 years ago) it all becomes a bit of a mess.</em></p>
<p><em>You can try the same by just adding any analogRead(5) to the void loop() and check what happens to the output of the ct1.calcIrms(1480) function and what the analogRead(5) returns compared to when these two are run in different scripts. Something odd happens when putting analogRead() to the emontx script.</em></p>
<p><strong><em>I must be doing something wrong...????</em></strong></p>
<p><em>Basically the code is...</em></p>
<p><em>#define FILTERSETTLETIME 5000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; Time (ms) to allow the filters to settle before sending data<br />
	const int CT1 = 1;<br />
	const int CT2 = 0;</em></p>
<p><em>...</em></p>
<p><em>void setup()</em><br />
	<em>{</em><br />
	<em>if (CT1) ct1.current(1, 111.1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Setup emonTX CT channel (channel, calibration)<br />
	if (CT2) ct2.current(2, 111.1);</em></p>
<p><em>...</em></p>
<p><em>void loop()<br />
	{</em><br />
	<em>&nbsp;&nbsp;&nbsp;&nbsp; if (CT1)&nbsp;emontx.power1 = ct1.calcIrms(1480) * 240.0;</em><br />
	&nbsp;</p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp; //<br />
	&nbsp;&nbsp;&nbsp; // Read battery voltage and current<br />
	&nbsp;&nbsp;&nbsp; //<br />
	&nbsp;&nbsp;&nbsp; currentB = (float)((10*5*analogRead(0)/256)*(5/Vcc_psu))-100;<br />
	&nbsp;&nbsp;&nbsp; voltageB = (float)10*analogRead(5)/256;<br />
	&nbsp;&nbsp;&nbsp; delay(10);</em><br />
	&nbsp;</p>
<p><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.println();<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(&quot;V=&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(voltageB,1);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(&quot;&nbsp;&nbsp; A=&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(currentB,1);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(&quot;&nbsp;&nbsp; W=&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(voltageB*currentB,0);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(&quot;&nbsp;&nbsp; CT1=&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(emontx.power1);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.println();</em></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8516"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 20/12/2012 - 23:02.</div>
    <div class="content">
     <p>Can you attach the<em> whole </em>sketch as a file please?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8521"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Fri, 21/12/2012 - 07:29.</div>
    <div class="content">
     <p>Will - do, posting the code when at the desktop.</p>
<p>What I gather about the problem is that there is not adequate time for the port to settle between changing the ports as what I read the analog read is really first setting multiplexer and then reading the port. According to some articles reading the analog port twice settles this problem. Anyway as there does not seem to be a way to control when the CTx analog reads within emonlib&nbsp;are happening dont know how to test if it is this analog port multiplexing problem that needs fixing or if its something else.</p>
<p>Anyone else ever trying tying to read other analog values&nbsp;than Vcc and CTx ?</p>
<p>Just a thought.</p>
<p><a href="http://www.adafruit.com/blog/2010/01/29/how-to-multiplex-analog-readings-what-can-go-wrong-with-high-impedance-sensors-and-how-to-fix-it/">http://www.adafruit.com/blog/2010/01/29/how-to-multiplex-analog-readings-what-can-go-wrong-with-high-impedance-sensors-and-how-to-fix-it/</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8525"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Fri, 21/12/2012 - 09:27.</div>
    <div class="content">
     <p>Attached is one version of the code which has been used for testing.</p>
<p>If the analogRead:s are commented out the CT1 information looks consistent (within AD converter tolerance). If and when analogRead:s are uncommented/active the CT1 information is messed up.</p>
<p>Note: On emonTx shield the path to AC voltage circuit is cut for analogRead(0), so its not a hw issue.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8542"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 21/12/2012 - 16:15.</div>
    <div class="content">
     <p>You needed to tick &quot;List&quot; when you attached the file.</p>
<p><img alt="" src="data:image/png;base64,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" /></p>
<p>&nbsp;</p>
<p>We have identified a hardware problem that only (I think) occurs with the &#39;floating&#39; c.t. as in the emonTx and the emonTx shield (but not in the SMT emonTx) where the sample &amp; hold capacitor acts as a <a href="1385.html#comment-7525">charge pump</a> and transfers charge from one input to the next via the multiplexer. The effect is very small, however.</p>
<p>There is a known problem when changing the voltage reference for the ADC converter, which requires a delay to allow it to settle, but you are not doing that.</p>
<p>The link to the comment about high impedance sensors only repeats the warning in the Atmel data sheet. If your voltage divider resistors are sensible values, I cannot see that being your problem, if the smaller is &gt;100 kOhms, it might be worth reducing them. The current sensor output is surely a low impedance source (unless you have a high value series resistor in the low-pass output filter), so again that is unlikely to be the problem.</p>
<p>You are using the latest emonLib?</p>
<p>I can&#39;t see a problem with your code. I&#39;m using a standard emonTx, and I cannot reproduce your fault. I have run your sketch (but with the battery voltage check in emontx_lib - emontx_sleep commented out) and the readings are unchanging, I cannot see any change in CT1 whether ADC5 is being read or not, and what value it is reading, 0, 20 V or 40 V (corresponding to 0 V, 1.65 V or 3.3 V on the input pin)..</p>
<p>Then I tried a minimal sketch only reading the two inputs direct and the c.t. via the library. Again, I see the same numbers for CT1&nbsp; whether ADC5 is being read or not.</p>
<p>I&#39;m afraid I can&#39;t see what your problem is.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8557"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Fri, 21/12/2012 - 17:47.</div>
    <div class="content">
     <p>Found a solution, the whole use of emonlib and analogRead must be turned to be timer controlled instead of using the main loop. <em>Attached a working script </em>which is not elegant by any means, but it works without reading fluctuation.</p>
<p>Figuring this out made me think that is there a bug in how emonlib is built. Its a continuous loop making measurement cycles somewhat variable if there are components added that slows the process down like analogRead(). <strong>Looks like how the current design how emonlib usage is generally used makes it vulnerable for timing issues.</strong> This is a worrying discovery.</p>
<p>Would appreciate any comments about the above finding.</p>
<p>EDIT - just saw R.W.:s answer. This made me think that we have differences in the libraries we use promoting timing issues somehow. How to check that ?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8575"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 21/12/2012 - 23:13.</div>
    <div class="content">
     <p>The method you are using in emonLib counts a fixed number of cycles (that you define in the call) and returns the rms current measured over that period. This was clearly intended for the battery-powered emonTx, which is then put into low-power sleep mode for 5 s until the current is sampled again.</p>
<p>I think the problem is that you did not understand how the library works, and you were attempting to use it in a way that was not intended.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8579"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Sat, 22/12/2012 - 04:18.</div>
    <div class="content">
     <p>&nbsp;</p>
<p>RW, referring to my incompetence, could you (or someone) describe how emonlib is intended to be used in case one wants to use the same script for both emonlib energy monitoring and analogread for third party devices ???</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8598"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 22/12/2012 - 13:20.</div>
    <div class="content">
     <p>Petri,</p>
<p>Not getting into the brain of the designer, or not knowing the history of a device or a development, doesn&#39;t amount to incompetence in my book, it could be for the very simple reason that you didn&#39;t have the time. I didn&#39;t say you were incompetent, so there&#39;s no need to get agitated.</p>
<p>For the record, I agree that documentation is lacking in some areas, and over the months that I have been involved here, I have been trying to address that problem. If you see any areas that you think need attention that I haven&#39;t spotted, feel free to draw it to my attention.</p>
<p>I think I&#39;ve addressed the question of how emonLib was intended to be used. There are many current threads discussing timed and interrupt-driven methods of reading the analogue inputs, and you must be aware of these.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8601"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Sat, 22/12/2012 - 13:45.</div>
    <div class="content">
     <p>No offence taken or given. Just would like to know how this is designed to work for the above mentioned setup ? What version of libraries are latest ? Any sample scripts using emonlib and analogRead ? Sorry but lost here (and really feel incompetent for this subject ;-) - what threads, did not found when tried searching ?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8610"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 22/12/2012 - 14:57.</div>
    <div class="content">
     <p>The original emonTx was designed to be powered by battery or mains. I believe the battery version came first. When mains powered, an AC-AC adapter can be used to monitor the mains voltage and derive an accurate measure of power, real and apparent. If battery operation is required, only current is sensed and an estimate of power based on the usual supply voltage is transmitted. In this case, battery life is important so the software reads a defined number of samples, calculates the rms current over that period and transmits the result. The software then sleeps the processor in low-power mode for 5 seconds. When the voltage input and true power calculations were added, and I suspect partly also to minimise use of the R.F. channel (which has a limitation that each transmitter can broadcast for not more than 1% of the time), the same algorithm was retained, except that the period is defined in complete mains cycles.<br />
	Thus, when you call any of the emonLib functions to read current or power, you are reading the average over a period of several cycles.</p>
<p>I don&#39;t know which library versions are latest - I&#39;ve been pressing for a version control system to be introduced for some time, but it appears to be low on the priority list. I have TortoiseGit installed and simply &quot;pull&quot; regularly.</p>
<p>There are currently two designs &#39;live&#39; that do things differently (and don&#39;t use emonLib). There is Calypos_rae&#39;s Mk2 (<a href="841.html" title="http://openenergymonitor.org/emon/node/841">http://openenergymonitor.org/emon/node/841</a>) and its successor the Mk2a&nbsp; (<a href="1681-2.html" title="http://openenergymonitor.org/emon/node/1681">http://openenergymonitor.org/emon/node/1681</a>) and MartinR&#39;s Phase-locked loop (<a href="1535.html" title="http://openenergymonitor.org/emon/node/1535">http://openenergymonitor.org/emon/node/1535</a>). Both have spawned variants that extend the original idea, Series530&#39;s &quot;Fusion&quot; (<a href="1103.html" title="http://openenergymonitor.org/emon/node/1103">http://openenergymonitor.org/emon/node/1103</a>) amongst them.&nbsp; These monitor the power continuously, sampling the mains upwards of 40 times per cycle. From the code you posted, these might be more applicable to your application.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8615"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Sat, 22/12/2012 - 15:43.</div>
    <div class="content">
     <p>Excellent - thank you, now understanding the history all this starts to make sense how code was intended to be used - disabling the sleep period is not enough, need to look the core concept too. Looks like I have a lot of code reading to be done to get my own project to the correct route. While talking about the solar my 1-wire network for heatpump monitoring just collapsed so I guess fixing the wiring and reinstalling sensors is priority during coming days.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8662"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Sun, 23/12/2012 - 18:05.</div>
    <div class="content">
     <p>Here is what I tested today using the sample voltage current script. <em>Would be enclined to say that the timer based reading seems to be more accurate than using standard sample script (even without using the analogRead at all).</em> The load is a normal lightbulb which should not vary much, voltage tested with multimeter is stable like when using the timer base script. This is the baseline in defining how to move forward.</p>
<p>What makes me curious though is that RW said he did not have variances to the readings when introducing analogRead() to the standard script ? Anyone else capable of validating the accuracy improvement when using timers ?</p>
<p>My emonlib is now about a month old and using Arduino 1.0.1.</p>
<p><strong>1. Standard script</strong></p>
<pre>
void loop()
{
  emon1.calcVI(20,2000);         // Calculate all. No.of half wavelengths (crossings), time-out
  emon1.serialprint();           // Print out all variables
// Serial.print(analogRead(5));
}

rP=89.93 aP=91.06 Vrms=227.32 Irms=0.40 PF=0.99
rP=93.49 aP=94.59 Vrms=229.48 Irms=0.41 PF=0.99
rP=90.84 aP=91.92 Vrms=227.95 Irms=0.40 PF=0.99
rP=92.25 aP=93.45 Vrms=229.53 Irms=0.41 PF=0.99
rP=90.40 aP=91.53 Vrms=227.44 Irms=0.40 PF=0.99
rP=92.17 aP=93.37 Vrms=229.64 Irms=0.41 PF=0.99
rP=89.97 aP=91.11 Vrms=227.34 Irms=0.40 PF=0.99
rP=92.48 aP=93.76 Vrms=229.42 Irms=0.41 PF=0.99
rP=90.91 aP=92.04 Vrms=227.71 Irms=0.40 PF=0.99
</pre><p><strong>2. Standard script with analogRead() included&nbsp;- produces serious amount of variance and not useable</strong></p>
<pre>
void loop()
{
  emon1.calcVI(20,2000);         // Calculate all. No.of half wavelengths (crossings), time-out
  emon1.serialprint();           // Print out all variables
  Serial.print(analogRead(5));
}

488rP=93.51 aP=94.69 Vrms=230.17 Irms=0.41 PF=0.99
430rP=133.23 aP=135.03 Vrms=275.63 Irms=0.49 PF=0.99
507rP=87.82 aP=88.98 Vrms=221.76 Irms=0.40 PF=0.99
433rP=132.20 aP=134.04 Vrms=274.31 Irms=0.49 PF=0.99
500rP=89.92 aP=91.11 Vrms=225.24 Irms=0.40 PF=0.99
433rP=131.14 aP=132.80 Vrms=273.70 Irms=0.49 PF=0.99
500rP=91.08 aP=92.19 Vrms=225.17 Irms=0.41 PF=0.99
430rP=132.15 aP=133.87 Vrms=275.47 Irms=0.49 PF=0.99
497rP=89.71 aP=90.99 Vrms=225.82 Irms=0.40 PF=0.99</pre><p><strong>3. Modified he emon.calcVI to be called on regular intervals using a timer and when analogRead() is running disabled using emon.calcVI. </strong>(Script attached, using a spare 9V AC supply for testing which outputs &#39;only&#39; 9.6VAC so thats different conmpared what you others may have. Also ports are for emonshield not for emonTX.) There is an odd Irms reading fluctuation/error there which dont undestand where it comes from - and it does not seem to affect rP and aP readings at all ?</p>
<pre>
//
// Timer interrupt based call to emonlib to calculate VI.
//
ISR(TIMER2_OVF_vect) {

    if(!timeractive)
    {
    timeractive=0xFF;
    TCCR2B = 0x00;
   
    emon1.calcVI(20,2000);         // Calculate all. No.of half wavelengths (crossings), time-out

    TCNT2 = 130;    
    TIFR2 = 0x00;  
    timeractive=0x00;
    TCCR2B = 0x07;
    }

   
};

void loop()
{
  emon1.serialprint();           // Print out all variables
     if (!timeractive)
    {
      TCCR2B = 0x00;
      Serial.print(analogRead(5));
      TCCR2B = 0x07;
    }
}

418rP=94.42 aP=95.38 Vrms=228.31 Irms=0.42 PF=0.99
361rP=94.11 aP=95.06 Vrms=228.62 Irms=0.42 PF=0.99
368rP=94.92 aP=95.87 Vrms=227.81 Irms=0.42 PF=0.99
367rP=93.89 aP=94.88 Vrms=226.88 Irms=0.53 PF=0.99
412rP=93.93 aP=94.88 Vrms=227.82 Irms=0.42 PF=0.99
425rP=94.26 aP=95.23 Vrms=227.60 Irms=0.42 PF=0.99
427rP=94.47 aP=95.40 Vrms=227.44 Irms=0.42 PF=0.99
378rP=93.40 aP=94.43 Vrms=227.29 Irms=0.42 PF=0.99
356rP=94.62 aP=95.55 Vrms=227.33 Irms=0.42 PF=0.99</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8667"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sun, 23/12/2012 - 18:50.</div>
    <div class="content">
     <p>I don&#39;t understand what you are trying to do there Petrik. You have an 8ms timer interrupt but you call emon1.calcVI() for 20 half cycles which will take 200ms inside the interrupt. This will just block other interrupts for 200ms.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8675"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1747.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1747.jpg" alt="Petrik&#039;s picture" title="Petrik&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1747.html" title="View user profile.">Petrik</a> on Sun, 23/12/2012 - 22:23.</div>
    <div class="content">
     <p>Havent had time yet to check how long the calculations take. My aim is simple want to be able to use analogRead() for measuring PV voltage and PV current. Using the standard emon library it does not work in my setup. Readings are inconsistent and even stanard methods promote variance. Need to look for altenative approach, using timer is one.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8678"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Trying to make the emontx shield working...</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sun, 23/12/2012 - 23:41.</div>
    <div class="content">
     <p>the calcualtion is 20 x 10ms = 200ms</p>
<p>Your problem may be the print statements, which use interrupts, interfering with the I/V sampling. Try putting a delay in the loop after the prints.</p>
<p>With the timer interrupt you are effectively disabling interrupts during the sampling so the problem goes away.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1683"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-i9FQwk4N90-1AOCBmCBGeCooGytF_ZY4s9BR1Paj5wI" value="form-i9FQwk4N90-1AOCBmCBGeCooGytF_ZY4s9BR1Paj5wI"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
