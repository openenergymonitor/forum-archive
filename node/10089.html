<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10089 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:25:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>CT3 delayed readings? | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">CT3 delayed readings?</h3>
        <span class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Tue, 27/01/2015 - 01:34</span>
        <div class="content"><p>I&#39;m running the emonTxV3_3Phase_Voltage.ino sketch and notice that the readings on input CT3 are funny.</p>
<p>It flip flops between zero and the actual reading, ie it shows a reading like 200w then 5-10 sec&#39;s later switches to zero, then back to 200w then back to zero. I hope that makes sense.</p>
<p>I don&#39;t think that&#39;s normal or is it?</p>
<p>(I&#39;ve tried swapping the CT2 and CT3 clamps but get the same problem, so regardless of the clamp or the line its measuring, input ct3 has this strange behavior).</p>
<p>You can see this happening @ emoncms.org/hpsolar</p>
<p>&nbsp;</p>
<p>On a separate note - if I want to use CT4 on phase 3 (instead of phase 1), do I merely change line 119 - double Phasecal4 = 1.00; to read Phasecal4 = 1.37 (same as Phasecal3)?</p>
<p>Thank you.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10155.html" class="topic-previous" title="Go to previous forum topic">‹ Sensor error or calibration problem - Real beginner</a>
              <a href="10146.html" class="topic-next" title="Go to next forum topic">RFM12B capacitors blown on emontx3.4 ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-27139"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 27/01/2015 - 12:00.</div>
    <div class="content">
     <p>That does not make sense. And nobody else has reported a problem of this nature. The power for line 3 is calculated, as I'm sure you can see if you read the sketch, by multiplying the instantaneous current from CT3 by a delayed sample of the voltage of line 1 (and interpolated between samples as necessary to 'fine-tune' the delay). Which sketch are you using, and has it been changed? The power dropping to zero implies either the current or voltage or both become zero. Is the current reading for CT3 showing similar variation? Is the voltage? What is you power supply system (frequency, voltage, etc)?</p>
<p>If you want to use CT4 on phase 3, you can either rotate all the phases (so phase 3 becomes phase 1, phase 1 becomes phase 2, phase 2 becomes phase 3) or you can multiply the CT4 current by the delayed voltage that CT3 uses.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27143"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7220.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mtran&#039;s picture" title="mtran&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Tue, 27/01/2015 - 13:48.</div>
    <div class="content">
     <p><strong>Which sketch are you using, and has it been changed?</strong></p>
<p>I&#39;m running the 3 phase one from here -&gt; <a href="https://github.com/openenergymonitor/emonTxFirmware/blob/master/emonTxV3/RFM12B/Examples/emonTxV3_3Phase_Voltage/emonTxV3_3Phase_Voltage.ino" title="https://github.com/openenergymonitor/emonTxFirmware/blob/master/emonTxV3/RFM12B/Examples/emonTxV3_3Phase_Voltage/emonTxV3_3Phase_Voltage.ino">https://github.com/openenergymonitor/emonTxFirmware/blob/master/emonTxV3...</a></p>
<p>&nbsp;</p>
<p>I changed line 110 double Vcal = 276.9 to 290.9 to match my mains of 246v.</p>
<p>&nbsp;</p>
<p><strong>Is the current reading for CT3 showing similar variation?</strong></p>
<p>I haven&#39;t pulled the emontx from my meter box to check yet. However, reading my mains meter, phase3 is consistently around 1.08-1.09A. Voltage is 246, 247 etc.</p>
<p>At this stage I don&#39;t think its</p>
<p>1. the clamp, as it works fine plugged into input 2.</p>
<p>2. anything to do with the power line ie no fluctuations in voltage or current because its fine when measured using input 2.</p>
<p>So that leaves the sketch or emontx hardware??</p>
<p>&nbsp;</p>
<p><strong>multiply the CT4 current by the delayed voltage that CT3 uses.</strong></p>
<p>so change line 395- sumP4 += phaseShiftedV1 * filteredI4 to</p>
<p>sumP4 += phaseShiftedV<strong>3</strong> * filteredI4 ?</p>
<p>and no need to change line 119-&nbsp; double Phasecal4 = 1.00 to 1.37 like Phasecal3?</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27144"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 27/01/2015 - 14:57.</div>
    <div class="content">
     <p>CT4:<br />
Correct. But if the phase calibration is wrong, then you'll need to replicate line 383 to give you a new variable phaseShiftedV4 that uses Phasecal4. That shouldn't be necessary if the CT's have similar phase errors. (Phasecal4 isn't actually used - I slipped up there!)</p>
<p>Regarding the original problem:<br />
An obvious question I should have asked earlier: Is the serial output of your emonTx giving correct or wrong values? If that's correct, is your emonBase receiving the correct values?</p>
<p>We've recently changed emonLib to use a low pass filter instead of the high pass to remove the bias offset, I'll rework the sketch (which doesn't use emonLib) to do the same and let you have that. Meanwhile, I wonder whether the serial prints are causing the problem? Try commenting out "#define SERIALPRINT" at the top (but not before you check the output!).</p>
<p>I'll run the sketch and look for zero values, but I don't expect to see anything as I never noticed anything untoward whilst developing and testing the sketch, and as I mentioned no-one else seems to have seen this either.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27154"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 27/01/2015 - 20:07.</div>
    <div class="content">
     <p>Note: You have not answered the frequency question yet. That sketch is for a 50 Hz system. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27162"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 27/01/2015 - 21:32.</div>
    <div class="content">
     <p>I have run the sketch on my test rig for about an hour. The test current in CT3 was approx. 1.9 A</p>
<p>It has sent 1008 valid readings (after discarding the first 5 as the filters settled), and there is not a single reading where the CT3 current does not start with the digit "1". There are 7 instances where it starts "1.86" 67 with "1.87", 200 with "1.88", 352 with "1.89", 270 with "1.90" 96 with 1.91, 16 with "1.92"</p>
<p>On that basis, I don't have any evidence to suggest that there might be an inherent problem with the sketch.</p>
<p>It might be worth checking whether the rest of your system can handle a reading every 3.5 s approx, and you might want to reduce that rate to say one every 10 s, especially if you are using emoncms.org, as Trystan likes people to not send data more frequently than once every 10 s, to better share out the limited (and free to you!) resources.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27163"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7220.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mtran&#039;s picture" title="mtran&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Tue, 27/01/2015 - 21:43.</div>
    <div class="content">
     <p>Thank you.</p>
<p>I&#39;m in Australia, so yes to 50hz.</p>
<p>&nbsp;</p>
<p>My serial output:</p>
<p>(have not commented out #define SERIALPRINT, also note I have not uncomment CT4 yet its still //#define CT4 )</p>
<p>10 231 0 214 0 0 0 0 0 250 0<br />
10 231 0 217 0 254 253 0 0 249 0<br />
10 240 0 219 0 0 0 0 0 250 0<br />
10 230 0 210 0 2 254 0 0 250 0<br />
10 233 0 216 0 0 0 0 0 250 0<br />
10 238 0 218 0 255 253 0 0 249 0<br />
10 230 0 217 0 0 0 0 0 249 0<br />
10 232 0 223 0 254 253 0 0 249 0<br />
10 231 0 211 0 0 0 0 0 250 0<br />
10 255 0 221 0 254 253 0 0 250 0<br />
10 231 0 214 0 0 0 0 0 250 0<br />
10 231 0 219 0 252 253 0 0 249 0<br />
10 245 0 217 0 0 0 0 0 249 0</p>
<p>&nbsp;</p>
<p>Got to go to work, back in 8 hours :-)</p>
<p>ps I don&#39;t think this makes a difference but my PV solar is fed into phase 3. I don&#39;t think the solar input has any bearing on the zero effect since it occurs 24/7 ie night time when solar is off.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27164"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 27/01/2015 - 21:46.</div>
    <div class="content">
     <p>On the emonTx V3, the burden resistor for CT4 is likely to be smaller than for the other three, so that channel may not be suitable for this purpose (i.e. to act as part of a set of 3)</p>
<p>The sensitivity of any CT can be checked by running one of my RawSampleTool sketches.&nbsp; This will show the raw ADC samples for voltage and current during one or more mains cycles.&nbsp; RawSampleTool_4ss_2.ino is near the top of my <a href="1757.html">Summary Page</a>.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27165"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 27/01/2015 - 22:05.</div>
    <div class="content">
     <p>We can't be looking at the same sketch. The serial output in the sketch you said you were using sends 13 values, and has the variable names preceding the values, viz:</p>
<p>Voltage: 246.11<br />
 Current 1: 0.00 Power 1: 0.00 VA 1: 0.00 PF 1: nan<br />
 Current 2: 0.00 Power 2: 0.00 VA 2: 0.00 PF 2: nan<br />
 Current 3: 1.90 Power 3: 310.36 VA 3: 468.46 PF 3: 0.66</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27171"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7220.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mtran&#039;s picture" title="mtran&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Wed, 28/01/2015 - 11:43.</div>
    <div class="content">
     <p>just to clarify, to get the serial output above, I remote into the Pi and run a python cmd, eg python -m serial.tools.miniterm -p /dev/ttyAMA0 -e</p>
<p>(its raining here and the emontx is in my meter box which is outside so I haven&#39;t been able to grab a laptop and connect it directly to the emontx to run the sketch). Hope that helps.</p>
<p>&nbsp;</p>
<p>edit: just a thought, the serial output from the python cmd comes directly from the emontx and not via the sketch right? If so then the error is with the emontx hardware?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27185"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 28/01/2015 - 13:11.</div>
    <div class="content">
     <p><i>"the serial output from the python cmd comes directly from the emontx and not via the sketch right?"</i><br />
I haven't a clue what you mean there. You're well tangled up with your understanding. The sketch is the software that controls what the processor in the emonTx does. That includes processing the data from getting values from the ADC to sending numbers to be transmitted by the radio module. I am printing to the serial port on the emonTx the numbers derived from those measurements, and I have not seen one faulty value in >2000 measurements. </p>
<p>I realised after I wrote, that you're not looking at the data that the sketch in the emonTx is generating, so you can't blame the emonTx hardware nor the sketch until you've shown that its output is faulty. From what I've done here, that's not the case and it's more likely that the data isn't being received properly, though that might be because the sketch is sending it too frequently for the Pi to handle.</p>
<p>I haven't got a working RPi here (I've had one for months, I've not had time to figure out how to set it up) so I can't offer a comment on that other than to suggest that as a further line of investigation.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27193"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7220.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mtran&#039;s picture" title="mtran&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Wed, 28/01/2015 - 14:58.</div>
    <div class="content">
     <p>I meant by that running the command &quot;python -m serial.tools.miniterm -p /dev/ttyAMA0 -e&quot;, it would return data from the emontx as raw data and not processed data. Its a similar command to &quot;minicom -b 9600 -o -D /dev/ttyAMA0&quot;.</p>
<p>&nbsp;</p>
<p>However, if like you say the sketch controls the emontx then the data I&#39;m seeing has been processed through the sketch.</p>
<p>Anyway, I&#39;ve changed the sketch by adding CT4 and it seems my problem is gone.</p>
<p>&nbsp;</p>
<p>Thank you very much for your help.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27200"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 28/01/2015 - 16:22.</div>
    <div class="content">
     <p>That I definitely DO NOT understand - it has to be a fault in the processing after reception in the RPi.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27206"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Wed, 28/01/2015 - 17:54.</div>
    <div class="content">
     <p>@Robert - After reading mtran&#39;s last post I too thought it was extremely odd and assumed it was probably something more to do with reloading the sketch rather than the ct4 code itself. mainly because I have vague recollection of another user having an issue with just one channel of a emonTx v3&nbsp;that mysteriously vanished (the fault not the emonTx that is!) from what I recall we thought it was interference until it just disappeared.</p>
<p>However your reply made me question that theory and thought about it some&nbsp;more. My assumption was based on no more than the fact the serial print was the serial incoming to the Pi and unlikely to have been effected yet, plus the fault occurs every second packet which seemed too regular to be a&nbsp;&quot;random effect&quot; rather than a &quot;incorrect result&quot;. Whilst considering RF issues I realised I didn&#39;t know for sure how the emonTx was connected, looking at mtrans&nbsp;other threads, the plot thickens......</p>
<p>I&#39;m guessing here that he may not be using an rfm2pi and the 3phase sketch is modified to give a direct serial output and the &quot;issue&quot; may of actually been circumvented when adding ct4 print statements.</p>
<p>Or there is also a possibility a jeelink or a bluetooth device maybe influencing the serial data, to boot.</p>
<p>@mtran&nbsp;- Are you using a RFM2Pi&nbsp;?&nbsp;can you confirm how you are connecting the emonTx and if there are any other serial devices.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27210"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 28/01/2015 - 20:30.</div>
    <div class="content">
     <p>Paul,</p>
<p>In the absence of information to the contrary, and he did confirm he had not changed the sketch, I have to assume people are using the "standard" set-up, i.e a Radio link. </p>
<p>I wondered - maybe you can confirm - is the "standard" RFM12Pi plus his router and emoncms.org capable of handling data every 3.5 s?  I'd have thought so for the first part, maybe not the second (but I'm not sure how that explains only CT3 going missing). I don't know, and can't replicate what I assume is his set-up. All we know is he's happy.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27213"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Wed, 28/01/2015 - 22:45.</div>
    <div class="content">
     <p>Absolutely, It wasn&#39;t until I questioned my own assumptions the non-rfm2pi&nbsp;possibilities came to mind. He may well be using an rfm2pi, in fact the 10 serial print&nbsp;values are&nbsp;possibly&nbsp;the 5 byte-pair ints, but if that is the case ct3&nbsp;values should be &quot;flip-flopping&quot; between 0 and -500w (minus 500).</p>
<p>What defines the 3.5 seconds ? &nbsp;is it the&nbsp;3second&nbsp;sleep in the&nbsp;if settled?</p>
<p>​I would be surprised if the setup&nbsp;couldn&#39;t handle a 3.5sec interval as&nbsp;it should cope with 3 emonTx&#39;s at 10 seconds each, which would present the same frequency of intervals, if any part was likely to object I guess it would be emoncms.org and then the packets would just be buffered until it did accept them.</p>
<p>Very odd!!&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27214"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7220.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mtran&#039;s picture" title="mtran&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Wed, 28/01/2015 - 22:49.</div>
    <div class="content">
     <p>my setup is an rpi B+, RFM12Pi, and the emontxV3 (433Mhz ) bought back in late Nov.</p>
<p>&nbsp;</p>
<p>I also have a usb-serial cable connected from my solar inverter (serial) to the rpi (usb). A script on the rpi collects the inverter data and publishes it to pvoutput.org.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27216"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Wed, 28/01/2015 - 23:07.</div>
    <div class="content">
     <p>Aside from editing the &quot;#defines&quot; and &quot;Vcal&quot; is the emonTx&nbsp;v3&nbsp;sketch all original? and still behaving ?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27217"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 28/01/2015 - 23:23.</div>
    <div class="content">
     <p><i>"What defines the 3.5 seconds ?  is it the 3second sleep in the if settled?"</i><br />
Yes - plus of course the time to execute the main loop.</p>
<p>I don't accept that it's a random effect, but there may be some strobing going on. So if it goes away for some minutes and then returns, that's a likely explanation. So the finger of suspicion points at something else happening every 7 s approx (or an odd sub-multiple of that: 2.33 s, 1.4 s, 1 s, etc). But what's the mechanism by which it is writing zeros into CT3 and only into CT3? This is what's sent:</p>
<p>struct { int power1, power2, power3, power4, Vrms;} </p>
<p>That doesn't change. If CT4 is not defined, it's outputs are set to zero each time, but power4 is still sent. So the "0 0" before the 249/250 is correct.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27220"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7220.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mtran&#039;s picture" title="mtran&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Thu, 29/01/2015 - 00:20.</div>
    <div class="content">
     <p>The script is all original besides the vcal value.</p>
<p>The second edit was to uncomment //#define CT4 and changed line 395- sumP4 += phaseShiftedV1 * filteredI4</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27221"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Thu, 29/01/2015 - 01:08.</div>
    <div class="content">
     <p>The serial output&nbsp;above gives the following int&nbsp;values for that struct</p>
<blockquote><p>10 231 214 &nbsp; &nbsp; &nbsp;0 0 250<br />
10 231 217 -514 0 249<br />
10 240 219 &nbsp; &nbsp; &nbsp;0 0 250<br />
10 230 210&nbsp;-510 0 250<br />
10 233 216 &nbsp; &nbsp; &nbsp;0 0 250<br />
10 238 218 -513 0 249<br />
10 230 217 &nbsp; &nbsp; &nbsp;0 0 249<br />
10 232 223 -514 0 249<br />
10 231 211 &nbsp; &nbsp; &nbsp;0 0 250<br />
10 255 221 -514 0 250<br />
10 231 214 &nbsp; &nbsp; &nbsp;0 0 250<br />
10 231 219 -516 0 249<br />
10 245 217 &nbsp; &nbsp; &nbsp;0 0 249</p>
</blockquote>
<p>which is remarkably&nbsp;consistent,&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27223"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7220.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mtran&#039;s picture" title="mtran&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/7220.html" title="View user profile.">mtran</a> on Thu, 29/01/2015 - 02:06.</div>
    <div class="content">
     <p>and the minus 500 values on phase 3 are due to the PV exporting back to the grid.</p>
<p>Also on the phase 3 line are bunch of aquarium equipment eg water &amp; air filters, so the line has a constant consumption of 200-300w (that -500 is the net; gross PV is probably 700-800w). Therefore there should never be a zero reading on the phase 3 line.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27259"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 31/01/2015 - 17:59.</div>
    <div class="content">
     <p>There wasn't a zero reading on the phase 3 line! It was "nan" or "ovf", that was presumably being converted to zero in the RPi. And that's what threw us.</p>
<p>I have managed to replicate the problem - by accident - when converting the sketch to use the low-pass filter (in order to remove the problem of wild values at start-up as the filters settle). I've also had meaningless numbers, powers of 200 kW with 6kVA and pf = 33. </p>
<p>I think therefore it's a memory addressing or buffer overflow type of problem, but I don't yet know the exact cause.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27568"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 10/02/2015 - 17:37.</div>
    <div class="content">
     <p>I think I have finally got to the root of the problem here. It appears to be a case of the old problem where the memory heap growing upwards meetsg the stack growing downwards; but what fooled me for a long time was MemoryFree() was reporting over 1000 bytes of free memory, also the fact that no text strings were corrupted - the usual symptom. </p>
<p>The cure (so far) is to surround all the string literals with the "F" macro, which has the effect of leaving them in flash memory and thus freeing up around 500 bytes of static RAM:</p>
<p>e.g:<br />
&nbsp;&nbsp; Serial.println("OpenEnergyMonitor.org");<br />
becomes<br />
&nbsp;&nbsp; Serial.println(F("OpenEnergyMonitor.org"));</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27576"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 10/02/2015 - 22:16.</div>
    <div class="content">
     <p>Most of those AVR memory checkers compare the largest the heap has ever been, with where the stack is now, so you need to call them from wherever you think your deepest stack is likely to occur.&nbsp; I use a wrapper routine that tracks the smallest it&#39;s ever been, and call that from various low-level routines that I know get called when things are deep:</p>
<pre>
static void check_free_ram() {
  int free_ram = freeRam();
  if (free_ram &lt; smallest_free_ram)
    smallest_free_ram = free_ram;
}</pre><p>Then I just check smallest_free_ram at my leisure, and even post it to an emoncms&nbsp;feed whenever it changes for a simple but useful diagnostics page:</p>
<p><img alt="" src="../sites/default/files/diags.png" style="height:134px; width:200px" /></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27578"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 10/02/2015 - 23:13.</div>
    <div class="content">
     <p>The deepest this goes is in the "calculate 3 phase" function where it's got the stored values array, the filter and rms variables all as doubles. And that's precisely where I was checking.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27580"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Tue, 10/02/2015 - 23:54.</div>
    <div class="content">
     <p>So how did you determine that the root cause was the stack crashing into the heap? &nbsp;Were you able to determine why the memory checker failed to see it?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27584"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 11/02/2015 - 02:13.</div>
    <div class="content">
     <p>I haven't <i>proved</i> it, but having moved 500 bytes or so of string literals out of SRAM, the problem went away. Of course, it might still be a wayward pointer that's now dumping data where it doesn't matter...</p>
<p>But as pdcleyn still has a problem and he'd already done that, I'm beginning to wonder again. Without a decent in-circuit debugger, I'm very much groping in the dark.</p>
<p>I've never had the memory checker show less than a hundred or so bytes even when there have been problems - it just can't catch the last few. Which is why I thought with around 1100 bytes 'free' there shouldn't have been a problem. And which is why I'm thinking again.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27587"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 11/02/2015 - 07:31.</div>
    <div class="content">
     <p><em>I&#39;ve never had the memory checker show less than a hundred or so bytes even when there have been problems - it just can&#39;t catch the last few.</em></p>
<p>Problems as in corruption, or problems as in failed mallocs()? &nbsp; There&#39;s a global variable called __malloc_margin which in Arduino land seems to be set to 128. &nbsp;In AVR land I think it&#39;s set to 32. &nbsp; When it&#39;s about to expand the heap, it uses the current stack pointer less that number as its upper limit as to what it can expand to if it needs to. &nbsp;I think it&#39;s a primitive guess at what the dynamic range of the stack size will be.</p>
<p>You can see all this code (and change it and debug it) here:</p>
<p>arduino-1.0.5/hardware/arduino/cores/arduino/avr-libc/malloc.c﻿</p>
<p>In theory, you can also change those variables&#39; initial settings from your own module, but it must be done before any calls to malloc(), including any done by the runtime behind your back. &nbsp;It may be that if it&#39;s the very first thing you do in setup() you might be ok, but I haven&#39;t confirmed that. &nbsp;Editing malloc.c and restarting the IDE is an alternative.</p>
<pre>
/* May be changed by the user only before the first malloc() call.  */

size_t __malloc_margin = 128;
char *__malloc_heap_start = &amp;__heap_start;
char *__malloc_heap_end = &amp;__heap_end;</pre><p>&nbsp;</p>
<p><strong>[EDIT]&nbsp;</strong>Actually, do you guys do any malloc&#39;ing&nbsp;or C++ new&#39;ing, or are all your classes and variables confined to .data, .bss and the stack?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27599"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 11/02/2015 - 13:16.</div>
    <div class="content">
     <p>I've never seen a malloc/realloc or a new in any code around here. The usual symptom is gibberish strings, which in itself is pretty harmless but an indication of a problem, and the usual cure is to get rid of some or shorten them.</p>
<p>My next line of investigation will be JeeLib. That's recently had the RFM69CW added so it's realistic to suspect that it has grown as a result. Some while ago a change to (and an expansion of) the Ethercard library resulted in the Nanode RF sketch blowing up, and I suspect that a similar thing has happened here, since all reports of problems have been confined to this year, which is roughly when the change to JeeLib happened.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-27618"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: CT3 delayed readings?</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 11/02/2015 - 22:12.</div>
    <div class="content">
     <p>Actually, .data lives below .bss, so if the stack is trampling over your strings it&#39;s probably already taken out your static variables on the way down.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10089"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-0aVpndojCdGMdAZiHeNSyD9kbNXdMWHwqlcaw3zrAD0" value="form-0aVpndojCdGMdAZiHeNSyD9kbNXdMWHwqlcaw3zrAD0"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
