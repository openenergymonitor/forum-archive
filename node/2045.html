<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2045 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:59 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Calculating coefficients for phase-accurate current measurements | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Calculating coefficients for phase-accurate current measurements</h3>
        <span class="submitted">Submitted by <a href="../user/3296.html" title="View user profile.">CapnBry</a> on Fri, 22/02/2013 - 23:37</span>
        <div class="content"><p>I currently have an ATmega attached to an electrical socket using a transformerless supply and a sense resistor piped into an opamp to juice up the numbers. The values are piped into the atmega analog ports and give me nice pretty output like this</p>
<p><img alt="" src="../../../i.imgur.com/iuml37Al.png" style="width: 640px; height: 225px;" /></p>
<p><a href="http://imgur.com/iuml37A">http://imgur.com/iuml37A</a></p>
<p>Unfortunately the math to convert that to actual and apparent power escapes me. Obviously I understand that I can multiply a factor times the offset from the baseline (zero point) and get an instantaneous usage value but I&#39;m not clear on how to get accurate values. I have a kill-a-watt meter so I can tell what the values mean, and I came across the emonlib which can do the readings and calculations for me! Sweet. Now I just need to figure out what the coefficients emonlib needs.</p>
<p>Because my current is directly measured, it is exactly in phase with the voltage reading. Does that mean my PHASECAL is 1.0 or 0.0? Is the VCAL the peak to peak (non-RMS) voltage? And what does the ICAL&nbsp;constant represent? I suppose I can just keep tweaking the numbers until I get a working value but I&#39;d like to understand what they are exactly.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2061.html" class="topic-previous" title="Go to previous forum topic">‹ EmonGLCD time incorrect in the morning</a>
              <a href="2051.html" class="topic-next" title="Go to next forum topic">The RFM12 to PI interface script is not running. ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-10054"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 22/02/2013 - 23:50.</div>
    <div class="content">
     <p>The short answer is to read up about measuring the various quantities, and doing the calculations, in the &quot;<a href="../buildingblocks.html">Building Blocks</a>&quot; section. It&#39;s hard to tell you exactly where to start reading, since you haven&#39;t told us how much electrical theory you know. But I think everything you need to know is there - somewhere.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10059"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Sat, 23/02/2013 - 08:40.</div>
    <div class="content">
     <p>Even though your current and voltage are phase aligned at the ATmega inputs you are still (presumably) reading them at different times because there is only one ADC. This means you will still have to set a PHASECAL value to account for the phase error caused by the delay between the two readings.</p>
<p>VCAL is simply the ratio between the true instantaneous voltage and the voltage at the ATmega input. e.g. if 100V on the a/c line gives 1V at the chip then VCAL is 100. Similarly if 100A instantaneous current results in 1V at the chip then ICAL is 100.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10063"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sat, 23/02/2013 - 10:39.</div>
    <div class="content">
     <p>The above display is similar to the output from the <strong>RawSamplesTool_4ss_2</strong> tool that I posted at <a href="1705.html#comment-8535" title="http://openenergymonitor.org/emon/node/1705#comment-8535">http://openenergymonitor.org/emon/node/1705#comment-8535</a>, This allows raw ADC samples to be stored for subsequent analysis in a spreadsheet.&nbsp; Although I didn&#39;t post the resulting graph at the time, here it is now.&nbsp; On its half-heat setting, the waveform of the current that is drawn by my Bosch hot air gun is &quot;interesting&quot;.</p>
<p><a href="../sites/default/files/BoschWaveformAtHalfHeat.jpg"><img alt="" height="300" src="../sites/default/files/BoschWaveformAtHalfHeat.jpg" width="600" /></a></p>
<p>&nbsp;</p>
<p>As Martin has said, there are various possible sources of phase shift.&nbsp; The phaseCal algorithm provides a convenient means of adjusting the phase relationship of one waveform with respect to the other.&nbsp; Another tool that I&#39;ve posted, <strong>PhasecalChecker</strong>, allows the optimal value of phaseCal to be found when measuring a resistive load.&nbsp; Power Factor will then be very close to unity.</p>
<p>These tools, and others, are listed and linked from my &#39;sticky&#39; thread at the top of the General forum area.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10109"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3296.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3296.jpg" alt="CapnBry&#039;s picture" title="CapnBry&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/3296.html" title="View user profile.">CapnBry</a> on Mon, 25/02/2013 - 15:53.</div>
    <div class="content">
     <p>Wow, it is so easy! I&#39;m not sure why I was having such a hard time understanding the relationships. I think I had my head stuck so deeply in my own code that when I looked at something else I just couldn&#39;t switch gears. I also thought my phase shift would be negligible due to the current being measured right after the voltage. However it is true that this measurement actually takes place 1/9000th of a second later. That seems insignificant but given a 60Hz&nbsp;voltage period, that amplifies the error by a order of magnitude&nbsp;to 0.67% that can add up over time.</p>
<p>The VCAL/ICAL&nbsp;also makes sense now given the scaling with VCC.</p>
<p>Thanks for the help, this really works great!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10111"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Mon, 25/02/2013 - 16:20.</div>
    <div class="content">
     <p><em>Thanks for the help, this really works great!</em></p>
<p>Good.&nbsp; What exactly is your system doing?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10125"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3296.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3296.jpg" alt="CapnBry&#039;s picture" title="CapnBry&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/3296.html" title="View user profile.">CapnBry</a> on Tue, 26/02/2013 - 14:14.</div>
    <div class="content">
     <p>Oh It is just a project for my own blog / amusement that I started over a year ago and had put aside. Basically it is just a <a href="http://www.ladyada.net/make/tweetawatt/">Tweet-a-watt</a>&nbsp;adapted to use the RFM12B&nbsp;transmitter. I already have a ton of the transmitters around my house sending various environmental conditions, BBQ progress, and fermentation information so I was hoping to augment that with power monitoring. The Ladyada project is a cute idea but terrible on the software side, in that it requires the receiver calculate the power and doesn&#39;t even do that correctly.</p>
<p>I&#39;ll post the code <a href="https://github.com/CapnBry">on my github</a> once it is complete. I think others might find it interesting as to save time and therefore power, I actually perform most of the floating point math while the ADC is doing its measurement. It also gives me 75 ADC sample pairs per mains cycle which gives pretty good resolution of the power data.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10137"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 26/02/2013 - 18:32.</div>
    <div class="content">
     <p><em>I actually perform most of the floating point math while the ADC is doing its measurement. It also gives me 75 ADC sample pairs per mains cycle which gives pretty good resolution of the power data.</em></p>
<p>Neat.</p>
<p>If you were to use integer maths, I reckon that all of your processing could be done while the ADC is busy.&nbsp; My PV Router system went up from around 57 to 89 sample pairs per 50 Hz mains cycle when I did this, and it does around 96 when in free-running interrupt mode.&nbsp;&nbsp; Using integer maths also means that the main processor is idle for some of the time, so giving it something else doesn&#39;t affect the sampling rate.&nbsp; My <a href="1757.html">Mk2i_rev4</a> build works in this way.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10153"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3296.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3296.jpg" alt="CapnBry&#039;s picture" title="CapnBry&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating coefficients for phase-accurate current measurements</h3>

    <div class="submitted">Submitted by <a href="../user/3296.html" title="View user profile.">CapnBry</a> on Wed, 27/02/2013 - 15:00.</div>
    <div class="content">
     <p>I&#39;m running 128 prescaler at 16MHz&nbsp;so the maximum number of sample pairs I&#39;d be able to get per 60Hz&nbsp;cycle is 80. Even if I comment out all the math I still only end up with 75 sample pairs per cycle. Now that I&#39;ve done it this way and checked it into GitHub, I may try switching it over to the freerunning style and integer math like they do in the AVR465 application note.</p>
<p>Source code is in the<a href="https://github.com/CapnBry/JeeAWatt/blob/bc7c731b6cf0cb1e0f4b789707aa695bd2beeda9/arduino/JeeAWatt/JeeAWatt.ino#L62"> github&nbsp;JeeAWatt project</a>&nbsp;if anyone is interested in seeing it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2045"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-CAg1-hDo0GnJaSoGEaNL_A7Zs2OCtUQ0IukohZo2i0M" value="form-CAg1-hDo0GnJaSoGEaNL_A7Zs2OCtUQ0IukohZo2i0M"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
