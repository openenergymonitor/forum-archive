<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10363 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:43:50 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>[Release] EmonCMS - Fix all timezone issues. | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">[Release] EmonCMS - Fix all timezone issues.</h3>
        <span class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Sat, 21/03/2015 - 03:03</span>
        <div class="content"><p>On extended branch: <a href="https://github.com/emoncms/emoncms/pull/303">https://github.com/emoncms/emoncms/pull/303</a></p>
<p>Fixes timezone issues for people with server on diferent timezone of browser.</p>
<p>Now user selects timezone from the internal php list and even day light saving time is correct across the year.</p>
<p>Also fix midnight issue to day comulators like kwh/d.</p>
<p>All tested.</p>
<p><img alt="" height="163" src="../sites/default/files/2_0.jpg" width="261" /></p>
<p><img alt="" height="143" src="../sites/default/files/1_2.jpg" width="406" /></p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10792.html" class="topic-previous" title="Go to previous forum topic">‹ AVG value calculating</a>
              <a href="10789.html" class="topic-next" title="Go to next forum topic">EmonPi software update - emonhub.conf change ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-28873"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Sat, 21/03/2015 - 10:57.</div>
    <div class="content">
     <p>A very welcome update chaveiro, it should sort a lot of ongoing issues which are being regularly reported in the forum.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28875"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sat, 21/03/2015 - 11:39.</div>
    <div class="content">
     <p>Hi chaveiro, Can you elaborate a little? What in your opinion was at fault? and how does what you propose solve that?</p>
<p>I have had a look at your commit and I&#39;m my PHP isn&#39;t up to&nbsp;working&nbsp;out what you&#39;ve done and why. This is a huge, core topic that has many implications, the effects&nbsp;of which wouldn&#39;t necessarily manifest until further down the line possibly at year end,&nbsp;DST start/end or a leap year.</p>
<p>You&nbsp;have linked to 4 open issues on github&nbsp;using&nbsp;&quot;fixed in #303&quot; a fuller&nbsp;explanation for the contributors and visitors to those&nbsp;threads would indicate you understand the&nbsp;issue and that what you propose may work. There are many additional unresolved threads here on the forum too.</p>
<p>I (and many others I&#39;m sure)&nbsp;appreciate your effort and welcome any fixes in this area, but would like to know more before diving in.</p>
<p>I think the core question is what time is used where? is all the data stored using unix time only, without any timezone changes and then&nbsp;manipulated when read for visualization&nbsp;and calculation etc?&nbsp;</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28880"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Sat, 21/03/2015 - 18:30.</div>
    <div class="content">
     <p>Hi Paul, i will try to keep it simple:</p>
<p>All feed data are saved in epoch seconds from 1/1/1970 00:00:00 that per definition is in UTC (not GMT). This is standard linux, no change here. This is what is saved to input and feed engines.</p>
<p>To know the start of a day we must know user local timezone and that is a calculated conversion from epoch timezone, the result of calculation gives a new epoch value corresponds to the user timezone midnight. (fix in process_model.php)</p>
<p>Feeds that are per day accumulator must be based on owner timezone. This means that if your feed is public and you share to a diferent timezone user, they will see your midnight on their offset. It&#39;s no bug, the reason is that the owners midnight cant change.</p>
<p>The core emoncms used an offset in hours from GMT. But some timezones have 15 minutes offset and could not be applied correctly. Also DST changes are diferent for various countries. So too maintain compatibility i kept the User/timezone.json returning an offset but now in seconds instead of hours but this values is now calculated on the fly for the particular user timezone. Then updated php files that used this values on various parts of emoncms to use the php core DateTime class that takes care converting timezones (including DST changes) for us by using the standard&nbsp;timezones codes associated to the user.</p>
<p>There is also a change in database user table schema to support the timezone name instead of hour offset.</p>
<p>All javascript related timezone were already dealt by the javascript itself.<br />
Json gives always result values in epoch (UTC). And conversions are applied in JS to the client browser timezone. No change here.</p>
<p>After updating to this fixed version, you must select your timezone in user panel. Then all day feed&nbsp;accumulator (like kwh/d) past data might need an offset fix. If you have a database engine it&#39;s easy as add/subtract the correct value to the old data. This is to fix users reporting that day starts at 8&#39;o clock (or not mid night).</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28896"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sat, 21/03/2015 - 23:45.</div>
    <div class="content">
     <p>This all sounds good, but I still can&#39;t determine what was wrong and what has changed in relation to some of the issues. For example I am in the UK using GMT/BST and have experienced issues with DST, I understand you have changed from 1 hour to 3600 seconds and how midnight is determined for &quot;other&quot; time&nbsp;zones&nbsp;but neither&nbsp;of these should effect GMT/BST.</p>
<blockquote><p><em>&quot;All feed data are saved in epoch seconds from 1/1/1970 00:00:00 that per definition is in UTC (not GMT). This is standard linux, <strong>no change here</strong>. This is what is saved to input and feed engines.&quot;</em></p>
</blockquote>
<p>Would I be correct in assuming the server time will have absolutely&nbsp;no impact on either the timestamp saved (as that is unixtime derived from ntp) or the query results as their time references are taken from the client/browser?and that you have made no change to that functionality, it was already working that way?&nbsp;</p>
<p>Paul</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28902"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Sun, 22/03/2015 - 01:01.</div>
    <div class="content">
     <p>Yes, linux epoch value does not &#39;leap&#39; from timezone or DST events.</p>
<p>Main issue was design error. User specified a fixed GMT offset but on DST this offset changes.</p>
<p>Other issue was that midnight was not being correctly calculated&nbsp; for timezones other than GMT.</p>
<p>To confuse a little UTC != GMT != BST != DST :)</p>
<p>Always use location code. ex.: Europe/London. Systems must have mapping for the timezone rules / location updated regulary as the mapping can change. (ex.by politics decision)</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28903"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sun, 22/03/2015 - 01:58.</div>
    <div class="content">
     <p>I am well aware how &quot;epoch time&quot; <em>should</em> work and I am familiar with the differences between the &quot;times&quot;.</p>
<p>What I do not understand is why if you have only made changes to how the offset works and no change was required when using a 0 offset, then why&nbsp;when previously using a 0 offset resulted in an error at the beginning and end of BST when DST was applied? epoch didn&#39;t change and the fixed 0 offset didn&#39;t change and yet issues occur. If you have not made&nbsp;changes to effect this behavior then it will remain!</p>
<p>I think I will have to look at the code and&nbsp;work this out for myself. I&#39;m not questioning whether your fixes to the timezone or the daily totals work and I fully understand your reasoning there. My specific&nbsp;interest is in the previous&nbsp;&quot;UTC +0:00&quot; issues&nbsp;with BST.&nbsp;I&#39;m trying to understand how something that was previously broken that you apparently haven&#39;t changed is now fixed ??</p>
<p>I hope it is fixed, it may well be fixed. I was just hoping to understand cause and cure to&nbsp;<u>know</u> it was fixed.&nbsp;but I guess we can put it to the test next weekend.:-)</p>
<p>Paul</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28919"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Sun, 22/03/2015 - 23:18.</div>
    <div class="content">
     <p>Thanks Chaveiro for your work on this</p>
<p>I think there may be two separate issues here and that the bug created at the last change from BST that resulted in a negative kwhd value is as Paul mentioned independent of the user timezone offset setting.</p>
<p>I&#39;ve been testing changing the localtime to see if I can reproduce the error that we had last time and I cant seem to replicate it, it appears to work fine through local time changes, If I change the system time (equivalent of changing utc) then I can replicate the error, but I would expect that as then any of the time difference calculations would either result in a negative value if the time change is backwards leading then to a negative kwh value or just a larger kwh value if the time change is&nbsp; forward 1 hour.</p>
<p>Emoncms should run on UTC and be independent of localtime changes so that the current time minus last time always returns the correct time difference in seconds which is then used for kwh increment calculations in processes such as power_to_kwhd.</p>
<p>If I understand correctly the default settings for system time on a ubuntu server should be independent of the localtime but perhaps that isnt always the case.</p>
<p>I&#39;ve created a test script to check how php handles changes to localtime</p>
<p>&lt;?php</p>
<p>// date_default_timezone_set(&#39;UTC&#39;);</p>
<p>print &quot;Default php timezone: &quot;.date_default_timezone_get().&quot;\n&quot;;</p>
<p>$time = time();<br />
print &quot;time as given by time(): &quot;.time().&quot;\n&quot;;</p>
<p>$strtime = date(&quot;Y-n-j H:i:s&quot;, $time);<br />
print &quot;time in format: Y-n-j H:i:s: $strtime\n&quot;;</p>
<p>$time2 = strtotime($strtime);<br />
print &quot;strtotime on (Y-n-j H:i:s): $time2\n&quot;;</p>
<p>$startday = mktime(0, 0, 0, date(&quot;m&quot;,$time), date(&quot;d&quot;,$time), date(&quot;Y&quot;,$time));<br />
print &quot;start of day time as used in input processor: &quot;.$startday.&quot;\n&quot;;</p>
<p>print &quot;time now minus start of day time in hours: &quot;.(($time - $startday) / 3600).&quot;\n&quot;;</p>
<p>with date_default_timezone_set(&#39;UTC&#39;); commented out changes to local time resulted in a different $startday time. That doesnt explain the negative kwh value but it may explain an offset in the time of a daily value.</p>
<p>It looks like it would be a good idea to add:</p>
<p>date_default_timezone_set(&#39;UTC&#39;);</p>
<p>to the top if index.php as an initial step. I could also add some sanity checks to the input processors to check that the time difference between current time and last time is not negative.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28920"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Sun, 22/03/2015 - 23:33.</div>
    <div class="content">
     <p>I&#39;ve set the localtime timezone settings on emoncms.org with:</p>
<p>sudo dpkg-reconfigure tzdata</p>
<p>to Etc/UTC</p>
<p>which may be the equivalent of setting php to use UTC only with:</p>
<p>date_default_timezone_set(&#39;UTC&#39;);</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28924"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 23/03/2015 - 00:38.</div>
    <div class="content">
     <p>I&#39;ve always had trouble getting my head around what the intended&nbsp;result is. &nbsp;Let&#39;s say the house being monitored is in Sydney, the emoncms server is in London, and the viewer and his webbrowser are in Sydney.</p>
<p>I assume any per-day totals in that case are meant to be measured midnight-to-midnight Sydney time, right? &nbsp;When Sydney puts its clocks forward 1 hour for summer time are they now measured midnight-to-midnight using the clock on the wall&nbsp;(i.e. an hour earlier than they were) or are they now measured 1am-1am&nbsp;using the clock on the wall (i.e. at exactly the same time they used to be measured). &nbsp;I guess either would work but the former introduces a 1hr jitter to the length of days at the beginning and end of summer time.</p>
<p>Now lets say the viewer and his webbrowser head off to San Francisco and want to check out their Sydney house remotely (server still in London). &nbsp;Presumably you want the per-day totals to still be anchored in Sydney time and not to be impacted by the http client timezone?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28927"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Mon, 23/03/2015 - 09:20.</div>
    <div class="content">
     <p>Hello dBC, my long term plan is to make daily kwh data independent of timezone by moving over to recording the total accumulating watt hours and then calculating daily data on the fly when you want to view a graph, I detailed this in more detail here: <a href="3995.html" title="http://openenergymonitor.org/emon/node/3995">http://openenergymonitor.org/emon/node/3995</a></p>
<p>There are quite a few things that are needed to get this to fully work. The browser would need to know what timezone to request and Im currently working on a fix to the phpfina feed engine that will fix the issue that caused some days to return null values.</p>
<p>But yes its the behaviour you detail that is the expected result. I think Chaveiro&#39;s recent work aims to fix this for the existing kwh/d daily data method.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28930"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Mon, 23/03/2015 - 11:18.</div>
    <div class="content">
     <p>Don&#39;t use date_default_timezone_set() in PHP scripts, set it in php.ini to be the same as linux timezone or epoch may return incorrect.<br />
Use DateTime.Timezone class to do timezone conversions instead.</p>
<p>Setting system Timezone to &#39;UTC&#39; is bad because different UTC countries may have diferent DST settings. Always use localized timezone, ex.: Europe/London.</p>
<p>From google: &quot;Zones like Etc/GMT+6 are intentionally reversed for backwards compatibility with POSIX standards. You should almost never need to use these zones. Instead you should be using a fully named time zone like America/New_York or Europe/London or whatever is appropriate for your location.&quot;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28931"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Mon, 23/03/2015 - 12:11.</div>
    <div class="content">
     <p>Regarding DBC question, daily kwh/d is timezone dependent on the sensor timezone.</p>
<p>Emoncms expect a user account to be in one timezone and all sensor nodes to be in the same timezone.</p>
<p>You cant have one account with nodes from diferent timezones, for that create a user for each different timezone and group nodes on the same instalation timezone to the user account with that timezone.</p>
<p>Browser device timezone only affects viewed data.</p>
<p>If nodes are in Sydney, set user timezone to Autralia/Sydney, independent of where server is.</p>
<p>If it&#39;s 23h in Sydney and client browser device is in London timezone, he will see &#39;now&#39; data at London 12h (Sydney is 11h ahead of London).</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28934"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Mon, 23/03/2015 - 12:33.</div>
    <div class="content">
     <p>Hi Trystan, I think you are probably&nbsp;right there are 2 distinct areas of concern, but the &quot;daily totaling&quot; seems to make it extremely difficult to separate them, I was perhaps optimistic the &quot;Fix all timezone issues&quot; title did in fact mean just that, but unable to confirm this with any real confidence&nbsp;from the code<span style="line-height: 20.7999992370605px;">&nbsp;</span><span style="line-height: 20.7999992370605px;">myself</span><span style="line-height: 1.6;">.</span></p>
<p><span style="line-height: 1.6;">My overall concerns are with global use, but wouldn&#39;t expect any other timezone&nbsp;to be correct unless UTC/GMT/BST functioned correctly hence using my own experience as a case study.&nbsp;</span></p>
<p><span style="line-height: 1.6;">Last autumn there were several errors reported&nbsp;and at the time I felt the cause was an overlap causing issues with read-only feeds and whaccumulators, the clocks go forward this weekend so the potential issues will be different.</span></p>
<p>The &quot;daily totals&quot; will always&nbsp;be problematic no matter what, even when the timezone side of things is functioning well if you edit any past data the &quot;daily totals&quot; are not updated. The &quot;on the fly&quot; method will bring so much flexibility and improve accuracy whilst reducing the number of feeds, simplifying process lists and reduce size on disk. (the same applies to max&nbsp;and min daily feeds)</p>
<p>So putting &quot;dailies&quot;&nbsp;to one side for a moment it becomes clearer (to me at least) &nbsp;that the 2 distinct&nbsp;areas are saving the data which should always be unix time aka&nbsp;epoch and then reporting the data which should be in the target timezone.</p>
<p>Since most&nbsp;incoming data starts&nbsp;with a unix timestamp I would expect that to be saved untouched but I assume it does/did go through some form &quot;time zone adjustment&quot; for overlaps to occur. Can you confirm if any adjustments are done? If they are I assume they are offset for the dailies which should happen only for the dailies.</p>
<p>When a data frame arrives via the api without a timestamp is it given a unix timestamp or is it given a local timestamp? and by that I&#39;m referring to the servers localtime rather than the users localtime ie is emoncms making a DST adjustment independent of user timezone?</p>
<p>My ambition here was to determine whether we are always saving all data points in unixtime&nbsp;regardless of feed&nbsp;type, time of year or time&nbsp;zone. because&nbsp; IMHO this is essential for anything else to work. everything else is reliant on this.&nbsp;</p>
<p>I also wonder whether we need to be defining &quot;which&quot; unix time aka&nbsp;epoch we should use since there should only be one. if it needs to be defined does this not suggest it&#39;s not correctly defined on the server and localtime is being used?</p>
<p>chaveiro - regarding your reply to dBC&nbsp;above, I agree that is currently the better way as the daily totals are TZ dependent, can you confirm if whilst viewing a realtime&nbsp;graph for a property in&nbsp;Sydney&nbsp;from&nbsp;San Francisco that the time window displayed would be labelled&nbsp;in&nbsp;Sydney localtime intervals ie account TZ NOT browser time</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28938"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 23/03/2015 - 13:06.</div>
    <div class="content">
     <p><i>"When a data frame arrives via the api without a timestamp is it given a unix timestamp or is it given a local timestamp? and by that I'm referring to the servers localtime rather than the users localtime ie is emoncms making a DST adjustment independent of user timezone?"</i></p>
<p>Here's my two penn'orth:<br />
<b><i>Provided that</i></b> the data is only generated, stored and used within one timezone, it doesn't matter. Once any one of those conditions is broken, it <b><i>does</i></b> matter and so that emonCMS.org and (local RPi) emonCMS can remain the same piece of software, and so that a user who has enabled web access can get the correct view in San Francisco of his data from Sidney, the only way to do it is for everything to be stored in Unix time and to convert to and from Unix time each time the data enters or leaves the database.<br />
If you use a local timestamp, DST gives you almost exactly the same problem as does a different timezone. If you want to use a "local" time for labelling data in the database, it must remain at a static offset with respect to Unix time and not shift with DST.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28942"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Mon, 23/03/2015 - 13:34.</div>
    <div class="content">
     <p>I think we&#39;re on the same page</p>
<p>I agree with that 100% and would prefer we used ONLY unix time for storing data, but as I suspect this has not been the case previously I am trying to establish if that is by design or error.</p>
<p>My question to chaveiro&nbsp;was to confirm that perceived &quot;local time&quot; was the accounts&nbsp;TZ thoughout and not further confused by user location. The only 2 real &quot;times&quot; in play should be unix time for all recorded datapoint&nbsp;timestamps and the &quot;local time&quot; which should be the DST adjusted TZ of the account, (probably the property location but not mandatory.) used for ALL reporting and graphing, plus reseting the &quot;dailies&quot; until &quot;on the fly&quot; totals are implemented.&nbsp;</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28947"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Mon, 23/03/2015 - 15:36.</div>
    <div class="content">
     <p>Thanks for your thoughts on this. Most of the timing in emoncms is done with time() which should be UTC and so not be affected by DST changes.</p>
<p>There is a slightly confusing remnant from when timestamps where not recorded as unix timestamps in the feed last time:values. These are stored in the format $strtime = date(&quot;Y-n-j H:i:s&quot;, $time); and then converted back to unix time $time2 = strtotime($strtime); That conversion appears to work fine under locatime changes with the same unix time stamp being returned as was used in the date function. Id like to remove that and just use unix timestamp throughout because there&#39;s no point storing the timestamp in the Y-n-j H:i:s format anyway.</p>
<p>The way the midnight time is currently calculated for daily data is here <a href="https://github.com/emoncms/emoncms/blob/master/Modules/input/process_model.php#L670" title="https://github.com/emoncms/emoncms/blob/master/Modules/input/process_model.php#L670">https://github.com/emoncms/emoncms/blob/master/Modules/input/process_mod...</a>. The desired result here is for it to return midnight UTC and then for the - ($this-&gt;timezoneoffset * 3600); I realise now that I got this wrong as mktime is affected by system localtime. It looks like chaveiro&#39;s suggestion of using:</p>
<p>$now = DateTime::createFromFormat(&quot;U&quot;, $time_now);<br />
$now-&gt;setTimezone(new DateTimeZone($this-&gt;timezone));<br />
$now-&gt;setTime(0,0); // Today at 00:00<br />
return $now-&gt;format(&quot;U&quot;);</p>
<p>would fix this as the $this-&gt;timezone input is default &quot;UTC&quot; or &quot;Europe/London&quot; etc and as long as DateTime handles this all correctly then the output should be a unix timestamp that corresponds to midnight in the users timezone.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28953"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Mon, 23/03/2015 - 16:14.</div>
    <div class="content">
     <p>The switch from the current implementation to chaveiro&#39;s suggestion will need some thought as the current use of</p>
<p>mktime(0, 0, 0, date(&quot;m&quot;,$time_now), date(&quot;d&quot;,$time_now), date(&quot;Y&quot;,$time_now)) - ($this-&gt;timezoneoffset * 3600);</p>
<p>should work ok if the timezoneoffset = 0 and the server&#39;s localtime is the users timezone for local/rpi or own server installs. If the change of implementation leads to a period where the timezone changes to UTC and then back to the correct user timezone that would cause some misaligned data. I cant see anything that would stop this from happening at the moment but would probably only be a minor thing to fix.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29050"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Thu, 26/03/2015 - 20:57.</div>
    <div class="content">
     <p>Check this: <a href="https://github.com/emoncms/emoncms/pull/309" title="https://github.com/emoncms/emoncms/pull/309">https://github.com/emoncms/emoncms/pull/309</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-29527"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Thu, 09/04/2015 - 20:47.</div>
    <div class="content">
     <p>Following the UK DST changeover, all previous&nbsp;daily feed data has disappeared!!</p>
<p><a href="10365.html#comment-29520">See this post</a></p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-30931"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8253.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Grimshad&#039;s picture" title="Grimshad&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Release] EmonCMS - Fix all timezone issues.</h3>

    <div class="submitted">Submitted by <a href="../user/8253.html" title="View user profile.">Grimshad</a> on Fri, 05/06/2015 - 02:07.</div>
    <div class="content">
     <p>Did this ever get in? My kWh/d resets at UTC instead of my time.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10363"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-3Ebw1qnDlHOSLU5VkBGwB0KrGI2uMvXby-q2ZSS-CyE" value="form-3Ebw1qnDlHOSLU5VkBGwB0KrGI2uMvXby-q2ZSS-CyE"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
