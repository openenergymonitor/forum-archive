<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1943 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:05:47 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Battery-efficient pulse measurement | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Battery-efficient pulse measurement</h3>
        <span class="submitted">Submitted by Guest on Mon, 21/01/2013 - 18:39</span>
        <div class="content"><p>Hi,&nbsp;</p>
<p>I have setup a system with two emonTx&#39;s, one that measures power consumption for heating and incoming power from the solar panels, both with CT&#39;s. The other emonTx is measuring pulses from the main unit for all incoming power. Unfortunately I have no other way of measuring total incoming power.</p>
<p>My problem is that I don&#39;t know how to setup a pulse measuring sketch that is battery efficient. The one I have now sends results every 15 seconds, but it chewed through 2 AA batteries in 4 days. I have read that you should put the RF module to sleep, which I do, but still it is not good enough. I can live with not being able to see current power level so often, but I will need to measure the total consumption on a daily level. How can this be done? Can I calculate kWh, i.e. collect total pulses, and then do the calculation in emonCMS?</p>
<p>Is their any other ways of conserving battery power for pulse counting?</p>
<p>thanks</p>
  <div class="forum-topic-navigation clear-block">
          <a href="959.html" class="topic-previous" title="Go to previous forum topic">‹ DS18B20 temperature sensor</a>
              <a href="1937.html" class="topic-next" title="Go to next forum topic">Multiple pulse counting with Arduino Mega? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-9285"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="o_cee&#039;s picture" title="o_cee&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by o_cee (not verified) on Mon, 21/01/2013 - 20:28.</div>
    <div class="content">
     <p>AFAIK, as soon as you put the cpu to sleep, you loose track of time. So it is not possible to calculate momentary power. Only counting pulses should be possible to make efficient, since you can put the cpu to sleep and wake it up on interrupt from the sensor.</p>
<p>I don&#39;t know if it&#39;s possible to calculate momentary power in emoncms, but I have a feeling that it will be hard to get good enough accuracy.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9291"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mickiii&#039;s picture" title="mickiii&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by mickiii (not verified) on Tue, 22/01/2013 - 06:39.</div>
    <div class="content">
     <p>Would it be possible to simply calculate pulse count, and then once every 5-10 minutes send it to the base, and then subsequently divide the count by the no. of counts per. kWh on then emonCMS side? It would be nice to know momentary power, but not for the cost of new batteries every other week.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9293"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 22/01/2013 - 10:45.</div>
    <div class="content">
     <p>Are you sure the CPU is actually going to sleep between transmissions?</p>
<p>The version of emontx_lib that I looked at just has..</p>
<p>void emontx_sleep(int seconds) {<br />
	&nbsp;&nbsp;&nbsp; for (int i=0; i&lt;seconds; i++) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay(1000);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (UNO) wdt_reset();<br />
	&nbsp;&nbsp;&nbsp; }<br />
	}</p>
<p>I can&#39;t see anything in the Arduino documentation that says delay() puts the CPU in sleep mode (but that doesn&#39;t mean that it doesn&#39;t!).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9295"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Tue, 22/01/2013 - 11:20.</div>
    <div class="content">
     <p>I concur with Martin the MCU is not being put to sleep only the RFM12.</p>
<p>I think if you add this in at the end of your loop in the main sketch it will put the MCU to sleep for the time period defined in ms.</p>
<p><strong>Sleepy::loseSomeTime(time_between_readings);</strong></p>
<p>So for 5 mins it would be</p>
<p><strong>Sleepy::loseSomeTime(300000);</strong></p>
<p>For 10 mins it would be</p>
<p><strong>Sleepy::loseSomeTime(600000);</strong></p>
<p>Its tied into this part of code at the beginning of the sketch I believe.</p>
<p><strong>ISR(WDT_vect) { Sleepy::watchdogEvent(); }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Attached JeeLib sleep function to Atmega328 watchdog - enables MCU to be put into sleep mode inbetween readings to reduce power consumption</strong></p>
<p>&nbsp;</p>
<p><strong>*EDIT: Ignore that, it will miss the pulses if its asleep...</strong></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9296"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 22/01/2013 - 11:36.</div>
    <div class="content">
     <p>It will wake up on the pulse interrupt though won&#39;t it?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9297"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="o_cee&#039;s picture" title="o_cee&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by o_cee (not verified) on Tue, 22/01/2013 - 12:16.</div>
    <div class="content">
     <p>Interrupt will wake it up, yes.</p>
<p>Have you read this?<br />
	<a href="https://learn.openenergymonitor.org/?redirect=pulse-counting-sleep" title="http://openenergymonitor.org/emon/buildingblocks/pulse-counting-sleep">http://openenergymonitor.org/emon/buildingblocks/pulse-counting-sleep</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9298"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/450.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by <a href="../user/450.html" title="View user profile.">stuart</a> on Tue, 22/01/2013 - 14:05.</div>
    <div class="content">
     <p>Do it differently, does the meter have an infrared port?&nbsp; Use that to read the values every few minutes, you can sleep inbetween reads then.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9318"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mickiii&#039;s picture" title="mickiii&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by mickiii (not verified) on Wed, 23/01/2013 - 08:41.</div>
    <div class="content">
     <p>Yes, the meter has an infrared port. How would that work, is there a sketch I can refer to? Also, I assume the same sensor can be used as the one for pulses right?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9368"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Thu, 24/01/2013 - 15:38.</div>
    <div class="content">
     <p>Mickiii,</p>
<p>I modified the low power sketch yesterday for my own battery powered wireless pulse node for my gas meter outside.&nbsp; I am only using it to count the pulses and not the power calculation stuff.</p>
<p>I&#39;m putting the MCU into low power mode using the function in jeelib in between pulses and then sending the data to the emonbase roughly every 15mins (its not accurate).&nbsp; Note that there is some code in there requesting an ACK from the emonbase so data doesn&#39;t go missing.</p>
<p>If you wanted to measure on a daily basis you could in theory stretch the 15mins to a whole day.</p>
<p>The node is powered by a 9v battery because as it happens it was the only connector I had laying around so the voltage regulator is still being used.</p>
<p>I have put the sketch on Github.&nbsp; Its the first time I have really used it so I have no idea if I have done it correctly.</p>
<p><a href="https://github.com/StuntMonkeh/emonTxFirmware/tree/master/emonTx_Pulse_LowPower">https://github.com/StuntMonkeh/emonTxFirmware/tree/master/emonTx_Pulse_LowPower</a></p>
<p>Hope its of some help.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9377"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="mickiii&#039;s picture" title="mickiii&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by mickiii (not verified) on Thu, 24/01/2013 - 18:26.</div>
    <div class="content">
     <p>Thank you, I really appreciate it. I will have a look at it, and try to modify it to my needs.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9379"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="o_cee&#039;s picture" title="o_cee&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by o_cee (not verified) on Thu, 24/01/2013 - 18:52.</div>
    <div class="content">
     <p>StuntMonkeh: &nbsp;Take a look at this:&nbsp;http://arduino.cc/forum/index.php/topic,45239.0.html &nbsp;You should handle reading of shared data properly, switching off interrupts to avoid possible corruption. The original code should be updated for this as well, haven&#39;t had time to submit a patch yet.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9386"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Fri, 25/01/2013 - 10:19.</div>
    <div class="content">
     <p>I read the link last night and again this morning.&nbsp; I&#39;m thoroughly confused.</p>
<p>Am I right in thinking I need to turn off the ability for the input to trigger an interrupt after it has been triggered.</p>
<p>So I assume it needs to go a little something like this;</p>
<p>1. Pulse from meter.</p>
<p>2. Interrupt occurs.</p>
<p>3. Turn off interrupt functionality for the input pin.</p>
<p>4. Count the pulse.</p>
<p>5. Turn the interrupt functionality for the input pin back on.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9387"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="o_cee&#039;s picture" title="o_cee&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Battery-efficient pulse measurement</h3>

    <div class="submitted">Submitted by o_cee (not verified) on Fri, 25/01/2013 - 11:06.</div>
    <div class="content">
     <p>No, you need to turn it off when reading the pulse count (or any other multi byte global variables which is written to in the interrupt handler) from loop().</p>
<p>Here is also some good information:&nbsp;<a href="http://www.gammon.com.au/forum/?id=11488">http://www.gammon.com.au/forum/?id=11488</a>&nbsp; especially in the section called &quot;Critical sections ... accessing volatile variables&quot;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1943"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-RtMpssrgI7bK-Nhj_DDhiIzuq7Xr1V_C7l24D9tjQqI" value="form-RtMpssrgI7bK-Nhj_DDhiIzuq7Xr1V_C7l24D9tjQqI"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
