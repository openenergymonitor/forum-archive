<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11354 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:58:37 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Analog voltage reference with a precise voltage reference. | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Analog voltage reference with a precise voltage reference.</h3>
        <span class="submitted">Submitted by <a href="../user/8481.html" title="View user profile.">SimonK</a> on Fri, 09/10/2015 - 12:26</span>
        <div class="content"><p>Im playing with an arduino and one CT and AC - AC on analog pins.</p>
<p>The circuits for CT an AC-AC are powered from 3.3V.</p>
<p>The board (arduino) from 5V (USB).</p>
<p>&nbsp;</p>
<p>Can I use a precise voltage reference ? (I have one with 4.096V)</p>
<p>Do I need to change anything ? (arduino AREF is set to external and has the VREF connected to it).</p>
<p>And code changes needed for calculations to the voltage read by the analog pins ?</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11369.html" class="topic-previous" title="Go to previous forum topic">‹ Solar PV Type 2 monitoring</a>
              <a href="11325.html" class="topic-next" title="Go to next forum topic">Measuring inductive loads such as washing machines produces errors in power factor ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-34787"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 09/10/2015 - 12:39.</div>
    <div class="content">
     <p>You will be using only 80% of the input range, unless you shift the bias voltage to 2.048 V by changing resistors. You need to tell emonLib that your reference is 4.096 V, and the starting point for the digital filters is no longer half way (assuming you don't change the bias resistors). You'll need to modify your copy of emonLib to achieve this. If you look at emonlib.cpp, it should be fairly obvious what you need to do.</p>
<p>I've never tried that configuration, so I don't know what else you might need to do. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34788"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8481.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="SimonK&#039;s picture" title="SimonK&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/8481.html" title="View user profile.">SimonK</a> on Fri, 09/10/2015 - 12:50.</div>
    <div class="content">
     <p>So if I shift the bias voltage to 2.048V and set the SupplyVoltage to 4.096V it should work ?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34790"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 09/10/2015 - 14:32.</div>
    <div class="content">
     <p>I can't see a reason why not. You'll probably want to run one of Robin's utility sketches to check that the input is biased to the right place and the waveforms look right, and of course you can if you wish adjust the voltage divider/burden resistor to take advantage of the 25% or so extra input swing you have.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34793"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8481.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="SimonK&#039;s picture" title="SimonK&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/8481.html" title="View user profile.">SimonK</a> on Fri, 09/10/2015 - 15:16.</div>
    <div class="content">
     <p>Thx, and where do I find the sketches ?</p>
<p>Had no luck finding them.</p>
<p>EDIT: found them! Which one should I use ?<br />
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34794"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Fri, 09/10/2015 - 15:41.</div>
    <div class="content">
     <p><em>Which one should I use ?</em></p>
<p>This one: <a href="../sites/default/files/rawSamplesTool.ino_.zip">http://openenergymonitor.org/emon/sites/default/files/rawSamplesTool.ino_.zip</a></p>
<p>or</p>
<p>this one: <a href="../sites/default/files/RawSamplesTool_4ss_2.ino_.zip">http://openenergymonitor.org/emon/sites/default/files/RawSamplesTool_4ss_2.ino_.zip</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34801"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 09/10/2015 - 22:13.</div>
    <div class="content">
     <p><em>Do I need to change anything ? (arduino AREF is set to external and has the VREF connected to it).</em></p>
<p>Just be aware that&nbsp;EnergyMonitor::readVcc() unconditionally sets it back to AVCC, not by calling analogReference() but by directly banging on ADMUX. &nbsp; &nbsp;The library and those raw sample tools call readVcc() and if you run that code unmodified on your setup you will destroy your processor.</p>
<p>I think for your hardware&nbsp;you want a modified readVcc() that unconditionally returns 4096 and <strong>NEVER</strong>&nbsp;writes to ADMUX.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34810"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 10/10/2015 - 11:31.</div>
    <div class="content">
     <p>dBC:</p>
<p>Do you have any information about the <i>stability</i> of the internal reference? We know the initial value is imprecise (1.0 < 1.1 < 1.2 V), but what effect does supply voltage, ageing and temperature have? I can't find any specific information for the 328P, only generic data on band-gap devices generally.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34813"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 10/10/2015 - 12:48.</div>
    <div class="content">
     <p>I&#39;ve only ever used the 2.56V internal reference&nbsp;available on some AVR devices (including the 2560 used for the measurements below), and like you I&#39;ve not been able to find any specific data. &nbsp; My 3.3V Vcc is stable down to the mV, so of the parameters you listed,&nbsp;temperature is the only one I&#39;ve studied in detail, and it&#39;s not that great.</p>
<p>The attached plot shows the 2.56V bandgap over a 12C temperature range. &nbsp;It varies by 4.569mV or about 0.18%, or about 1.8 AtoD units, so&nbsp;it&#39;s barely stable enough for a 10-bit AtoD. &nbsp;Since moving to 14-bit AtoD conversions (courtesy of oversampling) I&#39;ve also moved to an external Vref, which is more&nbsp;temperature stable&nbsp;(approx 30ppm/degC, or about 5x better than the measured internal bandgap performance).</p>
<p><img alt="" src="../sites/default/files/bandgap_temp.png" style="width: 480px; height: 373px;" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34814"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 10/10/2015 - 12:59.</div>
    <div class="content">
     <p>That's useful knowledge, thanks. As you say, not that great but a lot better than the &plusmn;10% of the initial value. I've always been a little dubious over the use of the nominal value of the Vcc supply as the basis of the calculations, because of the effect of device tolerance, temperature, load and supply variations on the true value, but the data seemingly doesn't exist to prove the question one way or the other.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34816"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 10/10/2015 - 13:19.</div>
    <div class="content">
     <p>Yes, I guess it comes down to which you think is the more stable: &nbsp;Vcc, or the 1.1V bandgap&nbsp;used by readVcc() in order to &quot;measure&quot;&nbsp;Vcc.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34817"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Sat, 10/10/2015 - 17:26.</div>
    <div class="content">
     <p><em>what effect does supply voltage, ageing and temperature have?</em></p>
<p>Here&#39;s two plots (one for the 328 the other for the 328P) that show Bandgap vs V<sub>cc</sub> at three different temperatures for the 328, and four different temps for the 328P.</p>
<p>Taken from the Atmel datasheet:<br />
<a href="http://www.atmel.com/images/Atmel-8271-8-bit-AVR-Microcontroller-ATmega48A-48PA-88A-88PA-168A-168PA-328-328P_datasheet_Complete.pdf">www.atmel.com/images/Atmel-8271-8-bit-AVR-Microcontroller-ATmega48A-48PA-88A-88PA-168A-168PA-328-328P_datasheet_Complete.pdf</a> pages 485 and 510.</p>
<p>Couldn&#39;t find any data on ageing. <strong>:-(</strong></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34818"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Analog voltage reference with a precise voltage reference.</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 10/10/2015 - 18:25.</div>
    <div class="content">
     <p>A good find, Bill, thanks. I can do some sums with that.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11354"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-5GcaKDF06rJd7QOUuuVkmAcyJPtiV-d0ayoPc9h_kC0" value="form-5GcaKDF06rJd7QOUuuVkmAcyJPtiV-d0ayoPc9h_kC0"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
