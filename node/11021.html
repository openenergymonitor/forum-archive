<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11021 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:46:35 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Success using the STM32F103 microcontroller | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Success using the STM32F103 microcontroller</h3>
        <span class="submitted">Submitted by Guest on Wed, 22/07/2015 - 23:32</span>
        <div class="content"><p>I want to thank the community for there excellent work on this project, and I&#39;m happy to report that eMonLib works fine on the STM32F103 microcontroller using the third party hardware support files for the Arduino IDE.</p>
<p>&nbsp;</p>
<p>I have written some details on the STM32duino forum <a href="http://stm32duino.com/viewtopic.php?f=19&amp;t=447">http://stm32duino.com/viewtopic.php?f=19&amp;t=447</a></p>
<p>Basically the current / latest version of eMonLib compiles without any changes. The STM32 is an ARM board, and hence the ARM specific code is being used.</p>
<p>Luckily the ADC&#39;s in the STM32F103 are 12 bit, so I didn&#39;t need to change the header, as this is set for 12 bits on ARM. (Note. Not all STM32 boards have 12 bit ADC&#39;s, some STM32F3 series boards have 16 bit ADC&#39;s )</p>
<p>However the majority of cheaply available STM32 boards are based on the STM32F103C8 or STM32F103CB .</p>
<p>These devices have 72Mhz clocks, 20k RAM, and either 64 or 128k flash, and cost around $5 on eBay or AliExpress.</p>
<p>Like all ARM based boards, they operate at 3.3V rather than 5V, so the input signal conditioning needs to be adjusted to suit the max voltage range, i.e the voltage dividers on both the current and voltage sensors need to be changed slighltly.</p>
<p>The downside of using any non-AVR based microcontroller is the limited support for other hardware libraries, as well as issues conecting to peripherals that require 5V signals (However its now more common for most peripherals to be 3.3V hence the Microcontroller operating on 3.3V is often a benefit)</p>
<p>At the moment I don&#39;t think there is a port for the RadioHead library, but their are ports for the NRF24 series.</p>
<p>Electrical / hardware connection to peripherals is generally not a big issue, as most modern peripherals now seem to be using 3.3V signals, and most 5V devices accept 3.3V as a logic High on their input.</p>
<p>The only device I have found so far that doesn&#39;t work on 3.3 is a 7 segment LED driver.</p>
<p>&nbsp;</p>
<p>On the plus side. Using the STM32 gives you loads more RAM (20k on even the most basic board), and plenty of Flash (normally 128k), and the STM32 has 9 analog inputs each of 12 bits, with faster acquisition time than on AVR.</p>
<p>For any interested in the full spec on some STM32 devices, take a look at this page on Sparkfun</p>
<p><a href="https://www.sparkfun.com/products/retired/11280" title="https://www.sparkfun.com/products/retired/11280">https://www.sparkfun.com/products/retired/11280</a></p>
<p>&nbsp;</p>
<p>Then do a search on eBay e.g.</p>
<p><a href="http://www.ebay.co.uk/sch/i.html?_from=R40&amp;_trksid=p2050601.m570.l1313.TR11.TRC1.A0.H0.Xmaple+mini+stm32.TRS0&amp;_nkw=maple+mini+stm32&amp;_sacat=0" title="http://www.ebay.co.uk/sch/i.html?_from=R40&amp;_trksid=p2050601.m570.l1313.TR11.TRC1.A0.H0.Xmaple+mini+stm32.TRS0&amp;_nkw=maple+mini+stm32&amp;_sacat=0">http://www.ebay.co.uk/sch/i.html?_from=R40&amp;_trksid=p2050601.m570.l1313.T...</a></p>
<p>&nbsp;</p>
<p>So thanks again to the OpenEnergyMonitor team, and I will endevour to keep this thread updated as I add things like an ILI9341 display <a href="http://www.ebay.co.uk/sch/i.html?_odkw=maple+mini+stm32&amp;_osacat=0&amp;_from=R40&amp;_trksid=p2045573.m570.l1313.TR1.TRC0.A0.H0.Xili9341.TRS0&amp;_nkw=ili9341&amp;_sacat=0" title="http://www.ebay.co.uk/sch/i.html?_odkw=maple+mini+stm32&amp;_osacat=0&amp;_from=R40&amp;_trksid=p2045573.m570.l1313.TR1.TRC0.A0.H0.Xili9341.TRS0&amp;_nkw=ili9341&amp;_sacat=0">http://www.ebay.co.uk/sch/i.html?_odkw=maple+mini+stm32&amp;_osacat=0&amp;_from=...</a></p>
<p>and an NRF905 to my energy monitor.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11038.html" class="topic-previous" title="Go to previous forum topic">‹ Measuring 240V split phase devices using only one CT?</a>
              <a href="11003.html" class="topic-next" title="Go to next forum topic">Monitoring data traffic ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-32483"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 23/07/2015 - 00:17.</div>
    <div class="content">
     <p><i>"Like all ARM based boards, they operate at 3.3V rather than 5V, so the input signal conditioning needs to be adjusted to suit the max voltage range, i.e the voltage dividers on both the current and voltage sensors need to be changed slighltly."</i></p>
<p>No they won't (nor the default calibration) if you use the emonTx values, which also uses a 3.3 V supply.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32489"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Thu, 23/07/2015 - 03:58.</div>
    <div class="content">
     <p>Hi Robert</p>
<p>Although the voltage dividers to create the mid point bias/offset voltage don&#39;t need to be changed, voltage dividers for both the voltage sense and the current sense are not likely to be the same , i.e if you already had built some external signal conditioning for an AVR baord,</p>
<p>i.e My understanding is that for best accurary, the AC input from the voltage sense, need to provide the AVR boards with just under 5V AC peak to peak, where as on ARM boards this needs to be just under 3.3V peak to peak.</p>
<p>As I&#39;m building this from scratch, with the signal conditioning on a piece of Veroboard, I &#39;m using a 10k trim pot to form the voltage sense divider, and I trimmed it to produce about 3V for 250V input. and also trimmed current sense input to give around 3V P/P when there is a 4kW load</p>
<p>I still need to clamp the max current at 4kW, as I know the read damand could exceed 4kW but I don&#39;t have the capacity to export more than 4kW, and managing the amount of power that is exported vs used for heating etc, is my main aim.</p>
<p>Hence I&#39;m aiming for best accuracy up to 4kW and anything above that, will be dealt with by the software.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32491"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 23/07/2015 - 06:11.</div>
    <div class="content">
     <p>You can run the AVR at 5V or 3.3V and some of the OEM designs do use 3.3V.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32492"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Thu, 23/07/2015 - 06:30.</div>
    <div class="content">
     <p>@dBC</p>
<p>Thanks. I was aware that AVR can be run at 3.3V, but at 3.3V, I think you need to lower the clock frequency to stay within the spec (thats not to say that most chips don&#39;t work fine at 16Mhz on 3.3V)</p>
<p>My main reason for posting, was just to let the community know that that eMonLib compiles and works fine on STM32 devices, as there are many libs that don&#39;t work on ARM boards or the STM32</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32493"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Thu, 23/07/2015 - 07:47.</div>
    <div class="content">
     <blockquote><p>... to let the community know that that eMonLib compiles and works fine on STM32 ...</p>
</blockquote>
<p>I think this is very nice to hear as the Atmel 8-bitter is &#39;at the edge&#39; regarding performance for a lot of the energy monitoring stuff (one of the reasons why it is overclocked&nbsp; at 16MHz and 3V3!), especially in three-phase systems and when other functionality has to be added (temperature sensing, RF connection, ethernet).</p>
<p>The ARM controllers are a &#39;natural&#39; replacement for the Atmel, the only problem is that there are so many of them around that it is hard to make a decision which one to use. But the &#39;Maple&#39; like hardware with 12 bit ADC and Arduino compatibility seems to be a very good choice.</p>
<p>BR, J&ouml;rg.</p>
<p>&nbsp; &nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32496"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 23/07/2015 - 08:48.</div>
    <div class="content">
     <p>Yes, I certainly didn&#39;t mean to discourage your ARM work, indeed I&#39;ve long been suggesting&nbsp;it. &nbsp;I was just pointing out that any resistor work you need to do for 3.3V operation is presumably already done for the 3.3V AVR OEM designs, so you could potentially copy that.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32501"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Thu, 23/07/2015 - 11:28.</div>
    <div class="content">
     <p>@dBC</p>
<p>No discouragement taken ;-)</p>
<p>I&#39;ll have a look for some other 3.3V implementations, but at the moment my only issues seem to be related to the current clamp scaling values, which seem to need to be quite low , possibly because the ADC is 12 bits not 10 - but I&#39;m not sure, or possibly because I&#39;m limiting my range to around 4kW by having approx 200 ohm burden resistor on the current clamp</p>
<p>One thing I&#39;ve also just noticed is that if I swap the current clamp direction I&#39;m getting quite different results i.e different power being shown. But I doubt this is a ARM issue, and I presume this is a common question, so I&#39;ll endevour to track down the answer.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32503"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 23/07/2015 - 12:05.</div>
    <div class="content">
     <p><em>&nbsp;scaling values, which seem to need to be quite low , possibly because the ADC is 12 bits not 10&nbsp;- but I&#39;m not sure</em></p>
<p>That probably makes sense since all the readings will be 4x bigger. &nbsp;Your raw mid-line reading will be 2048 instead of 512, and your high peak will be approaching 4095 instead of 1023.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32512"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 23/07/2015 - 15:11.</div>
    <div class="content">
     <p><i>"One thing I've also just noticed is that if I swap the current clamp direction I'm getting quite different results i.e different power being shown."</i></p>
<p>The likeliest reason for that is voltage crosstalk, i.e. there is some voltage signal adding to the current signal, so when you reverse the orientation of the CT and hence invert the current signal, the voltage now subtracts, hence the difference.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32557"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Thu, 23/07/2015 - 22:04.</div>
    <div class="content">
     <p>Robert,</p>
<p>Thanks</p>
<p>I&#39;ll put my scope on the two analogue inputs and see whats going on.</p>
<p>&nbsp;</p>
<p>
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32560"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 23/07/2015 - 22:26.</div>
    <div class="content">
     <p>You probably need to take the CT off, and well away from, its cable and see what you read. If it's half the difference, there's your answer.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32570"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Thu, 23/07/2015 - 23:40.</div>
    <div class="content">
     <p>Robert,</p>
<p>Its possible my test rig is no good.&nbsp; I&#39;m using a plug / socket arrangement with separated live and neutral wires that is part of a commercial power monitor, but the L and N wires are in two quite short loops and they are not very far apart from each other, so there could be some inteference.</p>
<p>I&#39;ll probably need to make a better test rig cable</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32571"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 23/07/2015 - 23:58.</div>
    <div class="content">
     <p>I did measure the influence of adjacent cables on the 'shop' 100 A CT - see the report.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32573"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Fri, 24/07/2015 - 00:11.</div>
    <div class="content">
     <p>Can you post a link&nbsp; to that</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32574"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 24/07/2015 - 01:45.</div>
    <div class="content">
     <p><a href="https://learn.openenergymonitor.org/?redirect=report-yhdc-sct-013-000-current-transformer">http://openenergymonitor.org/emon/buildingblocks/report-yhdc-sct-013-000-current-transformer</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32579"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Fri, 24/07/2015 - 12:02.</div>
    <div class="content">
     <p>@dBC</p>
<p>Thanks for the link.</p>
<p>I don&#39;t know what I was doing wrong yesterday, but the difference between the power when flowing in different directions, has now been fixed.</p>
<p>I think I just had wildly wrong calibration figures, as I was running on a different PC, and was using the default calibration values.</p>
<p>My re-calibrated values are</p>
<p>&nbsp; emon1.voltage(PA0, 243,7.5);&nbsp; // Voltage: input pin, calibration, phase_shift<br />
&nbsp; emon1.current(PA1, 8.42);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Current: input pin, calibration.</p>
<p>The current calibration is low because I only want to read 2kW for max input voltage range, and also I suspect because the ADC range is 12 bits instead of 10 bits on AVR</p>
<p>I have noticed however an problem that I needed to fix</p>
<p>I checked the ADC inputs with no signal input, and the are the current input reading about 1860 when they should be reading about 2048 (half of 4095).</p>
<p>Checking the voltages on the pins, the voltage divider on the current input is wrong, reading around 1.45V instead of 1.6V, so it looks like one of my resistors is way out of tollerance, or the capacitor is resistive.</p>
<p>(The voltage input is fine)</p>
<p>I&#39;ll need to take the circuit apart and re-measure the resistors</p>
<p>This will of course be causing problems with my results, which are actually surprisingly good even though the current input voltage must be going below 0V for a small part of the waveform :-(</p>
<p>&nbsp;</p>
<p>I&#39;m also seeing a lot of supply noise coming in from the PC via USB, which I don&#39;t get at all when I run the board from a separate USB PSU. I don&#39;t think there is a lot I can do about this, apart from getting a powered USB hub, but I think I&#39;ll live with it for development.</p>
<p>&nbsp;</p>
<p>Just as a matter of interest, I timed by max min test sketch, and its performing a million samples in 7 secs, i.e 7uS per analogue sample (well the rest of the code is probably taking a few uS, so the sample is probably more like 4 or 5uS)</p>
<p>Looking at the code in calcVI, having faster sample times, may help with calculation precision, as its going to be in the while loop for a lot more iterations.</p>
<p>Also, I noticed that most variables are doubles, which is great, as the STM32 being ARM has proper double unlike AVR which AFIK typedef&#39;s double to float.</p>
<p>Of course processing doubles is going to take more cpu cycles (on any processor) than floats, so it would be interesting to compare the number of iterations in the main while loop of calcVI on STM32 vs a Uno etc</p>
<p>(But I&#39;ll leave that for another day)</p>
<p>&nbsp;</p>
<p>Anyway, thanks again for all your help</p>
<p>&nbsp;</p>
<p>Cheers</p>
<p>
Roger</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32581"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 24/07/2015 - 12:33.</div>
    <div class="content">
     <p>You might want to tune&nbsp;PHASECAL as well as I believe its current setting assumes the 110 usecs between sampling V and I, while your V and I samples will be much much closer together.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32591"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Fri, 24/07/2015 - 22:37.</div>
    <div class="content">
     <p>@dDB</p>
<p>I did change my phaseCal to 7.5 as this seemed to give me a power factor of 100.00 when runing a 2kW oil filled electric radiator.</p>
<p>I have one of those inline power meters which I&#39;m using as my calibration reference (actually I have 2 different types of these, so I should compare what they both read), and it shows 100% power factor for the radiator.</p>
<p>My calibration factor is about 7.5, which probably makes sense, as it would imply that the STM32 is sampling between 4 and 5 times faster than the AVR boards (if the default value for phaseCal is 1.7)</p>
<p>Generally the STM32&#39;s, running at 72Mhz come out at operating at around 5.5 times faster than a 16Mhz AVR, because of both the clock speed and also some instructions are more efficient on the ARM CPU.</p>
<p>However, the calculatuions of doubles on ARM vs I think doubles type defed to float&#39;s on AVR probably slow things a little in relative terms, so values of about 4 times larger for phaseCal on STM32 @ 72Mhz sound about right.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32593"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 24/07/2015 - 22:53.</div>
    <div class="content">
     <p><em>&nbsp;I only want to read 2kW for max input voltage range</em></p>
<p>You may have considered and dealt with this already, but in case not:&nbsp;if there&#39;s any chance a fault on the circuit being monitored will cause much larger power flows (at least until a fuse blows) then you need to consider what voltages/currents that will expose your ADC pins to. &nbsp; There&#39;s quite a bit of detail in the datasheet for your CPU about that under &quot;I/O current injection&quot;.</p>
<p>Also, if you &quot;amplified&quot; your CT output simply by increasing the burden there is a limit to how far you can do that before the signal starts to distort, or phase errors become large, but since you have a scope&nbsp;that should be easy to test.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32595"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Sat, 25/07/2015 - 00:18.</div>
    <div class="content">
     <p>@dBC</p>
<p>&nbsp;</p>
<blockquote><p>You may have considered and dealt with this already, but in case not:&nbsp;if there&#39;s any chance a fault on the circuit being monitored will cause much larger power flows (at least until a fuse blows) then you need to consider what voltages/currents that will expose your ADC pins to. &nbsp; There&#39;s quite a bit of detail in the datasheet for your CPU about that under &quot;I/O current injection&quot;.</p>
</blockquote>
<p>Thanks</p>
<p>I was going to clamp the input with zeners</p>
<blockquote><p>&nbsp;</p>
<p>Also, if you &quot;amplified&quot; your CT output simply by increasing the burden there is a limit to how far you can do that before the signal starts to distort, or phase errors become large, but since you have a scope&nbsp;that should be easy to test.</p>
</blockquote>
<p>&nbsp;</p>
<p>I will probably reduce the burden resistor a bit, (is a 200 ohm trim pot), and get a range up to 4kW.</p>
<p>However even at the moment I get a nice clean sine wave with about 200 Ohms as the burden.</p>
<p>I understand that impedance matching can cause problems if the burden resistor is wildly miss matched with the pickup coil.</p>
<p>My CT is a SCT-013-030 but I opened it up and removed the internal 68 ohm resistor, so that I can use an external variable resistor.</p>
<p>I&#39;m not sure if the 030 has the same coil as the SCT-013-000, but I know I&#39;m not the first person to convert a SCT-013-030</p>
<p>I took a look online and I noticed that one eBay vendor was selling a wide range of SCT-013 devices, some of which looked a bit more suitable for my application e.g. the SCT-013-010 claimed to give 1V per 10A, however it wasnt clear if this was 1V RMS or 1V P/P, I&#39;m assuming RMS i.e so P/P would be 2.82V at 10A i.e at 2.4 kW&nbsp; (assuming 240V supply)</p>
<p>But I&#39;ll carry on with testing my current config.</p>
<p>BTW. I am also interested in ESP8266 devices, but they only have 1 ADC. So I&#39;ve just ordered some 16 Channel analog mux modules, as it it should be possible with slight modification to the code to switch the input into the ADC via the Mux, and hence still read V and I</p>
<p>However, I suspect a bigger issue with the ESP8266 is that putting code in a tight loop while the signals are analysed, e.g. in calcVI, would cause drop out of its wifi operations.</p>
<p>So... I&#39;ve also ordered some EW3135 modules, which are a STM32F411CE microcontroller, paired with a wifi module (via SDIO I think)</p>
<p><a href="http://www.seeedstudio.com/depot/EMW3165-CortexM4-based-WiFi-SoC-Module-p-2488.html" title="http://www.seeedstudio.com/depot/EMW3165-CortexM4-based-WiFi-SoC-Module-p-2488.html">http://www.seeedstudio.com/depot/EMW3165-CortexM4-based-WiFi-SoC-Module-...</a></p>
<p>This would offload the sensing to the STM32F411CE, which is an exceptionally fast device</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32600"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Sat, 25/07/2015 - 11:04.</div>
    <div class="content">
     <p>Update.</p>
<p>I figured out my offset problem, was just the load of my scope, affecting the offset voltage divider.</p>
<p>Everything now seems to work really well.</p>
<p>This is not an entire fair comparison, but I tested an Nano using the same external circuit (but re-adjusted the trim pots for 5V P/P) and the Nano actually suffered more from supply noise, or possibly ADC noise of some other kind, than the STM32 does.</p>
<p>The voltage readings I see on the STM32 are far more stable.</p>
<p>With no load, I&#39;m seeing data like this (sampling over 100 crossing points, i.e 1 sec)</p>
<p>&nbsp;</p>
<p>242.30V RMS ,0.05A RMS ,-0.53W ,Powerfactor -4.28%<br />
242.57V RMS ,0.05A RMS ,-0.72W ,Powerfactor -5.57%<br />
243.00V RMS ,0.05A RMS ,-0.63W ,Powerfactor -5.10%<br />
243.09V RMS ,0.05A RMS ,-0.74W ,Powerfactor -6.71%<br />
243.12V RMS ,0.05A RMS ,-0.75W ,Powerfactor -6.15%<br />
243.51V RMS ,0.05A RMS ,-0.45W ,Powerfactor -4.02%<br />
243.48V RMS ,0.05A RMS ,-0.46W ,Powerfactor -3.83%<br />
243.22V RMS ,0.04A RMS ,-0.67W ,Powerfactor -6.33%<br />
243.76V RMS ,0.04A RMS ,-0.57W ,Powerfactor -5.24%<br />
243.69V RMS ,0.04A RMS ,-0.64W ,Powerfactor -5.96%<br />
243.56V RMS ,0.04A RMS ,-0.75W ,Powerfactor -7.06%<br />
243.32V RMS ,0.04A RMS ,-0.73W ,Powerfactor -6.95%<br />
243.14V RMS ,0.04A RMS ,-0.65W ,Powerfactor -6.14%<br />
243.43V RMS ,0.04A RMS ,-0.70W ,Powerfactor -6.59%<br />
243.15V RMS ,0.04A RMS ,-0.72W ,Powerfactor -6.85%<br />
243.14V RMS ,0.04A RMS ,-0.61W ,Powerfactor -5.87%<br />
242.77V RMS ,0.04A RMS ,-0.60W ,Powerfactor -5.72%</p>
<p>&nbsp;</p>
<p>On load of just over 2kW, I get values like this</p>
<p>33.92V RMS ,8.56A RMS ,2001.17W ,Powerfactor 100.00%<br />
233.80V RMS ,8.53A RMS ,1993.19W ,Powerfactor 100.00%<br />
234.09V RMS ,8.52A RMS ,1993.35W ,Powerfactor 100.00%<br />
234.15V RMS ,8.50A RMS ,1989.96W ,Powerfactor 100.00%<br />
234.61V RMS ,8.50A RMS ,1993.47W ,Powerfactor 100.00%<br />
234.37V RMS ,8.47A RMS ,1986.32W ,Powerfactor 100.00%<br />
234.43V RMS ,8.46A RMS ,1983.89W ,Powerfactor 100.00%<br />
234.40V RMS ,8.45A RMS ,1980.42W ,Powerfactor 100.00%<br />
234.31V RMS ,8.43A RMS ,1976.01W ,Powerfactor 100.00%<br />
234.59V RMS ,8.43A RMS ,1978.64W ,Powerfactor 100.00%<br />
234.41V RMS ,8.42A RMS ,1972.77W ,Powerfactor 100.00%<br />
234.80V RMS ,8.42A RMS ,1977.74W ,Powerfactor 100.00%<br />
235.76V RMS ,8.45A RMS ,1992.04W ,Powerfactor 100.00%<br />
235.08V RMS ,8.42A RMS ,1978.59W ,Powerfactor 100.00%<br />
235.26V RMS ,8.42A RMS ,1980.28W ,Powerfactor 100.00%<br />
235.67V RMS ,8.43A RMS ,1985.90W ,Powerfactor 100.00%<br />
235.79V RMS ,8.42A RMS ,1986.25W ,Powerfactor 100.00%</p>
<p>&nbsp;</p>
<p>The drop in load is real, i.e its also reported by my inline current meter, the resistance of the fire must go up as it starts to warm up.</p>
<p>&nbsp;</p>
<p>I had considered whether it may still be best to use a Nano for this project for ease with interfacing to other peripherals, but as the STM32 seems to give better results, I&#39;m almost certainly going to use it, even though I may need to put more work getting the radio libs to compile and run.</p>
<p>&nbsp;</p>
<p>Anyway, thanks for everyone&#39;s help with this.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32603"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Sat, 25/07/2015 - 15:22.</div>
    <div class="content">
     <p><em>I figured out my offset problem, was just the load of my scope, affecting the offset voltage divider.</em></p>
<p>Hi Roger,</p>
<p>Was it your scope input set to 50 Ohms vice 1 MOhm?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32622"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 25/07/2015 - 20:47.</div>
    <div class="content">
     <p><i>"I understand that impedance matching can cause problems if the burden resistor is wildly miss matched with the pickup coil."</i></p>
<p>That's a red herring. The CT is a current source, and the secondary resistance is essentially irrelevant. Provided that the CT has a sufficient VA rating, the burden voltage is determined solely by the burden resistance (given a constant primary current). The CT is happiest, unloaded and at its most accurate, when working into a short circuit.</p>
<p><i>"The drop in load is real, i.e its also reported by my inline current meter, the resistance of the fire must go up as it starts to warm up."</i></p>
<p>Indeed it does, and the phenomenon is known is "inrush". For a tungsten lamp, the inrush current is around 12 &times; the running current. You can look up the temperature coefficient of resistance if you're really interested, it varies of course from metal to metal.</p>
<p><i>"it wasn't clear if this was 1V RMS or 1V P/P"</i><br />
It is always rms unless stated otherwise. To the best of my knowledge, all SCT-013-xxx CTs are the same beast, the only difference being the value of the internal burden resistor, or the absence thereof (replaced by zeners) in the -000 version.</p>
<p><i>"Was it your scope input set to 50 Ohms vice 1 MOhm?"</i><br />
Even a 1 M&Omega; input impedance 'scope would seriously drag down the centre point of a pair of 470 k&Omega; resistors, from 50% to about 40% of the supply voltage.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32626"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 25/07/2015 - 22:22.</div>
    <div class="content">
     <p>Indeed. &nbsp;Roger, assuming you&#39;re not trying to run your front end off batteries, don&#39;t be shy about lowering those 470KRs way way down. &nbsp;They are historically that high to enable long battery life, but if you&#39;re going to power it from the mains, 470K is&nbsp;crazy high for building a stable, low-noise rail (as you just discovered by loading it up with your scope).</p>
<p>Using 470K dividers instead of 20K dividers saves you about 100uA. &nbsp; On AVR designs (so not relevant to this thread), disabling the digital input buffer on that ADC pin will save you about 800uA. &nbsp;AFAIK&nbsp;the current OEM sketches don&#39;t do that. &nbsp;It&#39;s a pretty big save for the cost of setting some bits in the DIDRn registers. &nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32628"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Sun, 26/07/2015 - 00:26.</div>
    <div class="content">
     <p>@dBC</p>
<p>Re: Dividers</p>
<p>As I need to sense voltage as well as current, because I need to measure power flow. I will need to have a mains supply near the Tx for sensing, so I may as well power it from the mains.</p>
<p>&nbsp;</p>
<p>I assumed that the 470k resistors in the dividers where that high to allow the Tx to run on batteries, but also to make the bias voltage less immune to noise.</p>
<p>I&#39;d already dropped the 470k&#39;s down to 270k, after previously having tried some low values. I think I tried 1k</p>
<p>But using higher values does give some noise reduction on the bias rail, hence I pushed the values back up to 270k.</p>
<p>From memory, I think there are issues if you try to use the ADC on the STM32 to read impedances of above around 150k (I think there is an application note about this)</p>
<p>However, I thought that the input impedance from the CT is more a function of the CT and the 10uF capcacitor than it is of the 270k (or 470k resistors)</p>
<p>i.e The 10uF cap is what is really supplying the input current into the ADC and not the resistor divider network.</p>
<p>So I suppose a better arrangement would be to change the 10uf to a larger value e.g. 47uF and drop the resistor dividers to 47k, as that would give a similar time constant / noise immunity.</p>
<p>But of course electrolitics are not good at absorbing noise, so I should have some smaller e.g. 100nF or 10nF caps across the 10uF</p>
<p>&nbsp;</p>
<p>However, if I run the whole thing of a less noisy supply, I think the issues will go away</p>
<p>I&#39;m just rig up something where I can connect via USB to the board, but apply a separate supply. So I&#39;ll post again when I&#39;ve done that and got some results</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32629"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 26/07/2015 - 00:39.</div>
    <div class="content">
     <p><em>But using higher values does give some noise reduction on the bias rail, hence I pushed the values back up to 270k.</em></p>
<p>It&#39;d be interesting to know more about that. &nbsp;My gut feel is that the stiffer that rail is the better. &nbsp;My definition of &quot;noise&quot; includes anything that knocks it off it&#39;s nominal voltage. &nbsp;Do you have a theory as to why increasing the R reduced the noise?</p>
<p><em>I think there are issues if you try to use the ADC on the STM32 to read impedances of above around 150k&nbsp;</em></p>
<p>That&#39;s pretty impressive. &nbsp;The equivalent value for the AVR is anything above 10K.</p>
<p><em>i.e The 10uF cap is what is really supplying the input current into the ADC and not the resistor divider network.</em></p>
<p>Yes, that&#39;s the conclusion I came to do on my back-of-the-envelope equivalent circuit here: &nbsp;<a href="10097.html">http://openenergymonitor.org/emon/node/10097</a></p>
<p>I think you can do pretty much anything you want to those Rs and it won&#39;t make much difference to the source impedance. &nbsp;Some have claimed the higher value helps protect the input pin from higher currents, by my analysis in that thread suggests not by much.</p>
<p>Given the current design seems to come in below the 10K AVR restriction, I wouldn&#39;t have thought you&#39;d have any problems coming in below your 150K restriction.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32630"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Sun, 26/07/2015 - 05:21.</div>
    <div class="content">
     <p>@dBC</p>
<p>I&#39;d need to model the divider in LTSpice to see if the higher resistors make any difference, but in my not too technical tests were that higher values seemed to be showing less noise on my scope.</p>
<p>I presumed that the divider is an RC network, so the high the R lower the&nbsp; 3dB point, in the frequency response would be.</p>
<p>&nbsp;</p>
<p>Re: 150k input impedance.</p>
<p>The Application note is <a href="http://www.st.com/web/en/resource/technical/document/application_note/CD00211314.pdf" title="http://www.st.com/web/en/resource/technical/document/application_note/CD00211314.pdf">http://www.st.com/web/en/resource/technical/document/application_note/CD...</a></p>
<p>Section 3.4 on page 20 indicates quotes 150k as a high input impedance source.</p>
<p>Spec on the whole STM32F103C microcontroller is here</p>
<p><a href="http://www.st.com/web/en/resource/technical/document/datasheet/CD00161566.pdf" title="www.st.com/web/en/resource/technical/document/datasheet/CD00161566.pdf">www.st.com/web/en/resource/technical/document/datasheet/CD00161566.pdf</a></p>
<p>I think most of the ADC data is on page 76</p>
<p>It has these statements</p>
<p><strong>External input impedance&nbsp; 50 k ohms</strong></p>
<p><strong>Sampling switch resistance 1k</strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32658"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 26/07/2015 - 22:35.</div>
    <div class="content">
     <p>I think one problem is at those high R values, your scope is becoming part of the circuit, and probably earthing things too (unless it&#39;s isolated). &nbsp; &nbsp;Without any test gear attached, does the ADC report less noise when you use higher R values for the divider? &nbsp;If so, maybe you need to improve your Vcc.</p>
<p>That&#39;s a great application note, and most of that stuff applies to all AtoD applications. &nbsp;As you&#39;ve already discovered, and it re-enforces, a good ripple-free supply is critical. &nbsp;I&#39;d start there. &nbsp;My low-divider-R theory assumes that the divider has good low impedance access to a GND and a low impedance ripple-free Vcc.</p>
<p>The specs on the ADC look good, and the 50K source impedance gives you quite a bit more headroom than the corresponding 10K for the AVR. &nbsp;I doubt you&#39;ll have any source impedance issues there.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32661"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="rogerclark&#039;s picture" title="rogerclark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by rogerclark (not verified) on Sun, 26/07/2015 - 23:36.</div>
    <div class="content">
     <p>@dBC</p>
<p>Running on my bench supply is a lot better than the USB from the PC.</p>
<p>I do still see some small spikes on the ADC line, but I&#39;m not sure if this is noise being generated by the board it&#39;s self on its supply lines, or some function of the ADC sampling its self.</p>
<p>If I let the ADC line float and look at it on the scope I see a saw tooth waveform, which I think is caused by the ADC sampling the pin.</p>
<p>Strangely, I think when it samples, that the ADC pin is pulled slightly high by the acquisition, (which I think accounts for the small spikes).</p>
<p>But I really don&#39;t think its worth worrying about too much.</p>
<p>I will however take another look at the mains voltage sampling, as currently because I&#39;m using a 12V transformer, I&#39;m using a divider of a 33k resistor in series with a 10k trim pot.</p>
<p>But this means that I&#39;ve got about 40k input impedance on Vin. I&#39;ll probably drop this down to a 1k trim pot and a 3.3k resistor, so that there is more drive available.</p>
<p>&nbsp;</p>
<p>I&#39;m not sure what the normal range of variance on the voltage measurement is, but I&#39;m seeing a maximum of +/- 0.4 V , when sampling over 100 crossings.</p>
<p>My incoming supply is actually not that stable, as our power is via overhead power cables (even here in the suburbs of Melbourne), and I see voltage changes of several volts over a 5 minute period on the mains supply, even when we don&#39;t have any large loads going on and off in the house (or any solar coming in)</p>
<p>However I think those fluctuations are very low frequency and not the &quot;noise&quot; i&#39;m seeing on the mains voltage.</p>
<p>I suppose I could try measureing the mains with my DVM if I feel adventurous ;-)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-32664"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Success using the STM32F103 microcontroller</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 27/07/2015 - 01:06.</div>
    <div class="content">
     <p>The glitches are probably the charge-n-hold cap being charged (or discharged). &nbsp;I think that got a mention in your application note, and I posted a picture of the AVR equivalent recently here: &nbsp;<a href="11011.html">http://openenergymonitor.org/emon/node/11011</a></p>
<p>With regards your Voltage sensing input, did you check out how the OEM designs do it? &nbsp;They pretty much replicate the current&nbsp;input, but just replace the CT with the VT. &nbsp;I think that&#39;ll solve any input impedance issues. &nbsp;Those designs are fairly well proven, and there&#39;s even a 3.3V version. &nbsp;In theory, you should be able to just swap out the CPU and leave everything else untouched ... perhaps tweaking R values to suit your specific needs.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11021"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-aidkAoqk38H6PY1e_c8D7A1_8uT6LCWx2egD7hOXv48" value="form-aidkAoqk38H6PY1e_c8D7A1_8uT6LCWx2egD7hOXv48"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
