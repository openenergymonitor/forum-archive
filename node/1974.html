<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1974 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:05:29 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>advice for monitoring water meters? [Closed] | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">advice for monitoring water meters? [Closed]</h3>
        <span class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Tue, 29/01/2013 - 19:51</span>
        <div class="content"><p>Hi</p>
<p>excuse me if this has been asked before, but have anybody done monitoring water usage?</p>
<p>I saw some examples on a sketch for 3 phase electricity... but would it be hard to both monitor the 3 individual phases and also calculate the combined use of electricity?</p>
<p>I had an idea... use both CT an optical sensor to in some way try to predict what the meter says and if it varies then manuel input the meter reading... would that be possible and if so would it be hard to do?</p>
<p>i have asked the facotry of the water meter if its possible to attach a read switch or something and it seems so on their webpage (<a href="http://www.elstermetering.com/en/693.html" title="http://www.elstermetering.com/en/693.html">http://www.elstermetering.com/en/693.html</a> look at page 2 in the meters pdf)</p>
<p>The electricity meter is a self reporting meter so i could look up the usage on the internet but even thou the meter reports for every hour, its sometimes several hours to do updates if not a day or 2... i want to see the effect of my behaviour right away</p>
<p>for the water meter i have to fill in a report card once a year... far to long, it want to have hourly reporting here also..</p>
<p>The heat meter is selfreporting, thou it only updates once every 3 months... dont know if i could but a hall effect to the flow counter and how accurate i could get temp readings... but the meter allows me to read the temps and maybe i could use that to account for the fall in temp there will be when mounting a sensor outside on the tube... will have to check in to that..</p>
<p>&nbsp;</p>
<p>hope for some input and ideas</p>
<p>&nbsp;</p>
<p>/bo</p>
  <div class="forum-topic-navigation clear-block">
          <a href="1351.html" class="topic-previous" title="Go to previous forum topic">‹ Raspberry Pi Kickstarter.... so close :-)</a>
              <a href="2020.html" class="topic-next" title="Go to next forum topic">Temperature resolution for low power node ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-9550"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 31/01/2013 - 22:38.</div>
    <div class="content">
     <p><em>have anybody done monitoring water usage?</em><br />
	I have not seen that reported here, but if you can have a pulse output from your meter, then the emonTx pulse input can be used.</p>
<p><em>3 phase electricity... but would it be hard to both monitor the 3 individual phases </em><br />
	No, it has been done <a href="1170.html" title="http://openenergymonitor.org/emon/node/1170">http://openenergymonitor.org/emon/node/1170</a></p>
<p><em>and also calculate the combined use of electricity?</em><br />
	Add the power / energy for each of the phases together to obtain the total.</p>
<p><em>The electricity meter is a self reporting meter&nbsp;</em><br />
	Does your meter also have an infra-red output? If it has, it might be possible to read that. And the same for your heat meter.<br />
	&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9558"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Fri, 01/02/2013 - 12:43.</div>
    <div class="content">
     <p>Most water meters use a reed switch.&nbsp; Take a look at your water meter and find the datasheet for it.</p>
<p>Its possible to buy pulse modules to clip on the top of the water meter that have a flying lead attached so you can count the pulses.</p>
<p>Heat meters often have pulse outputs for kWh or a comms bus which uses a protocol i.e. M-Bus.&nbsp; Again, find the datasheet for your heat meter and you will be able to see what it offers.&nbsp; Unfortunately its usually one or the other.</p>
<p>In short its trivial to count pulses but bus protocols are going to be more difficult.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9895"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 11:00.</div>
    <div class="content">
     <p>Back again... strange enough i did not get any emails for the 2 replys</p>
<p>For my heat meter i know it has an infra output and i just have to build an rs-232 interface for it.. i also got a list of the different ID it spits out.. the only thing left is to figure on how to pas the relavant data on. Not that sharp in programming :-(</p>
<p>The water meter do need the clip on read switch... i have seen people use an&nbsp; hall effect sensor, an interesting idea is found here where the res. can be as good as 15ml.(tablesppon): <a href="http://www.edcheung.com/automa/water.htm" title="http://www.edcheung.com/automa/water.htm">http://www.edcheung.com/automa/water.htm</a></p>
<p>The manufacture has not responded to my mails even thou they sell a clip on thing</p>
<p><em>The electricity meter</em> do only have an blink output, 10000 pulses for every kwh</p>
<p><em>3 phase electricity</em>... i looked at the link and the only thing i could not figure is why there was 2 jacks on the side of each board... since each phase only need 1 CS clamp i would figure only one jack is needed?? the thread did not give me any clues</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9896"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 11:40.</div>
    <div class="content">
     <p>So i checked up on the water meter... the factory do have an reed disc option its even showed on the data sheet: <a href="http://www.elstermetering.com/downloads/M100_D_0101e_1012.pdf">http://www.elstermetering.com/downloads/M100_D_0101e_1012.pdf</a></p>
<p>Also i mailed them to hear if i could get a disc (i&#39;m a bit lazy)</p>
<p>if not would a reed switch or hall effect give the best results?</p>
<p>&nbsp;</p>
<p>next if to check the heat meter.. an Kamstrup Multical 601... on this link the register id&#39;s can be found, page 90 : <a href="http://kamstrup.com/media/11976/file.pdf">http://kamstrup.com/media/11976/file.pdf</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9897"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 11:51.</div>
    <div class="content">
     <p>lucky me... a nice arduino geek send me this arduino code that is made for my meter...</p>
<p>#include &lt;SoftwareSerial.h&gt;<br />
	#include &lt;OneWire.h&gt;</p>
<p>// Kamstrup Multical 601<br />
	word const kregnums[] = { 0x003C,0x0050,0x0056,0x0057,0x0059,0x004a,0x0044,0x0045 };<br />
	char* kregstrings[]&nbsp;&nbsp; = { &quot;Energy&quot;,&quot;Current Power&quot;,&quot;Temperature t1&quot;,&quot;Temperature t2&quot;,&quot;Temperature diff&quot;, &quot;Flow&quot;, &quot;Volumen 1&quot;, &quot;Volumen 2&quot; };<br />
	#define NUMREGS 8<br />
	#define KAMBAUD 1200</p>
<p>// Units<br />
	char*&nbsp; units[65] = {&quot;&quot;,&quot;Wh&quot;,&quot;kWh&quot;,&quot;MWh&quot;,&quot;GWh&quot;,&quot;j&quot;,&quot;kj&quot;,&quot;Mj&quot;,<br />
	&quot;Gj&quot;,&quot;Cal&quot;,&quot;kCal&quot;,&quot;Mcal&quot;,&quot;Gcal&quot;,&quot;varh&quot;,&quot;kvarh&quot;,&quot;Mvarh&quot;,&quot;Gvarh&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;VAh&quot;,&quot;kVAh&quot;,&quot;MVAh&quot;,&quot;GVAh&quot;,&quot;kW&quot;,&quot;kW&quot;,&quot;MW&quot;,&quot;GW&quot;,&quot;kvar&quot;,&quot;kvar&quot;,&quot;Mvar&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;Gvar&quot;,&quot;VA&quot;,&quot;kVA&quot;,&quot;MVA&quot;,&quot;GVA&quot;,&quot;V&quot;,&quot;A&quot;,&quot;kV&quot;,&quot;kA&quot;,&quot;C&quot;,&quot;K&quot;,&quot;l&quot;,&quot;m3&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;l/h&quot;,&quot;m3/h&quot;,&quot;m3xC&quot;,&quot;ton&quot;,&quot;ton/h&quot;,&quot;h&quot;,&quot;hh:mm:ss&quot;,&quot;yy:mm:dd&quot;,&quot;yyyy:mm:dd&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;mm:dd&quot;,&quot;&quot;,&quot;bar&quot;,&quot;RTC&quot;,&quot;ASCII&quot;,&quot;m3 x 10&quot;,&quot;ton x 10&quot;,&quot;GJ x 10&quot;,&quot;minutes&quot;,&quot;Bitfield&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;s&quot;,&quot;ms&quot;,&quot;days&quot;,&quot;RTC-Q&quot;,&quot;Datetime&quot;};</p>
<p>// Pin definitions<br />
	#define PIN_1WIRE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4&nbsp; // 1-Wire bus<br />
	#define PIN_KAMSER_RX&nbsp; 6&nbsp; // Kamstrup IR interface RX<br />
	#define PIN_KAMSER_TX&nbsp; 7&nbsp; // Kamstrup IR interface TX<br />
	#define PIN_DIAG_LED&nbsp;&nbsp; 13 // Diag LED to blink with for fun</p>
<p>// Kamstrup optical IR serial<br />
	#define KAMTIMEOUT 2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Kamstrup timeout after transmit<br />
	#define POLLINTERVAL 300000&nbsp; // Polling interval<br />
	SoftwareSerial kamSer(PIN_KAMSER_RX, PIN_KAMSER_TX, true);&nbsp; // Initialize serial</p>
<p>// 1-wire<br />
	byte ts_t[]&nbsp; = {0x28,0x14,0xA9,0xAA,0x03,0x00,0x00,0x0F};&nbsp; // Indoor temperature<br />
	OneWire ds(PIN_1WIRE);&nbsp; // Initialize 1-Wire</p>
<p>// last poll variable<br />
	long lastpoll;</p>
<p>
	void setup() {<br />
	&nbsp; // setup pins<br />
	&nbsp; pinMode(PIN_DIAG_LED,OUTPUT);<br />
	&nbsp; pinMode(PIN_KAMSER_RX,INPUT);<br />
	&nbsp; pinMode(PIN_KAMSER_TX,OUTPUT);</p>
<p>&nbsp; // initialize kamstrup serial interface<br />
	&nbsp; kamSer.begin(KAMBAUD);<br />
	&nbsp;<br />
	&nbsp; // initialize serial interface (connected to linksys router)<br />
	&nbsp; Serial.begin(9600);<br />
	&nbsp;<br />
	&nbsp; // initialize lastpoll value<br />
	&nbsp; lastpoll = 0;<br />
	}</p>
<p>void loop() {</p>
<p>&nbsp; // check if it is time to do a poll<br />
	&nbsp; if(millis() - lastpoll &gt; POLLINTERVAL or lastpoll == 0) {</p>
<p>&nbsp;&nbsp;&nbsp; // get Kamstrup data from meter<br />
	&nbsp;&nbsp;&nbsp; for (int kreg = 0; kreg &lt; NUMREGS; kreg++) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; kamReadReg(kreg);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay(100);<br />
	&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; // get 1-wire temps<br />
	&nbsp;&nbsp;&nbsp; String t = gettemp_ds18b20(ts_t);<br />
	&nbsp;&nbsp;&nbsp; Serial.print(t);</p>
<p>&nbsp;&nbsp;&nbsp; // send a newline to have linksys process the data<br />
	&nbsp;&nbsp;&nbsp; Serial.println(&quot;&quot;);&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp; // update lastpoll<br />
	&nbsp;&nbsp;&nbsp; lastpoll = millis();<br />
	&nbsp; }</p>
<p>&nbsp; // toggle LED to show we are alive<br />
	&nbsp; togglePin(PIN_DIAG_LED);<br />
	&nbsp;<br />
	&nbsp; // loop delay<br />
	&nbsp; delay(500);<br />
	&nbsp;<br />
	};</p>
<p>// Toggle pin<br />
	void togglePin(int pinNum) {<br />
	&nbsp; digitalWrite(pinNum, !digitalRead(pinNum));<br />
	}</p>
<p>// get temperature reading from 1wire sensor<br />
	String gettemp_ds18b20(byte addr[8]) {<br />
	&nbsp; byte i;<br />
	&nbsp; byte present = 0;<br />
	&nbsp; byte data[12];<br />
	&nbsp; int HighByte, LowByte, TReading, SignBit, Tc_100, Whole, Fract;<br />
	&nbsp; String value = &quot;&quot;;<br />
	&nbsp; ds.reset();<br />
	&nbsp; ds.select(addr);<br />
	&nbsp; ds.write(0x44,1);<br />
	&nbsp; delay(1000);<br />
	&nbsp; present = ds.reset();<br />
	&nbsp; ds.select(addr);&nbsp;&nbsp;&nbsp;<br />
	&nbsp; ds.write(0xBE);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Read Scratchpad<br />
	&nbsp; for ( i = 0; i &lt; 2; i++) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // we need 2 bytes<br />
	&nbsp;&nbsp;&nbsp; data[i] = ds.read();<br />
	&nbsp; }<br />
	&nbsp; // Convert to degrees celsius<br />
	&nbsp; LowByte = data[0];<br />
	&nbsp; HighByte = data[1];<br />
	&nbsp; TReading = (HighByte &lt;&lt; 8) + LowByte;<br />
	&nbsp; SignBit = TReading &amp; 0x8000;&nbsp; // test most sig bit<br />
	&nbsp; if (SignBit) // negative<br />
	&nbsp; {<br />
	&nbsp;&nbsp;&nbsp; TReading = (TReading ^ 0xffff) + 1; // 2&#39;s comp<br />
	&nbsp; }<br />
	&nbsp; Tc_100 = (6 * TReading) + TReading / 4;&nbsp;&nbsp;&nbsp; // multiply by (100 * 0.0625) or 6.25<br />
	&nbsp; Whole = Tc_100 / 100;&nbsp; // separate off the whole and fractional portions<br />
	&nbsp; Fract = Tc_100 % 100;<br />
	&nbsp; if (SignBit) // If its negative<br />
	&nbsp; {<br />
	&nbsp;&nbsp;&nbsp; value = &quot;-&quot;;<br />
	&nbsp; }<br />
	&nbsp; value += Whole;<br />
	&nbsp; value += &quot;.&quot;;<br />
	&nbsp; if (Fract &lt; 10)<br />
	&nbsp; {<br />
	&nbsp;&nbsp;&nbsp; value += &quot;0&quot;;<br />
	&nbsp; }<br />
	&nbsp; value += Fract;<br />
	&nbsp; return value;<br />
	}</p>
<p>
	// kamReadReg - read a Kamstrup register<br />
	void kamReadReg(unsigned short kreg) {</p>
<p>&nbsp; byte recvmsg[30];&nbsp; // buffer of bytes to hold the received data<br />
	&nbsp; float rval;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // this will hold the final value</p>
<p>&nbsp; // prepare message to send and send it<br />
	&nbsp; byte sendmsg[] = { 0x3f, 0x10, 0x01, (kregnums[kreg] &gt;&gt; 8), (kregnums[kreg] &amp; 0xff) };<br />
	&nbsp; kamSend(sendmsg, 5);</p>
<p>&nbsp; // listen if we get an answer<br />
	&nbsp; unsigned short rxnum = kamReceive(recvmsg);</p>
<p>&nbsp; // check if number of received bytes &gt; 0<br />
	&nbsp; if(rxnum != 0){<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; // decode the received message<br />
	&nbsp;&nbsp;&nbsp; rval = kamDecode(kreg,recvmsg);<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; // print out received value to terminal<br />
	&nbsp;&nbsp;&nbsp; if (rval != false) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(rval);<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp; }<br />
	&nbsp;<br />
	&nbsp; Serial.print(&quot;,&quot;);</p>
<p>}</p>
<p>// kamSend - send data to Kamstrup meter<br />
	void kamSend(byte const *msg, int msgsize) {</p>
<p>&nbsp; // append checksum bytes to message<br />
	&nbsp; byte newmsg[msgsize+2];<br />
	&nbsp; for (int i = 0; i &lt; msgsize; i++) { newmsg[i] = msg[i]; }<br />
	&nbsp; newmsg[msgsize++] = 0x00;<br />
	&nbsp; newmsg[msgsize++] = 0x00;<br />
	&nbsp; int c = crc_1021(newmsg, msgsize);<br />
	&nbsp; newmsg[msgsize-2] = (c &gt;&gt; 8);<br />
	&nbsp; newmsg[msgsize-1] = c &amp; 0xff;</p>
<p>&nbsp; // build final transmit message - escape various bytes<br />
	&nbsp; byte txmsg[20] = { 0x80 };&nbsp;&nbsp; // prefix<br />
	&nbsp; int txsize = 1;<br />
	&nbsp; for (int i = 0; i &lt; msgsize; i++) {<br />
	&nbsp;&nbsp;&nbsp; if (newmsg[i] == 0x06 or newmsg[i] == 0x0d or newmsg[i] == 0x1b or newmsg[i] == 0x40 or newmsg[i] == 0x80) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; txmsg[txsize++] = 0x1b;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; txmsg[txsize++] = newmsg[i] ^ 0xff;<br />
	&nbsp;&nbsp;&nbsp; } else {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; txmsg[txsize++] = newmsg[i];<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp; }<br />
	&nbsp; txmsg[txsize++] = 0x0d;&nbsp; // EOF</p>
<p>&nbsp; // send to serial interface<br />
	&nbsp; for (int x = 0; x &lt; txsize; x++) {<br />
	&nbsp;&nbsp;&nbsp; kamSer.write(txmsg[x]);<br />
	&nbsp; }</p>
<p>}</p>
<p>// kamReceive - receive bytes from Kamstrup meter<br />
	unsigned short kamReceive(byte recvmsg[]) {</p>
<p>&nbsp; byte rxdata[50];&nbsp; // buffer to hold received data<br />
	&nbsp; unsigned long rxindex = 0;<br />
	&nbsp; unsigned long starttime = millis();<br />
	&nbsp;<br />
	&nbsp; kamSer.flush();&nbsp; // flush serial buffer - might contain noise</p>
<p>&nbsp; byte r;<br />
	&nbsp;<br />
	&nbsp; // loop until EOL received or timeout<br />
	&nbsp; while(r != 0x0d){<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; // handle rx timeout<br />
	&nbsp;&nbsp;&nbsp; if(millis()-starttime &gt; KAMTIMEOUT) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;<br />
	&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; // handle incoming data<br />
	&nbsp;&nbsp;&nbsp; if (kamSer.available()) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // receive byte<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r = kamSer.read();<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(r != 0x40) {&nbsp; // don&#39;t append if we see the start marker<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // append data<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rxdata[rxindex] = r;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rxindex++;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; }<br />
	&nbsp; }</p>
<p>&nbsp; // remove escape markers from received data<br />
	&nbsp; unsigned short j = 0;<br />
	&nbsp; for (unsigned short i = 0; i &lt; rxindex -1; i++) {<br />
	&nbsp;&nbsp;&nbsp; if (rxdata[i] == 0x1b) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte v = rxdata[i+1] ^ 0xff;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (v != 0x06 and v != 0x0d and v != 0x1b and v != 0x40 and v != 0x80){<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.print(&quot;Missing escape &quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial.println(v,HEX);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; recvmsg[j] = v;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i++; // skip<br />
	&nbsp;&nbsp;&nbsp; } else {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; recvmsg[j] = rxdata[i];<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp; j++;<br />
	&nbsp; }<br />
	&nbsp;<br />
	&nbsp; // check CRC<br />
	&nbsp; if (crc_1021(recvmsg,j)) {<br />
	&nbsp;&nbsp;&nbsp; Serial.println(&quot;CRC error: &quot;);<br />
	&nbsp;&nbsp;&nbsp; return 0;<br />
	&nbsp; }<br />
	&nbsp;<br />
	&nbsp; return j;<br />
	&nbsp;<br />
	}</p>
<p>// kamDecode - decodes received data<br />
	float kamDecode(unsigned short const kreg, byte const *msg) {</p>
<p>&nbsp; // skip if message is not valid<br />
	&nbsp; if (msg[0] != 0x3f or msg[1] != 0x10) {<br />
	&nbsp;&nbsp;&nbsp; return false;<br />
	&nbsp; }<br />
	&nbsp; if (msg[2] != (kregnums[kreg] &gt;&gt; 8) or msg[3] != (kregnums[kreg] &amp; 0xff)) {<br />
	&nbsp;&nbsp;&nbsp; return false;<br />
	&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp; // decode the mantissa<br />
	&nbsp; long x = 0;<br />
	&nbsp; for (int i = 0; i &lt; msg[5]; i++) {<br />
	&nbsp;&nbsp;&nbsp; x &lt;&lt;= 8;<br />
	&nbsp;&nbsp;&nbsp; x |= msg[i + 7];<br />
	&nbsp; }<br />
	&nbsp;<br />
	&nbsp; // decode the exponent<br />
	&nbsp; int i = msg[6] &amp; 0x3f;<br />
	&nbsp; if (msg[6] &amp; 0x40) {<br />
	&nbsp;&nbsp;&nbsp; i = -i;<br />
	&nbsp; };<br />
	&nbsp; float ifl = pow(10,i);<br />
	&nbsp; if (msg[6] &amp; 0x80) {<br />
	&nbsp;&nbsp;&nbsp; ifl = -ifl;<br />
	&nbsp; }</p>
<p>&nbsp; // return final value<br />
	&nbsp; return (float )(x * ifl);</p>
<p>}</p>
<p>// crc_1021 - calculate crc16<br />
	long crc_1021(byte const *inmsg, unsigned int len){<br />
	&nbsp; long creg = 0x0000;<br />
	&nbsp; for(unsigned int i = 0; i &lt; len; i++) {<br />
	&nbsp;&nbsp;&nbsp; int mask = 0x80;<br />
	&nbsp;&nbsp;&nbsp; while(mask &gt; 0) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; creg &lt;&lt;= 1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (inmsg[i] &amp; mask){<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; creg |= 1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mask&gt;&gt;=1;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (creg &amp; 0x10000) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; creg &amp;= 0xffff;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; creg ^= 0x1021;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp; }<br />
	&nbsp; return creg;<br />
	}<br />
	&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9898"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 12:08.</div>
    <div class="content">
     <p>phew... i guess that one saves a lot of trouble... now how do i send data to the emon cms system?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9899"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1817.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="StuntMonkeh&#039;s picture" title="StuntMonkeh&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/1817.html" title="View user profile.">StuntMonkeh</a> on Sat, 16/02/2013 - 14:12.</div>
    <div class="content">
     <p>If you can find an Elster distributor they should be able to give you a price although I suggest making it as easy as possible for them by giving them a part number.&nbsp; Don&#39;t give up though, they will often say they will get back to you so you will need to keep hassling them.</p>
<p>You could possibly use something else but I doubt it would be worth the hassle.&nbsp; The problem with water meters are they often tend to be located in a hole outside.&nbsp; If you get their module it will clip straight on and will be suitably rated against water ingress.</p>
<p>I assume the Kamstrup meter is being read from an IR receiver.&nbsp; You will need to merge your code with some from the emonTX sketch to bundle the data in the standard format you want to send to your emonBase.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9900"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 14:20.</div>
    <div class="content">
     <p>The water meter is inside my flat...</p>
<p>In fact the water meter, heat meter and fuse box are inside the same closet... so 1 emontx can handle both the electricity (3 cs clamps) and water meter (elster disc or hall effect...</p>
<p>think i will spend the evening figureing out how to merge codes... any help with that is more than welcome..</p>
<p>on the hardware side... how would i fit an ir interface to the imontx if its possible?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9902"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 14:30.</div>
    <div class="content">
     <p>btw... the code for the emontx... i looked and there are a lot of examples...</p>
<p>is there not a &quot;standard&quot; code that comes with the assembled units sold in the store or do i have to hack something together?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9903"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 14:52.</div>
    <div class="content">
     <p>think i found the answer for a sketch here: <a href="../emontx/firmware/writing-code-for-the-emontx.html" title="http://openenergymonitor.org/emon/emontx/firmware/writing-code-for-the-emontx">http://openenergymonitor.org/emon/emontx/firmware/writing-code-for-the-e...</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9904"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 15:37.</div>
    <div class="content">
     <p>so far i have managed to build this sketch that should do electricity and water.. only thing is that there is only 1 input for 9V AC... is there a way to hack in 2 more?</p>
<p>&nbsp;</p>
<pre>
#include &quot;EmonLib.h&quot;                   // Include Emon Library

//------------------------Electricity Start---------------------------
EnergyMonitor ct1;                     // Create an instance Phase 1
EnergyMonitor ct2;                     // Create an instance Phase 2
EnergyMonitor ct3;                     // Create an instance Phase 3
//------------------------Electricity End-----------------------------
//------------------------Water Start---------------------------------
long pulseCount = 0;
unsigned long pulseTime,lastTime;      // Used to measure time between pulses
double power;
int ppltr = 1;                         // pulses per liter
//------------------------Water End-----------------------------------

void <b>setup</b>()
{  
  <b>Serial</b>.begin(9600);
//------------------------Electricity Start---------------------------
ct1.voltageTX(238.5,&nbsp;1.7);             // Calibration, phase_shift
ct1.currentTX(1,&nbsp;115.6);               // CT channel, calibration.
ct2.voltageTX(238.5,&nbsp;1.7);             // Calibration, phase_shift
ct2.currentTX(1,&nbsp;115.6);               // CT channel, calibration.
ct3.voltageTX(238.5,&nbsp;1.7);             // Calibration, phase_shift
ct3.currentTX(1,&nbsp;115.6);               // CT channel, calibration.
//------------------------Electricity End-----------------------------
//------------------------Water Start---------------------------------
// pulse detection interrupt (emontx pulse channel - IRQ0 D3)
attachInterrupt(1, onPulse, FALLING);
//------------------------Water End-----------------------------------
}

void <b>loop</b>()
{
//------------------------Electricity Start---------------------------
ct1.calcVI(20,2000);                   // Calculate all. No.of wavelengths, time-out
ct1.serialprint();                     // Print out all variables
ct2.calcVI(20,2000);                   // Calculate all. No.of wavelengths, time-out
ct2.serialprint();                     // Print out all variables
ct3.calcVI(20,2000);                   // Calculate all. No.of wavelengths, time-out
ct3.serialprint();                     // Print out all variables
delay(1000);
//------------------------Electricity End-----------------------------
//------------------------Water Start---------------------------------
<b>Serial</b>.print(Water);
<b>Serial</b>.print(&#39; &#39;);
<b>Serial</b>.print(Liter);
<b>Serial</b>.println(pulseCount * ppltr);    // Liters used
delay(1000);
//------------------------Water End-----------------------------------
}
//------------------------Water Start--------------------------------- 
//The interrupt routine &ndash; runs each time a falling edge of a pulse is detected
void onPulse()                  
{
lastTime = pulseTime;
pulseTime = micros();
pulseCount++;                          // count pulse               
power = int((3600000000.0 / (pulseTime - lastTime))/ppltr);  // calculate water
}
//------------------------Water End-----------------------------------</pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9906"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 16:06.</div>
    <div class="content">
     <p>now with transmit in the code - only need to figure how to read from heat meter:</p>
<p>&nbsp;</p>
<pre style="margin-bottom: 0.5cm">
#include&nbsp;&lt;JeeLib.h&gt;
#include &quot;EmonLib.h&quot;                   // Include Emon Library
//------------------------Transmit Start-------------------------
// this is added as we&#39;re using the watchdog for low-power waiting
ISR(WDT_vect) { Sleepy::watchdogEvent(); }

// create structure &ndash; a neat way of packaging data for RF comms
typedef struct { int power; } PayloadTX;                                
PayloadTX emontx;
//------------------------Transmit End---------------------------

//------------------------Electricity Start----------------------
EnergyMonitor ct1;                     // Create an instance Phase 1
EnergyMonitor ct2;                     // Create an instance Phase 2
EnergyMonitor ct3;                     // Create an instance Phase 3
//------------------------Electricity End------------------------
//------------------------Water Start----------------------------
long pulseCount = 0;
unsigned long pulseTime,lastTime;      // Used to measure time between pulses
double power;
int ppltr = 1;                         // pulses per liter
//------------------------Water End------------------------------

void <b>setup</b>()
{  
  <b>Serial</b>.begin(9600);
//------------------------Electricity Start----------------------
ct1.voltageTX(238.5, 1.7);             // Calibration, phase_shift
ct1.currentTX(1, 115.6);               // CT channel, calibration.
ct2.voltageTX(238.5, 1.7);             // Calibration, phase_shift
ct2.currentTX(1, 115.6);               // CT channel, calibration.
ct3.voltageTX(238.5, 1.7);             // Calibration, phase_shift
ct3.currentTX(1, 115.6);               // CT channel, calibration.
//------------------------Electricity End------------------------
//------------------------Transmit Start-------------------------
// initialize RFM12B (node id, frequency, group)
rf12_initialize(10, RF12_433MHZ, 210);      
rf12_sleep(RF12_SLEEP);
//------------------------Transmit End---------------------------
//------------------------Water Start----------------------------
// pulse detection interrupt (emontx pulse channel - IRQ0 D3)
attachInterrupt(1, onPulse, FALLING);
//------------------------Water End------------------------------
}

void <b>loop</b>()
{
//------------------------Transmit Start-------------------------
emontx.power&nbsp;=&nbsp;ct1.calcIrms(1480)&nbsp;*&nbsp;240.0;
//------------------------Transmit End---------------------------
//------------------------Electricity Start----------------------
ct1.calcVI(20,2000);                   // Calculate all. No.of wavelengths, time-out
ct1.serialprint();                     // Print out all variables
ct2.calcVI(20,2000);                   // Calculate all. No.of wavelengths, time-out
ct2.serialprint();                     // Print out all variables
ct3.calcVI(20,2000);                   // Calculate all. No.of wavelengths, time-out
ct3.serialprint();                     // Print out all variables
//------------------------Transmit Start-------------------------
rf12_sleep(RF12_WAKEUP);

int i = 0; while (!rf12_canSend() &amp;&amp; i&lt;10) {rf12_recvDone(); i++;}

rf12_sendStart(0, &amp;emontx, sizeof emontx);
// set the sync mode to 2 if the fuses are still the Arduino default
// mode 3 (full powerdown) can only be used with 258 CK startup fuses
rf12_sendWait(2);

rf12_sleep(RF12_SLEEP);
Sleepy::loseSomeTime(5000);
//------------------------Transmit End---------------------------
delay(1000);
//------------------------Electricity End------------------------
//------------------------Water Start----------------------------
<b>Serial</b>.print(Water);
<b>Serial</b>.print(&#39; &#39;);
<b>Serial</b>.print(Liter);
<b>Serial</b>.println(pulseCount * ppltr);    // Liters used
delay(1000);
//------------------------Water End------------------------------
}
//------------------------Water Start---------------------------- 
//The interrupt routine &ndash; runs each time a falling edge of a pulse is detected
void onPulse()                  
{
lastTime = pulseTime;
pulseTime = micros();
pulseCount++;                          // count pulse               
power = int((3600000000.0 / (pulseTime - lastTime))/ppltr);  // calculate water
}
//------------------------Water End------------------------------</pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9907"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 16:07.</div>
    <div class="content">
     <p>upps... code bits come from here:</p>
<p>&nbsp;</p>
<p><a href="../emontx/firmware/writing-code-for-the-emontx.html" title="http://openenergymonitor.org/emon/emontx/firmware/writing-code-for-the-emontx">http://openenergymonitor.org/emon/emontx/firmware/writing-code-for-the-e...</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9909"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 16:32.</div>
    <div class="content">
     <p>trying to integrate this thread... <a href="1170.html" title="http://openenergymonitor.org/emon/node/1170">http://openenergymonitor.org/emon/node/1170</a></p>
<p>still have to figure why 2&nbsp; jacks are pluged in to each....</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9910"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 19:07.</div>
    <div class="content">
     <p>so far i got this for the master module... a bit worried about counting pulses for water meter is done right:</p>
<p>&nbsp;</p>
<p>Version:1.0 StartHTML:0000000167 EndHTML:0000012001 StartFragment:0000000454 EndFragment:0000011985</p>
<p style="margin-bottom: 0cm">#define FVCAL 237 // default is 234.26</p>
<p style="margin-bottom: 0cm">#define FICAL 111.5 // default 111.1</p>
<p style="margin-bottom: 0cm">#define FPHASE 1 // default 1.7</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#define FILTERSETTLETIME 5000 // Time (ms) to allow the filters to settle before sending data</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//CT 1 is always enabled</p>
<p style="margin-bottom: 0cm">const int CT2 = 1; // Set to 1 to enable CT channel 2</p>
<p style="margin-bottom: 0cm">const int CT3 = 0; // Set to 1 to enable CT channel 3</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#define freq RF12_433MHZ // Frequency of RF12B module can be RF12_433MHZ, RF12_868MHZ or RF12_915MHZ. You should use the one matching the module you have.433MHZ, RF12_868MHZ or RF12_915MHZ. You should use the one matching the module you have.</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int nodeID = 10; // emonTx RFM12B node ID</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int networkGroup = 210; // emonTx RFM12B wireless network group - needs to be same as emonBase and emonGLCD needs to be same as emonBase and emonGLCD</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int UNO = 1; // Set to 0 if your not using the UNO bootloader (i.e using Duemilanove) - All Atmega&#39;s shipped from OpenEnergyMonitor come with Arduino Uno bootloader</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &lt;avr/wdt.h&gt; // the UNO bootloader</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &lt;JeeLib.h&gt; // Download JeeLib: <a href="http://github.com/jcw/jeelib" title="http://github.com/jcw/jeelib">http://github.com/jcw/jeelib</a></p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ISR(WDT_vect) { Sleepy::watchdogEvent(); }</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &quot;EmonLib.h&quot;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">EnergyMonitor ct1,ct2,ct3; // Create instances for each CT channel</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &lt;Wire.h&gt;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">typedef struct { int power1, power2, power3, Vrms; } PayloadTX; // neat way of packaging data for RF comms</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">PayloadTX emontx[3];</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int LEDpin = 9; // On-board emonTx LED</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">boolean settled = false;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">long pulseCount = 0;</p>
<p style="margin-bottom: 0cm">unsigned long pulseTime,lastTime; // Used to measure time between pulses</p>
<p style="margin-bottom: 0cm">double power;</p>
<p style="margin-bottom: 0cm">int ppltr = 1; // pulses per liter</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Void setup()</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">Serial.begin(9600);</p>
<p style="margin-bottom: 0cm">Serial.println(&quot;emonTX CT123 Voltage example&quot;);</p>
<p style="margin-bottom: 0cm">Serial.println(&quot;OpenEnergyMonitor.org&quot;);</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;Node: &quot;);</p>
<p style="margin-bottom: 0cm">Serial.print(nodeID);</p>
<p style="margin-bottom: 0cm">Serial.print(&quot; Freq: &quot;);</p>
<p style="margin-bottom: 0cm">if (freq == RF12_433MHZ) Serial.print(&quot;433Mhz&quot;);</p>
<p style="margin-bottom: 0cm">if (freq == RF12_868MHZ) Serial.print(&quot;868Mhz&quot;);</p>
<p style="margin-bottom: 0cm">if (freq == RF12_915MHZ) Serial.print(&quot;915Mhz&quot;);</p>
<p style="margin-bottom: 0cm">Serial.print(&quot; Network: &quot;);</p>
<p style="margin-bottom: 0cm">Serial.println(networkGroup);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct1.voltageTX(FVCAL, FPHASE); // ct.voltageTX(calibration, phase_shift) - make sure to select correct calibration for AC-AC adapter <a href="../modules/index.html" title="http://openenergymonitor.org/emon/modules/">http://openenergymonitor.org/emon/modules/</a></p>
<p style="margin-bottom: 0cm">emontx/firmware/calibration</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct1.currentTX(1, FICAL);1 // Setup emonTX CT channel (channel (1,2 or 3), calibration)</p>
<p style="margin-bottom: 0cm">// CT Calibration factor = CT ratio / burden resistance</p>
<p style="margin-bottom: 0cm">ct2.voltageTX(FVCAL, FPHASE); // CT Calibration factor = (100A / 0.05A) x 18 Ohms</p>
<p style="margin-bottom: 0cm">ct2.currentTX(2, FICAL);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct3.voltageTX(FVCAL, FPHASE);</p>
<p style="margin-bottom: 0cm">ct3.currentTX(3, FICAL);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">rf12_initialize(nodeID, freq, networkGroup); // initialize RF</p>
<p style="margin-bottom: 0cm">//rf12_control(0xc657);</p>
<p style="margin-bottom: 0cm">// approx. 3.918kps, i.e. 10000/29(1+0x57) kps</p>
<p style="margin-bottom: 0cm">rf12_sleep(RF12_SLEEP);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Wire.begin(); // join i2c bus (address optional for master)</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">pinMode(LEDpin, OUTPUT); // Setup indicator LED</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">digitalWrite(LEDpin, HIGH);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (UNO) wdt_enable(WDTO_8S); // Enable anti crash (restart) watchdog if UNO bootloader is selected. Watchdog does not work with duemilanove</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">bootloader // Restarts emonTx if sketch hangs for more than 8s</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">// pulse detection interrupt (emontx pulse channel - IRQ0 D3)</p>
<p style="margin-bottom: 0cm">attachInterrupt(1, onPulse, FALLING);</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">void loop()</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">pokeSlave(2); // start slave on phase 2</p>
<p style="margin-bottom: 0cm">pokeSlave(3); // start slave on phase 3</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct1.calcVI(20,2000); // Calculate all. No.of crossings, time-out</p>
<p style="margin-bottom: 0cm">emontx[0].power1 = ct1.realPower;</p>
<p style="margin-bottom: 0cm">Serial.print(emontx[0].power1);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">emontx[0].Vrms = ct1.Vrms*100; // AC Mains rms voltage</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (CT2)</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">ct2.calcVI(20,2000); //ct.calcVI(number of crossings to sample, time out (ms) if no waveform is detected)</p>
<p style="margin-bottom: 0cm">emontx[0].power2 = ct2.realPower;</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;\t&quot;); Serial.print(emontx[0].power2);</p>
<p style="margin-bottom: 0cm">//Serial.print(&quot;\t&quot;); Serial.print(ct2.Irms);</p>
<p style="margin-bottom: 0cm">//Serial.print(&quot;\t&quot;); Serial.print(ct2.powerFactor);</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (CT3)</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">ct3.calcVI(20,2000);</p>
<p style="margin-bottom: 0cm">emontx[0].power3 = ct3.realPower;</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;\t&quot;); Serial.print(emontx[0].power3);</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;\t&quot;); Serial.print(ct1.Vrms);</p>
<p style="margin-bottom: 0cm">Serial.println(); delay(100);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">// because millis() returns to zero after 50 days !</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (!settled &amp;&amp; millis() &gt; FILTERSETTLETIME) settled = true;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (settled) // send data only after filters have settled</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">readSlave(2); // get data for phase 2</p>
<p style="margin-bottom: 0cm">readSlave(3); // get data for phase 3</p>
<p style="margin-bottom: 0cm">delay(100); // send_rf_data corrupts any pending Serial.prints so wait until they finish - need to find out why</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">send_rf_data(); // *SEND RF DATA* - see emontx_lib</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">digitalWrite(LEDpin, HIGH); delay(2); digitalWrite(LEDpin, LOW); // flash LED</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">emontx_sleep(5); // sleep or delay in seconds - see emontx_lib</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">else if (UNO) wdt_reset();</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">Serial.print(Water);</p>
<p style="margin-bottom: 0cm">Serial.print(&#39; &#39;);</p>
<p style="margin-bottom: 0cm">Serial.print(Liter);</p>
<p style="margin-bottom: 0cm">Serial.println(pulseCount * ppltr); // Liters used</p>
<p style="margin-bottom: 0cm">delay(1000);</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//The interrupt routine &ndash; runs each time a falling edge of a pulse is detected</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">void onPulse()</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">lastTime = pulseTime;</p>
<p style="margin-bottom: 0cm">pulseTime = micros();</p>
<p style="margin-bottom: 0cm">pulseCount++; // count pulse</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">power = int((3600000000.0 / (pulseTime - lastTime))/ppltr); // calculate water</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9913"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 20:11.</div>
    <div class="content">
     <p>final cosmetic changes, still need to figure where to find emontx_lib.ino:</p>
<p>&nbsp;</p>
<p style="margin-bottom: 0cm">/*</p>
<p style="margin-bottom: 0cm">EmonTx CT123 + Voltage example</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">An example sketch for the emontx module for CT only electricity monitoring.</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Part of the openenergymonitor.org project</p>
<p style="margin-bottom: 0cm">Licence: GNU GPL V3</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Authors: Glyn Hudson, Trystan Lea</p>
<p style="margin-bottom: 0cm">Builds upon JeeLabs RF12 library and Arduino</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">emonTx documentation: <a href="../modules/emontx/index.html" title="http://openenergymonitor.org/emon/modules/emontx/">http://openenergymonitor.org/emon/modules/emontx/</a></p>
<p style="margin-bottom: 0cm">emonTx firmware code explination: <a href="../modules/emontx/firmware.html" title="http://openenergymonitor.org/emon/modules/emontx/firmware">http://openenergymonitor.org/emon/modules/emontx/firmware</a></p>
<p style="margin-bottom: 0cm">emonTx calibration instructions: <a href="../modules/emontx/firmware/calibration.html" title="http://openenergymonitor.org/emon/modules/emontx/firmware/calibration">http://openenergymonitor.org/emon/modules/emontx/firmware/calibration</a></p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">THIS SKETCH REQUIRES:</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Libraries in the standard arduino libraries folder:</p>
<p style="margin-bottom: 0cm">- JeeLib <a href="https://github.com/jcw/jeelib" title="https://github.com/jcw/jeelib">https://github.com/jcw/jeelib</a></p>
<p style="margin-bottom: 0cm">- EmonLib <a href="https://github.com/openenergymonitor/EmonLib.git" title="https://github.com/openenergymonitor/EmonLib.git">https://github.com/openenergymonitor/EmonLib.git</a></p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Other files in project directory (should appear in the arduino tabs above)</p>
<p style="margin-bottom: 0cm">- emontx_lib.ino</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Slave control for 3-phase added by Martin Roberts 14/10/12</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Pulse counter for Elster m100 Artist water meter by Bo Herrmannsen 16/02/13</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">*/</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#define FVCAL 237 // default is 234.26</p>
<p style="margin-bottom: 0cm">#define FICAL 111.5 // default 111.1</p>
<p style="margin-bottom: 0cm">#define FPHASE 1 // default 1.7</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#define FILTERSETTLETIME 5000 // Time (ms) to allow the filters to settle before sending data</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//CT 1 is always enabled</p>
<p style="margin-bottom: 0cm">const int CT2 = 1; // Set to 1 to enable CT channel 2</p>
<p style="margin-bottom: 0cm">const int CT3 = 0; // Set to 1 to enable CT channel 3</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#define freq RF12_433MHZ // Frequency of RF12B module can be RF12_433MHZ, RF12_868MHZ or RF12_915MHZ. You should use the one matching the module you have.433MHZ, RF12_868MHZ or RF12_915MHZ. You should use the one matching the module you have.</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int nodeID = 10; // emonTx RFM12B node ID</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int networkGroup = 210; // emonTx RFM12B wireless network group - needs to be same as emonBase and emonGLCD needs to be same as emonBase and emonGLCD</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int UNO = 1; // Set to 0 if your not using the UNO bootloader (i.e using Duemilanove) - All Atmega&#39;s shipped from OpenEnergyMonitor come with Arduino Uno bootloader</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &lt;avr/wdt.h&gt; // the UNO bootloader</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &lt;JeeLib.h&gt; // Download JeeLib: <a href="http://github.com/jcw/jeelib" title="http://github.com/jcw/jeelib">http://github.com/jcw/jeelib</a></p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ISR(WDT_vect) { Sleepy::watchdogEvent(); }</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &quot;EmonLib.h&quot;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">EnergyMonitor ct1,ct2,ct3; // Create instances for each CT channel</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">#include &lt;Wire.h&gt;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">typedef struct { int power1, power2, power3, Vrms; } PayloadTX; // neat way of packaging data for RF comms</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">PayloadTX emontx[3];</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">const int LEDpin = 9; // On-board emonTx LED</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">boolean settled = false;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">long pulseCount = 0;</p>
<p style="margin-bottom: 0cm">unsigned long pulseTime,lastTime; // Used to measure time between pulses</p>
<p style="margin-bottom: 0cm">double power;</p>
<p style="margin-bottom: 0cm">int ppltr = 1; // Pulses per liter</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Void setup()</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">Serial.begin(9600);</p>
<p style="margin-bottom: 0cm">Serial.println(&quot;emonTX CT123 Voltage example&quot;);</p>
<p style="margin-bottom: 0cm">Serial.println(&quot;OpenEnergyMonitor.org&quot;);</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;Node: &quot;);</p>
<p style="margin-bottom: 0cm">Serial.print(nodeID);</p>
<p style="margin-bottom: 0cm">Serial.print(&quot; Freq: &quot;);</p>
<p style="margin-bottom: 0cm">if (freq == RF12_433MHZ) Serial.print(&quot;433Mhz&quot;);</p>
<p style="margin-bottom: 0cm">if (freq == RF12_868MHZ) Serial.print(&quot;868Mhz&quot;);</p>
<p style="margin-bottom: 0cm">if (freq == RF12_915MHZ) Serial.print(&quot;915Mhz&quot;);</p>
<p style="margin-bottom: 0cm">Serial.print(&quot; Network: &quot;);</p>
<p style="margin-bottom: 0cm">Serial.println(networkGroup);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct1.voltageTX(FVCAL, FPHASE); // ct.voltageTX(calibration, phase_shift) - make sure to select correct calibration for AC-AC adapter <a href="../modules/index.html" title="http://openenergymonitor.org/emon/modules/">http://openenergymonitor.org/emon/modules/</a></p>
<p style="margin-bottom: 0cm">emontx/firmware/calibration</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct1.currentTX(1, FICAL);1 // Setup emonTX CT channel (channel (1,2 or 3), calibration)</p>
<p style="margin-bottom: 0cm">// CT Calibration factor = CT ratio / burden resistance</p>
<p style="margin-bottom: 0cm">ct2.voltageTX(FVCAL, FPHASE); // CT Calibration factor = (100A / 0.05A) x 18 Ohms</p>
<p style="margin-bottom: 0cm">ct2.currentTX(2, FICAL);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct3.voltageTX(FVCAL, FPHASE);</p>
<p style="margin-bottom: 0cm">ct3.currentTX(3, FICAL);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">rf12_initialize(nodeID, freq, networkGroup); // initialize RF</p>
<p style="margin-bottom: 0cm">//rf12_control(0xc657);</p>
<p style="margin-bottom: 0cm">// approx. 3.918kps, i.e. 10000/29(1+0x57) kps</p>
<p style="margin-bottom: 0cm">rf12_sleep(RF12_SLEEP);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Wire.begin(); // join i2c bus (address optional for master)</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">pinMode(LEDpin, OUTPUT); // Setup indicator LED</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">digitalWrite(LEDpin, HIGH);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (UNO) wdt_enable(WDTO_8S); // Enable anti crash (restart) watchdog if UNO bootloader is selected. Watchdog does not work with duemilanove</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">bootloader // Restarts emonTx if sketch hangs for more than 8s</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">// pulse detection interrupt (emontx pulse channel - IRQ0 D3)</p>
<p style="margin-bottom: 0cm">attachInterrupt(1, onPulse, FALLING);</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">void loop()</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">pokeSlave(2); // start slave on phase 2</p>
<p style="margin-bottom: 0cm">pokeSlave(3); // start slave on phase 3</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">ct1.calcVI(20,2000); // Calculate all. No.of crossings, time-out</p>
<p style="margin-bottom: 0cm">emontx[0].power1 = ct1.realPower;</p>
<p style="margin-bottom: 0cm">Serial.print(emontx[0].power1);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">emontx[0].Vrms = ct1.Vrms*100; // AC Mains rms voltage</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (CT2)</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">ct2.calcVI(20,2000); //ct.calcVI(number of crossings to sample, time out (ms) if no waveform is detected)</p>
<p style="margin-bottom: 0cm">emontx[0].power2 = ct2.realPower;</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;\t&quot;); Serial.print(emontx[0].power2);</p>
<p style="margin-bottom: 0cm">//Serial.print(&quot;\t&quot;); Serial.print(ct2.Irms);</p>
<p style="margin-bottom: 0cm">//Serial.print(&quot;\t&quot;); Serial.print(ct2.powerFactor);</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (CT3)</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">ct3.calcVI(20,2000);</p>
<p style="margin-bottom: 0cm">emontx[0].power3 = ct3.realPower;</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;\t&quot;); Serial.print(emontx[0].power3);</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">Serial.print(&quot;\t&quot;); Serial.print(ct1.Vrms);</p>
<p style="margin-bottom: 0cm">Serial.println(); delay(100);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">// because millis() returns to zero after 50 days !</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (!settled &amp;&amp; millis() &gt; FILTERSETTLETIME) settled = true;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if (settled) // send data only after filters have settled</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">readSlave(2); // get data for phase 2</p>
<p style="margin-bottom: 0cm">readSlave(3); // get data for phase 3</p>
<p style="margin-bottom: 0cm">delay(100); // send_rf_data corrupts any pending Serial.prints so wait until they finish - need to find out why</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">send_rf_data(); // *SEND RF DATA* - see emontx_lib</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">digitalWrite(LEDpin, HIGH); delay(2); digitalWrite(LEDpin, LOW); // flash LED</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">emontx_sleep(5); // sleep or delay in seconds - see emontx_lib</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">else if (UNO) wdt_reset();</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">Serial.print(Water);</p>
<p style="margin-bottom: 0cm">Serial.print(&#39; &#39;);</p>
<p style="margin-bottom: 0cm">Serial.print(Liter);</p>
<p style="margin-bottom: 0cm">Serial.println(pulseCount * ppltr); // Liters used</p>
<p style="margin-bottom: 0cm">delay(1000);</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//------------------------Water Start----------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//The interrupt routine &ndash; runs each time a falling edge of a pulse is detected</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">void onPulse()</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">lastTime = pulseTime;</p>
<p style="margin-bottom: 0cm">pulseTime = micros();</p>
<p style="margin-bottom: 0cm">pulseCount++; // count pulse</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">power = int((3600000000.0 / (pulseTime - lastTime))/ppltr); // calculate water</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">//------------------------Water End------------------------------</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">void pokeSlave(byte phase)</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">//Serial.print(&quot;Poking slave &quot;);</p>
<p style="margin-bottom: 0cm">//Serial.println(phase,DEC);</p>
<p style="margin-bottom: 0cm">Wire.beginTransmission(phase); // transmit to device slave</p>
<p style="margin-bottom: 0cm">Wire.write(0x5a); // send any data</p>
<p style="margin-bottom: 0cm">Wire.endTransmission(); // stop transmitting</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">void readSlave(byte phase)</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">byte *p;</p>
<p style="margin-bottom: 0cm">int i;</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">if((phase&lt;2)||(phase&gt;3)) return;</p>
<p style="margin-bottom: 0cm">p=(byte *)(&amp;emontx[phase-1]);</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">//Serial.print(&quot;Reading from slave &quot;);</p>
<p style="margin-bottom: 0cm">//Serial.println(phase,DEC);</p>
<p style="margin-bottom: 0cm">Wire.requestFrom(phase, sizeof emontx[0]); // request data from slave device</p>
<p style="margin-bottom: 0cm">&nbsp;</p>
<p style="margin-bottom: 0cm">i=0;</p>
<p style="margin-bottom: 0cm">while(Wire.available()) // slave may send less than requested</p>
<p style="margin-bottom: 0cm">{</p>
<p style="margin-bottom: 0cm">p[i++] = Wire.read();</p>
<p style="margin-bottom: 0cm">}</p>
<p style="margin-bottom: 0cm">}</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9914"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sat, 16/02/2013 - 20:11.</div>
    <div class="content">
     <p>when compiling i got these errors.. i guess its very simple:</p>
<p>&nbsp;</p>
<p>In file included from sketch_feb16b.cpp:58:<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:9: error: stray &#39;\302&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:9: error: stray &#39;\267&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:9: error: stray &#39;\302&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:9: error: stray &#39;\267&#39; in program<br />
	In file included from sketch_feb16b.cpp:58:<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:252:46: error: invalid suffix &quot;dc3202e9bd6dee29fbfadea040f592d&quot; on integer constant<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:253:62: error: invalid suffix &quot;dc3202e9bd6dee29fbfadea040f592d&quot; on integer constant<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:442: error: stray &#39;#&#39; in program<br />
	In file included from sketch_feb16b.cpp:62:<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:9: error: stray &#39;\302&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:9: error: stray &#39;\267&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:9: error: stray &#39;\302&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:9: error: stray &#39;\267&#39; in program<br />
	In file included from sketch_feb16b.cpp:62:<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:248:46: error: invalid suffix &quot;c7fa71f1de8d7c8a35f1c2056c669ff&quot; on integer constant<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:249:62: error: invalid suffix &quot;c7fa71f1de8d7c8a35f1c2056c669ff&quot; on integer constant<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:270: error: stray &#39;\342&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:270: error: stray &#39;\200&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:270: error: stray &#39;\246&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: stray &#39;#&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: stray &#39;#&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: stray &#39;#&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: stray &#39;#&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: stray &#39;#&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: stray &#39;#&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: stray &#39;#&#39; in program<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:489: error: stray &#39;#&#39; in program<br />
	sketch_feb16b:33: error: &#39;Void&#39; does not name a type<br />
	In file included from sketch_feb16b.cpp:58:<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:4: error: expected unqualified-id before &#39;&lt;&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:389: error: expected constructor, destructor, or type conversion before &#39;&lt;&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:421: error: expected constructor, destructor, or type conversion before &#39;&lt;&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:423: error: expected constructor, destructor, or type conversion before &#39;&lt;&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/JeeLib/JeeLib.h:430: error: expected unqualified-id before numeric constant<br />
	sketch_feb16b.cpp: In function &#39;void __vector_12()&#39;:<br />
	sketch_feb16b:53: error: &#39;Sleepy&#39; has not been declared<br />
	In file included from sketch_feb16b.cpp:62:<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h: At global scope:<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:4: error: expected unqualified-id before &#39;&lt;&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: expected constructor, destructor, or type conversion before &#39;;&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: expected unqualified-id before numeric constant<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: expected unqualified-id before &#39;=&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: expected constructor, destructor, or type conversion before &#39;.&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: expected unqualified-id before &#39;&lt;&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: expected constructor, destructor, or type conversion before &#39;.&#39; token<br />
	/Applications/Arduino101.app/Contents/Resources/Java/libraries/EmonLib/EmonLib.h:391: error: expected unqualified-id before &#39;&lt;&#39; token</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9922"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sun, 17/02/2013 - 09:09.</div>
    <div class="content">
     <p>sorry for the crossposting....</p>
<p>&nbsp;</p>
<p>i got a heads up on the errors and will add the missing .cpp</p>
<p>&nbsp;</p>
<p>and will check if water messurement is done right... but heads up on that are welcome</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9925"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sun, 17/02/2013 - 09:40.</div>
    <div class="content">
     <p>i thank <a href="../user/924.html" title="View user profile.">Robert Wall</a> for the heads up...</p>
<p>My errors are now down to this little:</p>
<p>sketch_feb16b.cpp: In function &#39;void setup()&#39;:<br />
	sketch_feb16b:113: error: &#39;bootloader&#39; was not declared in this scope<br />
	sketch_feb16b.cpp: In function &#39;void loop()&#39;:<br />
	sketch_feb16b:160: error: &#39;send_rf_data&#39; was not declared in this scope<br />
	sketch_feb16b:164: error: &#39;emontx_sleep&#39; was not declared in this scope</p>
<p>i assume its because i have yet to figure which emontx_lib.ino to use (found a lot of them)</p>
<p><em>Other files in project directory (should appear in the arduino tabs above)<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - emontx_lib.ino</em></p>
<p>The org sketch comes from here: <a href="1170.html" title="http://openenergymonitor.org/emon/node/1170">http://openenergymonitor.org/emon/node/1170</a> and the only link was to the sketch itself</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9936"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sun, 17/02/2013 - 15:58.</div>
    <div class="content">
     <p>found the file... just there are 6 copies in the firmware zip... each seems a bit different...</p>
<p>EDIT: 2 of them are the same, so 5 different versions... the 2 first files are excatly the same, the rest are just subversion so to speak.. some lines are commented out in one version and in the others other lines are commented out.&nbsp; still i dont know which one the author intended to use</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9937"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sun, 17/02/2013 - 16:25.</div>
    <div class="content">
     <p>thinking about adding a infrared serial port to read my heat meter...</p>
<p>have looked at the schematics and to me it seems that there are no free pins on the chip... or have i missed something?</p>
<p>if i have not what would be the most wise to do? i was thinking about using the pin for temp prope since i do not plan to use it anyway and maybe one of the CT jack ports</p>
<p>since i intend to copy the full 3 phase system i only use 1 CT probe and the pulse input on the master</p>
<p>if its total undoable i do have an mega on the shelf that could be used to read the heat meter and send to the emonbase</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9945"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Sun, 17/02/2013 - 19:53.</div>
    <div class="content">
     <p>all problems sorted for so far... except one:</p>
<p>sketch_feb16b.cpp: In function &#39;void setup()&#39;:<br />
	sketch_feb16b:113: error: &#39;bootloader&#39; was not declared in this scope</p>
<p>but with this little my head have moved forward... is it possible with simple small hacks to add a serial port?</p>
<p>sketch attached, if any erros please let me know</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9955"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 18/02/2013 - 00:14.</div>
    <div class="content">
     <p>That error is telling me that the compiler thinks there is a variable (or a function) called &quot;bootloader&quot; that has not been declared or defined.&nbsp; I do not think there is a such a thing. &quot;:113&quot; means that at line 113, the compiler knew there was an error. The error might be that line or somewhere before that. What does line 113, or the line or lines that come immediately before it, look like?&nbsp; Do they look correct? Is something obviously wrong?</p>
<p>How did you obtain the file? I did warn you not to copy off the screen, but to download a &quot;Raw&quot; file or a &quot;Zip&quot; file from Github. If you must copy off the screen, you must make sure you do not create new lines where the screen image wraps around.</p>
<p>(I can see what your problem is, I am trying to teach you how to find it for yourself, and how to avoid the problem next time).</p>
<p>Look at the Community section <a href="626.html" title="http://openenergymonitor.org/emon/node/626">http://openenergymonitor.org/emon/node/626</a> for information about reading serial data from a meter.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9961"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 09:11.</div>
    <div class="content">
     <p>dooh... i got the code from here: <a href="../sites/default/files/emonTx_CT123_Voltage_3phase_Master.html" title="http://openenergymonitor.org/emon/sites/default/files/emonTx_CT123_Voltage_3phase_Master.ino">http://openenergymonitor.org/emon/sites/default/files/emonTx_CT123_Volta...</a></p>
<p>then i added the sections from the pulse count examples (modded to count water instead)</p>
<p>of course in the first link the bootloader statement is not even there and should not be even if i add pulse count... (in fact its not even in the pulse count example found here: <a href="../emontx/firmware/writing-code-for-the-emontx.html" title="http://openenergymonitor.org/emon/emontx/firmware/writing-code-for-the-emontx">http://openenergymonitor.org/emon/emontx/firmware/writing-code-for-the-e...</a></p>
<p>So now the big mystery is just where i found the bootloader line</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9963"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 09:48.</div>
    <div class="content">
     <p>i read the post at <a href="626.html" title="http://openenergymonitor.org/emon/node/626">http://openenergymonitor.org/emon/node/626</a></p>
<p>only thing is that i does not descripe how to connect the ir sender and ir photo transistor</p>
<p>i allready have a arduino code spec for my meter and how to connect IR stuff... i only miss how to hook up the IR stuff to the imontx... i assume that it requires that there are free pins or that there are unused jacks.. in my case i know that i will only use one CT jack</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9966"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 18/02/2013 - 10:42.</div>
    <div class="content">
     <p><em>So now the big mystery is just where i found the bootloader line</em></p>
<p>It&#39;s not that big a mystery, Robert gave you a very big hint above. Try searching for &quot;bootloader&quot; in the original code and you should see where it came from. You must have added the semicolon your self so that should have given you a clue.</p>
<p>It seems to me that you are well out of your depth here and are trying to do something quite difficult before you have mastered the basics. It&#39;s always best to take small steps when you aren&#39;t sure exactly how things work. e.g. get the&nbsp;original code to compile before you try to modify it.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9968"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 10:54.</div>
    <div class="content">
     <p>oh yeah... forgot about my meter... compared to the elster meter mine does not transmit anything before it has gotten a request... hence there is a need for 2 pins.. one for tx and one for rx.</p>
<p>i have attached the sketch (not made by me) for my heat meter... it was org written to just output the data and a set interval. It will need to be reduced in what data is sent, i only need total energy since you can always calc what has been consumed each poll.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9969"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 10:59.</div>
    <div class="content">
     <p>well it might seems that i stand in water to my nose... programming has never been my strong side, but i have made an arduino base gsm remote to control my pre-heater in the car.. only problem there is that the gsm shield sometimes loose connection to the gsm network... but i just need to figure some code that can check the blink freq and reset the gsm module it the reception LED blinks to fast.</p>
<p>so in other words i can hack together code... even thou sometimes i need a lot of help...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9970"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 11:07.</div>
    <div class="content">
     <p>*see&#39;s the light*</p>
<p>now i got it... indeed i have put in a semicolon the wrong place... but yes, i agree... start with the org code as is before start modding it...</p>
<p>i was just a bit to fast... like the idea of the project so much that i dont take time to sit back and understand first (a weakness of mine)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9972"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 14:14.</div>
    <div class="content">
     <p>think i got most of the sketch done...</p>
<p>as i have a mega on the shelf i wanted to use that as a play-a-round platform... but how do i change pin mapping... i guess in the emontx_lib.cpp but the only thing i could find there is:</p>
<p>//--------------------------------------------------------------------------------------<br />
	// Sets the pins to be used for voltage and current sensors based on emontx pin map<br />
	//--------------------------------------------------------------------------------------</p>
<p>since i plan to use 3 phase i will need the emontx in the end but wanted to fault check my sketch first.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9973"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 15:30.</div>
    <div class="content">
     <p>hmm... have been thinking about this since my last post</p>
<p>since i got a mega could i use 3 shields (one with rf) and stack them all on top of each other?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9974"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Mon, 18/02/2013 - 16:31.</div>
    <div class="content">
     <p>been comparing the schematics for the emontx and the arduino mega 2560.. i can compare all the pin names on the atmega chips so i guess i don&#39;t need to change the library&#39;s but just connectt the right places...</p>
<p>the only thing i cant figure is how i change the library so it can work with 3 ac inputs at the same time... (so i get each phase more accurate)</p>
<p>&nbsp;</p>
<p>EDIT: of course this all means i have to make a shield myself... unless i can use the emontx shield and just stack them..</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-9996"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Tue, 19/02/2013 - 13:27.</div>
    <div class="content">
     <p>hmm.. building a shield is not that hard....</p>
<p>&nbsp;</p>
<p>but where do i find port maps etc? i would need that to change the pins from what&#39;s used on an uno to what an mega has</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10001"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Tue, 19/02/2013 - 16:12.</div>
    <div class="content">
     <p>Almost ready with the schematic... just need to figure what pins on an mega board i will have to connect the imputs to so that i can use the library&#39;s without having to change them much</p>
<p>&nbsp;</p>
<p>about the lib&#39;s.. i know i can messure current with one CT and one 9V AC... but how do i go about 3 CT&#39;s and 9V AC for each CT but on same board sketch?</p>
<p>can i just match the pin names on an uno with the pin names on a mega or is there more to it than that?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-10021"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3149.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3149.jpg" alt="boelle&#039;s picture" title="boelle&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: advice for monitoring water meters? [Closed]</h3>

    <div class="submitted">Submitted by <a href="../user/3149.html" title="View user profile.">boelle</a> on Wed, 20/02/2013 - 14:23.</div>
    <div class="content">
     <p>Attached is a draft for an EmonTX Shield for the Arduino Mega.</p>
<p>The end goal / Idea is to have a shield that has full 3 Phase input (not just 1 9VAC input), Input for Water Meter (Pulse) and Infra Red Port for Meters that do coms that way...</p>
<p>Suggestions Ideas are more than welcome</p>
<p>Only thing that could have been done wrong is what pin each input is connected to. I have done my best to match pin names from the emontx chip to what i can read on a schematic for the mega</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1974"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-NL-HMELnhPfdgxxxktpQEnvjlfxKblllOcmKArILy6I" value="form-NL-HMELnhPfdgxxxktpQEnvjlfxKblllOcmKArILy6I"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
