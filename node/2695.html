<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2695 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:08:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>telling when energy is being exported | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">telling when energy is being exported</h3>
        <span class="submitted">Submitted by Guest on Wed, 14/08/2013 - 20:14</span>
        <div class="content"><p>I am using the code below but only get positive number whether I am importing or exporting power to the grid. Any advice on what i am doing wrong, probably trivial as I am rather a begiiner&nbsp;in this area</p>
<p>&nbsp;</p>
<p>emon1.current(1, 111.1);&nbsp; // Current: input pin, calibration.<br />
	emon1.voltage(2, 234.26, 1.7);&nbsp; // Voltage: input pin, calibration, phase_shift</p>
<p>emon2.current(3, 111.1);&nbsp;</p>
<p>....</p>
<p>double Irms = emon1.calcIrms(1480);&nbsp; // Calculate Irms only<br />
	emon1.calcVI(20,2000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Calculate all. No.of crossings, time-out</p>
<p>double Irmsfeed = emon2.calcIrms(1480);&nbsp; // Calculate Irms only</p>
<p>emontx.powersolar=Irms*230;<br />
	emontx.powerfeed=emon1.realPower;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2652.html" class="topic-previous" title="Go to previous forum topic">‹ Transformer in place of AC_AC adapter.</a>
              <a href="2338.html" class="topic-next" title="Go to next forum topic">How to just send the time part from the raspberry pi to emonglcd ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-14347"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: telling when energy is being exported</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 15/08/2013 - 18:05.</div>
    <div class="content">
     <p>Power direction depends on the relative phases of the current and the voltage - read about it in Building Blocks - <a href="https://learn.openenergymonitor.org/?redirect=ac-power-introduction">An introduction to AC Power</a></p>
<p>Your sketch has no knowledge of the voltage, hence it cannot know the relationship between current and voltage. You need to look at one of the CT123_voltage example sketches - and measure the voltage as well as the current.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14352"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Da01769&#039;s picture" title="Da01769&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: telling when energy is being exported</h3>

    <div class="submitted">Submitted by Da01769 (not verified) on Thu, 15/08/2013 - 19:45.</div>
    <div class="content">
     <p>Robert,</p>
<p>many thanks for the suggestion, I have read both the intro and CT123 but am still confused. In my script I have the line</p>
<p>emon1.voltage(2, 234.26, 1.7);</p>
<p>does this not do what is required? Sorry if I am being stupid here but I am struggling with how the libraries are invoked. I assumed the the calc in calcirms&nbsp;invoked what I needed. I have run the CT123 demo script but do not get meaningful, at least to me, output. &nbsp;What have I missed here?</p>
<p>&nbsp;</p>
<p>Dave</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14357"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: telling when energy is being exported</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 15/08/2013 - 20:19.</div>
    <div class="content">
     <p>Take a look at <a href="https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTx_CT123_Voltage">emonTx_CT123_Voltage</a> which you can get from Github</p>
<p>In the emonLib library, in the EnergyMonitor there are two principal <em>methods</em> that do the donkey work:</p>
<p>&nbsp;&nbsp;&nbsp; void calcVI(int wavelengths, int timeout, long refCal=1126400L);<br />
	&nbsp;&nbsp;&nbsp; double calcIrms(int NUMBER_OF_SAMPLES, long refCal=1126400L);</p>
<p>and some supporting methods that set up the variables:</p>
<p>&nbsp;&nbsp;&nbsp; void voltage(int _inPinV, double _VCAL, double _PHASECAL);<br />
	&nbsp;&nbsp;&nbsp; void current(int _inPinI, double _ICAL);</p>
<p>&nbsp;&nbsp;&nbsp; void voltageTX(double _VCAL, double _PHASECAL);<br />
	&nbsp;&nbsp;&nbsp; void currentTX(int _channel, double _ICAL);</p>
<p>&nbsp;&nbsp;&nbsp; void voltageTX3(double _VCAL, double _PHASECAL);<br />
	&nbsp;&nbsp;&nbsp; void currentTX3(int _channel, double _ICAL);</p>
<p>You are using calcIrms, the one that calculates rms current. If you read through the code in EmonLib.cpp, you&#39;ll see that nowhere is the voltage used.</p>
<p>Now look at calcVI(....), and you&#39;ll see that - like the graphs in the BB article, each sample of current is multiplied by the corresponding voltage sample to give you power. Hence if voltage and current are the same sign, power is positive and if they are the opposite sign, power is negative.</p>
<p>You do have an ac-ac voltage adapter connected to your voltage input, don&#39;t you?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14358"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Da01769&#039;s picture" title="Da01769&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: telling when energy is being exported</h3>

    <div class="submitted">Submitted by Da01769 (not verified) on Thu, 15/08/2013 - 20:40.</div>
    <div class="content">
     <p>I do have a ac-ac voltage adapter connected and thanks for the explanation of why calcirms does not work. Now with calcirms&nbsp;I assign the answer in the invocation ( irms&nbsp;= calcirms ...) but for ClacVI i just invoke the routine, how do I reference the results, in particular the realpower with its associated direction indication. This is where I think my main problem in grasping how things for together lies, too many years since I programmed seriously.</p>
<p>&nbsp;</p>
<p>Dave</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14360"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: telling when energy is being exported</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 15/08/2013 - 20:54.</div>
    <div class="content">
     <p>Look at emonTx_CT123_Voltage.ino and the line immediately after calcVI(...)</p>
<p>realPower is a<em> property</em> of the EnergyMonitor class - calcVI gives it a value and there it sits until it&#39;s changed. That line fishes it out and assigns the value to the left-hand side. You could equally well do<br />
	&nbsp; Serial.print([whatever].realPower);<br />
	or indeed any of the other properties listed as public in emonLib.h, apparentPower, powerFactor, Vrms, Irms.<br />
	[whatever] is the name you gave to the class <em>instance</em>, emon1 or emon2 in your case. You almost had this in the last line of your first post.</p>
<p>[Edit: Robin - don&#39;t confuse the poor guy at this stage, he&#39;s fumbling with getting his first sketch to work.]</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14361"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: telling when energy is being exported</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 15/08/2013 - 21:30.</div>
    <div class="content">
     <p>Once you have a working voltage sensor and current sensor, you may find it helpful to run some of the simple sketches which are listed near the top of my <a href="1757.html">Summary Page</a>.&nbsp; They may seem trivial, but they can really show you what&#39;s going on at a low level.&nbsp;</p>
<p>Using <strong>MinAndMaxValues</strong>, you are actually seeing the raw sample values from your ADC.&nbsp; The later version, <strong>MinMaxAndRangeChecker</strong>, repeatedly displays these values for each of the first four analogue channels.&nbsp; Your V and I sensors are likely to be using two of these channels, but the other two channels will be floating so beware of spurious values from them.</p>
<p><strong>RawSamplesTool</strong> can provide a simple graphical display on your Serial Monitor of your voltage and current waveforms.&nbsp; This is a really useful tool to run on any new front-end hardware.&nbsp;&nbsp; If you don&#39;t have EmonLib handy (which it doesn&#39;t actually use), the later version <strong>RawSamplesTool_4ss_2</strong> may be better.&nbsp; I used that one myself only yesterday.</p>
<p>Any of my Mk2 PV Router sketches will allow you to measure continuously the flow of energy.&nbsp; <strong>Mk2_PV_Router_mini_3</strong> might be a good one to try first.&nbsp; Every second, it displays how many Joules have been recorded.&nbsp; It should work fine with just the input hardware, but it does require the AC voltage source to be present, as do most of my sketches.</p>
<p>Another useful sketch which I&#39;d almost forgotten about is <strong>DigitalMeterEmulator</strong>.&nbsp; This gives a 40 mS pulse every 3600 Joules which is what most digital electricity meters do.&nbsp; If you happen to have a spare 1000 pulses-per-kWh meter which you can connect in series, calibration then becomes very straightforward.&nbsp; When both LEDs are flashing at the same rate, your calibration is perfect :D</p>
<p>Edit - Many people have told me that the simple tools that I&#39;ve posted have been really helpful to get their systems up and running.&nbsp; I look forward to seeing how this thread develops ...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-14374"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Da01769&#039;s picture" title="Da01769&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: telling when energy is being exported</h3>

    <div class="submitted">Submitted by Da01769 (not verified) on Fri, 16/08/2013 - 09:07.</div>
    <div class="content">
     <p>many thanks for the help with my sketch, I think I now have direction of current and am going to let it run for a while to collect some data. I will then try some of the suggested stuff to both calibrate and refine what i am collecting. I think I am starting to get the hang of how things link together, fairly simple once grasped but really very confusing until you see the linkages between the setup section, the loop section and the libraries.&nbsp;</p>
<p>Dave</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2695"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-8HcJbCpnJrwLs2ReJB95_wTJLo8KDoTKxv0CSrJS_Lw" value="form-8HcJbCpnJrwLs2ReJB95_wTJLo8KDoTKxv0CSrJS_Lw"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/2695 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:08:33 GMT -->
</html>
