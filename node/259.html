<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/259 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:51:31 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>A few questions | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">A few questions</h3>
        <span class="submitted">Submitted by Guest on Mon, 17/10/2011 - 23:44</span>
        <div class="content"><p>I&nbsp;posted this in the software area but didnt get a response so trying here plus another question:</p>
<p>==================================</p>
<p>Hi Guys,</p>
<p>I am going to try and use my existing Arduino based inverter monitor to also monitor my household consumption. I am planning on basing it heavily on the great work on here. I am currently looking at modifying the &quot;Basic energy monitoring sketch&quot; I have a few questions in relation to that specific script:</p>
<p>I can poll my inverter for the current mains voltage so I don't need the AC-AC adapter solution. Given that I get an accurate mains voltage should I just comment out filteredV and shiftedV and use sampleV all the way down.</p>
<p>I assume that the code in this thread: <a href="198.html"><font color="#3399cc">http://openenergymonitor.org/emon/node/198</font></a>&nbsp;is what I would use to calculate the total consumption for the day. I then just need to write a small bit of code to calculate a RMS&nbsp;for real power because the data is uploaded every 5 mins.</p>
<p>EDIT: Also I am using 3 phase power so what is the best way to combine this. (1) Do three analogue reads and add them together for a total sampleI (or does the IRATIO vary too much between CTs?); or (2) Do consecutive calls to the function for each phase and add the real powers at the end; or (3) Something else??</p>
<p>================================</p>
<p>Plus my latest question after having built it is I&nbsp;am finding that my calibration curve isn't linear. I need a ICAL&nbsp;of about 1 for loads around 500W, at 2000W&nbsp;it is 1.25 and at 200w it is 0.66. So any ideas about this. Could it be my power meter? Could it be my circuit (I used 5% resistors)? Has anyone seen this before? I thought I&nbsp;could just get around it by using a simple IF-THEN and using a different ICAL&nbsp;depending on the raw power measurement?</p>
<p>Thanks for any help!</p>
  <div class="forum-topic-navigation clear-block">
          <a href="277.html" class="topic-previous" title="Go to previous forum topic">‹ Emoncms2 with Extras</a>
              <a href="257.html" class="topic-next" title="Go to next forum topic">Hmm - was working now, isnt... ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-2221"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Krumlov&#039;s picture" title="Krumlov&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: A few questions</h3>

    <div class="submitted">Submitted by Krumlov (not verified) on Tue, 18/10/2011 - 10:09.</div>
    <div class="content">
     <p>Still would appreciate any additonal info but I&nbsp;think I&nbsp;have solved the calibration problem. I had noticed that I was getting 30-40W indicated when I had nothing connected but there were posts elsewhere on this site that said that was normal so I didn;t think anything of it. However it occurred to me that that is a significant proportion of any loads that are a few hundred watts. So I measured the values being returned with nothing connected (which was around 510) and then started subtracting that from the read values so that when nothing was connected I&nbsp;was getting only a couple of watts being shown.</p>
<p>This basically fixed it. My ICAL values are now around 2.6 and am seeing an accuracy of +/-3% of the plug in meter. So pretty happy I might have solved it. Why I am having this problem and no-one else I don't know.</p>
<p>Still would like some opinions on the best way to handle 3 phase power. I have seen the two phase example and note that it uses separate calls for each phase. I&nbsp;think it would be faster to read each pin and add them all together if this would work. Thoughts?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2339"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Krumlov&#039;s picture" title="Krumlov&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: A few questions</h3>

    <div class="submitted">Submitted by Krumlov (not verified) on Sun, 20/11/2011 - 12:35.</div>
    <div class="content">
     <p>Bit disappointed I&nbsp;wasn't able to get any feedback on my questions but for those in the future here is my test sketch that I came up with to get it to work for me. Thanks to those who came up with the initial sketches and circuits but I don't know how others have it working so well without removing the &quot;noise&quot; from the data. Unless mine is more noisy than others. I&nbsp;do have the three current sensing electronics and the voltage sensing all on a tiny breadboard. In any case once I&nbsp;started to remove the false readings I found that acted as a calibration for the low end of the current range and then the ICAL variable did the adjustment for the high end. I have 3 phase power&nbsp;so you will see how I solved that, I&nbsp;only reasonably had the ability to measure voltage on one phase so there will be some inaccuracies there but you will also see the effect that had on the PHASECAL values. Lastly I&nbsp;commented out a bunch of variables as I&nbsp;was trying to get this to work on a UNO which is also doing some other stuff so memory is at a premium. Again this is only a test sketch that I&nbsp;was using as a proof of concept but hopefully someone will find it useful.</p>
<p>&nbsp;</p>
<pre>
/**************************************************************\
 * | ORIGINALLY:
 * //Basic energy monitoring sketch
 * //Authors: Trystan Lea, Eric Sandeen
 *
 * //Licenced under GNU General Public Licence more details here
 * // openenergymonitor.org
 \**************************************************************/

/*********************************************************************\
 * |Modified for future use as an energy monitor      |
 * |which uploads to pvoutput.org                                        |
 * |This version is test/calibration sketch                              |
 * |                                                                     |
 \*********************************************************************/</pre><pre>
//Sketch measures voltage and current.
//and then calculates useful values like real power,

#define  PHASE_A  0
#define  PHASE_B  1
#define  PHASE_C  2</pre><pre>
//Setup variables
int numberOfSamples = 3000;

//Set Voltage and current input pins
int inPinV = 2;
int inPinI[3] = {5, 4, 3};</pre><pre>
//Sanity check calibration method thanks to Eric Sandeen <a href="http://sandeen.net/wordpress">http://sandeen.net/wordpress</a>
//See discussion here: <a href="59.html">http://openenergymonitor.org/emon/node/59</a>
//Enter the values of your setup below

// Voltage is reduced both by wall xfmr &amp; voltage divider
// #define AC_WALL_VOLTAGE        245
// #define AC_ADAPTER_VOLTAGE     14.1
// Ratio of the voltage divider in the circuit
// #define AC_VOLTAGE_DIV_RATIO   13
// CT: Voltage depends on current, burden resistor, and turns
//#define CT_BURDEN_RESISTOR    56
//#define CT_TURNS              1350</pre><pre>
//Calibration coeficients
//These need to be set in order to obtain accurate results
//Set the above values first and then calibrate futher using normal calibration method described on how to build it page.
double VCAL = 1.1567;
double ICAL[3] = {2.28, 2.3, 2.17};
double PHASECAL[3] = {-4.5, 5.78, 6.49};

double I_ZERO[3] = {512.2, 509.5, 511.6};</pre><pre>
// Initial gueses for ratios, modified by VCAL/ICAL tweaks
//#define AC_ADAPTER_RATIO       (AC_WALL_VOLTAGE / AC_ADAPTER_VOLTAGE) // Variable Saving
double V_RATIO = (245/14.1) * 13 * 5 / 1024 * VCAL; // Variable Saving this was = AC_ADAPTER_RATIO * AC_VOLTAGE_DIV_RATIO * 5 / 1024 * VCAL;
double I_RATIO = (long double)1350 / 56 * 5 / 1024;  // Variable Saving this was = (long double)CT_TURNS / CT_BURDEN_RESISTOR * 5 / 1024 * ICAL;

//Sample variables
float lastSampleV,lastSampleI[3],sampleV,sampleI[3];</pre><pre>
//Filter variables
double lastFilteredV, lastFilteredI[3], filteredV, filteredI[3];

//Stores the phase calibrated instantaneous voltage.
double shiftedV[3];</pre><pre>
//Power calculation variables
double sumP;

//Useful value variables
double realPower[3];</pre><pre>
//Variables used by Gav to determine total power consumption     
double Total_Daily_Consumption = 0L,   // This is the total power for the day and is a sum of the xxxx multipled by the time since last update
Sum_Power_Used = 0L;            // This is the average instantaneous power used to be uploaded at every 5 mins.

unsigned long lwhtime, whtime = 0L;
int number_PowerCalcs = 0;</pre><pre>
char status_url[200];

void setup()
{
  Serial.begin(9600);
  sampleV = analogRead(inPinV);                        //Do a read now to stop spurious first calculations
  sampleI[PHASE_A] = analogRead(inPinI[PHASE_A])-I_ZERO[PHASE_A];
  sampleI[PHASE_B] = analogRead(inPinI[PHASE_B])-I_ZERO[PHASE_B];
  sampleI[PHASE_C] = analogRead(inPinI[PHASE_C])-I_ZERO[PHASE_C];</pre><pre>
}

void loop()
{
  float tempPower = 0;</pre><pre>
  for (int phase=0; phase&lt;=2; phase++){
    Calc_Power_Used(phase);

    lwhtime = whtime;
    whtime = millis();
    Total_Daily_Consumption += realPower[phase] * ((whtime-lwhtime)/(3600000.0));
    tempPower += realPower[phase];</pre><pre>
    switch(phase){
      case(0):
      Serial.println(&quot;PHASE A&quot;);
      break;
      case(1):
      Serial.println(&quot;PHASE B&quot;);
      break;
      case(2):
      Serial.println(&quot;PHASE C&quot;);
      break;
    }
    //Output to serial
    Serial.print(&quot; RP &quot;);
    Serial.print(realPower[phase]);
    Serial.print(&quot; Increment &quot;);
    Serial.print(realPower[phase] * ((whtime-lwhtime)/(3600000.0)));
    Serial.print(&quot; Total &quot;);
    Serial.print(Total_Daily_Consumption);
    Serial.print(&quot; Sum Power &quot;);
    Serial.print(Sum_Power_Used);
    Serial.print(&quot; Calcs &quot;);
    Serial.print(number_PowerCalcs);
    Serial.print(&quot; TIME &quot;);
    Serial.println(whtime-lwhtime);

  }</pre><pre>
  Sum_Power_Used += (tempPower * tempPower);
  number_PowerCalcs++;

  sprintf(status_url, &quot;v3=%ld&amp;v4=%d HTTP/1.0\0&quot;, long(floor(Total_Daily_Consumption)), (int)round(sqrt(Sum_Power_Used / number_PowerCalcs)));
  Serial.println(status_url);</pre><pre>
}


/*******************************************************************\
 * |                                                                   |
 * | Calc_Power_Used determines the power being used at that moment    |
 * | in time. The main loop then looks at the time differential        |
 * | and adds the real power used to the total used.                   |
 * |                                                                   |
 * | This will loop for 3000 samples or 3 seconds whatever comes first |
 * |                                                                   |
 \*******************************************************************/</pre><pre>
void Calc_Power_Used(int phase)
{
  unsigned long start = millis();
  int n = 0;
  while ((n &lt; numberOfSamples) &amp;&amp; (millis() - start) &lt; 3000)
  {
    n++;
    //Used for offset removal
    lastSampleV=sampleV;
    lastSampleI[phase]=sampleI[phase];

    //Read in voltage and current samples.  
    sampleV = analogRead(inPinV);               
    sampleI[phase] = analogRead(inPinI[phase])-I_ZERO[phase];
    if (sampleI[phase] &lt; 0) sampleI[phase] =0;</pre><pre>
    //Used for offset removal
    lastFilteredV = filteredV;
    lastFilteredI[phase] = filteredI[phase];

    //Digital high pass filters to remove 2.5V DC offset.
    filteredV = 0.996*(lastFilteredV+sampleV-lastSampleV);</pre><pre>
    //filteredI = 0.996*(lastFilteredI+sampleI-lastSampleI);
    filteredI[phase] = 0.996*(lastFilteredI[phase]+sampleI[phase]-lastSampleI[phase]);

    //Phase calibration goes here.
    shiftedV[phase] = lastFilteredV + PHASECAL[phase] * (filteredV - lastFilteredV);
    //shiftedV = sampleV;</pre><pre>
    //Instantaneous Power
    sumP = sumP + shiftedV[phase] * filteredI[phase];

  }</pre><pre>
  //Calculation of the root of the mean of the voltage and current squared (rms)
  //Calibration coeficients applied.

  //Calculation power values
  realPower[phase] = V_RATIO*I_RATIO*ICAL[phase]*sumP / numberOfSamples;</pre><pre>
  //Reset accumulators
  sumP = 0; 

}</pre><p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2342"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Mr. Sharkey&#039;s picture" title="Mr. Sharkey&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: A few questions</h3>

    <div class="submitted">Submitted by Mr. Sharkey (not verified) on Sun, 20/11/2011 - 16:57.</div>
    <div class="content">
     <p>No expert here, but I found that if the burden resistors on the current transformers are not selected carefully, the resulting voltage sample is not linear over the entire measurement range. My test showed that after a break-over level, the voltage increase was no longer linearly proportional to the current increase when the resistor value was too high.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2344"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Krumlov&#039;s picture" title="Krumlov&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: A few questions</h3>

    <div class="submitted">Submitted by Krumlov (not verified) on Mon, 21/11/2011 - 11:34.</div>
    <div class="content">
     <p>Thanks for the reply. Your link didn't work for me but I&nbsp;used the standard Efergy CTs and a resistor of 56 Ohms which was recommended somewhere on the site. So not sure if that was my problem?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/259"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-FMSB2Ie_fpl-GsL_lAa78CMcROa7MfG_F9ieIgibyE0" value="form-FMSB2Ie_fpl-GsL_lAa78CMcROa7MfG_F9ieIgibyE0"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
