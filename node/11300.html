<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11300 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:14:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonTx hang with 3-Phase firmware and &lt;230V | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonTx hang with 3-Phase firmware and &lt;230V</h3>
        <span class="submitted">Submitted by <a href="../user/8741.html" title="View user profile.">David Eitzinger</a> on Thu, 24/09/2015 - 21:21</span>
        <div class="content"><p>I have a question regarding the last revisions of the 3-phase sketch (emonTxV3_4_3Phase_Voltage v0.5): In the<br />
versions &gt; v0.3 the jeelib dependency was removed and the code for the RF69CW went into the sketch. There is<br />
a comment in the code about problems with the power supply of the Arduino when the voltage drops below<br />
230V:</p>
<pre>
RF OUTPUT POWER (RFM69CW Only):

At line 663, the output power is set. When powered via the AC adapter only, the
output power is limited and depends on the minimum supply voltage. The 
following is a rough guide. If correct operation is impossible (i.e. the emonTx 
continually resets) then an external 5 V supply must be used.


Min supply voltage  maximum power
  235 V              -4 dBm (0x8E)
  230 V             -10 dBm (0x88)
 
Reducing the output power below -10 dBm has very little effect on
the minimum supply voltage.</pre><p>(The correct line number is currently 675.) We had nine EmonTx V3.4 running for several weeks without problems, but with the new software they all lock up as soon as the mains voltage goes below 230V.</p>
<p>My question is:</p>
<p>Is there a way to &#39;tune&#39; the settings of the RF-module so it will keep running ? It should be possible since up to v0.3 it did.</p>
<p>I&#39;d be very happy if someone could help me. The new code is a lot different (and smaller and nicer) than the RF-part of the jeelib and I can&#39;t really figure out where/what to look for...</p>
<p>Thanks and cheers from Berlin,</p>
<p>David</p>
<p>&nbsp;</p>
<p><em>Edit - wrapped long lines - BT</em></p>
  <div class="forum-topic-navigation clear-block">
          <a href="4007.html" class="topic-previous" title="Go to previous forum topic">‹ EmonTx Shield V2 compatible with Arduino Mega?</a>
              <a href="10199.html" class="topic-next" title="Go to next forum topic">emonTH - is there going to be a rfm69 version ? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-34461"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 24/09/2015 - 22:04.</div>
    <div class="content">
     <p><i>" The new code is a lot different (and smaller and nicer) than the RF-part of the jeelib "</i></p>
<p>That's actually not true - the code is almost exactly the JeeLib code, it just has only the necessary transmit parts included.</p>
<p>The problem with the voltage dropping is only distantly linked to the RFM69CW settings, it is that, at full power, the module draws a lot more current than the RFM12B for which the internal power supply was designed. The result is, the regulator fails as the module transmits and the 3.3 V rail collapses. Note that any connected peripherals (e.g. temperature sensors) will affect the point at which the voltage collapses.</p>
<p>I presume you are not using a separate 5 V supply, so the only effective 'tuning' you can do is reduce the rf power to the minimum necessary for communication, though you could try not using the on-board LED.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34463"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8741.jpg" alt="David Eitzinger&#039;s picture" title="David Eitzinger&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/8741.html" title="View user profile.">David Eitzinger</a> on Thu, 24/09/2015 - 22:41.</div>
    <div class="content">
     <p>You wrote that below PaLevel = 0x88 there would be next to no change but I&#39;ll give it a try. Do you know what the &#39;original&#39; setting in pre v3.0 was ? - I&#39;m wondering since that setting seems to work fine below 230V.</p>
<p>I also found this post: <a href="http://openenergymonitor.blogspot.de/2015/02/rfm69cw-power-consumption.html" title="http://openenergymonitor.blogspot.de/2015/02/rfm69cw-power-consumption.html">http://openenergymonitor.blogspot.de/2015/02/rfm69cw-power-consumption.html</a> actually showing not that much difference in power consumption. This really confuses me....</p>
<p>Well. I&#39;ll do a few tests over the weekend. Thanks for your quick reply !</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34464"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 24/09/2015 - 23:01.</div>
    <div class="content">
     <p><i>"Do you know what the 'original' setting in pre v3.0 was ?"</i></p>
<p>Not from memory, you need to look at the JeeLib source code for that. The default value (which I think is used as I can't see it being set in JeeLib), is</p>
<pre>
RegPaLevel            Default Value
(0x11) 
Bit 7 Pa0On *     rw    1          Enables PA0, connected to RFIO and LNA
6     Pa1On *     rw    0          Enables PA1, on PA_BOOST pin
5     Pa2On *     rw    0          Enables PA2, on PA_BOOST pin
4-0   OutputPower rw  11111        Output power setting, with 1 dB steps
                                   Pout = -18 + OutputPower [dBm] , with PA0
</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34475"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7218.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="emjay&#039;s picture" title="emjay&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/7218.html" title="View user profile.">emjay</a> on Fri, 25/09/2015 - 06:46.</div>
    <div class="content">
     <p>Confirmed - the JeeLib default setting for&nbsp;RegPaLevel (0x11) is the POR default&nbsp; (PA0 on, max power).</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34477"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 25/09/2015 - 06:55.</div>
    <div class="content">
     <p><em>&nbsp;you could try not using the on-board LED.</em></p>
<p>You can get some other very easy to achieve power saving by&nbsp;disabling&nbsp;the digital input buffer on all your analog inputs (see the DIDRn register in the datasheet for your particular CPU) and ensure pull-ups are enabled on all unused inputs.</p>
<p>On a 16MHz 5V 2560, I see about an 800uA saving per analog input by setting the appropriate bit in the DIDRn register, and a saving of about 20mA by enabling all pull-ups when no I/O pins are terminated (the 2560 has a lot of I/O pins!).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34484"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 25/09/2015 - 10:51.</div>
    <div class="content">
     <p>I'll look at that. I remembered that you'd mentioned this before, but I couldn't find it. It won't make a lot of difference on the 328P, but anything will help.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34499"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 26/09/2015 - 02:26.</div>
    <div class="content">
     <p>If I&#39;m reading the correct schematic and the correct datasheet, I think it should be as simple as putting:</p>
<p>&nbsp; DIDR0 = 0x1f; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Disable digital input buffer ADC0,ADC1,ADC2,ADC3,ADC4</p>
<p>in setup(). &nbsp; You&#39;ll notice the biggest savings while the inputs are all at Vcc/2 (which is how I measured my 800uA above).</p>
<p>The standard Arduino documentation covers how to enable pull-ups...</p>
<p><a href="https://www.arduino.cc/en/Reference/PinMode">https://www.arduino.cc/en/Reference/PinMode</a></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34505"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 26/09/2015 - 09:14.</div>
    <div class="content">
     <p>I'd already done that (and DIDR1) and it compiled OK, but I'm running a soak test on my V3.4 so I can't prove it just yet.</p>
<p>It might still be worth checking the timing of the LED pulse and putting a switch to disable it if needs be.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34510"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8741.jpg" alt="David Eitzinger&#039;s picture" title="David Eitzinger&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/8741.html" title="View user profile.">David Eitzinger</a> on Sat, 26/09/2015 - 12:52.</div>
    <div class="content">
     <p>Thanks for all the tips, I&#39;ll be trying one after the other...</p>
<p>The problem I have now:</p>
<p>I&#39;ve put a toaster, an old laserprinter and an electric bbq to one outlet and let the voltage drop from 237V (when idle) to 222V (@ 3343W). But the EmonTx won&#39;t lock up. Not even when I put the max. setting for the RegPaLevel (0x92). I&#39;ve also modified the code to turn the led on WHILE transmitting. But still - no lockup. I don&#39;t understand it. It&#39;s a similar EmonTx V3.4.1 with the same wall plug, antenna,&nbsp;RF-module and firmware. *rrr*</p>
<pre>
RegPaLevel            Default Value
(0x11)
Bit 7 Pa0On *     rw       1       Enables PA0, connected to RFIO and LNA
    6 Pa1On *     rw       0       Enables PA1, on PA_BOOST pin
    5 Pa2On *     rw       0       Enables PA2, on PA_BOOST pin
  4-0 OutputPower rw   11111       Output power setting, with 1 dB steps
                                   Pout = -18 + OutputPower [dBm] , with PA0
</pre><p>My conclusions:</p>
<ul>
<li>Jeelib&#39;s default value of 0x11 (00010001) gives: Pa0-2: off. -&gt; -18dBm + 17dBm = -1dBm</li>
<li>The current default value of 0x90 (10010000) gives: Pa0: 0n&nbsp; -&gt; -18dBm + 13dBm (Pa0) + 16dBm = 11dBm</li>
<li>The comment in the sketch says: &quot;RegPaLevel = 0x9F = PA0 on, +13 dBm -- RFM12B equivalent: 0x99 | 0x88 (-10dBm)&quot;. I would say: 0x9F = illegal. max. value: 0x92 = +13dBm, 0x88 = 3dBm.</li>
</ul>
<p>I don&#39;t know where to go from here. I guess during the next days I will have to drive to the problematic setup and hope that I can debug/reproduce the problem there, prepared with a custom sketch and all power-saving options enabled....</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34511"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 26/09/2015 - 14:21.</div>
    <div class="content">
     <p>I understand it perfectly. We have a name for it in English. It is the Law of Natural Perversity. </p>
<p>Simply put, it means that it only bites you when you are looking the other way!</p>
<p><i>"It's a similar EmonTx V3.4.1"</i></p>
<p>But not <i>the same</i> emonTx? I think you are looking a component tolerances if that is the case - one has either a worst-case set of components or very nearly, the other one doesn't. And I include the ac adapter in the set of components that affect this. If possible, I suggest you swap emonTx's and adapters so that you have the problem pair at home.</p>
<p>I think you have misread the Hope Electronic default value - 0x11 is the register <u>number</u> for RegPaLevel. The default value is 10011111 = 0x9F which is the maximum power of -18 + 31 = +13 dBm as Page 1 of the data sheet states.<br />
JeeLib does not change the default, so it too defaults to +13 dBm.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-34513"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8741.jpg" alt="David Eitzinger&#039;s picture" title="David Eitzinger&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonTx hang with 3-Phase firmware and <230V</h3>

    <div class="submitted">Submitted by <a href="../user/8741.html" title="View user profile.">David Eitzinger</a> on Sat, 26/09/2015 - 15:05.</div>
    <div class="content">
     <p>Whoa, I mis-interpreted the datasheet in every way possible...... So PA0 must be always on, I guess. Which gives min/max of: 0x80 to 0x9F</p>
<p>Well, I can exchange the EmonTx. - The thing is: the one I have here DID have the same problem - hanging when the line voltage drops. However now it doesn&#39;t seem to have any influence whatsoever. At the other installation we have eight (!) EmonTX V3.4.1 all showing the same symptoms: hanging, when voltage &lt;230V and sketch V0.5 but running absolutely fine with 3-Phase sketch V0.1)</p>
<p>Well... as I said, I guess there is no other chance as to go there and try to solve the mystery by testing/debugging/...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11300"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-Wlt3B4EmMyZKnVIEaUjkH5d4j1mlRxYiegTpfnrgeH0" value="form-Wlt3B4EmMyZKnVIEaUjkH5d4j1mlRxYiegTpfnrgeH0"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
