<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10833 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:46:59 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Calculating Wh totals in the discrete sampling sketch | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Calculating Wh totals in the discrete sampling sketch</h3>
        <span class="submitted">Submitted by <a href="../user/5027.html" title="View user profile.">Eric_AMANN</a> on Wed, 10/06/2015 - 07:21</span>
        <div class="content"><p>Hi,</p>
<p>When using the main sketch (emonTx_DiscreteSampling), energy must be calculated on emoncms using the &quot;Power to Kwh&quot; processor input. As explained <a href="3995.html">here</a>, it can cause large errors (RF packet lost, internet connection down, emoncms down , ...).</p>
<p>So, I would like to modify this sketch in order to calculate the total accumulated wh on-board the TX. Correct me if I&#39;m wrong but it must not be very difficult. One just needs to measure the time elapsed since the last sent and then add the corresponding energy (power x time-elapsed).</p>
<p>My first concern is that it seems so simple to me at first sight ... Am I missing something ? Has anybody already wrote such a sketch ?</p>
<p>Another concern :<br />
Will it still be possible to catch interrupts (pulse counting) with the same sketch ? If there is a high number of pulses, it may be difficult to measure the time elapsed since the last sent ?</p>
<p>Thank&#39;s for your help.</p>
<p>Eric</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10856.html" class="topic-previous" title="Go to previous forum topic">‹ senda data to Emoncms</a>
              <a href="10718.html" class="topic-next" title="Go to next forum topic">Problems with input to local Raspberry Pi from Yoctopuce VirtualHub ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-31150"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating Wh totals in the discrete sampling sketch</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Wed, 10/06/2015 - 10:16.</div>
    <div class="content">
     <p>Hello Eric, your not missing anything, it would be good to add this to the discrete sampling sketch. The frequency of pulse counting is usually quite slow and the time request to process an interrupt relatively short, I dont think it would affect the time elapsed significantly but I haven&#39;t tested it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31155"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5027.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Eric_AMANN&#039;s picture" title="Eric_AMANN&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating Wh totals in the discrete sampling sketch</h3>

    <div class="submitted">Submitted by <a href="../user/5027.html" title="View user profile.">Eric_AMANN</a> on Wed, 10/06/2015 - 11:02.</div>
    <div class="content">
     <p>Hi,</p>
<p>Ok , it will try to implement that. There is a real need.</p>
<p>The frequency of pulse counting can easily reach 10 Hz on buildings I&#39;m monitoring (36 kW + 1 pulse/1Wh = 10 pulses/second). I have no idea about the time request to process an interrupt (the ISR is quite short), but one can assume that it may affect significantly the time elapsed between two sent.&nbsp; Any opinion on that point ?</p>
<p>Correct me if I am wrong but one can&#39;t measure the exact elapsed time between two sent with millis() or micros() because these functions are not incrementing during an ISR.</p>
<p>So the solution would be to set up a timer interrupt to calculate kWh and send data at very precise rate. But I don&#39;t know if timer interrupt and pulse interrupt can coexist in the same sketch. I don&#39;t know either how to make the emontx sleep at low-power between two sent.</p>
<p>Some inputs ?</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31294"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5027.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Eric_AMANN&#039;s picture" title="Eric_AMANN&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating Wh totals in the discrete sampling sketch</h3>

    <div class="submitted">Submitted by <a href="../user/5027.html" title="View user profile.">Eric_AMANN</a> on Mon, 15/06/2015 - 07:53.</div>
    <div class="content">
     <p>Hi,</p>
<p>Finally, I added the Wh totals calculation in&nbsp; the emonTxV3_2_DiscreteSampling sketch (sorry, I have no TX3.4) simply by measuring the exact elapsed time between two calculation with millis().</p>
<p>First, I modified the emonTX payload :</p>
<pre>
typedef struct {
int power1;
int  power2;
int   power3;
int   power4;
int   Vrms;
int   temp;
float wh1;
float wh2;
float wh3;
float wh4;
} PayloadTX;     // create structure - a neat way of packaging data for RF comms
  PayloadTX emontx; </pre><p>Before calculating power and energy, it measures the time since the last calculation</p>
<pre>
 lastTime = calcTime;        //used to measure time between Wh calculation.
 calcTime = millis();
 elapsedTime = calcTime-lastTime;
 if (debug==1)  {Serial.print(elapsedTime);Serial.print(&quot;  &quot;);}</pre><p>Then it calculates the totals Wh just before updating the power like this :</p>
<pre>
ct1.calcVI(no_of_half_wavelengths,timeout);
emontx.wh1+=((ct1.realPower+emontx.power1)/2*elapsedTime/1000/3600);
emontx.power1=ct1.realPower;</pre><p>As I will not try to catch interrupt with the same TX, nor try to measure temperature, it should work fine.</p>
<p>&nbsp;</p>
<p>Doing that, I noticed that the real time between two sent is 11,2 seconds + few ms whereas the constant TIME_BETWEEN_READINGS was 10. When logging data every 10s in emoncms, many data are lost (10%). It can be problematic when using some process/grah</p>
<p>200 ms are &quot;lost&quot; here :</p>
<pre>
 delay(TIME_BETWEEN_READINGS*1000);
 digitalWrite(LEDpin, HIGH);
 delay(200);
 digitalWrite(LEDpin, LOW);    // flash LED - turn off to save power</pre><p>One second is lost anywhere else (during the sampling ?)</p>
<p>So, I made some modification to get a time between two sent equal to 10s + few ms.</p>
<p>A good solution would be to set up a timer interrupt to calculate kWh and send data at very precise rate. Will it work with pulse counting or temperature sensing ? I will have a look on that later.</p>
<p>Eric</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31298"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calculating Wh totals in the discrete sampling sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 15/06/2015 - 11:35.</div>
    <div class="content">
     <p>Eric, </p>
<p>TIME_BETWEEN_READINGS is actually the delay while the processor sleeps in low power mode (as you've discovered). The extra time is that taken to make the readings (200 ms per CT) plus the time to calculate the averages and process the result, get the temperature (if required), print the results to serial (if you're doing that) and to send the data.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10833"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-MyicnGIHLCqsPhqPql1qyLOoFHPrE1-_6yzfsurRPwU" value="form-MyicnGIHLCqsPhqPql1qyLOoFHPrE1-_6yzfsurRPwU"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
