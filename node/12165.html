<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Low-power sketch for reed switch pulse counting on EmonTH | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/emon/sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="/emon/modules/node/node.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/system/defaults.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/system/system.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/system/system-menus.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/user/user.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/sites/all/modules/mollom/mollom.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/forum/forum.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/sites/all/modules/views/css/views.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/comment/comment.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/sites/all/themes/emon3/style.css?r" />
<style type="text/css" media="all">@import "/emon/sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="/emon/" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="/emon/">Home</a> » <a href="/emon/forum">Forums</a> » <a href="/emon/forum/5">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Low-power sketch for reed switch pulse counting on EmonTH</h3>
        <span class="submitted">Submitted by <a href="/emon/user/5027" title="View user profile.">Eric_AMANN</a> on Fri, 12/02/2016 - 14:21</span>
        <div class="content"><p>Hi,</p>
<p>I wrote a new low-power sketch for EmonTH V1.4 that counts pulses from a reed switch. This is adapted from code written by Robert Wall <a href="http://openenergymonitor.org/emon/sites/default/files/emonTxV3_RFM12B_DiscreteSampling_with_pulse_0.ino">here</a>.</p>
<p>I like it because it allows me to debounce the circuit, send the pulse count periodically, and extend battery life. After a month of operation on my gas meter, no pulse lost and the battery voltage didn&#39;t change at all.</p>
<p>It requires that your meter is equipped with a reed switch that does not switch too fast. How does it work? The EmonTH sleeps all the time and wakes up every 0.5s in order to poll the state of the input. When catching the sequence 00001111, it detects a rising edge. The total number of pulses is sent every minute.</p>
<p>It means that either the &#39;on&#39; time or the &#39;off&#39; time of the pulse exceeds 4*0.5=2s. This is the case with my gas counter. You can easily change the polling period (500ms) to manage different pulse rates for other water meters, gas meters, etc.</p>
<p>This sketch may be easily modified to work on EmonTH V1.5 and also send the temperature/humidity every minute.</p>
<p>Eric</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="/emon/node/12303" class="topic-previous" title="Go to previous forum topic">‹ Sending control data to nodes</a>
              <a href="/emon/node/12297" class="topic-next" title="Go to next forum topic">Using emonhub &quot;scales&quot; as a quick and dirty calibration? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-39490"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5694" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-5694.jpg" alt="Patrice Diliakou&#039;s picture" title="Patrice Diliakou&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5694" title="View user profile.">Patrice Diliakou</a> on Wed, 17/02/2016 - 12:47.</div>
    <div class="content">
     <p>Thank you !</p>
<p>I&#39;ll test it soon ;)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39751"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5694" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-5694.jpg" alt="Patrice Diliakou&#039;s picture" title="Patrice Diliakou&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5694" title="View user profile.">Patrice Diliakou</a> on Wed, 24/02/2016 - 18:38.</div>
    <div class="content">
     <p>Hello,</p>
<p>No result.</p>
<p>It transmit at start the battery power and nothing after. The total blackout...</p>
<p>I puted a pulldown between 3 and 4, tried the other wire to 2, 5 or 6 : no response.</p>
<p>I am beginning to think that my emonth is broken...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39752"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/924" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/924" title="View user profile.">Robert Wall</a> on Wed, 24/02/2016 - 19:09.</div>
    <div class="content">
     <p>What is your emonTH, V1.4 or V1.5?&nbsp;</p>
<p>The pulse input is D2 on the V1.4, D3 on the V1.5 - so you might need to change &quot;const int PULSEPIN=2;&quot;</p>
<p>[ERIC: You need to add that in a comment.]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39778"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5694" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-5694.jpg" alt="Patrice Diliakou&#039;s picture" title="Patrice Diliakou&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5694" title="View user profile.">Patrice Diliakou</a> on Thu, 25/02/2016 - 11:51.</div>
    <div class="content">
     <p>Hello,</p>
<p>Sorry, i precised it on another thread. It is V1.4.</p>
<p>Connecting my reed is not clear. Where connect it ?</p>
<p>I use a pull-down resistor between pin 4 and ground to fix 0v when no working on reed.</p>
<p>I tried to connect other wire to 3v to send 3v to pin 4 when sollicited.(pin 1).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39795"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/924" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/924" title="View user profile.">Robert Wall</a> on Thu, 25/02/2016 - 13:53.</div>
    <div class="content">
     <p><em>&quot;Sorry, i precised it on another thread. It is V1.4.&quot;</em></p>
<p>That is what happens when you cross-post. Please do not do that, it wastes everyone&#39;s time. You cannot expect anyone to remember a post from 2+&nbsp;weeks ago on another thread<em>.</em></p>
<p><em style="line-height: 1.6;">&quot;Connecting my reed is not clear. Where connect it ?&quot;</em></p>
<p>Look at the circuit diagram - you will find it in the Wiki. You will see Pin 4, the pulse input, has provision for a pull-down resistor to GND. Therefore you connect your reed switch between Pin 4 and 3.3 V, which is Pin 2. If no resistor (R2) is fitted on yours (it is underneath the battery holder), use an external 10&nbsp;k&Omega; resistor between Pin 4 and Pin 3.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39811"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5694" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-5694.jpg" alt="Patrice Diliakou&#039;s picture" title="Patrice Diliakou&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5694" title="View user profile.">Patrice Diliakou</a> on Thu, 25/02/2016 - 18:22.</div>
    <div class="content">
     <p>It wasn&#39;t a cross-post but an other sketch from Eric :) So i missed to precise it on this one.</p>
<p>Otherwise, thank you for your answer. It confirm my situation : My Emonth doesn&#39;t work. For the pull down i didn&#39;t put it behind battery pack yet because i wanted to test it before.</p>
<p>You confirm my 3.3V&nbsp; use for it. So, Dig2 is protected and can accept 3v load. I wasn&#39;t sure and i supposed that i fused it.</p>
<p>I will make other tests, before to decide to trash it... and buy an other one. I think this one is broken. No transmission after first start and first battery value sent.</p>
<p>&nbsp;</p>
<p>Thank you.</p>
<p>Changed JeeLib libraries because i had old one (2014) No way.</p>
<p>Tried to resold weldings : no way. (electronic lab fully equiped)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39820"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/924" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/924" title="View user profile.">Robert Wall</a> on Thu, 25/02/2016 - 20:19.</div>
    <div class="content">
     <p>If you have a programmer, you can try a simple sketch:</p>
<pre>

#include &lt;JeeLib.h&gt;

void setup()
{
  pinMode(9, OUTPUT); digitalWrite(9,HIGH);   
  delay(10000);
  digitalWrite(9,LOW); 
}

void loop() 
{
  digitalWrite(9, digitalRead(2));
}</pre><p>With your reed switch and pull-down resistor connected, the LED should come ON for 10 s, after that it should come on when the magnet is near the reed switch, and it should go off when the magnet is away from the reed switch.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39872"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5694" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-5694.jpg" alt="Patrice Diliakou&#039;s picture" title="Patrice Diliakou&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5694" title="View user profile.">Patrice Diliakou</a> on Fri, 26/02/2016 - 22:34.</div>
    <div class="content">
     <p>Thank you, i test it now.</p>
<p>&nbsp;</p>
<p>EDIT :</p>
<p>Working well !</p>
<p>So my connection is good.</p>
<p>Will try to understand sketch programmation... :)</p>
<p>EDIT2 :</p>
<p>Well...</p>
<p>Nothing. No reaction. No back to console too.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39901"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/924" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/924" title="View user profile.">Robert Wall</a> on Sat, 27/02/2016 - 19:09.</div>
    <div class="content">
     <p>So, the problem is either the sketch is not working as it should, or your reed switch is &quot;bouncing&quot; so much that the sketch cannot recognise the transition from 0 to 1.</p>
<p>The main loop runs and then sleeps for 500 ms. Every time, that is every 500 ms, it reads the switch. The last 8 switch states are recorded in the bits in a byte, and when you have 00001111 (0x0F), you have detected the switch closing.&nbsp; If you have a really bad switch, it might be bouncing for a long time. But it should not bounce for more than 500 ms, and the switch must remain in each state long enough to give that bit pattern. i.e. it must be in each state for at least 2 s.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39955"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5694" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-5694.jpg" alt="Patrice Diliakou&#039;s picture" title="Patrice Diliakou&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5694" title="View user profile.">Patrice Diliakou</a> on Mon, 29/02/2016 - 14:09.</div>
    <div class="content">
     <p>Thank you for your precisions.</p>
<p>Are my fingers and a peace of wire can generate boucing phenomen ?</p>
<p>Ill will try to modify some parameters to taste more things?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39976"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/924" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/924" title="View user profile.">Robert Wall</a> on Mon, 29/02/2016 - 20:52.</div>
    <div class="content">
     <p>Yes, a piece of wire or a very cheap switch are both very good ways to get contact bounce. Using the &#39;interrupt-driven&#39; pulse sketch, I could see anything up to about 40 pulses with pressing the button once only.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40091"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5694" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-5694.jpg" alt="Patrice Diliakou&#039;s picture" title="Patrice Diliakou&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5694" title="View user profile.">Patrice Diliakou</a> on Thu, 03/03/2016 - 21:31.</div>
    <div class="content">
     <p>Thank you for the precisions.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40104"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/5027" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Eric_AMANN&#039;s picture" title="Eric_AMANN&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/5027" title="View user profile.">Eric_AMANN</a> on Fri, 04/03/2016 - 14:18.</div>
    <div class="content">
     <p>Hi,</p>
<p>Attached is a new version of the sketch described above but for <strong>EmonTH V1.5</strong>.</p>
<p>It also sends the temperature/humidity every minute. It&#39;s derived from the emonTH_DHT22_DS18B20_RFM69CW sketch (V1.6.1).</p>
<p>NB : When reading temperature and humidity with the DHT22, one pulse may be ignored because this sensor is very slow (2s).The DS18B20 sensor which is faster (375ms) is less problematic</p>
<p>Eric</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40110"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/10" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Low-power sketch for reed switch pulse counting on EmonTH</h3>

    <div class="submitted">Submitted by <a href="/emon/user/10" title="View user profile.">glyn.hudson</a> on Fri, 04/03/2016 - 17:15.</div>
    <div class="content">
     <p>Thanks, example has been pushed to github</p>
<p><a href="https://github.com/openenergymonitor/emonTH/commit/4ae519baecd59627ffdbcc0b8d5223747a4928d3" title="https://github.com/openenergymonitor/emonTH/commit/4ae519baecd59627ffdbcc0b8d5223747a4928d3">https://github.com/openenergymonitor/emonTH/commit/4ae519baecd59627ffdbc...</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="/emon/node/12165"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-gSDeNtX7WvXJVfgzG13i38bYJ5H-b3f1UrjawTbAO5k" value="form-gSDeNtX7WvXJVfgzG13i38bYJ5H-b3f1UrjawTbAO5k"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org">https://community.openenergymonitor.org</a></p>
   
</div>

<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
