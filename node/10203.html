<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10203 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:42:23 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Using an emonTx V3.4 as a Mk2 PV Router | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Using an emonTx V3.4 as a Mk2 PV Router</h3>
        <span class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 20/02/2015 - 19:28</span>
        <div class="content"><p>A few days ago, I posted a Mk2 Router sketch for use with the emonTx V3.2.&nbsp; The V3.2 platform has the RFu sub-assembly which includes both the Atmel processor and an RFM12B RF module.&nbsp;</p>
<p>This latest version of the Mk2 Router sketch is for use on the emonTx V3.4 platform.&nbsp; The V3.4 platform has the Atmel processor mounted directly on the PCB along with the more powerful RFM69CW RF module.</p>
<p>Much of the description for the V3.2-based application at <a href="10171.html">http://openenergymonitor.org/emon/node/10171</a> is also relevant to this later thread.&nbsp; Only the differences between these two applications are described here.</p>
<p><u>Hardware</u></p>
<p>Because the RFM69CW takes more power when in the active state, the V3.4 platform is unable to drive an output stage without an additional DC supply being provided.&nbsp; This can be either via the USB power connection, or via the Serial port.</p>
<p>When the additional source of DC power is available, there is no need to use the low power output stage as described for the emonTx V3 at <a href="https://learn.openenergymonitor.org?redirect=mk2/build">building a Mk2 PV Router</a> .&nbsp; The standard circuit, as shown for the emonTx V2, will be fine.</p>
<p><u>Software</u></p>
<p>Because the two RF modules use different libraries, the sketch for the V3.4 platform needs to #include &lt;Jeelib.h&gt; rather than &lt;RFu_Jeelib.h&gt;.&nbsp; Also, the line #define RF_COMPAT 1 needs to be included.</p>
<p>Because the two RF libraries use different port allocations, element 4 of the terminal strip is Digital 3 for the V3.4 platform rather than Digital 2.&nbsp; This alternative allocation needs to be made near the start of the sketch.</p>
<p><u>Testing</u></p>
<p>A similar test sequence has been run for the V3.4 platform as for the V3.2 one.&nbsp; A full description of the test sequence may be found in the attached results file.&nbsp; Towards the end of the file, the additional source of 5V DC was removed, and the processor can be seen to reset repeatedly.</p>
<p>Although a programming board was present via the Serial port, the two power lines were not connected.&nbsp; This can hopefully be seen in one of the photos.</p>
<p><u>General</u></p>
<p>As with all of my &quot;Mk2&quot; code, this sketch measures continuously.&nbsp; If the Router&#39;s functionality is not required, this sketch can be used on the emonTx V3.4 as a simple continuous monitor for real power, temperature and RMS voltage.&nbsp; In this case, no additional DC supply would be needed.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10567.html" class="topic-previous" title="Go to previous forum topic">‹ Enecsys Micoinverter Monitoring system  Proposal</a>
              <a href="12123.html" class="topic-next" title="Go to next forum topic">A sensor recommendation for a water meter dial ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-28013"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 21/02/2015 - 13:53.</div>
    <div class="content">
     <p>In the post above, Robin states:<br />
<i>"If the Router's functionality is not required, this sketch can be used on the emonTx V3.4 as a simple continuous monitor for real power, temperature and RMS voltage.  In this case, no additional DC supply would be needed."</i></p>
<p>Having quickly looked at the power supply calculations for the emonTx V3, that might not be true over the full range of possible supply voltages, especially if some or all of the power supply components are at the "worst case" end of their manufacturing tolerances.</p>
<p>If difficulties are experienced, it might be possible to alleviate them and restore correct operation by reducing the current consumption of the RFM69CW module. This can be done by turning down the transmitter power. If that is not acceptable, then an independent 5 V supply of adequate rating should be provided.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28362"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Tue, 03/03/2015 - 19:24.</div>
    <div class="content">
     <p>When using emonTx&nbsp;V3.4 as a Mk2 Router is it safe to use the high sensitivity&nbsp;CT4 to measure grid current when this input should not exceed 4.5kw.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28366"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 03/03/2015 - 22:23.</div>
    <div class="content">
     <p>The rating of Input 4 depends on your system voltage. It is only 4.5 kW on a 240 V supply, or a fraction over 19 A given a good sine wave. (If your current wave is 'peaky', the maximum rms current could be significantly less.) You are unlikely to damage either the CT or the input of the emonTx if the current exceeds this, but once the input clips, all accuracy has gone.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28372"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 03/03/2015 - 22:58.</div>
    <div class="content">
     <p><em>is it safe to use the high sensitivity&nbsp;CT4 to measure grid current when this input should not exceed 4.5kw.</em></p>
<p>As I understand it, the 4.5 kW value is determined by the value of the burden resistor with is fitted to the CT4 channel as standard (120 ohms).&nbsp; I assembled a 3.3V board of my own today with that same value of burden resistor and found that the maximum input range was approx 4.8 kW.&nbsp; Via an extension lead, my 2kW heater could well be taking less power than its rated value, so maybe the true maximum is closer to 4.5 kW as printed on the emonTx V3.4</p>
<p>For the purpose of diverting surplus power, the sensitivity of the &#39;grid&#39; sensor should be as high as possible.&nbsp; If whole house consumption is also required, it may be best to use one of the other channels for this.&nbsp; With its higher-valued burden, CT4 would provide accurate measurements for diversion purposes, while the 22R channel would given less accurate data over a wider range for datalogging.&nbsp;</p>
<p>For my own diverter units, I fit a pair of 1N4007 protection diodes at the processor&#39;s input, but these may not be necessary.&nbsp; For much of the last year, a standard emonTx V2 has been doing sterling service in our garage, with nothing to supplement the processor&#39;s internal protection.&nbsp; When our 8kW electric shower is turned on, the signal that the ADC sees will just be a max-amplitude square wave.&nbsp; No harm has ever befallen the system, it always recovers in true Tom &amp; Jerry style.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28374"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 04/03/2015 - 01:28.</div>
    <div class="content">
     <p><em>For my own diverter units, I fit a pair of 1N4007 protection diodes at the processor&#39;s input,</em></p>
<p>By the time they switch on, it may be too late for the internal diodes. &nbsp;The internal diodes clamp at Vcc+0.5V and GND-0.5V and&nbsp;are good for about 1mA. &nbsp;I think the later emonTxs use a&nbsp;1K series resistor for protection.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28379"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 04/03/2015 - 10:37.</div>
    <div class="content">
     <p>Yes, the V3.4 does have a series 1 k&Omega; resistor for exactly this reason, and the internal diodes are good for a lot more than 1 mA - 20 mA from memory, without looking at the data sheet. The 100 A YHDC has internal zeners that clip at about 23 V, so whilst not totally bullet-proof, the input should survive most abuse thrown at it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28380"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Wed, 04/03/2015 - 11:25.</div>
    <div class="content">
     <p>Thanks for your reply.&nbsp;I have 240v (sometimes higher)&nbsp; supply, My concern is overloading the 120R&nbsp;burden. OpenEneryMonitor-Wiki calculations say the max power the 120R burden will need to dissipate is 867mW ?. I think a 0.25W resistor has been used.&nbsp;&nbsp;&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28381"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 04/03/2015 - 11:27.</div>
    <div class="content">
     <p><em>and the internal diodes are good for a lot more than 1 mA - 20 mA from memory, without looking at the data sheet.&nbsp;</em></p>
<p>I&#39;ve never been able to find that in the datasheet. &nbsp;Do you know what it&#39;s listed as? &nbsp; The source for my 1mA&nbsp;number is&nbsp;AVR182, which states:</p>
<p><strong>...&nbsp;&nbsp;It is not recommended that the clamping&nbsp;diodes are conducting more than maximum 1 mA... &nbsp;The clamping&nbsp;diodes are able to handle spikes for a short period of time but not surges. The application note will not go into how to protect against surges, but simply recommend&nbsp;implementing protection against surges in the design.</strong></p>
<p>I guess the fact that it&#39;s an AC signal helps with the &quot;short period of time&quot;. &nbsp;It&#39;s at least going to go to zero every 10 msecs, &nbsp;but that application note is written with an AC signal in mind.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28384"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 04/03/2015 - 16:23.</div>
    <div class="content">
     <p><em>My concern is overloading the 120R&nbsp;burden. OpenEneryMonitor-Wiki calculations say the max power the 120R burden will need to dissipate is 867mW ?. I think a 0.25W resistor has been used.&nbsp;</em></p>
<p>The standard CT has a turns ratio of 2000, so if 100A is flowing in the primary there will be 50mA in the secondary.&nbsp; When flowing through a 120R burden, I think this will dissipate 0.3 Watts.&nbsp; I normally fit a 0.25W 150R burden, so it would indeed be overloaded under such continuous conditions.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28386"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 04/03/2015 - 16:59.</div>
    <div class="content">
     <p><i>"I've never been able to find that in the datasheet.  Do you know what it's listed as?"</i><br />
Section 28.1 Absolute maximum ratings. And it's 40 mA, not 20.</p>
<p>The note says "Exposure to absolute maximum rating conditions for extended periods may affect device reliability." [Translation: It cooks.] but as the measurement is meaningless when this is happening, I don't see that as a significant limitation.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28394"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Wed, 04/03/2015 - 19:29.</div>
    <div class="content">
     <p>Design calculations for CT bias resistors can be found at:-</p>
<p><a href="http://wiki.openenergymonitor.org/index.php?title=EmonTx_V3#Flashing_Pre-compiled_.hex" title="http://wiki.openenergymonitor.org/index.php?title=EmonTx_V3#Flashing_Pre-compiled_.hex">http://wiki.openenergymonitor.org/index.php?title=EmonTx_V3#Flashing_Pre...</a></p>
<p>If CT-1 is used instead of CT-4, can calipso-rae&#39;s&nbsp;excellent&nbsp;sketch still be used&nbsp;by just&nbsp;changing the allocation of analog&nbsp;pins.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28398"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 04/03/2015 - 22:08.</div>
    <div class="content">
     <p><em>Section 28.1 Absolute maximum ratings. And it&#39;s 40 mA, not 20.</em></p>
<p>I think that&#39;s an entirely different parameter from what we&#39;re discussing here. &nbsp;That 40mA is the absolute limit on how much current you can suck while it&#39;s trying to maintain a &#39;1&#39; on the output, or how much it can sink while it&#39;s trying to maintain a &#39;0&#39;. &nbsp;That pathway doesn&#39;t involve the internal protection diodes at all, but rather the very beefy GPIO drivers. &nbsp;The only contribution to the discussion I can find in the datasheet is max Voltage on any pin: &nbsp;Vcc+0.5V.</p>
<p>AVR182 leaks out a bit more detail by telling you to never exceed 1mA through those protection diodes (spikes above that are ok, surges are not). &nbsp; Something like the attached might do what you need. &nbsp;By the time 1mA is flowing through one of their internal protection diodes (perfectly legal according to AVR182), there&#39;ll be a full volt across the 1K series resistor, which should be enough to turn on those beefy external diodes well in advance of trouble.</p>
<p><img alt="" src="../sites/default/files/protection.jpg" style="height:233px; width:400px" /></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28400"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 04/03/2015 - 23:10.</div>
    <div class="content">
     <p><i>"I think that's an entirely different parameter from what we're discussing here.  That 40mA is the absolute limit on how much current you can suck while it's trying to maintain a '1' on the output, or how much it can sink while it's trying to maintain a '0'. "</i></p>
<p>What do you make of Note 3.1: "The sum of all I/O, for ports C0 - C5, ADC7, ADC6 should not exceed 100 mA."  To me, that infers that the ADC ports are included. Either way, the data sheet is unclear. But as far as I know (and I think I can include Glyn), no-one has ever blown up an ADC input, even on the V2 that has absolutely no protection outside the processor, other than the impedance of the bias supply.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28401"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 05/03/2015 - 08:57.</div>
    <div class="content">
     <p>My guess is that they did what they always do when writing those footnotes: &nbsp;they gathered up the names of all the pins that share some internal structure (or a GND pin) and then declared that the sum of all currents through those pins must not exceed the current limits of that shared structure, without much regard for whether it was even possible for such a pin to source or sink any current. &nbsp; Those ADC6 and ADC7 pins are quite unusual for AVR devices. &nbsp; On all the AVR devices I&#39;ve used, all ADC pins can also be used a GPIO pins. &nbsp;So I can forgive them for not stopping to think that ADC6 and ADC7 weren&#39;t candidates for contributing to the total current limits in that sub-section. &nbsp;Maybe they deliberately left them in for completeness. &nbsp;Certainly their inclusion doesn&#39;t make the list wrong. &nbsp;I think your inference that because of their inclusion, you can pump 40mA down them, is fairly bold.</p>
<p><em>the data sheet is unclear</em></p>
<p>Well the one thing it is clear on is that you must never exceed Vcc+0.5V. &nbsp;It seems to me it would be very easy to calculate or measure the primary current at which that&nbsp;happens&nbsp;on various emonTx input channels, and then tell people not to exceed it... complete with the usual&nbsp;warnings about non-sinusoidal current signals, and Ipeak etc. etc.</p>
<p>Now, when it comes to what happens as you do&nbsp;approach that Vcc+0.5V limit, the only definitive data I can find from Atmel&nbsp;is AVR182, and it is pretty clear (quoted above in bold). &nbsp;I&#39;d certainly put&nbsp;more weight in&nbsp;AVR182, then I would in them&nbsp;including a couple of unusual ADC pins in a group current rule. &nbsp;I guess we could quibble over what&#39;s a spike and what&#39;s a surge, but I suspect we&#39;d all agree that if someone&#39;s ADC input is attempting to exceed Vcc+0.5V / GND-0.5V&nbsp;(and sourcing more than 1mA while it does) for a significant part of each 10msec half-cycle, for a very extended number of half-cycles,&nbsp;then it&#39;s more surge than spike, and not within the limits required by AVR182. &nbsp; You certainly don&#39;t want it banging past those limits for as long as it takes to cook your dinner.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28403"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 05/03/2015 - 09:24.</div>
    <div class="content">
     <p><em>If CT-1 is used instead of CT-4, can calipso-rae&#39;s&nbsp;excellent&nbsp;sketch still be used&nbsp;by just&nbsp;changing the allocation of analog&nbsp;pins.</em></p>
<p>With the 22R burden for CT1, the sketch will still work and the burden should never be overloaded.&nbsp; However, with such a low sensitivity, accuracy will be somewhat compromised.&nbsp; When no current is flowing in a test rig, a 22R channel can easily indicate several Watts of &#39;virtual&#39; real power because each step of the ADC is so large.&nbsp; In a real life situation, where there will always be some activity at the CT, the effects of randomization will no doubt help to reduce this source of error.</p>
<p>The prime goal of the Router is to mimic the supply meter so that it can do something useful with any surplus power before penalties are applied.&nbsp; Using the full range of the ADC seems a better approach than just the bottom tenth of it.&nbsp; But having CT1 for the grid sensor may give acceptable results too.&nbsp; Using CT4, but with an appropriately selected burden (e.g. 39R or 56R) may be the best approach of all.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28404"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Thu, 05/03/2015 - 10:59.</div>
    <div class="content">
     <p>It&#39;s a pity&nbsp;the burden&nbsp;resistors are surface mount, makes them harder to change, for me anyway,. The 4 burden resistors fitted to the board are much bigger than all the other resistors, I wonder if they have a higher power rating than the 0.25w mentioned in the calculations. I think it would be easy to add a parallel resistor to the CT4 socket pins on the&nbsp;underside of the circuit boad.&nbsp;&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28405"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Thu, 05/03/2015 - 10:59.</div>
    <div class="content">
     <p>&quot;<em>It&#39;s a pity&nbsp;the burden&nbsp;resistors are surface mount, makes them harder to change, for me anyway,&quot;</em></p>
<p>Maybe there is a another option, Because of the parallel&nbsp;through-hole burden resistor provision to fit a &quot;replacement&quot; burden if you remove the existing SMT.&nbsp;It is possible to &quot;desensitize&quot; CT4 to the same range of CT1 to CT3 by adding a 27R&nbsp;resistor in parallel to the 120R&nbsp;SMT to give you 22R.</p>
<p>This method could also be used to select a intermediate range eg adding a 200R&nbsp;in parallel&nbsp;with the 120R will give you 75R, the range of the input would be around the midpoint between CT4 and CT1&#39;s range. This will also off-load some of the heat dissipation in the process.</p>
<p>You will need to accept a value &quot;near&quot; your target due to available component values but to achieve 39R you could need around 58R, and for 56R you need around 105R</p>
<p>The calibration figures would obviously need recalculating using the actual resistor values used.</p>
<p><a href="http://www.sengpielaudio.com/calculator-paralresist.htm">http://www.sengpielaudio.com/calculator-paralresist.htm</a></p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28406"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 05/03/2015 - 11:11.</div>
    <div class="content">
     <p><i>"I think it would be easy to add a parallel resistor to the CT4 socket pins on the underside of the circuit boad. "</i></p>
<p>It's even easier to add it to the top of the board - there are holes ready for it, on all 4 channels.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28409"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 05/03/2015 - 13:51.</div>
    <div class="content">
     <p>I&#39;ve used burden values of 39R or 56R to provide a workable compromise between maximum range and acceptable sensitivity.&nbsp; The approximate range for several burden values are given on my <a href="http://mk2pvrouter.co.uk/13701.html">main PCB page</a>:</p>
<p><em>If whole-house datalogging is required, the value of R6 will need to be reduced:</em></p>
<p><em>R6 = 56R will allow measurements of up to approximately 10 kW<br />
R6 = 47R will allow measurements of up to approximately 12 kW<br />
R6 = 39R will allow measurements of up to approximately 14 kW</em></p>
<p><em>NB. These burden resister values are for when the processor is operated at 3.3 V.&nbsp; If operated at 5V, these ranges are increased by approximately 50%.&nbsp; </em></p>
<p>I&#39;ve not tried going any lower than 39R.&nbsp; With a standard type of supply meter, the Router&#39;s performance may be perfectly acceptable.&nbsp; But with a less tolerant type of meter, any inaccuracy would be likely to lead to (albeit small) cost penalties.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28425"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Fri, 06/03/2015 - 16:18.</div>
    <div class="content">
     <p>My grid fuse is 80A. With 80A flowing in the CT primary there will be 40mA&nbsp;in the secondary.this gives 0.192 Watts to be dissipated by the 120R burden. So It looks as if it can&#39;t be overloaded.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28733"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Mon, 16/03/2015 - 21:30.</div>
    <div class="content">
     <p>Diverted Power</p>
<p>If you have a load of say 2kw connected to the system, You could count the number of times the triac is fired, send this to emoncms&nbsp;and calculate the amount of power diverted.</p>
<p>eg with a 2kw load, over 250 mains cycles or 5 seconds (as used by the sketch) you get 2000/250=8&nbsp;watts&nbsp;per per trigger. If the load is on for 50% during this period then you will fire the triac&nbsp;125 times.</p>
<p>Giving&nbsp;&nbsp;125 x 8 = 1000W. diverted. in 5 sec.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28734"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 16/03/2015 - 22:28.</div>
    <div class="content">
     <p>That is the technique used by MartinR in his PLL diverter, but it fails if your load is thermostatically controlled. Then, it gives you the energy (not power) <i>available for diversion</i>, not the actual energy diverted&mdash;the discrepancy being of course the current not consumed when the thermostat is open.</p>
<p>Robin uses a second smaller ring CT to measure the actual diverted current and hence the power/energy diverted.</p>
<p>[MartinR's technique worked for him because he also measured cylinder temperature and used that to override the diversion logic, so his thermostat functioned solely as a safety backup.]</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28827"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Thu, 19/03/2015 - 19:57.</div>
    <div class="content">
     <p>Yes, I see what you mean, It&#39;s not&nbsp;easy to put a CT on my diverted power wiring but I do&nbsp;have one measuring the solar power on CT1 as well as CT4 for grid.&nbsp;I have inserted a condition in the sketch that sets the number of triggers (for data logging) to zero&nbsp;if the number of triggers =&nbsp;250 (ie full power to heater) and solar - grid &lt; 2000. (Rating of heater)&nbsp;</p>
<p>if (trigs&nbsp;== 250 &amp;&amp; sumP_CT1 - sumP_grid &lt; 2000) trigs=0;</p>
<p>That appears to work.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28843"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 20/03/2015 - 08:40.</div>
    <div class="content">
     <p><em>with a 2kw load, over 250 mains cycles or 5 seconds (as used by the sketch) you get 2000/250=8&nbsp;watts&nbsp;per per trigger. </em></p>
<p>I think you mean 2000/ 50 = 40 Joules per mains cycle, because 2000 Joules of energy are consumed every second.</p>
<p><em>If the load is on for 50% during this period then you will fire the triac&nbsp;125 times.</em></p>
<p>The triac is actually fired twice per mains cycle - once for each half - but the Mk2&#39;s logic only controls it in whole cycles.&nbsp;</p>
<p><em>Giving&nbsp;&nbsp;125 x 8 = 1000W. diverted. in 5 sec.</em></p>
<p>If the load is on for 50% of the time, then over a 5-second period, it will be active for 125 mains cycles.&nbsp; Each &#39;on&#39; cycle contributes 40 Joules, so the total energy consumed during that 5-second period will be 5000 Joules, which is 1000 J/s or 1000 Watts.&nbsp;</p>
<p>Whether your electricity meter will record (penalise) this type of consumption depends on how rapidly the load is cycled.&nbsp; In &quot;normal&quot; mode with 50% power available, the load will probably be on for two mains cycles then off for two mains cycles giving an cycle frequency of approx 12.5 Hz.&nbsp; Anti-flicker mode reduces the rate of switching but may no longer be ignored by the supply meter.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28851"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Fri, 20/03/2015 - 14:25.</div>
    <div class="content">
     <p>I haven&#39;t changed anything relating to the operation&nbsp;of the Mk2&#39;s logic that controls the triac. If the electricity meter penalises the use of Anti-flicker mode, it was doing it before I&nbsp;made changes to the sketch.</p>
<p>All I&#39;m doing is changing the data&nbsp;logging&nbsp;info. sent to emoncms.&nbsp;Sending a count of triac triggers to emoncms&nbsp;(Instead of measuring diverted power and sending it)&nbsp;and using&nbsp;it to display and record&nbsp;diverted power by multiplying&nbsp;this feed by 8.</p>
<p>When the heater cut&#39;s out on it&#39;s thermostat, this can be detected in the sketch and the value for triggers&nbsp;sent to emoncms made zero. So recording no Diverted power. The triac&nbsp;will still be being fired of course.&nbsp;&nbsp;&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28860"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 20/03/2015 - 17:18.</div>
    <div class="content">
     <p>Norman, your system for detecting that the stat has opened sounds fine to me.&nbsp; An alternative approach would be to check when the energy bucket is overflowing.&nbsp; If the bucket&#39;s level ever has to be trimmed to its maximum value (3600 Joules), that presumably means that your load is consuming no power so you can simply ignore that mains cycle for counting purposes.</p>
<p>The point of my reply was to correct your sums for energy and power.&nbsp; It&#39;s all too easy to get these two parameters confused; we&#39;ve all done it.&nbsp; Strictly speaking, the Mk2 Router diverts surplus energy rather than surplus power.&nbsp; The control system is entirely reactive.&nbsp; When the energy state becomes too high, a burst of energy is diverted to the load.</p>
<p>Other systems which feature &quot;proportional control&quot; are predictive rather than reactive.&nbsp; That kind of system determines the amount of surplus power over a certain period and activates the load at an appropriate rate.&nbsp; Such systems can be hard pressed to keep up with rapidly changing conditions.&nbsp; Several people have told me that their alternative types of diverter are slow to react.&nbsp; Some commercial diverters include a small bias towards export in order to avoid over-consumption when conditions change.&nbsp; The Mk2 design has no such difficulty.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28970"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7784.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Storming Norman&#039;s picture" title="Storming Norman&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/7784.html" title="View user profile.">Storming Norman</a> on Tue, 24/03/2015 - 15:03.</div>
    <div class="content">
     <p>Thanks Robin, I stand corrected. I have been trying to understand your Interrupt Service Routine, I can see how it works after the 1st pass but don&#39;t understand what is happening when it starts. The 1st raw sample in (case 0) get&#39;s a voltage sample then&nbsp;puts diverted (CT3) analog&nbsp;pin to be read. but your notes say grid (CT4) is underway. Where did it get this from?.</p>
<p>I think it will get it from CASE 4 after the 1st pass.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28976"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 24/03/2015 - 19:59.</div>
    <div class="content">
     <p><em>your notes say grid (CT4) is underway. Where did it get this from?.</em></p>
<p>Norman, the ISR follows a 5-way sequence under the control of the &#39;static&#39; variable, <em>sample_index</em>.&nbsp; During the final stage which is &quot;case 4:&quot;, <em>sample_index</em> is set to 0 in readiness for next time around.&nbsp; Also during that stage, the &quot;next&quot; ADC conversion is set to the grid sensor which is CT4.&nbsp;&nbsp; That conversion will start as soon as the one which is already under way (for Voltage) has finished.&nbsp; By the time that the ISR gets to processing the data for voltage, the conversion for grid (CT4) has already started.&nbsp; There are other ways of operating the ADC, but this method is the fastest that I know of.&nbsp;</p>
<p>If I&#39;ve got it right, three elements in the ISR should follow the same sequence: Voltage, CT4, CT3, CT2 and CT1:</p>
<p>- the channel that the latest ADC result is from;</p>
<p>- the ADC channel which is to be set up next</p>
<p>- the conversion which is already under way (for info only)</p>
<p>These three sequences all go around in the same order, but start at different places.&nbsp; It&#39;s actually easier to see what&#39;s going on when there are more stages.&nbsp; When there are just two stages, it can take a while to work out what&#39;s happening.&nbsp; All credit to J&ouml;rg Becker for this interrupt-based kernel.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28978"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 24/03/2015 - 20:52.</div>
    <div class="content">
     <p>I think the first round of samples is a bit of a muddle but, in reality, does it matter? You're weighing the effect of one sample being wrong out of 2500 roughly in the first second of operation. The inaccuracy that introduces in the first mains cycle is probably comparable with the other errors that are present, in the first second it is quite insignificant. </p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-28982"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 24/03/2015 - 21:31.</div>
    <div class="content">
     <p>I&#39;ve probably never checked exactly what happens during the first 0.5 milliseconds of the ADC&#39;s operation (520 us actually), but the system soon settles down.&nbsp; No data from the ADC is used for serious purposes for the first few seconds, only for determining the boundaries of each mains cycle.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39079"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 03/02/2016 - 13:33.</div>
    <div class="content">
     <p>On <a href="12030.html">another thread</a>, CidiRome has raised the interesting possibility that the processing of certain parts of this code may not be completed within the 104 us which is available.&nbsp; If this were to happen, ADC samples could be overwritten before they have been processed.&nbsp;</p>
<p>To investigate whether this is ever happening, I&#39;ve added a simple checker mechanism to this code.&nbsp; A boolean flag is set when each new ADC sample appears, and cleared when the data has been processed.&nbsp; If the next ADC sample ever appears before the flag has been cleared, a &quot;failure tally&quot; is incremented.&nbsp; Every five seconds, a copy of this tally is displayed by the &#39;main&#39; code at the Serial port via the existing datalogging mechanism.&nbsp;</p>
<p>With the expected number of failures being 0, I was delighted to see this value at the Serial port:</p>
<p>----<br />
Watts@CT4(grid):0, CT3:1, CT2:1, CT1:1, Wh@CT3:0, Vrms:305.9, temp:300.0, min#ofSS/MC:38, #ofSS:9609, #of timingFailures<strong>0</strong><br />
Watts@CT4(grid):0, CT3:0, CT2:0, CT1:0, Wh@CT3:0, Vrms:243.4, temp:300.0, min#ofSS/MC:38, #ofSS:9609, #of timingFailures<strong>0</strong><br />
Watts@CT4(grid):0, CT3:0, CT2:0, CT1:0, Wh@CT3:0, Vrms:244.0, temp:300.0, min#ofSS/MC:38, #ofSS:9607, #of timingFailures<strong>0</strong><br />
Watts@CT4(grid):0, CT3:0, CT2:0, CT1:0, Wh@CT3:0, Vrms:242.7, temp:300.0, min#ofSS/MC:38, #ofSS:9607, #of timingFailures<strong>0</strong></p>
<p>If one of the five lines which clears the flag is commented out, I would expect to see one failure being reported every data set.&nbsp; Each data set takes approx 5 * 104 us, so within a 5 second period the expected number of data sets will be 5,000,000 / (5 * 104) = 9615.&nbsp; This figure is just as I&#39;m seeing in practice, as below:</p>
<p>----<br />
Watts@CT4(grid):0, CT3:1, CT2:1, CT1:1, Wh@CT3:0, Vrms:305.3, temp:300.0, min#ofSS/MC:38, #ofSS:9620, #of timingFailures15296<br />
Watts@CT4(grid):0, CT3:0, CT2:0, CT1:0, Wh@CT3:0, Vrms:243.4, temp:300.0, min#ofSS/MC:38, #ofSS:9620, #of timingFailures<strong>9620</strong><br />
Watts@CT4(grid):0, CT3:0, CT2:0, CT1:0, Wh@CT3:0, Vrms:242.8, temp:300.0, min#ofSS/MC:38, #ofSS:9622, #of timingFailures<strong>9622</strong><br />
Watts@CT4(grid):0, CT3:0, CT2:0, CT1:0, Wh@CT3:0, Vrms:243.1, temp:300.0, min#ofSS/MC:38, #ofSS:9622, #of timingFailures<strong>9622</strong></p>
<p>From these results, it appears that my code as posted is doing all of its processing within the available time period.&nbsp; The use of all-integer rather than floating-point maths appears to be doing a good job.&nbsp; This code includes an integer-based phaseCal calculation for each of the four current-sensing channels.&nbsp; In the revised code, the error in this logic that was highlighted recently by Per-Ake (PBudmark) has been fixed by re-locating one of the lines in the &quot;voltage&quot; section of the ISR (case 0).</p>
<p>The revised code is attached.&nbsp; All input welcome.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39091"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 03/02/2016 - 18:23.</div>
    <div class="content">
     <p>On reflection, I doubt whether the timeTrial sketch that I posted earlier today is capable of detecting if processing within the ISR takes too long.&nbsp; Assuming that each iteration of the ISR will always run its course, the boolean flag will always have been cleared before its state is checked, so the test will never fail.</p>
<p>To check the time taken for a&nbsp; (long / int) calculation, I devised a simple sketch which loops around 100,000 times.&nbsp; On each loop, it checks millis() and uses this value to &#39;seed&#39; a dummy calculation of this type.&nbsp; The resulting dummy value is accumulated and printed out at the end of the run along with the time per loop in microseconds.</p>
<p>For just the loop structure, I&#39;m seeing 1.6 us / loop</p>
<p>If the dummy value is never printed out, the result is identical.&nbsp; This tells me that the optimiser is smart enough to recognise that this value will never be used so need not be calculated.</p>
<p>If the dummy value <strong><em>is </em></strong>printed out, I&#39;m seeing 38 us / loop, so I deduce that the (long / int) calculation is taking around 36 us.&nbsp; This is not far from the value of &quot;about 40us&quot; that CidiRome reported earlier.</p>
<p>To demonstrate whether the ISR workload in my free-running &quot;CM&quot; code is ever exceeding its permitted duration is not straightforward.&nbsp; Any ideas as to how this could be done will be gratefully received.&nbsp; My gut feeling is that this code is working OK because I&#39;ve not seen anything to make me suspect that it isn&#39;t.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39095"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 03/02/2016 - 21:31.</div>
    <div class="content">
     <p>You could check at the end of your ISR to see if a new conversion has completed. &nbsp;A positive result wouldn&#39;t necessarily mean that you&#39;ve lost data, but it would at least indicate that you&#39;re sometimes slipping behind and have the potential to lose some. &nbsp;A negative result would mean you always complete with time to spare. &nbsp;</p>
<p>Something like:</p>
<pre>
volatile bool ADC_ISR_lagged;
volatile uint32_t ADC_ISR_lagcount;

...

  if (ADCSRA &amp; _BV(ADIF)) {                   // If new conversion pending
    ADC_ISR_lagged = true;                    // note that we&#39;re lagging
    ADC_ISR_lagcount++;
  }</pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39113"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 04/02/2016 - 14:01.</div>
    <div class="content">
     <p>Hi dBC, CidiRome, I&#39;m pleased to see a worldwide interest in checking the behaviour of my revised ISR structure - just as it should be for these open-source ventures.</p>
<p>For my part, I&#39;ve devised a simple tool which checks the duration of each ISR visit and records the longest value.&nbsp; This occurs in loop() which is doing nothing other than this task.&nbsp; After a pre-set period, it dumps the result to Serial, and then starts over.</p>
<p>This tool is ISR_duration_checker.ino, as attached.&nbsp; The ADC is free-running with an ISR that does a (long / int) calculation every time.&nbsp; This results in an overall delay of ~64 us which is well within the 104 us threshold.&nbsp; Every tenth visit, it does some extra work which takes another ~40 us.&nbsp; The consequence of this is that pairs of ADC-done interrupts occasionally overlap.&nbsp; When this occurs, the &#39;main&#39; code records this back-to-back activity as a single longer ISR visit because micros() is not executed between them.&nbsp; The results file, resultsFor_overlappingISRs_1.txt shows this effect nicely.</p>
<p>I then took a clean version of my <a href="../sites/default/files/emonTxV3_4_as_Mk2Router.ino_.zip">emonTxV3_4_as_Mk2Router </a>sketch and replaced its loop() with the one from the above checker tool.&nbsp; The resulting code is attached as newISR_timingChecks.ino.&nbsp; Having made this change, everything will be happening in the ISR just as before, but no &quot;copyOf&quot; data is being processed by the &#39;main&#39; code.&nbsp; By getting the code in loop() to display its result every 13 seconds, the 5-second datalogging activity within the ISR should always be caught.</p>
<p>The resulting display is attached as ISR_duration_results_1.txt with an extract shown below.&nbsp; This indicates to me that the code I have tested today is working OK, and that no rescheduling of the ISR workload will be necessary..</p>
<p>&gt;&gt;free RAM = 1141<br />
----<br />
max duration was 96 us<br />
max duration was 96 us<br />
max duration was 100 us<br />
max duration was 96 us<br />
max duration was 96 us<br />
max duration was 96 us<br />
max duration was 100 us<br />
max duration was 96 us<br />
max duration was 104 us<br />
max duration was 104 us<br />
max duration was 96 us</p>
<p>The code that I was running for this test was posted by me last year.&nbsp; It provides a &quot;Mk2 PV Router&quot; control activity within a 4-channel &quot;continuous monitoring&quot; environment for real power with individual powerCal and phaseCal adjustments for each channel.&nbsp; All of this work takes place within the ISR.&nbsp; Support is provided in the &#39;main&#39; code for RF datalogging, temperature measurements and Serial.&nbsp; If this code is modified for any other purpose, care should be taken not to increase the ISR workload such that timing problems are encountered.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39128"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 05/02/2016 - 11:22.</div>
    <div class="content">
     <p>A couple of days ago, dBC suggested a way of checking if the ISR workload was ever exceeding the time that is available.&nbsp; Having read up about ADIF in the datasheet, this does seem an excellent idea.&nbsp; What&#39;s more, it&#39;s working perfectly in practice too!</p>
<p>The attached tool <em>ISR_lagging_checker</em> will run on any Atmega 328 platform.&nbsp; It has a free-running ISR in which workload is simulated using <em>delayMicroseconds()</em>.&nbsp; As posted, each visit to the ISR has a 40 us delay, and every tenth one has an additional delay of 65 us.&nbsp; With the cycle time of the free-running ISR being ~104 us, I would expect to see an instance of lagging at every tenth visit.&nbsp; Over a 3 second period, there will be 3,000,000 / 104&nbsp; = 28846 visits, one tenth of which is 2884.&nbsp; The value that I&#39;m consistently seeing on the screen is 2622.&nbsp; Not sure why there is this discrepancy.&nbsp; The displayed value did not change when I increased the extra delay from 65 us to 80 us.</p>
<p>I then ported this mechanism to a clean copy of my <a href="../sites/default/files/emonTxV3_4_as_Mk2Router.ino_.zip">emonTxV3_4_as_Mk2Router</a> sketch.&nbsp; When this was run on an emonTx V3.4, the number of instances of lagging was zero.&nbsp; When a fixed delay of 10 us was introduced to every ISR visit, there were still no such instances.&nbsp; When I increased the delay to 20 us, an effect started to be seen.</p>
<p>With a 6 second recording period, and a datalogging event occurring every 5 seconds, it is evident that precisely one instance of lag is being at each datalogging event:</p>
<p>&gt;&gt;free RAM = 1159<br />
----<br />
0<br />
1<br />
2<br />
1<br />
1<br />
1<br />
1<br />
2<br />
1<br />
1<br />
1<br />
1<br />
2<br />
1<br />
1<br />
1<br />
1<br />
2<br />
1</p>
<p>
To summarise: All visits to the ISR are completing with at least 10 us to spare.&nbsp; Once per datalog period, there is a heavyweight visit where there is less than 20 us to spare, but running over into the next visit (which will always be a short one) would not cause any problem.&nbsp;</p>
<p>The technique suggested by dBC, as demonstrated above, would seem to be an excellent way of verifying the performance of any similar code before it is released for general use.&nbsp; Trans-world co-operation of this nature is surely open-source at its best.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39134"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/02/2016 - 20:58.</div>
    <div class="content">
     <p><em>28846 visits, one tenth of which is 2884.&nbsp; The value that I&#39;m consistently seeing on the screen is 2622.&nbsp; Not sure why there is this discrepancy.</em></p>
<p>28846 / 11 is 2622 &nbsp;and...</p>
<pre>

counterForExtraDelay++; 
if (counterForExtraDelay &gt; 10) 
&nbsp; { // extra &#39;work&#39; for the Nth visit only
</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39135"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/02/2016 - 21:41.</div>
    <div class="content">
     <p>Because ADC_ISR_lagcount is a multi-byte variable, you can&#39;t access it reliably while there&#39;s a chance the ISR may be manipulating it (a 32-bit increment is not atomic on an 8-bit AVR). &nbsp;But you can use the single-byte ADC_ISR_lagged to decide whether it&#39;s worth going to the effort. &nbsp; So maybe something like this:</p>
<pre>
void loop()
{
  uint32_t my_lagcount;

  if (ADC_ISR_lagged) {
    cli();
    my_lagcount = ADC_ISR_lagcount;
    ADC_ISR_lagcount = 0;
    ADC_ISR_lagged = false;
    sei();
  } else
    my_lagcount    = 0;

  Serial.println (my_lagcount);
  delay(3000);
}

</pre><p>I made the same mistake in DataLogger.ino in this thread:&nbsp;<a href="12030.html">http://openenergymonitor.org/emon/node/12030</a>&nbsp;which I&#39;ll fix.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39146"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sat, 06/02/2016 - 00:32.</div>
    <div class="content">
     <p>Doh!&nbsp; How many more times will I use &#39;&gt;&#39; when it should have been &quot;&gt;=&quot;.&nbsp;</p>
<p>I&#39;ll have to think a bit more about the other one; I wondered why that boolean was in in the code fragment you provided,&nbsp; There&#39;s a lot of new ground for me to cover here.&nbsp; Thanks for the guidance.&nbsp; I trust that it doesn&#39;t affect the conclusion that my code as posted appears to be OK.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39149"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 06/02/2016 - 02:54.</div>
    <div class="content">
     <p>You&#39;re welcome. &nbsp; &nbsp;And I agree, your conclusion remains sound. &nbsp;You&#39;d have to be pretty unlucky to hit the timing window I pointed out. &nbsp;If you did, all you&#39;d see is a one-off very strange value for lagcount.</p>
<p>A lot of people confuse volatility with atomicity&nbsp;(is that a word?). &nbsp;But they&#39;re&nbsp;two separate issues, each with their own solution. &nbsp;Declaring something <em>volatile</em> will ensure the compiler always accesses it at its memory location, rather than using&nbsp;the local registers that it loaded it into just a few lines of code earlier. &nbsp;In the case of read access say,&nbsp;every time the compiler sees&nbsp;ADC_ISR_lagcount it will generate the necessary code to go and re-read it from memory. &nbsp; &nbsp;For non-volatile variables it usually just does that on the first access in a function, then does all it&#39;s manipulations on the register copy, and if any of them were writes, writes the register copy back out to memory before returning.</p>
<p>Whether or not an operation is atomic comes down to what the CPU can do in a single instruction. &nbsp;ISRs don&#39;t interrupt instructions, they only interrupt between instructions. &nbsp;Incrementing or reading a 32-bit variable is a single instruction on any modern proper CPU so there&#39;s generally no hazard. &nbsp;But on a little 8-bit micro, you have to consider the generated code.</p>
<p>&nbsp;&nbsp;&nbsp; ADC_ISR_lagged = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // note that we&#39;re lagging<br />
&nbsp;&nbsp;&nbsp; ADC_ISR_lagcount++;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // count the lags</p>
<p>generates all of this:</p>
<pre>
     39a:    81 e0           ldi    r24, 0x01    ; 1
     39c:    80 93 35 02     sts    0x0235, r24
     3a0:    80 91 31 02     lds    r24, 0x0231
     3a4:    90 91 32 02     lds    r25, 0x0232
     3a8:    a0 91 33 02     lds    r26, 0x0233
     3ac:    b0 91 34 02     lds    r27, 0x0234
     3b0:    01 96           adiw    r24, 0x01    ; 1
     3b2:    a1 1d           adc    r26, r1
     3b4:    b1 1d           adc    r27, r1
     3b6:    80 93 31 02     sts    0x0231, r24
     3ba:    90 93 32 02     sts    0x0232, r25
     3be:    a0 93 33 02     sts    0x0233, r26
     3c2:    b0 93 34 02     sts    0x0234, r27</pre><p>
<font face="sans-serif, Arial, Verdana, Trebuchet MS"><span style="white-space: normal;">​And more importantly I guess,&nbsp; when you go to access that variable in the main loop:</span></font></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my_lagcount = ADC_ISR_lagcount;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ADC_ISR_lagcount = 0;</p>
<p>&nbsp;</p>
<p>generates:</p>
<pre>
&nbsp; &nbsp;  4fe:&nbsp;&nbsp; &nbsp;80 90 31 02 &nbsp;&nbsp; &nbsp;lds&nbsp;&nbsp; &nbsp;r8, 0x0231
&nbsp; &nbsp; &nbsp;502:&nbsp;&nbsp; &nbsp;90 90 32 02 &nbsp;&nbsp; &nbsp;lds&nbsp;&nbsp; &nbsp;r9, 0x0232
&nbsp; &nbsp; &nbsp;506:&nbsp;&nbsp; &nbsp;a0 90 33 02 &nbsp;&nbsp; &nbsp;lds&nbsp;&nbsp; &nbsp;r10, 0x0233
&nbsp; &nbsp; &nbsp;50a:&nbsp;&nbsp; &nbsp;b0 90 34 02 &nbsp;&nbsp; &nbsp;lds&nbsp;&nbsp; &nbsp;r11, 0x0234
&nbsp; &nbsp; &nbsp;50e:&nbsp;&nbsp; &nbsp;10 92 31 02 &nbsp;&nbsp; &nbsp;sts&nbsp;&nbsp; &nbsp;0x0231, r1
&nbsp; &nbsp; &nbsp;512:&nbsp;&nbsp; &nbsp;10 92 32 02 &nbsp;&nbsp; &nbsp;sts&nbsp;&nbsp; &nbsp;0x0232, r1
&nbsp; &nbsp; &nbsp;516:&nbsp;&nbsp; &nbsp;10 92 33 02 &nbsp;&nbsp; &nbsp;sts&nbsp;&nbsp; &nbsp;0x0233, r1
&nbsp; &nbsp; &nbsp;51a:&nbsp;&nbsp; &nbsp;10 92 34 02 &nbsp;&nbsp; &nbsp;sts&nbsp;&nbsp; &nbsp;0x0234, r1
</pre><p>It has to fetch ADC_ISR_lagcount out of memory byte by byte and then zero it out byte by byte (r1 contains 0). &nbsp;So now you can imagine what happens if the ISR code fires in between any of these 8 instructions. &nbsp;You&#39;ve picked up some of the 4 bytes before the ISR has changed them all (assuming a carry propagates all the way through) and the rest after the ISR has changed them all. &nbsp;So you end up with an inconsistent 32-bit value, half of it loaded from one era, and the other half from another.</p>
<p>So accessing volatile multi-byte variables&nbsp;needs&nbsp;to be protected from interruption.&nbsp; You can either use the macros defined in &lt;atomic.h&gt;, or you can simply wrap your access with cli(); sei(); pairs.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39152"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sat, 06/02/2016 - 09:51.</div>
    <div class="content">
     <p>Are the statements <em>cli()</em> and <em>sei()</em> having the same effect as <em>noInterrupts()</em> and <em>interrupts()</em>, as in this example from the Arduino Reference page:</p>
<pre>
void loop() { 

noInterrupts();

// critical, time-sensitive code here

interrupts();

// other code here }</pre><p>Where would I be able find out more about these interesting constructs?&nbsp; (preferably is an easy going form that I can comprehend!)<br />
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39154"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 06/02/2016 - 11:24.</div>
    <div class="content">
     <p><em>Are the statements cli() and sei() having the same effect as noInterrupts() and interrupts()</em></p>
<p>Yes, from Arduino.h:</p>
<pre>
#define interrupts() sei()
#define noInterrupts() cli()</pre><p>I&#39;m not sure why the Arduino folk decided to rename them.... perhaps to aid readability or portability to non-AVR platforms.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39178"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 07/02/2016 - 04:20.</div>
    <div class="content">
     <p>I&#39;ve attached a really simple sketch that demonstrates the atomic problem. &nbsp;The ADC-complete interrupt simply counts how many times it&#39;s run (and doesn&#39;t even bother to read the conversion result), so I&#39;m using the ADC as a simple timer that ticks every 104 usecs. &nbsp;You might need to tweak start_adc() for your CPU type; just set it up however you usually set it up so it&#39;s in continuous sampling&nbsp;mode.</p>
<p>The main loop aggressively monitors the counter and screams if it ever goes backwards. &nbsp;If I&#39;ve done the maths correctly&nbsp;that should only happen every 310 days (32-bit counter * 104 usecs). &nbsp;You get to choose whether the main loop accesses the counter atomically or not by whether or not you include the cli() / sei() pair:</p>
<pre>
   //  cli();
    latest_ISR_count = ADC_ISR_count;    // Needs protection from interrupts
   //  sei();</pre><p>Without the protection, the complaints come screaming in....</p>
<p>Hello world<br />
1FF -&gt; 100 ?<br />
BFF -&gt; B00 ?<br />
FFF -&gt; F00 ?<br />
19FF -&gt; 1900 ?</p>
<p>always when there&#39;s a carry. &nbsp;The ISR changed&nbsp;ADC_ISR_count from 0x1ff to 0x200 right in the middle of that assignment statement above. &nbsp;The assignment statement fetched the three high order bytes before the interrupt, but before it could fetch the 4th (least significant) byte, the ISR fired and changed the bottom two bytes (because there was a carry). &nbsp;The ISR then returns, and the assignment statement completes by fetching the 4th byte, but it&nbsp;is inconsistent with the stale 3rd byte it picked up before the ISR.</p>
<p>It&#39;s a bit of an artificial example. &nbsp;The reason it shows up so reliably in this case is because the main loop is hammering so hard on the shared datastructures, it&#39;s pretty much guaranteed to be watching during a transition. In real life, the main loop is likely to be off doing other useful stuff most of the time, so the necessary conditions become much rarer (and harder to find when they do occur). &nbsp;</p>
<p>And of course cli()/sei() isn&#39;t the only way to solve it; it&#39;s just the ultimate brute-force way. &nbsp; Robin mentioned&nbsp;he uses a dataReady flag, and an agreement between the competing threads on who&#39;s allowed to write and who&#39;s allowed to read when. &nbsp;If you can arrange that, it has the big advantage that you&#39;re not disabling interrupts all the time.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39187"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Using an emonTx V3.4 as a Mk2 PV Router</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sun, 07/02/2016 - 12:39.</div>
    <div class="content">
     <p><em>dBC: I&#39;ve attached a really simple sketch that demonstrates the atomic problem. </em></p>
<p>... and it works really nicely, exactly as posted.&nbsp; Without the cli() and sei() pair in place, the complaints do indeed come screaming in, too fast to see.&nbsp; Pulling out the USB cable stopped it, not sure if there&#39;s a tidier way ...</p>
<p>Hello world<br />
1FF -&gt; 100 ?<br />
2FF -&gt; 200 ?<br />
AFF -&gt; A00 ?<br />
EFF -&gt; E00 ?<br />
1AFF -&gt; 1A00 ?<br />
22FF -&gt; 2200 ?<br />
27FF -&gt; 2700 ?<br />
2AFF -&gt; 2A00 ?<br />
32FF -&gt; 3200 ?</p>
<p>These &#39;failures&#39; are occurring at slightly different moments for me, but the pattern on each run is exactly the same.&nbsp; Adding a one-off <em>Serial.println()</em> statement at the start of <em>loop() </em>causes the first such event not to occur, but all the others remain exactly as before.&nbsp; Because there is never any variation in what either of them is doing, the ISR and main code are presumably remaining in perfect synch.&nbsp; In the real world, the main code would be&nbsp; taking different paths on each run.</p>
<p><span id="cke_bm_73E" style="display: none;">&nbsp;</span>With the<em> cli()</em> and <em>sei()</em> in place, or <em>noInterrupts()</em> and <em>interrupts(), </em>the interaction between the ISR and main code operates perfectly.&nbsp; Nice demo dBC, thanks for sharing.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10203"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-9kkGxF0SWIlW-TkWg4llEWiySf_ikDRSWhUzS_AFPUw" value="form-9kkGxF0SWIlW-TkWg4llEWiySf_ikDRSWhUzS_AFPUw"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
