<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/3600 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:26:04 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>[Solved] emonTH gas with phototransistor | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">[Solved] emonTH gas with phototransistor</h3>
        <span class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Sat, 11/01/2014 - 21:59</span>
        <div class="content"><p>Hi,</p>
<p>My gas meter has a reflective filled-in zero on the smallest dial which I want to detect using an emonTH as a low power sensor node.</p>
<p>I&#39;ve got a proof of concept working using Maplin&#39;s Photo Reflector SY-CR102 but that has a range of around 1mm when I test it, way too weak for my meter&#39;s clear cover.</p>
<p>I&#39;m guessing I need a more powerful IR LED and detector. Can anyone recommend components that would suit? The easier to solder the better ;-)</p>
<p>My proposed sketch will have the emonTH&nbsp;wake more regularly than the default 60 seconds* and fire up the IR LED, then check and see what&#39;s happening in sensor land.</p>
<p>I&#39;m totally open to a better suggestion if anyone has one. I suspect the digital pin / interrupt with LED polling would be much more power intensive?</p>
<p>* I&#39;m going to turn all our gas appliances on full and measure the time it takes the disc to pass a fixed point, then poll slightly more quickly than that to avoid missing it).</p>
<p>thanks!</p>
  <div class="forum-topic-navigation clear-block">
          <a href="3906.html" class="topic-previous" title="Go to previous forum topic">‹ Moteino gateway</a>
              <a href="3815.html" class="topic-next" title="Go to next forum topic">Solar PV power diversion with emonTx V3 using a PLL and temperature measurement ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-17529"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 11/01/2014 - 22:59.</div>
    <div class="content">
     <p>Does the &#39;fast&#39; dial also have a magnet in it? Mine has and it will operate a small reed switch. This thead <a href="1732.html" title="http://openenergymonitor.org/emon/node/1732">http://openenergymonitor.org/emon/node/1732</a> has a lot about this - and a reed switch in position is shown in the picture here <a href="1732.html#comment-10911" title="http://openenergymonitor.org/emon/node/1732#comment-10911">http://openenergymonitor.org/emon/node/1732#comment-10911</a>. If yours is the same or a similar meter, it is worth checking. An ordinary magnetic compass held in front of the register will show the presence of a magnet.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17537"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Sun, 12/01/2014 - 12:05.</div>
    <div class="content">
     <p>Theres also info on the Building Blocks &gt; Pulse counting &gt; Gas Metering page &nbsp;which includes a link to the following page</p>
<p><a href="https://github.com/Bra1nK/HomeMonitor/tree/master/Gas Meter Pulse Creator">https://github.com/Bra1nK/HomeMonitor/tree/master/Gas%20Meter%20Pulse%20Creator</a>.</p>
<p>But I would also support Robert&#39;s comment of checking to see if there&#39;s a magnet first ;-)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17551"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Sun, 12/01/2014 - 21:25.</div>
    <div class="content">
     <p>Good shout. I didn&#39;t think my meter had a magnet because the profile of the section with the dials is not relieved (i.e. nowhere that you&#39;d fit a sensor, as I see in many photos).</p>
<p>However, a compass held up to the meter does a lazy 360 twirl as the gas is being used.</p>
<p>Reed switch to be picked up tomorrow!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17577"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Mon, 13/01/2014 - 22:55.</div>
    <div class="content">
     <p>OK.. last little thing that&#39;s bothering me - I seem to be able to crash the emonTH sketch if I interrupt it just as it&#39;s hitting the DHT sensor in the loop():</p>
<pre>
Pulse
Pulse
Pulse
Pulse
Pulse
Read failemonTH payload:
  Battery voltage: 0.20V
  Pulses accumula&uuml;e</pre><p>No further activity can be got from the emonTH without a reset. &quot;Read fail&quot; is only contained in DHT.cpp</p>
<p>I guess the nature of interrupts is that this sort of thing can happen. Means that an emonTH with DHT22 wouldn&#39;t be suitable for a gas monitor though?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17578"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Mon, 13/01/2014 - 23:04.</div>
    <div class="content">
     <p>Sorry, another schoolboy error: &nbsp;http://forum.arduino.cc/index.php?PHPSESSID=np8octjlbdvvc8jugimnedbij0&amp;topic=89059.msg683360#msg683360</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17589"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Tue, 14/01/2014 - 08:56.</div>
    <div class="content">
     <p>Bah. So, my sketch works nicely and if I use a magnet I can generate pulses by hand and they appear in emonCMS, so very close.</p>
<p>Unfortunately the reed switch is completely lifeless in the presence of my gas meter - I tried holding it against the dial (closest possible approach) in various orientations, and nothing.</p>
<p>Clearly I need a more sensitive switch (I picked up <a href="http://www.maplin.co.uk/p/assemtech-rhodium-plated-miniature-reed-switch-n30an">this switch</a> from Maplin on the way home - I can&#39;t find the AT sensitivity but I have to get quite close with a rare earth magnet to trip it, so it&#39;s obviously not good)</p>
<p>I see from <a href="1732.html">this discussion</a> that the&nbsp;Standex ORD324-1015 was the only one&nbsp;J&eacute;r&ocirc;me could get to work. I can&#39;t seem to find anywhere selling this online. Does anyone have a recommendation for something I can order up that is more likely to work?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17591"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Edwin&#039;s picture" title="Edwin&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by Edwin (not verified) on Tue, 14/01/2014 - 10:18.</div>
    <div class="content">
     <p>Hi,</p>
<p>I am monitoring my gas meter as well. I have a&nbsp;reflective filled&nbsp; number 6, and setup a photo sensor as well to count the number of rotation on my gas meter.</p>
<p>I ordered a photo reflective sensor incl. comparator&nbsp;at DX:</p>
<p><a href="http://dx.com/p/diy-ir-infrared-reflection-sensor-module-blue-160655">http://dx.com/p/diy-ir-infrared-reflection-sensor-module-blue-160655</a></p>
<p>The only disadvantage I am experiencing is sometimes the sensor is sometime double counting the numbers, because there is a impurity of the reflecting material. I changed the script to check if a pulse is generated two times within a second, because it is not rotating that fast.&nbsp;If I count two pulses within the same second, it&nbsp;is not counted because it is false.</p>
<p>I do have a gas meter like yours with a magnet in it. To avoid the&nbsp;situation described as above; I ordered:</p>
<p><a href="http://dx.com/p/">http://dx.com/p/</a>lm393-3144-hall-sensor-module-blue-221287</p>
<p>I didn&#39;t have&nbsp;time to test it with the Hall Sensor, but will let you know when I have the results.</p>
<p>Best regards,</p>
<p>Edwin</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17595"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Tue, 14/01/2014 - 11:49.</div>
    <div class="content">
     <p>Hi Edwin - thanks for that. Are you able to get a clean enough signal just now to use an interrupt, or do you check the value on an analogue&nbsp;pin?</p>
<p>The reed sensor approach is nice because you can sleep and wake on interrupt. Do you run with battery power, and if so what sort of life are you getting with the IR solution?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17598"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 14/01/2014 - 12:19.</div>
    <div class="content">
     <p>I did say this one <a href="http://spiratronics.com/magnetic-reed-switch-en.html" title="http://spiratronics.com/magnetic-reed-switch-en.html">http://spiratronics.com/magnetic-reed-switch-en.html</a> worked for me.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17601"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Tue, 14/01/2014 - 13:06.</div>
    <div class="content">
     <p>Thanks - I think I&#39;m failing to keep track of where everything I&#39;ve read is...</p>
<p>I&#39;ve ordered that part, and also the paired IR&nbsp;LED / sensors in case of reverting to optical detection (at 20mA, I&#39;d need to organise&nbsp;mains power though).</p>
<p>The hardware side of this may be cryptic to me but it&#39;s nice that you don&#39;t have to waste much money on parts if they don&#39;t work out :)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17608"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Edwin&#039;s picture" title="Edwin&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by Edwin (not verified) on Tue, 14/01/2014 - 21:31.</div>
    <div class="content">
     <p>I am using the interrupt input on the emontx3 and not a analogue input. For powering i use the 5V USB and do not use the ACAC as a power supply because i do have 4 emontx boards and this will require to much current and will influence the Vrms measurement.</p>
<p>As mentioned the problem in my case was that reflecting part was not always reflecting (impurity of the reflecting part) so I was counting 2 pulses when it the counter was rotating. I fixed this in the code of Interrupt routine of the arduino.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17669"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Thu, 16/01/2014 - 19:34.</div>
    <div class="content">
     <p>One step forward, another step back...&nbsp;</p>
<p>The reed switch mentioned up-thread doesn&#39;t work - I tried every possible orientation while the boiler was on full, and no dice.</p>
<p>I quickly combined the IR LED and phototransistor&nbsp;with a sketch which toggles the emonTH&#39;s on-board LED on a change interrupt on IRQ0.</p>
<p>It will detect a piece of paper easily and it will detect when I pass it in front of the plastic enclosure of the meter dials, but it&#39;s absolutely unresponsive to the passage of the silver reflective zero digit itself.</p>
<p>Next option is to use analogue... it will be worth it in the end (or I guess I can ask my supplier to fit me a modern smart meter).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17687"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Fri, 17/01/2014 - 07:26.</div>
    <div class="content">
     <p>OK, got somewhere last night, finally:</p>
<p><img alt="" src="../../../cdn.mccraw.co.uk/wp-content/uploads/2014/01/gaspulse.png" style="width: 594px; height: 421px;" /></p>
<p>However, this morning when the boiler came on, I only got a couple of pulses detected (I&#39;d expect 3 per minute as above, from last night) so I wonder if my batteries have dropped enough to impact the calibration.</p>
<p>Still, it proves it&#39;s possible in principal. It looks like I got a shift of under 100 on the analogue pin (and it&#39;s power hungry too) so not one for battery operation perhaps - unfortunate since the meter is on the exterior of the building.</p>
<p>It&#39;s not a power-optimised sketch so has essentially been on full for 7 hours, could have been quite a drain (20mA LED IIRC)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17689"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Fri, 17/01/2014 - 09:01.</div>
    <div class="content">
     <p>Last night I was getting a reading of ~800 for the dial and ~700 for the reflective digit, but as mentioned above it&#39;s not reliable (I&#39;ll need to go back to the sketch which output the raw readings). As this is 10% of the ADC&#39;s reading range, I&#39;m guessing that it means the voltage across the phototransistor&nbsp;only changes by ~0.5V between the two situations.</p>
<p>Without going crazy, is it possible to physically wire the phototransistor&nbsp;so that the 0-5V seen by the emonTH&nbsp;more closely matches this range? That is, my existing reading of 2.5V would be 0V and existing reading of 3.5V would take it right up to 5V? Or am I over-optimising with this idea, since I&#39;ve proven already that I can detect it (sometimes!)</p>
<p>It would be nice to stick with AAs&nbsp;if possible, as the emonTH does report battery voltage so I can anticipate a change, and it would be massively less hassle. If I can get this to work with the power-saving features from the default firmware, waking up every second to take a reading rather than every minute, it should be better even if it won&#39;t last for years...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17697"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 17/01/2014 - 15:45.</div>
    <div class="content">
     <p>I think the optical route is doomed as far as batteries are concerned. The only way I can see to power-save is to determine the width of the pulse you&#39;re seeing at present, and then to use an output to turn on for the minimum amount of time (ms?) both the LED and photo-transistor at least this often in order to catch the reflector going past. But this still means the processor will be almost fully awake all the time, rather than being woken by an interrupt. But at least you might be able to get the LED current down by a significant factor.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17733"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Sun, 19/01/2014 - 02:15.</div>
    <div class="content">
     <p>I&#39;m a little further on with this now and my sketch incorporates the default emonTH power-saving features.</p>
<p>It fires up the LED at a low duty cycle, probably this could be optimised further (25ms on, 750ms off was simple for starters - at 15ms&nbsp;there was some instability in the readings, which I thought was surprising, but then I&#39;m not so hot on the old electronics).</p>
<p>The LED is nominally&nbsp;20mA&nbsp;(not sure what it actually draws from 2AA) so at a 3.3% cycle that&#39;s 0.66mA - still about six months operation if my guesswork is correct.</p>
<p>Since the emonTH can report its battery state, I&#39;d be very pleased with such a long period of operation if it turns out to be the case. Perhaps someone with the necessary equipment could validate it in practice, but otherwise I&#39;ll just need to leave it on and report back.</p>
<p>I&#39;m not so hot on visualising the pulses - just got a realtime&nbsp;chart for now and then the frequency of pulses denotes the rate of burn at the boiler / hob.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17742"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="ngbod&#039;s picture" title="ngbod&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/3824.html" title="View user profile.">ngbod</a> on Sun, 19/01/2014 - 14:37.</div>
    <div class="content">
     <p>For low battery alerts you can use the event module to send you an email when the voltage drops to a set value. &nbsp;Just pick a voltage value that&#39;s&nbsp;just above the brown out voltage of the emonTH.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17745"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Sun, 19/01/2014 - 23:19.</div>
    <div class="content">
     <p>Thanks - good tip.</p>
<p>I&#39;ve been running the sketch all day and it&#39;s bang on the money - over 300 thousands / m<sup>3</sup> have passed through the meter and the emonTH has reported exactly the right number of pulses.</p>
<p>I realised that I had poorly aligned the IR LED and transistor within their blu-tac&nbsp;&quot;package&quot; and re-stuck them together with extra care. This has achieved really good separation of the reflective digit - I get an average reading of ~600 but a low of just over 50 when the digit passes by.</p>
<p>A good next step would be to pot these components somehow &nbsp;and make it look less homebrew should a meter reader drop by (since the meter is external to the property we wouldn&#39;t be there to explain). However, that&#39;s icing on the cake.</p>
<p>I&#39;ll push up the sketch when I&#39;ve tidied it a little.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17788"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3261.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="3chooks&#039;s picture" title="3chooks&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/3261.html" title="View user profile.">3chooks</a> on Mon, 20/01/2014 - 22:55.</div>
    <div class="content">
     <p>&nbsp;</p>
<p>I&#39;m looking to measure gas consumption through pulse counting to a emonTH and came across the following supplier as an example of pulse counting energy monitoring components.</p>
<p>&nbsp; &nbsp; &nbsp;http://www.saveometer.com/store.aspx</p>
<p>They appear to offer a range of gas meter pulse counting sensors with fitting instructions for a range of gas meters.</p>
<p>Unfortunately they are bundled with a transmitter,&nbsp;unnecessary for me, &nbsp;that bumps up the price</p>
<p>&nbsp;</p>
<p>Has anybody had success ordering these or similar sensors separately?</p>
<p>From this company or similar that ship to UK addresses?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17789"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Mon, 20/01/2014 - 23:03.</div>
    <div class="content">
     <p>When I got back from work today I found my emonTH had dropped 6 pulses of gas - not too awful but still a bit disappointing though I suppose that could be one packet lost over the wireless (I haven&#39;t even thought about looking into retries and acks).</p>
<p>I then experienced a 30 minute outage where the emonTH wasn&#39;t calling in this evening. In the end I flipped out one of the batteries for a moment to kick it off again, and it seems to have been fine since then - now a total of 654 pulses recorded, actual meter reads 684, so a further 24 lost (that&#39;s not unreasonable, with the boiler often doing 5-8 pulses per 5 minute period and 6 lost reporting periods).</p>
<p>I&#39;m not sure why the emonTH would just stop calling in. Perhaps a memory leak (although I see nothing obvious - not likely to be in one of the libraries as other people get these processors to run for months). It&#39;s only about 15 feet from the Pi through one brick wall, so should have good signal. If it happens again I&#39;ll do some more investigation.</p>
<p>I see some previous work&#39;s been done on transmitting pulses a bit more robustly. Although this first attempt is within 5% of the true value it could easily be improved even if a foolproof protocol is a bit hard to think of.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17792"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Tue, 21/01/2014 - 02:29.</div>
    <div class="content">
     <p>@3chooks, it&#39;s not clear what they&#39;re actually measuring - presumably magnetic as some of the example meters are surely too ancient for optical pulse.</p>
<p>You can pick up a reed switch for peanuts (less than it would cost me to mail you my unwanted one) and pair with an emonTH without too much trouble. My sketch is overkill for a reed switch (which has the big advantage of using an interrupt / digital pin) but could be adapted, if there&#39;s nothing more immediately suited.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-17793"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Tue, 21/01/2014 - 02:35.</div>
    <div class="content">
     <p>I&#39;ve submitted a pull request on my emonTH analogue pulse sketch: see&nbsp;https://github.com/openenergymonitor/emonTH/pull/2 for those who may be interested.</p>
<p>This now uses ACKs and attempts retries (with pulse count carried over if all retries fail) in an attempt to make the transport more robust.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18430"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Fri, 14/02/2014 - 13:04.</div>
    <div class="content">
     <p>I&#39;ve now got an on-board D18B20 providing external temperature (since my gas meter is outdoors).</p>
<p>I was thinking some more about robustness of pulse submission and it occurs to me that a packet could be received (but the ack is corrupted) resulting in a duplicate packet being sent by my sketch. To guard against this, ideally the Pi would not forward on duplicate packets. I guess that means an update to the python script when I can get around to it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18433"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 14/02/2014 - 13:20.</div>
    <div class="content">
     <p>That&#39;s a really difficult problem because you need to be able to detect a failure in both directions - the original data not received and the acknowledgement not received. I think the only practical safe way is to send a serial number - though of course if you accumulate energy in the transmitter, the energy itself functions as the serial number. But then you have the problem of power failure and resetting from zero that has to be detected and accommodated at the receiver unless you also store the last value in NVRAM, and then if you do that you have the problem of the NVRAM wearing out if you write to it too often....</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18435"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Fri, 14/02/2014 - 14:23.</div>
    <div class="content">
     <p>Hopefully if the original data isn&#39;t received by the base, it will get one of the subsequent retries (I&#39;ve considered having the retry delay be a product of the nodeID to avoid repeated collisions between multiple units).</p>
<p>Ignoring any transmission received within x seconds of the first would guard against a failed ack (but it would need to be flexible, in case someone wants to have a really rapidly updating sensor for some reason, on the same magnitude as the retry delay)</p>
<p>The approach I&#39;ve taken in my sketch (now in the emonTH git repo) is to submit pulses since the last successful transmission only. This means if all retries fail because, say, the Pi is switched off, pulses will accumulate on the emonTH until the Pi is switched back on. Losing power on the emonTH would cause untransmitted pulses to be lost, but the impact is reduced because only pulses counted since the last transmission are unrecorded, and by default that&#39;s only the last five minutes.</p>
<p>Not perfect, but should be reasonable I hope.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18436"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Fri, 14/02/2014 - 14:33.</div>
    <div class="content">
     <p>This issue has been discussed in other related threads. The lead I&#39;m following is to send a counter (which is homogeneous to an energy).</p>
<p>See a list of related posts <a href="https://learn.openenergymonitor.org/?redirect=gas-meter-monitoring">here</a>. I meant to sort them and didn&#39;t get the time. I added this thread to the list.</p>
<p>I power my TX with a LiPo, and added a <a href="https://www.sparkfun.com/products/10968">step up</a> that keeps the voltage 5V even if the LiPo delivers less.</p>
<p>The communication with the Pi used to work reliably, then with the cold I begun to lose samples at night. Then I added the step up to fight the voltage drop due to the cold, but I never got the communication to work again. I suppose I&#39;m at the range limit and it relies on the position of the antennas... I must have been lucky the first time I installed the devices.</p>
<p>My next step is to try a lower bitrate to increase the range and finally get the communication channel to work reliably.</p>
<p>My other issue is the post-processing, from the pulse to the energy. You&#39;ll see that in the threads. Basically, the turn that is detected at time t accounts for energy consumed since last pulse. This time interval can be long. emoncms is not really made to work with this and I find it hard having a display that shows all the information I get from the sensor.</p>
<p>In practice, when it worked, I could clearly see the boiler switching on every 15 minutes for a few minutes. I&#39;d like to keep this precision, but remove the ugly spikes. You can see the feed here: <a href="http://jolimont.fr/emoncms/vis/auto?feedid=12" title="http://jolimont.fr/emoncms/vis/auto?feedid=12">http://jolimont.fr/emoncms/vis/auto?feedid=12</a></p>
<p>I just ordered the RFM2Piv2 and hope to be able to try a lower bitrate soon.</p>
<p>I also ordered a TH to try pulse reading with it, eventually monitor my water meter. But this is another story...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18499"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Mon, 17/02/2014 - 12:45.</div>
    <div class="content">
     <p>Thanks for the links. There are quite a lot of discrete discussions around gas and it&#39;s helpful that there&#39;s at least a page tying stuff together. Quite a lot of emphasis on electricity (understandably) but with so many UK properties on gas, I think it&#39;s at least as important.</p>
<p>I got a second TH to dedicate to my gas supply, and because it needed soldering that took me a while to put together. I kicked it off at midnight last night and will follow the accuracy and battery life closely this time. Since the TH steps up from 2AA anyway it should be reasonably stable (I&#39;ve considered a small solar LiPo&nbsp;to prevent me ever needing to change batteries but we&#39;ll see how it goes).</p>
<p>I&#39;m not too worried about the appearance of the pulse feed on a reading-by-reading basis. My goal is to separate our gas use into space heating and water heating to understand the input side of the dwelling&#39;s thermal performance and have a number of temperature readings to calculate the output side. Since temperature is not closely coupled to the individual gas pulses it doesn&#39;t matter much to me if they are aggregated every five minutes, hourly, even daily - i.e. we only have the heating on for a few hours at a time but the house is above ambient round the clock.</p>
<p>I wonder how hard it would be to come up with a bar graph visualisation&nbsp;(one where the height of the bar is the number of pulses divided by the node&#39;s call in frequency, i.e. the correct area under the bar is preserved?). Sadly everything graphical is greek&nbsp;to me.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18674"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/5190.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-5190.jpg" alt="Schism&#039;s picture" title="Schism&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: [Solved] emonTH gas with phototransistor</h3>

    <div class="submitted">Submitted by <a href="../user/5190.html" title="View user profile.">Schism</a> on Sun, 23/02/2014 - 08:13.</div>
    <div class="content">
     <p>I spent the last half hour or so with my Pi offline while I imaged the SD card and HDD for the local emonCMS build.</p>
<p>When I switched on the Pi and configured the network group I got a call from my gas emonTH&nbsp;with 29 pulses - at least double the maximum I&#39;ve previously seen, suggesting the pulses were carried over until a successful ACK was received.</p>
<p>I still need to look at ignoring false resubmissions at the Pi end. Seems promising though.</p>
<p>On the hardware front, blu-tacking the sensor to my meter is proving a little problematic in terms of getting a nice consistant reading - I dropped a bunch of pulses midweek when something shifted. I&#39;m going to have to make a better holder for the apparatus, potentially secured to the meter cupboard door so that it always hits the same spot (I&#39;m just paranoid of being accused of tampering with the meter, since it&#39;s not inside the property).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/3600"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-CXexnsTVljFTQIJGi0FFdWI8DbSvoe0wQZeL0-Ur0Vc" value="form-CXexnsTVljFTQIJGi0FFdWI8DbSvoe0wQZeL0-Ur0Vc"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
