<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/12566 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:16:08 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Tips n Tricks from my own Pi appliance... | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Tips n Tricks from my own Pi appliance...</h3>
        <span class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Wed, 27/04/2016 - 08:31</span>
        <div class="content"><p>This is a thread where I will dump some stuff the devs may or may not find handy; These are things I do on my own pi appliance image that I built for a radio related project, I hope you find somthing usefull here guys.</p>
<p>Kicking this off with my version of fstab, has some extra locations mounted to tmpfs you that might interest you guys.</p>
<pre>

&nbsp;</pre>  <div class="forum-topic-navigation clear-block">
          <a href="12582.html" class="topic-previous" title="Go to previous forum topic">‹ Missing data</a>
              <a href="12578.html" class="topic-next" title="Go to next forum topic">displaying the time in rawdata visualization (solved) ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-41430"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 10:52.</div>
    <div class="content">
     <p>Free up some RAM, for free....</p>
<p>Append &quot;gpu_mem=16&quot; to /boot/config.txt, this caps the RAM available to the GPU (since eMonPi is running headless the GPU should not be in use) and gives the OS some RAM back for free :)</p>
<p>&nbsp;</p>
<p>Before:</p>
<pre>
root@emonpi:~# free -m

             total       used       free     shared    buffers     cached

Mem:           <u><strong>925</strong></u>        435        489         22          2        175

-/+ buffers/cache:        257        668

Swap:            0          0          0</pre><p>&nbsp;</p>
<p>&nbsp;</p>
<p>After:</p>
<pre>
root@emonpi:~# free -m

             total       used       free     shared    buffers     cached

Mem:           <u><strong>973</strong></u>        424        549         17         19        166

-/+ buffers/cache:        238        735

Swap:            0          0          0</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41432"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Wed, 27/04/2016 - 09:06.</div>
    <div class="content">
     <p>Firewalls, we all love to hate them, one way or another; but wouldn&#39;t it be great if you wanted to be able to reach your eMonPi while on the move, of course it would but that means setting up dynamic DNS and them poking about with your firewall, what fun.</p>
<p>&nbsp;</p>
<p>Well here&#39;s some tricks to solve 1/2 of that; upnp&nbsp;for your pi...</p>
<p>&nbsp;</p>
<p>There are a couple of components to making this a real sucsess, a binary that actually communicates to the router via uPNP, an init script to call the process with the arguments, and a cron entry to keep calling it every few mins.</p>
<p>Init script / cron details attached, the binaries can be installed with &quot;apt-get install miniupnpc&quot;</p>
<p>&nbsp;</p>
<p>Happy uPNPing....</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41433"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 10:30.</div>
    <div class="content">
     <p>All in one update script;</p>
<p>Short and sweet, says it all really...</p>
<p>&nbsp;</p>
<p>**EDIT: removed the rpi-firmware update since this relyably&nbsp;killed my pi image, I&#39;ll dig deeper to work out why...</p>
<p>**EDIT2: after spending a little time on this, I can see that the &quot;commit=&quot; argument used for mounting the data partition on the SD card is actually the issue, removing that makes it possible to upgrade the firmware to 4.4</p>
<p>I&#39;ll be modifying the update script to account for that and posting a new version in a short while.</p>
<p>**EDIT3: New script worked up, it works but needs some real world testing - ALL I check for is that the system upgrades, so maybe release an RC3 on the new firmware before a full release?</p>
<p>As part of one of the PHP updates you are asked if you want to keep the local version of some config - yes do that, dont replace it; Also I dont currently force acceptance of the kernel upgrade, so you will be prompted for that. I may be able to clean up / automate both of these if you want the update script used here to be included on production builds, but at the moment I&#39;m only aiming to give you the building blocks to intigrate into the web based update method.</p>
<p>The problem with the new firmware appears to be syntax related; &quot;commit=120&quot; on the line for the data volume in /etc/fstab&nbsp;is the issue. Reading from here:&nbsp;http://www.softpanorama.org/Internals/Unix_filesystems/linux_ext2_ext3.shtml it looks like you are trying to use an EXT3 feature on an EXT2 filesystem, so removing the argument from /etc/fstab should have 0 effect (other than allowing the new 4.4 kernel to boot fully).</p>
<p>SSHD gets broken as part of the update too (specifically on Pi3 using on board wifi only) so you will need to append this to the bottom of your /etc/ssh/sshd_config:</p>
<pre>
IPQoS cs0 cs0</pre><p>See here for more information (long thread):&nbsp;https://www.raspberrypi.org/forums/viewtopic.php?f=28&amp;t=138631</p>
<p>**update script now does this for you...**</p>
<p>Final side note - updating the rpi-firmware will leave behind additional folders in /lib/modules, you will need to clean up the old ones (after a rebboot) to save sdcard space.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41442"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Wed, 27/04/2016 - 12:36.</div>
    <div class="content">
     <p>One caveat. UPnP has some security risks associated with it.<br />
<a href="https://nakedsecurity.sophos.com/2013/02/05/upnp-flaws-turn-millions-of-firewalls-into-doorstops/"><em><strong>Here&#39;s</strong></em></a> an article that explains some of them.</p>
<p>More info:</p>
<p><em><strong><a href="http://www.howtogeek.com/122487/htg-explains-is-upnp-a-security-risk/">www.howtogeek.com/122487/htg-explains-is-upnp-a-security-risk/</a></strong></em> and</p>
<p><em><strong><a href="http://www.root6.com/support-2/tips/upnp-it-was-always-a-bad-idea/">www.root6.com/support-2/tips/upnp-it-was-always-a-bad-idea/</a></strong></em><br />
Excerpt from this article:<br />
<em>it turns out that some routers have UPnP enabled on their Internet-facing port! </em><br />
<em>That&rsquo;s right; you send the correctly formed UDP-discovery packet at the Internet side of the router and along with being able to open ports you can query the router for lots of details about itself, allowing you to better tailor your attack for other known vulnerabilities of that specific model. HD Moore (of Metasploit fame) has had a cluster of machines probing the public Internet to see how many public-facing IP addresses had UPnP enabled and it turns out around 2% of hosts respond to WAN-borne UDP discovery packets. He repeated his scan weekly for six months and those eighty-one million routers remained reasonably constant.</em></p>
<p><em>In case your wondering if your router is vulnerable you can find a list of affected models <strong><a href="http://blog.defensecode.com/2013/02/defensecode-security-advisory-cisco.html">here</a></strong>, and you&rsquo;d be surprised how many big-name manufacturers are there.</em></p>
<p>Here&#39;s<em><strong> </strong></em>a quick test to check your if your router is vulnerable to UPnP exploits:<br />
<a href="https://www.grc.com/x/ne.dll?bh0bkyd2"><em><strong>https://www.grc.com/x/ne.dll?bh0bkyd2</strong></em></a></p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41443"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Wed, 27/04/2016 - 12:54.</div>
    <div class="content">
     <p>Bill,</p>
<p>I totally agree, it does have some security concerns, as does opening up access directly to your pi from the internet, but if the options were not here, nobody would have the choice.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41444"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Wed, 27/04/2016 - 12:58.</div>
    <div class="content">
     <p><em>but if the options were not here, nobody would have the choice.</em></p>
<p>True. I just wanted to point out the security issues for those who might not be aware of them.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41457"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Wed, 27/04/2016 - 22:20.</div>
    <div class="content">
     <p>Hi Andy,</p>
<p>I built the current emonPi image.&nbsp;</p>
<p>Thanks for sharing your modifications.&nbsp;</p>
<p><strong>Memory Tweaks</strong></p>
<p>Setting&nbsp;gpu_mem=16 sounds like a good idea, are there any other side effects to this that you know of&nbsp;other then GUI performance&nbsp;which is obviously not an issue for us. I think I might have read somewhere about stability issues.&nbsp;</p>
<p><strong>Upnp</strong></p>
<p>Nice trick, although I think I&#39;ll leave this out from the stock emonPi image to avoid any potential security issues.&nbsp;</p>
<p><strong>Firmware Update Issue</strong></p>
<p>I would very much like to make the standard&nbsp;emonPi image compatible with the latest ras-pi firmware. Please could you give some more details&nbsp;on the changes you made to make this possible. After these changes to the way partitions are mounted would the new changes be backward compatible&nbsp;e.g. users running older firmware&nbsp;</p>
<p><strong>Log rotate and tmpfs&nbsp;/var/log</strong></p>
<p>This is an issue I wonder if you could help shed some light on: Even though logrotate seems to be working&nbsp;I&#39;ve noticed that /var/log which is mounted as a tmpfs&nbsp;in the RAM fills up after a month or two of operation. Have you noticed this? This is one issue we need to fix before we launch the new image (currently in RC2)&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41464"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 10:53.</div>
    <div class="content">
     <p>Glyn,</p>
<p>Memory Tweak - not had any issues with this on my own system, mine runs a radio repeater for weeks / months at a time, stability hasn&#39;t been an issue here, it does not run a GUI of any kind so the extra ram is handy; I&#39;ve run like that on Pi A (the original one), B, B+, 2B and now the 3 - 3 is brand new of course so no real feedback on that.</p>
<p>uPNP - You might consider adding that but disabled by default - installing the demon is perfectly safe form a security point of view - the security concerns are more about how resilient your Apache server setup is and how secure the users router is. As has been pointed out - it does need to come with a health warning.</p>
<p>Firmware update - found / fixed - I&#39;ll be posting about that shortly, its a simple fix and my update script should take care of it. (more to follow on that). EDIT: See above, update script updated and information added, firmware update works but breaks SSH over wifi - fix now included in the update script.</p>
<p>LogRotate - I&#39;ll take a look at your setup, my eMonPi is all of a day old at this point - so I&#39;d obviously not run into that.</p>
<p>Other advice - delete the ssh keys from the base image before you prep it for download - so every eMonPi RC2 download has the same keys in it at the moment, not a hot idea. EDIT: Still working on this because the base image doesnt re-create the keys when they are missing - not a big deal, I&#39;ll write an init script to take care of it.</p>
<p>Andy</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41465"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 08:25.</div>
    <div class="content">
     <p>Syslog / LogRotate</p>
<p>So one early issue, the syslog is filling up with garbage, due to a bug in the base raspbian system;</p>
<p>Edit the /etc/rsyslog.conf and comment out the last 4 lines that use xconsole, the log balooning&nbsp;should get taken care of (see below). There is a little more work / testing to be done on logrotate to see what it is / isnt doing, but that will take a couple of days for me to check it out.</p>
<pre>
#daemon.*;mail.*;\

#       news.err;\

#       *.=debug;*.=info;\

#       *.=notice;*.=warn       |/dev/xconsole</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41467"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 09:16.</div>
    <div class="content">
     <p>LogRotation;</p>
<p>Once you fix the syslog issue (above) that should reduce the crap being logged to /var/log/messages, it was probably that file / var/log/messages that has been filling up the /var/log tmpfs&nbsp;volume; moving on...</p>
<p>/etc/cron.daily/logrotate was found to be empty, it should look like the one attahced.</p>
<p>/etc/logrotate.conf - small changes here to capture ALL logs in the /var/log/ directory (including the ever expanding messages output) and to make sure the rotation happens daily - change daily if you want weekly / monthly etc. (again see attached).</p>
<p>/etc/fstab&nbsp;required an extra line for the filesystem where logrotate wants to keep its status, since logs are non-persistent, this can live on tempfs too.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41468"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 10:30.</div>
    <div class="content">
     <p>There is a Pi3 unique breakage introduced when you fully update the firmware and base OS, just what you really want in your life.</p>
<p>SSHD gets broken, but ONLY when using the on board WiFi adapter and NO ethernet, this was a bear to find, but still here is the fix;</p>
<p>Edit your /etc/ssh/sshd_config and append the following to the end of the config;</p>
<pre>
IPQoS cs0 cs0
</pre><p>Restart SSHD (or reboot the eMonPi) and SSH is now forever cured.</p>
<p>0 side effects to any other process, and will have no apparent effects on other pi models / wifi cards etc.</p>
<p>EDIT: Update script (re-attached above) now fixes this as part of the update.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41471"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Thu, 28/04/2016 - 10:52.</div>
    <div class="content">
     <p><em>Memory Tweak - not had any issues with this on my own system</em></p>
<p>Same here. I run all of my Pis (4 of them) with this same tweak and have noticed no ill effects. I&#39;ve seen uptimes of over 270 days. (reboot caused by mains power loss)</p>
<p>No worries about this one, Glyn.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41474"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 13:08.</div>
    <div class="content">
     <p>SSH Keys - Auto Generation (the idea here is that we form a service that always starts to create the keys if they are missing. That way the new images can be built and setup for download without any keys in them, and each new install will have new SSH keys.</p>
<p>&nbsp;</p>
<p>1. install the files attached in the locations that I hope are obvious form their names</p>
<p>2. chmod them to 500 (read / execute by root)</p>
<p>3.&nbsp;systemctl daemon-reload (tell the system the files have changed)</p>
<p>4.&nbsp;systemctl enable emonpi-sshkeygen.service (enable the service)</p>
<p>&nbsp;</p>
<p>Now you can remove the SSH keys and they will be re-created at boot time.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41476"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Thu, 28/04/2016 - 13:41.</div>
    <div class="content">
     <p>Glyn,</p>
<p>I&#39;d mentioned this a few months ago, but at that time you decided to go with the stock log rotation.</p>
<p>Ramlog writes the log files to ram, saves them to disk at shutdown and can be configured to save the logs at a user selectable interval. It&#39;s a bash script, and is free. (as in beer) Sounds like it might be able to solve your tmpfs memory issues.</p>
<p>Fom the author&#39;s web page:</p>
<p>
<em>Ramlog act as a system daemon. On startup it creates ramdisk, it copies files from /var/log into ramdisk and mounts ramdisk as /var/log. All logs after that will be updated on ramdisk. Logs on harddrive are kept in folder /var/log.hdd which is updated when ramlog is restarted or stopped. On shutdown it saves log files back to harddisk so logs are consistent. Ramlog 2.x is using tmpfs by default, ramfs and kernel ramdisk are suppored as well. Program rsync is used for log synchronization. </em></p>
<p><em>Ramlog is intended to be used on netbooks or notebooks with SSD or HDD drives.</em></p>
<p><em>In case ramlog is restarted (by default it is one time per day), directory /var/log.hdd is synchronized with /var/log using rsync. Frequency of the automatic log saves can be controller via cron, by default, the ramlog file is placed into /etc/cron.daily </em></p>
<p><a href="http://www.tremende.com/ramlog/">www.tremende.com/ramlog/</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41477"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Thu, 28/04/2016 - 14:45.</div>
    <div class="content">
     <p>Hi Andy,</p>
<p>Thanks so much for you help. Yes, it was the /var/log/messages that was filling up the partition. I think log rotate&nbsp;was working to rotate the emonpi log files (at least on my version of the image) e.g. emonhub.conf etc. However /var/log/messages was not being rotated and this caused this issue.</p>
<p>I have made the change you suggested to logroate and it now seems to be working well and inclusing all logs. Obviously it will take a couple of months to be able to tell for sure.&nbsp;</p>
<p>I have added regenerating SSH keys to the emonpi factory reset script<br />
<a href="https://github.com/openenergymonitor/emonpi/commit/f5ea0de800e9c463905c6d32937a4391d7c2335e" title="https://github.com/openenergymonitor/emonpi/commit/f5ea0de800e9c463905c6d32937a4391d7c2335e">https://github.com/openenergymonitor/emonpi/commit/f5ea0de800e9c463905c6...</a></p>
<p>I will include the fstab, SSHD fix and memory tweak in the next image. I will have the image up for download tomorrow.&nbsp;</p>
<p>You suggested changing logrotate&nbsp;from:</p>
<pre>
#!/bin/sh

/usr/sbin/logrotate -v -s /var/log/logrotate/logrotate.status 
/etc/logrotate.conf 2&gt;&amp;1 | tee /var/log/logrotate/logrotate.log</pre><p>to</p>
<pre>
#!/bin/sh

test -x /usr/sbin/logrotate || exit 0
/usr/sbin/logrotate /etc/logrotate.conf</pre><p>What&#39;s wrong with doing as I was previously&nbsp;doing: moving logrotate.status and logrotate.log to /var/log to ensure it would work on a RO FS. Would doing this negate the need to mount&nbsp;/var/lib/logrotate as tmpfs</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41482"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9853.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="AndyTaylor&#039;s picture" title="AndyTaylor&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/9853.html" title="View user profile.">AndyTaylor</a> on Thu, 28/04/2016 - 15:45.</div>
    <div class="content">
     <p><em>What&#39;s wrong with doing as I was previously&nbsp;doing: moving logrotate.status and logrotate.log to /var/log to ensure it would work on a RO FS. Would doing this negate the need to mount&nbsp;/var/lib/logrotate as tmpfs</em></p>
<p>Nothing - I hadnt realised that was what you were doing, you can trim the changes for logrotate to the very bottom of the logrotate.conf file - change the bottom line to remove the .log parts of the catch all, this is why it didnt rotate &quot;messages&quot;.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41492"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Tips n Tricks from my own Pi appliance...</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Fri, 29/04/2016 - 11:43.</div>
    <div class="content">
     <p>For anyone following this thread using full wildcard is a bad idea:</p>
<p>The manpage for logrotate says</p>
<p><em>&nbsp; &nbsp;Please&nbsp; use wildcards with caution.&nbsp; If you specify *, logrotate<br />
will rotate all files,<br />
&nbsp; &nbsp;including previously rotated ones.&nbsp; A way around this is to use the<br />
olddir directive or&nbsp;a more exact wildcard (such as *.log).</em></p>
<p>I found this post which explains things well:<br />
<a href="http://hudolejev.blogspot.co.uk/2012/06/wildcards-in-logrotate-configuration.html" title="http://hudolejev.blogspot.co.uk/2012/06/wildcards-in-logrotate-configuration.html">http://hudolejev.blogspot.co.uk/2012/06/wildcards-in-logrotate-configura...</a></p>
<p>The <a href="https://github.com/emoncms/emoncms/blob/master/scripts/logger/logrotate.conf">current logrotate.conf</a> symlinked on latest emonpi image has been changed to</p>
<p><em>/var/log/*.log /var/log/*/*.log /var/log/syslog /var/log/messages {}</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/12566"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-yrK__Oii1974JCjNGy5C8yrjv5cHbo8NnjZ-JTc-bYs" value="form-yrK__Oii1974JCjNGy5C8yrjv5cHbo8NnjZ-JTc-bYs"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/12566 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:16:08 GMT -->
</html>
