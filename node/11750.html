<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11750 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:49:42 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Multi Channel Current Monitoring  | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Multi Channel Current Monitoring </h3>
        <span class="submitted">Submitted by <a href="../user/9079.html" title="View user profile.">hardcj</a> on Thu, 03/12/2015 - 22:49</span>
        <div class="content"><p>Hello,&nbsp;</p>
<p>Firstly thank you for the website and the large amount of info that is available, as well as the large amount of people who like myself also play and learn along the way!</p>
<p>&nbsp;</p>
<p>I am working on a project that needs to record data (current only at the moment) of distribution boards and each of their outputs. The boards are all three phase and vary from 4 x three phase outputs (16&nbsp;channel - L1, L2, L3, N) to 8 x three phase outputs (32 channel - L1, L2, L3, N). I am using Arduino Yun&#39;s as my board of choice (pro&#39;s and cons, cons to follow in a minute)</p>
<p>I have tried a number of different ways (software, my own and others) to try and get multi channel up to 32, but can only reliably go up to about 15 channels before i run out of dynamic memory....I know I could change board and gain alot more dynamic memory and it would probably be a quick fix, but the Yun&#39;s are chosen because of the Bridge, USB and Wifi/Network capabilities!</p>
<p>So....does anyone know a way to do what I am trying to do without using up all my dynamic memory?? There is probably an easy way that has been staring me in the face, but as with all things...when you work on a project too intensively for too long, you can sometimes miss the obvious!</p>
<p>Thank you in advance!</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11642.html" class="topic-previous" title="Go to previous forum topic">‹ Compass/Windrose widget</a>
              <a href="11759.html" class="topic-next" title="Go to next forum topic">Arduino Yun &amp; thermeq3 - control of Max! wireless thermostatic radiator valves ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-36673"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Multi Channel Current Monitoring </h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 03/12/2015 - 22:56.</div>
    <div class="content">
     <p>So give us a clue - what are you doing now, that is running out of memory?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36678"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9079.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="hardcj&#039;s picture" title="hardcj&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Multi Channel Current Monitoring </h3>

    <div class="submitted">Submitted by <a href="../user/9079.html" title="View user profile.">hardcj</a> on Thu, 03/12/2015 - 23:50.</div>
    <div class="content">
     <p>Well as an example I can use the Emonlib library using the method: ( I have used just 1 as the example of the process im using. &nbsp;</p>
<p>&quot;</p>
<p>#include &quot;EmonLib.h&quot;</p>
<p>EnergyMonitor emon0; <strong>( x 15 of these)</strong></p>
<p>#define NSENSORS 15</p>
<p>EnergyMonitor emon[NSENSORS];</p>
<p>typedef struct {<br />
&nbsp; float apparentPower; &nbsp;//4<br />
&nbsp; float realPower; &nbsp; &nbsp;// 4<br />
&nbsp; float powerFactor; &nbsp;// 4<br />
&nbsp; float Irms; &nbsp; &nbsp; &nbsp; &nbsp; // 4<br />
} sEmonSensor;</p>
<p>sEmonSensor EmonTx[NSENSORS];</p>
<p>&nbsp;</p>
<p>void setup() {</p>
<p>Serial.begin(9600);</p>
<p>&nbsp;</p>
<p>emon[0].current(2, 97.7); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Current: pin, calib. <strong>&nbsp;( x 15 of these)</strong></p>
<p>}</p>
<p>void loop () {<br />
&nbsp;<br />
&nbsp;for (int i=0; i&lt;NSENSORS; i++) { &nbsp; &nbsp;<br />
&nbsp; emon[i].calcVI(20,50);<br />
&nbsp; }</p>
<p>&nbsp;</p>
<p>Serial.print(emon[0].Irms);&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
&nbsp; &nbsp; Serial.print(F(&quot;, &nbsp;&quot;));</p>
<p>}</p>
<p>&nbsp;</p>
<p>If that makes any sense at all?</p>
<p>&nbsp;</p>
<p>Basically what im trying to achieve is to record what each three phase output of the distribution boards is doing. The largest board (at the moment) im trying to record data from has 8 x 4 pole breakers. But the maximum amount of CT&#39;s I can get running on the emonlib&nbsp;library is 15 before it comes up with the following issue on the Arduino IDE:</p>
<p>Sketch uses 19,454 bytes (67%) of program storage space. Maximum is 28,672 bytes.<br />
Global variables use 2,784 bytes (108%) of dynamic memory, leaving -224 bytes for local variables. Maximum is 2,560 bytes.<br />
processing.app.debug.RunnerException: Not enough memory; see <a href="http://www.arduino.cc/en/Guide/Troubleshooting#size" title="http://www.arduino.cc/en/Guide/Troubleshooting#size">http://www.arduino.cc/en/Guide/Troubleshooting#size</a> for tips on reducing your footprint.<br />
&nbsp;&nbsp; &nbsp;at processing.app.Sketch.size(Sketch.java:1680)<br />
&nbsp;&nbsp; &nbsp;at processing.app.Sketch.build(Sketch.java:1590)<br />
&nbsp;&nbsp; &nbsp;at processing.app.Sketch.build(Sketch.java:1509)<br />
&nbsp;&nbsp; &nbsp;at processing.app.Editor$DefaultRunHandler.run(Editor.java:1915)<br />
&nbsp;&nbsp; &nbsp;at java.lang.Thread.run(Thread.java:695)</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36682"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Multi Channel Current Monitoring </h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 04/12/2015 - 00:31.</div>
    <div class="content">
     <p>It doesn't make a lot of sense! It looks to me as if you've defined 30 instances of the class EnergyMonitor - 15 separate instances named emon0, emon1, emon2, ... emon14, and an array of 15 too. Did you mean that, or have I misread it?</p>
<p>Presumably the array EmonTx of structs is to accept &amp; transmit the data, but you haven't implemented that yet?</p>
<p>Unfortunately, because of the way the software filters work, you do need a class instance for each channel, and I think that, unless there are some variables that you don't need, there's nothing redundant in the library. But of course if there are things you don't want, you're free to take them out.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36730"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9079.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="hardcj&#039;s picture" title="hardcj&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Multi Channel Current Monitoring </h3>

    <div class="submitted">Submitted by <a href="../user/9079.html" title="View user profile.">hardcj</a> on Fri, 04/12/2015 - 22:47.</div>
    <div class="content">
     <p>Hello,&nbsp;</p>
<p>Thank you for your comments. Yes i am creating up to 15 instances at the moment, as that&#39;s the maximum amount I can get to work, but eventually I&#39;d like to do a&nbsp;lot more. The reason I&#39;ve done them as individual instances is because i am multiplexing it all through 4051B&#39;s as there aren&#39;t enough inputs on the Yun for 32 individual analog&nbsp;inputs.</p>
<p>I have read briefly about continuous sampling, but I haven&#39;t got my head round that yet...as i believe it converts the raw data from the CT&#39;s in a different and less taxing way...(please correct me if I&#39;m wrong and have barked up the wrong tree with that one!haha)</p>
<p>I also read something about Emonlibpro and in the description it says about &quot;any number of voltage and current sensors&quot;. Is this any number above 15?? or again am I reading into this wrong....I&#39;m having a proper research evening tomorrow so I&#39;ll hopefully answer those questions tomorrow.</p>
<p>Both of the above I&#39;ve not had a chance to read into yet, but will so hopefully tomorrow....</p>
<p>I finally read in another post about doing the filtering and DC biasing on the first CT channel and just copy the result into the others (how ever many) which would also seem to save a&nbsp;lot of processing power??</p>
<p>My questions above are why I have posted...im a little lost as into the direction I should follow, and hey, who better to ask than you guys!?</p>
<p>thanks again!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36755"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Multi Channel Current Monitoring </h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 05/12/2015 - 14:54.</div>
    <div class="content">
     <p><i>"Yes i am creating up to 15 instances at the moment..."</i><br />
Ok, if you're certain of that. It looked as if you were generating 30.</p>
<p><i>"I have read briefly about continuous sampling, but I haven't got my head round that yet...as i believe it converts the raw data from the CT's in a different and less taxing way..."</i></p>
<p>I don't know where you got that one from, but I'd say NOT TRUE. In the 'discrete' sketch, the ADC is started and when the result is returned, the loop continues and processes the numbers. It does this for each voltage and current pair for 10 cycles, then gives you the averages over that period. It achieves about 50 sample pairs per cycle. In the 'continuous' sketch, the ADC free-runs and triggers an interrupt at end of each conversion. That starts an ISR (Interrupt Service Routine) that, while the present conversion is under way, sets up the target of the next conversion and processes the result of the last conversion, which the main loop can then pick up and handle. So in fact the processor is working a lot harder, and unless you have a really fast ADC, you won't be able to handle 15 pairs of voltage and current readings at anywhere near a respectable sampling rate.</p>
<p>I know nothing about emonlibpro, so I cannot comment.</p>
<p><i>"I finally read in another post about doing the filtering and DC biasing on the first CT channel and just copy the result into the others (how ever many) which would also seem to save a lot of processing power??"</i><br />
Oh yes, it'll save a bit of processing power. And most likely introduce steps too, which will give you wrong results. Why is the filter there in the first place? The only way to economise there is to provide all the inputs with a common DC bias (see "Op-amp bias" somewhere in Resources), and then you need to run the filter on just one channel and you can subtract the (identical to within the ADC linearity) offset value from each channel. EmonLib does all you need there and it would simply need the common offset to be shared between all the instances. But even so, there's not a lot of processing in the filter.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11750"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-1lBEvGm1JsIMe3KNoXMj5H7ff13SBTONE77hqJGjOiA" value="form-1lBEvGm1JsIMe3KNoXMj5H7ff13SBTONE77hqJGjOiA"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/11750 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:49:42 GMT -->
</html>
