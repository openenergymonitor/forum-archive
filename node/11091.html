<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11091 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:44:28 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonPi beginner question - Use with intermittent network connectivity | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonPi beginner question - Use with intermittent network connectivity</h3>
        <span class="submitted">Submitted by <a href="../user/8549.html" title="View user profile.">alex_london</a> on Sat, 08/08/2015 - 01:12</span>
        <div class="content"><p>Hello all...&nbsp;I only recently acquired myself an emonPi, mostly to tinker, but also to find out more about my energy use habits and hopefully do something about it! But I think I need some assistance or pointers with a few problems I&#39;ve been having...&nbsp;</p>
<p>Initially I set everything up to log to the local emonCMS on the emonPi itself, but the web interface performance was ridiculously slow... understandable, for two reasons... (a) the hardware is obviously not comparable to a desktop pc/workstation let alone a dedicated server, (b) I&nbsp;have the device installed in a location where wifi&nbsp;connectivity seems sketchy at best - so additional latency and packet loss just makes everything seem even slower than it is.</p>
<p>To tackle (a), I installed emonCMS on a local Ubuntu Linux server I have, and so far so good - I directed my feeds to it and it seemed to be doing its thing.</p>
<p>I recently left for a few days, only to return to find the emonPi had lost all connectivity to my wireless network so nothing was being logged to the Linux server. Though strangely the display was showing 50% wifi signal and my DHCP assigned IP address was there too.</p>
<p>In the end I had to restart the emonPi to get it to reconnect, and it seems to be logging again. But it hasn&#39;t logged any of the data that was previously &quot;missed&quot;.</p>
<p>Sorry for the lengthy intro - now for a few questions!</p>
<ol>
<li>Is the data loss&nbsp;expected? I&#39;d imagine there&#39;s a way to have it store data locally and upload once it has restored connectivity to the network?</li>
<li>Also, what if there&#39;s a power loss in the meantime? I do have the local emonCMS configured and my inputs are logging to local feeds - alongside the forwarding I set up to send data to my other server... so the data is there I imagine, it just hasn&#39;t &quot;synchronised&quot;?</li>
<li>How would I force a &quot;sync&quot; of the data, if indeed it has been safely stored locally?</li>
<li>I think the wireless connectivity issue can be resolved with a better wifi dongle, perhaps one with an actual external aerial! I&#39;m using the recommended&nbsp;Edimax&nbsp;EW7811UN - any other models you can vouch for that may have better performance?</li>
</ol>
<p>Looking forward to your comments/suggestions!</p>
<p>-Alex</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11712.html" class="topic-previous" title="Go to previous forum topic">‹ Help Us Install and Record PV energy for remote West African Village</a>
              <a href="11556.html" class="topic-next" title="Go to next forum topic">Energy production during the night. ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-33141"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sat, 08/08/2015 - 09:45.</div>
    <div class="content">
     <p>Hi Alex</p>
<p>1. No, not expected. But there are instances where it is an avoidable or too minimal to warrant the&nbsp;solution. On the emonPi there are 2 parts, emonHub and emonCMS, emonHub will&nbsp;&quot;buffer&quot; data in RAM when it cannot deliver the data until it can but it is not written to disc as is is designed to run on a&nbsp;read-only OS. It will catch up when network is restored if the volatile data is still available&nbsp;ie no restarting, rebooting or power cuts.</p>
<p>2. Yes and No, the data is there in emonCMS to fall back on but unfortunately there is currently no &quot;sync&quot; mechanism, so this is not really a &quot;solution&quot; but an absolute last resort if you really must have that data.</p>
<p>3. You can&#39;t really &quot;sync&quot; at all as they are independent, I&#39;m not saying it cannot be done or that it won&#39;t be available in the future but right now you would need to &quot;figure it out&quot; for each feed based on the circumstance.</p>
<p>4. Not personally, the edimax seems ok most of the time, I do have a couple og external aerial types and I found they didn&#39;t offer any signal improvement or at least if they did it wasn&#39;t significant enough to justify the ugly protrusion and/or additional drivers.</p>
<p>Are you sure the network connection was permanently lost in this instance? how did you establish there was no network connection or was it assumed from&nbsp;lack of data?</p>
<p>Generally speaking if there is a network outage, emonhub&nbsp;will buffer OR if there is a powercut&nbsp;the Pi is read-only OS, emoncms&nbsp;normally only&nbsp;buffers 1minuite&nbsp;of data&nbsp;and it is usual to assume there are no power readings during&nbsp;a power outage, at least for the usual short interruptions this doesn&#39;t present a big issue.</p>
<p>Getting a power cut after an extended network outage would be unlucky but if a frequent occurrence then perhaps a UPS and/or wired network connection could be on the cards?&nbsp;&nbsp;</p>
<p>The crux of the issue here will be&nbsp;the wifi connectivity, if you can ensure the network reconnects after being down&nbsp;you should be ok, can you test that scenario? the emonPi should be running a check and reconnect script as far as I recall.</p>
<p>Paul</p>
<p>&nbsp;&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33152"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8549.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="alex_london&#039;s picture" title="alex_london&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/8549.html" title="View user profile.">alex_london</a> on Sat, 08/08/2015 - 23:26.</div>
    <div class="content">
     <p>Thanks Paul, that clarifies a few things for me.&nbsp;</p>
<p>On further analysis&nbsp;I think the problem may be&nbsp;my wifi&nbsp;configuration in wpa_supplicant.conf. There were a number of free/open networks listed in there which must have been added during initial setup of the emonPi. This is just an educated guess, but I think&nbsp;what happened was that when it lost signal to my access point, it switched to one of the open networks, but that meant it was obviously no longer on my local network. It never came back as the open networks must have a stronger signal than mine.</p>
<p>I&#39;ve cleaned up the file now and will see how that works - I&#39;ll simulate a few wifi outages by powering off my access point a few hours at a time and see what happens.</p>
<p>&nbsp;</p>
<p>This is probably a point for a new post, but one other thing I&#39;m trying is to limit the wlan interface rate to reduce packet loss and get a better signal to noise ratio. But it doesn&#39;t seem to take any of my settings:</p>
<p>List available and current rates:</p>
<pre>
root@emonpi:~# iwlist wlan0 bitrate
wlan0     4 available bit-rates :
          1 Mb/s
          2 Mb/s
          5.5 Mb/s
          11 Mb/s
          Current Bit Rate:65 Mb/s</pre><p>Set rate:</p>
<pre>
root@emonpi:~# iwconfig wlan0 rate 5.5M fixed</pre><p>List again (<em>note there is no change in the current rate</em>):</p>
<pre>
root@emonpi:~# iwlist wlan0 bitrate
wlan0     4 available bit-rates :
          1 Mb/s
          2 Mb/s
          5.5 Mb/s
          11 Mb/s
          Current Bit Rate:65 Mb/s</pre><p>I have tried all listed options, as well as other unlisted ones.&nbsp;Not sure if this is a limitation of the Edimax&nbsp;dongle/drivers or something else is going on...</p>
<p>You&#39;re right that a wired network connection is probably the way to go longer term, however there are a few other things that need to get done in the house first before I can do this! So for the short-to-medium term wifi is unfortunately the only way I can connect...</p>
<p>-Alex</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33167"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Sun, 09/08/2015 - 15:57.</div>
    <div class="content">
     <p>I tried this and got the same result, a quick web search seems to suggest the bitrate &quot;limit&quot; must be set prior to connection for each connection, so ideally you need to add a setting to one of&nbsp;the wifi&nbsp;conf files but I found no guides or examples of that.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33562"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8585.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Aceshigh84&#039;s picture" title="Aceshigh84&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/8585.html" title="View user profile.">Aceshigh84</a> on Sun, 23/08/2015 - 22:05.</div>
    <div class="content">
     <p>I have experienced a similar problem as the OP today.</p>
<p>The emonPi lost Wi-Fi at approximately 07:00 this morning (I didn't realise until 18:30 when I returned home). I pulled the edimax usb dongle and reinserted it, then Wi-Fi was restored. The local emonCMS has kept on tracking grid &amp; solar, but web emonCMS now has a gap in data for the complete day. As I didn't power cycle the emonPi, I fully expected it to upload to web emonCMS when Wi-Fi was restored.</p>
<p>How can I get the day's data to web emonCMS?</p>
<p>Cheers!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33564"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/6518.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="JD&#039;s picture" title="JD&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/6518.html" title="View user profile.">JD</a> on Mon, 24/08/2015 - 06:32.</div>
    <div class="content">
     <p>I don&#39;t have any idea how to get data from the local emonCMS to emoncms.org.</p>
<p>However, I have a few Raspberry Pi&#39;s in remote locations and have fought to keep them connected using various wifi dongles. &nbsp;The following solution has kept them online for about 6 months straight:</p>
<p>1. Install the script&nbsp;&quot;WiFi_Check&quot; from here:</p>
<p><a href="https://rpi.tnet.com/project/scripts/wifi_check" title="https://rpi.tnet.com/project/scripts/wifi_check">https://rpi.tnet.com/project/scripts/wifi_check</a></p>
<p>2. &nbsp;Install a modification to the script to ping the router to check for wifi connectivity. &nbsp;If no router response, then restart wifi services. &nbsp;Be sure to enter your router&#39;s address in the appropriate place.&nbsp;</p>
<p>Step 1: &nbsp;Open the&nbsp;config file in an editor:</p>
<p>sudo nano /usr/local/bin/WiFi_Check</p>
<p>Step 2: &nbsp;Replace everything below # Settings with the code below:</p>
<pre>
##################################################################
# Settings
# Where and what you want to call the Lockfile
lockfile=&#39;/var/run/WiFi_Check.pid&#39;
# Which Interface do you want to check/fix
wlan=&#39;wlan0&#39;
# Which address do you want to ping to see if you can connect
pingip=&#39;192.168.1.1&#39;

##################################################################

echo
echo &quot;Starting WiFi check for $wlan&quot;
date
echo 

# Check to see if there is a lock file

if [ -e $lockfile ]; then
    # A lockfile exists... Lets check to see if it is still valid
    pid=`cat $lockfile`
    if kill -0 &amp;&gt;1 &gt; /dev/null $pid; then
        # Still Valid... lets let it be...
        #echo &quot;Process still running, Lockfile valid&quot;
        exit 1

    else

        # Old Lockfile, Remove it
        #echo &quot;Old lockfile, Removing Lockfile&quot;
        rm $lockfile
    fi
fi

# If we get here, set a lock file using our current PID#

#echo &quot;Setting Lockfile&quot;
echo $$ &gt; $lockfile

# We can perform check
echo &quot;Performing Network check for $wlan&quot;

/bin/ping -c 2 -I $wlan $pingip &gt; /dev/null 2&gt; /dev/null

if [ $? -ge 1 ] ; then
    echo &quot;Network connection down! Attempting reconnection.&quot;
    /sbin/ifdown $wlan
    sleep 5
    /sbin/ifup --force $wlan
else
    echo &quot;Network is Okay&quot;   

fi

# Check is complete, Remove Lock file and exit
#echo &quot;process is complete, removing lockfile&quot;
rm $lockfile

exit 0

##################################################################

# End of Script</pre>         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33614"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 25/08/2015 - 23:51.</div>
    <div class="content">
     <p>There is already some sort of wi-fi reconnection script running on the emonPi, I haven&#39;t looked closely at it but I think it&#39;s cron based.</p>
<p>@Aceshigh84 - I took a closer look at the emon-pi&nbsp;variant of emonhub&#39;s&nbsp;code as there definitely&nbsp;shouldn&#39;t be any gaps in the data, or so I thought. It turns out there are significant differences in the code&nbsp;in the way&nbsp;emoncms&nbsp;data is passed by http. It appears this version does not resubmit data if undelivered, it seems to just send and forget every 30secs&nbsp;(hardcoded&nbsp;interval not from conf) it deletes the data regardless of whether is is sent or confirmed.</p>
<p>Apparently&nbsp;this version does not provide any buffering beyond 30secs.</p>
<p>@alex_london - I hope you have email notifications on as the info I have given you above is incorrect for this version. I had no idea at the time and cannot explain why the controlled&nbsp;FIFO&nbsp;buffers have been removed, sorry.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-33625"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8549.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="alex_london&#039;s picture" title="alex_london&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/8549.html" title="View user profile.">alex_london</a> on Wed, 26/08/2015 - 11:12.</div>
    <div class="content">
     <p>@JD - thanks. I&#39;ll try out that script when I get a chance, probably this weekend. Have also considered going down the powerline route and get a small brick to give it an ethernet connection. But if this script works, it&#39;ll save some money for sure!</p>
<p>@paul - yes I&#39;ve been keeping an eye on this thread... the missing data is no big deal, it&#39;s not that lives depend on it! Was more of a curiosity for me, trying to understand how it&#39;s supposed to work.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36878"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9108.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-9108.jpg" alt="ChrisValentine&#039;s picture" title="ChrisValentine&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi beginner question - Use with intermittent network connectivity</h3>

    <div class="submitted">Submitted by <a href="../user/9108.html" title="View user profile.">ChrisValentine</a> on Wed, 09/12/2015 - 14:50.</div>
    <div class="content">
     <p>I&#39;m getting weak wifi issues too - am going to try moving the wifi dongle away from the emonPi using a USB extension cable.</p>
<p>But the unit does really need to buffer in some way to avoid discontinuity caused by a drop of Internet connection.</p>
<p>Chris.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11091"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-nkGzxlmNA0UAKig1Ly10PVsoRMJ-ih1HhjQQ60pq7Xg" value="form-nkGzxlmNA0UAKig1Ly10PVsoRMJ-ih1HhjQQ60pq7Xg"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/11091 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:44:28 GMT -->
</html>
