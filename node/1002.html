<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Mk2 PV controller + emonTX + LCD display | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/emon/sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="/emon/modules/node/node.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/system/defaults.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/system/system.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/system/system-menus.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/user/user.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/sites/all/modules/mollom/mollom.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/forum/forum.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/sites/all/modules/views/css/views.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/modules/comment/comment.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="/emon/sites/all/themes/emon3/style.css?r" />
<style type="text/css" media="all">@import "/emon/sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="/emon/" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="/emon/">Home</a> » <a href="/emon/forum">Forums</a> » <a href="/emon/forum/4">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Mk2 PV controller + emonTX + LCD display</h3>
        <span class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Thu, 30/08/2012 - 22:49</span>
        <div class="content"><p>Finally got it working, combining Robin&#39;s Mk2 code, with eMonTx and an LCD display.</p>
<p>Still some problems with the current measurements, but so far so good.</p>
<p>Ignore the very messy wiring!!!</p>
<p>Video of the device in operation....</p>
<p><a href="http://youtu.be/DFJP4T8GAo8" title="http://youtu.be/DFJP4T8GAo8">http://youtu.be/DFJP4T8GAo8</a></p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="/emon/node/1200" class="topic-previous" title="Go to previous forum topic">‹ emonTx + 2x Elster meters</a>
              <a href="/emon/node/1112" class="topic-next" title="Go to next forum topic">RESOLVED - Emonbase NanodeRF DHCP issues ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-6001"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/238" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/238" title="View user profile.">Paul Reed</a> on Thu, 30/08/2012 - 22:58.</div>
    <div class="content">
     <p>&nbsp;Nice work Stuart.</p>
<p>When you say 'finally', have you had problems? &nbsp;- &nbsp;I haven't been keeping up with the forum recently :(</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6004"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Fri, 31/08/2012 - 08:21.</div>
    <div class="content">
     <p>I've had to re-write Robin's code to use interrupt handlers and thats been causing problems.&nbsp; I've also spent time minimising the phase difference between voltage + current samples in the circuit.</p>
<p>I've still got issues with the emonTX side of the code not measuring current properly, and at the moment I've no idea why!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6038"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Tue, 04/09/2012 - 08:11.</div>
    <div class="content">
     <p>I've published my working code for all this on github.</p>
<p><a href="https://github.com/stuartpittaway/ArduinoSolarPowerController" title="https://github.com/stuartpittaway/ArduinoSolarPowerController">https://github.com/stuartpittaway/ArduinoSolarPowerController</a></p>
<p>&nbsp;</p>
<p>Features:</p>
<p>1. emonTx features monitoring of current and voltage</p>
<p>2. Solar PV power divert (as per Mk2 PV&nbsp;controller)</p>
<p>3. Output to LCD display</p>
<p>4. Interrupt driven reading of samples + PV power divert</p>
<p>&nbsp;</p>
<p>I'll publish the circuit diagram once I've moved it over to stripboard.</p>
<p>In breif, I'm using an OpAmp gain on the CT readings to monitor current.&nbsp; Mascot AC adapter to measure voltage, which is also driven through an OpAmp comparitor circuit to detect positive zero cross detections which then fire hardware interrupt 1.</p>
<p>Once a zero cross has been detected, a second interrupt is setup to read samples from the wave form at set time intervals.&nbsp; I find reading 50-75 samples per full AC wave gives good readings.</p>
<p>On the next zero cross, the previous samples are used to drive the solar pv power divert logic.&nbsp; The eMonTx readings are taken every half second using the average of 25 wave form readings.</p>
<p>Because of the interrupt driven nature of the code/circuit, the main loop() of the code simply outputs things to serial or the LCD screen and doesn't need to worry about affecting the timing of the readings.</p>
<p>I'm going to attempt to put in the RFM12 module, and adjustable OpAmp gain with bilateral switches.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6041"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/1163" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-1163.gif" alt="markcarter10&#039;s picture" title="markcarter10&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/1163" title="View user profile.">markcarter10</a> on Tue, 04/09/2012 - 09:24.</div>
    <div class="content">
     <p>Great stuff !</p>
<p>Just what we are looking for?</p>
<p>Do you need an addition CT?</p>
<p>Look forward to your circuit details</p>
<p>&nbsp;</p>
<p>regards</p>
<p>MarkCarter10</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6042"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Tue, 04/09/2012 - 10:45.</div>
    <div class="content">
     <p>At the moment, I'm not directly measuring PV&nbsp;power using a seperate CT.</p>
<p>Although I think theres time/room to add it into the code.</p>
<p>Might have problems with EMMA patent then though <img src="http://openenergymonitor.org/emon/sites/all/modules/fckeditor/fckeditor/editor/images/smiley/msn/devil_smile.gif" alt="" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6046"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Tue, 04/09/2012 - 21:22.</div>
    <div class="content">
     <p>&nbsp;Just started putting the circuit diagram together using CircuitLab, great site only just started using it today!</p>
<p><a href="https://www.circuitlab.com/circuit/38t8ey/emontx-with-solar-and-lcd/">https://www.circuitlab.com/circuit/38t8ey/emontx-with-solar-and-lcd/</a></p>
<p>You can also run circuit simulation to see the waveforms - all from your web browser.</p>
<p><img width="540" height="405" border="1" src="https://www.circuitlab.com/circuit/38t8ey/screenshot/540x405/" alt="" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6062"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/1163" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-1163.gif" alt="markcarter10&#039;s picture" title="markcarter10&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/1163" title="View user profile.">markcarter10</a> on Wed, 05/09/2012 - 14:34.</div>
    <div class="content">
     <p>Thanks Stuart</p>
<p>Circuit Lab does a great job!</p>
<p>Do you think your code will work using Robins MKII circuit? (unmodified)</p>
<p>I see you have more filtering and&nbsp; voltage stabilization on the 2.5v ref rail, and an opamp on the ac ref circuit</p>
<p>&nbsp;</p>
<p>As you are&nbsp;using EmonTX are there any pin differences with Arduino Uno?&nbsp;</p>
<p>&nbsp;</p>
<p>regards</p>
<p>&nbsp;</p>
<p>Mark</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6063"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Wed, 05/09/2012 - 16:06.</div>
    <div class="content">
     <p>I'm not using emonTx or an Arduino board, simply the ATMEGA328P chip on breadboard!</p>
<p>I'm trying to use the newer features from emonTX-SMT but without the SMT parts !!</p>
<p>Additionally, running at 3.3v is not important to me as this is going to be run from the mains 24x7.</p>
<p>The code may work with Robin's MKII circuit, you'll just have to check the calibration values to get accurate readings, and you will need someway to do hardware phase calibration, otherwise the PHASECAL&nbsp;values will be large 2+ which makes for bad readings. Thats what the registor/capacitor combination are doing in the bottom right of my diagram.</p>
<p>Additionally, I'm using interrupts which need to be triggered from a zero crossing so some sort of detector is needed for this.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6064"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/1163" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-1163.gif" alt="markcarter10&#039;s picture" title="markcarter10&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/1163" title="View user profile.">markcarter10</a> on Wed, 05/09/2012 - 16:47.</div>
    <div class="content">
     <p>Thanks</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6085"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Thu, 06/09/2012 - 21:13.</div>
    <div class="content">
     <p>Amazingly I've now got RFM12B working with this circuit + code, transmitting the values over the air.</p>
<p>I made a stripboard version of this <a href="http://jeelabs.com/products/rfm12b-board">http://jeelabs.com/products/rfm12b-board</a></p>
<p>All working on a couple of prototype/breadboards - amazing&nbsp;!</p>
<p>I'm getting VERY&nbsp;short of spare digital pins now though, and need a couple for the OpAmp gain pins.</p>
<p>&nbsp;<img width="150" height="371" alt="" src=" http://s15.postimage.org/i8q0dj0qz/2012_09_06_21_59_50.jpg" /></p>
<p><img width="300" height="395" alt="" src="http://s8.postimage.org/ugw5g9w05/2012_09_06_21_58_29.jpg" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6149"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Wed, 12/09/2012 - 07:52.</div>
    <div class="content">
     <p>Looked at the Fritzing software last night and came up with this layout (needs a tidy up!) the software is clever in that it will turn this into a scematic and also a PCB layout - almost automatically.</p>
<p><a href="http://fritzing.org/">http://fritzing.org/</a></p>
<p>&nbsp;</p>
<p>The Fritzing layout file is on GITHUB if anyone ones it <a href="https://github.com/stuartpittaway/ArduinoSolarPowerController">github.com/stuartpittaway/ArduinoSolarPowerController</a></p>
<p>&nbsp;</p>
<p><img width="901" height="394" border="1" src="https://github.com/stuartpittaway/ArduinoSolarPowerController/blob/master/ArduinoeMonTXSolar_bb.png?raw=true" alt="" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6204"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robin&#039;s picture" title="Robin&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by Robin (not verified) on Mon, 17/09/2012 - 18:16.</div>
    <div class="content">
     <p class="western" style="margin-bottom: 0cm">Stuart, LM358 is not suitable for feeding the ADC as the output will not swing high enough. The datasheet is not very forthcoming on this, quoting results only for a 30V supply (28V max). An older datasheet I saw specified high level output voltage as Vcc &ndash; 1.5. This means that on a 5V supply the output will not go much above 3.5V, which will severely compromise the ADC measurements.</p>
<p class="western" style="margin-bottom: 0cm">LM358 is good for generating the 2.5V rail and for feeding digital inputs, but not for feeding the ADC!</p>
<p class="western" style="margin-bottom: 0cm">I carried out some measurements on several opamps to measure the minimum and maximum output voltage, as well as the ADC measurements from an Arduino. The circuit was a unity gain inverting amp, with the 2.5V reference coming from a 2.5V rail as per your circuit. All the resistors were 100k<font face="Times New Roman, serif">&Omega;</font><font face="Times New Roman, serif">. The supply voltage was measured as 5.04V.</font></p>
<p class="western" style="margin-bottom: 0cm">&nbsp;</p>
<div class="western" style="margin-bottom: 0cm;">
	opamp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; min out&nbsp; ADC&nbsp;&nbsp;&nbsp;&nbsp; max out&nbsp; ADC</div>
<div class="western" style="margin-bottom: 0cm;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; V&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; min&nbsp;&nbsp;&nbsp; &nbsp; V&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; max</div>
<div class="western" style="margin-bottom: 0cm;">
	OP295&nbsp;&nbsp;&nbsp;&nbsp; 0.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5.04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1023</div>
<div class="western" style="margin-bottom: 0cm;">
	MC33204 0.12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4.37&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 893</div>
<div class="western" style="margin-bottom: 0cm;">
	LM358&nbsp;&nbsp;&nbsp;&nbsp; 0.063&nbsp;&nbsp;&nbsp;&nbsp; 10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3.76&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 764</div>
<div class="western" style="margin-bottom: 0cm;">
	OP279&nbsp;&nbsp;&nbsp;&nbsp; 0.019&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1021</div>
<div class="western" style="margin-bottom: 0cm;">
	TS912&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.023 &nbsp; &nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5.04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1023</div>
<p class="western" style="margin-bottom: 0cm">As you can see, the maximum ADC reading from the LM358 was 764, obviously unacceptable.</p>
<p class="western" style="margin-bottom: 0cm">First prize went to the OP295, with the full range of ADC outputs all the way from 0 to 1023. Unfortunately, OP295s seem to be becoming scarce and expensive. However, OP279 and TS912 both give very good results, and some are available on ebay.</p>
<p class="western" style="margin-bottom: 0cm">It is worth noting that with the opamp in the inverting mode, the full range on the ADC will only be obtained if the 2.5V rail is precisely half way between the rails. If the resistor tolerance is 1%, you might expect to lose around 10 counts at one or other end of the scale. I had an old batch of 1% resistors that were very consistent, all the resistances were identical. With the 5V rail measuring 5.04V, the 2.5V measured 2.52V, which is very good. However, a new batch of 100k<font face="Times New Roman, serif">&Omega;</font> resistors I bought recently on ebay are less consistent. The first two I picked gave 2.54V on the 2.5V rail &ndash; still within tolerance, but not as good.</p>
<p class="western" style="margin-bottom: 0cm">Oh, and before I forget, many thanks to calypso_rae and stuart for publishing this excellent work. I intend to start building one soon.</p>
<p class="western" style="margin-bottom: 0cm">&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6206"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="pmcalli&#039;s picture" title="pmcalli&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by pmcalli (not verified) on Mon, 17/09/2012 - 19:21.</div>
    <div class="content">
     <p>Stuart the 2.5V reference in your circuit is shown as driving 100nF its only specified&nbsp; for 50pF so may have a tendency to oscillate. you can run without the op amp but only if you have a large cap ( 100uF ) across r2 and drop the values of r1 and r2 to 10k otherwise the adc inputs cross talk due to insufficient drive to charge the sample and hold in the time allowed.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6207"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Mon, 17/09/2012 - 20:47.</div>
    <div class="content">
     <p>Thanks for your comments folks:</p>
<p>Robin, I was simply using the LM358 as I had a bunch of them!&nbsp;</p>
<p>Just noticied the AVR reference notes are using the LMV358 (<a href="http://www.atmel.com/Images/doc2566.pdf" title="http://www.atmel.com/Images/doc2566.pdf">http://www.atmel.com/Images/doc2566.pdf</a>)&nbsp; which seems to be a rail to rail opamp.</p>
<p>&nbsp;</p>
<p>I could also run the ADC at a lower reference voltage - 1.1volt for instance and still retain the full scale output from the LM358 ?</p>
<p>&nbsp;</p>
<p>pmcalli: Thanks for the feedback, you say run without the OpAmp - are you referring to a simple split resistor network instead ?</p>
<p>&nbsp;</p>
<p>Given the above comments, I&#39;m surprised its working as well as it does :-)</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6211"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robin&#039;s picture" title="Robin&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by Robin (not verified) on Tue, 18/09/2012 - 11:05.</div>
    <div class="content">
     <p>Stuart, if the purpose of the 100nF is to stablise the 2.5V rail, it might be better to connect it to the junction of R1 and R2.&nbsp; I have seen this arrangement used elsewhere.</p>
<p>Please can I ask a question about the zero crossing detector?&nbsp;&nbsp;&nbsp; I see that on the input R11 and R12 are 10k and 12k, so there is an offset from 2.5V.&nbsp; What is the thinking behind this please, and were any calculations involved?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6212"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robin&#039;s picture" title="Robin&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by Robin (not verified) on Tue, 18/09/2012 - 11:05.</div>
    <div class="content">
     <p>Stuart, if the purpose of the 100nF is to stablise the 2.5V rail, it might be better to connect it to the junction of R1 and R2.&nbsp; I have seen this arrangement used elsewhere.</p>
<p>Please can I ask a question about the zero crossing detector?&nbsp;&nbsp;&nbsp; I see that on the input R11 and R12 are 10k and 12k, so there is an offset from 2.5V.&nbsp; What is the thinking behind this please, and were any calculations involved?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6213"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Tue, 18/09/2012 - 11:10.</div>
    <div class="content">
     <p>Robin, if you look at the zero crossing detector on the breadboard, Im using a variable trimmer pot, and the OpAmp as a comparator, the trimmer then sets when the interrupt fires.</p>
<p>You don&#39;t actually want the interrupt firing at the exact time of zero cross, it needs to be slightly before this so the interrupt can then begin its reading and do some logic before the new sine wave starts.&nbsp; I configured this pot by watching the VZerocross value output in the serial window and trying to get as near to 512 as I could.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6214"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="pmcalli&#039;s picture" title="pmcalli&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by pmcalli (not verified) on Tue, 18/09/2012 - 11:24.</div>
    <div class="content">
     <p>Thanks for the feedback, you say run without the OpAmp - are you referring to a simple split resistor network instead ?</p>
<p>Single resistor network of 2x10K&nbsp;and an FBC of 100uF&nbsp;across bottom one. It takes up same space and cost is about the same.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6370"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Wed, 26/09/2012 - 09:38.</div>
    <div class="content">
     <p>On the comments about selection of OpAmp, LM358 its mentioned that the output never goes above the top rail voltage-1.5v.</p>
<p>If I leave the OpAmp running at 5v, and then run the rest of the circuit from 3.3v (which also keeps the RFM12B happy) then I can get a much better range on the ADC, of 0.06v to 3.3v based on the numbers given above.</p>
<p>My DC bias circuit would then have to output about 1.6v to keep everything aligned.</p>
<p>I&#39;ve got a box full of LM358&#39;s so I&#39;d like to use them :-) but on a more realistic point, they are cheap to buy and easy to find.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6447"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="Robin&#039;s picture" title="Robin&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by Robin (not verified) on Sun, 30/09/2012 - 12:12.</div>
    <div class="content">
     <p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">I would like to suggest a method of measuring mains voltage that offers a different trade-off between the (conflicting) requirements.</font></p>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">This one offers the following advantages:</font></p>
<ol>
<li>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">It is accurate.</font></p>
</li>
<li>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">It is safe if properly constructed.</font></p>
</li>
<li>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">It offers over-voltage protection up to 1000V.</font></p>
</li>
<li>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">It does not require a separate transformer.</font></p>
</li>
<li>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">It is reasonably cheap. The most expensive component is a TS912 opamp, available from RS in a DIL package at under &pound;2. (LMV358 is also suitable.)</font></p>
</li>
<li>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">The circuit can still be connected to an LCD or a computer for monitoring.</font></p>
</li>
</ol>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">The disadvantage is that it involves making direct connections to the mains, but we have to do that already if we are making a mains controller, so I don&#39;t see that as a disadvantage. When you look at the problem, you find that two small pieces of heatshrink sleeving are all that is required to make the system completely safe. However, all the usual precautions must be applied!</font></p>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">I have built this circuit and tested it on a breadboard, measuring the mains voltage waveform using the Arduino ADC. Full details are here.</font> <a href="http://openenergymonitor.org/emon/node/1105">http://openenergymonitor.org/emon/node/1105</a></p>
<p class="western" style="margin-bottom: 0cm"><font face="Arial, sans-serif">An LTSpice simulation was used to test the system and check that it is not damaged by high voltages. Further tests also checked that the circuit measures only mains voltage, and that any voltage between neutral and earth is filtered out. For this test there is 50V at 48z on the mains neutral line for this purpose. The circuit can be seen to measure only the 240V AC mains voltage &ndash; the voltage on neutral is filtered out. A screenshot of the simulation is shown on the attachment below.</font></p>
<p class="western" style="margin-bottom: 0cm">One more thing: Stuart, your method of running the Arduino at 3.3V and an LM358 at 5V looks good, and may be an improvement over what I have done here.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6627"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Thu, 11/10/2012 - 10:23.</div>
    <div class="content">
     <p>Last night I finally got around the building the OpAmp circuit using a 3.3v regulator as the signal voltage.</p>
<p>So I have 3.3v going to the AREF on the ATMEL chip, 3.3v then runs to a voltage divider, giving 1.65v centre to the current and voltage sensor circuits.</p>
<p>Even when run through the op-amp, the signal is no longer clipped and the range on the arduino is very good.</p>
<p>Had to set analogReference(EXTERNAL) in the code to make it work.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6719"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/1774" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-1774.jpg" alt="PaulOckenden&#039;s picture" title="PaulOckenden&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/1774" title="View user profile.">PaulOckenden</a> on Tue, 16/10/2012 - 20:14.</div>
    <div class="content">
     <p>How&#39;s the project going? Any more progress?</p>
<p>Have you sorted the problems you mentioned at the start moving to an interrupt driven code structure?</p>
<p>Really keen to see how this one goes!</p>
<p>P.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6732"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Wed, 17/10/2012 - 08:29.</div>
    <div class="content">
     <p>Yes the interrupt code is working fine, I&#39;ve not had much time to move from a breadboard working prototype to something more permanent - probably stripboard in my case.</p>
<p>I&#39;ve added a 3.3v regulator to the circuit, and now looking at how to add a variable op-amp gain using similar circuit to the emontxSMT from this site.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6733"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/1774" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/pictures/picture-1774.jpg" alt="PaulOckenden&#039;s picture" title="PaulOckenden&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/1774" title="View user profile.">PaulOckenden</a> on Wed, 17/10/2012 - 09:17.</div>
    <div class="content">
     <p>Cool. I&#39;m wondering at what stage I should jump in!</p>
<p>Do you think you&#39;re there yet? Are the Github/Fritzing&nbsp;locations up to date?</p>
<p>Sorry to be a pain!</p>
<p>P.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-6736"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="/emon/user/450" title="View user profile."><img src="http://openenergymonitor.org/emon/sites/default/files/imagecache/avatar/default_0.png" alt="stuart&#039;s picture" title="stuart&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Mk2 PV controller + emonTX + LCD display</h3>

    <div class="submitted">Submitted by <a href="/emon/user/450" title="View user profile.">stuart</a> on Wed, 17/10/2012 - 11:49.</div>
    <div class="content">
     <p>The diagrams/Fritzing are old now, although they do work.</p>
<p>The Github is up-to-date, and works fine if you just want standard emontx+mk2 pv without the Opamp gain stuff.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="/emon/node/1002"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-6sn0hSX9KCgGXQNA-AfkZSoPUoIL8yxvzUpHNGRLh6k" value="form-6sn0hSX9KCgGXQNA-AfkZSoPUoIL8yxvzUpHNGRLh6k"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org">https://community.openenergymonitor.org</a></p>
   
</div>

<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
