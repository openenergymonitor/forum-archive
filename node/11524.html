<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11524 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:13:53 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>LED pulse sensor with Arduino-like board | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">LED pulse sensor with Arduino-like board</h3>
        <span class="submitted">Submitted by <a href="../user/8960.html" title="View user profile.">alexsh1</a> on Wed, 04/11/2015 - 16:29</span>
        <div class="content"><p>Hello,</p>
<p>&nbsp;</p>
<p>I am trying to use the optical pulse sensor</p>
<p><a href="https://learn.openenergymonitor.org/?redirect=opticalpulsesensor" title="http://openenergymonitor.org/emon/buildingblocks/opticalpulsesensor">http://openenergymonitor.org/emon/buildingblocks/opticalpulsesensor</a></p>
<p>​with Arduino-like module - sensebender&nbsp;-&gt;&nbsp;http://www.mysensors.org/hardware/micro</p>
<p>I am having troubles making this sensor work with the sketch from MySensors:</p>
<blockquote><p>/**<br />
&nbsp;* The MySensors Arduino library handles the wireless radio link and protocol<br />
&nbsp;* between your home built sensors/actuators and HA controller of choice.<br />
&nbsp;* The sensors forms a self healing radio network with optional repeaters. Each<br />
&nbsp;* repeater and gateway builds a routing tables in EEPROM which keeps track of the<br />
&nbsp;* network topology allowing messages to be routed to nodes.<br />
&nbsp;*<br />
&nbsp;* Created by Henrik Ekblad &lt;henrik.ekblad@mysensors.org&gt;<br />
&nbsp;* Copyright (C) 2013-2015 Sensnology AB<br />
&nbsp;* Full contributor list: <a href="https://github.com/mysensors/Arduino/graphs/contributors" title="https://github.com/mysensors/Arduino/graphs/contributors">https://github.com/mysensors/Arduino/graphs/contributors</a><br />
&nbsp;*<br />
&nbsp;* Documentation: <a href="http://www.mysensors.org/" title="http://www.mysensors.org">http://www.mysensors.org</a><br />
&nbsp;* Support Forum: <a href="http://forum.mysensors.org/" title="http://forum.mysensors.org">http://forum.mysensors.org</a><br />
&nbsp;*<br />
&nbsp;* This program is free software; you can redistribute it and/or<br />
&nbsp;* modify it under the terms of the GNU General Public License<br />
&nbsp;* version 2 as published by the Free Software Foundation.<br />
&nbsp;*<br />
&nbsp;*******************************<br />
&nbsp;*<br />
&nbsp;* REVISION HISTORY<br />
&nbsp;* Version 1.0 - Henrik EKblad<br />
&nbsp;*&nbsp;<br />
&nbsp;* DESCRIPTION<br />
&nbsp;* This sketch provides an example how to implement a distance sensor using HC-SR04&nbsp;<br />
&nbsp;* Use this sensor to measure KWH and Watt of your house meeter<br />
&nbsp;* You need to set the correct pulsefactor of your meeter (blinks per KWH).<br />
&nbsp;* The sensor starts by fetching current KWH value from gateway.<br />
&nbsp;* Reports both KWH and Watt back to gateway.<br />
&nbsp;*<br />
&nbsp;* Unfortunately millis() won&#39;t increment when the Arduino is in&nbsp;<br />
&nbsp;* sleepmode. So we cannot make this sensor sleep if we also want&nbsp;<br />
&nbsp;* to calculate/report watt-number.<br />
&nbsp;* <a href="http://www.mysensors.org/build/pulse_power" title="http://www.mysensors.org/build/pulse_power">http://www.mysensors.org/build/pulse_power</a><br />
&nbsp;*/</p>
<p>#include &lt;SPI.h&gt;<br />
#include &lt;MySensor.h&gt; &nbsp;</p>
<p>#define DIGITAL_INPUT_SENSOR 3 &nbsp;// The digital input you attached your light sensor. &nbsp;(Only 2 and 3 generates interrupt!)<br />
#define PULSE_FACTOR 1000 &nbsp; &nbsp; &nbsp; // Nummber of blinks per KWH of your meeter<br />
#define SLEEP_MODE false &nbsp; &nbsp; &nbsp; &nbsp;// Watt-value can only be reported when sleep mode is false.<br />
#define MAX_WATT 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Max watt value to report. This filetrs outliers.<br />
#define INTERRUPT DIGITAL_INPUT_SENSOR-2 // Usually the interrupt = pin -2 (on uno/nano anyway)<br />
#define CHILD_ID 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Id of the sensor child<br />
unsigned long SEND_FREQUENCY = 20000; // Minimum time between send (in milliseconds). We don&#39;t wnat to spam the gateway.<br />
MySensor gw;<br />
double ppwh = ((double)PULSE_FACTOR)/1000; // Pulses per watt hour<br />
boolean pcReceived = false;<br />
volatile unsigned long pulseCount = 0; &nbsp;&nbsp;<br />
volatile unsigned long lastBlink = 0;<br />
volatile unsigned long watt = 0;<br />
unsigned long oldPulseCount = 0; &nbsp;&nbsp;<br />
unsigned long oldWatt = 0;<br />
double oldKwh;<br />
unsigned long lastSend;<br />
MyMessage wattMsg(CHILD_ID,V_WATT);<br />
MyMessage kwhMsg(CHILD_ID,V_KWH);<br />
MyMessage pcMsg(CHILD_ID,V_VAR1);</p>
<p>
void setup() &nbsp;<br />
{ &nbsp;<br />
&nbsp; gw.begin(incomingMessage);</p>
<p>&nbsp; // Send the sketch version information to the gateway and Controller<br />
&nbsp; gw.sendSketchInfo(&quot;Energy Meter&quot;, &quot;1.0&quot;);</p>
<p>&nbsp; // Register this device as power sensor<br />
&nbsp; gw.present(CHILD_ID, S_POWER);</p>
<p>&nbsp; // Fetch last known pulse count value from gw<br />
&nbsp; gw.request(CHILD_ID, V_VAR1);<br />
&nbsp;&nbsp;<br />
&nbsp; attachInterrupt(INTERRUPT, onPulse, RISING);<br />
&nbsp; lastSend=millis();<br />
}</p>
<p>
void loop() &nbsp; &nbsp;&nbsp;<br />
{&nbsp;<br />
&nbsp; gw.process();<br />
&nbsp; unsigned long now = millis();<br />
&nbsp; // Only send values at a maximum frequency or woken up from sleep<br />
&nbsp; bool sendTime = now - lastSend &gt; SEND_FREQUENCY;<br />
&nbsp; if (pcReceived &amp;&amp; (SLEEP_MODE || sendTime)) {<br />
&nbsp; &nbsp; // New watt value has been calculated &nbsp;<br />
&nbsp; &nbsp; if (!SLEEP_MODE &amp;&amp; watt != oldWatt) {<br />
&nbsp; &nbsp; &nbsp; // Check that we dont get unresonable large watt value.&nbsp;<br />
&nbsp; &nbsp; &nbsp; // could hapen when long wraps or false interrupt triggered<br />
&nbsp; &nbsp; &nbsp; if (watt&lt;((unsigned long)MAX_WATT)) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; gw.send(wattMsg.set(watt)); &nbsp;// Send watt value to gw&nbsp;<br />
&nbsp; &nbsp; &nbsp; } &nbsp;<br />
&nbsp; &nbsp; &nbsp; Serial.print(&quot;Watt:&quot;);<br />
&nbsp; &nbsp; &nbsp; Serial.println(watt);<br />
&nbsp; &nbsp; &nbsp; oldWatt = watt;<br />
&nbsp; &nbsp; }<br />
&nbsp;&nbsp;<br />
&nbsp; &nbsp; // Pulse cout has changed<br />
&nbsp; &nbsp; if (pulseCount != oldPulseCount) {<br />
&nbsp; &nbsp; &nbsp; gw.send(pcMsg.set(pulseCount)); &nbsp;// Send pulse count value to gw&nbsp;<br />
&nbsp; &nbsp; &nbsp; double kwh = ((double)pulseCount/((double)PULSE_FACTOR)); &nbsp; &nbsp;&nbsp;<br />
&nbsp; &nbsp; &nbsp; oldPulseCount = pulseCount;<br />
&nbsp; &nbsp; &nbsp; if (kwh != oldKwh) {<br />
&nbsp; &nbsp; &nbsp; &nbsp; gw.send(kwhMsg.set(kwh, 4)); &nbsp;// Send kwh value to gw&nbsp;<br />
&nbsp; &nbsp; &nbsp; &nbsp; oldKwh = kwh;<br />
&nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; } &nbsp; &nbsp;<br />
&nbsp; &nbsp; lastSend = now;<br />
&nbsp; } else if (sendTime &amp;&amp; !pcReceived) {<br />
&nbsp; &nbsp; // No count received. Try requesting it again<br />
&nbsp; &nbsp; gw.request(CHILD_ID, V_VAR1);<br />
&nbsp; &nbsp; lastSend=now;<br />
&nbsp; }<br />
&nbsp;&nbsp;<br />
&nbsp; if (SLEEP_MODE) {<br />
&nbsp; &nbsp; gw.sleep(SEND_FREQUENCY);<br />
&nbsp; }<br />
}</p>
<p>void incomingMessage(const MyMessage &amp;message) {<br />
&nbsp; if (message.type==V_VAR1) { &nbsp;<br />
&nbsp; &nbsp; pulseCount = oldPulseCount = message.getLong();<br />
&nbsp; &nbsp; Serial.print(&quot;Received last pulse count from gw:&quot;);<br />
&nbsp; &nbsp; Serial.println(pulseCount);<br />
&nbsp; &nbsp; pcReceived = true;<br />
&nbsp; }<br />
}</p>
<p>void onPulse() &nbsp; &nbsp;&nbsp;<br />
{&nbsp;<br />
&nbsp; if (!SLEEP_MODE) {<br />
&nbsp; &nbsp; unsigned long newBlink = micros(); &nbsp;<br />
&nbsp; &nbsp; unsigned long interval = newBlink-lastBlink;<br />
&nbsp; &nbsp; if (interval&lt;10000L) { // Sometimes we get interrupt on RISING<br />
&nbsp; &nbsp; &nbsp; return;<br />
&nbsp; &nbsp; }<br />
&nbsp; &nbsp; watt = (3600000000.0 /interval) / ppwh;<br />
&nbsp; &nbsp; lastBlink = newBlink;<br />
&nbsp; }&nbsp;<br />
&nbsp; pulseCount++;<br />
}</p>
<p>&nbsp;</p>
</blockquote>
<p>&nbsp;</p>
<p>The sensor is not indicating pulse reception (green LED) and Arduino is not receiving anything.&nbsp;<br />
I tried to use 3.3V from USB throught the voltage regulator as well as batteries, but no luck.</p>
<p>Any suggestions please? How do I test that the sensor is not dead?<br />
&nbsp;</p>
<p>EDIT: Forgot to mention. The wiring is simple:</p>
<p>LED Pulse Sensor &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Sensebender<br />
Pin 2 &nbsp;-----------------------------&gt; 3.3V</p>
<p>Pin 5 ------------------------------ &nbsp;GND<br />
Pin 6 ------------------------------ &nbsp;D3</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11492.html" class="topic-previous" title="Go to previous forum topic">‹ emon v2 or v3 for 3 phase and PV monitoring</a>
              <a href="11567.html" class="topic-next" title="Go to next forum topic">Emontx_V3 serial direct problems ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-35637"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 04/11/2015 - 16:49.</div>
    <div class="content">
     <p>Is the sensor drawing any current? Is the LED it is looking at bright enough and close enough? Have you tried the emonTx sketch (extract the appropriate sections with appropriate pin number changes)?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35638"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8960.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="alexsh1&#039;s picture" title="alexsh1&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/8960.html" title="View user profile.">alexsh1</a> on Wed, 04/11/2015 - 17:34.</div>
    <div class="content">
     <p>Thanks for a prompt reply. Do you think I&#39;d need a pull-up resistor? - it is powered by two AA batteries</p>
<p>I have not measured the current - will try to do it today.</p>
<p>i tried using a torch (4000lm) to emulate the LED pulse - I think this is bright enough.</p>
<p>No, I have not tried using emonTX sketch - I would have to change it completely as I&#39;m trying to set it up on MySensors board using one of nodes.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35645"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 04/11/2015 - 19:57.</div>
    <div class="content">
     <p>The shop page says the sensor output is TTL. If that is indeed the case, then the output is actively driven both high and low, and no pull-up should be necessary.<br />
Again, if the output is TTL and you're using a torch (and the spectral response of the sensor is compatible), you should be able to see any output with a multimeter, even though a multimeter might miss a genuine energy meter pulse at only 100 ms long or so.<br />
The reason I'm being cautious is genuine TTL runs off 5 V, this claims to work down to 3.3 V so it's not strictly TTL at all at that voltage.</p>
<p>I suggested the emonTx sketch as a cross-check. You might like to compare the relevant parts just in case there's a significant difference.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35711"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8960.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="alexsh1&#039;s picture" title="alexsh1&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/8960.html" title="View user profile.">alexsh1</a> on Fri, 06/11/2015 - 13:09.</div>
    <div class="content">
     <p>Ok, let&#39;s go back to the basic. TTL - it must be connected to the digital &nbsp;pin, which is what I have. I cannot see any current drawn by the LED. It is zero.&nbsp;In other words, I am not sure if the sensor is working at all.</p>
<p>Additionally, I connect the optical sensor to D3 as per the wiring diagram above:</p>
<p>#define DIGITAL_INPUT_SENSOR 3 // The digital input you attached your sensor. (Only 2 and 3 generates interrupt!)<br />
#define SENSOR_INTERRUPT DIGITAL_INPUT_SENSOR-2&nbsp;// Usually the interrupt = pin -2 (on uno/nano anyway)</p>
<p>&nbsp;</p>
<p>I do get the following output:</p>
<p>send: 3-3-0-0 s=255,c=0,t=17,pt=0,l=3,sg=0,st=ok:1.5<br />
send: 3-3-0-0 s=255,c=3,t=6,pt=1,l=1,sg=0,st=ok:0<br />
sensor started, id=3, parent=0, distance=1<br />
send: 3-3-0-0 s=255,c=3,t=11,pt=0,l=12,sg=0,st=ok:Energy Meter<br />
send: 3-3-0-0 s=255,c=3,t=12,pt=0,l=3,sg=0,st=ok:1.0<br />
send: 3-3-0-0 s=4,c=0,t=13,pt=0,l=0,sg=0,st=ok:<br />
send: 3-3-0-0 s=4,c=2,t=24,pt=0,l=0,sg=0,st=ok:<br />
send: 3-3-0-0 s=4,c=2,t=24,pt=0,l=0,sg=0,st=ok:<br />
send: 3-3-0-0 s=4,c=2,t=24,pt=0,l=0,sg=0,st=ok:<br />
send: 3-3-0-0 s=4,c=2,t=24,pt=0,l=0,sg=0,st=ok:<br />
read: 0-0-3 s=4,c=2,t=24,pt=0,l=5,sg=0:12169<br />
Received last pulse count from gw:12169<br />
Watt:178855<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:13162<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:13.1620<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:14156<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:14.1570<br />
Watt:179354<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:15151<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:15.1510<br />
Watt:178997<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:16145<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:16.1460<br />
Watt:179140<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:17140<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:17.1400<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:18137<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:18.1370<br />
Watt:179068<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:19132<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:19.1320<br />
Watt:179140<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:20127<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:20.1270<br />
Watt:178713<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:21122<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:21.1220<br />
Watt:178926<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:22116<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:22.1170<br />
Watt:179068<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:23110<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:23.1110<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:24105<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:24.1060<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:25100<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:25.1010<br />
Watt:179282<br />
send: 3-3-0-0 s=4,c=1,t=24,pt=5,l=4,sg=0,st=ok:26095<br />
send: 3-3-0-0 s=4,c=1,t=18,pt=7,l=5,sg=0,st=ok:26.0960</p>
<p>&nbsp;</p>
<p>not sure where watts are coming from as the sensor is not pulsing...</p>
<p>&nbsp;</p>
<p>PS What sketch from openenergymonitor&nbsp;shall I go through please? I am complete new to openenergymonitor.</p>
<p>Thanks for your help</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35712"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 06/11/2015 - 13:52.</div>
    <div class="content">
     <p>If your sensor is drawing absolutely zero current - not even microamps - then I can't say for certain that the sensor is dead (as I don't have one to test and I haven't seen a data sheet) but I would be highly suspicious.</p>
<p>It would take me some time to work through that third party sketch to find out how it works and to interpret what the print-out is trying to tell you - that's why I suggested the emonTx sketch. But all you want at present is something to test the sensor, so I suggest looking at the very simple example in Building Blocks: <a href="https://learn.openenergymonitor.org/?redirect=interrupt-based-pulse-counter" title="http://openenergymonitor.org/emon/buildingblocks/interrupt-based-pulse-counter">http://openenergymonitor.org/emon/buildingblocks/interrupt-based-pulse-c...</a>. Even that is too complicated, all you need to print is the pulse count itself. You'll also need to change it to get the correct input pin (attach interrupt). You can test the sketch using a bit of wire to connect the input to 5 V, you might need the pull-down resistor it mentions for this. If it sees anything from 1 to many tens of pulses each time you dab the wire on - the sketch is working. Then substitute your sensor for the wire.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35730"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8960.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="alexsh1&#039;s picture" title="alexsh1&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/8960.html" title="View user profile.">alexsh1</a> on Sat, 07/11/2015 - 17:59.</div>
    <div class="content">
     <p>Robert,</p>
<p>&nbsp;</p>
<p>The sensor is working. I re-assemled everything on&nbsp;Arduino Uno and the green LED is on when the pulse is detected.&nbsp;However, now I have a problem that such pulse is not registered by Arduino or registered incorrectly. I found this:</p>
<p><a href="https://github.com/openenergymonitor/emonTxFirmware" title="https://github.com/openenergymonitor/emonTxFirmware">https://github.com/openenergymonitor/emonTxFirmware</a></p>
<p>Which firmware would you recommend me to use to take a working optical sensor example to compare with?<br />
I&#39;ll insert a few println to debug the code.</p>
<p>
Thanks</p>
<p>Alex</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35731"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 07/11/2015 - 21:24.</div>
    <div class="content">
     <p>Have you tried the Building Blocks code that I linked to above? That has the absolute minimum needed, so should be easy to work on. </p>
<p>The only thing that can go wrong is the "1" in attachInterrupt(1, onPulse, FALLING);<br />
When you've got that right, you should see (if you Print it) pulseCount rising with every pulse detected. You can also see if changing FALLING to RISING makes any difference, as this is what your original sketch used.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35732"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8960.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="alexsh1&#039;s picture" title="alexsh1&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/8960.html" title="View user profile.">alexsh1</a> on Sun, 08/11/2015 - 01:05.</div>
    <div class="content">
     <p>Thanks very much for the link. It really did help to troubleshoot the issue.</p>
<p>The following modification to&nbsp;the Building Blocks code&nbsp;worked&nbsp;in my setup:</p>
<p>int pin = 3;</p>
<p>void setup&nbsp;</p>
<p>{</p>
<p>pinMode&nbsp;(pin, INPUT_PULLUP);<br />
attachInterrupt(digitalPinToInterrupt(pin),&nbsp;onPulse, FALLING);</p>
<p>}</p>
<p>&nbsp;</p>
<p>Thanks<br />
Alex</p>
<p>&nbsp;</p>
<p>PS For those using Arduino Nano, only D2/D3 can be used with&nbsp;attachInterrupt</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35733"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 08/11/2015 - 01:47.</div>
    <div class="content">
     <p>That should give you a good guide to the changes you need to make in your original sketch to configure it correctly.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35734"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 08/11/2015 - 03:21.</div>
    <div class="content">
     <p>Good to hear you got it sorted. &nbsp;I think there may be other more subtle issues awaiting you with the original sketch as posted. &nbsp;All of those volatile variables manipulated by the pulse ISR are larger than &nbsp;one byte, which means accessing them is non-atomic. &nbsp;In order to guarantee reading them in a consistent state from within loop(), you&#39;ll need to protect those accesses from interruption.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35868"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Fri, 13/11/2015 - 12:11.</div>
    <div class="content">
     <p>Good work getting up and running using the sensor. For reference&nbsp;I have just measured the power consumption of the sensor, it reports 0mA when no pulse is detected and 5.3mA when a pulse is detected, most of this power consumption will be going to the green on-board LED.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35896"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8960.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="alexsh1&#039;s picture" title="alexsh1&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: LED pulse sensor with Arduino-like board</h3>

    <div class="submitted">Submitted by <a href="../user/8960.html" title="View user profile.">alexsh1</a> on Sat, 14/11/2015 - 10:05.</div>
    <div class="content">
     <p>Did anyone observe&nbsp;a&nbsp;battery life on the&nbsp;emonTx V3 (latest) using only a pulse meter? (Real-time and combined)<br />
I am interested to know for how long it can&nbsp;run autonomously. Unfortunately, I do not have 240V&nbsp;socket&nbsp;close to my meter so a pulse reader on batteries is the only option.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11524"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-MxzvaCCDmw2tgY7JnDjTLTrSdhfBeaQuxmVoF1Ws2w4" value="form-MxzvaCCDmw2tgY7JnDjTLTrSdhfBeaQuxmVoF1Ws2w4"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
