<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/10878 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 13:46:43 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The best build that is no better than the others - It Works! | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">The best build that is no better than the others - It Works!</h3>
        <span class="submitted">Submitted by <a href="../user/8169.html" title="View user profile.">cab123</a> on Sat, 20/06/2015 - 00:47</span>
        <div class="content"><p>
Hi, after&nbsp;finishing&nbsp;my build, it is time to give back to the community and describe the best i can all that i have done.</p>
<p>What you will see here is nothing new of what is already done, if anyone wants to build something similar, adjusted to the specific need of the Portuguese electric company, that defines some crazy periods &nbsp;for low rate tariff, what needs to be done to count &euro;/kWh is right here.</p>
<p>
So lets begin:</p>
<p>First of all in order to know how everything works i ordered a emonTx V2 Kit and a RPI RF receiver from the store, assembled it and learned the inner works of it for some days. BUT somehow i managed to convince myself that 3 CT were not enough, and because i have ethernet right next no my fuse box, there was no need for the wireless stuff.</p>
<p>So a custom build was the solution, with:</p>
<p>- Arduino MEGA 1280<br />
- 1x Voltage sensor (ADC 0)<br />
- 8X CT Analog channels (ADC 2,3,5,6,8,9,11,12)<br />
- Burden resistor of the CT at 68 OHM to increase resolution at 0-50AMP (i have m&aacute;x 25 Amp at home)<br />
- Ethernet with ENC28J60</p>
<p>I already had most of the parts laying around, only had to buy the transformer and the resistors and condensers for the analog input circuit. Even the inputs terminals were here - that&#39;s why i ditched the phone connectors - if you do not have a strong reason to do the same please don&#39;t do it!</p>
<p>Here it is front side<br />
<img alt="" height="383" src="../../../lh3.googleusercontent.com/-Q7e3GpOCRRY/VWJUG1IRYlI/AAAAAAAACyE/nsXLGDnp1lo/s800/P1080363.JPG" width="688" /></p>
<p>and back side<br />
<img alt="" height="399" src="../../../lh3.googleusercontent.com/-OzUrjbW8vrM/VWJUG5mO78I/AAAAAAAACyY/lHuKj57ciLc/s800/P1080365.JPG" width="688" />(the high voltage is protected with a big layer of&nbsp;hot glue)</p>
<p>Installed on the fuse box<br />
<img alt="" height="387" src="../../../lh3.googleusercontent.com/-EcfkxuXg5c8/VWJUG12dikI/AAAAAAAACyg/WMFSQURtuJk/s800/P1080366.JPG" width="688" /></p>
<p>
The input circuit is the same as what is explained in the building blocks for the arduino, however how the whole system is powered is absolutely critical to get good measurements. You can see here (<a href="10111.html" title="http://openenergymonitor.org/emon/node/10111">http://openenergymonitor.org/emon/node/10111</a>) some really good advices on how to get proper power. My system is powered through a home alarm system that provides stable 12V. The 12V is stepped down to 7,5V with a DC/DC converter to power the arduino via DC IN. the arduino regulator outputs 5V for the board and feeds another external regulator that provides 3.3V to the ethernet chip. This way was the one that generated the least heat for the whole system and at the same time provided good reference and good measurements.</p>
<p>One problem i have is that CT channels 1, 4 and 7 have higher noise than the rest. They can go up to 20W without a CT attached to the circuit. The others CT channels 2,3, 5, and 6 are really really quiet, they read between -0.2W and 0.2W and average nicely to 0W.</p>
<p>
this is the sketch running on the arduino mega, nothing new, reports direcly to emoncms and has some thresholds to get rid of the noisy readings</p>
<p>&nbsp;</p>
<pre style="font-size: 100%;">
/*
  EmonTx CT123 Voltage NanodeRF example
  
  Part of the openenergymonitor.org project
  Licence: GNU GPL V3
  
  Author: Trystan Lea
*/

#include &quot;EmonLib.h&quot;
//#define DEBUG
int node_id = 12;

#define NSENSORS 8
EnergyMonitor emon[NSENSORS];                   // Create  instances for each CT channel

//---------------------------------------------------------------------
// The PacketBuffer class is used to generate the json string that is send via ethernet - JeeLabs
//---------------------------------------------------------------------
class PacketBuffer : public Print {
public:
    PacketBuffer () : fill (0) {}
    const char* buffer() { return buf; }
    byte length() { return fill; }
    void reset()
    { 
      memset(buf,NULL,sizeof(buf));
      fill = 0; 
    }
    virtual size_t write (uint8_t ch)
        { if (fill &lt; sizeof buf) buf[fill++] = ch; }
    byte fill;
    char buf[250];
    private:
};
PacketBuffer str;

//---------------------------------------------------------------------
// ETHERNET
//---------------------------------------------------------------------
#include &lt;EtherCard.h&gt;

static byte mymac[] = { 0x74,0x69,0x69,0x2D,0x30,0x31 };   // ethernet interface mac address, must be unique on the LAN
byte Ethernet::buffer[700];
unsigned long timer = 0;
char website[] PROGMEM = &quot;emoncms.org&quot;;                    // 1) Set this to the domain name of your hosted emoncms - leave blank if posting to IP address 
static byte hisip[] = { 192,168,1,10 };                    // or if your posting to a static IP server:
boolean use_hisip = false;                                 // change to true if you would like the sketch to use hisip
char basedir[] = &quot;&quot;;                                       // 2) If your emoncms install is in a subdirectory add details here i.e &quot;/emoncms3&quot;
char apikey[] = &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;;        // 3) Set to your account write apikey 
int ethernet_error = 0;                                    // Etherent (controller/DHCP) error flag
int ethernet_requests = 0;                                 // count ethernet requests without reply                 
int dhcp_status = 0;
int dns_status = 0;

//---------------------------------------------------------------------
// SETUP
//---------------------------------------------------------------------
void setup() 
{
  dhcp_status = 0; dns_status = 0; ethernet_requests = 0; ethernet_error=0;

#ifdef DEBUG
  Serial.begin(9600);
  Serial.println(&quot;OpenEnergyMonitor.org&quot;);
#endif

  delay(1000);
  
  if (ether.begin(sizeof Ethernet::buffer, mymac, 53) == 0) {
#ifdef DEBUG
    Serial.println( &quot;Failed to access Ethernet controller&quot;);
#endif
    ethernet_error = 1;
}
 
  delay(1000);
  
  // Ain 1,4,7 e provavelmente 10 induzem ruido
  
  emon[0].current(2, 28.234);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[0].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

  emon[1].current(3, 28.136);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[1].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

  emon[2].current(5, 28.577);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[2].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

  emon[3].current(6, 28.346);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[3].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

  emon[4].current(8, 28.143);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[4].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

  emon[5].current(9, 28.507);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[5].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

  emon[6].current(11, 28.320);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[6].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

  emon[7].current(12, 28.330);         // Calibration factor = CT ratio / burden resistance = 2000 / 68 Ohms = 29.412
  emon[7].voltage(0, 206.3, 1.7);     // (ADC input, calibration, phase_shift)                              

}


//---------------------------------------------------------------------
// LOOP
//---------------------------------------------------------------------
void loop() 
{ 
  dhcp_dns();   // handle dhcp and dns setup - see dhcp_dns tab
  ether.packetLoop(ether.packetReceive());

  if ((millis()-timer)&gt;10000) {  // 10000 = a post every 10 seconds.
    timer = millis();
    
  for (int i=0; i&lt;NSENSORS; i++) {   // perform measurements
    emon[i].calcVI(20,2000);
  }
    
     // Available properties: ct1.realPower, ct1.apparentPower, ct1.powerFactor, ct1.Irms and ct1.Vrms
 
    str.reset();
    str.print(basedir); str.print(&quot;/input/post.json?&quot;); str.print(&quot;apikey=&quot;); str.print(apikey); str.print(&quot;&amp;node=&quot;);  str.print(node_id);
    str.print(&quot;&amp;json={V:&quot;); str.print(emon[0].Vrms); str.print(&quot;,&quot;);
    str.print(&quot;P1:&quot;); abs(emon[0].realPower) &lt; 10 ? str.print(&quot;0&quot;) : str.print(emon[0].realPower); str.print(&quot;,&quot;);
    str.print(&quot;I1:&quot;); str.print(emon[0].Irms); str.print(&quot;,&quot;);
    str.print(&quot;pF1:&quot;); str.print(emon[0].powerFactor); str.print(&quot;,&quot;);    
    str.print(&quot;P2:&quot;); abs(emon[1].realPower) &lt; 0.9 ? str.print(&quot;0&quot;) : str.print(emon[1].realPower); str.print(&quot;,&quot;);
    str.print(&quot;P3:&quot;); abs(emon[2].realPower) &lt; 0.9 ? str.print(&quot;0&quot;) : str.print(emon[2].realPower); str.print(&quot;,&quot;);
    str.print(&quot;P4:&quot;); abs(emon[3].realPower) &lt; 20 ? str.print(&quot;0&quot;) : str.print(emon[3].realPower); str.print(&quot;,&quot;);
    str.print(&quot;P5:&quot;); abs(emon[4].realPower) &lt; 0.9 ? str.print(&quot;0&quot;) : str.print(emon[4].realPower); str.print(&quot;,&quot;);
    str.print(&quot;P6:&quot;); abs(emon[5].realPower) &lt; 0.9 ? str.print(&quot;0&quot;) : str.print(emon[5].realPower); str.print(&quot;,&quot;);
    str.print(&quot;P7:&quot;); abs(emon[6].realPower) &lt; 20 ? str.print(&quot;0&quot;) : str.print(emon[6].realPower); str.print(&quot;,&quot;);
    str.print(&quot;P8:&quot;); abs(emon[7].realPower) &lt; 0.9 ? str.print(&quot;0&quot;) : str.print(emon[7].realPower);    
    str.print(&quot;}&quot;); str.print(&quot;\0&quot;);  //  End of json string
#ifdef DEBUG
    Serial.print(&quot;Data sent: &quot;); Serial.println(str.buf);
#endif
    ether.browseUrl(PSTR(&quot;&quot;) ,str.buf, website, 0);  // Send data to the server

  } //end of main 10 second cycle
} // end of main loop</pre><p>&nbsp;</p>
<p>
So everything smooth, but again i was not happy with this, had to get cost per kWh, with the real rates depending on the time of the day so read the forum and got the needed help, use addons on the emoncms or use crontab. I still did&#39;t setup properly a home server with emoncms (working on that) so crontab was my only choice. My NAS is awake 24x7, so it was easy to make it work. Too bad i&#39;m not able to install emoncms on it.</p>
<p>The Portuguese Electricity company is really creative in setting the offpeak periods, on my case its everyday from 00:00 to 07:00, but on Saturday it gets really twisted. It bounces back and forth between offpeak and onpeak and has different periods if we are in the summer or if we are in the winter.</p>
<p>this is a possible solution that is working for a month now (removed absolute paths to make it easier to read):</p>
<p>New feed with 3 values:</p>
<blockquote><pre>
- euro - tariff value in &euro;/kWh
- vazio - if offpeak: 1 otherwise 0
- cheio - if offpeak: 0 otherwise 1</pre></blockquote>
<p>My crontab:</p>
<blockquote><pre>
# Bi-horario semana:
0  0    * * 1-5   root   tarifa.sh vazio
0  7    * * 1-5   root   tarifa.sh cheio

# Bi-horario domingo:
0  0    * * 0      root  tarifa.sh vazio

# Bi-horario sabado:
0  0    * * 6     root   tarifa.sh vazio
0  9    * * 6     root   tarifa_verao.sh cheio
30 9    * * 6     root   tarifa_inverno.sh cheio
0  13   * * 6     root   tarifa_inverno.sh vazio
0  14   * * 6     root   tarifa_verao.sh vazio
30 18   * * 6     root   tarifa_inverno.sh cheio
0  20   * * 6     root   tarifa_verao.sh cheio
0  22   * * 6     root   tarifa.sh vazio</pre></blockquote>
<p>the argument in each call is the &euro;/kWh, so every time the tarrif changes i only have to update these files:</p>
<blockquote><pre>
# more vazio
0.120294
# more cheio
0.224213</pre></blockquote>
<p>the script itself is very simple and has two variants: one that runs at summer time and one that runs at winter time:</p>
<blockquote><pre style="font-size: 100%;">
# more tarifa.sh
#!/bin/sh
set -e    # exit if any error
i=$(&lt;$1)  # load file

# Determine the tariff period from the ending of the argument
cheio=0; vazio=0;
if  [[ &quot;$1&quot; == *cheio ]]; then cheio=1; else vazio=1; fi;

curl -s &quot;http://emoncms.org/input/post.json?json={euro:$i,cheio:$cheio,vazio:$vazio}&amp;apikey=XXXXXXXXXXXXX&amp;node=1&quot;</pre></blockquote>
<p>&nbsp;</p>
<blockquote><pre style="font-size: 100%;">
# more tarifa_inverno.sh
#!/bin/sh
set -e    # exit if any error
i=$(&lt;$1)  # load file

# Determine the tariff period from the ending of the argument
cheio=0; vazio=0;
if  [[ &quot;$1&quot; == *cheio ]]; then cheio=1; else vazio=1; fi;

if date +%Z | grep BST &amp;&gt; /dev/null; then   # summer time
:
else                                    # winter time
curl -s &quot;http://emoncms.org/input/post.json?json={euro:$i,cheio:$cheio,vazio:$vazio}&amp;apikey=XXXXXXXXXXXX&amp;node=1&quot;
fi</pre></blockquote>
<p>&nbsp;</p>
<blockquote><pre style="font-size: 100%;">
# more tarifa_verao.sh
#!/bin/sh
set -e    # exit if any error
i=$(&lt;$1)  # load file

# Determine the tariff period from the ending of the argument
cheio=0; vazio=0;
if  [[ &quot;$1&quot; == *cheio ]]; then cheio=1; else vazio=1; fi;

if date +%Z | grep BST &amp;&gt; /dev/null; then   # summer time
curl -s &quot;http://emoncms.org/input/post.json?json={euro:$i,cheio:$cheio,vazio:$vazio}&amp;apikey=XXXXXXXXXXXXXX&amp;node=1&quot;
fi</pre></blockquote>
<p>&nbsp;</p>
<p>on emoncoms this is the input feed for&nbsp;the onpeak/offpeak periods:</p>
<p><img alt="" height="191" src="../../../lh3.googleusercontent.com/-el1gaBmRNQU/VYSr_yk7uDI/AAAAAAAACz0/sPd8YwU1cgA/s720/euro_cheio_vazio_feed.jpg" width="688" /></p>
<p>
And this is the general input configuration for the CT&#39;s:<br />
<img alt="" height="422" src="../../../lh3.googleusercontent.com/-I_SMiYn0_uE/VYSsa8l_W3I/AAAAAAAACz8/fuFKIrybzLU/s962/arduino_feeds.JPG" width="688" /></p>
<p>
With all this it was easy to generate the following&nbsp;graphs:</p>
<p><strong>Brief</strong> to see in the smartphone</p>
<p><img alt="" height="475" src="../../../lh3.googleusercontent.com/-0VAkYxjKh3k/VYSu46wyQrI/AAAAAAAAC0U/ZzSUsHiYiso/s629/Dash_Brief.JPG" width="386" /></p>
<p>
<strong>Detail </strong>to debug<br />
<img alt="" height="445" src="../../../lh3.googleusercontent.com/-adQ1NdUHpbg/VYSu45VW1FI/AAAAAAAAC0Y/yv-tSiN_3p4/s1152/Dash_Live.JPG" width="688" /></p>
<p>
Offpeak(Green) and Onpeak(Orange) usage - got this snapshot at midnight, all the counters were set to 0. I can assure you it works though!</p>
<p><img alt="" height="435" src="../../../lh3.googleusercontent.com/-X-DG124PtgM/VYSu4vsl7bI/AAAAAAAAC0Q/g5b7Qmi4H7Y/s784/Dash_BiHorario.JPG" width="688" /></p>
<p>
and several usage statisticas and costs</p>
<p><img alt="" height="662" src="../../../lh3.googleusercontent.com/--puGUDeJHm0/VYSu6ePfw4I/AAAAAAAAC0s/lvuf-FJNJI8/s720/Dash_consumos.JPG" width="688" /></p>
<p><img alt="" height="330" src="../../../lh3.googleusercontent.com/-6i_KvBlbJcA/VYSu6u-rOpI/AAAAAAAAC0o/5iqfPWUqCdI/s869/Dash_consumosII.JPG" width="688" /></p>
<p>The values don&#39;t add up nicely in the last picture because i made mistakes at the beginning. It would be nice if we could reset all the feeds to start over.</p>
<p>&nbsp;</p>
<p>Well that&#39;s it, hope you enjoy and if you are not sure about building your own i hope you find here some arguments to go for it!</p>
<p>
Thanks!</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="10784.html" class="topic-previous" title="Go to previous forum topic">‹ My Dashboard - and how do you put text in front of image?</a>
              <a href="10911.html" class="topic-next" title="Go to next forum topic">Newbie questions - how&#039;s this system? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-31538"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8282.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="tinamore&#039;s picture" title="tinamore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/8282.html" title="View user profile.">tinamore</a> on Sat, 20/06/2015 - 07:27.</div>
    <div class="content">
     <p>Great build.</p>
<p>Thank you for sharing.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31547"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8169.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="cab123&#039;s picture" title="cab123&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/8169.html" title="View user profile.">cab123</a> on Sat, 20/06/2015 - 15:23.</div>
    <div class="content">
     <p>Thanks.</p>
<p>Looking back to the whole thing i would have had extra care designing the analog stage fot the CT sensors, having 3 out of 8 with some noise still bothers me. However after spending&nbsp;too much time trying to solve that,&nbsp;i just assumed the error and continued.</p>
<p>My main objective with this project is&nbsp;not to monitor energy alone, it is to automate my home-made&nbsp;EVSE&nbsp;to charge my Nissan Leaf. With this system it is easy to pull the whole house consumption&nbsp;from the API, do the math and instruct the car to use the remaining available power.</p>
<p>What you get from having a openenergy system is much more than what&nbsp;you see... and that&#39;s truly amazing! Thanks!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31568"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8282.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="tinamore&#039;s picture" title="tinamore&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/8282.html" title="View user profile.">tinamore</a> on Sun, 21/06/2015 - 15:05.</div>
    <div class="content">
     <p>Hi</p>
<p>I think&nbsp;noise of&nbsp;&quot;3 out of 8&quot; from base&nbsp;ADC arduino when use&nbsp;analogRead() on&nbsp;different PINs&nbsp;ADC of Arduino</p>
<p>You can see topic:</p>
<p><a href="https://forums.adafruit.com/viewtopic.php?f=25&amp;t=11597&amp;sid=33426cbf21c75563c52322afd5d1e0f4">https://forums.adafruit.com/viewtopic.php?f=25&amp;t=11597&amp;sid=33426cbf21c75563c52322afd5d1e0f4</a></p>
<p>​I think this noise&nbsp;is inevitable</p>
<p>(Sorry&nbsp;for&nbsp;my English)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31569"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 21/06/2015 - 15:28.</div>
    <div class="content">
     <p>If the noise is only present on some channels, then it might well be an issue with the layout. It might also be the CT itself picking up a signal from adjacent cables. Do all the analogue inputs have a good solid GND connection back to a single common point? Is it possible that some digital signals are returning along the same piece of copper? Is there a filter between the digital and analogue power supplies on your particular Arduino? (Some have one, some do not.) All these things (and more!) can affect the noise pickup. There is a lot of good information on how to minimise noise pickup on the Atmel website.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31576"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sun, 21/06/2015 - 23:23.</div>
    <div class="content">
     <p>One simple test to help isolate the noise is to swap a noisy CT with a quiet CT, just at the screw terminals where they terminate onto your monitor (don&#39;t physically move the CTs). &nbsp;If the noise stays with the CT you&#39;ll know to investigate it over near the breakers, or in the cabling. &nbsp;If the noise stays with the screw terminal you&#39;ll know to investigate on your board.</p>
<p>I too monitor individual circuits, and I definitely get some minor cross-talk between my CTs (or possibly the CT cables). &nbsp;I&#39;ve confirmed it arrives at my screw terminals, so I at least know not to go looking for the source in my monitor. &nbsp;One day I might man up and start moving CTs around, but I prefer not to be messing around back there if I can avoid it.</p>
<p>I&#39;ve added the ability to capture the 24-bit raw waveform data out of my monitor. &nbsp;Effectively each of my channels is also a 24-bit 4KHz scope. &nbsp;Attached is a picture of my Hot Plates circuit (time and frequency domains). &nbsp;In both cases the Hot Plates are off, but in the second case I&#39;ve switched a 2.4KW load on, on a completely different circuit. &nbsp; The RMS ghost current on the Hot Plates circuit jumps from about 4.8mA to 19.5mA and you can see it&#39;s nicely sync&#39;d with V, enough&nbsp;to make it break out of its&nbsp;anti-creep threshold and declare the Hot Plates are using 4.8W!&nbsp; &nbsp;Fortunately, the hot plates never use any low currents like that, so I have an additional software anti-creep threshold on that circuit of 10W.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31577"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8169.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="cab123&#039;s picture" title="cab123&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/8169.html" title="View user profile.">cab123</a> on Mon, 22/06/2015 - 00:32.</div>
    <div class="content">
     <p>Hi&nbsp;thanks for your inputs!</p>
<p>I resoldered&nbsp;a few times all the tracks, with added wires to get solid connections, and spend some time trying to&nbsp;isolate each channel the best i could. I&#39;m not sure now if there were more noisy channels, but could never fix those 3. The noise is present with no CT attached. It appears as a positive power that can go up to 13-14Watt on one of them.</p>
<p>To troubleshoot the arduino board i changed the analog pins for the channels, the original ones were 1 to 8. and the noise was on 1, 4 and 7, so i bypassed those, but because it was no easy task i had to remake all the connections to the analog inputs.&nbsp;If you see on my sketch i&#39;m using analog 2,3,5,6,8,9,11,12.</p>
<p>The&nbsp;noise shifted to the new analog inputs acordingly, where before Analog input 2 was clean, with the second analog circuit, it became noisier when driven&nbsp;by&nbsp;the analog circuit number 1.</p>
<p>So it&#39;s definitely on the prototype board layout.</p>
<p>I also tried to take care of good grounding&nbsp;if you check the back side picture the black wires are ground and have a reinforced track that surrounds all the channels. The noisier are not in a particular physical area, and are adjacent to clean channels&nbsp;so after some more soldering and reconditioning those nasty channels without any improvement i just gave up.</p>
<p>But i&#39;m happy, 5 out of 8 are just perfect :-) I can sense my washer machine&nbsp;stand-by at 2Watt, if i pull the circuit breaker it goes down to zero! Ain&#39;t that amazing?</p>
<p>&nbsp;</p>
<p>Regarding the constructive interference&nbsp;between channels, this time with the CT&#39;s connected and&nbsp;in operation, i also observed that phenomenon while testing, i read here on the forum that the CT cables should be shielded to ground, you guys recommend doing that? on my graphs i have not observed that since setting up the thresholds in the sketch.</p>
<p>BR</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31578"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 22/06/2015 - 04:10.</div>
    <div class="content">
     <p>That all sounds like pretty thorough noise hunting. &nbsp;Not sure what to suggest after that, unless you can borrow a scope from someone? &nbsp;If you can, I&#39;d power up the proto board (with&nbsp;the Arduino&nbsp;and CTs&nbsp;removed), set the scope probe to AC coupling and just a few mV per division and start probing around. &nbsp;I guess the mid-rails would be a good place to start... see if they&#39;re noisier on the noisy channels than on the quiet channels. &nbsp;You might be able to do something similar with a multimeter.... set your multimeter to AC volts and then measure each of the mid-rails, but a scope would be way better suited to the task.</p>
<p><strong>[EDIT]&nbsp;</strong>Actually, it could be worth checking the DC voltage of each of the mid-rails as well. &nbsp;The noisy ones might be sitting right on an AtoD step, while the quiet ones might be safely in the middle of a step. &nbsp;Robert has a theory that just the right amount of noise there can be helpful, but I&#39;m not convinced. &nbsp; There&#39;s more about that here: &nbsp;<a href="../http_/%252Fopenenergymonitor.org/emon/sites/default/files/Arduino%20AC%20current%20input%20A.html">http://openenergymonitor.org/emon/http%3A/%252Fopenenergymonitor.org/emon/sites/default/files/Arduino%20AC%20current%20input%20A.png</a></p>
<p>And the other thing I forgot to mention, is that your Arduino itself makes a half decent rudimentary scope. &nbsp;I posted a sketch in that &quot;noise in Arduino builds&quot; thread that you referenced above that you can use. &nbsp;Try running that on your noisy channel with no CT connected and then graph the data it spits out. &nbsp;It just gets raw readings, no filtering, no nothing... if it&#39;s only the LSB that&#39;s flipping backwards and forwards then it&#39;s probably as good as it gets, if it&#39;s anything else its shape may give some clues. &nbsp;That it&#39;s showing up as real power suggests it has at least some 50Hz component.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31589"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8169.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="cab123&#039;s picture" title="cab123&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/8169.html" title="View user profile.">cab123</a> on Mon, 22/06/2015 - 09:09.</div>
    <div class="content">
     <p>Hi dBC,&nbsp;unfortunately i don&#39;t have a scope, and the readings i made with my multimeter&nbsp;revealed&nbsp;nothing wrong at it&#39;s own limited level of precision.</p>
<p>But your sketch to pull raw data directly from&nbsp;the arduino seems at reach and it&#39;s definitely a good idea to do that,&nbsp;i&#39;ll try&nbsp;when i have the chance.</p>
<p>tks!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31597"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 22/06/2015 - 10:48.</div>
    <div class="content">
     <p>When you are set up to view it, assuming there is some&nbsp;50Hz signal in there, try it with and without power to your transformer to see if that&#39;s the source. &nbsp;If it were coming in through your Arduino DC supply, I&#39;d expect it to be more consistent across all your channels.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31601"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 22/06/2015 - 12:30.</div>
    <div class="content">
     <p><i>"If it were coming in through your Arduino DC supply..."</i></p>
<p>Your full scale power is approx 12 kW, I think, so 20 W is about 0.16%. That is well within the range where shifting the bias point <em>inside</em> one step of the ADC can give big changes in the readings, so if it is easy, you could try replacing one of the bias resistors with another of the same value. The different value of resistance, still inside the tolerance band, might move the bias point enough to make a difference.</p>
<p>One day, I will sit down with a spreadsheet and try to understand exactly how very small signals behave when the bias moves across the boundary of an ADC step - both for rms current and average power.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31617"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 22/06/2015 - 20:34.</div>
    <div class="content">
     <p>That sketch referenced above will tell you your peak-to-peak noise in A/D units. &nbsp;If it&#39;s above 1 that&#39;s when you can go researching the source (powering off the transformer etc). &nbsp;If it is&nbsp;1 then that&#39;s normal, and as Robert says, you can move the quiescent state relative to the A/D steps by re-throwing the resistor dice.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31625"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Tue, 23/06/2015 - 00:32.</div>
    <div class="content">
     <p>cab123</p>
<p>You can use the new scheduler module from XT branch instead of crontab to get the same multi rate accountings.</p>
<p>For Portugal use this schedules :</p>
<p><strong>Empty:</strong> Winter|Mon-Fri|00:00-06:59, Winter|Sat|00:00-09:29,13:00-18:29,22:00-23:59, Winter|Sun|00:00-23:59 , Summer|Mon-Fri|00:00-06:59, Summer|Sat|00:00-08:59,14:00-19:59,22:00-23:59, Summer|Sun|00:00-23:59</p>
<p><strong>Full:</strong> Winter|Mon-Fri|07:00-23:59, Winter|Sat|09:30-12:59,18:30-21:59 , Summer|Mon-Fri|07:00-23:59, Summer|Sat|09:00-13:59,20:00-21:59</p>
<p>Config input as follow (this is example for tri-rate schedule):</p>
<p><img alt="" height="401" src="../sites/default/files/3hrs.jpg" width="707" /></p>
<p>Give it a try!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-31811"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8169.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="cab123&#039;s picture" title="cab123&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: The best build that is no better than the others - It Works!</h3>

    <div class="submitted">Submitted by <a href="../user/8169.html" title="View user profile.">cab123</a> on Tue, 30/06/2015 - 11:48.</div>
    <div class="content">
     <p>Hi chaveiro, still posting to&nbsp;emocms.org, to install modules i have to setup a local server, right?</p>
<p>dBC/Robert, i really want to troubleshoot the noisy channels, but i&#39;m at a point where the data building up on the graphs start to get really interesting, so i will delay this until&nbsp;the next &quot;maintenance window&quot;, where&nbsp;i will&nbsp;move data to a new local server. There is a big chance of failure so it&#39;s a good time to troubleshoot :-)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/10878"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-nWXLK9XrXEaKVcp6YXs81xvfB6vD7IFA0EzR3MDL8-8" value="form-nWXLK9XrXEaKVcp6YXs81xvfB6vD7IFA0EzR3MDL8-8"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
