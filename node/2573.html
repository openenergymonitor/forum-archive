<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/2573 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:08:24 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Programming help | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Programming help</h3>
        <span class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Thu, 11/07/2013 - 09:11</span>
        <div class="content"><p>Instead of asking others to write a function, I thought that I&#39;d try and learn a little programming myself, and add a useful addition to the input process list. But thought that I&#39;d start by replicating one of the existing functions to establish how it all works, and build it from there!</p>
<p>I edited the process_model.php to include the menu item;</p>
<p><strong>$list[27] = array(<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _(&quot;My test&quot;),<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProcessArg::FEEDID,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;my_test&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataType::REALTIME<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</strong></p>
<p>and added the function to the process_model.php &nbsp;(which should just log the value to the feed);</p>
<p><strong>public function my_test($feedid, $time_now, $value)<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;feed-&gt;insert_data($id, $time, $time, $value);<br />
	&nbsp; &nbsp; &nbsp;return $value;<br />
	&nbsp; &nbsp;}</strong></p>
<p>I also added a description to custom-table-fields.js</p>
<p><strong>case 27:<br />
	&nbsp;key = &#39;test&#39;; type = 2; break;</strong></p>
<p>Everything looked good at this stage, I could add the &#39;My test&#39; to an input process, and the new feed was created, however the values recorded were not as expected, instead of recording the exact value (as log to feed does) it recorded a very small value (0.00023) which incremented&nbsp;over time. ie just &nbsp;one row in the database with the value incrementing.</p>
<p>What&#39;s gone wrong! is there another file somewhere which determines how list [27] processes and records the data in mysql?</p>
<p>Paul</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2586.html" class="topic-previous" title="Go to previous forum topic">‹ DC shunt for 24vdc 100ah battery current sense </a>
              <a href="2589.html" class="topic-next" title="Go to next forum topic">Emoncms on Raspberry stop to log data after power failure - lose data after reboot ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-13553"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Thu, 11/07/2013 - 13:20.</div>
    <div class="content">
     <p>Not sure what it implies, but if you want to start with a clone of the log to feed function, you may want to change the parameters list in there:</p>
<pre>
public function my_test($feedid, $time_now, $value)</pre><p>See:</p>
<pre>
public function log_to_feed($id, $time, $value)
    {
      $this-&gt;feed-&gt;insert_data($id, $time, $time, $value);

      return $value;
    }</pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13560"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Thu, 11/07/2013 - 21:00.</div>
    <div class="content">
     <p>Thanks for the reply Jerome, however with&nbsp;the changes you suggest, I still get a very low value recorded in the database;</p>
<p>0.00813195 instead of the feed value of approx 244 (Mains voltage). The database contains just one row of data and the number increments with each update.</p>
<p>A quick check of the figure recorded suggest that mysql&nbsp;is interpreting&nbsp;the data as &#39;power to kwh&#39;, as after 15 minutes the database is showing 0.0608 (0.244kW / 4 = 0.61kWh) &nbsp;- Coincidence?</p>
<p>How does the database determines how to process the feed value, or should this be determined in the module process_model.php?</p>
<p>Thank you for your patience!</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13562"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3657.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3657.jpg" alt="Mattia Rossi&#039;s picture" title="Mattia Rossi&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/3657.html" title="View user profile.">Mattia Rossi</a> on Thu, 11/07/2013 - 21:40.</div>
    <div class="content">
     <p>Silly question, you did use your test function on a new input without, say, applying the log to feed an power to kwh/d processes before, did you ?</p>
<p>As it is explained in the input configuration page:</p>
<p><em>Input processes are executed sequentially with the result being passed back for further processing by the next processor in the input processing list.</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13565"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Thu, 11/07/2013 - 22:20.</div>
    <div class="content">
     <p>Mattia, the input processes on the feed are:</p>
<p><strong>x </strong>0.01<br />
	<strong>Log to feed</strong><br />
	<strong>My test </strong>(this process)</p>
<p>....and I am comparing &#39;Log to feed&#39; with &#39;My test&#39;, which should be the same??</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13574"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3657.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3657.jpg" alt="Mattia Rossi&#039;s picture" title="Mattia Rossi&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/3657.html" title="View user profile.">Mattia Rossi</a> on Fri, 12/07/2013 - 08:35.</div>
    <div class="content">
     <p>Hi Paul, my guess is that there&#39;s something weird with your config.</p>
<p>The code you originally posted shouldn&#39;t have generated any value any time, since as Jerome pointed out you were using the wrong names for the parameters.</p>
<p>I replicated what I think is your setup:</p>
<p>Change process_model.php and add</p>
<p>$list[26] = array(<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _(&quot;My test&quot;),<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProcessArg::FEEDID,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;my_test&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataType::REALTIME<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</p>
<p>(the latest entry in my version of process_model is 25, I guess you have more than one experiment going on ...)</p>
<p>Add the method my_test:</p>
<p>public function my_test($id, $time, $value){</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;feed-&gt;insert_data($id, $time, $time, $value);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $value;</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>Choose an input and add the new process:</p>
<p>In the input list table:</p>
<p>100 2 TEST-CMD-2 x log test</p>
<p>In the Input config table:</p>
<p>1 x 0.01<br />
	2 Log to feed TEST-INPUT-2<br />
	3 My test TEST-TEST</p>
<p>In my setup feed TEST-INPUT-2 has id 27 (mysql table feed_27) and feed TEST-TEST has id 60 (table feed_60)</p>
<p>Update feed:</p>
<p>curl -n &quot;http://myurl.com/emoncms/input/post.json?node=100&amp;apikey=myapikey&amp;csv=0,22000,0&quot;</p>
<p>(this is a test node in my emoncms, the relevant part is that I am sending the value 22000 for node 100 id 2, the one I set up previously)</p>
<p>And if I check both in emoncms and the db I have the correct value (22000x0.01 =220 ) in both feeds TEST-INPUT-2 and TEST-TEST</p>
<p>My guess is that you are mixing up feed names/looking at the wrong feeds when checking, or you changed something else that is having a side effect on your values .... is that the only change you made to your emoncms setup ? or else, are you experimenting with a live feed that is fed directly through the rfm12php script ? If so, did you restart it after changing the code ?&nbsp;</p>
<p>Mattia</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13576"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Fri, 12/07/2013 - 09:44.</div>
    <div class="content">
     <p>Mattia thanks for your patience,</p>
<p>I&#39;ve deleted out the test feed &amp; input config, returned back to the original modules, so everything is as downloaded from Git.</p>
<p>Rebooted, and made a fresh start using the changes that you have detailed, &nbsp;and yes, now it works, and is logging the value correctly! I don&#39;t know where I had gone wrong, but it&#39;s obviously working fine now, and I can use this as a template to try and add a few functions that seem to be missing from emoncms, such as &#39;maximum value&#39; &amp; &#39;minimum value&#39;, which are present in the the emonGLCD but not emoncms, and would be useful not just for temperatures, but also solar generation levels, usage etc.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13577"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3657.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3657.jpg" alt="Mattia Rossi&#039;s picture" title="Mattia Rossi&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/3657.html" title="View user profile.">Mattia Rossi</a> on Fri, 12/07/2013 - 10:03.</div>
    <div class="content">
     <p>Hi Paul,</p>
<p>next time you feel like you want to experiment some more in the software development field (pun intended :) you could try a git diff instead of deleting and reloading:</p>
<p>&nbsp;</p>
<p>root@raspberrypi:/var/www/emoncms/Modules/input# git diff -w process_model.php<br />
	diff --git a/Modules/input/process_model.php b/Modules/input/process_model.php<br />
	index d17f0ac..619b149 100644<br />
	--- a/Modules/input/process_model.php<br />
	+++ b/Modules/input/process_model.php<br />
	@@ -216,10 +216,27 @@ class Process<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataType::UNDEFINED<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $list[26] = array(<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _(&quot;My test&quot;),<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProcessArg::FEEDID,<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;my_test&quot;,<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1,<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataType::REALTIME<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );<br />
	+<br />
	+</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $list;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>+&nbsp;&nbsp;&nbsp; public function my_test($id, $time, $value){<br />
	+<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;feed-&gt;insert_data($id, $time, $time, $value);<br />
	+<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	+<br />
	+&nbsp;&nbsp;&nbsp; }<br />
	+<br />
	&nbsp;&nbsp;&nbsp;&nbsp; public function input($time, $value, $processList)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $process_list = $this-&gt;get_process_list();</p>
<p>&nbsp;</p>
<p>These are the changes I made to process_model.php with respect to the master version</p>
<p>a plus in front means you added a line, a minus means you removed it, the garbage at the beginning is an indicator of where in the file you made the change</p>
<p>If you need to check changes to more than one file, just omit the file name and move to the appropriate folder level to include all the directories in which you made changes:</p>
<p>root@raspberrypi:/var/www/emoncms/Modules# git diff -w<br />
	diff --git a/Lib/tablejs/custom-table-fields.js b/Lib/tablejs/custom-table-fields.js<br />
	index 3be2f15..5a839fe 100644<br />
	--- a/Lib/tablejs/custom-table-fields.js<br />
	+++ b/Lib/tablejs/custom-table-fields.js<br />
	@@ -113,7 +113,8 @@ var customtablefields = {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; key = &#39;- inp&#39;; type = 1; break;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case 23:<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; key = &#39;kwhkwhd&#39;; type = 2; break;<br />
	-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case 26:<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; key = &#39;test&#39;; type = 2; break;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(type)<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	diff --git a/Modules/feed/feed_model.php b/Modules/feed/feed_model.php<br />
	index 113d48e..f22bd23 100644<br />
	--- a/Modules/feed/feed_model.php<br />
	+++ b/Modules/feed/feed_model.php<br />
	@@ -276,10 +276,11 @@ class Feed<br />
	&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;mysqli-&gt;query(&quot;UPDATE feeds SET value = &#39;$value&#39;, time = &#39;$updatetime&#39; WHERE id=&#39;$feedid&#39;&quot;);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; //Check feed event if event module is installed<br />
	-&nbsp;&nbsp;&nbsp; // if (is_dir(realpath(dirname(__FILE__)).&#39;/../event/&#39;)) {<br />
	-&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; require_once(realpath(dirname(__FILE__)).&#39;/../event/event_model.php&#39;);<br />
	-&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; check_feed_event($feedid,$updatetime,$feedtime,$value);<br />
	-&nbsp;&nbsp;&nbsp; // }<br />
	+&nbsp;&nbsp;&nbsp; if (is_dir(realpath(dirname(__FILE__)).&#39;/../event/&#39;)) {<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require_once(realpath(dirname(__FILE__)).&#39;/../event/event_model.php&#39;);<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $event = new Event($this-&gt;mysqli);<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $event-&gt;check_feed_event($feedid,$updatetime,$feedtime,$value);<br />
	+&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	&nbsp;&nbsp; }<br />
	@@ -308,10 +309,11 @@ class Feed<br />
	&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;mysqli-&gt;query(&quot;UPDATE feeds SET value = &#39;$value&#39;, time = &#39;$updatetime&#39; WHERE id=&#39;$feedid&#39;&quot;);</p>
<p>&nbsp;&nbsp; //Check feed event if event module is installed<br />
	-&nbsp;&nbsp;&nbsp; // if (is_dir(realpath(dirname(__FILE__)).&#39;/../event/&#39;)) {<br />
	-&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; require_once(realpath(dirname(__FILE__)).&#39;/../event/event_model.php&#39;);<br />
	-&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; check_feed_event($feedid,$updatetime,$feedtime,$value);<br />
	-&nbsp;&nbsp;&nbsp; // }<br />
	+&nbsp;&nbsp;&nbsp; if (is_dir(realpath(dirname(__FILE__)).&#39;/../event/&#39;)) {<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require_once(realpath(dirname(__FILE__)).&#39;/../event/event_model.php&#39;);<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $event = new Event($this-&gt;mysqli);<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $event-&gt;check_feed_event($feedid,$updatetime,$feedtime,$value);<br />
	+&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	&nbsp;&nbsp; }<br />
	diff --git a/Modules/input/process_model.php b/Modules/input/process_model.php<br />
	index d17f0ac..619b149 100644<br />
	--- a/Modules/input/process_model.php<br />
	+++ b/Modules/input/process_model.php<br />
	@@ -216,10 +216,27 @@ class Process<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataType::UNDEFINED<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $list[26] = array(<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _(&quot;My test&quot;),<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProcessArg::FEEDID,<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;my_test&quot;,<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1,<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataType::REALTIME<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );<br />
	+<br />
	+</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $list;<br />
	&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>+&nbsp;&nbsp;&nbsp; public function my_test($id, $time, $value){<br />
	+<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;feed-&gt;insert_data($id, $time, $time, $value);<br />
	+<br />
	+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	+<br />
	+&nbsp;&nbsp;&nbsp; }<br />
	+<br />
	&nbsp;&nbsp;&nbsp;&nbsp; public function input($time, $value, $processList)<br />
	&nbsp;&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $process_list = $this-&gt;get_process_list();</p>
<p>&nbsp;</p>
<p>... if it looks like it is too complicated .. trust me, once you get used to it it isn&#39;t, and it&#39;s waay better then deleting everything and restarting from scratch ...</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>Mattia</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13579"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Fri, 12/07/2013 - 13:26.</div>
    <div class="content">
     <p>I totally agree with Mattia about the use of git.</p>
<p>If you want to develop a feature, a bugfix, whatever, here&#39;s a possible workflow:</p>
<p>Start from latest revision</p>
<pre>
git checkout master</pre><p>Create a branch and move to that branch</p>
<pre>
git checkout -b my_branch_for_feature_x</pre><p>After a development step, commit your changes.</p>
<pre>
git add modified_file

git commit</pre><p>While developping, you can check what you modified:</p>
<pre>
git diff

git difftool</pre><p>If you did a git add on a file, its changes are &quot;staged&quot;, and won&#39;t be indicated by a git diff or difftool, you can do an explicit</p>
<pre>
git diff HEAD</pre><p>When your changes are committed, you can checkout any other branch</p>
<pre>
git commit master</pre><p>then come back</p>
<pre>
git checkout my_branch_for_feature_x</pre><p>You are not supposed to change branch with uncommitted changes. But you can do it by &quot;stashing&quot; your work.</p>
<pre>
git stash</pre><p>When back to your dev branch, unstash</p>
<pre>
git stash pop</pre><p>I&#39;m realizing you already sent pull requests so you probably know a good part of it already.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13594"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Fri, 12/07/2013 - 23:04.</div>
    <div class="content">
     <p>Thanks for the advice Mattia/Jerome.</p>
<p>I&#39;ve spent tonight switching between commits for familiarity, and surprised&nbsp;how powerful &#39;Git&#39; is, but I don&#39;t think that I possess the necessary programming skills to yet positively contribute to OEM at the standard expected.</p>
<p>But I appreciate the encouragement and in time, I will learn... (but don&#39;t hold your breath!)</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13616"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Sun, 14/07/2013 - 09:41.</div>
    <div class="content">
     <p>I&#39;ve now successfully added a new function to the process_model.php module - &#39;max value&#39; which record the daily highest value of a particular feed. For example, to record the highest temperature that a particular feed reaches during that day, and resets at midnight. (Similar to facility offered in emonGLCD)<br />
	I&#39;ve had it&nbsp;successfully running on a development branch (thanks Mattia/Jerome!) for a couple of days, and it appears to work well, but would be grateful if you could have a quick look at this section of the code, to ensure there are no obvious mistakes which may cause problems for people later.<br />
	Next job - to add a &#39;min value&#39; to record the lowest daily feed value, which is more problematic, as on first run the database entry is 0, so the present value must be lower than 0 to meet the &#39;IF&#39; condition, otherwise the new value would remain 0.... hmmm......</p>
<p>Thanks<br />
	Paul</p>
<p>--------------------------------------&gt;&lt;--------------------------------------</p>
<p>public function max_value($feedid, $time_now, $value)<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $new_max = 0;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get last value<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last = $this-&gt;feed-&gt;get_timevalue($feedid);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_max = $last[&#39;value&#39;];<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_time = strtotime($last[&#39;time&#39;]);</p>
<p>// Check if we have a new max<br />
	if ($last_time) {</p>
<p>&nbsp;&nbsp; if ($value &gt; $last_max)<br />
	&nbsp;&nbsp; {<br />
	&nbsp;&nbsp; $new_max = $value;<br />
	&nbsp;&nbsp; }<br />
	&nbsp;&nbsp; else<br />
	&nbsp;&nbsp; {<br />
	&nbsp;&nbsp; $new_max = $last_max;<br />
	&nbsp;&nbsp; }<br />
	&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $feedtime = mktime(0, 0, 0, date(&quot;m&quot;,$time_now), date(&quot;d&quot;,$time_now), date(&quot;Y&quot;,$time_now));<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;feed-&gt;update_data($feedid, $time_now, $feedtime, $new_max);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	&nbsp;&nbsp;&nbsp; }</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13629"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Mon, 15/07/2013 - 18:29.</div>
    <div class="content">
     <p>Hi Paul.</p>
<p>Glad you&#39;re going down to it !</p>
<p>Here are my comments. Note that I didn&#39;t try your code and I don&#39;t have an extensive knowledge of the existing code, so I may be wrong.</p>
<p>- You&#39;re writing in the database every time, even when the max is unchanged. Why not do the writing only when it was changed ?</p>
<p>- AFAIU, [&#39;time&#39;] is the time when the sample was recorded. When writing in the DB, you are writing the present time, not the time of the max sample. Anyway, if you write only when max changed (see comment above), then it is correct.</p>
<p>- I don&#39;t see the daily reset in your code. (You wouldn&#39;t notice that in your tests if the max has been increasing each day.) Can you explain me how it is meant to reset ?</p>
<p>- I think (but I may be totally mistaken) that if($last_max)) ensures that a sample is there already, so it could take care of the first run issue.</p>
<p>It could look like this (absolutely not tested !!) :</p>
<p>--------------------------------------&gt;&lt;--------------------------------------</p>
<p>public function max_value($feedid, $time_now, $value)<br />
	&nbsp;&nbsp;&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get last value<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last = $this-&gt;feed-&gt;get_timevalue($feedid);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_max = $last[&#39;value&#39;];<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_time = strtotime($last[&#39;time&#39;]);</p>
<p>&nbsp;&nbsp;&nbsp; // Check if we don&#39;t have a higher value already</p>
<p>&nbsp;&nbsp;&nbsp; if (! ($last_time and ($value &lt;= $last_max))) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $feedtime = mktime(0, 0, 0, date(&quot;m&quot;,$time_now), date(&quot;d&quot;,$time_now), date(&quot;Y&quot;,$time_now))</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;feed-&gt;update_data($feedid, $time_now, $feedtime, $value);<br />
	&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	&nbsp;&nbsp;&nbsp; }</p>
<p>--------------------------------------&gt;&lt;--------------------------------------</p>
<p>This does not address the daily reset issue.</p>
<p>From a quick investigation in process_model.php, I&#39;d be tempted to use something like in the average function :</p>
<p>$result = $this-&gt;mysqli-&gt;query(&quot;SELECT * FROM $feedname WHERE time = &#39;$feedtime&#39;&quot;);</p>
<p>if (!$result), then don&#39;t define last_time, to force new max being written.</p>
<p>--------------------------------------&gt;&lt;--------------------------------------</p>
<p>public function max_value($feedid, $time_now, $value)<br />
	&nbsp;&nbsp;&nbsp; {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $feedname = &quot;feed_&quot; . trim($feedid) . &quot;&quot;;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $feedtime = mktime(0, 0, 0, date(&quot;m&quot;,$time_now), date(&quot;d&quot;,$time_now), date(&quot;Y&quot;,$time_now));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Search for a previous value for today</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $result = $this-&gt;mysqli-&gt;query(&quot;SELECT * FROM $feedname WHERE time = &#39;$feedtime&#39;&quot;);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!$result)&nbsp; {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // No value, set variables to 0 to force new value as the max</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_time =0;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_max = 0;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; } else {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; // There is a value for today</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; // Get last value (not optimal, we&#39;re fetching the DB again for the same line, we&#39;d better use $result, no time to investigate this right now)<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last = $this-&gt;feed-&gt;get_timevalue($feedid);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_max = $last[&#39;value&#39;];<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $last_time = strtotime($last[&#39;time&#39;]);</p>
<p>}</p>
<p>&nbsp;&nbsp;&nbsp; // Check if we don&#39;t have a higher value today already</p>
<p>&nbsp;&nbsp;&nbsp; if (! ($last_time and ($value &lt;= $last_max))) {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $feedtime = mktime(0, 0, 0, date(&quot;m&quot;,$time_now), date(&quot;d&quot;,$time_now), date(&quot;Y&quot;,$time_now))</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $this-&gt;feed-&gt;update_data($feedid, $time_now, $feedtime, $value);<br />
	&nbsp;&nbsp; }<br />
	&nbsp;<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $value;<br />
	&nbsp;&nbsp;&nbsp; }</p>
<p>--------------------------------------&gt;&lt;--------------------------------------</p>
<p>OK, this was my 2 cent feedback. Gotta go. Sorry for the crappy code indentation.</p>
<p>I hope I&#39;m not confusing. Things are a bit blurry to me and it is quite possible that I imagine problems where your implementation was correct already.</p>
<p>Good luck !</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13659"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Tue, 16/07/2013 - 21:21.</div>
    <div class="content">
     <p>Hi Jerome</p>
<p>I&#39;ve used the format used by the &#39;power to kwh/d&#39; function, and added;</p>
<p>$list[27] = array(<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _(&quot;max value&quot;),<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProcessArg::FEEDID,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;max_value&quot;,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataType::<strong>DAILY</strong><br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</p>
<p>....to the process_model.php file.<br />
	By setting it to &#39;DAILY&#39;, only one row is created per day in the database, and the value is updated on each cycle, with a fresh row being created at midnight., and which will contain that &#39;new&#39; day&#39;s max reading. So the database looks like this, with just one row for each 24hrs period.</p>
<p><img alt="" src="../sites/default/files/db.html" style="width: 453px; height: 151px;" /></p>
<p>I thought that this would be OK, as it doesn&#39;t significantly add &nbsp;to the database size, yet provides an historical daily record for later processing. Unfortunately, I don&#39;t fully understand how this works under the hood - just copied it by example &amp; desperation!</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-13662"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1531.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1531.gif" alt="Jérôme&#039;s picture" title="Jérôme&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Programming help</h3>

    <div class="submitted">Submitted by <a href="../user/1531.html" title="View user profile.">Jérôme</a> on Tue, 16/07/2013 - 22:50.</div>
    <div class="content">
     <p>Oh right, I missed the &quot;DataType::DAILY&quot; part. I had the feeling there was something I didn&#39;t understand. I don&#39;t know how this works under the hood either. I shall look into it. Someday...</p>
<p>It is possible that my other points apply. For instance, if value is less than max, you don&#39;t have to write anything, so I believe it is useless to do $new_max = $last_max, then write $new_max. Just a hint. I could be wrong.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/2573"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-0bC6hC4AeMaDelBNSOBE7cW7zfFI4AYUHCPRQfIlQDg" value="form-0bC6hC4AeMaDelBNSOBE7cW7zfFI4AYUHCPRQfIlQDg"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
