<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1312 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:53:23 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Reset on new NanodeRF SMT | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Reset on new NanodeRF SMT</h3>
        <span class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Sat, 10/11/2012 - 15:41</span>
        <div class="content"><p>Hi</p>
<p>Just received a pre assembled NanodeRF.</p>
<p>Down loaded the latest firmware and what I believe to be the correct libraries.</p>
<p>Monitoring serial port I get a string of DHCP failed then a DHCP status 1.</p>
<p>Then I get:-</p>
<p>SRV: 213.138.101.177<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=1806,3111<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0</p>
<p>	[webClient]<br />
	&nbsp;</p>
<p>As webclient print is in the setup loop I am assuming the watchdog timer is resetting.</p>
<p>The cycle then continues with many DHCP failed followed eventually by a data sent.</p>
<p>I presume I have 2 separate issues the first being DHCP set up.</p>
<p>Any suggestions to what is wrong? Have I missed a setting in the software?</p>
<p>I know emoncs.org is receiving the data as I added a new wireless node(18) at the same time and the inputs for that node have appeared on the web page.</p>
<p>UPDATE</p>
<p>I left the NanodeRF running for several hours.&nbsp;The DHCP is no longer failing.&nbsp;I now get continuous:-</p>
<p>[webClient]<br />
	DHCP status: 1<br />
	IP:&nbsp; 192.168.1.13<br />
	GW:&nbsp; 192.168.1.1<br />
	DNS: 8.8.8.8<br />
	DNS status: 1<br />
	SRV: 213.138.101.177<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;json={rf_fail:1}<br />
	Time request sent<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=1968,3111<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=1968,3111<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=1968,3111<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=1968,3111<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=1968,3111<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=1968,3111<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0</p>
<p>[webClient]<br />
	&nbsp;</p>
<p>So I seem to be left with a reset.&nbsp;</p>
<p>&nbsp;</p>
<p>Regards</p>
<p>Ian</p>
  <div class="forum-topic-navigation clear-block">
          <a href="1318.html" class="topic-previous" title="Go to previous forum topic">‹ How To: emoncms on NginX &amp; PHP5-FPM</a>
              <a href="1315.html" class="topic-next" title="Go to next forum topic">Smart way for migration from Cacti/RRDTool to emoncms? ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-7136"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Reset on new NanodeRF SMT</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 10/11/2012 - 17:54.</div>
    <div class="content">
     <p>For what it&#39;s worth, I&#39;m having HUGE problems with the (old) nanodeRF and Ethernet. It seems to be centred around DNS, though it can be accessing the controller or DHCP; but as I&#39;m no networking expert I&#39;m struggling.</p>
<p>I&#39;ve modified getDHCPandDNS.ino (out of the EtherCard library examples) to allow the port to be re-initialised under software control, and here are some stats:</p>
<p>Requests: 509<br />
	Success:&nbsp; 463<br />
	Reinits: 20<br />
	Failed to init: 3</p>
<p>&#39;Request&#39; is an attempt to submit data. &#39;Failed to init&#39; is any fault that meant it didn&#39;t get as far as getting an IP address to send the data to.&nbsp; If it fails 3 times in a row to get a response from the emoncms.org server, it re-initialises (&#39;Reinits&#39;) the port.</p>
<p>And enlarging the buffer from 700 to 1000 bytes</p>
<pre class="rteindent1">
byte Ethernet::buffer[1000]; </pre><p>seems to have helped.</p>
<p>========================</p>
<p>As for your watchdog timeout, the maximum that the watchdog can be set for is 8 s. If you don&#39;t reset it within that period, it will time out and cause a restart. Unless there&#39;s reset missing somewhere, I&#39;d suggest you need a longer timeout, but I don&#39;t know if it&#39;s possible to do that.</p>
<p>There&#39;s a list of the timeout constants <a href="http://tushev.org/articles/electronics/48-arduino-and-watchdog-timer">here</a>.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7146"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1894.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Ian Eagland&#039;s picture" title="Ian Eagland&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Reset on new NanodeRF SMT</h3>

    <div class="submitted">Submitted by <a href="../user/1894.html" title="View user profile.">Ian Eagland</a> on Sun, 11/11/2012 - 12:27.</div>
    <div class="content">
     <p>Many thanks for the reply.</p>
<p>I left it on logging the serial to file. About 5pm&nbsp;it started to work correctly. The reset was because I was not getting a response from the emoncms.org server. I did not not know that earlier as it is the first time I have used a nanodeRF. For the record and in case any one else has a similar problem the serial output is like this when all is well:-</p>
<p>Termite log, started at Sun Nov 11 11:06:40 2012<br />
	**********************************************************</p>
<p>[webClient]<br />
	DHCP status: 0<br />
	DHCP failed<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;json={rf_fail:1}<br />
	Time request sent<br />
	DHCP status: 1<br />
	IP:&nbsp; 192.168.1.13<br />
	GW:&nbsp; 192.168.1.1<br />
	DNS: 8.8.8.8<br />
	DNS status: 1<br />
	SRV: 213.138.101.177<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=2100,3086<br />
	OK received<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=2112,3086<br />
	OK received<br />
	Time request sent<br />
	Time: t11,08,44<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0<br />
	OK received<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=18&amp;csv=2112,3086<br />
	OK received<br />
	Data sent: /api/post.json?apikey=24a5c91daceb457805e259b1ae6cbc46&amp;node=20&amp;csv=0,0<br />
	OK received</p>
<p>And so on.</p>
<p>I guess my problem may have been caused by the server.</p>
<p>Regards</p>
<p>Ian</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7148"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Reset on new NanodeRF SMT</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 11/11/2012 - 16:04.</div>
    <div class="content">
     <p>I think either you&#39;re lucky, or I&#39;m not!&nbsp;</p>
<p>My analysis is:<br />
	The Ethernet functions can hang just about anywhere. Some of them have their own timeouts, that are much greater than the 8 s watchdog, hence the watchdog must be disabled to allow these to complete (or time out). DHCP depends on getting a reply from your router, in my case it either replies immediately or not at all. DNS depends on getting a reply from the DNS server, and that can take many seconds. Both these functions seem to have the own internal timeouts. But the function called to initialise the Ethernet, ether.begin( ), can hang indefinitely, therefore you need the watchdog enabled before that is called, and then disabled after to allow the DHCP and DNS functions ether.dhcpSetup( ) and dnsLookup( ) to return, and then enabled again to catch any hang-ups elsewhere.</p>
<p>The standard sketch indeed re-initialises if the server fails to respond after 10 tries. (This is done is a rather obscure way in line 219</p>
<pre>
if (ethernet_requests &gt; 10) delay(10000); // Reset the nanode 
      if more than 10 request attempts have been tried without a reply</pre><p>&nbsp;&nbsp; with a delay of 10s, which causes the watchdog to fire that in turn resets the processor).</p>
<p>I&#39;m hoping that the version that I&#39;m working on will intelligently allow the Ethernet initialisation to complete and still be robust enough to allow unsupervised operation.</p>
<p>And having found out a bit more about the watchdog timer, 8 s is the maximum that it is possible to set.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7149"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1741.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1741.jpg" alt="ukmoose&#039;s picture" title="ukmoose&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Reset on new NanodeRF SMT</h3>

    <div class="submitted">Submitted by <a href="../user/1741.html" title="View user profile.">ukmoose</a> on Sun, 11/11/2012 - 17:33.</div>
    <div class="content">
     <p>Robert, &nbsp;You&#39;ve probably tried this, but have you tried changing the&nbsp;dns server ip address in the dhcp_dns script?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-7175"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Reset on new NanodeRF SMT</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 11/11/2012 - 22:35.</div>
    <div class="content">
     <p>Thanks for the input.</p>
<p>Yes, with the NanodeRF_multinode.ino sketch, I&#39;ve tried Google (8.8.8.8) and my ISP&#39;s. At present, I&#39;m playing with the getDHCPandDNS.ino sketch from the EtherCard Library examples, using the EtherCard library default of (8.8.8.8). I&#39;m collecting stats to see just where the problems seem to lie. I sense there&#39;s a memory allocation/buffer overflow/timing problem somewhere, but I could well be wrong.</p>
<p>Over a period of exactly 8 hours yesterday, attempting every 5 s to post 3 integer values of test data to emoncms.org, this is what I recorded:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</p>
<table border="1" cellpadding="1" cellspacing="1" height="138" width="405">
<tbody>
<tr>
<td style="width: 384px;">
				Requests made:</td>
<td style="width: 77px;">
				4331</td>
</tr>
<tr>
<td style="width: 384px;">
				Successful:&nbsp;</td>
<td style="width: 77px;">
				3677</td>
</tr>
<tr>
<td style="width: 384px;">
				Reinitialised after 3 successive failures to obtain &#39;ok&#39;</td>
<td style="width: 77px;">
				267</td>
</tr>
<tr>
<td style="width: 384px;">
				Failed to access Ethernet controller</td>
<td style="width: 77px;">
				0</td>
</tr>
<tr>
<td style="width: 384px;">
				DHCP failed</td>
<td style="width: 77px;">
				9</td>
</tr>
<tr>
<td style="width: 384px;">
				DNS failed</td>
<td style="width: 77px;">
				102</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>(Since writing the 16:04 post above, I&#39;ve established the DNS timeout is close to 50 s - there&#39;s a 30 s timeout I can see in the library, I&#39;ve yet to understand where the additional 15 or more seconds comes from).</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1312"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-AcZf-1jVPm80DD_eS_GuI9h5vOV4zXuMc43gYTAoYVs" value="form-AcZf-1jVPm80DD_eS_GuI9h5vOV4zXuMc43gYTAoYVs"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/1312 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:53:23 GMT -->
</html>
