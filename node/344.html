<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/344 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:53:34 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Error compiling &quot;Mains AC Non-Invasive Energy Monitor (2 channel) | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Error compiling &quot;Mains AC Non-Invasive Energy Monitor (2 channel)</h3>
        <span class="submitted">Submitted by Guest on Sun, 08/01/2012 - 22:32</span>
        <div class="content"><p>What would cause this:</p>
<p>CURRENT_MONITOR.cpp.o: In function `loop':<br />
CURRENT_MONITOR.cpp:87: undefined reference to `Channel::emon_calc(int, double)'<br />
CURRENT_MONITOR.cpp:88: undefined reference to `Channel::emon_calc(int, double)'<br />
&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="694.html" class="topic-previous" title="Go to previous forum topic">‹ ethernet shield with arudino mega 2560</a>
              <a href="686.html" class="topic-next" title="Go to next forum topic">Bad Data from New Build (Newbie in need!) ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-2737"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/577.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Anonwelder&#039;s picture" title="Anonwelder&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Error compiling "Mains AC Non-Invasive Energy Monitor (2 channel)</h3>

    <div class="submitted">Submitted by <a href="../user/577.html" title="View user profile.">Anonwelder</a> on Sun, 15/01/2012 - 15:04.</div>
    <div class="content">
     <p>Hi swilus.</p>
<p>Did you ever get to the bottom of this error at all? I am getting a very similar message when attempting to verify Pauldreed's Solar Power Manager sketch. In my case I get:</p>
<p>sketch_Solar_Power_Meter.cpp.o: In function `loop':<br />
sketch_Solar_Power_Meter.cpp:124: undefined reference to `Channel::emon_calc(int, double) 'sketch_Solar_Power_Meter.cpp:125: undefined reference to `Channel::emon_calc(int, double)'</p>
<p>Any assistance would be great.</p>
<p>&nbsp;</p>
<p>AW</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2738"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/10.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-10.jpg" alt="glyn.hudson&#039;s picture" title="glyn.hudson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Error compiling "Mains AC Non-Invasive Energy Monitor (2 channel)</h3>

    <div class="submitted">Submitted by <a href="../user/10.html" title="View user profile.">glyn.hudson</a> on Sun, 15/01/2012 - 16:15.</div>
    <div class="content">
     <p>&nbsp;Have a look at the emonTx examples:&nbsp;<a href="https://github.com/openenergymonitor/emonTxFirmware">https://github.com/openenergymonitor/emonTxFirmware</a>&nbsp;they are more up to date and work well with Arduino 1.0.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-2873"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/577.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Anonwelder&#039;s picture" title="Anonwelder&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Error compiling "Mains AC Non-Invasive Energy Monitor (2 channel)</h3>

    <div class="submitted">Submitted by <a href="../user/577.html" title="View user profile.">Anonwelder</a> on Thu, 26/01/2012 - 15:41.</div>
    <div class="content">
     <p>Hi Glyn.</p>
<p>All verifying and compiling now. It was my error as I did not include the pde correctly. I can confirm that all is well in both Arduino v023 and Arduino 1.0.</p>
<p>Sorry for delay in replying as I am unable to access this site without going through a proxy server and my previous application had expired. </p>
<p>Thanks for your continued help.</p>
<p>AW</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3887"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="aam&#039;s picture" title="aam&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Error compiling "Mains AC Non-Invasive Energy Monitor (2 channel)</h3>

    <div class="submitted">Submitted by aam (not verified) on Wed, 18/04/2012 - 12:15.</div>
    <div class="content">
     <p>Hi all,</p>
<p>I am having&nbsp;exactly this&nbsp;problem compiling&nbsp;the energy monitor&nbsp;sketch for my&nbsp;Arduino, however&nbsp;I do not know what&nbsp;the pde mentioned&nbsp;above is.</p>
<p>Can&nbsp;anyone please help</p>
<p>Thankyou</p>
<p>Alan</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3899"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Error compiling "Mains AC Non-Invasive Energy Monitor (2 channel)</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Thu, 19/04/2012 - 07:51.</div>
    <div class="content">
     <p>Aam: have you downloaded and unziped EmonLib:&nbsp;<a href="https://github.com/openenergymonitor/EmonLib">https://github.com/openenergymonitor/EmonLib</a>&nbsp;into the arduino libraries folder?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-3905"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="aam&#039;s picture" title="aam&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Error compiling "Mains AC Non-Invasive Energy Monitor (2 channel)</h3>

    <div class="submitted">Submitted by aam (not verified) on Thu, 19/04/2012 - 09:30.</div>
    <div class="content">
     <p>Hi Trystan,</p>
<p>Yes I have downloaded EmonLib and put it in the library folder but still get:-</p>
<p>124: Undefined Reference to Channel::emon_calc (int, double)</p>
<p>125: Undefined Reference to Channel::emon_calc (int, double)</p>
<p>when compiling. I have pasted the code in below, any help will be much appreciated.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>//--------------------------------------------------------------------------------------<br />
	// Mains AC Non-Invasive Energy Monitor (2 channel)<br />
	// Last revision 27th Oct 2010<br />
	// Licence: GNU GPL<br />
	// By Trystan Lea (updated to support two channel energy monitoring by Glyn Hudson)<br />
	//--------------------------------------------------------------------------------------<br />
	//--------------------------------------------------------------------------------------<br />
	// VARIABLE DECLERATION<br />
	//--------------------------------------------------------------------------------------<br />
	&nbsp; //--ENERGY MEASURMENT VARIABLES------------------------------<br />
	&nbsp;<br />
	&nbsp; //Power measurement/time variables<br />
	&nbsp; unsigned long t_now, t_diff, t_last, t_culm;<br />
	&nbsp;&nbsp;<br />
	&nbsp; //kwhTotal is cumulative kwh today.<br />
	&nbsp; double Solarkwh =0.0;<br />
	&nbsp; double Mainskwh =0.0;<br />
	//--------------------------------------------------------------------------------------<br />
	// EMON<br />
	//--------------------------------------------------------------------------------------</p>
<p>	// include the library code:<br />
	#include &lt;LiquidCrystal.h&gt;&nbsp; // initialize the library with the numbers of the interface pins<br />
	LiquidCrystal lcd(8, 9, 10, 11, 12, 13);<br />
	int menuState = 0;<br />
	int menu = 0;</p>
<p>	int wavelengths = 3000;&nbsp;&nbsp; //number of wavelengths to sample<br />
	int inPinV = 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Analog input pin number that voltage signal is connected to<br />
	int inPinI_1 = 3;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Analog input pin number that current signal is connected to. Channel 1<br />
	int inPinI_2 = 2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Analog input pin number that current signal is connected to. Channel 2<br />
	int menupin = 1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Arduino pin 1 goes to pushbutton for menu<br />
	int RelayOn = 4;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Arduino pin 4 goes to the opto isolator (full power)<br />
	int HRelayOn = 3;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Arduino pin 3 goes to opto isolator (half power)<br />
	int led_on = 6;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Arduino pin 6 goes to panel LED</p>
<p>
	//channel 1<br />
	double VCAL = 1.28348;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Voltage calibration scaler<br />
	double ICAL_1 = 0.05815;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Current calibration scaler<br />
	double ICAL_2 = 0.05806;</p>
<p>	double PHASECAL = 2.3;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Shifts voltage relative to current,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //subtracting any phase shifting caused by components<br />
	&nbsp;&nbsp;&nbsp;<br />
	int emon_timeout = 2000;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //how long to wait ms if something goes wrong.</p>
<p>
	class Channel<br />
	{<br />
	&nbsp; public:<br />
	&nbsp;&nbsp;&nbsp; void emon_calc(int,double);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //create pulse function<br />
	&nbsp;&nbsp;&nbsp; double realPower,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Output variables<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apparentPower,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; powerFactor,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vrms,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Irms,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whInc,<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wh;</p>
<p>	&nbsp; private: // Variable declaration for emon_calc procedure<br />
	&nbsp;&nbsp; int lastSampleV,sampleV;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //sample_ holds the raw analog read value, lastSample_ holds the last sample_<br />
	&nbsp;&nbsp;&nbsp; int lastSampleI,sampleI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>	&nbsp;&nbsp;&nbsp; double lastFilteredV,filteredV;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Filtered_ is the raw analog value minus the DC offset<br />
	&nbsp;&nbsp;&nbsp; double lastFilteredI, filteredI;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; double phaseShiftedV;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Holds the calibrated phase shifted voltage.<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; double sqV,sumV,sqI,sumI,instP,sumP;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //sq = squared, sum = Sum, inst = instantaneous<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; int startV;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Instantaneous voltage at start of sample window.<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; boolean lastVCross, checkVCross;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Used to measure number of times threshold is crossed.<br />
	&nbsp;&nbsp;&nbsp; int crossCount;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // &#39;&#39;<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; unsigned long lwhtime, whtime;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //used to calculate energy used.</p>
<p>	};</p>
<p>	Channel ch1,ch2;&nbsp;&nbsp;&nbsp; //create two incidence of class channel for the two channels</p>
<p>	//--------------------------------------------------------------------------------------<br />
	// SETUP<br />
	//--------------------------------------------------------------------------------------<br />
	void setup()<br />
	{<br />
	&nbsp;&nbsp; lcd.begin(16, 2); // set up the LCD&#39;s number of columns and rows:<br />
	&nbsp;<br />
	&nbsp;&nbsp; Serial.begin(9600);<br />
	&nbsp;&nbsp; pinMode(RelayOn,OUTPUT); // this sets the pin named RelayOn to be an output<br />
	&nbsp;&nbsp; pinMode(HRelayOn,OUTPUT); // this sets the pin named RelayOn to be an output<br />
	&nbsp;&nbsp; pinMode(menupin, INPUT); // this sets the pin named menupin to be an input<br />
	&nbsp;&nbsp; pinMode (led_on, OUTPUT); //this sets the pin named led_on to be an output</p>
<p>	&nbsp;&nbsp; t_culm = (3600000 * 12);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //On first run, advances the 24hr timer by 12hrs (so can restart at midday!)&nbsp;<br />
	&nbsp;&nbsp; //t_culm = (3600000 * 23.75);&nbsp; //FOR TESTING ONLY<br />
	&nbsp;&nbsp;<br />
	&nbsp;&nbsp; digitalWrite(RelayOn,HIGH);&nbsp;&nbsp; //Switches relay off<br />
	&nbsp;&nbsp; digitalWrite(HRelayOn,HIGH);&nbsp; //Switches relay off<br />
	&nbsp;&nbsp;<br />
	&nbsp;&nbsp; //Introduces 15 second delay to allow caps to charge up<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;&nbsp; Please Wait&nbsp; &quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Initialising....&quot;);<br />
	&nbsp;&nbsp;&nbsp; delay (15000);<br />
	}</p>
<p>	unsigned long wtime;</p>
<p>	//--------------------------------------------------------------------------------------<br />
	// MAIN LOOP<br />
	//--------------------------------------------------------------------------------------<br />
	void loop()<br />
	{<br />
	&nbsp; //-------------------------------------------------------------------------------------------<br />
	&nbsp; // 1) Calculate energy monitor values<br />
	&nbsp; //-------------------------------------------------------------------------------------------<br />
	&nbsp; ch1.emon_calc(inPinI_1,ICAL_1);&nbsp; //Energy Monitor calc function for channel 1, pass Arduino analog in pin nummber and calibration coefficient<br />
	&nbsp; ch2.emon_calc(inPinI_2,ICAL_2);&nbsp; //Energy Monitor calc function, for channel 2, pass Arduino analog in pin nummber and calibration coefficient</p>
<p>	&nbsp; //--ENERGY MEASURMENT CALCULATION----------------&nbsp;&nbsp;<br />
	&nbsp;<br />
	&nbsp;//Power measurement<br />
	&nbsp; t_now = millis();<br />
	&nbsp;&nbsp;&nbsp; if ( t_now &gt; t_last ) {&nbsp;&nbsp; //check to see if millis has overflowed back to zero (after approx 49 days)<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t_diff = t_now - t_last; } //if not, the time each emon cycle takes<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else {&nbsp; //if millis has reset...<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t_diff = 4127; }&nbsp;&nbsp; //t_diff = (the amount of time each average emon cycle takes), again dealing with the millis reset.<br />
	&nbsp; t_culm += t_diff;<br />
	&nbsp; t_last = t_now;<br />
	&nbsp;<br />
	&nbsp; if ( t_culm &gt; (3600000 * 24)){ //check to see if 24hrs has elapsed<br />
	&nbsp; Solarkwh = 0; // RESET<br />
	&nbsp; Mainskwh = 0; // RESET<br />
	&nbsp; t_culm = 0;&nbsp;&nbsp; // RESET<br />
	&nbsp; }</p>
<p>	&nbsp; //ch1.realPower = 2534;&nbsp; //FOR TESTING ONLY<br />
	&nbsp; //ch2.realPower = 1522;&nbsp; //FOR TESTING ONLY<br />
	&nbsp;<br />
	&nbsp; //Calculate number of kwh generated.<br />
	&nbsp; Solarkwh = Solarkwh + ((ch1.realPower/1000.0) * 1.0/3600.0 * (t_diff/1000.0));<br />
	&nbsp; Mainskwh = Mainskwh + ((ch2.realPower/1000.0) * 1.0/3600.0 * (t_diff/1000.0));&nbsp;</p>
<p>	&nbsp;&nbsp;&nbsp; //------------Data Output-------------<br />
	&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; //Read menupin to see what menu to display<br />
	&nbsp;&nbsp;&nbsp; menuState = digitalRead(menupin);<br />
	&nbsp;&nbsp;&nbsp; if ( menuState == LOW) {<br />
	&nbsp;&nbsp;&nbsp; menu = menu+1; }<br />
	&nbsp;&nbsp;&nbsp; if (menu &gt; 4){<br />
	&nbsp;&nbsp;&nbsp; menu = 0;<br />
	&nbsp;&nbsp;&nbsp; }&nbsp;<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; //MENU 0&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; if (menu == 0) {<br />
	&nbsp;&nbsp;&nbsp; // clear the lcd screen<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; //if-else statement to alter LCD print format depending upon power reading<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch1.realPower &gt;= 1000)&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lcd.print(&quot;Solar &quot;); lcd.print(ch1.realPower / 1000.0, 3); lcd.print(&quot; kW&quot;);&nbsp; }<br />
	&nbsp;&nbsp;&nbsp; else&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lcd.print(&quot;Solar &quot;); lcd.print(ch1.realPower, 0); lcd.print(&quot; Watts&quot;);&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch2.realPower &gt;= 5000)&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lcd.print(&quot;M/Power over 5kW&quot;); }<br />
	&nbsp;&nbsp;&nbsp; else<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch2.realPower &gt;= 1000)&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lcd.print(&quot;Mains &quot;); lcd.print(ch2.realPower / 1000.0, 3); lcd.print(&quot; kW&quot;);&nbsp; }<br />
	&nbsp;&nbsp;&nbsp; else&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lcd.print(&quot;Mains &quot;); lcd.print(ch2.realPower, 0); lcd.print(&quot; Watts&quot;);&nbsp; }<br />
	&nbsp;&nbsp;&nbsp; }</p>
<p>	&nbsp;&nbsp;&nbsp; //MENU 1 - to enable detailed readings for calibration<br />
	&nbsp;&nbsp;&nbsp; if (menu == 1) {<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Solar &quot;); lcd.print(Solarkwh); lcd.print(&quot; kWh&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Mains &quot;); lcd.print(Mainskwh); lcd.print(&quot; kWh&quot;);&nbsp; }</p>
<p>	&nbsp;&nbsp;&nbsp; //MENU 2 - to enable detailed readings for calibration<br />
	&nbsp;&nbsp;&nbsp; if (menu == 2) {<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;PowerF &quot;); lcd.print(ch1.powerFactor, 2);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Voltage &quot;); lcd.print(ch1.Vrms, 0); lcd.print(&quot; V&quot;);&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; //MENU 3 - to enable detailed readings for calibration<br />
	&nbsp;&nbsp;&nbsp; if (menu == 3) {<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Solar &quot;); lcd.print(ch1.realPower, 0); lcd.print(&quot; W&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Mains &quot;); lcd.print(ch2.realPower, 0); lcd.print(&quot; W&quot;);&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;<br />
	&nbsp;&nbsp;&nbsp; //MENU 4 - DEMO MODE<br />
	&nbsp;&nbsp;&nbsp; if (menu == 4) {<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print (&quot;Press button for&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;3 secs for demo&quot;);<br />
	&nbsp;&nbsp;&nbsp; delay (3000);<br />
	&nbsp;&nbsp;&nbsp; if (digitalRead(menupin)== LOW) {&nbsp; //check to see if button is still pressed<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print (&quot;DEMO MODE&quot;);<br />
	&nbsp;&nbsp;&nbsp; delay (2000);<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Solar 1.326 kW&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Mains 298 Watts&quot;);<br />
	&nbsp;&nbsp;&nbsp; digitalWrite (led_on,HIGH);<br />
	&nbsp;&nbsp;&nbsp; delay (10000);<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Solar 18.36 kWh&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Mains 4.29 kWh&quot;);<br />
	&nbsp;&nbsp;&nbsp; digitalWrite (led_on,HIGH);<br />
	&nbsp;&nbsp;&nbsp; delay (10000);<br />
	&nbsp;&nbsp;&nbsp; lcd.clear();<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 0);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;PowerF 0.98&quot;);<br />
	&nbsp;&nbsp;&nbsp; lcd.setCursor(0, 1);<br />
	&nbsp;&nbsp;&nbsp; lcd.print(&quot;Voltage 247 V&quot;);<br />
	&nbsp;&nbsp;&nbsp; digitalWrite (led_on,HIGH);<br />
	&nbsp;&nbsp;&nbsp; delay (10000);<br />
	&nbsp;&nbsp;&nbsp; menu = 0; }<br />
	&nbsp;&nbsp;&nbsp; else {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; menu = 0; }<br />
	&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp;//checks to see if can run at full power<br />
	&nbsp; if (ch1.realPower &gt; (ch2.realPower +1090)) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; digitalWrite(HRelayOn,HIGH); //turn the half power output off<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; digitalWrite(RelayOn,LOW); //turn the full output on<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp; else{<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; digitalWrite(RelayOn,HIGH); //turn the output off<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //checks to see if can run at half power<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch1.realPower &gt; (ch2.realPower +545)) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; digitalWrite(HRelayOn,LOW); }//turn the output on<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else&nbsp; {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; digitalWrite(HRelayOn,HIGH); //turn the output off<br />
	&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;&nbsp; }<br />
	&nbsp;//LED control<br />
	&nbsp;&nbsp; if (digitalRead(RelayOn) == LOW) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; analogWrite(led_on, 200);&nbsp; }<br />
	&nbsp;&nbsp; else if (digitalRead(HRelayOn) == LOW) {<br />
	&nbsp;&nbsp;&nbsp;&nbsp; analogWrite(led_on, 30);&nbsp;&nbsp; } //quarter brightness<br />
	&nbsp;&nbsp; else {<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; digitalWrite (led_on,HIGH);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay (100);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; digitalWrite (led_on,LOW);<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
	&nbsp;}</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-4551"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="fabiusmontana&#039;s picture" title="fabiusmontana&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Error compiling "Mains AC Non-Invasive Energy Monitor (2 channel)</h3>

    <div class="submitted">Submitted by fabiusmontana (not verified) on Tue, 22/05/2012 - 15:58.</div>
    <div class="content">
     <p><span id="result_box" lang="en"><span class="hps">Hello everyone</span><span>.</span><br />
	<span class="hps">I&#39;m</span> <span class="hps">having the same problem</span><span>.</span> <span class="hps">I installed</span> <span class="hps">all</span> <span class="hps">the libraries</span><span>,</span> <span class="hps">but the error</span> <span class="hps">remains:</span></span></p>
<p>122: undefined reference to `Channel::emon_calc(int, double)</p>
<p>123: undefined reference to `Channel::emon_calc(int, double)&#39;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/344"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-O4X0Mjvsu5TwQRbgNdkX1atoHe2RAlF7rGqXgzHU-58" value="form-O4X0Mjvsu5TwQRbgNdkX1atoHe2RAlF7rGqXgzHU-58"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/344 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:53:34 GMT -->
</html>
