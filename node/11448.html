<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11448 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:58:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Emonpi &amp; Socket Interfacer help | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/6.html">Archived: Questions and support </a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Emonpi &amp; Socket Interfacer help</h3>
        <span class="submitted">Submitted by <a href="../user/8878.html" title="View user profile.">paddyb</a> on Tue, 20/10/2015 - 19:38</span>
        <div class="content"><p>Hi - I recently purchased an Emonpi and am very happy with it so far. I have been trying to setup multi-tarrif&nbsp;cost calculations following various threads I&nbsp;found here in the forums like these:</p>
<address>http://openenergymonitor.org/emon/node/6100 and http://openenergymonitor.org/emon/node/10175</address>
<p>I understand the principles of what I&nbsp;need to do, but so far I have not been able to update&nbsp;input values of the node I&nbsp;created to hold the &#39;currentcost&#39;, &#39;onpeak&#39; and &#39;offpeak&#39; parameters with any script. In my emonhub&nbsp;conf&nbsp;file I have declared a socket interface like this:</p>
<p>[[Socket]] &nbsp; # Socket Interfacer<br />
&nbsp; &nbsp; Type = EmonHubSocketInterfacer<br />
&nbsp; &nbsp; [[[init_settings]]]<br />
&nbsp; &nbsp; &nbsp; &nbsp; port_nb = 50824<br />
&nbsp; &nbsp; [[[runtimesettings]]]</p>
<p>but when I&nbsp;try&nbsp;to post data to it using any of the sample python scripts I have found I get an error returned in my shell saying &quot;socket.error: [Errno 111] Connection refused&quot;. If I run a netstat command directly on my EmonPi&nbsp;It does not display&nbsp;my chosen port as &#39;listening&#39; on the local address/port column (I am presuming it should be displayed here ?). I have tired various different port numbers incase any particular&nbsp;one was used by another application. Which ever one I tired I&nbsp;get the same message. I also made sure to add any declared port to the UFW firewall rule. I have tired running my value posting script locally on the EmonPi and also from remote machines (with the HOST parameter updated accordingly) but always get the same error.</p>
<p>Any ideas what I might be doing wrong? Is there something different or unusual here because its the low-write emoncms&nbsp;running on the PI (shop bought unaltered emonpi&nbsp;with&nbsp;low-write-v8.5)</p>
<p>Is there any other method of updating &#39;input&#39; values? I have read the HTTP JSON posting method is not yet implemented on the PI but that was an older post - is this still accurate?</p>
<p>Any help or advice&nbsp;greatly appreciated.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11361.html" class="topic-previous" title="Go to previous forum topic">‹ new inactive nodes appearing</a>
              <a href="11186.html" class="topic-next" title="Go to next forum topic">EmonCMS 9.0 Installation guide issues ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-35168"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8878.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8878.jpg" alt="paddyb&#039;s picture" title="paddyb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/8878.html" title="View user profile.">paddyb</a> on Tue, 20/10/2015 - 19:44.</div>
    <div class="content">
     <p>I should have shown the script I am using when attempting to update the values.. As far as I can see it should work based on the many other examples I have found scattered around the forum.</p>
<pre>

#!/usr/bin/python
import socket
# &quot;frame&quot; string starting with a node id followed by values$
frame = &#39;17 19550 1 0&#39;
# Parameters #
# HOST: hostname or IP address of emonHub
HOST = &#39;localhost&#39;
# PORT: port number to the emonHub interfacer
PORT = 50824
# Code #
# Append line ending
frame = frame + &#39;\r\n&#39;
# Send frame of data
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))
s.send(frame)
s.close()</pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35180"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 20/10/2015 - 22:02.</div>
    <div class="content">
     <p>What is logged in emonhub.log when emonhub&nbsp;is (re)started?&nbsp;</p>
<p>Does it show the socket interfacer&nbsp;as successfully created or are there any errors, you may&nbsp;need to set loglevel&nbsp;= DEBUG in emonhub.conf to get the full picture.</p>
<p>Your conf and script look ok to me, I would of said check the port is enabled in ufw but you&#39;ve done that, did you restart (re-enable)&nbsp;ufw after adding the new rules?</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35183"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8878.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8878.jpg" alt="paddyb&#039;s picture" title="paddyb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/8878.html" title="View user profile.">paddyb</a> on Tue, 20/10/2015 - 22:42.</div>
    <div class="content">
     <p>Hi - thank you very much for helping me. I did the restart of emonhub as suggested and see this in the log actually:</p>
<pre>
&quot;ERROR MainThread Unable to create &#39;Socket&#39; interfacer: global name &#39;socket&#39; is not defined&quot;</pre><p>I then changed the name of my interfacer to Test_Skt incase the original&nbsp;title I&nbsp;chose of &#39;socket&#39; in case it clashed with some kind of namespace&nbsp;or reserverd&nbsp;keywords but I get the same error message:</p>
<pre>
INFO     MainThread Creating EmonHubSocketInterfacer &#39;Test_Skt&#39; 
DEBUG    MainThread Opening socket on port 50824
ERROR    MainThread Unable to create &#39;Test_Skt&#39; interfacer: global name &#39;socket&#39; is not defined</pre><p>Does this mean anything to anyone?&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35184"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 20/10/2015 - 22:56.</div>
    <div class="content">
     <p>Try adding &quot;import socket&quot; as the first line to ~/emonhub/src/emonhub_interfacer.py</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35187"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8878.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8878.jpg" alt="paddyb&#039;s picture" title="paddyb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/8878.html" title="View user profile.">paddyb</a> on Tue, 20/10/2015 - 23:17.</div>
    <div class="content">
     <p>I found that file one folder deeper than you said, in &quot;/home/pi/emonhub/src/interfacers&quot;, but it already has import socket in it. It was the fifth item in the import list. I moved it to the top anyway but still get the same &quot;global name &#39;socket&#39; is not defined&quot; message</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35189"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 20/10/2015 - 23:45.</div>
    <div class="content">
     <p>Sorry my mistake I gave you the &quot;other&quot; location by mistake I had both the &quot;emon-pi&quot; variant and original emonhub&nbsp;files open to compare. I have not used a socket interfacer on emonPi&nbsp;yet, but I know they work fine on the genuine emonhub as I use them frequently.</p>
<p>Your reply has confused me somewhat as you say this is on a emonPi, correct?</p>
<p>The suggestion to add that import came from comparing the files as above.</p>
<p>The import is clearly missing from the&nbsp;emon-pi variant <a href="https://github.com/openenergymonitor/emonhub/blob/emon-pi/src/interfacers/EmonHubSocketInterfacer.py#L1">(see here)</a>&nbsp;and it can be correctly found as the 5th import on the original version <a href="https://github.com/emonhub/emonhub/blob/development/src/emonhub_interfacer.py#L14">(see here)</a>. in which case I&#39;m thrown as the location says emon-pi variant but the import entry contradicts that, no wonder you are having troubles, Have you changed anything or can you shed any light on&nbsp;the confusion?</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35190"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Tue, 20/10/2015 - 23:58.</div>
    <div class="content">
     <p>I think I sussed&nbsp;it!&nbsp;</p>
<p>The file you should be looking at is&nbsp;<strong>/home/pi/emonhub/src/interfacers/EmonHubSocketInterfacer.py</strong>, when the interfacers&nbsp;were split out into seperate&nbsp;files in&nbsp;that version the import must of&nbsp;got left behind in&nbsp;/home/pi/emonhub/src/interfacers/emonhub_interfacer.py.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35218"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8878.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8878.jpg" alt="paddyb&#039;s picture" title="paddyb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/8878.html" title="View user profile.">paddyb</a> on Wed, 21/10/2015 - 20:57.</div>
    <div class="content">
     <p>Hi Paul,</p>
<p>I can confirm I am definitely using a genuine&nbsp;EmonPi, in its lovely aluminum case,&nbsp;bought from the OEM shop.&nbsp;I also definitely have the files u pointed to in your first link to the the&nbsp;emon-pi variant.&nbsp;</p>
<p>I am very much a python amature, but in the file&nbsp;EmonHubSocketInterfacer.py it does&nbsp;import&nbsp;emonhub_interfacer.py. I assumed&nbsp;when it does that, that it kind-of inherited&nbsp;any required&nbsp;imports&nbsp;required or called by the first file? (could be mistaken).</p>
<p>Anyways, just to try something, I added the&nbsp;serial, time, datetime, logging, socket &amp; select imports to the&nbsp;EmonHubSocketInterfacer.py file and rebooted. Now it does create the socket, but when I run my script to update the values, the script executes without errors so it thinks it sent the values to a socket who listened, but on the input page&nbsp;they don&#39;t&nbsp;actually update. The instant I execute my script the log starts to fill with this message:</p>
<pre>
WARNING MainThread Test_Sock2 thread is dead
</pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35266"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4440.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4440.jpg" alt="pb66&#039;s picture" title="pb66&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/4440.html" title="View user profile.">pb66</a> on Fri, 23/10/2015 - 12:39.</div>
    <div class="content">
     <p>You would think the python imports would work like that (many users do), I expected that behaviour&nbsp;too when I first started using python, however no, that&#39;s not how python works unfortunately, You can &quot;apparently&quot; find or access the inherited imports by using something like importedparentmodule.moduleparentimported.function (eg something like s = emonhub_interfacer.serial.serial(port, baud)) but it is frowned upon and considered wrong, in fact I have only read one instance of it it the literally hundreds of posts I read on imports whilst trying to fathom the &quot;quirky&quot; import system.</p>
<p>Each module should import all its own stuff, this doesn&#39;t open another instance of the imported modules, just links to the existing instance if there is one.</p>
<p>As for the &quot;thread is dead&quot; I&#39;m afraid I do not have a clue :-(, I have only ever used sockets in the original emonHub and they have never given cause to do any debugging so I&#39;m not really sure what you can check, but I will post anything I think of and if i get time i will take a closer look.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-35311"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8878.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8878.jpg" alt="paddyb&#039;s picture" title="paddyb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Emonpi & Socket Interfacer help</h3>

    <div class="submitted">Submitted by <a href="../user/8878.html" title="View user profile.">paddyb</a> on Sat, 24/10/2015 - 11:12.</div>
    <div class="content">
     <p>Thanks for the explanation and all the help so far. I have kinda given up on getting this to work on my EmonPi as I have managed to complete my goal of multi tariff recording on emoncms.org instead (also thanks to your help in a different thread :) )</p>
<p>If a new version is released for EmonPi I will upgrade to it and try again. I guess for now if any of the devs see this they could mark this feature as needing improvement in future versions.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11448"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-pOHbakXHBidHug30JfR-XnILGTaRGBXzT1WYfZFpmic" value="form-pOHbakXHBidHug30JfR-XnILGTaRGBXzT1WYfZFpmic"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
