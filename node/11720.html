<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/11720 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:48:46 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonCMS 9.2 migration data corruption | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonCMS 9.2 migration data corruption</h3>
        <span class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Tue, 01/12/2015 - 13:49</span>
        <div class="content"><p>After migrating to 9.2 from 8.5 I noticed after a day or so that daily phptimeseries&nbsp;feeds were not updating anymore. Digging in logs I came to notice that a lot of PHP errors were being generated around&nbsp;timezone issues.</p>
<p>The reason for this was that some user still had an old timezone entry in the database (ie. -1, 2 etc. instead of a proper php timezone entry like&nbsp;&#39;Europe/Amsterdam&#39;.)</p>
<p>Is it an idea to check for that in the user_model.php code (function&nbsp;get_timezone($userid)) catching the exception and defaulting to a proper timezone</p>
<p>&nbsp;</p>
<p>Furthermore, my phptimeseries data seems corrupted now, will the recover script still work with emoncms 9.2?</p>
<p>&nbsp;</p>
<p>Somehow the data seems to be there, when I use the simplezoom&nbsp;widget the daily&nbsp;data is visible, when using the zoom widget only some daily data from 2012..... any idea?</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="11799.html" class="topic-previous" title="Go to previous forum topic">‹  (BETA): emonSD22Dec15 - emonPi / emonBase (Raspberry Pi + RFM69Pi) Emoncms v9 pre-built ready</a>
              <a href="12135.html" class="topic-next" title="Go to next forum topic">Web hosted emoncms 9.2 won&#039;t save settings for My Electric ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-36551"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Tue, 01/12/2015 - 22:06.</div>
    <div class="content">
     <p><em>still had an old timezone entry in the database...</em><br />
An interesting point! I&#39;ll flag that up as an issue to be looked at.</p>
<p><em>Furthermore, my phptimeseries data seems corrupted now...</em><br />
I don&#39;t think that this can be rectified easily. Emoncms&nbsp;has evolved in v9 to interpret&nbsp;time zones differently to the previous version, which has meant that it gathers &#39;daily feed data&#39; possibly within a different time-frame, resulting in it not being captured. The data is still there - but it&#39;s not displayed.</p>
<p>I&#39;ve discussed this with Trystan&nbsp;&amp; Chaveiro&nbsp;previously and remains unresolved.</p>
<p>Paul</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36552"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8066.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="firefox7518&#039;s picture" title="firefox7518&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/8066.html" title="View user profile.">firefox7518</a> on Tue, 01/12/2015 - 22:50.</div>
    <div class="content">
     <p>arjen, this is also exactly my issue since i migrated to 9.1. I asked for help here:&nbsp;<a href="11566.html">http://openenergymonitor.org/emon/node/11566</a></p>
<p>Can you check if it is the same for you when looking on the data in the edit section of the visualization?&nbsp;</p>
<p>I had almost 100 accounts on it and 500 inverters sending data to it. Of course I did not thought that it could be that harmful to the data so I only changed the timezone for my valid clients and left the others as they are. Your find could be actually the reason for this strange behavior we have.</p>
<p>If this is true it would be maybe great to update the table to default UTC timezone for every account to be save?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36553"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Wed, 02/12/2015 - 00:56.</div>
    <div class="content">
     <p>@Paul</p>
<p>&gt;An interesting point! I&#39;ll flag that up as an issue to be looked at.</p>
<p>I saw it on github, thanks!</p>
<p>&nbsp;</p>
<p>But it gets stranger, the new day here has begun and the data is visible again. I thought I&#39;ve seen the same thing last morning but now I can confirm this behavior. But I cannot explain why.... I will check again during the day.</p>
<p>All seems fine now.</p>
<p><img alt="" src="../../../getsem.info/data_zoom_after.png" style="width: 600px; height: 406px;" /></p>
<p>&gt;I don&#39;t think that this can be rectified easily.&nbsp;</p>
<p>On a test domain I placed a backup of the data&nbsp;from before the migration to 9.2 but with the current emoncms 9.2 build. Same behavior, so I don&#39;t think the data is really corrupt.</p>
<p>I will put the complete old build including recent data back to see what happens.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36561"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Wed, 02/12/2015 - 01:30.</div>
    <div class="content">
     <p>It&#39;s now 2:25 and all (!) data seems to be there...... ???</p>
<p><img alt="" src="../../../www.getsem.info/data_zoom_225.png" style="width: 600px; height: 352px;" /></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36563"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8066.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="firefox7518&#039;s picture" title="firefox7518&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/8066.html" title="View user profile.">firefox7518</a> on Wed, 02/12/2015 - 06:18.</div>
    <div class="content">
     <p>Check daily again. My Zoom widget shows every day different Total kWh values! One day I have a total of 5800kWh and the other day it&#39;s 11800kWh! On these days it goes back to April where I started the feed.</p>
<p>As checked in the visual edit daily functionality the data seems to be there and complete but somehow the timezones are acting up?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36574"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Wed, 02/12/2015 - 11:13.</div>
    <div class="content">
     <p>Ok, I placed an older (8.4.0) version of emoncms&nbsp;on the server against&nbsp;the current data, using the vis edit daily of this version I suddenly see an extra datapoint&nbsp;on the day I did the migration to 9.2. This datapoint is offset by -1 hour.&nbsp;</p>
<p>I can select the datapoint and click on delete but this does only set the datapoint to zero. Is there a way to really delete this specific datapoint?</p>
<p><img alt="" src="../../../www.getsem.info/data_zoom_old_emoncms_vis.PNG" style="width: 601px; height: 316px;" /></p>
<p>&nbsp;</p>
<p>and since the time has passed 12:00 the data is skewed again.</p>
<p><img alt="" src="../../../www.getsem.info/data_zoom_1206.PNG" style="width: 600px; height: 490px;" />&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36578"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Thu, 03/12/2015 - 05:25.</div>
    <div class="content">
     <p>Ok, found a way to delete the datapoint using a modified version of the recovery script found in the &quot;usefulscripts&quot;&nbsp;repo</p>
<p>For those that need it and know the time entry of the faulty datapoint change the following lines in common.php:</p>
<p>$dp = unpack(&quot;x/Itime/fvalue&quot;,$d);<br />
fwrite($fhw, pack(&quot;CIf&quot;,249,$dp[&#39;time&#39;],$dp[&#39;value&#39;]));</p>
<p>to:</p>
<p>$dp = unpack(&quot;x/Itime/fvalue&quot;,$d);<br />
if ($dp[&#39;time&#39;]==TIMEVALUE) { &nbsp;//replace TIMEVALUE by something as&nbsp;1448751600<br />
&nbsp;&nbsp; &nbsp;echo &quot;Time entry found and skipping\n&quot;;<br />
&nbsp;&nbsp; &nbsp;}<br />
else {<br />
&nbsp;&nbsp; &nbsp;fwrite($fhw, pack(&quot;CIf&quot;,249,$dp[&#39;time&#39;],$dp[&#39;value&#39;]));<br />
&nbsp;&nbsp; &nbsp;}</p>
<p>&nbsp;</p>
<p>Data still not visible in the new version of emoncms though. Maybe there is some other issues that is casuing the data to be displayed incorrectly.</p>
<p>&nbsp;</p>
<p>Update:</p>
<p>&nbsp;</p>
<p>When I change the following line in zoom.php</p>
<p>get_feed_data_async(vis_feed_kwh_data_callback,null,kwhd,start,end,3600*24,1,1);</p>
<p>to:</p>
<p>get_feed_data_async(vis_feed_kwh_data_callback,null,kwhd,start,end,3600*24,1,0); (limit interval to 0 / false)</p>
<p>the data gets&nbsp;visible again. This is logical as the phptimeseries engine then just bluntly feeds all available entries back in the data array.</p>
<p>Somehow this piece of code in the phptimeseries engine is causing an undesirable effect.</p>
<p>if ($limitinterval)<br />
{<br />
$diff = abs($dptime-$time);&nbsp;<br />
if ($diff&lt;($interval/2)) { &nbsp;<br />
$value = $array[&#39;value&#39;];<br />
}</p>
<p>not sure yet why tho</p>
<p>In the phptimeseries DB files I can see that during the last year the time entry (epoch) jumps&nbsp;two times from daily at 22:00 to daily at&nbsp;21:00, the&nbsp;dates match DST time changes so that&#39;s probably correct. But after the update to 9.2 the entries are at 23:00.</p>
<p>Could this be the reason that the zoom graph has issues showing the data? If so, it might be an idea to write a script based on the recovery script&nbsp;that takes feed_id and timezone as input and resets all datapoints&nbsp;to the proper time?</p>
<p>If this is the case I can try to write such a script.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36608"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Thu, 03/12/2015 - 08:46.</div>
    <div class="content">
     <p>Paul,</p>
<p>&nbsp;</p>
<p>I think I have a solution. The visualisation&nbsp;widgets use the current time als input to get data within&nbsp;a certain time frame. This can cause the phptimeseries engine to &#39;miss&#39; data entries if&nbsp;the option &quot;$limitinterval&quot; is set to true as in the code to get the data it is being checked whether the found data is within given interval/2.</p>
<p>I think the best solution for this is to first seek for the first data item in the given timeframe and then &#39;sync&#39; the entry&#39;s time value to be the start time entry for the further search. This puts the start of the interval search at an real data item and also speeds up the data gathering if the data set on disk is smaller than the given timeframe.&nbsp;</p>
<p>Items found after this and still&nbsp;not fit within&nbsp;interval/2 can then be discarded with confidence.</p>
<p>I will put up a pull request to implement this.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36614"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8066.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="firefox7518&#039;s picture" title="firefox7518&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/8066.html" title="View user profile.">firefox7518</a> on Thu, 03/12/2015 - 10:34.</div>
    <div class="content">
     <p>I tried your git hub fix. Funny thing is that it shows the data from April to October when the DST happened. After that the data will not be shown :-)&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36616"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Thu, 03/12/2015 - 11:03.</div>
    <div class="content">
     <p>Strange, then probably the first data entry falls outside the interval/2 range. What happens if you place in the following function of phptimeseries.php</p>
<p>public function get_data($feedid,$start,$end,$interval,$skipmissing,$limitinterval)</p>
<p>&nbsp;</p>
<p>at the top of the function the follwing&nbsp;line:</p>
<p>$limitinterval = 0;</p>
<p>So it becomes:</p>
<p>public function get_data($feedid,$start,$end,$interval,$skipmissing,$limitinterval)<br />
{</p>
<p>$limitinterval&nbsp;= 0;<br />
$start = intval($start/1000);</p>
<p>[...etc]</p>
<p>?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36727"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Fri, 04/12/2015 - 22:36.</div>
    <div class="content">
     <p>I&#39;ve dig into phpTimeSeries engine code and i saw something i didn&#39;t notice before.</p>
<p>The engine format expects 9 bytes per data point.</p>
<p>But the way of writing this 9 bytes with <strong>fwrite($fh, pack(&quot;<u>CIf</u>&quot;,249,$time,$value))</strong> , expecting 1 + 4 + 4 bytes for 249char, time and value respectively.</p>
<p>The problem is that pack format <u><strong>l</strong></u> and<strong> <u>f</u></strong> for time and value is platform/os dependent.<br />
Meaning that real size in some platforms could take 17 bytes (1+8+8) or 13 bytes (1+8+4 or 1+4+8) but the engine expects only 9bytes.</p>
<p>From PHP documentation:<br />
<strong>C</strong> - unsigned char<br />
<strong>I&nbsp;</strong> - unsigned integer (machine dependent size and byte order)<br />
<strong>f</strong> - float (machine dependent size and representation)</p>
<p>So i would not recommend using phpTimeSeries engine if you are not sure what sizes your platform / OS 32vs64bits / PHP version will use, because anything different from 9bytes will break the feed data.</p>
<p>&nbsp;</p>
<p>Update:<br />
Regarding that limitinterval on get_data, i&#39;m not sure why it was implemented, because the engine has no interval limits(each data point time is saved as passed), maybe Trystan can give an insight of what was the initial idea for having it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36731"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/238.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-238.jpg" alt="Paul Reed&#039;s picture" title="Paul Reed&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/238.html" title="View user profile.">Paul Reed</a> on Fri, 04/12/2015 - 22:50.</div>
    <div class="content">
     <p>What are the implications for correcting this (complex) issue, if corrected would&nbsp;it affect historical data?</p>
<p>Paul</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36732"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Fri, 04/12/2015 - 23:24.</div>
    <div class="content">
     <p>All time-value pairs have a preceding &#39;249&#39; char so they are easy to locate, if everything is ok the char must happen every&nbsp;9bytes offset.</p>
<p>If a particular deploy used any other size than 9bytes, then the data points will be there but with garbage in between, as there is some auto correction code on post metode that sets the file size to multiple o 9 if it detects an error like that.</p>
<p>If the OS was updated latter and the size changed mean time, they can be recovered also, detecting when the format changed by looking for that 249 char offsets.</p>
<p>I never used this engine so didn&#39;t test the behaviour. My previous post is just a warning of what can happen.</p>
<p>The raspberry pi is running a 32bits OS right? If so there should not be any problem.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-36802"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Mon, 07/12/2015 - 08:31.</div>
    <div class="content">
     <p>&gt;The problem is that pack format&nbsp;l&nbsp;and&nbsp;f&nbsp;for time and value is platform/os dependent.</p>
<p>That is correct, and there are issues reported with that. But it looks that for I and f no 64bits support is implemented (yet?).&nbsp;</p>
<p>From&nbsp;the php website:</p>
<p>&quot;PHP&nbsp;5.6.3 The &quot;q&quot;, &quot;Q&quot;, &quot;J&quot; and &quot;P&quot; codes were added to enable working with 64-bit numbers.&quot;</p>
<p>and:</p>
<p>&quot;Even though in a 64-bit architecure intval(6123456789) = 6123456789, and sprintf(&#39;%b&#39;, 5000000000) = 100101010000001011111001000000000&nbsp;<br />
pack will not treat anything passed to it as 64-bit.&quot;</p>
<p>&nbsp;</p>
<p>I&#39;m running on a 64bit CPU, with 64bit Debian and with a PHP version that supports 64bit int. To be sure I checked the phptimeseries DB files and the entries are 9 bytes long. So it looks safe (for now).</p>
<p>Regarding the&nbsp;limitinterval, the root cause of issues around not displaying certain values and hops in data entries comes from writing the time values corrected for timezone. The code for posting data first gets the current time, corrects it for timezone and then writes it to disk.</p>
<p>That happens here in&nbsp;process_processlist.php:</p>
<p>public function kwhinc_to_kwhd($feedid, $time_now, $value)<br />
{<br />
[..]<br />
<strong>$current_slot = $this-&gt;getstartday($time_now);</strong></p>
<p>[...]</p>
<p>$this-&gt;feed-&gt;update_data($feedid, $time_now,<strong> $current_slot</strong>, $new_kwh);</p>
<p>[...]</p>
<p>Why not write time always in UTC and then let the timezone interpretation be done when retrieving the data?</p>
<p>If this cannot be fixed due to existing data, there are a few options to patch. One is the PR I did. You could also change all the references in de vis modules&nbsp;from:</p>
<p>get_feed_data_async(vis_feed_kwh_data_callback,null,kwhd,start,end,3600*24,1,1);</p>
<p>to default:</p>
<p>get_feed_data_async(vis_feed_kwh_data_callback,null,kwhd,start,end,3600*24,1,0);</p>
<p>To skip the limitinterval code in phptimeseries engine completely.</p>
<p>You could also &#39;loosen&#39; the limitinterval check in phptimeseries&nbsp;engine:</p>
<p>if ($limitinterval)<br />
{<br />
$diff = abs($dptime-$time);<br />
if ($diff&lt;($interval/2)) {<br />
$value = $array[&#39;value&#39;];<br />
}</p>
<p>&nbsp;</p>
<p>to:</p>
<p>if ($limitinterval)<br />
{<br />
$diff = abs($dptime-$time);<br />
if ($diff&lt;$interval) {<br />
$value = $array[&#39;value&#39;];<br />
}</p>
<p>Or skip the diff check&nbsp;all&nbsp;together and let the only difference be that the $limitinterval&nbsp;options lines up al the results neatly to the interval time and without that option use de DB time.</p>
<p>&nbsp;</p>
<p>Then it will be like this:</p>
<p>if ($limitinterval)<br />
{<br />
$value = $array[&#39;value&#39;];<br />
} else {<br />
$value = $array[&#39;value&#39;];<br />
$atime = $array[&#39;time&#39;];<br />
}</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-37696"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3695.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="chaveiro&#039;s picture" title="chaveiro&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/3695.html" title="View user profile.">chaveiro</a> on Thu, 31/12/2015 - 01:39.</div>
    <div class="content">
     <p>&gt; Why not write time always in UTC and then let the timezone interpretation be done when retrieving the data?</p>
<p>It is indeed saved to engine in UTC.<br />
Midnight of user post can be different for each user and/or time of the year. (DST changes).</p>
<p>So that getstartday() return the utc timestamp when its midnight at the user timezone for the passed date. Confusing? :)</p>
<p>
I would just use your last option for limit interval. Can you test if fixes all the issues you are having?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38015"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2185.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arjen&#039;s picture" title="arjen&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/2185.html" title="View user profile.">arjen</a> on Fri, 08/01/2016 - 12:37.</div>
    <div class="content">
     <p>&gt;So that getstartday() return the utc timestamp when its midnight at the user timezone for the passed date. Confusing? :)</p>
<p>&nbsp;</p>
<p>That was confusing indeed :) I thought that timenow was changed by applying user timezone, but PHP doc indeed states that this is not the case.</p>
<p>&nbsp;</p>
<p>The last option seems to have a side effect, I get&nbsp;the last value in the DB displayed twice.</p>
<p>&nbsp;</p>
<p>This works without any issues:</p>
<p>if ($limitinterval)<br />
{<br />
$diff = abs($dptime-$time);<br />
if ($diff&lt;$interval) {<br />
$value = $array[&#39;value&#39;];<br />
}</p>
<p>&nbsp;</p>
<p>update:</p>
<p>I changed the PR on github to reflect the above.</p>
<p><a href="11882.html" title="http://openenergymonitor.org/emon/node/11882">http://openenergymonitor.org/emon/node/11882</a><br />
also describes the same issue and the current PR seems to solve it.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38074"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8370.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="blaal02&#039;s picture" title="blaal02&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/8370.html" title="View user profile.">blaal02</a> on Sat, 09/01/2016 - 21:41.</div>
    <div class="content">
     <p abp="755">This fixed my kWh/d multigraph too.</p>
<p abp="756">Thanks!<br abp="757" /><br />
Sandy</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39168"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4463.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4463.jpg" alt="efidi13&#039;s picture" title="efidi13&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonCMS 9.2 migration data corruption</h3>

    <div class="submitted">Submitted by <a href="../user/4463.html" title="View user profile.">efidi13</a> on Sat, 06/02/2016 - 17:37.</div>
    <div class="content">
     <p>Hello, I applied the fix proposed by arjen in PR 414 and now everything works as expected.</p>
<p>Without his fix the zoom visualization was totally unusable (I&#39;m using Emoncms 9.3).</p>
<p>The only thing I don&#39;t understand is why it seems that so few people encountered this problem.</p>
<p>BTW thank you arjen!</p>
<p>Regards,</p>
<p>Federico.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/11720"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-G9TzeMnRZsIYvKrsqY-0KNsZVOWuQhGBn2t5d2G-nl0" value="form-G9TzeMnRZsIYvKrsqY-0KNsZVOWuQhGBn2t5d2G-nl0"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
</body>


<!-- Mirrored from openenergymonitor.org/emon/node/11720 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:48:46 GMT -->
</html>
