<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/12490 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:45:16 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Graphing Problems | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/5.html">Archived: Software</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Graphing Problems</h3>
        <span class="submitted">Submitted by <a href="../user/8163.html" title="View user profile.">Esk Energy</a> on Sat, 09/04/2016 - 09:14</span>
        <div class="content"><p>The graph visualisations (multigraph, raw data etc) interpret the stored data wrongly and differently depending on FIWA/FINA and also depending on the saved interval.</p>
<p>I stored some manufactured data using BulkAdd&nbsp;stamped 1/4/16 from 00:00 to 04:00 (UTC) at one minute intervals.<br />
The value was (time-&gt;hour*100) + time-&gt;minute so 00:00 should be 0, 00:59 should be 59, 01:00=100 etc</p>
<p>The process list stored new feeds at 60s, 5min and&nbsp;60min for both FINA and FIWA. (ie&nbsp;6 feeds).</p>
<p>The multigraph of the data is attached. the original is at <a href="http://whitbyeskenergy.org.uk/emoncms/vis/multigraph?mid=14">http://whitbyeskenergy.org.uk/emoncms/vis/multigraph?mid=14</a></p>
<p>The things that stand out are:<br />
Starting time stamps are not the same<br />
All the time stamps are wrong (some by by 30 minutes)<br />
FINA and FIWA and not drawn the same</p>
<p>There are other issues (the stamps move if you scroll left/right)</p>
<p>I raised this a few weeks ago <a href="12295.html">https://openenergymonitor.org/emon/node/12295</a>&nbsp;and&nbsp;I still need to fix it so I would be very grateful for pointers as to the php and js files which extract and draw these graphs</p>
<p>Thanks</p>
<p>Mike</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="9978.html" class="topic-previous" title="Go to previous forum topic">‹ input and feeds not working since begining Jan on emoncms.org</a>
              <a href="12489.html" class="topic-next" title="Go to next forum topic">Configuring an Apache reverse SSL proxy for node-red ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-41017"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8163.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Esk Energy&#039;s picture" title="Esk Energy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Graphing Problems</h3>

    <div class="submitted">Submitted by <a href="../user/8163.html" title="View user profile.">Esk Energy</a> on Sat, 09/04/2016 - 13:11.</div>
    <div class="content">
     <p>Some of the datafiles look a bit suspect too.</p>
<p>Using the documented descriptions of the meta files I&#39;ve viewed the stored data and I&#39;d appreciate some comments on what would be expected to be stored for the data where the input was fed with timestamped data at one minute intervals as above (Sorry but stamps here are GMT so add one hour for BST)</p>
<p>1 minute FINA - looks OK<br />
31/03/2016 23:00:00 0<br />
31/03/2016 23:01:00 1<br />
31/03/2016 23:02:00 2</p>
<p>1 minute FIWA_0 - looks OK<br />
31/03/2016 23:00:00 0<br />
31/03/2016 23:01:00 1<br />
31/03/2016 23:02:00 2</p>
<p>1 minute FIWA_1<br />
31/03/2016 23:00:00 4.5 would have expected 0 as there is no previous data<br />
31/03/2016 23:10:00 14.5 would have expected average of 1,2,3,4,5,6,7,8,9,10=5.5 or value at 23:10=10<br />
31/03/2016 23:20:00 24.5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot; = 15.5 or value at 23:20=20</p>
<p>1 minute FIWA_2<br />
31/03/2016 23:00:00 29.5 would have expected 0 as there is no previous data<br />
01/04/2016 00:00:00 129.5 should be average approximating to 50 or value at 00:00=100<br />
01/04/2016 01:00:00 229.5 should be average approximating to 150 or value at 01:00=200</p>
<p>5 minute FINA - looks OK<br />
31/03/2016 23:00:00 0<br />
31/03/2016 23:01:00 1<br />
31/03/2016 23:02:00 2</p>
<p>5 minute FIWA_0 - looks OK<br />
31/03/2016 23:00:00 0<br />
31/03/2016 23:05:00 5<br />
31/03/2016 23:10:00 10<br />
31/03/2016 23:15:00 15</p>
<p>5 minute FIWA_1<br />
31/03/2016 23:00:00 2.5&nbsp;would have expected 0 as there is no previous data<br />
31/03/2016 23:10:00 12.5 would have expected 5 or value at 23:10=10<br />
31/03/2016 23:20:00 22.5&nbsp;would have expected 15 or value at 23:10=20</p>
<p>5 minute FIWA_2<br />
31/03/2016 23:00:00 27.5&nbsp;would have expected 0 as there is no previous data<br />
01/04/2016 00:00:00 127.5 would have expected 50 or value at 00:00=100<br />
01/04/2016 01:00:00 227.5&nbsp;would have expected 150 or value at 00:00=200<br />
&nbsp;</p>
<p>60 minute FINA<br />
31/03/2016 23:00:00&nbsp;would have expected 0 as there is no previous data<br />
01/04/2016 00:00:00 159 would have expected 50-55 or value at 00:00=100<br />
01/04/2016 01:00:00 259&nbsp;would have expected 150-155 or value at 01:00=200</p>
<p>60 minute FIWA_0 - LOOKS OK!<br />
31/03/2016 23:00:00 0<br />
01/04/2016 00:00:00 100<br />
01/04/2016 01:00:00 200</p>
<p>Thanks</p>
<p>Mike<br />
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41018"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Graphing Problems</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Sat, 09/04/2016 - 16:51.</div>
    <div class="content">
     <p>Hello Mike</p>
<p>The way the emoncms data request works is that it returns the nearest data to the request times set by the request start time and interval.</p>
<p>Let&#39;s say we set the visualisation start time to 1460217206,000 (04/09/2016 @ 3:53pm +&nbsp;26seconds (UTC)) and the interval to every 10 seconds, then emoncms will return the closest data it can, but allocated according to the request parameters. The data returned will be timestamped:</p>
<p>1460217206<br />
14602172<strong>1</strong>6<br />
14602172<strong>2</strong>6<br />
14602172<strong>3</strong>6<br />
...</p>
<p>If the feed was started at say 3:53pm and 0 seconds with data arriving at the server every 10 seconds, then for PHPFina the actual data locations are</p>
<p>1460217180<br />
1460217190<br />
1460217200<br />
1460217210<br />
1460217220<br />
1460217230</p>
<p>The nearest datapoint to request timestamp 1460217216 is 1460217220, which will appear to shift the data 4 seconds backwards on the multigraph.</p>
<p>The solution is to align the request interval and start time with the underlying feeds, so that if the request interval is 10s, the start_time is rounded to the nearest 10s.</p>
<p>The request would then have a start time of 1460217210 and return the datapoint allocated to that 10 second block in the phpfina file.</p>
<p>I had already implemented this for the default graph view on emoncms, but not for multigraph. I&#39;ve now added this code to the multigraph visualisation both on emoncms.org and the master branch. A cache refresh might be needed to load the new javascript.</p>
<p>There is still an issue if the request interval is less than the feed interval, which perhaps could be improved upon. Let&#39;s say the request interval is 10s and limit interval is set to 1, so that the data returned in the case of a 60s feed will be returned at an interval of 60s rather than the requested 10s. With limit interval set to 0, it will return datapoints at 10s, each one corresponding to the nearest 60s period.</p>
<p>The start time is still rounded to 10s, even with limit interval set to 1 on a 60s feed. The data returned could therefore have timestamps that are out compared to the data file position by 30s.</p>
<p>In addition, a node posting to the 60s feed has its timeslot allocated based on math function &#39;floor&#39; after division&nbsp;by the data interval. So it could be out by 59 seconds:</p>
<p>datapoint_position_in_file = floor((post_time - feed_start_time) / feed_interval)</p>
<p>where feed_start_time has been rounded using floor according to the feed_interval in the same way.</p>
<p>It&#39;s possible to use the graph visualisation (there&#39;s a post about it here <a href="12280.html" title="https://openenergymonitor.org/emon/node/12280">https://openenergymonitor.org/emon/node/12280</a>)&nbsp; to fix the request interval and set your own start_time and end_time in order to return the data in a more controlled way, if the timing is more important.</p>
<p>Hope that helps explain a bit of how it works.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-41032"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8163.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Esk Energy&#039;s picture" title="Esk Energy&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Graphing Problems</h3>

    <div class="submitted">Submitted by <a href="../user/8163.html" title="View user profile.">Esk Energy</a> on Sun, 10/04/2016 - 11:58.</div>
    <div class="content">
     <p>Hi Trystan</p>
<p>Thanks for the very quick response.</p>
<p>I&#39;m trying to get my head around the translation from the feed data to the data viewed on a graph/multigraph.</p>
<p>I&#39;ve had a poke around the engine php and it seems the feed data is always aligned to the feed storage interval, so a 10 second feed will always be at 00, 10, 20 seconds etc and&nbsp;a 60 second feed always on the 00 seconds.<br />
I believe fina and fiwa_0 data is stored this way. (I&#39;ll come to fiwa_1 etc later).<br />
This is great!</p>
<p>I can see the need to provide a subset of the base feed data where the request to graph is for a long time period.</p>
<p>I can&#39;t see the need to change the time stamps of the feed data in a small&nbsp;dataset (graph a short time period).<br />
I tried the new graph module on emoncms.org&nbsp;for a 5 minute feed and it indeed is much better in that the time stamp does not seem to move as you scroll left-right. But the time stamps were moved to be&nbsp;mid way between the base data stamps. In this 5 minute data the points graphed were at 09:02:25, 09:07:25 etc rather than 09:00:00, 09:05:00 etc. I can&#39;t see the point of this.</p>
<p>Coming back to the FIWA base data, it seems that each layer contains averages of the layer &quot;beneath&quot; it.<br />
For&nbsp;1 minute data the _0 layer has data every&nbsp;1 minutes (aligned to the 00 seconds) and the _1 layer has 10 minute data aligned to the hour. This too is great.<br />
BUT the averages seem to be shifted to the front of the averaging period.</p>
<p>Say, for a data set from 00:00:00, the layer_1 data for 00:00:00 is the average of the layer_0 data from 00:00:00 to 00:10:00. This is strange as one would expect the average to be stored at the end of the period (ie the data from 00:00:00 to 00:10:00 should be stored at 00:10:00. It sort of says when retrieving the 00:00:00 layer_1 data &quot;This value at 00:00:00 WILL BE the average for the NEXT 10 minutes&quot; rather than &quot;this was the average over the previous 10 minutes&quot;</p>
<p>Is this deliberate?</p>
<p>FYI my need for accurate stamps is to be able to see what caused what when our community hydro turbine trips or throws a wobbler. We have a mix of 5 minute and 1 minute feed data with inputs every minute.</p>
<p>Thanks for a fantastic product</p>
<p>Mike</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/12490"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-t85p4WVhG14RZbxU4ZmT5saGE3Q6rp25UPJQJYa0Fdc" value="form-t85p4WVhG14RZbxU4ZmT5saGE3Q6rp25UPJQJYa0Fdc"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
