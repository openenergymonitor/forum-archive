<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/1629 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:18:09 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Integer Maths is Magic! | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/3.html">Archived: General Discussion</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Integer Maths is Magic!</h3>
        <span class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 12/12/2012 - 13:52</span>
        <div class="content"><p><span lang="EN-US">Along with most Open Energy Monitor based code, my Mk2 sketch is full of floating poin<span style="">t </span></span><span lang="EN-US">calculations.<span style="">&nbsp; </span>Although easy to write, FP maths is notoriously slow.<span style="">&nbsp; </span>I decided to see whether the operation could be speeded up by the use of integer maths.&nbsp; </span>By &#39;integer maths&#39;, I mean that everything is done with int, long and bit-shiting (&gt;&gt; or &lt;&lt;), rather than float or double.</p>
<p>The attached Word document describes my method and findings.&nbsp; In short, integer maths is a great deal faster than its FP equivalent and works just as well.&nbsp; Graphs are presented to show the equivalent performance, and the resulting speed benefits are quantified.&nbsp;</p>
<p>At a rough guess, I would say that the total amount of processing time has been halved.&nbsp; Much of this gain has been achieved by rewriting the standard HPF filters as suggested by Atmel.&nbsp; I&#39;ve also managed to reduce Atmel&#39;s implementation by one processing statement.&nbsp; This saves a small amount of time when processing every V &amp; I sample.</p>
<p>A pair of &#39;core&#39; sketches are attached, these being chopped-down versions of the two sketches with which my measurements were taken.&nbsp; Although they compile, they are not intended to be run on an Arduino.&nbsp; Their sole purpose is to convey how the code has been altered to achieve integer maths operation.&nbsp; <em>[Sorry, there are a few mistakes in the comments - just follow the code!]</em></p>
<p>A similar upgrade could no doubt be usefully applied to many of the sketches that we all use.&nbsp; I look forward to hearing about lots of go-faster code before too long ...</p>
<p>&nbsp;</p>
  <div class="forum-topic-navigation clear-block">
          <a href="2052.html" class="topic-previous" title="Go to previous forum topic">‹ Wireless water and electricity monitoring</a>
              <a href="2062.html" class="topic-next" title="Go to next forum topic">Energy Monitoring RA post at Salford Uni ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-8218"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Fri, 14/12/2012 - 20:07.</div>
    <div class="content">
     <p>Brilliant stuff!&nbsp; I will almost certainly use this approach in my code, thanks so much for sharing.</p>
<p>One quick thought for further speed improvements when sampling more than one analog input (e.g. sampling voltage then current in quick succession):</p>
<p>The HPF in EmonLib takes about 200 microseconds to run, so I guess your version takes about 100 microseconds.&nbsp; Which is a very important number because that just happens to be about the time it takes to run analogRead().</p>
<p>analogRead() blocks until it&#39;s done but it looks like it shouldn&#39;t be too hard to modify analogRead() so it doesn&#39;t block (it blocks for 100 microseconds while waiting for the ADC to do its thing, but I think the processor is basically idle during this period - see line 78 of wiring_analog.c for the busy-wait loop).&nbsp; analogRead appears to do three mains things: it triggers the ADC to start reading, then it busy-waits until the ADC is finished, then it reads the relevant registers.&nbsp; It should be easy to split analogRead into two parts, let&#39;s call them start_adc() and get_adc().&nbsp; start_adc() fires off the ADC and immediately returns. get_adc() returns -1 if the ADC isn&#39;t ready yet or returns the ADC value if it is ready.</p>
<p>So the end result would be:</p>
<ol>
<li>
		sample voltage (takes 100 microseconds)</li>
<li>
		sample current (takes 100 microseconds) AND, while waiting for the ADC, run the HPF for the voltage sample, then busy-wait until the ADC has finished.</li>
</ol>
<p>If we&#39;re really clever then both analogRead() operations can be spent doing useful maths, further reducing the time taken to execute one loop.&nbsp; e.g. the analogRead() to get the voltage can be spent running the HPF on the current sample from the previous iteration.</p>
<p>Just a thought.&nbsp; I won&#39;t have time to tinker with this over the weekend but hopefully will do next week.</p>
<p>Thanks again for the integer maths stuff - looks very useful.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8221"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 14/12/2012 - 20:43.</div>
    <div class="content">
     <p>When using integer maths, the HPF takes much less that 100uS.&nbsp; In the setup that I&#39;ve described above, the entire per-loop processing is only around 50uS.</p>
<p>As for &#39;free&#39; time during ADC conversions, try this:</p>
<p>&nbsp; ADMUX = 0x40 + currentSensorPin; // 0 to 5<br />
	&nbsp; ADCSRA |= (1&lt;&lt;ADSC);<br />
	&nbsp; {<br />
	&nbsp;&nbsp;&nbsp; // do something useful<br />
	&nbsp;&nbsp;&nbsp; delayMicroseconds(10); // to see how much time is available<br />
	&nbsp; }<br />
	&nbsp; while(bit_is_set(ADCSRA, ADSC));<br />
	&nbsp; sampleI = ADC;</p>
<p>Works a treat!<br />
	&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8222"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Fri, 14/12/2012 - 21:10.</div>
    <div class="content">
     <p><em>If we&#39;re really clever then both analogRead() operations can be spent doing useful maths, further reducing the time taken to execute one loop.&nbsp; e.g. the analogRead() to get the voltage can be spent running the HPF on the current sample from the previous iteration.</em></p>
<p>Finding something useful to do during the first of the two ADC slots is not immediately obvious, but it seems a shame not to use free time if it&#39;s there.&nbsp; My approach has been to delay the processing of both raw samples from one loop to the next.&nbsp; Then there is always data to process when free time becomes available.&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8266"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <img src="../sites/default/files/imagecache/avatar/default_0.png" alt="arvidb&#039;s picture" title="arvidb&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by arvidb (not verified) on Sun, 16/12/2012 - 01:57.</div>
    <div class="content">
     <p>Why not let periodic interrupts take care of the sampling (storing the data in a <a href="http://en.wikipedia.org/wiki/Circular_buffer">Circular buffer</a>)? This way the sampling and the calculations are independent: you get samples at a fixed period, a period which is not dependent on the calculation time, and you can even do calculations that takes a bit longer than the sampling (at least if you don&#39;t need continuous sampling and with enough of a buffer).</p>
<p>Circular buffers are quite easy to implement; you need an array for the buffer and two index variables, one that is updated by the writer (sample routine) and one that is updated by the reader (calculation routine). There&#39;s lots of details in the Wikipedia article in the link above.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8304"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Mon, 17/12/2012 - 15:17.</div>
    <div class="content">
     <p>@<a href="../user/956.html" title="View user profile.">calypso_rae</a></p>
<p>Love this stuff!&nbsp; Just hope I have time to tinker before Christmas descends upon us.</p>
<p>BTW, what motivated you to try to squeeze as many samples into a given time period?&nbsp; My own motivation is to increase the quality of the measurements (more samples per cycle should provide more precise calculated values)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8305"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 17/12/2012 - 15:27.</div>
    <div class="content">
     <p>Isn&#39;t it more important that the samples are evenly spaced in time since the calculations give equal weight to each sample?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8312"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1399.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1399.jpg" alt="Series530&#039;s picture" title="Series530&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1399.html" title="View user profile.">Series530</a> on Mon, 17/12/2012 - 20:38.</div>
    <div class="content">
     <p>I had a play with my sketch this last weekend and increased the number of samples, per cycle by about 15%. To be honest, I&#39;m not convinced that I made any difference to the accuracy of the readings compared to my plug in energy monitor or my enviR units.</p>
<p>Perhaps at low power when the waveforms are far from sinusoidal it will marginally improve accuracy. As the power increases the current waveforms err toward sinusoidal and this is easily resolved with a relatively low samples per cycle rate. IMHO anyway.</p>
<p>I will keep the code as the whole thing is a lot cleaner now.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8314"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Mon, 17/12/2012 - 20:45.</div>
    <div class="content">
     <p><em>Isn&#39;t it more important that the samples are evenly spaced in time since the calculations give equal weight to each sample?</em></p>
<p>I&#39;m so pleased you asked that question, Martin!</p>
<p><a href="1681-2.html">http://openenergymonitor.org/emon/node/1681</a></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8322"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 18/12/2012 - 08:13.</div>
    <div class="content">
     <p>Looks promising Robin but I&#39;m surprised that you&#39;re still not using interrupts. It would be interesting to see how it compares with my interrupt/PLL based code if you get chance to try it on your rig at some point.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8324"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 18/12/2012 - 10:15.</div>
    <div class="content">
     <p>Well, Martin, my feeling is that if the ADC sub-processor is simply running back-to-back conversions all day long, then its conversion rate should be pretty much uniform.&nbsp; I intend to knock up a sketch which checks whether the &#39;hidden&#39; workload has been finished or not before the ADC operation has completed.&nbsp; Then the amount of available time within ADC conversions can be better understood.</p>
<p>According to my TALLYMODE display, the average number of loops per mains cycle (when rounded down to the nearest integer) is always either 88 or 89 .&nbsp; This is the same value that I get when simply looping around a pair of dummy analogRead() statements.&nbsp; What&#39;s more, I&#39;ve not seen this value reduce when Serial statements are added, which is encouraging.</p>
<p>On the &quot;loops per mains cycle&quot; scale, my free-running Mk2a code provides around 88, their spacing and regularity being entirely dependent on the performance of the ADC sub-processor.&nbsp; Your interrupt-based code, as I understand it, provides exactly 50, this value being maintained by some kind of mechanism which varies the speed of the processor&#39;s clock to precisely align with the mains frequency.</p>
<p>Developers will no doubt make up their own minds as to which approach they prefer.&nbsp; It&#39;s good that they now have a choice.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8327"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Tue, 18/12/2012 - 10:42.</div>
    <div class="content">
     <p>Personally, I will probably err away from using IRQs to trigger the analog sampling for one simple reason: in my system, I use a rather different RF protocol to the normal emonTX.&nbsp; My emonTX sits patiently and waits to be asked for data from the base unit (and if data is lost then it can be re-sent) - the emonTX never sends RF data without being asked.</p>
<p>The end result is that the RFM12b on my emonTX is almost always in RX mode and could receive an RF packet at any time.&nbsp; If the RFM12b receives the start of a valid packet then it&#39;ll raise an IRQ and it&#39;s REALLY important that IRQ is handled ASAP or we&#39;ll lose RF data. (the RFM12b only has a 2-byte buffer).&nbsp; If the ATMEGA is handling 50 IRQs per second for analog sampling then I assume there&#39;s a fair chance that it&#39;ll be busy handling one of these IRQs when the RFM12b raises its hand asking for help (the ATMEGA disables IRQs while inside an interrupt service routine (ISR), I believe).</p>
<p>I could be wrong.&nbsp; I guess that if the analog sampling ISR takes very little time (i.e. it just saves the previous conversion and then tells the ADC to start conversion but doesn&#39;t wait for conversion to finish) then it might be possible that, even in the worst case scenario, you&#39;ll never lose RF data.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8331"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Tue, 18/12/2012 - 11:40.</div>
    <div class="content">
     <p>If the ADC interrupt comes regularly at its 104 us interval (is this correct for the standard Arduino settings?) then you could use &#39;polling&#39; of the RFM12B status inside the IRQ. AFAIR the RFM12B needs attention every ~200us at the nominal 49,2k data rate.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8333"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Tue, 18/12/2012 - 11:56.</div>
    <div class="content">
     <p>Great, thanks J&ouml;rg.&nbsp; In which case, I guess the &quot;analog-sampling-using-IRQs&quot; might well work in my situation!</p>
<p>Ian wrote: &quot;<em>To be honest, I&#39;m not convinced that I made any difference to the accuracy of the readings compared to my plug in energy monitor</em>&quot;</p>
<p>This is very interesting.&nbsp; Does anyone have any empirical evidence to suggest how much of an accuracy improvement we might see by sampling the AC waveform as rapidly as possible (compared to the standard EmonLib technique)?&nbsp; I know that posh power quality meters costing hundreds of pounds show off about sampling the AC waveform rapidly (where &quot;rapidly&quot; means 64 times per cycle).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8335"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 18/12/2012 - 12:31.</div>
    <div class="content">
     <p>Robin - I don&rsquo;t want to get into another long debate, it&rsquo;s just that you seem to be striving really hard to achieve uniform sampling without using the using the one mechanism that would make it easy. I don&rsquo;t understand why, and you haven&rsquo;t offered any reason, but that&rsquo;s up to you.</p>
<p>Obviously you can never achieve true uniformity unless the cycle time is an exact multiple of the sampling period &ndash; hence the phase-locked loop. For me it&rsquo;s all about the fun of doing something novel or clever, that&rsquo;s why I liked your original concept so much.</p>
<p>I chose 50 samples per mains cycle because it&rsquo;s a nice round number and it seemed to be plenty. It could be more, but you need to leave time for radio transmission and temperature measurement for a complete solution.</p>
<p>Jack &ndash; you are right that ADC ISR takes very little time. If well written it shouldn&rsquo;t interfere with you RF reception at all, even if both are using interrupts. If it does become an issue then all you need to do is slow down the bit rate on the RF channel (from the 49.2kb/s that J&ouml;rg mentions) since your overall data rate is presumably pretty low. You can also speed up the ADC by changing it&rsquo;s clock prescaler.</p>
<p>You should be able to calculate the effect of sampling rate for various wave shapes, it would certainly be useful information for the rest of use. Since it is basically integration over time I still think equal spacing of samples is significant unless the time between each sample is included in the power calculation.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8337"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Tue, 18/12/2012 - 12:49.</div>
    <div class="content">
     <p><em>Quote: Obviously you can never achieve true uniformity unless the cycle time is an exact multiple of the sampling period</em></p>
<p>This is absolutely correct. You could achieve this in Robins code by using a &#39;calculation interval&#39; which is an exact multiple of the nominal mains period. For 104 us a calculation an interval of 130 ms would fit quite nicely. Not sure though if this interferes with Robins energy bucket evaluations.</p>
<p>But sure, using &#39;real&#39; (timer) interrupts, zero crossing detection and/or a PLL would be an optimal solution. I just understand that this might be too far away from &#39;standard Arduino&#39; programming style (if there is such a thing :-) )</p>
<p>&nbsp;</p>
<p>BR, J&ouml;rg.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8338"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Tue, 18/12/2012 - 12:52.</div>
    <div class="content">
     <p>MartinR: &quot;.<em>..hence the phase-locked loop..</em>.&quot;</p>
<p>Oooh, you&#39;re using a PLL!? Awesome!&nbsp; Is your code available online?&nbsp; I had a look at your <a href="1170.html#comment-6686">3-phase thread</a> but I couldn&#39;t see any PLL stuff in the code.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8340"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 18/12/2012 - 12:58.</div>
    <div class="content">
     <p><em>Robin - I don&rsquo;t want to get into another long debate, it&rsquo;s just that you seem to be striving really hard to achieve uniform sampling without using the using the one mechanism that would make it easy. I don&rsquo;t understand why, and you haven&rsquo;t offered any reason, but that&rsquo;s up to you.</em></p>
<p>Martin - neither do I.&nbsp; I just know that my latest version of the Mk2 code is a lot slicker than it was before, and I would therefore like it to be available for people to use.&nbsp; But if anyone prefers to go down the alternative route of using interrupts, that&#39;s fine, and I&#39;m sure you would be happy to help them along the way.&nbsp; Incidentally, is there an idiot&#39;s guide as to how your phase-locking / interrupt mechanisim actually works, because I can&#39;t follow your code :(</p>
<p>From the various results that I took over the summer with a disc-style meter attached, it could be seen that my original Mk2 design works pretty well.&nbsp;&nbsp; Not too many micro-pennies appeared to be slipping away.&nbsp; Mk2a can only work better.&nbsp; If you can demonstrate that an interrupt-based approach can work better still, I will be most impressed!</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8341"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Tue, 18/12/2012 - 13:22.</div>
    <div class="content">
     <p>Jack &ndash; my PLL code is here: <a href="1535.html">http://openenergymonitor.org/emon/node/1535</a></p>
<p>Robin &ndash; I take your point. You&rsquo;ve put a lot of effort into making your code easy to read and understand and that has made it very accessible to everyone, which is a good thing. I&rsquo;m probably too lazy to do that so it&rsquo;s going to be a much narrower target audience (maybe like Jack?). The concept is pretty simple. You want to divide the mains cycle into equal sized chunks. As J&ouml;rg says you could do this by using one of the ATmega hardware timers with a period that divides into 20ms but this will never be exact. The phase-locked loop improves on this by constantly adjusting the timer period so that an exact multiple fits into the current mains period. I&rsquo;m not even sure it is better but it&rsquo;s more fun to play with :)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8342"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Tue, 18/12/2012 - 13:45.</div>
    <div class="content">
     <blockquote><p><em>my original Mk2 design works pretty well.&nbsp;&nbsp; Not too many micro-pennies appeared to be slipping away.</em></p>
</blockquote>
<p>Part of me is extremely excited to try to implement some of the fun ideas flying around.&nbsp; But the pragmatic part of my brain - the part that&#39;s well aware that I have a limited amount of time to tinker - is starting to question whether there&#39;s much accuracy to be gained from rapid sampling.&nbsp; Robin, if your original Mk2 design didn&#39;t let many micro-pennies slip away, do you yet have evidence that there are real performance benefits (in terms of measurement accuracy) to be gained from rapid sampling (apart from the enjoyment to be gained from the engineering challenges, of course)?</p>
<p>Given the aim of trying to improve measurement accuracy, I wonder if time might be better spent, for example, <a href="1680.html">experimenting with CT clamps which are well matched to the load</a> (and possibly using 2 CT clamps) in order to increase accuracy.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8344"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Tue, 18/12/2012 - 15:05.</div>
    <div class="content">
     <p>I think the &#39;big&#39; step with Robins new code is that the sampling rate is no longer depending so much on &#39;other&#39; things that have to be done apart from sampling and calculating (like serial output). And the code is very easily readable and understandable and follows &#39;Arduino style&#39; very much.</p>
<p>Switching to interrupts would be a next (maybe smaller) step to attain perfection. Biggest impact would be that any remaining processing time could be very easily &#39;used&#39; in the main loop without any thoughts about distracting the exact adc sampling. But the code will clearly look strange to many people with Arduino experience.</p>
<p>Using a fixed sampling period (like a 100 us timer interrupt instead of 104 us advc interrupt) that fits exactly to the nominal mains period at 50Hz would then be the next (even smaller) step (mains frequency long term stability is extremely high, and short term stability is just &#39;good enough&#39;).</p>
<p>The PLL, if properly done, can give perfectly equidistant sampling which fits perfectly to every mains period (although it works with a presumption about the next mains period based on measuring the last, which might not be correct for fast mains period variations and especially distortion). The gained effect in accuracy may be small compared to the other steps described.</p>
<p>&nbsp; &nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8362"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Tue, 18/12/2012 - 17:41.</div>
    <div class="content">
     <p>MartinR wrote: &quot;<em>You should be able to calculate the effect of sampling rate for various wave shapes, it would certainly be useful information for the rest of us</em>&quot;</p>
<p>I&#39;ve <a href="1680.html#comment-8351">made a start on comparing</a> the effect on RMS current calculations of sampling current at 17 samples-per-cycle versus 45 samples-per-cycle for a number of appliances.&nbsp; To get up to 45 samples-per-cycle I haven&#39;t used any of the clever tricks discussed above; I just stripped the code right back to the bare minimum required to produce an RMS current calculation (i.e. don&#39;t sample voltage).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8364"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 18/12/2012 - 18:21.</div>
    <div class="content">
     <p>There seems to be an assumption here that accurate measurements can only be taken if the sampling process is phase-locked to the waveform that is being measured.&nbsp; I don&#39;t understand why this should be so.&nbsp; The only important thing, surely, is to sample at regular intervals.&nbsp;</p>
<p>Although my Mk2 code had a higher workload during one half than the cycle than the other, that is not the case for the latest version.&nbsp; Providing that the measurement system is linear, regular sampling should surely be sufficient to achieve nigh-on perfect results.&nbsp; We&#39;re way above the Nyquist frequency for 50Hz, so should be seeing power at quite a few of the lower harmonics as well as the fundamental.&nbsp;</p>
<p>Jorg has touched on the difficulty of tracking frequency and amplitude distortions when a PLL is used.&nbsp; Obtaining precisely 50 samples per cycle sounds less tricky to me than ensuring that they are all equally spaced.&nbsp; Any timing jitter within the control loop would seem to negate any benefits that may be gained with a phase-locked sampling algorithm.</p>
<p>Final point: Given that the waveforms that we&#39;re monitoring are often far from sinusoidal, might it not be better to sample them asynchronously?&nbsp; Then any odd parts of the waveform will be blended out in the measuring process.&nbsp; The current profile from our PV inverter, as posted again below, is far from sinusoidal.&nbsp; I do hope that someone else will be able to supply an equivalent trace at some stage.</p>
<pre>
cycleCount 152,  samplesDuringThisMainsCycle 68
|                                     p .                                       |
|                                      c. p                                     |
|                                       c    p                                  |
|                                       .c      p                               |
|                                       . c       p                             |
|                                       .   c        p                          |
|                                       .    c         p                        |
|                                       .      c          p                     |
|                                       .       c           p                   |
|                                       .        c            p                 |
|                                       .       c                p              |
|                                       .       c                  p            |
|                                       .       c                   p           |
|                                       .        c                   p          |
|                                       .         c                   p         |
|                                       .           c                  p        |
|                                       .            c                 p        |
|                                       .             c                p        |
|                                       .             c                p        |
|                                       .           c                  p        |
|                                       .         c                    p        |
|                                       .       c                      p        |
|                                       .     c                      p          |
|                                       .       c                  p            |
|                                       .        c               p              |
|                                       .        c             p                |
|                                       .        c           p                  |
|                                       .       c          p                    |
|                                       .     c         p                       |
|                                       .     c       p                         |
|                                       .   c      p                            |
|                                       . c      p                              |
|                                       .c    p                                 |
|                                       .cp                                     |
|                                      pc                                       |
|                                   p   c                                       |
|                                p     c.                                       |
|                             p       c .                                       |
|                           p        c  .                                       |
|                        p         c    .                                       |
|                      p         c      .                                       |
|                   p           c       .                                       |
|                 p            c        .                                       |
|               p             c         .                                       |
|            p                 c        .                                       |
|           p                  c        .                                       |
|         p                    c        .                                       |
|        p                    c         .                                       |
|        p                  c           .                                       |
|       p                  c            .                                       |
|       p                c              .                                       |
|       p                c              .                                       |
|       p                c              .                                       |
|       p                  c            .                                       |
|       p                    c          .                                       |
|       p                       c       .                                       |
|         p                      c      .                                       |
|           p                  c        .                                       |
|             p               c         .                                       |
|               p             c         .                                       |
|                 p           c         .                                       |
|                   p          c        .                                       |
|                      p        c       .                                       |
|                        p        c     .                                       |
|                           p      c    .                                       |
|                             p      c  .                                       |
|                                 p   c .                                       |
|                                    pc .                                       |
PHASECAL = 1.00
 </pre><p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8369"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Tue, 18/12/2012 - 19:55.</div>
    <div class="content">
     <p><em>Quote:</em></p>
<p><em>There seems to be an assumption here that accurate measurements can only be taken if the sampling process is phase-locked to the waveform that is being measured.&nbsp; I don&#39;t understand why this should be so.&nbsp; The only important thing, surely, is to sample at regular intervals.&nbsp;</em></p>
<p>With a sinusoidal waveform, there is much more power and energy transferred in the parts with higher voltages than in the parts with lower voltages.</p>
<p>For a &#39;Gedankenexperiment&#39;&nbsp; (thought experiment?) go to an extreme: If you have a measuring interval of 5 ms (@50Hz mains, means 20 ms mains period), then this 5 ms interval can either lie around the maximum voltage in the sine curve or around the zero crossing. You get a much higher RMS value for voltage (and current) around maximum than around the zero crossing. So it clearly depends where your measuring interval lies within the mains period (if they are not equal in length).</p>
<p>If you take a less extreme example with a measuring interval of 19,8 ms (50Hz, 20 ms mains period) then taking e.g. 100 RMS values will give a &#39;beat&#39; effect in the results. They will slowly move up and down (in a sinusoidal form) . The sampling of a waveform with a frequency different to the frequencies in the waveform will always introduce &#39;mixing&#39; results. (This is one of the reasons why a &#39;Nyquist filter&#39; should always be used when sampling analog waveforms with an adc).</p>
<p>PS: one additional point: an RMS value is only defined over one complete period of the underlying waveform. If you measure only a fraction (or an &#39;inexact&#39; (?) multiple) of the period, then you do not get the RMS value! This might sound rather theoretical, but has exactly the above mentioned consequences.</p>
<p>AND: if you measure over a large number of periods, then the error gets smaller and smaller and smaller. This is how integrating meters work (more or less).</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8370"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1774.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1774.jpg" alt="PaulOckenden&#039;s picture" title="PaulOckenden&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1774.html" title="View user profile.">PaulOckenden</a> on Tue, 18/12/2012 - 19:35.</div>
    <div class="content">
     <p>An interesting point re PLL is what you lock on to. Remember, the voltage and current can be slightly (or even wildly) out of phase.</p>
<p>Which does it make most sense to lock to, if doing PLL&nbsp;style sampling?&nbsp;</p>
<p>Voltage I&#39;m guessing, as the phase of that won&#39;t change. And yet it&#39;s the current sample (which can change phase) which is of most interest.</p>
<p>P.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8371"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Tue, 18/12/2012 - 19:41.</div>
    <div class="content">
     <p><em>Quote: An interesting point re PLL is what you lock on to. Remember, the voltage and current can be slightly (or even wildly) out of phase.</em></p>
<p>Doesn&#39;t matter principally. Even if they are out of phase, they have the same frequency (in general). But it will off course be much easier to lock on to voltage as this is always there (not talking about mains outages :-) )! And it has clearly defined zero crossings most of the time (or maxima if you lock to these).</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8373"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2484.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2484.jpg" alt="jack_kelly&#039;s picture" title="jack_kelly&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/2484.html" title="View user profile.">jack_kelly</a> on Tue, 18/12/2012 - 20:05.</div>
    <div class="content">
     <p>I wonder if <em>randomly</em> sampling each cycle might be a good approach (as long as you sample many waveforms per RMS calculation: &nbsp; law of large numbers and all that).&nbsp; i.e. you take, say, 50 samples per cycle but these are randomly spaced.&nbsp; As Martin points out, we&#39;re doing integration over time, and a much-studied numerical approach for integration uses random sampling: <a href="http://en.wikipedia.org/wiki/Monte_Carlo_integration">Monte Carlo Integration</a>.&nbsp; (of course, creating a true random number generator on an Arduino is <a href="http://arduino.cc/forum/index.php/topic,7449.0.html">not a trivial problem</a>).&nbsp; Random sampling would avoid any &quot;beat frequency&quot; problems (and, like Robin, I&#39;d be a little worried that a software PLL may &quot;jitter&quot; too much, especially given that we&#39;re not sampling rapidly enough to actually measure zero-crossings so we have to interpolate to find where the zero crossings should be).</p>
<p>Robin wrote: <em>&quot;I do hope that someone else will be able to supply an equivalent trace at some stage&quot;</em></p>
<p>Whilst not exactly equivalent, I posted some current traces (recorded by my emonTX at 47 samples per cycle) <a href="1680.html#comment-8363">here</a>.</p>
<p>By the way, my empirical experiments with 17 samples-per-cycle versus 45 samples-per-cycle are leading me to believe that rapid sampling is a nice-to-have feature but may not actually improve accuracy much.&nbsp; But I was only measuring current (not voltage) so perhaps larger effects will be seen if sampling both voltage and current.&nbsp; My results are <a href="1680.html#comment-8351">here</a>.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8376"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 18/12/2012 - 21:07.</div>
    <div class="content">
     <p>If you are measuring a wave with high frequency content (a triac-chopped wave for example) then a high sample rate is essential (Nyquist again). If you&#39;re not and you have a pure sine wave, then only two samples per cycle are enough - Nyquist yet again.</p>
<p>Coming back to earth, there is less and less energy in the higher harmonics, so as Jack suggests, it makes little difference with a &quot;normal&quot; sort of wave shape. If you are taking 14 samples per cycle, you should read the 7th harmonic (350 Hz) accurately. If you are taking 46 samples, you should read the 23rd harmonic (1150 Hz).</p>
<p><em>&quot;I&#39;d be a little worried that a software PLL may &quot;jitter&quot; too much, especially given that we&#39;re not sampling rapidly enough to actually measure zero-crossings so we have to interpolate to find where the zero crossings should be&quot;</em></p>
<p>Er... If I understood the PLL code correctly, that isn&#39;t true. It actually locks <strong>so that</strong><strong> </strong>a measurement happens on the zero crossing - it uses any error measured there to adjust the frequency to maintain lock.</p>
<p>I&#39;ve no idea what the short-term jitter of the mains is, but if you realise that every generator on the system (both those actively generating and the spinning reserve) represents a flywheel weighing many tons, it can&#39;t be all that fast.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8379"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1332.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-1332.jpg" alt="JBecker&#039;s picture" title="JBecker&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/1332.html" title="View user profile.">JBecker</a> on Tue, 18/12/2012 - 21:39.</div>
    <div class="content">
     <p><em>Quote: I&#39;ve no idea what the short-term jitter of the mains is, but if you realise that every generator on the system (both those actively generating and the spinning reserve) represents a flywheel weighing many tons, it can&#39;t be all that fast.</em></p>
<p>This is the point! The mains fundamental frequency is amazingly stable, but higher frequency content can lead to severe zero crossing distortions which can bring a PLL out of synch or introduce a fixed or varying phase shift (depending on the nature of the distortions).</p>
<p><em>Quote: If .... you have a pure sine wave, then only two samples per cycle are enough&nbsp; </em></p>
<p>Enough for what? They are enough to &#39;recognize&#39; this single frequency in the resulting data. They are not enough to sample the waveform (what we need for real power measurement).</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8380"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 18/12/2012 - 21:55.</div>
    <div class="content">
     <p>Jack, I have a Bosch hot-air gun which operates just like your hair-drier.&nbsp; At low-power, they each only use half of the waveform; it&#39;s cheap, and effective for the manufacturer.&nbsp; As RW has pointed out on your hardware thread, the CT is always adjusting itself so that the DC content of its output waveform moves towards zero.&nbsp; This process happens all the time, but is less apparent when the waveform is sinusoidal.&nbsp;</p>
<p>It&#39;s for precisely this reason (the floating nature of our V and I sensors) that I decided to reinstate independent filters for each of them.&nbsp; Otherwise, when the current waveform changes shape, as it does with our half-power appliances, we&#39;d be subtracting an inappropriate level of DC offset.&nbsp; This would cause the calculated power value to be incorrectly inflated.&nbsp; Warning - micropence alert!!&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-8382"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Integer Maths is Magic!</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Wed, 27/02/2013 - 17:28.</div>
    <div class="content">
     <p>Not sure whether this is the right place to post this one as it&#39;s not actually to do with integer maths.&nbsp; It is however to do with analogRead() which was discussed earlier, and the right people seem to be on board, so here goes ...</p>
<p>Here&#39;s a couple of sketches to show how analogRead() and the equivalent low-level method behave:</p>
<p><strong>AnRead_speedCheck</strong> does 1000 pairs of analogRead() statements and then displays the amount of time taken.&nbsp; I always see a time of 223mS which is just over 89 loops per mains cycle period.</p>
<p><strong>ADC_speedCheck</strong> does the same workload but using low-level ADC instructions.&nbsp; As expected, the time taken is exactly the same.&nbsp; By use of the <em>delay_microseconds</em> variable, delay can be inserted while ADC conversions are underway.&nbsp; My rig can accept anything up to 100uS without any change to the results.&nbsp; Above 100uS, the overall time taken starts to become extended.</p>
<p>This sketch also has a flag which is &#39;cleared&#39; if there is spare time to do so.&nbsp; If it remains &#39;set&#39; when the ADC operation has finished, a counter is incremented by one.&nbsp; This mechanism provides another way of quantifying the amount of usable time that&#39;s available per analogRead() instruction.</p>
<p>Not sure whether this material will be much use to anyone, but it seemed like a good idea anyway.&nbsp; This kind of flag could be a useful addition for a Mk2a test build.&nbsp; If the flag ever fails to be cleared, my argument about the regularity of Mk2a&#39;s sampling intervals would be somewhat blown out of the water!</p>
<p>(files added 27/2/13, maybe I forgot to attach them earlier)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/1629"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-F738EdJxhh6yWyYXoA1VzvEfuVAuQ3-sUaJVVyYC_6Q" value="form-F738EdJxhh6yWyYXoA1VzvEfuVAuQ3-sUaJVVyYC_6Q"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
