<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/3815 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 16:19:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Solar PV power diversion with emonTx V3 using a PLL and temperature measurement | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>
        <span class="submitted">Submitted by <a href="../user/4782.html" title="View user profile.">AllenConquest</a> on Sun, 09/02/2014 - 21:22</span>
        <div class="content"><p>I have Martin&#39;s sketch up and running (with a few modifications to use different CT connections). However, I&#39;m not getting a reading from my temperature sensor. My output looks like this:</p>
<p>514 511 510 239.41 811.56 4.36 0.00 49.99 0.00 0.00 PLL is locked</p>
<p>I have CT1 as my grid input (811.56), CT2 is my Solar PV (4.36). The voltage and frequency look fine, but I&#39;m getting 0.00 for the temperature.</p>
<p>I know the sensor is working because the previous sketch (emonTxV3 Discrete Sampling) was displaying the temperature correctly. I changed the W1PIN define to 5 for the emonTx V3.</p>
<p>The pin changes I made are:</p>
<p>// Arduino I/O pin useage<br />
	#define VOLTSPIN 0<br />
	#define CT1PIN 2<br />
	#define CT2PIN 4<br />
	#define LEDPIN 6<br />
	//#define SYNCPIN 6 // this output will be a 50Hz square wave locked to the 50Hz input<br />
	//#define SAMPPIN 5 // this output goes high each time an ADC conversion starts or completes<br />
	#define RFMSELPIN 4<br />
	#define RFMIRQPIN 3<br />
	#define SDOPIN 12<br />
	#define W1PIN 5 // 1-Wire pin for temperature<br />
	#define TRIACPIN 2 // triac driver pin</p>
<p>Is there anything else I need to change in this sketch for the emonTX V3 ?</p>
<p>Thanks,</p>
<p>Allen</p>
  <div class="forum-topic-navigation clear-block">
          <a href="3600.html" class="topic-previous" title="Go to previous forum topic">‹ [Solved] emonTH gas with phototransistor</a>
              <a href="3898.html" class="topic-next" title="Go to next forum topic">Non-wireless connection ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-18305"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 10/02/2014 - 00:19.</div>
    <div class="content">
     <p>Are you powering the temperature sensor with the output from DIO 19? If you are, have you turned that on? Remember, the emonTx V2 powered the temperature sensor all the time, and that is the version that Martin&#39;s code was written for.</p>
<p>(See in the default emonTx V3 sketch:</p>
<p class="rteindent1">const byte DS18B20_PWR= 19;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // DS18B20 Power</p>
<p>for a hint.)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18313"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4782.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4782.png" alt="AllenConquest&#039;s picture" title="AllenConquest&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/4782.html" title="View user profile.">AllenConquest</a> on Mon, 10/02/2014 - 10:47.</div>
    <div class="content">
     <p>I had noticed the statements switching the power on in the emonTx V3&nbsp;sketch, but having never had a V2 I didn&#39;t realise the difference.</p>
<p>However, I have tried putting the&nbsp;digitalWrite(DS18B20_PWR, HIGH) statement in the readTemperature() method of Martin&#39;s sketch, but I still get nothing back. So I now have (where I have defined DS18B20_PWR to be 19):</p>
<p>int readTemperature()<br />
	{<br />
	&nbsp; byte buf[9];<br />
	&nbsp; int result;<br />
	&nbsp; digitalWrite(DS18B20_PWR, HIGH);<br />
	&nbsp; oneWire.reset();<br />
	&nbsp; oneWire.write(SKIP_ROM);<br />
	&nbsp; oneWire.write(READ_SCRATCHPAD);<br />
	&nbsp; for(int i=0; i&lt;9; i++) buf[i]=oneWire.read();<br />
	&nbsp; if(oneWire.crc8(buf,8)==buf[8])<br />
	&nbsp; {<br />
	&nbsp;&nbsp;&nbsp; result=(buf[1]&lt;&lt;8)|buf[0];<br />
	&nbsp;&nbsp;&nbsp; // result is temperature x16, multiply by 6.25 to convert to temperature x100<br />
	&nbsp;&nbsp;&nbsp; result=(result*6)+(result&gt;&gt;2);<br />
	&nbsp; }<br />
	&nbsp; else result=BAD_TEMPERATURE;<br />
	&nbsp; digitalWrite(DS18B20_PWR, LOW);<br />
	&nbsp; return result;<br />
	}</p>
<p>Can anyone help?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18316"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 10/02/2014 - 13:04.</div>
    <div class="content">
     <p><br type="_moz" /><br />
	&nbsp;I used 2&nbsp;functions to access the DS18B20 convertTemperature() starts the conversion and readTemperature() reads the result.</p>
<p>By turning the power off in readTemperature() you will have no power during the conversion process. Since you are using the PLL you presumably are running on mains power so there is no reason not to leave the DS18B20 power on all the time.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18317"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4782.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4782.png" alt="AllenConquest&#039;s picture" title="AllenConquest&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/4782.html" title="View user profile.">AllenConquest</a> on Mon, 10/02/2014 - 13:51.</div>
    <div class="content">
     <p>I tried just switching it on in the setup(), but that didn&#39;t help. So I also added it to the convertTemperature() and readTermperature() method, but still no output.</p>
<p>void convertTemperature()<br />
	{<br />
	&nbsp; oneWire.reset();<br />
	&nbsp; digitalWrite(DS18B20_PWR, HIGH);<br />
	&nbsp; oneWire.write(SKIP_ROM);<br />
	&nbsp; oneWire.write(CONVERT_TEMPERATURE);<br />
	}</p>
<p>I tried the statement both before and after the oneWire.reset() call incase that was doing something. What was the reason for not using the&nbsp;DallasTemperature&nbsp;library?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18319"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/1824.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="MartinR&#039;s picture" title="MartinR&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/1824.html" title="View user profile.">MartinR</a> on Mon, 10/02/2014 - 14:44.</div>
    <div class="content">
     <p>In the above the power will still be off for the oneWire reset command. Just turn the power on in setup() and remove all other references to DS18B20_PWR.</p>
<p>The Dallas library spends too much time waiting for things to happen so it can&#39;t be used with continuous monitoring.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18322"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4782.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4782.png" alt="AllenConquest&#039;s picture" title="AllenConquest&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/4782.html" title="View user profile.">AllenConquest</a> on Mon, 10/02/2014 - 17:53.</div>
    <div class="content">
     <p>I solved the problem. I was forgetting the pinMode() command. So now these two lines are in my Setup() function and that is all.</p>
<p>pinMode(DS18B20_PWR, OUTPUT);<br />
	digitalWrite(DS18B20_PWR, HIGH);</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18324"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4782.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4782.png" alt="AllenConquest&#039;s picture" title="AllenConquest&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/4782.html" title="View user profile.">AllenConquest</a> on Mon, 10/02/2014 - 18:43.</div>
    <div class="content">
     <p>I now have one outstanding issue. I am driving an SSR&nbsp;to simplify the output stage, directly from the Dig2 (pin 4 on connector block) and GND (pin 3 on the connector block). This is giving me an switching voltage of around 3.3V, which hard switch the SSR.&nbsp;</p>
<p>In fact it seems that there is a resistance between the output pins that varies depending on the switching voltage. If I use a 9V&nbsp;battery to switch the relay I get a lower output resistance that 3.3V.</p>
<p>Is there a way to use the 5V&nbsp;supply to switch the relay instead of the 3.3V ?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18510"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4782.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4782.png" alt="AllenConquest&#039;s picture" title="AllenConquest&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/4782.html" title="View user profile.">AllenConquest</a> on Mon, 17/02/2014 - 18:39.</div>
    <div class="content">
     <p>I&#39;ve hit a problem that I hope someone can help me with. My temperature sensor has suddenly started returning 300 Celsius. I can see from Martin&#39;s sketch that this is a default value when something is wrong. I&#39;m not quiet able to understand what the oneWire code is doing and why this might be.</p>
<p>I loaded up the default&nbsp;emonTxV3 Discrete Sampling sketch and that is reporting the temperature correctly. So there is something in the code, but I don&#39;t know what.</p>
<p>Can anyone help?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18511"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 17/02/2014 - 19:42.</div>
    <div class="content">
     <p><em>&quot;So there is something in the code&quot;&nbsp;</em> Not necessarily. It might also be a power supply issue - if the supply is dipping because you are drawing too much current from the 3.3 V rail, that could easily cause the DS18B20 to malfunction. The minimum supply voltage is only 3.0 V, so it doesn&#39;t have far to go. Does the DS18B20 work correctly with your code if you disconnect the SSR? If it does, I might be right, if not, I am probably wrong.</p>
<p>To understand the DS18B20 code, you need to study its data sheet. On page 10, the explanation starts with an overview and goes into increasing levels of detail, before giving examples on page 18.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18672"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/4782.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-4782.png" alt="AllenConquest&#039;s picture" title="AllenConquest&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/4782.html" title="View user profile.">AllenConquest</a> on Sat, 22/02/2014 - 23:50.</div>
    <div class="content">
     <p>My setup has now been diverting to the hot water tank for a few days and it&#39;s looking good. I now have 2 temperature sensors connected (top and bottom of cylinder).&nbsp;</p>
<p>Can anyone tell me where in Martin&#39;s sketch to put the logic to switch off diverting when a set temperature is reached?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-18673"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Solar PV power diversion with emonTx V3 using a PLL and temperature measurement</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 23/02/2014 - 00:58.</div>
    <div class="content">
     <p>The actual comparison logic needs to be done infrequently, so immediately after you&#39;ve got the temperature is a good place for that - set a logical flag and use that every cycle to determine whether to block setting the triac trigger.</p>
<p>Lines 328 or 331 look to be promising candidates, depending on whether you want to allow the manual triggering or not. &quot;divertFlag&quot; is used eventually to calculate the power diverted, so you need to make sure that is dealt with correctly too. I can&#39;t see any other traps that might catch you out.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/3815"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-Y7n4okYk9vphBnK8ZxI22JJL7FbCQm-PD7Kdx8zElMM" value="form-Y7n4okYk9vphBnK8ZxI22JJL7FbCQm-PD7Kdx8zElMM"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
