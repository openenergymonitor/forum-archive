<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/12030 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 14:10:14 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>EmonPi schematic/board diffs, additional CTs and alternative firmware changes | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>
        <span class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 18/01/2016 - 13:00</span>
        <div class="content"><p>Hi.</p>
<p>Today I&#39;m building the add-up for my emonPi&nbsp;for a&nbsp;3rd CT sensor and noticed what seems to be a difference between the schematic and the board tracks:</p>
<p>It seems to me that the connection to the GND of the jack has not been made in the EmonPi Board.</p>
<p>Is there a reason for this, should I connect this&nbsp;or not in&nbsp;my 3rd CT input?</p>
<p>From what I can understand this connection shouldn&#39;t be done because I think it would cause a permanent negative reading when the CT is disconnected. Am I right?</p>
<p><img alt="" src="../../../vieirasoft.net/Capture_Emon_Diff_sch_brd.png" style="width: 695px; height: 438px;" /></p>
<p>Cheers.</p>
  <div class="forum-topic-navigation clear-block">
          <a href="12312.html" class="topic-previous" title="Go to previous forum topic">‹ Very new and lost :)</a>
              <a href="12120.html" class="topic-next" title="Go to next forum topic">Pulse counter for energy meter  ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-38433"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 18/01/2016 - 13:57.</div>
    <div class="content">
     <p>How can it cause a permanent negative reading? The purpose is to hold the input at GND (ADC output = 0) when no CT plug is inserted, so that the sketch can detect the presence or absence of a plug - and hopefully of the CT - and&nbsp;skip reading and processing that input if necessary. If the PCB layout is correct, I don&#39;t know why the connection has been left off - it may have been decided that this feature was not needed, or it&nbsp;may simply be an oversight that will be corrected at some time in the future.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38438"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 18/01/2016 - 15:51.</div>
    <div class="content">
     <p>Hi.</p>
<p>I thought that the Voltage divider&nbsp;composed of the 2 470k resistors was to create a 1.65 V midpoint voltage.</p>
<p>If we pull the input to zero wouldn&#39;t it be equivalent to reading -1.65 V?</p>
<p>Maybe if&nbsp;the reading is zero at the analog input&nbsp;equivalent to an extreme of -1.65 V the software can consider the absence of the CT sensor and that is the purpose of the connection to GND.</p>
<p>Anyway, that connection&nbsp;seems not be be there.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38442"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 18/01/2016 - 16:29.</div>
    <div class="content">
     <p>&quot;<em>I thought that the Voltage divider&nbsp;composed of the 2 470k resistors was to create a 1.65 V midpoint voltage.&quot;</em></p>
<p>Yes, that&#39;s what it does. Normally.</p>
<p><em>&quot;If we pull the input to zero wouldn&#39;t it be equivalent to reading -1.65 V?&quot;</em></p>
<p>Stop and look at the circuit diagram. There&#39;s no plug in the socket, so the input terminal of the socket is grounded. Hence the ADC input is effectively grounded via the burden resistor - which has no voltage across it because there&#39;s no current flowing in it. Where does the -1.65 V come from? Or to ask the question in a different way, what has happened to voltages and currents in the voltage divider?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38448"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Mon, 18/01/2016 - 17:43.</div>
    <div class="content">
     <p><em><strong>The way the schematic is drawn,</strong></em> it appears the &quot;error&quot; is actually in the CT2 circuit. The line from the fixed contact (pin 4) to ground is connected directly under the arrowhead, but should be drawn like the CT1 circuit, i.e. just a bit to the right of the arrowhead.</p>
<p>Drawing error only. Nothing more.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38449"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 18/01/2016 - 17:56.</div>
    <div class="content">
     <p>Hi.</p>
<p>Bill: I was not referring to that (I don&#39;t think that that should even be&nbsp;considered&nbsp;an error, both pin 4 are connected to GND). The possible error I&#39;m referring to is on the tracks schema that the Pin 4 doesn&#39;t seem to be&nbsp;connected to the GND.</p>
<p>Robert: The -1.65V I&#39;m referring are related to the midpoint that is considered to calculate the alternate voltages/currents. I know that the circuit will read a real 0 volts at the port, but if the software is not programmed to detect&nbsp;a disconnected&nbsp;CT wouldn&#39;t it read -100A (probably not, I cannot <em>compute</em> the calculated current of a line at the -1.65V in all 360&ordm; of the wave length)</p>
<p>I&#39;m to confused now...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38452"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3426.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3426.jpg" alt="Bill Thomson&#039;s picture" title="Bill Thomson&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3426.html" title="View user profile.">Bill Thomson</a> on Mon, 18/01/2016 - 18:07.</div>
    <div class="content">
     <p>The arrowhead represents the contact. Thus the schematic shows a connection directly to the contact. It&#39;s really a matter of semantics. That&#39;s why I emphasized &quot;the way the schematics is <strong>drawn</strong>&quot; i.e. I was trying to pot out a <em>drawing</em> error.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38454"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 18/01/2016 - 19:20.</div>
    <div class="content">
     <p>Having just taken the end panel off an emonPi&nbsp;and measured it, I confirm there&nbsp;<strong>is</strong>&nbsp;a ground connection, so it&#39;s the PCB layout that seems to be incorrect, in that the ground plane isn&#39;t shown.</p>
<p><em>&quot;if the software is not programmed to detect&nbsp;a disconnected&nbsp;CT wouldn&#39;t it read -100A&quot;</em><br />
No. You need to explain your thinking a little better, because I can&#39;t see how you think that a socket with no input can read anything.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38456"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 18/01/2016 - 19:35.</div>
    <div class="content">
     <p>I don&#39;t know how to explain it, maybe I&#39;m wrong.</p>
<p>A reading of GND level wouldn&#39;t be considered by the software a permanent reading of negative amperage?</p>
<p>I believe that, to have a zero Amperes reading the analog port reading has to be 1.65V (the midpoint) what intensity will be calculated if the reading at the port is permanent zero or a logic -1.65V?</p>
<p>I don&#39;t really know, maybe the result is zero amps also...</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38458"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 18/01/2016 - 20:00.</div>
    <div class="content">
     <p>Ah, I understand now. You&#39;ve forgotten the filter in emonLib&nbsp;that removes the 1.65 V bias that the voltage divider adds to&nbsp;the current signal. So, whatever happens to the actual input, provided that the voltage at all times remains within the input range of the ADC, the filter will remove the d.c. component and pass only the a.c component to be measured and reported.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38464"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 18/01/2016 - 21:16.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;m not using the emonLib, instead I&#39;m using a firmware I&#39;ve altered based on the MK2 energy diverter.</p>
<p>I will make the firmware changes to use the 3rd CT before I connect it, so I will see how it will react to that situation.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38465"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 18/01/2016 - 21:24.</div>
    <div class="content">
     <p>The Mk 2 has,&nbsp;as far as I remember (without checking),&nbsp;no detection of a missing CT because it&#39;s assumed that you need the CT at all times and it is not an option&nbsp;to not have one. &nbsp;But notice, the Mk2 does NOT report or display current (it only uses the current multiplied by the voltage to calculate&nbsp;the&nbsp;average power), so it&#39;s only necessary to remove the offset in the voltage signal. Therefore, the Mk2 has the same filter arrangement on the voltage input, and&nbsp;no&nbsp;filter on the current input(s).&nbsp;If you need the current separately, then you need to apply the filter to the current signal too.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38467"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 18/01/2016 - 21:34.</div>
    <div class="content">
     <p>Yea.</p>
<p>I forgot that with MK2 we only have Real Power output, not apparent power (VA).</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38521"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 19/01/2016 - 22:16.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve made the first changes on the code to accept the additional CT sensor and I&#39;m getting a negative reading of around&nbsp;780W with absolutely no hardware connected to the analog port.</p>
<p><img alt="" src="../../../vieirasoft.net/Capture_Emon_negative_reading.png" style="width: 487px; height: 155px;" /></p>
<p>Let&#39;s see how it goes when I connect the CT hardware.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38709"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 25/01/2016 - 11:49.</div>
    <div class="content">
     <p>Hi.</p>
<p>NewsFlash:</p>
<p>I&#39;ve made my external &quot;kit&quot; to connect to the EmonPI and get a 3rd CT sensor working.</p>
<p>I&#39;m using the same circuit above connected to the EmonPI&nbsp;RJ45&nbsp;port (ADC6) and I&#39;m getting the 3.3V from the ISP1&nbsp;connector (instead of changing the circuit to use 5V available at&nbsp;the RJ45 port).</p>
<p>For testing and calibration purposes&nbsp;I&#39;ve put the 3rd CT sensor&nbsp;next to the mains CT so it would measure exactly the same current/power.<br />
At the beginning I noticed a slightly difference&nbsp;in the reading of about 10W and I compensated that adjusting the PowerCal for this CT in the firmware I&#39;m using&nbsp;based on the MK2 thinking that I was getting this difference because of components not being exactly the same, etc etc.</p>
<p>Now I&#39;m noticing that the reading are the same around&nbsp;500W&nbsp;but are lower at lower powers and higher at higher powers.</p>
<p>This is a sample:</p>
<blockquote><p>Timestamp P1 P3 Diff</p>
<p>1453666680 1671 1682 11<br />
1453666690 1037 1042 5<br />
1453666695 1301 1309 8<br />
1453666705 1295 1303 8<br />
1453666710 1285 1293 8<br />
1453666720 2523 2544 21<br />
1453666725 1653 1664 11<br />
1453666765 2044 2061 17<br />
1453666770 2533 2549 16<br />
1453666780 1186 1185 -1<br />
1453666795 382 374 -8<br />
1453666800 383 375 -8<br />
1453666810 378 370 -8<br />
1453666815 395 386 -9<br />
1453666820 378 369 -9<br />
1453666825 1162 1161 -1<br />
1453666830 2503 2517 14<br />
1453666840 2414 2427 13<br />
1453666855 1184 1185 1<br />
1453666860 870 866 -4<br />
1453666870 385 377 -8<br />
1453666875 385 376 -9<br />
1453666880 384 375 -9<br />
1453666885 383 374 -9<br />
1453666890 382 374 -8</p>
</blockquote>
<p>Any ideas&nbsp;on how to correct this, preferably by software/firmware change?</p>
<p>Cheers&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38717"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 25/01/2016 - 15:58.</div>
    <div class="content">
     <p>From your description, that sounds like a straightforward calibration issue. Do&nbsp;not&nbsp;expect two CTs and two burden resistors to give exactly the same answer. The CT has a 3% tolerance, the resistor might be 1% or 5%, depending on what exactly you&#39;ve used, so if the numbers are within 15% of one another, that is within the band that is acceptable. The whole purpose of calibration is to remove that difference.</p>
<p>Read about component tolerances in Resources &gt; Building Blocks.</p>
<p>Also, be aware that, unless you have changed Robin&#39;s code, the Mk2 does not completely remove the d.c offset, so although real power is calculated correctly, current might not be.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38722"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 25/01/2016 - 16:42.</div>
    <div class="content">
     <p>Hi.</p>
<p>Thank you for your answer.</p>
<p>I used 1% tolerance resistors.</p>
<p>I&#39;m talking about Ws of power, not VAs or As (the MK2 sketch doesn&#39;t even &quot;compute&quot; VAs or Amps).</p>
<p>I would expect a linear result that could be corrected with PowerCal, but this doesn&#39;t seem to be the case as it &quot;middle&quot; point where it goes negative and positive.</p>
<p>I will try to change the order of sample collection in the ISR routine&nbsp;so it gets P3 after V instead of P1 after V and see what happens to the results.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38723"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Mon, 25/01/2016 - 16:56.</div>
    <div class="content">
     <p>Also, remember that phasecal, apart from attempting to correct the difference in phase error between the two transformers, also corrects the timing difference between samples, which is 104&nbsp;&mu;s between successive samples. It does not make a great difference though with a purely resistive load.</p>
<p>If you have a significant noise contribution, I suggest you subtract a constant from each power to give a zero power reading (or acceptably close to zero) on no load, then adjust powercal&nbsp;at as high a load as you can, to give the same reading on both.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38774"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 26/01/2016 - 22:42.</div>
    <div class="content">
     <p>Hi.</p>
<p>I noticed that, when I read the CT3 before CT1 I invert the readings, so it seems that both CTs are reading correctly, but the firmware is not computing the values right.</p>
<p>I&#39;ve made some changes to my firmware so I can online change the powercal and&nbsp;phasecal&nbsp;for each CT so I can test values without needing to update the firmware on each try.</p>
<p>I&#39;ve tried changing the phasecal to values like .25, .5, .75, .9, etc.&nbsp;but I don&#39;t notice any change in the results.</p>
<p>Is phasecal a value that I should consider trying values with lower differences like .009 or .0009?</p>
<p>Next&nbsp;I will try ti understand what phasecal does in the code to see If I can tell how to use it to correct things.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38782"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 27/01/2016 - 00:00.</div>
    <div class="content">
     <p><em>&quot;Next&nbsp;I will try ti understand what phasecal does in the code to see If I can tell how to use it to correct things.&quot;</em><br />
Reading the Building Blocks article might save you some trouble.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38784"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 27/01/2016 - 01:02.</div>
    <div class="content">
     <p>I&#39;ve read &quot;Explanation of the phase correction algorithm&quot; and I noticed that the values are different from the mk2 system.</p>
<p>But, it&nbsp;works more or less as I expected.</p>
<p>I will read the code to see how it work in the mk2 code so I can apply&nbsp;the theory.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38894"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 29/01/2016 - 23:07.</div>
    <div class="content">
     <p>Hi.</p>
<p>I think I understood what the phaseCal&nbsp;value does for each CT, and I think it is <strong>very </strong>important to be dismissed and set to 1 to all CTs as if it wasn&#39;t important.</p>
<p>But there are things that are puzzling me, for instance this text</p>
<blockquote><p>// Values ouside the 0 to 1 range involve extrapolation, rather than interpolation<br />
// and are not recommended. &nbsp;By altering the order in which V and I samples are&nbsp;<br />
// taken, and for how many loops they are stored, it should always be possible to<br />
// arrange for the optimal value of phaseCal to lie within the range 0 to 1.</p>
</blockquote>
<p>But the fact is that, from what I understood, a value over 1, like 1.25, 1.5 and 1,75 would be the necessary values to correct the phase error between readings when we have 4 sensors (1 VAC and 3 CTs).</p>
<p>To invert the readings order, it seems to be necessary to collect the values from all CTs and make all the calculations in the Voltage cycle&nbsp;so we can use a phaseCal between 0 and 1 (0.75, 0.5, 0.25 to compensate the delay from the CT readings being made before). But doing this this way would probably exceed the maximum time that the ISR should run on that specific cycle.</p>
<p>Even with not recommended&nbsp;values over 1, I can&#39;t correct the readings, I will always get CT1 with higher readings than CT3, with about the same difference.</p>
<p>If I change the reading order from:<br />
Voltage, CT1, CT2, CT3<br />
to<br />
Voltage, CT3, CT2, CT1<br />
the&nbsp;difference will immediately* invert (be negative). This means that both CTs (including my external circuit) work correctly and are accurate enough.</p>
<p>*I&#39;ve made changes that allow me to change many values in the firmware, including the order that readings are made. At this point the base calculations are still the MK2 code, but the rest of the code may be already unrecognizable.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38897"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 29/01/2016 - 23:46.</div>
    <div class="content">
     <p>The description of Phasecal was written before the Mk2 Diverter and the &quot;continuous&quot; sketches appeared.&nbsp;The &quot;discrete&quot; sketches only ever read one CT and the voltage at a time, so if you read CT, Voltage with a modified emonLib, you will get a value for Phasecal between 0 and 1. I do not know how you have changed the Mk2 sketch so I cannot comment. One thing is certain, the same value of Phasecal will not be correct for 3 CTs, but unless you have loads with a very poor power factor, the phase correction does not have a significant effect.</span></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38898"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 30/01/2016 - 00:46.</div>
    <div class="content">
     <p>I &nbsp;think your comment confirms my learnings about this.&nbsp;I&#39;m trying to get similar readings on all CTs so that after I can accurately&nbsp;make a&nbsp;calibration&nbsp;that that will apply to all.</p>
<p>About the poor power factor, this CTs are&nbsp;hooked to the main grid wire, so the &nbsp;power factor will probably not be the best&nbsp;there.</p>
<p>About my changes to the code, I believe that I haven&#39;t made changes to the code that matter to this and&nbsp;the original code should behave the same way.</p>
<p>It would lovely that someone that has access to an EmonTx to test the MK2 sketch with CT4&nbsp;and CT3* on the same load to see if behaves like mine. But even so, there will be a difference because EmonTX makes 5 reads and mine only makes 4 (but this would be a thing I would be able to simulate), but anyway the the CT4 read is still one cycle delayed from the voltage and the CT3 two cycles.</p>
<p>* I said CT4&nbsp;and CT3 because the MK2&nbsp;sketch reads in this order: Voltage, CT4, CT3, CT2 and CT1</p>
<p>At think point I&#39;m having 48 samples per cycle, with emonTX&nbsp;there should be only about 38. When I started I had 64 samples per cycle with only 2 CTs.</p>
<p>I thought&nbsp;about reading in a way that I get all the combinations possible of reading order like this:<br />
V CT1 CT2 CT3&nbsp;V CT1 CT3 CT2&nbsp;V CT2 CT1 CT3&nbsp;V CT2 CT3 CT1&nbsp;V CT3 CT1 CT2&nbsp;V CT3 CT2 CT1<br />
But I don&#39;t like the idea.</p>
<p>At this point what I don&#39;t&nbsp;understand&nbsp;is why the&nbsp;phaseCal&nbsp;correction don&#39;t change anything, but at the same time, it seems that if the readings&nbsp;difference&nbsp;invert when I change the reading order, the problem should be related to the phaseCal...</p>
<p>Can there be some idea that I&#39;m missing on all this?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38899"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 30/01/2016 - 02:39.</div>
    <div class="content">
     <p>The name Phasecal is wrong - it does not describe all that it does.  Phasecal shifts the voltage wave in an attempt to correct for two things: (1) the <em >difference</em> between the phase error of the voltage transformer and the phase error of the current transformer, and (2) the time difference between taking the readings. Both phase errors change as the quantity being measured changes, so Phasecal will never be correct if the voltage and current vary from the values when the errors were measured. If you read the test reports on the two transformers, you can see how the phase error changes. In your sketch, one value of phasecal will never be suitable for all four CTs because the time difference is 104&nbsp;&mu;s greater for each one.</span></p>
<p>If you need to have a similar (it can never be the same) Phasecal for each CT, you must read CT1 V CT2 V CT3 V and use pairs for current and voltage readings (for the 3 real powers).</p>
<p>I am working on the &quot;CM&quot; sketch to remove a number of problems, phase calibration is one of them.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38901"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 30/01/2016 - 08:41.</div>
    <div class="content">
     <p><em>About the poor power factor, this CTs are&nbsp;hooked to the main grid wire, so the &nbsp;power factor will probably not be the best&nbsp;there.</em></p>
<p>You tweaked my curiosity with that comment, so I decided to plot my whole-house power factor across a day. &nbsp;Of course&nbsp;looking at power factor without also looking at power is fairly meaningless, but for better or worse here it is. That solid 100% during the middle of the day is the PV export. &nbsp;You can also see the fridge cycling at night; the compressor running actually improves my power factor because without it, all that&#39;s left in the middle of the night is background electronics.</p>
<p>As others have said before, the higher the power flow (in either direction) usually the closer the power factor is to unity.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38904"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 30/01/2016 - 09:55.</div>
    <div class="content">
     <p>Good Morning.</p>
<p>I think I&#39;ve left an idea that is not what I meant:<br />
- With the default MK2 sketch the phaseCal (or PhaseShift as you correctly called&nbsp;it) is 1 to all CTs;<br />
- But I don&#39;t need to have the same <em>phaseShift</em> for all CTs, I want to find the best value for each CT that enables me to have similar readings on all CTs when they are measuring the same live wire.</p>
<p>Yesterday night I found something, but I know that the programmer will be pissed off with me again with my next sentence because he believes that his code don&#39;t have errors but I suspect that this&nbsp;code shouldn&#39;t be there: &quot;&gt;&gt;8&quot; because it is diving&nbsp;the shifted portion&nbsp;by 256 when, I think, it should be at the same greatness size.</p>
<blockquote><p>&nbsp; &nbsp; &nbsp; phaseShiftedSampleV_minusDC_long = lastSampleV_minusDC_long<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ (((sampleVminusDC_long - lastSampleV_minusDC_long)*phaseCal_int_CT1)<u><strong>&gt;&gt;8</strong></u>);</p>
<p>&nbsp;</p>
</blockquote>
<p>Even so, if I remove this <em>division</em>&nbsp;from the code, I noticed a slight change but not enough to correct the problem. I will make more tests later.</p>
<p>Cheers.&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38910"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sat, 30/01/2016 - 13:28.</div>
    <div class="content">
     <p>No, the &quot;&gt;&gt;8&quot; is correct. It is&nbsp;<strong><em>restoring</em></strong>&nbsp;the scale because&nbsp;phaseCal_int_CT1 is itself left-shifted by 8 bits:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; phaseCal_int_CT[i] = phaseCal_CT[i] * 256; // for integer maths</p>
<p><em>&quot;&nbsp;With the default MK2 sketch the phaseCal (or PhaseShift as you correctly called&nbsp;it) is 1 to all CTs;&quot;</em><br />
That arises from what I wrote a little way back - where the dominant load is near unity power factor, phasecal makes little difference.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38914"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 30/01/2016 - 22:01.</div>
    <div class="content">
     <p>Humm...</p>
<p>You are right, missed that one, looking again...</p>
<p>shouldn&#39;t it be:<br />
&nbsp;phaseShiftedSampleV_minusDC_long = lastSampleV_minusDC_long<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ (((sampleVminusDC_long - lastSampleV_minusDC_long)*phaseCal_int_CT1&gt;&gt;8));</p>
<p>So that only the variable phaseCal_int_CTx is divided, instead of the shifted value multiplied by the phaseCal_int_CTx?</p>
<p><strong>UPDATE: The representation would be be better, but the result is the same</strong></p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38942"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sun, 31/01/2016 - 17:09.</div>
    <div class="content">
     <p><em>CidiRome: Yesterday night I found something, but I know that the programmer will be pissed off with me again with my next sentence because he believes that his code don&#39;t have errors ...</em></p>
<p>I don&#39;t think this kind of comment is helpful or fair.&nbsp; If someone has doubts about code that I or anyone else has posted via this forum, it&#39;s only reasonable that those doubts are aired here.&nbsp; But please let&#39;s do this in a constructive manner rather than getting personal about it.&nbsp; Thanks.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38946"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sun, 31/01/2016 - 19:05.</div>
    <div class="content">
     <p>I have always been constructive. May not have been always correct, but my objective has been always shed light to doubts I had.</p>
<p>I&#39;m trying to put this code working correctly, let&#39;s see if I can do that. Until I can get all CTs making similar readings it is not ok for&nbsp;me. I believe that I can get this code reading CTs with constant differences lower than 5W when reading loads under 1000W&nbsp;(taking in account I use 3 loops in the CT and the division is made by the powercal value).</p>
<p>Since you came to this thread, can you test your code with as many CTs as possible&nbsp;in the same live wire and see if the readings are similar in them all?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38950"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9309.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="PBudmark&#039;s picture" title="PBudmark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/9309.html" title="View user profile.">PBudmark</a> on Sun, 31/01/2016 - 21:33.</div>
    <div class="content">
     <p>Actually, the result is not the same, as&nbsp;phaseCal_int_CT[1] is an double multiplied by 256 (and truncated to int).<br />
With phaseCal_CT[1]=1.12, the upscaled&nbsp;phaseCal_int_CT[1] is 0x11E</p>
<p>Multiplying diff by 0x11E and then &gt;&gt;8 differs from multiplying diff with 0x1</p>
<p>/Per-Ake</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38952"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 31/01/2016 - 22:00.</div>
    <div class="content">
     <p>Per-Ake, what are you trying to say? The object is to remove the slow floating-point calculation from the time-critical section of code. The real consideration is this (given that phasecal itself is only a rough approximation, knowing&nbsp;the variation in the phase errors that it tries to correct): Is multiplying a floating-point number&nbsp;by 256 and truncating to integer, using that to perform&nbsp;a second multiplication on&nbsp;a varying value, then right-shifting the result by 8 bits, acceptably close to multiplying that same varying value by the original floating-point number?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38955"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/9309.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="PBudmark&#039;s picture" title="PBudmark&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/9309.html" title="View user profile.">PBudmark</a> on Sun, 31/01/2016 - 22:13.</div>
    <div class="content">
     <p>My reply was to entry &quot;Submitted by&nbsp;CidiRome&nbsp;on Sat, 30/01/2016 - 22:01.&quot;, with reply #38914, but obviously all replies goes to the end...</p>
<p>I am trying to say that the code used in the library is correct (and works as intended) and that the suggested rewriting (in the post replied to) does not give the same result, ie the UPDATE-statement is not correct.</p>
<p>The text: &quot;Multiplying diff by 0x11E and then &gt;&gt;8 differs from multiplying diff with 0x1&quot; was intended to show the difference between<br />
1)&nbsp;the correct handling in lib:&nbsp;Multiplying diff by&nbsp;0x11E&nbsp;and then &gt;&gt;8<br />
2)&nbsp;the suggested (incorrect) handling:&nbsp;multiplying diff with 0x1<br />
/Per-Ake</p>
<p>&nbsp;</p>
<p><em>[ I understand now - thanks. RW.]</em></p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38956"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Sun, 31/01/2016 - 22:21.</div>
    <div class="content">
     <p>Maybe this thread should be reserved for the helpful enquiry that was originally raised about the emonPi and its documentation.&nbsp; The conversation seems to have since moved off in several different directions so is likely to become lost because the title is no longer relevant.&nbsp; The purpose and implementation of phaseCal has been well explored in many other threads over the years.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38957"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 31/01/2016 - 23:03.</div>
    <div class="content">
     <p>CidiRome:</p>
<p>We, the moderators, have discussed this thread and your contributions&nbsp;in this thread and elsewhere.</p>
<p>This is the second time on these public forums that Robin Emley&nbsp;(calypso_rae)&nbsp;has had cause to object to comments that you have made about him and &#39;his&#39; software. While we all appreciate that English might not be your native language, I think you have an excellent command of English, and that it should be good enough for you to be able to avoid phrasing questions and making comments in a way that can be understood as a direct criticism of a particular person - someone in this case who has&nbsp;made a huge contribution to the OEM community.&nbsp;</p>
<p>We also understand that you are trying to learn what is a fairly difficult and complicated subject, but as Robin pointed out last time, the way to do that is to read, read again, investigate, check and try to follow the path of the logic through for yourself. Only when you fail is it time to ask a question. And when that time comes, you must ask for an explanation for why something was done in the way it was,&nbsp;and you must not write it as you did here: &quot;<em>Yesterday night I found something, but I know that the programmer will be pissed off with me again with my next sentence because he believes that his code don&#39;t have errors ...&quot;</em>.</p>
<p>We are now asking you&nbsp;to note that personal criticism is not acceptable here, and to make your comments and ask your questions in such a way as to avoid any perception of that. If you continue, your account will be closed and you will not be allowed to post.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38959"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 01/02/2016 - 00:19.</div>
    <div class="content">
     <p>I apologize&nbsp;again if I insulted anyone, as I said before it was never my intent.</p>
<p>Reading again that sentence, I admit it can have a bad interpretation, but I said it in a fun way.</p>
<p>Thanks&nbsp;PBudmark, your explanation was very constructive, once again I admit I didn&#39;t saw that the precision would be lost in the variable if the &gt;&gt;8 was made before. I&#39;ve made tests without considering the variable limitations, and in this pseudo high level language, that has to be carefully taken in account.</p>
<p>Pass this, any suggestion on how to get the all the CTs reading similar values?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38962"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 01/02/2016 - 09:58.</div>
    <div class="content">
     <p>Maybe it&#39;s time to go back to basics..... wrap your CTs around&nbsp;a wire with:</p>
<ul>
<li>no load</li>
<li>a large known resistive load</li>
</ul>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38963"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 01/02/2016 - 10:42.</div>
    <div class="content">
     <p>Thank you dBC.</p>
<p>I haven&#39;t done that again because, I don&#39;t want to take my EmonPI out of service for a while that would be needed to accomplish&nbsp;that. The 2 CT&#39;s I&#39;m testing are inside the breaker box wrapped to the mains live wire and later I will take the second (CT3) to another breaker I want to measure.</p>
<p>Do you think that it possible that I&#39;m having a so basic problem when:</p>
<ul>
<li>On loads lower than 500W (reading with 3 loops around&nbsp;the CT with calcs made by the FW)</li>
<li>With sensor order like V, CT1, CT2, CT3 I get CT1 (related to CT3) with higher readings of about 10 to 20 W</li>
<li>With sensor order like V, CT3, CT2, CT1 I get CT1&nbsp;(related to CT3) with lower readings of about 10 to 20 W</li>
<li>On higher loads the problem get worse.</li>
</ul>
<p>It is a very strange coincidence...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38966"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 01/02/2016 - 11:57.</div>
    <div class="content">
     <p>I&#39;m not sure I understood too much of that, and I&#39;m not familiar with your code or the code it was based on, but it seems to me you&#39;re trying to calibrate to an unknown, changing signal with non-unity power factor. &nbsp;That strikes me as challenging. &nbsp;How do you know which calibration knob to turn when the results don&#39;t match?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38968"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 01/02/2016 - 12:55.</div>
    <div class="content">
     <p>Nice analogy.</p>
<p>You are right and I should do that calibration.</p>
<p>But, independently of the power factor, is it expected or not, that two CTs should make similar readings when clamped to the same wire?</p>
<p>In my understanding, if&nbsp;they only make the same readings when the reading order is changed in the code, there should be something that I&nbsp;can do to correct the code or improve it.</p>
<p>Anyway, at this point, I&#39;m thinking that this error will happen also with a load with power factor of 1, when I have time I will have to&nbsp;confirm that.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38985"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 01/02/2016 - 21:01.</div>
    <div class="content">
     <p><em>is it expected or not, that two CTs should make similar readings when clamped to the same wire?</em></p>
<p>Yes, I would expect that, provided they&#39;re both properly calibrated. &nbsp; Way down at the low-end, CTs start to come off the rails, especially in phase error, and each example of a CT does that differently. &nbsp;So if you were measuring a tiny signal I could imagine they could start to diverge quite significantly, but otherwise I&#39;d expect them to read the same.</p>
<p>But if they haven&#39;t been calibrated, then you&#39;re kinda&#39; stabbing in the dark. &nbsp;You may well stumble across some combination that appears to work for one situation, but doesn&#39;t for another.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38987"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 01/02/2016 - 21:11.</div>
    <div class="content">
     <p><em>I don&#39;t want to take my EmonPI out of service for a while that would be needed to accomplish that. The 2 CT&#39;s I&#39;m testing are inside the breaker box wrapped to the mains live wire and later I will take the second (CT3) to another breaker I want to measure.</em></p>
<p>Do you have a breaker that only has a known, large, resistive load on it? &nbsp;An electric oven breaker would be a good candidate. &nbsp;Maybe you could calibrate your new CT to that circuit?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-38991"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 01/02/2016 - 21:28.</div>
    <div class="content">
     <p>Hi.</p>
<p>The reason I keep <em>stabbing in the dark</em>, is because, from my previous calibration experiences, I ended using the same values for all CTs, slightly&nbsp;different from the original ones in the sketch, but the same for all, since all&nbsp;the CTs are the same model and maker and I get (at least apparent) correct values just by changing the readings order, until I have time and opportunity to make new calibrations ,I have to keep <em>stabbing </em>where&nbsp;I have room to.&nbsp;</p>
<p>That is the way I normally calibrate the CTs, but I still have to open the breaker box and change the CTs.</p>
<p>I&nbsp;thought&nbsp;of another thing, at this point I have a an even number of readings, one thing I wil try is to make it odd so the readings are irregular along the passing&nbsp;time, probably this means nothing, but...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39044"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 02/02/2016 - 22:30.</div>
    <div class="content">
     <p>Hi.</p>
<p>Latest findings.</p>
<p>dBC, you seem to be an expert on this area, please tell me if I&#39;m wrong on this assumptions.</p>
<p>I started looking thoroughly to the ISR code and limitations and found that (at least in my code) there is an&nbsp;ISR cycle in every&nbsp;energy Hz that is taking longer than 104uS and from what I understood this will mess the two values that read next. I suppose that the read value in the next ISR cycle will be the one requested in the present&nbsp;cycle&nbsp;because one cycle has been skipped and the&nbsp;value requested before is lost.</p>
<p>Then I found that this situation seems to be&nbsp;caused by this division<br />
long realPower_for_energyBucket &nbsp;= sumP_forEnergyBucket&nbsp;/ sampleSetsDuringThisCycle;<br />
that delays the code for about 40uS</p>
<p>​A curious&nbsp;thing&nbsp;is that the compiler/linker seems to be smart because if I remove the code where that variable is used (and still leave the division) it seems to also remove the variable creation and (at least) the division because the delay of the division also disappears.</p>
<p>To get to this conclusion I just removed the division part of the above line so that the variable is still used in the code after.</p>
<p>The bad news are that, even with the ISR always under 90uS I still get the reading errors, and I was hoping that this error&nbsp;was coming from this (1 wrong sample&nbsp;for every 48 samples or 240 wrong samples per second)... seems not. :-(</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39048"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Wed, 03/02/2016 - 00:08.</div>
    <div class="content">
     <p>I&#39;m not familiar with your code, or the code it&#39;s based on, so I can&#39;t really comment. &nbsp;But I can confirm that gcc is very good at getting rid of anything it&#39;s determined can&#39;t possibly make a difference. &nbsp;I had an example a while back where my f/w decides it wants to deliberately restart the box....</p>
<pre>
    link_led_shadow = original_link_led_shadow;
    while (1);             &nbsp;// Let the wdog bite us</pre><p>link_led_shadow is a global&nbsp;machine-state variable&nbsp;that my&nbsp;watchdog ISR preserves in non-volatile&nbsp;storage before resetting (to assist in post-mortem analysis). &nbsp; &nbsp;But gcc was smart enough to look at those two lines&nbsp;and realise there was no point in writing to link_led_shadow&nbsp;because the very next statement would never terminate, so nobody would ever know what was in link_led_shadow. &nbsp; Of course, making it volatile solved the problem. &nbsp;This is an example where you need to declare a variable volatile even though the ISR &nbsp;never&nbsp;writes to it. &nbsp;The fact that the ISR <strong>reads</strong> it, is enough to require it being volatile. &nbsp; &nbsp;The dead-code elimination algorithm is working very well.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39099"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 04/02/2016 - 01:16.</div>
    <div class="content">
     <p><em>found that (at least in my code) there is an ISR cycle in every energy Hz that is taking longer than 104uS and from what I understood this will mess the two values that read next</em></p>
<p>I think you may be ok, provided it doesn&#39;t happen &quot;too often and back-to-back&quot;. &nbsp; Assuming the ISR reads&nbsp;the conversion result &nbsp;first up, you&#39;ve got 104 usecs before the ADC has another result for you (I&#39;m ignoring interrupt latency here which obviously I shouldn&#39;t for a proper analysis). &nbsp;But you&#39;ve actually got 208 usecs&nbsp;before that next result&nbsp;gets clobbered by a third conversion.</p>
<p>So for example, if once in a while your ISR takes 120 usecs (say) but usually only takes 80 usecs, then I don&#39;t think you&#39;ll lose anything. &nbsp;You&#39;ll return from the long ISR and immediately re-enter to process the next result and then you&#39;ll be all caught up. &nbsp;Effectively you have a 104usec&nbsp;slip buffer that you&#39;d need to consume before anything bad happens. &nbsp;If you had back-to-back 120 usecs ISRs, then you&#39;d get 16 usecs behind each time. &nbsp;You could afford to deal with about 6 of them (104/16) before you&#39;d exceed your slip buffer and lose some data &nbsp;(again, ignoring interrupt latency, which you do at your peril).</p>
<p>The other thing to note is the AVR always promises to execute one main program instruction after the RETI&nbsp;before it looks for more pending interrupts. &nbsp;You might notice if your&nbsp;ISR consistently takes longer than the interrupt arrival rate, you don&#39;t completely hang the main program. &nbsp;It limps along at one instruction per ISR return.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39100"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 04/02/2016 - 01:27.</div>
    <div class="content">
     <p>Hi.</p>
<p>Thank you very much for this explanation.</p>
<p>In fact I was puzzled why the results were so acceptable with a 2% of the values wrong.</p>
<p>This explains it, in fact makes much sense, since the ADC is stored right away in the first few instructions of the ISR.</p>
<p>I was thinking that the ISR call was skipped if the previous one haven&#39;t ended, but at the same time my observations of the timings (when I intentionally caused the ISR to take more time) where against that conclusion.</p>
<p>My code has most&nbsp;of the ISR calls&nbsp;under&nbsp;40uS&nbsp;and about 1/50&nbsp;between&nbsp;100uS&nbsp;and&nbsp;150uS.</p>
<p>I&#39;m presently trying to get&nbsp;rawsamples&nbsp;and try&nbsp;to understand where the reading differences are coming&nbsp;from...</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39102"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Thu, 04/02/2016 - 04:17.</div>
    <div class="content">
     <p>Yeh, Atmel were smart enough to clear down the&nbsp;ADIF flag&nbsp;as they launch&nbsp;your ISR. &nbsp; So the whole time you&#39;re lingering in the ISR, &nbsp;ADIF is armed and ready to latch the next event.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39103"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Thu, 04/02/2016 - 07:57.</div>
    <div class="content">
     <p><em>CidiRome: My code has most&nbsp;of the ISR calls&nbsp;under&nbsp;40uS&nbsp;and about 1/50&nbsp;between&nbsp;100uS&nbsp;and&nbsp;150uS.</em></p>
<p>A very interesting observation.&nbsp; I am hoping to do a similar test in a different way today.&nbsp; Most of the ISR calls will be short; something different only happens at specific parts of each mains cycle.&nbsp; The time of highest workload is likely to be when datalog stats are copied for use by the main code.&nbsp; If necessary, this extra activity could be distributed over multiple ISR visits.&nbsp; The&nbsp;dataReady flag would only be set after everything had been completed.&nbsp; With none of the timing in the main code being critical, it wouldn&#39;t matter how many ISR visits this workload was distributed over.</p>
<p><em>dBC:&nbsp; I think you may be ok, provided it doesn&#39;t happen &quot;too often and back-to-back&quot; ... you&#39;ve actually got 208 usecs&nbsp;before that next result&nbsp;gets clobbered by a third conversion.&nbsp; </em></p>
<p>Nicely put.&nbsp; I believed this to be the case but hadn&#39;t quite been able to put it into words.</p>
<p><em>dBC:The other thing to note is the AVR always promises to execute one main program instruction after the RETI&nbsp;before it looks for more pending interrupts. &nbsp;You might notice if your&nbsp;ISR consistently takes longer than the interrupt arrival rate, you don&#39;t completely hang the main program. &nbsp;It limps along at one instruction per ISR return.</em></p>
<p>Very interesting too.&nbsp; I wonder whether <em>micros()</em> will be updated between back-to-back ISR visits?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39105"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 04/02/2016 - 09:47.</div>
    <div class="content">
     <p>Hi.</p>
<p>calypso_rae:&nbsp;<em>If necessary, this extra activity could be distributed over multiple ISR visits.</em></p>
<p>Despite saying that I have that cycle that goes over the ISR timing, yesterday I&#39;ve made changes that passed some calculations to the next cycle of the ISR and have&nbsp;already every cycle under 100uS, because,&nbsp;based on what dBC said, I was thinking about going back to the original&nbsp;to have a better (understandable) code.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39106"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/02/2016 - 06:51.</div>
    <div class="content">
     <p>micros() uses TIMER0 which is free running (regardless of the state of the CPU) at one tick every 4usecs. &nbsp;But it&#39;s only an 8-bit timer, so overflows every 1024 usecs. &nbsp;The TIMER0 OVF interrupt is used to keep track of how often that&#39;s happened. &nbsp;So micros() fetches it&#39;s bottom 8-bits from the free running hardware, and ORs in the top bits from the software overflow count (and&nbsp;then multiples it all by 4 so as to return the more natural unit of usecs rather than 4-usecs).</p>
<p>TIMER0 OVF is a higher priority than the ADC completion interrupt, so if it has overflowed while your ISR is running, and your ISR wants to re-run immediately for a second time, I&#39;d expect the TIMER0 OVF to get in between the two &quot;back to back&quot; invocations of your ISR.</p>
<p>If you call micros() at the beginning and end of your ISR, there&#39;s a <s>good</s>&nbsp;<strong>slight</strong>&nbsp;chance the 8-bit timer will have overflowed in between. In theory you could re-enable global interrupts at the start of your ISR, and let the TIMER0 OVF ISR interrupt your ISR. &nbsp;But an alternative, assuming you&#39;re timing things that take less than 1024 usecs, is to simply add 1024 to the result if you find your second call to micros() returns a number smaller than your first call.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39107"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 04/02/2016 - 10:57.</div>
    <div class="content">
     <p>Hi.</p>
<p>I normally don&#39;t store the values returned from micros(), instead a subtraction is made.&nbsp;I haven&#39;t noticed negative values being returned by the subtraction except on the beginning&nbsp;in cases where I reverse the order of the micros() samples to get the time the whole loop takes and in that case I get a first super high value (unsigned).</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39123"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/02/2016 - 22:42.</div>
    <div class="content">
     <p>Yes, fair comment. &nbsp;Thinking about it some more, TIMER0 only overflows every 1024 usecs, and your ISR is of the order of 100 usecs, so my &quot;good chance&quot; claim above is a bit strong. &nbsp;I&#39;ll change it to &quot;slight chance&quot;. &nbsp;At any rate, if you ever do see time going backwards inside your ISR, you&#39;ll know why (as you say, it&#39;ll appear as a very large difference&nbsp;since it&#39;s all unsigned).</p>
<p>With regards latency, I dusted off an old DataLogger sketch (attached below) I wrote a while back. &nbsp;Its ADC ISR takes about 3 usecs normally, and about 7 &nbsp;usecs when a complete oversample is ready to be handed over to the main loop. &nbsp;I added some code to make it do a bunch of useless stuff every 10th invocation, and to also check at the end of the ISR if a new ADC conversion had rolled in, i.e. if it&#39;s starting to slip behind. &nbsp;</p>
<p>The useless work is just enough to push it over the edge in the case where an oversample is ready to be handed over. &nbsp;In all the other cases it gets out just in time. &nbsp;So in summary, when the 10th ISR invocation happens to align with an oversample&nbsp;being ready (every 256th invocation) the slip detection code fires and triggers the scope.</p>
<p>The pink trace is high whenever we&#39;re inside the ISR, the blue trace goes briefly high whenever the slip-detection code has detected a slip. &nbsp;In the first pic you can see a bunch of ISR firings. &nbsp;Most are so short as to just appear as a blip at that timebase, but every 10th one is longer. &nbsp; &nbsp;And you can see there is 1.04 msecs between the two long ones. &nbsp;If you look really closely, you can just see the second firing hard up against the end of the long firing. &nbsp;It looks like a blemish at the end of the long firing. &nbsp;</p>
<p>The second pic is zoomed in on that point, and shows exactly what happens when the ISR takes too long. &nbsp;We&#39;re in the ISR doing the useless stuff (pink high) and as&nbsp;that finishes the slip-detect code discovers we&#39;ve been in there so long that another ADC conversion has completed so indicates a slip (blue high). &nbsp;So we exit the ISR&nbsp;knowing that we&#39;re immediately going to re-enter&nbsp; as another ADC conversion is waiting to be read. &nbsp;The last thing the ISR does on the way out is to set pink low and the first thing the new back-to-back ISR does is to set it high again. &nbsp;And you can see that takes a full 3.58 usecs&nbsp;(or 57 cycles). &nbsp;So that gives you a&nbsp;feel for how much latency you should allow for (at least for my simple ISR). &nbsp;</p>
<p>If you look at the prologue and epilogue of the ISR below, you can pretty much account for all of those cycles. &nbsp; The rjump, push, sbi, cbi and pop all take 2 cycles. &nbsp;The in, out and eor each take 1, and the reti takes 5 (this was done on a 2560 with the wider PC). &nbsp;I think that adds up to about 54 cycles, but it takes 5 cycles to get to the vector after the event happens, so we&#39;re actually ahead (I may have miscounted some instructions or not lined up the cursors perfectly... one cycle is just 62.5 nsecs).&nbsp;The more complicated your ISR (and I bet yours is way more complicated than mine) the more registers its going to have to preserve and restore, so your latency could be even higher.</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; 74:&nbsp;&nbsp; &nbsp;1f c1 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;rjmp&nbsp;&nbsp; &nbsp;.+574 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;; 0x2b4 &lt;__vector_29&gt;<br />
&nbsp; &nbsp; &nbsp; 76:&nbsp;&nbsp; &nbsp;00 00 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;nop</p>
<p>
000002b4 &lt;__vector_29&gt;:<br />
&nbsp; &nbsp; &nbsp;2b4:&nbsp;&nbsp; &nbsp;1f 92 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r1<br />
&nbsp; &nbsp; &nbsp;2b6:&nbsp;&nbsp; &nbsp;0f 92 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r0<br />
&nbsp; &nbsp; &nbsp;2b8:&nbsp;&nbsp; &nbsp;0f b6 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;in&nbsp;&nbsp; &nbsp;r0, 0x3f&nbsp;&nbsp; &nbsp;; 63<br />
&nbsp; &nbsp; &nbsp;2ba:&nbsp;&nbsp; &nbsp;0f 92 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r0<br />
&nbsp; &nbsp; &nbsp;2bc:&nbsp;&nbsp; &nbsp;11 24 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;eor&nbsp;&nbsp; &nbsp;r1, r1<br />
&nbsp; &nbsp; &nbsp;2be:&nbsp;&nbsp; &nbsp;2f 93 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r18<br />
&nbsp; &nbsp; &nbsp;2c0:&nbsp;&nbsp; &nbsp;3f 93 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r19<br />
&nbsp; &nbsp; &nbsp;2c2:&nbsp;&nbsp; &nbsp;4f 93 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r20<br />
&nbsp; &nbsp; &nbsp;2c4:&nbsp;&nbsp; &nbsp;8f 93 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r24<br />
&nbsp; &nbsp; &nbsp;2c6:&nbsp;&nbsp; &nbsp;9f 93 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r25<br />
&nbsp; &nbsp; &nbsp;2c8:&nbsp;&nbsp; &nbsp;af 93 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r26<br />
&nbsp; &nbsp; &nbsp;2ca:&nbsp;&nbsp; &nbsp;bf 93 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;push&nbsp;&nbsp; &nbsp;r27<br />
&nbsp; &nbsp; &nbsp;2cc:&nbsp;&nbsp; &nbsp;2d 9a &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;sbi&nbsp;&nbsp; &nbsp;0x05, 5; &nbsp; &nbsp; &nbsp; &nbsp;PORTB |= 0x20;<br />
...</p>
<p>&nbsp; &nbsp; &nbsp;3c8:&nbsp;&nbsp; &nbsp;2d 98 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;cbi&nbsp;&nbsp; &nbsp;0x05, 5; &nbsp; &nbsp; &nbsp; &nbsp;PORTB &amp;= 0xdf;<br />
&nbsp; &nbsp; &nbsp;3ca:&nbsp;&nbsp; &nbsp;bf 91 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r27<br />
&nbsp; &nbsp; &nbsp;3cc:&nbsp;&nbsp; &nbsp;af 91 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r26<br />
&nbsp; &nbsp; &nbsp;3ce:&nbsp;&nbsp; &nbsp;9f 91 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r25<br />
&nbsp; &nbsp; &nbsp;3d0:&nbsp;&nbsp; &nbsp;8f 91 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r24<br />
&nbsp; &nbsp; &nbsp;3d2:&nbsp;&nbsp; &nbsp;4f 91 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r20<br />
&nbsp; &nbsp; &nbsp;3d4:&nbsp;&nbsp; &nbsp;3f 91 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r19<br />
&nbsp; &nbsp; &nbsp;3d6:&nbsp;&nbsp; &nbsp;2f 91 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r18<br />
&nbsp; &nbsp; &nbsp;3d8:&nbsp;&nbsp; &nbsp;0f 90 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r0<br />
&nbsp; &nbsp; &nbsp;3da:&nbsp;&nbsp; &nbsp;0f be &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;out&nbsp;&nbsp; &nbsp;0x3f, r0&nbsp;&nbsp; &nbsp;; 63<br />
&nbsp; &nbsp; &nbsp;3dc:&nbsp;&nbsp; &nbsp;0f 90 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r0<br />
&nbsp; &nbsp; &nbsp;3de:&nbsp;&nbsp; &nbsp;1f 90 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;pop&nbsp;&nbsp; &nbsp;r1<br />
&nbsp; &nbsp; &nbsp;3e0:&nbsp;&nbsp; &nbsp;18 95 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;reti</p>
<pre>
&nbsp;</pre><p><strong>[EDIT]&nbsp;</strong>Removed a race condition in DataLogger.ino while accessing lagcount, and made the display incremental rather than cumulative.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39126"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7218.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="emjay&#039;s picture" title="emjay&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/7218.html" title="View user profile.">emjay</a> on Fri, 05/02/2016 - 10:37.</div>
    <div class="content">
     <p>@dBC,</p>
<p>Nice work - refreshing to have solid, clear data to work with.</p>
<p>
&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39127"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 05/02/2016 - 11:03.</div>
    <div class="content">
     <p>Hi.</p>
<p>My assembly coding is a little bit rusty, last time I used was about 10 Years ago to build a simple&nbsp;Washing machine programmer (it is still working while the original mechanical ones didn&#39;t last 2 years).</p>
<p>I built it using an ATmega8515 (if I remember correctly).</p>
<p>Before that it was at school with 8086 and some 32bit virtual&nbsp;RISC I can&#39;t remember the name&nbsp;and even before that it was Z80 in my very very old spectrum... Reading and recording to tapes Piiiiiiiiii, pip......</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39138"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 05/02/2016 - 22:41.</div>
    <div class="content">
     <p>Hi.</p>
<p>Today I took the time to tweak my firmware soo I could see what is going on.</p>
<p>This image show the raw samples taken over an entire cycle (in fact they are from 4 different cycles, but within a small interval in time). CT1 and CT3&nbsp;are hooked to the same live wire (the grid)&nbsp;and CT2 is the solar that curiously seems to have a slight production at night) and no shift calibration&nbsp;has been made, so despite being aligned, CT1 shoud be displaced 104uS from Voltage, CT2 208uS and CT3 312uS.</p>
<p>This thing that is puzzling me more it the Voltage wave that I would expect to be almost a perfect sinusoidal one and is very distorted, is this normal?</p>
<p><img alt="" src="../../../vieirasoft.net/Capture_Emon_Volts_CTs.png" style="width: 631px; height: 573px;" />&nbsp;</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39140"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 05/02/2016 - 23:31.</div>
    <div class="content">
     <p>Yes, V does look quite distorted. &nbsp;It varies from region to region based on how good your local supply is but I don&#39;t think I&#39;ve seen one that bad before. &nbsp;How are you sensing V, and assuming it&#39;s via a transformer, is that transformer powering anything else, like your energy monitor for example?</p>
<p>CT1 and CT3 look encouragingly similar, but for the phase shift. &nbsp;Is the phase shift as predicted in terms of multiples of 104 usecs? &nbsp;Because you&#39;re not measuring a purely resistive load, you can&#39;t really comment on any phase shift between V and I, i.e. the phase shift you see between V and I probably exists in the real signals. &nbsp;Below is a V,I plot from my energy monitor, after sensor+meter&nbsp;phase shift removal, demonstrating how out of phase V and I can be.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39142"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Fri, 05/02/2016 - 23:53.</div>
    <div class="content">
     <p>Hi.</p>
<p>The V is being taken through an AC-AC transformer that was originally from a DLink Router.<br />
A cable with 1mm wires with about 1.5m comes from the breaker box where it is connected to one of&nbsp;the socket outlets&nbsp;breaker.<br />
To this cable are connected the AC-AC transformer and he AC-DC 5V 2A EmonPi&nbsp;power adapter.<br />
This AC-DC 5V 2A power adapter&nbsp;is coincidentaly&nbsp;one&nbsp;from a DLink Access point that I adapted with an USB socket.</p>
<p>About the CT1 and CT3, I believe that the difference related to the two samples being taken with 208uS apart.</p>
<p>The only thing I forgot to say is that the live wire has 3 loops on CT1 and CT3 and 10 loops on CT2.</p>
<p>Any more thoughts?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39144"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7218.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="emjay&#039;s picture" title="emjay&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/7218.html" title="View user profile.">emjay</a> on Sat, 06/02/2016 - 00:11.</div>
    <div class="content">
     <p>Try putting some dummy load on the AC-AC transformer if all it is doing is feeding a high R value potential divider into the ADC pin - the V waveform should change.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39145"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 06/02/2016 - 00:43.</div>
    <div class="content">
     <p><em>About the CT1 and CT3, I believe that the difference related to the two samples being taken with 208uS apart.</em></p>
<p>So now that you&#39;ve presumably got the raw numbers in a spreadsheet, you can do your own Power calculation using sigma&nbsp;(CT1*V) &nbsp;and then again using sigma (CT3*V)&nbsp;and see if you come up with the same discrepancy as your monitor does. &nbsp;Then you can shift one of them in time (in the spreadsheet)&nbsp;to align with the other, and see how much of&nbsp;the discrepancy in Power disappears. &nbsp; &nbsp;That&#39;ll give you a pretty good feel for how much of your observed discrepancies are down to uncorrected phase errors.</p>
<p>If you look at that lights signal of mine above, you can see how important it is to have&nbsp;the V-I phase information a true reproduction of what&#39;s happening on the wire&nbsp;if you want&nbsp;to accurately measure non-linear loads. &nbsp;When all those CFL caps come on at the same time, the current goes from 0 to ~1.8A in an instant. &nbsp;That green line is very near vertical and it&#39;s&nbsp;all happening along a fairly steep part of the V sine-wave. &nbsp;If you erroneously shift the green relative to the red you can get quite a different result.</p>
<p>Now that you can see your captured signals, I think you&#39;re also in a good position to play with their PHASECAL knobs. &nbsp;If you can tweak each of their PHASECAL knobs so that the two signals align, you might then get better results. &nbsp;But keep in mind the usual provisos... CT phase error varies with current etc. so you can&#39;t expect any one pair of PHASECAL settings to work perfectly across the entire dynamic range of your meter. &nbsp;Aligning them for your &quot;average power load&quot; is about the best you&nbsp;can do, and hope that your CTs Phase Vs Current graph is fairly flat. &nbsp;One rule of thumb I often see quoted is to calibrate your phase errors at expected Imax / 10, but your application might vary.</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39148"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 06/02/2016 - 01:03.</div>
    <div class="content">
     <p>Hummm.</p>
<p>Would it be a good idea to make 192 sample log of an entire V wave and update it, lets say, every 8 Hz and use that log to calculate the precise power against 192 samples of each CT, one cycle/CT at a time instead of every CT and V each cycle.</p>
<p>I think this way we wouldn&#39;t have to deal with phaseShifts. but in the other hand, very irregular loads could be more prone to bad readings...</p>
<p>Is this idea too much crazy?</p>
<p>Cheers</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39150"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 06/02/2016 - 07:47.</div>
    <div class="content">
     <p>It&#39;s an interesting idea. &nbsp;I think you&#39;re&nbsp;saying V doesn&#39;t change much&nbsp;so capture it once (refreshed 8 times per second) and then spend your valuable ADC resources focusing more on the CTs? &nbsp; I don&#39;t really have a feel for whether that would give more accurate results, or less. &nbsp;Others may?</p>
<p><strong>[EDIT]&nbsp;</strong>- thinking about it some more, if you stopped looking at V, how would you keep your I readings sync&#39;d to the right place in your stored V array? &nbsp;The I zero-crossings often happen nowhere near the V zero-crossings and there are often a lot more of them.</p>
<p>But in any case, remember there are&nbsp;<strong>two&nbsp;</strong>sources of phase shifts you need to deal with. &nbsp;The one you&#39;re addressing is caused by the fact you&#39;ve only got one ADC and it takes 104usecs to get a reading. &nbsp;Even if you had dedicated, synchronised&nbsp;ADCs &nbsp;(I&#39;ve got 21 24-bit ADCs in my energy monitor, 3 for voltage and 18 for current all running simultaneously) your VTs, CTs and various filters all introduce significant phase shift. &nbsp;So you&#39;re always going to have to deal with correcting phase shifts, even if you eliminate the ones caused by time-sharing &nbsp;a single ADC.</p>
<p>Did you try emjay&#39;s suggestion of loading up your VT a bit? &nbsp;It&#39;s a good idea.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39157"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 06/02/2016 - 11:48.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve thought of what you said in the <strong>EDIT</strong> part and you are right, and I think that would have to be a mater of timing.</p>
<p>To be truthful I&#39;m not sure I understood the source of the <strong>second</strong>&nbsp;phase shift :-(<br />
If they are all synchronized, are you talking about hardware delays? If yes are they even perceptible&nbsp;at a 104uS scale?</p>
<p>About putting a load on the AC-AC transformer, what value would you suggest? Do you think that the distorted wave can come from that?</p>
<p>Another thing, I looked at the AC-AC input circuit and noticed that there is a 1uF capacitor in series with the input, won&#39;t this cause some kind of delay since the capacitor has to charge/discharge every cycle? Is that&nbsp;the hardware delay?</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39158"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 06/02/2016 - 12:25.</div>
    <div class="content">
     <p><em>If they are all synchronized, are you talking about hardware delays? If yes are they even perceptible at a 104uS scale?</em></p>
<p>Yes, your sensing hardware (CTs and VTs) plus any filters you might have all introduce significant phase errors. &nbsp;Check out &quot;4. Phase error&quot; in this report: &nbsp;<a href="https://learn.openenergymonitor.org/?redirect=report-yhdc-sct-013-000-current-transformer">http://openenergymonitor.org/emon/buildingblocks/report-yhdc-sct-013-000-current-transformer</a></p>
<p><em>About putting a load on the AC-AC transformer, what value would you suggest?</em></p>
<p>Something that doesn&#39;t exceed the output power of the transformer.... maybe 1/2 its rated output? &nbsp;It&#39;s just an experiment at this stage to see if it improves the shape of your V, so play around with it.</p>
<p><em>Do you think that the distorted wave can come from that?</em></p>
<p>It&#39;s possible and easy to test, right?</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39165"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sat, 06/02/2016 - 16:52.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve not tested adding the load to the AC-AC transformer yet, but I will test it as soon as I can (already have a lamp to test that will draw about 500mA).</p>
<p>While I don&#39;t have the chance to look at it, I noticed that the the distorted AC wave seems to be related in some way with the CT1 wave. I&#39;ve multiplied the values by&nbsp;10 and notice that the most <em>impact</em> on the AC wave happens when the CT1 wave falls almost instantly&nbsp;from a positive value&nbsp;to a negative one.</p>
<p>This raises some questions:<br />
What can cause this reactive (don&#39;t know if it&nbsp;is the correct designation) values?<br />
The permanent load on this house are two computers with an APC Smart UPS, the fridge and the freezer (don&#39;t know if these ones where on at the moment I took the samples)</p>
<p>In this image the CTX is CT1 multiplied by&nbsp;10.</p>
<p><img alt="" src="../../../vieirasoft.net/Capture_Emon_Volts_CTs_2.png" style="width: 761px; height: 471px;" /></p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39176"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Sat, 06/02/2016 - 21:12.</div>
    <div class="content">
     <p><em>I noticed that the the distorted AC wave seems to be related in some way with the CT1 wave.</em></p>
<p>Do you suspect cross-talk between your V and I channels? &nbsp;An easy test for that would be to unplug your CT and see if V changes (normal cautions apply about not unplugging a burdenless-CT while it&#39;s wrapped around a conductor carrying current). &nbsp;It looks like there&#39;s a bit of blip in your CT2 (PV right?) reading at the same time. &nbsp;That could be more evidence of cross-talk, or it might be the inverter struggling to track the distorted V wave.</p>
<p>Or do you suspect local V sagging in your house wiring due to your loads? &nbsp;An easy test for that would be to power off all the loads and see if V changes.</p>
<p><em>The permanent load on this house are two computers with an APC Smart UPS,</em></p>
<p>My guess would be them. &nbsp;Again, easy to test, right? &nbsp;Unplug it from the wall (let it run off batteries) and take another capture.</p>
<p>Was it daylight hours when you took that measurement? &nbsp;CT1 is your main street feed right, where power can flow in either direction? &nbsp; When you&#39;ve got non-linear loads, and an inverter&nbsp;that only wants to contribute to the 50Hz component, you can get some pretty ugly current signals flowing across that point. &nbsp;Here&#39;s how my house looks to the grid. &nbsp; There&#39;s more stuff going on in the first three odd harmonics than there is at the fundamental.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39183"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Sun, 07/02/2016 - 02:19.</div>
    <div class="content">
     <p>Hi.</p>
<p>Lets see if I can answer everything, at least what I understood.</p>
<p>About the cross talk, that wasn&#39;t my idea (despite being a very good one), I was thinking of something causing some kind of energy spike that would distort the V&nbsp;Wave, I said that because there seems to be something&nbsp;strange on the moment&nbsp;that the CT current goes negative. But, one the other way, the V wave is collected so close to the grid&nbsp;input in the house that I&#39;m&nbsp;inclined for it to be side effect&nbsp;of the inverter, it has is own breaker in the breaker box.<br />
I will do some testing with the PV breaker off, and other options as suggested.</p>
<p>Test with the computers on batteries: I have to improve the way I&#39;m collecting the samples I use to make this graphs before I make more tests (including the PV breaker off), presently it is a multi-step just to collect each sensor.<br />
CT1 (and CT3 when values are present): Grid&nbsp;power (bi directional);<br />
CT2:PV with an APS 500W Inverter and production&nbsp;is registered as positive values</p>
<p>The graph values I posted were at night, this&nbsp;one I&#39;m posting now has been improved:<br />
- There is a production of about 10W (late afternoon and very cloudy)<br />
- The scale is real for Volts (with the same Vcal I use in the firmware);<br />
- The CTs scale in Amps is more or less arbitrary because I don&#39;t know the Ical for this firmware;<br />
- There is no&nbsp;phase shift&nbsp;correction, Each CT sample is 104uS apart&nbsp;from the previous one and V is probably ahead because (by the code) the index used for the array of samples is incremented after the V sample has been taken and I didn&#39;t took much time trying to correct that;<br />
<img alt="" src="../../../vieirasoft.net/Capture_Emon_Volts_CTs_3.png" /><br />
Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39236"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 08/02/2016 - 22:21.</div>
    <div class="content">
     <p>Hi.</p>
<p>Today I have new findings, I will list them:<br />
- It&nbsp;seems that there is no&nbsp;cross talking between the ADC inputs;<br />
- The CTs read a Permanent&nbsp;value&nbsp;511 with the their&nbsp;breaker off, or when taken out of the live wire, except one that reads 512 (CT1 reads 512, CT2 and CT3 reads 511;&nbsp;CT1 and CT3 were read out of the wire and CT2 with the breaker off). I attribute the 512 value on CT1 to tolerance values on the voltage divider resistors, do you agree? I think that this 511-512 doesn&#39;t make any difference in power readings, am I wrong?<br />
- The strange readings of my last post&nbsp;where CT1 current goes negative around&nbsp;sample 20&nbsp;and positive around sample 42 seems to be&nbsp;caused by the DC power supply (I bought a one Arduino&nbsp;Nano for tests and&nbsp;one of my projects will be to analyze the voltage output of this power supply with and without load);<br />
- I tested the additional&nbsp;load on the AC-AC adapter to check if I would get a better sinusoidal wave, but the only difference was a drop on the resulting voltage (I intend to try different&nbsp;AC-AC adapters and also make tests with the Arduino Nano&nbsp;on this area);<br />
- I tested a pure resistive load on CT3 and the wave was&nbsp;very similar to the Voltage wave. One more nail in the coffin that probably the grid wave is just bad and not reading errors...<br />
- I still get a huge difference in the readings of CT1 and CT3, I think it is&nbsp;related to the order the samples are taken when the current drops around sample 16 and 40, I will make some changes to alter the reading order during the cycle to see what happens.</p>
<p>Hope this helps some one.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39239"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Mon, 08/02/2016 - 23:25.</div>
    <div class="content">
     <p><em>I still get a huge difference in the readings of CT1 and CT3, I think it is related to the order the samples are taken&nbsp;</em></p>
<p>You&#39;ve got all the raw samples in a spreadsheet right? &nbsp;You might find it&nbsp;easier to do the experiments there,&nbsp;with the advantage that it gives you a stable signal to play with. &nbsp;You should be able to replicate the maths done in your energy monitor in the spreadsheet, and come up with the exact same result. &nbsp;You can even &quot;fix&quot; the phase error in your spreadsheet and see how big a difference that makes.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39333"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 11/02/2016 - 23:51.</div>
    <div class="content">
     <p>Hi.</p>
<p>I&#39;ve already made some tests with my new Arduino Nano&nbsp;and found that the AC wave is really distorted here, I will try later on other places to see if there are differences&nbsp;See the picture with a graphic created with samples every 104uS.</p>
<p>About the using of phaseShift to correct the readings, I&#39;m getting nowhere:<br />
- There was a warning not to use phaseshift&nbsp;outside of the range 0 to 1, but from what I understand, in order to get the necessary value the phaseshift&nbsp;would have to be between 1 and 2. Even so, I can&#39;t get any difference in the readings no mater what values I put.</p>
<p><img alt="" src="../../../vieirasoft.net/Capture_Emon_V_Wave.png" style="width: 685px; height: 365px;" /></p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39472"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Tue, 16/02/2016 - 22:44.</div>
    <div class="content">
     <p>Hi.</p>
<p>Today I made some findings:</p>
<p>- I got the phaseShift algorithm to make a difference&nbsp;in the outcome by changing&nbsp;the code (switched the place where&nbsp;lastSampleV_minusDC_long is updated): it seems that when the phaseshift algorithm was applied,&nbsp;sampleVminusDC_long and&nbsp;lastSampleV_minusDC_long have the same value so the algorithm&nbsp;would return&nbsp;the latest value no matter what value phase shift was set to.<br />
- I still get a difference between CTs but the result is already much better.</p>
<p>PS:&nbsp;I took a long time to write and re-write this post in order to avoid offending any one. If still I did manage to do that, I sincerely apologize.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39476"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/7218.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="emjay&#039;s picture" title="emjay&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/7218.html" title="View user profile.">emjay</a> on Thu, 18/02/2016 - 15:06.</div>
    <div class="content">
     <blockquote><p>found that the AC wave is really distorted here</p>
</blockquote>
<p>Possibly - your series of samples of the V waveform are certainly distorted as before. But part of this may still be from <strong>how</strong> you sample. Did you use the same random plug-in transformer to step down the voltage from mains to low enough for the ADC input as for the earlier readings posted?</p>
<p>For a definitive (<strong>but short term only</strong>) test, with sufficient care with checking that there is a true Neutral potential not too far from GND and floating the node supply to reference this neutral, a resistor-only divider can be used. <em>Not to be attempted if you don&#39;t thoroughly understand the risks involved.</em></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39479"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 18/02/2016 - 11:27.</div>
    <div class="content">
     <p>Hi.</p>
<p>emjay:&nbsp;Probably you are right, I&#39;m using transformers to step down the voltage level and I believe that the capacitor in the Voltage divider may also being affecting the result... To be truthfull&nbsp;I don&#39;t like the idea of using only a voltage divider but I understand how it work.</p>
<p>A good thing was to see AC&nbsp;waves taken by the other&#39;s EmonPI.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39524"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 18/02/2016 - 14:20.</div>
    <div class="content">
     <p>You need to be&nbsp;<strong>VERY, VERY</strong>&nbsp;careful if you do try to use the resistive divider connected directly to the supply. Remember that if for any reason the neutral becomes disconnected - anywhere, it could be a fault outside your house - <em>everything </em>become live at the full mains voltage. You must still treat the neutral conductor as &quot;live&quot;. &nbsp;I&#39;ve been an electrical engineer for all my working life, and professionally qualified for around 30 years.&nbsp;I do not recommend you do as emjay suggests&nbsp;unless you fully understand the risks and the consequences should anything go wrong.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39525"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 18/02/2016 - 14:42.</div>
    <div class="content">
     <p>Robert:<br />
That's exactly why I'm not even thinking about trying.</p>
<p>But, I have an AC transformer with lower voltage that I will test without the AC voltage divider to se the results.</p>
<p>About the phaseShift correction algorithm, after I made the change, I'm getting a more regular difference of around 10w that I'm trying to correct, but before I had much worse and irregular differences.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39532"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Thu, 18/02/2016 - 22:36.</div>
    <div class="content">
     <p>Hi.</p>
<p>Today I remembered of a simple test that allowed me to verify a few conclusions that I made before. It is&nbsp;so simple that I&#39;m shocked and annoyed&nbsp;with myself that I didn&#39;t remembered it before.</p>
<p>I configured CT3 to read the values from the same analog port of CT1. With this simple test I was able to determine a few things:<br />
- The phaseShift correction I made to the firmware is absolutely crucial to get more&nbsp;accurate readings&nbsp;from the CTs.<br />
- &nbsp;The 10W difference I referred in my last post may well be hardware related.</p>
<p>Tests with CT1 and CT2 configured to the same Pin (aka same hardware but&nbsp;readings at different&nbsp;timings)</p>
<p><strong>With phaseShift correction</strong><br />
&lt;500W Load = Very similar&nbsp;Readings<br />
@2000W Load =&nbsp;CT3 reads more 15W that CT1 probably result of&nbsp;<em>(it also has a small effect on the amplitude, which may need to be corrected)</em>,&nbsp;Is there an effective yet simple algorithm to correct the&nbsp;amplitude?</p>
<p><strong>Without phaseShift correction:</strong><br />
negative to 500W Load = CT1 with a constant 10W reading above CT3<br />
@2000W Load = CT1&nbsp;with readings above 40W higher than CT3</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-39636"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Mon, 22/02/2016 - 12:24.</div>
    <div class="content">
     <p>Hi there.</p>
<p>I think I finally got the phaseShift algorithm to work correctly.</p>
<p>I implemented a way of delaying the calculations so I don&#39;t have to extrapolate the value for the next Volts point. So, if the phaseShift is lower than 1 the regular method is used, but if the phaseShift is higher than 1 the <em><strong>I</strong></em>&nbsp;value is stored so the calculation with it is made on the next cycle and in the present cycle the calculation is made with the previous <em><strong>I</strong></em> value. For example, a phaseShift of 1.75 becomes 0.75 and the calcuation&nbsp;is made with the <em><strong>I</strong></em> value from last cycle.</p>
<p>With this improvement I&#39;ve been&nbsp;able to get a difference&nbsp;of 0 to 1 Watts at any load (up to 4kW) with maximum occasional spikes that go up to 2 W and down to -1W. This measurements where made at my grid connection with the same CT being measured at with 104uS and 312uS apart from the V reading and the described phaseShift correction being applied.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-40217"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/8733.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-8733.jpg" alt="CidiRome&#039;s picture" title="CidiRome&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: EmonPi schematic/board diffs, additional CTs and alternative firmware changes</h3>

    <div class="submitted">Submitted by <a href="../user/8733.html" title="View user profile.">CidiRome</a> on Wed, 09/03/2016 - 22:34.</div>
    <div class="content">
     <p>Hi.</p>
<p>Since my last post where I was able to get accurate power reading despite the Phase Shift, that I&#39;ve been struggling to get two CTs of the same model to read the same values when hooked&nbsp;to the same live wire.</p>
<p>Today I stopped my emonPi to measure the voltage divider, burden and other components and compare the values to my off-EmonPi CT circuit and I wasn&#39;t able to measure the capacitors.</p>
<p>There is one thing that is intriguing me, the Voltage divider capacitor is stated to be&nbsp;10uF on the schematic (C3, C4 and C10),&nbsp;but this capacitors are on board smd that are so small that I can&#39;t believe they are 10uF.</p>
<p>The capacitor I&#39;m using on my off-EmonPi CT circuit is a&nbsp;TANTALUM&nbsp;10UF 10V.</p>
<p>Can someone confirm me that the capacitor is 10uF and that the one I&#39;m using is adequate?</p>
<p>I&#39;ve been told many times that the differences I&#39;m having may be related to the margin of error of the components&nbsp;specially the CT, but the fact is that at least the CTs perform exactly the same way when I exchange them with each other.</p>
<p>What puzzles me about the readings is that the difference is not linear:<br />
@400W&nbsp;the difference is about 10 W<br />
@2300W&nbsp;the difference is about 25&nbsp;W<br />
Considering the second difference, the first should be less then 5W.</p>
<p>Any ideas are appreciated.</p>
<p>One thing I will do is confirm that both CTs read zero when not hooked or&nbsp;hooked to a wire that has no current passing.</p>
<p>Cheers.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/12030"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-reFnT7kGqRoi4ttNGh_NFYPjzVawuXSiijd3yRCA-tM" value="form-reFnT7kGqRoi4ttNGh_NFYPjzVawuXSiijd3yRCA-tM"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
