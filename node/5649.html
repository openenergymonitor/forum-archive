<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr">


<!-- Mirrored from openenergymonitor.org/emon/node/5649 by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 20 Feb 2017 15:26:23 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch | Archived Forum</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/default/files/emon3_favicon.png" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/mollom/mollom4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/forum/forum4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/comment/comment4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/emon3/style4b43.css?r" />
<style type="text/css" media="all">@import "../sites/all/themes/emon3/user_bar.css";</style>
    <script type="text/javascript"> </script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>

<div id="box">

<table border="0" cellpadding="0" cellspacing="0" id="header">
  <tr>
    <td id="logo">
       <h1 class='site-name'><a href="../index.html" title="Home">Archived Forum</a></h1>    </td>
    <td id="menu">
      
                  
      
    </td>
  </tr>
  <tr>
    <td colspan="2"><div></div></td>
</tr>
</table>
<!--<div style="background-color:#444444; border-top: 1px solid #888; height:32px;">-->

<table border="0" cellpadding="0" cellspacing="0" id="content">
  <tr>
        <td valign="top">
            <div id="main">
        <div class="breadcrumb"><a href="../index.html">Home</a> » <a href="../forum.html">Forums</a> » <a href="../forum/4.html">Archived: Hardware</a></div>     
        <div class="tabs"></div>
                          <div class="node">

    
    
          <div class="comment" >
                <h3 class="title" style="">Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>
        <span class="submitted">Submitted by <a href="../user/2221.html" title="View user profile.">alpav</a> on Thu, 28/08/2014 - 19:48</span>
        <div class="content"><p>Hello,</p>
<p>I am the happy and proud owner of an OEM full system composed of an emonGLCD, emonTX V2 and an Open Kontrol&nbsp;Gateway emonBase. It has been serving me very well for two years and even better after the precious directions on calibration that Robert Wall has given me some time ago. In any case, I have not found a proper setup that fully satisfies me.</p>
<p>My main interest would be to match the measure of the electricity&#39;s company meter either for the consumption and the solar production: it is close but I still have around 1,5 kWh of difference on 20 kWh of production read (7+%). I don&#39;t know if it is possible to reduce this gap, but I am not fully happy with this.</p>
<p>Wandering in the forum I came into the great job of&nbsp;Robin Emley and I started to think to update the emonTX firmware with the&nbsp;emonTx_continuous_watthours sketch. Before proceeding I am still studying in order to understand what I am going to do. And, again, I am struggling with the calibration...</p>
<p>The last time I have calibrated my node I found the following values to be quite reliable for my setup:</p>
<p>Voltage calibration constant = 207.275 - AC-AC Model: FP AD 3515 - Suggested calibration constant = 212.658</p>
<p>Current calibration constant =&nbsp;113.6 for CT1 and 112.6 for CT2 (Theoretical Current calibration constant = 111.1)</p>
<p>Phase calibration constant = 1.81 for CT1 and 1.77 for CT2</p>
<p>What I see in the&nbsp;emonTx_continuous_watthours.ino explanation is that theoretical values are used for Vcal and Ical and also phaseCal&nbsp;constants are set with fixed values.</p>
<p>Now I am struggling on what to do with this: do I assume my calibration is still valid and therefore use it to calculate the powerCal value? This would then become 0.245 rather than the 0.277 reported in the sketch (for CT1; 0.242 for CT2). And what about the phaseCal&nbsp;constants? They differ a lot from the 0.22 and 0.41 reported in the sketch.</p>
<p>Actually I can&#39;t evaluate whether it is a big difference, and worth it keep in into consideration, or not. This is more valid for the phaseCal: I remember those values were giving me powerFactors like 1.0002 or 0.9998 under pure resistive loads (bulbs and a toaster) so I was happy with them.</p>
<p>Probably I am searching for a problem that doesn&#39;t exist, but I&#39;d really like to make that 7% discrepancy to disappear.</p>
<p>Thanks,</p>
<p>Alberto</p>
  <div class="forum-topic-navigation clear-block">
          <a href="5640.html" class="topic-previous" title="Go to previous forum topic">‹ Potential collisions when using many EmonTX V3  RF in the same place</a>
              <a href="5624.html" class="topic-next" title="Go to next forum topic">Faulty CT sensor or EmonTX shield ›</a>
      </div>
</div>
      </div>
    
    <div class="links">&raquo; <ul class="links inline"><li class="comment_forbidden first last"></li>
</ul></div>  </div>
<div id="comments">
  <a id="comment-23406"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Thu, 28/08/2014 - 23:45.</div>
    <div class="content">
     <p>The method that most people adopt, bearing in mind the difficulty of accurately measuring current and voltage to a similar accuracy to the calibration of your supplier&#39;s meter (there&#39;s a Building Blocks page about multimeters that you might like to read if you haven&#39;t seen it) is to apply small corrections over time so that the energy readings agree with the supplier&#39;s meter and generation meter. Unless your multimeter is particularly good, you&#39;re unlikely to get much closer than you already are by measuring and working out the calibration constants for voltage and current separately. For the phase shift correction, Robin&#39;s tool <a href="1757.html">here</a> is probably a good way to go. I understand that with careful adjustments over time, you can get to better than 1% agreement between emonTx and your supplier&#39;s meter.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23410"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2221.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2221.png" alt="alpav&#039;s picture" title="alpav&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/2221.html" title="View user profile.">alpav</a> on Fri, 29/08/2014 - 05:33.</div>
    <div class="content">
     <p>Thanks for the prompt response. So you&#39;re telling me that the error that I see is reasonable provided all the uncertainties in the system, the difficulties in precise measurements and the way the calibration is done through two separate constants. I then suppose that moving to the new sketch won&#39;t provide me with more accuracy as the calibration is supposed to be done the same way, i.e. with the same type of uncertainty, isn&#39;t it?</p>
<p>Maybe the best approach to achieve my goal is to apply corrections over time, as suggested, rather than chasing the best combination of constant values. This means that using theoretical values instead of values found during calibration is not going to make a large difference if then I will correct the results: have I got your point?</p>
<p>I have another question about the&nbsp;emonTx_continuous_watthours sketch to be applied to the emonTX V2.</p>
<p>At line 65 we found the definitions for the analog inputs, that actually fits the emonTX V2&nbsp;setup:</p>
<p>// analogue input pins<br />
	const byte voltageSensor = 2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	const byte currentSensor_CT1 = 3;<br />
	const byte currentSensor_CT2 = 0;<br />
	const byte currentSensor_CT3 = 1;</p>
<p>At line 290, where the ISR routine starts, I see that the samples are read referring to the wrong inputs. For example, sample_V (that should refer to the voltage sensor) is read from the input 0 where is supposed to be connected the current sensor 2. Is it correct? It is going to mix up voltage and current, unless I miss something... The same mix is for the rest of the inputs.</p>
<p>ISR(ADC_vect)&nbsp;<br />
	{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; static unsigned char sample_index = 0;<br />
	&nbsp;<br />
	&nbsp; switch(sample_index)<br />
	&nbsp; {<br />
	&nbsp; &nbsp; case 0:<br />
	&nbsp; &nbsp; &nbsp; sample_V = ADC;<br />
	&nbsp; &nbsp; &nbsp;&nbsp;ADMUX = 0x40 + currentSensor_CT2; // set up the next-but-one conversion<br />
	&nbsp; &nbsp; &nbsp; sample_index++; // advance the control flag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; &nbsp; &nbsp;&nbsp;dataReady = true;<br />
	&nbsp; &nbsp; &nbsp; break;<br />
	&nbsp; &nbsp; case 1:<br />
	&nbsp; &nbsp; &nbsp;&nbsp;sample_CT1 = ADC;<br />
	&nbsp; &nbsp; &nbsp;&nbsp;ADMUX = 0x40 + currentSensor_CT3; // for the next-but-one conversion<br />
	&nbsp; &nbsp; &nbsp; sample_index++; // advance the control flag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; &nbsp; &nbsp; break;<br />
	&nbsp; &nbsp; case 2:<br />
	&nbsp; &nbsp; &nbsp;&nbsp;sample_CT2 = ADC;<br />
	&nbsp; &nbsp; &nbsp;&nbsp;ADMUX = 0x40 + voltageSensor; // for the next-but-one conversio<br />
	&nbsp; &nbsp; &nbsp; sample_index++; // advance the control flag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; &nbsp; &nbsp; break;<br />
	&nbsp; &nbsp; case 3:<br />
	&nbsp; &nbsp; &nbsp;&nbsp;sample_CT3 = ADC;<br />
	&nbsp; &nbsp; &nbsp;&nbsp;ADMUX = 0x40 + currentSensor_CT1; // for the next-but-one conversion<br />
	&nbsp; &nbsp; &nbsp; sample_index = 0; // advance the control flag&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; &nbsp; &nbsp; break;<br />
	&nbsp; &nbsp; default:<br />
	&nbsp; &nbsp; &nbsp; sample_index = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // to prevent lockup (should never get here)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; }&nbsp;<br />
	}</p>
<p>Thanks again for your help.</p>
<p>Have a good day,</p>
<p>Alberto</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23412"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3016.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="dBC&#039;s picture" title="dBC&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/3016.html" title="View user profile.">dBC</a> on Fri, 29/08/2014 - 08:32.</div>
    <div class="content">
     <p>The clue is in the comment: &nbsp;&nbsp;</p>
<p>// for the next-but-one conversion</p>
<p>When you run the ADC in continuous mode, by the time this ISR&nbsp;fires, it&#39;s already sampling the next input (as selected by the last write to ADMUX). &nbsp;The write you see here is telling it which one to start sampling, after the current sampling interval completes (when the next ISR fires).</p>
<p>So there are 3 conversions in the pipeline if you like:</p>
<p>. the one it&#39;s just completed (result is read from the ADC register above)</p>
<p>. the one it&#39;s currently working on (as selected by an earlier write to ADMUX)</p>
<p>. the one you want it to work on next when it&#39;s finished this one (specified by the above writes to ADMUX)</p>
<p>&nbsp;</p>
<p>Strictly speaking, the code is really setting it up for the next conversion, but the comment probably refers to that as &quot;next but one&quot; because it&#39;ll be available at the next but one interrupt. &nbsp;The next interrupt will provide you with the current conversion, the next one after that will provide you with the conversion you&#39;ve just selected via ADMUX.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23429"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Fri, 29/08/2014 - 13:34.</div>
    <div class="content">
     <p>Regarding your calibration accuracy, the theoretical values take no account of real components. Have you read the notes in Building Blocks about the sources of error? I think you&#39;re not clear in your mind about two different sources of possible error. The easy one to understand is due to the inability to make the components to perfectly accurate values. Calibration takes care of that.</p>
<p>What you might also be struggling with (it&#39;s not very clear from your posts) is also inaccuracy that arises from how the power is sampled to get the readings. The &quot;continuous&quot; sketch does what it says, it monitors continuously, adds up the energy that goes past during the sample period, and reports that (or divides it by the time elapsed and calls it average power). The &quot;discrete sample&quot; sketch measures power over a short period (10 cycles by default) and assumes that the power was constant at that value since the last sample 10 s ago.&nbsp; Therefore, if you have an appliance like an induction hob, that switches on and off rapidly, the &quot;discrete sample&quot; sketch is likely to report it at full power for 10 s even though it only happened to be at full power for 1 s before the sample was taken and for 2 s after - which would give you a 333% (approx) error for those 10 seconds.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23463"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2221.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2221.png" alt="alpav&#039;s picture" title="alpav&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/2221.html" title="View user profile.">alpav</a> on Sun, 31/08/2014 - 14:14.</div>
    <div class="content">
     <p>Thanks very much for your responses and suggestions. I have worked on the system during the weekend and I&#39;ve ended up into frustration: I am lost and I can&#39;t figure out what&#39;s wrong. I&#39;m close to give up.</p>
<p>I decided yesterday to move to the continuous sketch by calypso_rae. I have not fully clear in my mind all the implications of the measurement system, but it is definitely using an approach closer to what I would have done.</p>
<p>So I wanted to start re-calibrating my emonTX V2.2: I took a 60W bulb lamp and prepared a long wire. Then I made 20 loops of the wire into the CT1, 20 loops into CT2 and 20 loops into CT3. I loaded the&nbsp;PhasecalChecker sketch from calypso_rae&nbsp;to get the correct values: I didn&#39;t manage to find a single value in the range of 0.00-2.00 to give me a Power Factor better than 0.91 with none of the CTs. I get always a high value for the apparent power, almost constant. So I left this check and started working on the continuous sketch.</p>
<p>First of all I measured the open-circuit output from my&nbsp;FP AD 3515 AC-AC adapter: 12.56 V (on average) rather than the theoretical 9 V+20%. Another thing that I don&#39;t understand.</p>
<p>I then tried to adjust the powerCal&nbsp;factors in order to get reasonable values on CT1, CT2 and CT3. First of all three reasonable readings provided the uncertainty on the load and then three similar readings. After having completed the calibration of the values on the 60W bulb (x20 loops = 1200W), I made corrections and calibration using a toaster (nominal 650W&nbsp;checked with 1 wire, 6 loops-3.9kW and &nbsp;9 loops-5.85kW).</p>
<p>Then I moved the CT sensors on the main wire coming from the solar PV inverter realizing that the measured power was slightly less than the inverter was showing on its display, approx&nbsp;-3%. I didn&#39;t struggle on it as I&#39;ve always supposed that the inverter over-estimates the production.</p>
<p>I moved the CT&#39;s on their final positions (CT1 on house loads and CT2 on PV supply, CT3 disconnected) and left it monitoring for some hours.</p>
<p>Provided that my main scope is to have a system that can report values comparable with the electricity company&#39;s meters, I decided today to implement a pulse counter to interface the PV dedicated meter, to be used as reference. In Italy the electric company installs a separate meter to measure the PV production only, in order to calculate the incentives to be paid on the production and the excess put in the grid. If the emonTX measures the same values as read by the flashing led of the meter, then my system is calibrated and it has the accuracy that I am looking for.</p>
<p>Here my frustration has started: I see that the emonTX reads an instant power that is approx. 3% less than the one measured by the meter. But the accumulated energy is much more than the real! To give you some numbers: I read the meter yesterday night (no sun): 12179 kWh. At this point in time it is 12196 kWh, i.e. 17 kWh of energy come from the sun. The emonTx&nbsp;(it was reset when I read the energy on yesterday night) reports 20.4 kWh. It is a 20% of error! Meanwhile, it reads an instant power of 2859 Wh while the meter gives 2951 Wh.</p>
<p>I am lost: how can I apply a correction factor that should be for increasing the reading if the overall total is already too big? I&#39;ve started this revision because I wasn&#39;t happy of the 7% error I had and things have worsened dramatically. I&#39;m really disappointed of myself and I am thinking to leave things as they are and give up.</p>
<p>Thanks,</p>
<p>Alberto</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23466"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 31/08/2014 - 17:16.</div>
    <div class="content">
     <p>Robin (calypso_rae) has been on holiday, he may well respond shortly about your phase calibration problem. I&#39;m not sufficiently familiar with his test sketches to comment.</p>
<p><em>&quot;First of all I measured the open-circuit output from my FP AD 3515 AC-AC adapter: 12.56 V (on average) rather than the theoretical 9 V+20%. Another thing that I don&#39;t understand.&quot;</em><br />
	The &quot;20%&quot; is the regulation of the adapter. The actual value depends entirely on how the designer went about specifying the transformer. The 9 V output is on full load, when on no-load, the voltage will rise, and in your case - significantly. 20% is a typical value for the size of transformer we normally use, the regulation of yours is 39.55%.</p>
<p>That might be a problem. The incoming ac voltage (12.56 V rms) is divided in the ratio 10/110 inside the emonTx. That gives you 1.142 V rms. Assuming a perfect sine wave, that wave has a peak to peak value of 1.142 &times; 2 &times; &radic;2, and that is 3.23 V. That is within 70 mV of the nominal voltage of the 3.3 V dc supply that the Atmel processor runs on, and that&#39;s too close - you have only 2% for all the resistor tolerances and the regulator tolerance, and that&#39;s assuming your mains voltage was at maximum when you measured it! It&#39;s likely that the voltage wave is clipping on one or both peaks. I suggest you solder a higher value resistor in parallel with R14 (say 100 k&Omega;) to reduce the voltage by a few percent. If you do that, you will need to recalibrate powerCal.</p>
<p>The other thing you need to check is, are you counting each pulse once and only once?&nbsp; Is it possible that you are counting a flashing light from somewhere else? I think the voltage clipping is more likely to be the source of the error, because your power measurements will be non-linear according to the mains voltage. When the mains is high, you will measure low because the voltage wave is too low (clipping) at the peaks; and when the mains is low, you will measure correctly but you might have calibrated it when the mains was high and clipping, so it is still wrong!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23467"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2221.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2221.png" alt="alpav&#039;s picture" title="alpav&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/2221.html" title="View user profile.">alpav</a> on Sun, 31/08/2014 - 18:09.</div>
    <div class="content">
     <p>Dear Robert,</p>
<p>Thank you for the explanation. I will try with the&nbsp;100 k&Omega; resistor in parallel with R14 and perform a new calibration.</p>
<p><em>&quot;The other thing you need to check is, are you counting each pulse once and only once?&nbsp; Is it possible that you are counting a flashing light from somewhere else?&quot;</em></p>
<p>I am quite sure that I am counting each pulse only once: I&#39;ve used a sketch described at <em>http://openenergymonitor.org/emon/node/123</em> and visually it was easy to follow either the blink and the serial output. When I was testing the production was between 1500 kWh and 3000 kWh, so the pulses frequency wasn&#39;t that high. I was in a completely dark room also. Moreover, I&#39;ve been there waiting for the meter to turn 1 kWh and it happened at the same time with the sketch, so I am confident I didn&#39;t count pulses more than once.</p>
<p>Apologies for abusing of your patience, just to be sure I have got the point... assuming that the problem is in the voltage clipping, and assuming that my previous calibration wasn&#39;t that wrong (the first time I made it using a resistive load of about 600 W and no loops in the wire), it is possible that I was counting less energy than real because of the voltage clipping. Now that I moved to the continuous&nbsp;sketch and made a calibration with higher loads I am using higher than necessary values for powerCal&nbsp;(to read reasonable values according to the loads) and this affects the measure when the mains is low also. On the other hand, it looks like the measure of low mains is reasonably correct: with the latest calibration the CT2&nbsp;(PV) measures the same value got reading the pulses (the difference is &lt;0.5%). Is this the point? If so, I still don&#39;t understand why the measured power is less or equal than the &quot;real&quot; (coming from pulses) but the energy is much higher than the one measured by the meter. I would have expected less energy also! I moved from an error of 7% (under) to 20% (over).</p>
<p>One more thing: I have bought the AC-AC adapter from the OEM shop as it was (at that time) the only one with the Euro plug. I did assume that it was tested and approved for the project, as explained in the website. So my question is: may I have encountered a &quot;faulty&quot; device? Worth it to replace it or proceed with the R14&nbsp;workaround?</p>
<p>Thank you,</p>
<p>Alberto</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23468"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 31/08/2014 - 18:54.</div>
    <div class="content">
     <p>When I wrote that the regulation of your adapter was 39%, I&#39;d forgotten that you had not specified the mains voltage when you measured the output. The link to the supplier now appears to show a different item, the one now listed is 9 V out for 230 V in, with load regulation quoted as &plusmn;30.8%. Until I know the output at full load at the nominal mains input voltage, it&#39;s hard to say whether yours is in fact faulty. If the output waveform looks distorted, it might be worth changing it. Otherwise, I recommend you add the resistor - it&#39;s a lot cheaper. You could try Robin&#39;s Min/max sketch, or RawSamplesTool_4ss_2, to check the limit values you&#39;re actually seeing. But that is only definite proof of the problem when you do it at maximum mains voltage, otherwise you need to scale the values according to how far below the maximum voltage your mains is when you do the test.</p>
<p>Where is the energy calculation coming from, that you say is 20% high? If I interpret you correctly, you are measuring real power from your emonTx and calculating power from the pulse rate on your PV export meter, and they agree within 0.5%. Yet when you put that power into somewhere and perform the integration over time (emonCMS?), the integrated energy value shown there is 20% (possibly - if your meter does not display decimal fractions, it could be 17.999 kWh, 13.3%) higher than your PV export meter has recorded.</p>
<p>Let&#39;s make sure the voltage wave is correct first. As the system will be non-linear if clipping is present, it&#39;s hard to say exactly what is going on.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23472"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2221.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2221.png" alt="alpav&#039;s picture" title="alpav&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/2221.html" title="View user profile.">alpav</a> on Sun, 31/08/2014 - 21:03.</div>
    <div class="content">
     <p>Yes, I&#39;ll manage to add the resistor first, as soon as possible. Actually I didn&#39;t measure the mains voltage when I measured the output of the adapter on no load.</p>
<p>To explain the origin of the 20%: I measure the real power from the emonTx&nbsp;using the Robin&#39;s&nbsp;<em>emonTx_continuous_watthours</em> sketch. This sketch provides as output on the serial monitor either the instant real power and the energy (counted from the power up) for every CT channel. I reset the emonTx at midnight and left it running over night and today also. Today at noon I have checked the measure from the emonTx&nbsp;(PV energy) and it was 12,2 kWh. I read the same value on the PV&nbsp;meter and it was 10 kWh (no decimals available but it took more than 25 minutes to go to 11 with sun power around 3 kWh). The inverter was saying 10.1 kWh at the same time.</p>
<p>After this a took another Arduino&nbsp;board and I implemented the pulse counter on it. I wanted to use it as reference for the energy. I then realized that the real power coming from the emonTx was always lower than the power computed by the pulse counter: the difference was approx. 3%. Despite this, the energy calculated by the emonTx was much higher.</p>
<p>Both the emonTx and the pulse counter provide the energy as output at the resolution of 1 Wh. With the pulse counter the assumption is that that&#39;s exact energy counted by the mains company, so it is my reference. It was easy to see how quick the two energy values were diverging: within 100 seconds with a sun power almost constant, the emonTx&nbsp;was integrating 28&nbsp;Wh more than the pulse counter (on a total of 100 Wh). Values to low to be used for an analysis, but they give the idea of a trend in the gap that was clearly diverging whilst the power reported by the emonTx&nbsp;was lower than the pulse counter&#39;s one.</p>
<p>I then decided to play with powerCal&nbsp;in order to make the two powers be the same as much as possible and I found out the constant values that make the difference to be within 0.5%. At this point the divergence of the energies was huge, the sun was going down, then I asked for help...</p>
<p>&nbsp;</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23477"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Sun, 31/08/2014 - 22:49.</div>
    <div class="content">
     <p>I&#39;ll load that sketch into an emonTx V2 and run some tests for you, but it will not be for a day or two. Your mains supply is 50 Hz?</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23481"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2221.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2221.png" alt="alpav&#039;s picture" title="alpav&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/2221.html" title="View user profile.">alpav</a> on Mon, 01/09/2014 - 05:19.</div>
    <div class="content">
     <p>230 Vac - 50 Hz. Thank you!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23522"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Tue, 02/09/2014 - 14:35.</div>
    <div class="content">
     <p>There is a problem in the maths.</p>
<p>I&#39;ve run the current Github sketch on my CT test rig, with a more-or-less constant &quot;power&quot; of 12.5 kW for exactly 10 mins as measured by the emonTx, and dropped the numbers sent in the RF packet into a spreadsheet.</p>
<p>There are 61 sets of values. The accumulated Wh went from 13510 to 16122, an increase of 2612. Multiplying by 6 (to take it up to one hour) = 15672. The average power over the period was 12537 W. I think that the accumulated Wh is exactly 25% over. (The ratio is 1.2500598229 and that&#39;s close enough!)</p>
<p>There are 375 messages (i.e. the accumulators have been added to that many times), but if that is supposed to happen every 2 s, there should have been 10 x 60 / 2 = 300 messages only, which exactly the same proportion that is the excess in the accumulators.</p>
<p>The problem is in the &quot;switch(sequenceCount)&quot; statements at line 449. The sequenceCount counter is being reset after 80, not 100 counts as it should be (there are 100 cycles in 2 s). So it&#39;s necessary to change &quot;case 80:&quot; to &quot;case 100:&quot; at line 503, and in the default case, similarly make it &quot;if (sequenceCount &gt; 100)&quot;.</p>
<p>With those changes done, the discrepancy is -0.063%.</p>
<p>NOTE: This sketch is specifically for a 50 Hz system.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23527"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/956.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-956.jpg" alt="calypso_rae&#039;s picture" title="calypso_rae&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/956.html" title="View user profile.">calypso_rae</a> on Tue, 02/09/2014 - 19:28.</div>
    <div class="content">
     <p>Thanks Robert.&nbsp;</p>
<p>Although my name appears at the top, that version of the &quot;continuous&quot; code was not done by me :)</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23545"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/3.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-3.jpg" alt="TrystanLea&#039;s picture" title="TrystanLea&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/3.html" title="View user profile.">TrystanLea</a> on Wed, 03/09/2014 - 15:53.</div>
    <div class="content">
     <p>Thanks very much for spotting this Robert, I&#39;ve updated the code on github.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23548"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/924.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/default_0.png" alt="Robert Wall&#039;s picture" title="Robert Wall&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/924.html" title="View user profile.">Robert Wall</a> on Wed, 03/09/2014 - 16:19.</div>
    <div class="content">
     <p>Thanks, Trystan. Actually, Robin had told me that he&#39;d spotted that the code had been changed in this area a little while ago, but at the time I hadn&#39;t looked closely and didn&#39;t appreciate that the error affected the calibration. All I did was verify the problem, home in the exact details, then verify the solution!</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<a id="comment-23562"></a>
  <div class="comment comment-published" >
    <div class="picture">
  <a href="../user/2221.html" title="View user profile."><img src="../sites/default/files/imagecache/avatar/pictures/picture-2221.png" alt="alpav&#039;s picture" title="alpav&#039;s picture" width="50" height="50" class="imagecache imagecache-avatar"/></a></div>

<h3 class="title" style="padding-bottom:5px">Re: Calibrating the emonTxV2 using the emonTx_continuous_watthours sketch</h3>

    <div class="submitted">Submitted by <a href="../user/2221.html" title="View user profile.">alpav</a> on Thu, 04/09/2014 - 05:40.</div>
    <div class="content">
     <p>Robert, thanks a lot for your feedback. Regret the delay, I&#39;ve been around for business so I could only add the change to the code on Tuesday night. Yesterday evening the emonTx&nbsp;was reporting 10.013 kWh of solar production; the company&#39;s meter and the inverter reported 10 kWh&nbsp;both.</p>
<p>It has been quite a cloudy day in here yesterday: I hope today will be better so I can verify it on higher powers too. It looks like the main source of the error was there. As my references (the inverter and the meter) do not display the decimal fractions, this is still a potential error of 1 kWh on 10 (worst case). During the next weekend I&#39;ll be able to better check it, but I am pretty sure that I will find the emonTx output extremely close to the meter&#39;s readings now.</p>
         </div>
    <div class="links">&raquo; <ul class="links"><li class="comment_forbidden first last"></li>
</ul></div>
  </div>
<form action="https://openenergymonitor.org/emon/node/5649"  accept-charset="UTF-8" method="post" id="comment-controls">
<div>  <div class="box">
    <h2 class="title">Comment viewing options</h2>    <div class="content"><div class="container-inline"><input type="hidden" name="form_build_id" id="form-0ZjWOch2COyq_LIeollNsDiuvbEQULbzKQaJkzNQLuE" value="form-0ZjWOch2COyq_LIeollNsDiuvbEQULbzKQaJkzNQLuE"  />
<input type="hidden" name="form_id" id="edit-comment-controls" value="comment_controls"  />
<div class="form-item" id="edit-mode-wrapper">
 <select name="mode" class="form-select" id="edit-mode" ><option value="1">Flat list - collapsed</option><option value="2" selected="selected">Flat list - expanded</option><option value="3">Threaded list - collapsed</option><option value="4">Threaded list - expanded</option></select>
</div>
<div class="form-item" id="edit-order-wrapper">
 <select name="order" class="form-select" id="edit-order" ><option value="1">Date - newest first</option><option value="2" selected="selected">Date - oldest first</option></select>
</div>
<div class="form-item" id="edit-comments-per-page-wrapper">
 <select name="comments_per_page" class="form-select" id="edit-comments-per-page" ><option value="10">10 comments per page</option><option value="30">30 comments per page</option><option value="50">50 comments per page</option><option value="70">70 comments per page</option><option value="90">90 comments per page</option><option value="150">150 comments per page</option><option value="200">200 comments per page</option><option value="250">250 comments per page</option><option value="300" selected="selected">300 comments per page</option></select>
</div>
<input type="submit" name="op" id="edit-submit" value="Save settings"  class="form-submit" />
</div><div class="description">Select your preferred way to display the comments and click "Save settings" to activate your changes.</div></div>
 </div>


</div></form>
</div>
      
              </div>
    </td>
      </tr>
</table>

<div id="footer">
  <p>Open-source tools for energy monitoring and analysis.&nbsp;Forum has moved to: <a href="https://community.openenergymonitor.org/">https://community.openenergymonitor.org</a></p>
   
</div>


</div>
<div style="margin:0 auto;width:1000px;">
  <div style ="float:right;width:400px;padding-right:20px;">
    <script>
      (function() {
        var cx = '006198118389747886812:rtaoc3wurta';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
  </div>
</div>

</body>
</html>
